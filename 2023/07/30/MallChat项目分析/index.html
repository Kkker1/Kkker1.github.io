<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/bonbon-16%C3%9716.png?v=2.8.0" type="image/png" sizes="16x16"><link rel="icon" href="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/bonbon-32%C3%9732.png?v=2.8.0" type="image/png" sizes="32x32"><meta name="description" content="先跑通项目                           尝试运行                           后端:                        |INFO|2023-07-30 09:50:38.781|main||uid&#x3D;|Tomcat initialized with port(s): 8080 (http)">
<meta property="og:type" content="article">
<meta property="og:title" content="MallChat项目分析">
<meta property="og:url" content="https://username.github.io/2023/07/30/MallChat%E9%A1%B9%E7%9B%AE%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="KkkerAn&#39;s Blog">
<meta property="og:description" content="先跑通项目                           尝试运行                           后端:                        |INFO|2023-07-30 09:50:38.781|main||uid&#x3D;|Tomcat initialized with port(s): 8080 (http)">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230730100207953.png">
<meta property="og:image" content="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230730103826557.png">
<meta property="og:image" content="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230730100713827.png">
<meta property="og:image" content="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230730103929645.png">
<meta property="og:image" content="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230730161607692.png">
<meta property="og:image" content="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230730225147538.png">
<meta property="og:image" content="https://username.github.io/MallChat%E9%A1%B9%E7%9B%AE%E5%88%86%E6%9E%90/image-20230731101441566.png">
<meta property="og:image" content="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230731100759932.png">
<meta property="og:image" content="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230731102513714.png">
<meta property="og:image" content="https://username.github.io/MallChat%E9%A1%B9%E7%9B%AE%E5%88%86%E6%9E%90/image-20230804170246021.png">
<meta property="og:image" content="https://username.github.io/MallChat%E9%A1%B9%E7%9B%AE%E5%88%86%E6%9E%90/image-20230804170416313.png">
<meta property="og:image" content="https://username.github.io/MallChat%E9%A1%B9%E7%9B%AE%E5%88%86%E6%9E%90/image-20230804170527319.png">
<meta property="og:image" content="https://username.github.io/MallChat%E9%A1%B9%E7%9B%AE%E5%88%86%E6%9E%90/image-20230804170656484.png">
<meta property="og:image" content="https://username.github.io/MallChat%E9%A1%B9%E7%9B%AE%E5%88%86%E6%9E%90/image-20230804170829700.png">
<meta property="article:published_time" content="2023-07-30T02:00:48.000Z">
<meta property="article:modified_time" content="2023-08-16T09:49:48.930Z">
<meta property="article:author" content="KkkerAn">
<meta property="article:tag" content="java">
<meta property="article:tag" content="MallChat">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230730100207953.png"><title>MallChat项目分析 | KkkerAn's Blog</title><link ref="canonical" href="https://username.github.io/2023/07/30/MallChat%E9%A1%B9%E7%9B%AE%E5%88%86%E6%9E%90/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.8.0"><link rel="stylesheet" href="css/custom.css"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":false},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: true,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"复制","copySuccess":"复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 6.3.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">归档</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">分类</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">标签</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">搜索</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">WelCome to My Blog</div><div class="header-banner-info__subtitle">回忆像一块彩色橡皮糖,被拉长了,颜色淡了,但还是甜</div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">MallChat项目分析</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-07-30</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">15.3k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">141分</span></span></div></header><div class="post-body">
        <h1 id="先跑通项目"   >
          <a href="#先跑通项目" class="heading-link"><i class="fas fa-link"></i></a><a href="#先跑通项目" class="headerlink" title="先跑通项目"></a>先跑通项目</h1>
      
        <h2 id="尝试运行"   >
          <a href="#尝试运行" class="heading-link"><i class="fas fa-link"></i></a><a href="#尝试运行" class="headerlink" title="尝试运行"></a>尝试运行</h2>
      
        <h3 id="后端"   >
          <a href="#后端" class="heading-link"><i class="fas fa-link"></i></a><a href="#后端" class="headerlink" title="后端:"></a>后端:</h3>
      <p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230730100207953.png"  alt="image-20230730100207953">
      </p>
<p>|INFO|2023-07-30 09:50:38.781|main||uid&#x3D;|Tomcat initialized with port(s): 8080 (http)|</p>
<p>找到内置的tomcat服务器端口号是8080</p>

        <h3 id="前端"   >
          <a href="#前端" class="heading-link"><i class="fas fa-link"></i></a><a href="#前端" class="headerlink" title="前端:"></a>前端:</h3>
      <p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230730103826557.png"  alt="image-20230730103826557">
      </p>

        <h2 id="尝试进入Swagger"   >
          <a href="#尝试进入Swagger" class="heading-link"><i class="fas fa-link"></i></a><a href="#尝试进入Swagger" class="headerlink" title="尝试进入Swagger"></a>尝试进入Swagger</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.github.xiaoymin&lt;/groupId&gt;</span><br><span class="line">    &lt;!--使用Swagger2--&gt;</span><br><span class="line">    &lt;artifactId&gt;knife4j-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">2.0</span><span class="number">.9</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></div></figure>

<p>因为找到了Swagger2依赖 所以项目中用了Swagger</p>
<p>尝试进入Swagger-ui页面</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230730100713827.png"  alt="image-20230730100713827">
      </p>
<p>找到Swagger配置类</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SwaggerConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean(value = &quot;defaultApi2&quot;)</span></span><br><span class="line">    Docket <span class="title function_">docket</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Docket</span>(DocumentationType.SWAGGER_2)</span><br><span class="line">                <span class="comment">//配置网站的基本信息</span></span><br><span class="line">                .apiInfo(<span class="keyword">new</span> <span class="title class_">ApiInfoBuilder</span>()</span><br><span class="line">                        <span class="comment">//网站标题</span></span><br><span class="line">                        .title(<span class="string">&quot;mallchat接口文档&quot;</span>)</span><br><span class="line">                        <span class="comment">//标题后面的版本号</span></span><br><span class="line">                        .version(<span class="string">&quot;v1.0&quot;</span>)</span><br><span class="line">                        .description(<span class="string">&quot;mallchat接口文档&quot;</span>)</span><br><span class="line">                        <span class="comment">//联系人信息</span></span><br><span class="line">                        .contact(<span class="keyword">new</span> <span class="title class_">Contact</span>(<span class="string">&quot;阿斌&quot;</span>, <span class="string">&quot;http://www.mallchat.cn&quot;</span>, <span class="string">&quot;972627721@qq.com&quot;</span>))</span><br><span class="line">                        .build())</span><br><span class="line">                .select()</span><br><span class="line">                <span class="comment">//指定接口的位置</span></span><br><span class="line">                .apis(RequestHandlerSelectors</span><br><span class="line">                        .withClassAnnotation(RestController.class)</span><br><span class="line">                )</span><br><span class="line">                .paths(PathSelectors.any())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>

<p>通过mallchat文档中得知</p>
<p>SwaggerUI经过Knife4j优化之后URL变更了</p>
<p>从localhost:8080&#x2F;doc.html进入SwaggerUI中</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230730103929645.png"  alt="image-20230730103929645">
      </p>
<p>获得了接口列表</p>

        <h2 id="端口号分析"   >
          <a href="#端口号分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#端口号分析" class="headerlink" title="端口号分析"></a>端口号分析</h2>
      <p>3306: Mysql端口</p>
<p>6379: Redis端口</p>
<p>8080:本地tomcat端口</p>
<p>8090?</p>
<p>9000:minio端口</p>
<p>9001:minio控制台端口</p>
<p>9988?</p>

        <h2 id="进入前端界面尝试前后端联调"   >
          <a href="#进入前端界面尝试前后端联调" class="heading-link"><i class="fas fa-link"></i></a><a href="#进入前端界面尝试前后端联调" class="headerlink" title="进入前端界面尝试前后端联调"></a>进入前端界面尝试前后端联调</h2>
      <p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230730161607692.png"  alt="image-20230730161607692">
      </p>

        <h2 id="申请测试号，来进行获取微信信息"   >
          <a href="#申请测试号，来进行获取微信信息" class="heading-link"><i class="fas fa-link"></i></a><a href="#申请测试号，来进行获取微信信息" class="headerlink" title="申请测试号，来进行获取微信信息"></a>申请测试号，来进行获取微信信息</h2>
      <p>通过微信测试号可以获得登录的头像等微信信息</p>

        <h2 id="通过测试号获取到登录信息之后进入前端页面进行测试"   >
          <a href="#通过测试号获取到登录信息之后进入前端页面进行测试" class="heading-link"><i class="fas fa-link"></i></a><a href="#通过测试号获取到登录信息之后进入前端页面进行测试" class="headerlink" title="通过测试号获取到登录信息之后进入前端页面进行测试"></a>通过测试号获取到登录信息之后进入前端页面进行测试</h2>
      <p>清除浏览器Session然后重新刷新页面抓到初始化请求</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230730225147538.png"  alt="image-20230730225147538">
      </p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="/MallChat%E9%A1%B9%E7%9B%AE%E5%88%86%E6%9E%90/image-20230731101441566.png"  alt="image-20230731101441566">
      </p>
<div class="table-container"><table>
<thead>
<tr>
<th>name</th>
<th>请求类型</th>
<th>URL</th>
</tr>
</thead>
<tbody><tr>
<td>page?pageSize&#x3D;20</td>
<td>GET请求</td>
<td><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://localhost:9988/capi/chat/public/member/page?pageSize=20" >http://localhost:9988/capi/chat/public/member/page?pageSize=20</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td>
</tr>
<tr>
<td>statistic</td>
<td>GET请求</td>
<td><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://localhost:9988/capi/chat/public/member/statistic" >http://localhost:9988/capi/chat/public/member/statistic</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td>
</tr>
<tr>
<td>badges</td>
<td>GET请求</td>
<td><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://localhost:9988/capi/user/badges" >http://localhost:9988/capi/user/badges</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td>
</tr>
<tr>
<td>page?pageSize&#x3D;20&amp;roomId&#x3D;1</td>
<td>GET请求</td>
<td><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://localhost:9988/capi/chat/public/msg/page?pageSize=20&roomId=1" >http://localhost:9988/capi/chat/public/msg/page?pageSize=20&amp;roomId=1</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td>
</tr>
<tr>
<td>list</td>
<td>GET请求</td>
<td><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://localhost:9988/capi/user/emoji/list" >http://localhost:9988/capi/user/emoji/list</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td>
</tr>
</tbody></table></div>
<p>然后点击登录按钮</p>
<p>通过微信扫码登录到聊天室中</p>
<p>我们来看新增的两个请求</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230731100759932.png"  alt="image-20230731100759932">
      </p>
<div class="table-container"><table>
<thead>
<tr>
<th>name</th>
<th>请求类型</th>
<th>URL</th>
</tr>
</thead>
<tbody><tr>
<td>userInfo</td>
<td>GET请求</td>
<td><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://localhost:9988/capi/user/userInfo" >http://localhost:9988/capi/user/userInfo</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td>
</tr>
<tr>
<td>list?uid&#x3D;10003</td>
<td>GET请求</td>
<td><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://localhost:9988/capi/user/emoji/list?uid=10003" >http://localhost:9988/capi/user/emoji/list?uid=10003</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td>
</tr>
</tbody></table></div>
<p>这个登录是通过VX扫码实现的，我们之后再看这个逻辑实现</p>
<p>先从用户模块开始看吧</p>

        <h2 id="用户模块"   >
          <a href="#用户模块" class="heading-link"><i class="fas fa-link"></i></a><a href="#用户模块" class="headerlink" title="用户模块"></a>用户模块</h2>
      <p>从Swaager-ui发起测试请求，响应结果是未登录</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230731102513714.png"  alt="image-20230731102513714">
      </p>
<p>可知URI被拦截器拦截</p>
<p>找到Token拦截器</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">//获取用户登录token</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> getToken(request);</span><br><span class="line">    <span class="type">Long</span> <span class="variable">validUid</span> <span class="operator">=</span> loginService.getValidUid(token);</span><br><span class="line">    <span class="keyword">if</span> (Objects.nonNull(validUid)) &#123;<span class="comment">//有登录态</span></span><br><span class="line">        request.setAttribute(ATTRIBUTE_UID, validUid);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isPublicURI</span> <span class="operator">=</span> isPublicURI(request.getRequestURI());</span><br><span class="line">        <span class="keyword">if</span> (!isPublicURI) &#123;<span class="comment">//又没有登录态，又不是公开路径，直接401</span></span><br><span class="line">            HttpErrorEnum.ACCESS_DENIED.sendHttpError(response);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    MDC.put(MDCKey.UID, String.valueOf(validUid));</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>调用了一个isPublicURI方法 来判断是不是公开路径</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isPublicURI</span><span class="params">(String requestURI)</span> &#123;</span><br><span class="line">    String[] split = requestURI.split(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> split.length &gt; <span class="number">2</span> &amp;&amp; <span class="string">&quot;public&quot;</span>.equals(split[<span class="number">3</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//将请求通过&#x27;/&#x27;分割,当数组长度大于2并且第四块为public的时候说明是公开路径</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">例如 http://localhost:9988/capi/user/userInfo</span></span><br><span class="line"><span class="comment">通过&#x27;/&#x27;切割 </span></span><br><span class="line"><span class="comment">则</span></span><br><span class="line"><span class="comment">split[0],</span></span><br><span class="line"><span class="comment">split[1],capi</span></span><br><span class="line"><span class="comment">split[2],user</span></span><br><span class="line"><span class="comment">split[3],userInfo</span></span><br><span class="line"><span class="comment">例如 http://localhost:9988/capi/chat/public/member/page</span></span><br><span class="line"><span class="comment">则</span></span><br><span class="line"><span class="comment">split[0],</span></span><br><span class="line"><span class="comment">split[1],capi</span></span><br><span class="line"><span class="comment">split[2],chat</span></span><br><span class="line"><span class="comment">split[3],public</span></span><br><span class="line"><span class="comment">split[4],member</span></span><br><span class="line"><span class="comment">split[5],page</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>决定用通过登录之后的前端来进行测试</p>

        <h3 id="获得用户信息"   >
          <a href="#获得用户信息" class="heading-link"><i class="fas fa-link"></i></a><a href="#获得用户信息" class="headerlink" title="获得用户信息"></a>获得用户信息</h3>
      <div class="table-container"><table>
<thead>
<tr>
<th>访问uri</th>
<th>请求类型</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;capi&#x2F;user&#x2F;userInfo</td>
<td>GET请求</td>
</tr>
</tbody></table></div>

        <h4 id="Controller层"   >
          <a href="#Controller层" class="heading-link"><i class="fas fa-link"></i></a><a href="#Controller层" class="headerlink" title="Controller层"></a>Controller层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/userInfo&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;用户详情&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ApiResult&lt;UserInfoResp&gt; <span class="title function_">getUserInfo</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//通过获取请求的上下文获取uid调用userService.getUserInfo方法  传入具体的Uid</span></span><br><span class="line">    <span class="keyword">return</span> ApiResult.success(userService.getUserInfo(RequestHolder.get().getUid()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>调用getUserInfo方法</p>
<p>将返回结果封装成APIResult对象(统一返回类型)</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(&quot;基础返回体&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApiResult</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;成功标识true or false&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Boolean success;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;错误码&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer errCode;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;错误消息&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String errMsg;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;返回对象&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; ApiResult&lt;T&gt; <span class="title function_">success</span><span class="params">(T data)</span> &#123;</span><br><span class="line">        ApiResult&lt;T&gt; result = <span class="keyword">new</span> <span class="title class_">ApiResult</span>&lt;T&gt;();</span><br><span class="line">        result.setData(data);</span><br><span class="line">        result.setSuccess(Boolean.TRUE);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//传入的参数data是Controller层中的</span></span><br><span class="line"><span class="comment">//userService.getUserInfo(RequestHolder.get().getUid())</span></span><br></pre></td></tr></table></div></figure>


        <h4 id="UserService层"   >
          <a href="#UserService层" class="heading-link"><i class="fas fa-link"></i></a><a href="#UserService层" class="headerlink" title="UserService层"></a>UserService层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UserInfoResp <span class="title function_">getUserInfo</span><span class="params">(Long uid)</span>;</span><br></pre></td></tr></table></div></figure>

<p>实现类中</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> UserInfoResp <span class="title function_">getUserInfo</span><span class="params">(Long uid)</span> &#123;</span><br><span class="line">       <span class="comment">//查询缓存中有没有这个Uid,本质上调用map.get() 如果有则返回User 如果没有则返回null</span></span><br><span class="line">       <span class="type">User</span> <span class="variable">userInfo</span> <span class="operator">=</span> userCache.getUserInfo(uid);</span><br><span class="line">       <span class="comment">//查询当前用户(Uid)的物品改名卡使用状态</span></span><br><span class="line">       <span class="type">Integer</span> <span class="variable">countByValidItemId</span> <span class="operator">=</span></span><br><span class="line">           userBackpackDao.getCountByValidItemId(uid, ItemEnum.MODIFY_NAME_CARD.getId());</span><br><span class="line">       <span class="keyword">return</span> UserAdapter.buildUserInfoResp(userInfo, countByValidItemId);</span><br><span class="line">       <span class="comment">//将缓存中的数据和当前用户改名卡状态发送到适配器中buildUserInfoResp中</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="getUserInfo"   >
          <a href="#getUserInfo" class="heading-link"><i class="fas fa-link"></i></a><a href="#getUserInfo" class="headerlink" title="getUserInfo"></a>getUserInfo</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> User <span class="title function_">getUserInfo</span><span class="params">(Long uid)</span> &#123;<span class="comment">//todo 后期做二级缓存</span></span><br><span class="line">		<span class="comment">//调用getUserInfoBatch获取一个Map&lt;Long,user&gt; 然后调用Map的get方法  如果有数据返回User,没有返回null</span></span><br><span class="line">       <span class="keyword">return</span> getUserInfoBatch(Collections.singleton(uid)).get(uid);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="getInfoBatch"   >
          <a href="#getInfoBatch" class="heading-link"><i class="fas fa-link"></i></a><a href="#getInfoBatch" class="headerlink" title="getInfoBatch"></a>getInfoBatch</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Map&lt;Long, User&gt; <span class="title function_">getUserInfoBatch</span><span class="params">(Set&lt;Long&gt; uids)</span> &#123;</span><br><span class="line">    	<span class="comment">//将uids转换成流 然后调用RedisKey的封装类将其拼接成mallchat:userInfo:uid_%d的格式，然后转成List列表</span></span><br><span class="line">        List&lt;String&gt; keys = uids.stream().map(a -&gt; RedisKey.getKey(RedisKey.USER_INFO_STRING, a)).collect(Collectors.toList());</span><br><span class="line">    	<span class="comment">//调用RedisUtils的mget方法，返回多个User放到List中</span></span><br><span class="line">        List&lt;User&gt; mget = RedisUtils.mget(keys, User.class);</span><br><span class="line">    	<span class="comment">//过滤非空的对象，封装成Key为Uid,Value为User的map 这里的map是缓存中的map</span></span><br><span class="line">        Map&lt;Long, User&gt; map = mget.stream().filter(Objects::nonNull).collect(Collectors.toMap(User::getId, Function.identity()));</span><br><span class="line">        <span class="comment">//还需要load更新的uid</span></span><br><span class="line">    	<span class="comment">//找到不包含在缓存中的uid放到needLoadUidList中</span></span><br><span class="line">        List&lt;Long&gt; needLoadUidList = uids.stream().filter(a -&gt; !map.containsKey(a)).collect(Collectors.toList());</span><br><span class="line">    	<span class="comment">//如果needLoadUidList非空则说明有新数据要写到缓存中</span></span><br><span class="line">        <span class="keyword">if</span> (CollUtil.isNotEmpty(needLoadUidList)) &#123;</span><br><span class="line">            <span class="comment">//调用userDao的查询方法 ，UserDao调用getBaseMapper().selectBatchIds(idList)获取数据库中的user用户列表</span></span><br><span class="line">            List&lt;User&gt; needLoadUserList = userDao.listByIds(needLoadUidList);</span><br><span class="line">            <span class="comment">//统一转换成key为mallchat:userInfo:uid_%d,value为User的格式 放到Map</span></span><br><span class="line">            Map&lt;String, User&gt; redisMap = needLoadUserList.stream().collect(Collectors.toMap(a -&gt; RedisKey.getKey(RedisKey.USER_INFO_STRING, a.getId()), Function.identity()));</span><br><span class="line">            <span class="comment">//调用RedisUtils.mset 统一写进缓存 参数一:要写进去的数据,参数二:过期时间5*60</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">//将查询UserInfo的缓存设置为300s 即5分钟</span></span><br><span class="line">            RedisUtils.mset(redisMap, <span class="number">5</span> * <span class="number">60</span>);</span><br><span class="line">            <span class="comment">//将更新完到缓存的数据放回到map中，用于进行返回用户数据</span></span><br><span class="line">            map.putAll(needLoadUserList.stream().collect(Collectors.toMap(User::getId, Function.identity())));</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">//返回map</span></span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="UserBackPackDao"   >
          <a href="#UserBackPackDao" class="heading-link"><i class="fas fa-link"></i></a><a href="#UserBackPackDao" class="headerlink" title="UserBackPackDao"></a>UserBackPackDao</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserBackpackDao</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;UserBackpackMapper, UserBackpack&gt; &#123;</span><br><span class="line">	<span class="comment">//利用了MP</span></span><br><span class="line">	<span class="keyword">public</span> Integer <span class="title function_">getCountByValidItemId</span><span class="params">(Long uid, Long itemId)</span> &#123;</span><br><span class="line">        <span class="comment">//调用lambdaQuery方法</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//这个Select语句是 SELECT COUNT( 1 ) FROM user_backpack WHERE (uid = ? AND item_id = ? AND status = ?)</span></span><br><span class="line">        <span class="comment">//注入的参数是uid: 10004， itemId: 1 ,status =0</span></span><br><span class="line">        <span class="comment">//翻译过来是查询10004号用户，物品ID为1(改名卡),未被使用(0未使用,1已使用)</span></span><br><span class="line">        <span class="comment">//返回了1  即10004用户状态正如参数所示</span></span><br><span class="line">        <span class="keyword">return</span> lambdaQuery().eq(UserBackpack::getUid, uid)</span><br><span class="line">                .eq(UserBackpack::getItemId, itemId)</span><br><span class="line">                .eq(UserBackpack::getStatus, YesOrNoEnum.NO.getStatus())</span><br><span class="line">                .count();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="流程"   >
          <a href="#流程" class="heading-link"><i class="fas fa-link"></i></a><a href="#流程" class="headerlink" title="流程"></a>流程</h4>
      <p>①查询用户信息的时候，Controller调用service的查询userInfo的方法，传入请求中的uid 然后包装成APIResult返回前端</p>
<p>②serviceImpl 查询用户数据 直接查询缓存，如果查询到缓存则直接返回用户数据</p>
<p>③如果缓存中没有数据则通过userDao查询数据库，数据库返回到的数据先写回到Redis中设置过期时间为300秒</p>
<p>④将查询结果返回，然后查询用户物品使用信息 调用userBackpackDao的方法</p>
<p>⑤统一将用户详情信息、用户物品使用信息用userAdapter封装返回</p>

        <h3 id="修改用户名"   >
          <a href="#修改用户名" class="heading-link"><i class="fas fa-link"></i></a><a href="#修改用户名" class="headerlink" title="修改用户名"></a>修改用户名</h3>
      <p>访问uil</p>
<div class="table-container"><table>
<thead>
<tr>
<th>访问uil</th>
<th>请求类型</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;capi&#x2F;user&#x2F;name</td>
<td>PUT请求</td>
</tr>
</tbody></table></div>

        <h4 id="Controller层-1"   >
          <a href="#Controller层-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#Controller层-1" class="headerlink" title="Controller层"></a>Controller层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PutMapping(&quot;/name&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;修改用户名&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ApiResult&lt;Void&gt; <span class="title function_">modifyName</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> ModifyNameReq req)</span> &#123;</span><br><span class="line">    userService.modifyName(RequestHolder.get().getUid(), req);</span><br><span class="line">    <span class="keyword">return</span> ApiResult.success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>调用userService.modfiyName方法修改用户名</p>
<p>返回成功结果</p>

        <h4 id="UserService层-1"   >
          <a href="#UserService层-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#UserService层-1" class="headerlink" title="UserService层"></a>UserService层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">modifyName</span><span class="params">(Long uid, ModifyNameReq req)</span>;</span><br></pre></td></tr></table></div></figure>

<p>实现类中</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">modifyName</span><span class="params">(Long uid, ModifyNameReq req)</span> &#123;</span><br><span class="line">    <span class="comment">//从请求中获取新的用户名</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">newName</span> <span class="operator">=</span> req.getName();</span><br><span class="line">    <span class="comment">//检查用户名是否合法,如果不合法会抛出异常</span></span><br><span class="line">    AssertUtil.isFalse(sensitiveWordBs.hasSensitiveWord(newName), <span class="string">&quot;名字中包含敏感词，请重新输入&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//检查用户列表中有没有该用户使用这个用户名 如果有则会返回一个User</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">oldUser</span> <span class="operator">=</span> userDao.getByName(newName);</span><br><span class="line">    <span class="comment">//判断用户中有这个名字则抛出异常</span></span><br><span class="line">    AssertUtil.isEmpty(oldUser, <span class="string">&quot;名字已经被抢占了，请换一个哦~~&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//判断用户有没有改名机会，如果有改名机会则会返回一个UserBackpack 如果没有则会返回null</span></span><br><span class="line">    <span class="type">UserBackpack</span> <span class="variable">firstValidItem</span> <span class="operator">=</span> userBackpackDao.getFirstValidItem(uid, ItemEnum.MODIFY_NAME_CARD.getId());</span><br><span class="line">    <span class="comment">//如果没有改名卡则抛出异常</span></span><br><span class="line">    AssertUtil.isNotEmpty(firstValidItem, <span class="string">&quot;改名次数不够了，等后续活动送改名卡哦&quot;</span>);</span><br><span class="line">   </span><br><span class="line">    <span class="comment">//走到这里用户可以改名，然后判断有没有使用改名卡</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">useSuccess</span> <span class="operator">=</span> userBackpackDao.invalidItem(firstValidItem.getId());</span><br><span class="line">    <span class="comment">//采用乐观锁判断改名卡使用是否成功</span></span><br><span class="line">    <span class="keyword">if</span> (useSuccess) &#123;</span><br><span class="line">        <span class="comment">//如果用户改名成功，则进入条件判断中</span></span><br><span class="line">        <span class="comment">//改名</span></span><br><span class="line">        userDao.modifyName(uid, req.getName());</span><br><span class="line">       </span><br><span class="line">        <span class="comment">//调用userInfoChange(uid) 删除缓存中用户信息并更新缓存数据物品使用信息</span></span><br><span class="line">        userCache.userInfoChange(uid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="getFirstValidItem"   >
          <a href="#getFirstValidItem" class="heading-link"><i class="fas fa-link"></i></a><a href="#getFirstValidItem" class="headerlink" title="getFirstValidItem"></a>getFirstValidItem</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> UserBackpack <span class="title function_">getFirstValidItem</span><span class="params">(Long uid, Long itemId)</span> &#123;</span><br><span class="line">    	<span class="comment">//调用LambdaQueryWrapper可以使用匿名类和lambda表达式进行查询条件的拼接</span></span><br><span class="line">    </span><br><span class="line">    	<span class="comment">//SELECT id,uid,item_id,status,idempotent,create_time,update_time FROM user_backpack </span></span><br><span class="line">    	<span class="comment">//WHERE (uid = ? AND item_id = ? AND status = ?) limit 1	</span></span><br><span class="line">    	<span class="comment">//参数:10004(Long), 1(Long), 0(Integer)  </span></span><br><span class="line"> </span><br><span class="line">        LambdaQueryWrapper&lt;UserBackpack&gt; wrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;UserBackpack&gt;().lambda()</span><br><span class="line">                .eq(UserBackpack::getUid, uid)   <span class="comment">//限制uid相等</span></span><br><span class="line">                .eq(UserBackpack::getItemId, itemId)  <span class="comment">//限制itemId相等</span></span><br><span class="line">                .eq(UserBackpack::getStatus, YesOrNoEnum.NO.getStatus())  <span class="comment">//限制物品使用情况，0即未使用</span></span><br><span class="line">                .last(<span class="string">&quot;limit 1&quot;</span>);  <span class="comment">//只能返回一个</span></span><br><span class="line">    </span><br><span class="line">    	<span class="comment">//返回一条查询结果</span></span><br><span class="line">        <span class="keyword">return</span> getOne(wrapper);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="invaldItem"   >
          <a href="#invaldItem" class="heading-link"><i class="fas fa-link"></i></a><a href="#invaldItem" class="headerlink" title="invaldItem"></a>invaldItem</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">invalidItem</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">		<span class="comment">//使用改名卡,修改用户物品信息表</span></span><br><span class="line">        <span class="type">UserBackpack</span> <span class="variable">update</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserBackpack</span>();</span><br><span class="line">        update.setId(id);</span><br><span class="line">        update.setStatus(YesOrNoEnum.YES.getStatus());</span><br><span class="line">    </span><br><span class="line">    	<span class="comment">//UPDATE user_backpack SET status=? WHERE id=?</span></span><br><span class="line">    	<span class="comment">//参数：1(Integer), 2(Long)</span></span><br><span class="line">    	<span class="comment">//更新用户物品使用表，如果更新成功则返回true,如果更新失败则返回false</span></span><br><span class="line">        <span class="keyword">return</span> updateById(update);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="ModifyName"   >
          <a href="#ModifyName" class="heading-link"><i class="fas fa-link"></i></a><a href="#ModifyName" class="headerlink" title="ModifyName"></a>ModifyName</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">modifyName</span><span class="params">(Long uid, String name)</span> &#123;</span><br><span class="line">    	<span class="comment">//更新用户表，用户使用了改名卡修改名字</span></span><br><span class="line">    	<span class="type">User</span> <span class="variable">update</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        update.setId(uid);</span><br><span class="line">        update.setName(name);</span><br><span class="line">    	</span><br><span class="line">    	<span class="comment">//更新用户信息</span></span><br><span class="line">    	<span class="comment">//UPDATE user SET name=? WHERE id=?</span></span><br><span class="line">    	<span class="comment">//参数：鱼鱼(String), 10004(Long)</span></span><br><span class="line">        updateById(update);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="userInfoChange"   >
          <a href="#userInfoChange" class="heading-link"><i class="fas fa-link"></i></a><a href="#userInfoChange" class="headerlink" title="userInfoChange"></a>userInfoChange</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">userInfoChange</span><span class="params">(Long uid)</span> &#123;</span><br><span class="line">    	<span class="comment">//删除用户缓存</span></span><br><span class="line">        delUserInfo(uid);</span><br><span class="line">    	<span class="comment">//更新缓存中用户物品使用时间</span></span><br><span class="line">        refreshUserModifyTime(uid);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="流程-1"   >
          <a href="#流程-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#流程-1" class="headerlink" title="流程"></a>流程</h4>
      <p>①调用Controller来处理改名请求，Controller调用service来进行改名操作</p>
<p>②判断用户名是否合法、用户名是否被占用、是否有改名次数，如果都有则进入改名阶段,如果有其一没有则抛出异常</p>
<p>③改名，先修改改名卡使用情况，如果修改成功则代表着改名成功，如果修改失败则说明有线程竞争</p>
<p>④改名成功，删除缓存中用户信息，缓存添加修改使用物品时间</p>

        <h3 id="可选勋章预览"   >
          <a href="#可选勋章预览" class="heading-link"><i class="fas fa-link"></i></a><a href="#可选勋章预览" class="headerlink" title="可选勋章预览"></a>可选勋章预览</h3>
      <div class="table-container"><table>
<thead>
<tr>
<th>访问Uri</th>
<th>请求类型</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;capi&#x2F;user&#x2F;badges</td>
<td>GET请求</td>
</tr>
</tbody></table></div>

        <h4 id="Controller层-2"   >
          <a href="#Controller层-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#Controller层-2" class="headerlink" title="Controller层"></a>Controller层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/badges&quot;)</span></span><br><span class="line">   <span class="meta">@ApiOperation(&quot;可选徽章预览&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> ApiResult&lt;List&lt;BadgeResp&gt;&gt; <span class="title function_">badges</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> ApiResult.success(userService.badges(RequestHolder.get().getUid()));</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></div></figure>

<p>调用Service层的badges方法 传入参数是请求中的uid</p>

        <h4 id="Service层"   >
          <a href="#Service层" class="heading-link"><i class="fas fa-link"></i></a><a href="#Service层" class="headerlink" title="Service层"></a>Service层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;BadgeResp&gt; <span class="title function_">badges</span><span class="params">(Long uid)</span>;</span><br></pre></td></tr></table></div></figure>

<p>实现类</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;BadgeResp&gt; <span class="title function_">badges</span><span class="params">(Long uid)</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//查询Cache中勋章列表   参数Type:2 表示勋章</span></span><br><span class="line">    List&lt;ItemConfig&gt; itemConfigs = itemCache.getByType(ItemTypeEnum.BADGE.getType());</span><br><span class="line">  </span><br><span class="line">    <span class="comment">//查询uid下的可用勋章，然后返回一个List&lt;UserBackpack&gt;</span></span><br><span class="line">    List&lt;UserBackpack&gt; backpacks = userBackpackDao.getByItemIds(uid, itemConfigs.stream().map(ItemConfig::getId).collect(Collectors.toList()));</span><br><span class="line">   </span><br><span class="line">    <span class="comment">//根据uid查询用户信息，获取当前用户佩戴的勋章</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userDao.getById(uid);</span><br><span class="line">    <span class="comment">//将总勋章列表、用户可用勋章、当前用户佩戴勋章传入适配器中的buildBadgeResp中，然后返回给前端</span></span><br><span class="line">    <span class="keyword">return</span> UserAdapter.buildBadgeResp(itemConfigs, backpacks, user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="getByType"   >
          <a href="#getByType" class="heading-link"><i class="fas fa-link"></i></a><a href="#getByType" class="headerlink" title="getByType"></a>getByType</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Cacheable(cacheNames = &quot;item&quot;, key = &quot;&#x27;itemsByType:&#x27;+#type&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;ItemConfig&gt; <span class="title function_">getByType</span><span class="params">(Integer type)</span> &#123;</span><br><span class="line">        <span class="comment">//传入参数：2 表示勋章</span></span><br><span class="line">        <span class="comment">//调用itemConfigDao的方法 返回数据 写入缓存中</span></span><br><span class="line">        <span class="keyword">return</span> itemConfigDao.getByType(type);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>

<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;ItemConfig&gt; <span class="title function_">getByType</span><span class="params">(Integer type)</span> &#123;</span><br><span class="line">    <span class="comment">//返回list,list中装着ambdaQuery查询结果</span></span><br><span class="line">    </span><br><span class="line"> 	<span class="comment">//SELECT id,type,img,`describe`,create_time,update_time FROM item_config WHERE (type = ?) </span></span><br><span class="line">    <span class="comment">//限制Type==type,然后转化成list</span></span><br><span class="line">    <span class="keyword">return</span> lambdaQuery().eq(ItemConfig::getType, type).list();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="getByItemId"   >
          <a href="#getByItemId" class="heading-link"><i class="fas fa-link"></i></a><a href="#getByItemId" class="headerlink" title="getByItemId"></a>getByItemId</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;UserBackpack&gt; <span class="title function_">getByItemIds</span><span class="params">(Long uid, List&lt;Long&gt; itemIds)</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//Preparing: SELECT id,uid,item_id,status,idempotent,create_time,update_time </span></span><br><span class="line">    <span class="comment">//FROM user_backpack WHERE (uid = ? AND item_id IN (?,?,?,?,?) AND status = ?)</span></span><br><span class="line">	<span class="comment">//==&gt; Parameters: 10004(Long), 2(Long), 3(Long), 4(Long), 5(Long), 6(Long), 0(Integer)</span></span><br><span class="line">    			<span class="comment">//返回LambdaQuery结果</span></span><br><span class="line">    			<span class="comment">//查询条件限制uid相等</span></span><br><span class="line">    	<span class="keyword">return</span> lambdaQuery().eq(UserBackpack::getUid, uid)</span><br><span class="line">        		<span class="comment">//在总勋章列表中的itemIds</span></span><br><span class="line">                .in(UserBackpack::getItemId, itemIds)</span><br><span class="line">            	<span class="comment">//是否使用勋章</span></span><br><span class="line">                .eq(UserBackpack::getStatus, YesOrNoEnum.NO.getStatus())</span><br><span class="line">                .list();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//这个方法就是判断用户是否有拥有的勋章</span></span><br></pre></td></tr></table></div></figure>


        <h4 id="userDao-getById"   >
          <a href="#userDao-getById" class="heading-link"><i class="fas fa-link"></i></a><a href="#userDao-getById" class="headerlink" title="userDao.getById"></a>userDao.getById</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">default</span> T <span class="title function_">getById</span><span class="params">(Serializable id)</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//SELECT id,name,avatar,sex,open_id,last_opt_time,ip_info,item_id,status,create_time,update_time 			//FROM user WHERE id=?</span></span><br><span class="line">    <span class="comment">//调用mp的方法，查询uid为id的用户信息，获取当前用户佩戴的勋章</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.getBaseMapper().selectById(id);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="buildBadgeResp"   >
          <a href="#buildBadgeResp" class="heading-link"><i class="fas fa-link"></i></a><a href="#buildBadgeResp" class="headerlink" title="buildBadgeResp"></a>buildBadgeResp</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;BadgeResp&gt; <span class="title function_">buildBadgeResp</span><span class="params">(List&lt;ItemConfig&gt; itemConfigs, List&lt;UserBackpack&gt; backpacks, User user)</span> &#123;</span><br><span class="line">    	<span class="comment">//判断user是否为空</span></span><br><span class="line">        <span class="keyword">if</span> (ObjectUtil.isNull(user)) &#123;</span><br><span class="line">            <span class="comment">// 这里 user 入参可能为空，防止 NPE 问题</span></span><br><span class="line">            <span class="comment">//如果为空则返回空集合</span></span><br><span class="line">            <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">        &#125;</span><br><span class="line">	</span><br><span class="line">    	<span class="comment">//将用户的可用勋章方法哦obtianItemSet中</span></span><br><span class="line">        Set&lt;Long&gt; obtainItemSet = 						backpacks.stream().map(UserBackpack::getItemId).collect(Collectors.toSet());</span><br><span class="line">    	<span class="comment">//利用总勋章列表放到流中</span></span><br><span class="line">        <span class="keyword">return</span> itemConfigs.stream().map(a -&gt; &#123;</span><br><span class="line">            <span class="comment">//new一个勋章返回类型</span></span><br><span class="line">            <span class="type">BadgeResp</span> <span class="variable">resp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadgeResp</span>();</span><br><span class="line">            <span class="comment">//将a的属性copy到resp中</span></span><br><span class="line">            BeanUtil.copyProperties(a, resp);</span><br><span class="line">            <span class="comment">//设置勋章ID，为了下一步与用户是否佩戴进行一个比较</span></span><br><span class="line">            resp.setObtain(obtainItemSet.contains(a.getId()) ? YesOrNoEnum.YES.getStatus() : YesOrNoEnum.NO.getStatus());</span><br><span class="line">            <span class="comment">//用户列表中是否有使用这个勋章，如果有则是佩戴勋章</span></span><br><span class="line">            resp.setWearing(ObjectUtil.equal(a.getId(), user.getItemId()) ? YesOrNoEnum.YES.getStatus() : YesOrNoEnum.NO.getStatus());</span><br><span class="line">            <span class="keyword">return</span> resp;</span><br><span class="line">            <span class="comment">//排序</span></span><br><span class="line">        &#125;).sorted(Comparator.comparing(BadgeResp::getWearing, Comparator.reverseOrder())</span><br><span class="line">                .thenComparing(BadgeResp::getObtain, Comparator.reverseOrder()))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="流程-2"   >
          <a href="#流程-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#流程-2" class="headerlink" title="流程"></a>流程</h4>
      <p>①Controller调用Service中的方法，封装成APIResult返回</p>
<p>②Service中先获取总的勋章列表并写入缓存中，其次再获取用户可用的勋章列表，最后获取用户信息来判断佩戴的勋章</p>
<p>③将总勋章列表、可用勋章列表、用户佩戴勋章传入适配器，适配器进行一个buildBadgeResp方法返回前端</p>

        <h3 id="佩戴勋章"   >
          <a href="#佩戴勋章" class="heading-link"><i class="fas fa-link"></i></a><a href="#佩戴勋章" class="headerlink" title="佩戴勋章"></a>佩戴勋章</h3>
      <div class="table-container"><table>
<thead>
<tr>
<th>访问URI</th>
<th>请求类型</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;capi&#x2F;user&#x2F;badge</td>
<td>PUT请求</td>
</tr>
</tbody></table></div>

        <h4 id="Controller层-3"   >
          <a href="#Controller层-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#Controller层-3" class="headerlink" title="Controller层"></a>Controller层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PutMapping(&quot;/badge&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;佩戴徽章&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ApiResult&lt;Void&gt; <span class="title function_">wearingBadge</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> WearingBadgeReq req)</span> &#123;</span><br><span class="line">    userService.wearingBadge(RequestHolder.get().getUid(), req);</span><br><span class="line">    <span class="keyword">return</span> ApiResult.success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>从请求中获取uid和整个请求都传入给userService.wearingBadge</p>

        <h4 id="Service层-1"   >
          <a href="#Service层-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#Service层-1" class="headerlink" title="Service层"></a>Service层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">wearingBadge</span><span class="params">(Long uid, WearingBadgeReq req)</span>;</span><br></pre></td></tr></table></div></figure>

<p>实现类中</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">wearingBadge</span><span class="params">(Long uid, WearingBadgeReq req)</span> &#123;</span><br><span class="line">    <span class="comment">//判断用户是否有这个勋章</span></span><br><span class="line">    <span class="type">UserBackpack</span> <span class="variable">firstValidItem</span> <span class="operator">=</span> userBackpackDao.getFirstValidItem(uid, req.getBadgeId());</span><br><span class="line">    <span class="comment">//如果没有勋章则会返回为null，为null则抛出异常</span></span><br><span class="line">    AssertUtil.isNotEmpty(firstValidItem, <span class="string">&quot;您没有这个徽章哦，快去达成条件获取吧&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//判断这个是不是勋章</span></span><br><span class="line">    <span class="type">ItemConfig</span> <span class="variable">itemConfig</span> <span class="operator">=</span> itemConfigDao.getById(firstValidItem.getItemId());</span><br><span class="line">    <span class="comment">//如果返回字段中类型不是勋章则会抛出异常</span></span><br><span class="line">    AssertUtil.equal(itemConfig.getType(), ItemTypeEnum.BADGE.getType(), <span class="string">&quot;该徽章不可佩戴&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//佩戴勋章 更新用户表</span></span><br><span class="line">    userDao.wearingBadge(uid, req.getBadgeId());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    userCache.userInfoChange(uid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>先调用getFirstValidItem方法 这里和使用改名卡那个方法是同一个，意义是确认是否拥有这个勋章如果有则会返回一条数据，如果没有则返回null</p>

        <h4 id="getFirstValidItem-1"   >
          <a href="#getFirstValidItem-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#getFirstValidItem-1" class="headerlink" title="getFirstValidItem"></a>getFirstValidItem</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> UserBackpack <span class="title function_">getFirstValidItem</span><span class="params">(Long uid, Long itemId)</span> &#123;</span><br><span class="line">    	<span class="comment">//调用LambdaQueryWrapper可以使用匿名类和lambda表达式进行查询条件的拼接</span></span><br><span class="line">    </span><br><span class="line">    	<span class="comment">//SELECT id,uid,item_id,status,idempotent,create_time,update_time FROM user_backpack </span></span><br><span class="line">    	<span class="comment">//WHERE (uid = ? AND item_id = ? AND status = ?) limit 1	</span></span><br><span class="line">    	<span class="comment">//参数:10004(Long), 2(Long), 0(Integer)  -0表示没有使用过 -1表示使用过  </span></span><br><span class="line"> </span><br><span class="line">        LambdaQueryWrapper&lt;UserBackpack&gt; wrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;UserBackpack&gt;().lambda()</span><br><span class="line">                .eq(UserBackpack::getUid, uid)   <span class="comment">//限制uid相等</span></span><br><span class="line">                .eq(UserBackpack::getItemId, itemId)  <span class="comment">//限制itemId相等</span></span><br><span class="line">                .eq(UserBackpack::getStatus, YesOrNoEnum.NO.getStatus())  <span class="comment">//限制物品使用情况，0即未使用</span></span><br><span class="line">                .last(<span class="string">&quot;limit 1&quot;</span>);  <span class="comment">//只能返回一个</span></span><br><span class="line">    </span><br><span class="line">    	<span class="comment">//返回一条查询结果</span></span><br><span class="line">        <span class="keyword">return</span> getOne(wrapper);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="itemConfigDao-getById"   >
          <a href="#itemConfigDao-getById" class="heading-link"><i class="fas fa-link"></i></a><a href="#itemConfigDao-getById" class="headerlink" title="itemConfigDao.getById"></a>itemConfigDao.getById</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//SELECT id,type,img,`describe`,create_time,update_time FROM item_config WHERE id=?</span></span><br><span class="line"><span class="comment">//Parameters: 2(Long)</span></span><br></pre></td></tr></table></div></figure>

<p>判断这个物品是不是勋章 ，查询结果会包含一个type字段，通过字段来判断是不是勋章</p>

        <h4 id="wearingBadge"   >
          <a href="#wearingBadge" class="heading-link"><i class="fas fa-link"></i></a><a href="#wearingBadge" class="headerlink" title="wearingBadge"></a>wearingBadge</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">wearingBadge</span><span class="params">(Long uid, Long badgeId)</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">update</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    <span class="comment">//设置Uid</span></span><br><span class="line">    update.setId(uid);</span><br><span class="line">    <span class="comment">//设置使用物品类型  即勋章类型</span></span><br><span class="line">    update.setItemId(badgeId);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//==&gt;  Preparing: UPDATE user SET item_id=? WHERE id=?</span></span><br><span class="line">	<span class="comment">//==&gt; Parameters: 2(Long), 10004(Long)</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//更新user表</span></span><br><span class="line">    updateById(update);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="userInfoChange-1"   >
          <a href="#userInfoChange-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#userInfoChange-1" class="headerlink" title="userInfoChange"></a>userInfoChange</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">userInfoChange</span><span class="params">(Long uid)</span> &#123;</span><br><span class="line">    	<span class="comment">//删除用户缓存</span></span><br><span class="line">        delUserInfo(uid);</span><br><span class="line">    	<span class="comment">//更新缓存中用户物品使用时间</span></span><br><span class="line">        refreshUserModifyTime(uid);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="流程-3"   >
          <a href="#流程-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#流程-3" class="headerlink" title="流程"></a>流程</h4>
      <p>①先判断用户是否有这个物品。如果没有会抛出异常</p>
<p>②判断在合格物品是不是勋章。如果不是会抛出异常</p>
<p>③更新用户表信息，将Item_id设置为这个物品</p>
<p>④更新缓存，删除本地缓存删除Redis缓存</p>

        <h3 id="黑名单"   >
          <a href="#黑名单" class="heading-link"><i class="fas fa-link"></i></a><a href="#黑名单" class="headerlink" title="黑名单"></a>黑名单</h3>
      <div class="table-container"><table>
<thead>
<tr>
<th>访问URI</th>
<th>请求类型</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;capi&#x2F;user&#x2F;black</td>
<td>PUT请求</td>
</tr>
</tbody></table></div>

        <h4 id="Controller层-4"   >
          <a href="#Controller层-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#Controller层-4" class="headerlink" title="Controller层"></a>Controller层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PutMapping(&quot;/black&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;拉黑用户&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ApiResult&lt;Void&gt; <span class="title function_">black</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> BlackReq req)</span> &#123;</span><br><span class="line">    <span class="comment">//从请求上下文中获取拉黑用户uid</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">uid</span> <span class="operator">=</span> RequestHolder.get().getUid();</span><br><span class="line">    <span class="comment">//判断拉黑目标用户是否是管理员，如果是管理员返回true</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">hasPower</span> <span class="operator">=</span> iRoleService.hasPower(uid, RoleEnum.ADMIN);</span><br><span class="line">    <span class="comment">//如果是管理员则抛出异常没有权限拉黑</span></span><br><span class="line">    AssertUtil.isTrue(hasPower, <span class="string">&quot;没有权限&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//没有异常则可以运行到这里 说明有权限 调用Service方法来拉黑用户</span></span><br><span class="line">    userService.black(req);</span><br><span class="line">    <span class="keyword">return</span> ApiResult.success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="Service层-2"   >
          <a href="#Service层-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#Service层-2" class="headerlink" title="Service层"></a>Service层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">black</span><span class="params">(BlackReq req)</span>;</span><br></pre></td></tr></table></div></figure>

<p>实现类中</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">black</span><span class="params">(BlackReq req)</span> &#123;</span><br><span class="line">    <span class="comment">//从请求上下文中获取要拉黑用户Uid</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">uid</span> <span class="operator">=</span> req.getUid();</span><br><span class="line">    <span class="comment">//创建一个黑名单用户</span></span><br><span class="line">    <span class="type">Black</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Black</span>();</span><br><span class="line">    <span class="comment">//设置拉黑用户UID、拉黑类型为UID  还有一种拉黑是拉黑IP地址</span></span><br><span class="line">    user.setTarget(uid.toString());</span><br><span class="line">    user.setType(BlackTypeEnum.UID.getType());</span><br><span class="line">    <span class="comment">//调用blackDao中的save方法 插入一条用户数据到User表中</span></span><br><span class="line">    </span><br><span class="line">    blackDao.save(user);</span><br><span class="line">    <span class="comment">//查询用户表中的UID用户 </span></span><br><span class="line">    <span class="type">User</span> <span class="variable">byId</span> <span class="operator">=</span> userDao.getById(uid);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//拉黑IP地址 一个是创建用户IP地址 一个是最后更新用户的IP地址 两个IP都拉黑</span></span><br><span class="line">    blackIp(byId.getIpInfo().getCreateIp());</span><br><span class="line">    blackIp(byId.getIpInfo().getUpdateIp());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//发布一条事件 一个用户拉黑事件</span></span><br><span class="line">    applicationEventPublisher.publishEvent(<span class="keyword">new</span> <span class="title class_">UserBlackEvent</span>(<span class="built_in">this</span>, byId));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h4 id="blackIp"   >
          <a href="#blackIp" class="heading-link"><i class="fas fa-link"></i></a><a href="#blackIp" class="headerlink" title="blackIp"></a>blackIp</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">blackIp</span><span class="params">(String ip)</span> &#123;</span><br><span class="line">    <span class="comment">//判断IP是否为空，如果为空则直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isBlank(ip)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//创建一个拉黑用户</span></span><br><span class="line">        <span class="type">Black</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Black</span>();</span><br><span class="line">        <span class="comment">//设置IP地址</span></span><br><span class="line">        user.setTarget(ip);</span><br><span class="line">        user.setType(BlackTypeEnum.IP.getType());</span><br><span class="line">        <span class="comment">//更新黑名单表</span></span><br><span class="line">        blackDao.save(user);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;duplicate black ip:&#123;&#125;&quot;</span>, ip);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="hasPower"   >
          <a href="#hasPower" class="heading-link"><i class="fas fa-link"></i></a><a href="#hasPower" class="headerlink" title="hasPower"></a>hasPower</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasPower</span><span class="params">(Long uid, RoleEnum roleEnum)</span> &#123;<span class="comment">//超级管理员无敌的好吧，后期做成权限=》资源模式</span></span><br><span class="line">    Set&lt;Long&gt; roleSet = userCache.getRoleSet(uid);</span><br><span class="line">    <span class="keyword">return</span> isAdmin(roleSet) || roleSet.contains(roleEnum.getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="getRoleSet"   >
          <a href="#getRoleSet" class="heading-link"><i class="fas fa-link"></i></a><a href="#getRoleSet" class="headerlink" title="getRoleSet"></a>getRoleSet</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Cacheable(cacheNames = &quot;user&quot;, key = &quot;&#x27;roles&#x27;+#uid&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Set&lt;Long&gt; <span class="title function_">getRoleSet</span><span class="params">(Long uid)</span> &#123;</span><br><span class="line">    <span class="comment">//查询数据库判断是否有管理员身份</span></span><br><span class="line">    List&lt;UserRole&gt; userRoles = userRoleDao.listByUid(uid);</span><br><span class="line">    <span class="comment">//将用户身份返回一个set</span></span><br><span class="line">    <span class="keyword">return</span> userRoles.stream()</span><br><span class="line">            .map(UserRole::getRoleId)</span><br><span class="line">            .collect(Collectors.toSet());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="listByUid"   >
          <a href="#listByUid" class="heading-link"><i class="fas fa-link"></i></a><a href="#listByUid" class="headerlink" title="listByUid"></a>listByUid</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;UserRole&gt; <span class="title function_">listByUid</span><span class="params">(Long uid)</span> &#123;</span><br><span class="line">    <span class="comment">//查询user_role表 通过uid来查询身份 返回集合</span></span><br><span class="line">    <span class="keyword">return</span> lambdaQuery()</span><br><span class="line">            .eq(UserRole::getUid, Objects.requireNonNull(uid))</span><br><span class="line">            .list();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="流程-4"   >
          <a href="#流程-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#流程-4" class="headerlink" title="流程"></a>流程</h4>
      <p>①判断目标拉黑用户是否是管理员，如果是管理员则没有权限拉黑抛出异常结束方法，如果不是管理员则继续拉黑操作</p>
<p>②插入一条拉黑用户信息到拉黑数据表中 先是拉黑UID</p>
<p>③再判断创造用户时IP是否存在，如果存在则插入一条创建IP地址的拉黑用户信息</p>
<p>④再判断更新用户时IP是否存在，如果存在则插入一条更新IP地址的拉黑用户信息</p>
<p>⑤发布一条事件，用户拉黑事件</p>

        <h3 id="徽章聚合信息"   >
          <a href="#徽章聚合信息" class="heading-link"><i class="fas fa-link"></i></a><a href="#徽章聚合信息" class="headerlink" title="徽章聚合信息"></a>徽章聚合信息</h3>
      <div class="table-container"><table>
<thead>
<tr>
<th>访问URI</th>
<th>请求类型</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;capi&#x2F;user&#x2F;public&#x2F;badges&#x2F;batch</td>
<td>POST请求</td>
</tr>
</tbody></table></div>

        <h4 id="Controller层-5"   >
          <a href="#Controller层-5" class="heading-link"><i class="fas fa-link"></i></a><a href="#Controller层-5" class="headerlink" title="Controller层"></a>Controller层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/public/badges/batch&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;徽章聚合信息-返回的代表需要刷新的&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ApiResult&lt;List&lt;ItemInfoDTO&gt;&gt; <span class="title function_">getItemInfo</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> ItemInfoReq req)</span> &#123;</span><br><span class="line">    <span class="comment">//调用service层中的getItemInfo方法</span></span><br><span class="line">    <span class="keyword">return</span> ApiResult.success(userService.getItemInfo(req));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="Service层-3"   >
          <a href="#Service层-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#Service层-3" class="headerlink" title="Service层"></a>Service层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;ItemInfoDTO&gt; <span class="title function_">getItemInfo</span><span class="params">(ItemInfoReq req)</span>;</span><br></pre></td></tr></table></div></figure>

<p>实现类中</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;ItemInfoDTO&gt; <span class="title function_">getItemInfo</span><span class="params">(ItemInfoReq req)</span> &#123;<span class="comment">//简单做，更新时间可判断被修改</span></span><br><span class="line">    <span class="comment">//req.getReqList中包含itemId(物品id)，ItemModifyTime(修改时间)</span></span><br><span class="line">    <span class="keyword">return</span> req.getReqList().stream().map(a -&gt; &#123;</span><br><span class="line">        <span class="comment">//查询itemCache调用getById方法获取ItemConfig</span></span><br><span class="line">        <span class="type">ItemConfig</span> <span class="variable">itemConfig</span> <span class="operator">=</span> itemCache.getById(a.getItemId());</span><br><span class="line">        <span class="comment">//如果修改时间非空 并且最后修改时间要在物品更新时间之后 也即合法</span></span><br><span class="line">        <span class="keyword">if</span> (Objects.nonNull(a.getLastModifyTime()) &amp;&amp; a.getLastModifyTime() &gt;= itemConfig.getUpdateTime().getTime()) &#123;</span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="keyword">return</span> ItemInfoDTO.skip(a.getItemId());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//修改时间为空或者修改时间不合法</span></span><br><span class="line">        <span class="type">ItemInfoDTO</span> <span class="variable">dto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ItemInfoDTO</span>();</span><br><span class="line">        <span class="comment">//设置ItemId，Img,Describe</span></span><br><span class="line">        dto.setItemId(itemConfig.getId());</span><br><span class="line">        dto.setImg(itemConfig.getImg());</span><br><span class="line">        dto.setDescribe(itemConfig.getDescribe());</span><br><span class="line">        <span class="comment">//封装成dto</span></span><br><span class="line">        <span class="keyword">return</span> dto;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="getById"   >
          <a href="#getById" class="heading-link"><i class="fas fa-link"></i></a><a href="#getById" class="headerlink" title="getById"></a>getById</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Cacheable(cacheNames = &quot;item&quot;, key = &quot;&#x27;item:&#x27;+#itemId&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ItemConfig <span class="title function_">getById</span><span class="params">(Long itemId)</span> &#123;</span><br><span class="line">    <span class="comment">//SELECT id,type,img,`describe`,create_time,update_time FROM item_config WHERE id=?</span></span><br><span class="line">    <span class="keyword">return</span> itemConfigDao.getById(itemId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="skip"   >
          <a href="#skip" class="heading-link"><i class="fas fa-link"></i></a><a href="#skip" class="headerlink" title="skip"></a>skip</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ItemInfoDTO <span class="title function_">skip</span><span class="params">(Long itemId)</span> &#123;</span><br><span class="line">        <span class="type">ItemInfoDTO</span> <span class="variable">dto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ItemInfoDTO</span>();</span><br><span class="line">    	<span class="comment">//设置ItemID，类型为不需要刷新类型</span></span><br><span class="line">        dto.setItemId(itemId);</span><br><span class="line">        dto.setNeedRefresh(Boolean.FALSE);</span><br><span class="line">        <span class="keyword">return</span> dto;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>




        <h3 id="用户聚合信息"   >
          <a href="#用户聚合信息" class="heading-link"><i class="fas fa-link"></i></a><a href="#用户聚合信息" class="headerlink" title="用户聚合信息"></a>用户聚合信息</h3>
      <div class="table-container"><table>
<thead>
<tr>
<th>访问URI</th>
<th>请求类型</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;public&#x2F;summary&#x2F;userInfo&#x2F;batc</td>
<td>POST请求</td>
</tr>
</tbody></table></div>

        <h4 id="Controller层-6"   >
          <a href="#Controller层-6" class="heading-link"><i class="fas fa-link"></i></a><a href="#Controller层-6" class="headerlink" title="Controller层"></a>Controller层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/public/summary/userInfo/batch&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;用户聚合信息-返回的代表需要刷新的&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ApiResult&lt;List&lt;SummeryInfoDTO&gt;&gt; <span class="title function_">getSummeryUserInfo</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> SummeryInfoReq req)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> ApiResult.success(userService.getSummeryUserInfo(req));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h4 id="Service层-4"   >
          <a href="#Service层-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#Service层-4" class="headerlink" title="Service层"></a>Service层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;SummeryInfoDTO&gt; <span class="title function_">getSummeryUserInfo</span><span class="params">(SummeryInfoReq req)</span>;</span><br></pre></td></tr></table></div></figure>

<p>实现类中</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;SummeryInfoDTO&gt; <span class="title function_">getSummeryUserInfo</span><span class="params">(SummeryInfoReq req)</span> &#123;</span><br><span class="line">    <span class="comment">//获取用户uidList</span></span><br><span class="line">    List&lt;Long&gt; uidList = getNeedSyncUidList(req.getReqList());</span><br><span class="line">    <span class="comment">//加载用户信息</span></span><br><span class="line">    Map&lt;Long, SummeryInfoDTO&gt; batch = userSummaryCache.getBatch(uidList);</span><br><span class="line">    <span class="comment">//返回数据</span></span><br><span class="line">    <span class="keyword">return</span> req.getReqList()</span><br><span class="line">            .stream()</span><br><span class="line">            .map(a -&gt; batch.containsKey(a.getUid()) ? batch.get(a.getUid():SummeryInfoDTO.skip(a.getUid()))</span><br><span class="line">                 <span class="comment">//判断cache中是否有uid如果有则直接调用cache的，如果没有则封装成dto返回</span></span><br><span class="line">            .filter(Objects::nonNull)</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="skip-1"   >
          <a href="#skip-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#skip-1" class="headerlink" title="skip"></a>skip</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> SummeryInfoDTO <span class="title function_">skip</span><span class="params">(Long uid)</span> &#123;</span><br><span class="line">    <span class="type">SummeryInfoDTO</span> <span class="variable">dto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SummeryInfoDTO</span>();</span><br><span class="line">    dto.setUid(uid);</span><br><span class="line">    dto.setNeedRefresh(Boolean.FALSE);</span><br><span class="line">    <span class="keyword">return</span> dto;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="总览"   >
          <a href="#总览" class="heading-link"><i class="fas fa-link"></i></a><a href="#总览" class="headerlink" title="总览"></a>总览</h3>
      
        <h4 id="UserController"   >
          <a href="#UserController" class="heading-link"><i class="fas fa-link"></i></a><a href="#UserController" class="headerlink" title="UserController"></a>UserController</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/capi/user&quot;)</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;用户管理相关接口&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IRoleService iRoleService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/userInfo&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;用户详情&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ApiResult&lt;UserInfoResp&gt; <span class="title function_">getUserInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ApiResult.success(userService.getUserInfo(RequestHolder.get().getUid()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/public/summary/userInfo/batch&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;用户聚合信息-返回的代表需要刷新的&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ApiResult&lt;List&lt;SummeryInfoDTO&gt;&gt; <span class="title function_">getSummeryUserInfo</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> SummeryInfoReq req)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ApiResult.success(userService.getSummeryUserInfo(req));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/public/badges/batch&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;徽章聚合信息-返回的代表需要刷新的&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ApiResult&lt;List&lt;ItemInfoDTO&gt;&gt; <span class="title function_">getItemInfo</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> ItemInfoReq req)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ApiResult.success(userService.getItemInfo(req));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PutMapping(&quot;/name&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;修改用户名&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ApiResult&lt;Void&gt; <span class="title function_">modifyName</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> ModifyNameReq req)</span> &#123;</span><br><span class="line">        userService.modifyName(RequestHolder.get().getUid(), req);</span><br><span class="line">        <span class="keyword">return</span> ApiResult.success();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/badges&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;可选徽章预览&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ApiResult&lt;List&lt;BadgeResp&gt;&gt; <span class="title function_">badges</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ApiResult.success(userService.badges(RequestHolder.get().getUid()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PutMapping(&quot;/badge&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;佩戴徽章&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ApiResult&lt;Void&gt; <span class="title function_">wearingBadge</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> WearingBadgeReq req)</span> &#123;</span><br><span class="line">        userService.wearingBadge(RequestHolder.get().getUid(), req);</span><br><span class="line">        <span class="keyword">return</span> ApiResult.success();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PutMapping(&quot;/black&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;拉黑用户&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ApiResult&lt;Void&gt; <span class="title function_">black</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> BlackReq req)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">uid</span> <span class="operator">=</span> RequestHolder.get().getUid();</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">hasPower</span> <span class="operator">=</span> iRoleService.hasPower(uid, RoleEnum.ADMIN);</span><br><span class="line">        AssertUtil.isTrue(hasPower, <span class="string">&quot;没有权限&quot;</span>);</span><br><span class="line">        userService.black(req);</span><br><span class="line">        <span class="keyword">return</span> ApiResult.success();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="UserService"   >
          <a href="#UserService" class="heading-link"><i class="fas fa-link"></i></a><a href="#UserService" class="headerlink" title="UserService"></a>UserService</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取前端展示信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> uid</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    UserInfoResp <span class="title function_">getUserInfo</span><span class="params">(Long uid)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改用户名</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> uid</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> req</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">modifyName</span><span class="params">(Long uid, ModifyNameReq req)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户徽章列表</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> uid</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;BadgeResp&gt; <span class="title function_">badges</span><span class="params">(Long uid)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 佩戴徽章</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> uid</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> req</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">wearingBadge</span><span class="params">(Long uid, WearingBadgeReq req)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户注册</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> openId</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(String openId)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">black</span><span class="params">(BlackReq req)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取用户汇总信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> req</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;SummeryInfoDTO&gt; <span class="title function_">getSummeryUserInfo</span><span class="params">(SummeryInfoReq req)</span>;</span><br><span class="line"></span><br><span class="line">    List&lt;ItemInfoDTO&gt; <span class="title function_">getItemInfo</span><span class="params">(ItemInfoReq req)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h4 id="UserServiceImpl"   >
          <a href="#UserServiceImpl" class="heading-link"><i class="fas fa-link"></i></a><a href="#UserServiceImpl" class="headerlink" title="UserServiceImpl"></a>UserServiceImpl</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserCache userCache;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserBackpackDao userBackpackDao;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ItemConfigDao itemConfigDao;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ApplicationEventPublisher applicationEventPublisher;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ItemCache itemCache;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BlackDao blackDao;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserSummaryCache userSummaryCache;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SensitiveWordBs sensitiveWordBs;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserInfoResp <span class="title function_">getUserInfo</span><span class="params">(Long uid)</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">userInfo</span> <span class="operator">=</span> userCache.getUserInfo(uid);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">countByValidItemId</span> <span class="operator">=</span> userBackpackDao.getCountByValidItemId(uid, ItemEnum.MODIFY_NAME_CARD.getId());</span><br><span class="line">        <span class="keyword">return</span> UserAdapter.buildUserInfoResp(userInfo, countByValidItemId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">modifyName</span><span class="params">(Long uid, ModifyNameReq req)</span> &#123;</span><br><span class="line">        <span class="comment">//判断名字是不是重复</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">newName</span> <span class="operator">=</span> req.getName();</span><br><span class="line">        AssertUtil.isFalse(sensitiveWordBs.hasSensitiveWord(newName), <span class="string">&quot;名字中包含敏感词，请重新输入&quot;</span>); <span class="comment">// 判断名字中有没有敏感词</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">oldUser</span> <span class="operator">=</span> userDao.getByName(newName);</span><br><span class="line">        AssertUtil.isEmpty(oldUser, <span class="string">&quot;名字已经被抢占了，请换一个哦~~&quot;</span>);</span><br><span class="line">        <span class="comment">//判断改名卡够不够</span></span><br><span class="line">        <span class="type">UserBackpack</span> <span class="variable">firstValidItem</span> <span class="operator">=</span> userBackpackDao.getFirstValidItem(uid, ItemEnum.MODIFY_NAME_CARD.getId());</span><br><span class="line">        AssertUtil.isNotEmpty(firstValidItem, <span class="string">&quot;改名次数不够了，等后续活动送改名卡哦&quot;</span>);</span><br><span class="line">        <span class="comment">//使用改名卡</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">useSuccess</span> <span class="operator">=</span> userBackpackDao.invalidItem(firstValidItem.getId());</span><br><span class="line">        <span class="keyword">if</span> (useSuccess) &#123;<span class="comment">//用乐观锁，就不用分布式锁了</span></span><br><span class="line">            <span class="comment">//改名</span></span><br><span class="line">            userDao.modifyName(uid, req.getName());</span><br><span class="line">            <span class="comment">//删除缓存</span></span><br><span class="line">            userCache.userInfoChange(uid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;BadgeResp&gt; <span class="title function_">badges</span><span class="params">(Long uid)</span> &#123;</span><br><span class="line">        <span class="comment">//查询所有徽章</span></span><br><span class="line">        List&lt;ItemConfig&gt; itemConfigs = itemCache.getByType(ItemTypeEnum.BADGE.getType());</span><br><span class="line">        <span class="comment">//查询用户拥有的徽章</span></span><br><span class="line">        List&lt;UserBackpack&gt; backpacks = userBackpackDao.getByItemIds(uid, itemConfigs.stream().map(ItemConfig::getId).collect(Collectors.toList()));</span><br><span class="line">        <span class="comment">//查询用户当前佩戴的标签</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userDao.getById(uid);</span><br><span class="line">        <span class="keyword">return</span> UserAdapter.buildBadgeResp(itemConfigs, backpacks, user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">wearingBadge</span><span class="params">(Long uid, WearingBadgeReq req)</span> &#123;</span><br><span class="line">        <span class="comment">//确保有这个徽章</span></span><br><span class="line">        <span class="type">UserBackpack</span> <span class="variable">firstValidItem</span> <span class="operator">=</span> userBackpackDao.getFirstValidItem(uid, req.getBadgeId());</span><br><span class="line">        AssertUtil.isNotEmpty(firstValidItem, <span class="string">&quot;您没有这个徽章哦，快去达成条件获取吧&quot;</span>);</span><br><span class="line">        <span class="comment">//确保物品类型是徽章</span></span><br><span class="line">        <span class="type">ItemConfig</span> <span class="variable">itemConfig</span> <span class="operator">=</span> itemConfigDao.getById(firstValidItem.getItemId());</span><br><span class="line">        AssertUtil.equal(itemConfig.getType(), ItemTypeEnum.BADGE.getType(), <span class="string">&quot;该徽章不可佩戴&quot;</span>);</span><br><span class="line">        <span class="comment">//佩戴徽章</span></span><br><span class="line">        userDao.wearingBadge(uid, req.getBadgeId());</span><br><span class="line">        <span class="comment">//删除用户缓存</span></span><br><span class="line">        userCache.userInfoChange(uid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(String openId)</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">insert</span> <span class="operator">=</span> User.builder().openId(openId).build();</span><br><span class="line">        userDao.save(insert);</span><br><span class="line">        applicationEventPublisher.publishEvent(<span class="keyword">new</span> <span class="title class_">UserRegisterEvent</span>(<span class="built_in">this</span>, insert));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">black</span><span class="params">(BlackReq req)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">uid</span> <span class="operator">=</span> req.getUid();</span><br><span class="line">        <span class="type">Black</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Black</span>();</span><br><span class="line">        user.setTarget(uid.toString());</span><br><span class="line">        user.setType(BlackTypeEnum.UID.getType());</span><br><span class="line">        blackDao.save(user);</span><br><span class="line">        <span class="type">User</span> <span class="variable">byId</span> <span class="operator">=</span> userDao.getById(uid);</span><br><span class="line">        blackIp(byId.getIpInfo().getCreateIp());</span><br><span class="line">        blackIp(byId.getIpInfo().getUpdateIp());</span><br><span class="line">        applicationEventPublisher.publishEvent(<span class="keyword">new</span> <span class="title class_">UserBlackEvent</span>(<span class="built_in">this</span>, byId));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;SummeryInfoDTO&gt; <span class="title function_">getSummeryUserInfo</span><span class="params">(SummeryInfoReq req)</span> &#123;</span><br><span class="line">        <span class="comment">//需要前端同步的uid</span></span><br><span class="line">        List&lt;Long&gt; uidList = getNeedSyncUidList(req.getReqList());</span><br><span class="line">        <span class="comment">//加载用户信息</span></span><br><span class="line">        Map&lt;Long, SummeryInfoDTO&gt; batch = userSummaryCache.getBatch(uidList);</span><br><span class="line">        <span class="keyword">return</span> req.getReqList()</span><br><span class="line">                .stream()</span><br><span class="line">                .map(a -&gt; batch.containsKey(a.getUid()) ? batch.get(a.getUid()) : SummeryInfoDTO.skip(a.getUid()))</span><br><span class="line">                .filter(Objects::nonNull)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;ItemInfoDTO&gt; <span class="title function_">getItemInfo</span><span class="params">(ItemInfoReq req)</span> &#123;<span class="comment">//简单做，更新时间可判断被修改</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> req.getReqList().stream().map(a -&gt; &#123;</span><br><span class="line">            <span class="type">ItemConfig</span> <span class="variable">itemConfig</span> <span class="operator">=</span> itemCache.getById(a.getItemId());</span><br><span class="line">            <span class="keyword">if</span> (Objects.nonNull(a.getLastModifyTime()) &amp;&amp; a.getLastModifyTime() &gt;= itemConfig.getUpdateTime().getTime()) &#123;</span><br><span class="line">                <span class="keyword">return</span> ItemInfoDTO.skip(a.getItemId());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">ItemInfoDTO</span> <span class="variable">dto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ItemInfoDTO</span>();</span><br><span class="line">            dto.setItemId(itemConfig.getId());</span><br><span class="line">            dto.setImg(itemConfig.getImg());</span><br><span class="line">            dto.setDescribe(itemConfig.getDescribe());</span><br><span class="line">            <span class="keyword">return</span> dto;</span><br><span class="line">        &#125;).collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Long&gt; <span class="title function_">getNeedSyncUidList</span><span class="params">(List&lt;SummeryInfoReq.infoReq&gt; reqList)</span> &#123;</span><br><span class="line">        List&lt;Long&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        List&lt;Long&gt; userModifyTime = userCache.getUserModifyTime(reqList.stream().map(SummeryInfoReq.infoReq::getUid).collect(Collectors.toList()));</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; reqList.size(); i++) &#123;</span><br><span class="line">            SummeryInfoReq.<span class="type">infoReq</span> <span class="variable">infoReq</span> <span class="operator">=</span> reqList.get(i);</span><br><span class="line">            <span class="type">Long</span> <span class="variable">modifyTime</span> <span class="operator">=</span> userModifyTime.get(i);</span><br><span class="line">            <span class="keyword">if</span> (Objects.isNull(infoReq.getLastModifyTime()) || (Objects.nonNull(modifyTime) &amp;&amp; modifyTime &gt; infoReq.getLastModifyTime())) &#123;</span><br><span class="line">                result.add(infoReq.getUid());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">blackIp</span><span class="params">(String ip)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isBlank(ip)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Black</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Black</span>();</span><br><span class="line">            user.setTarget(ip);</span><br><span class="line">            user.setType(BlackTypeEnum.IP.getType());</span><br><span class="line">            blackDao.save(user);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;duplicate black ip:&#123;&#125;&quot;</span>, ip);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="用户模块中的功能"   >
          <a href="#用户模块中的功能" class="heading-link"><i class="fas fa-link"></i></a><a href="#用户模块中的功能" class="headerlink" title="用户模块中的功能"></a>用户模块中的功能</h4>
      
        <h5 id="用户模块-1"   >
          <a href="#用户模块-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#用户模块-1" class="headerlink" title="用户模块"></a>用户模块</h5>
      
        <h5 id="黑名单模块"   >
          <a href="#黑名单模块" class="heading-link"><i class="fas fa-link"></i></a><a href="#黑名单模块" class="headerlink" title="黑名单模块"></a>黑名单模块</h5>
      
        <h5 id="徽章发放模块"   >
          <a href="#徽章发放模块" class="heading-link"><i class="fas fa-link"></i></a><a href="#徽章发放模块" class="headerlink" title="徽章发放模块"></a>徽章发放模块</h5>
      
        <h2 id="微信扫码登录"   >
          <a href="#微信扫码登录" class="heading-link"><i class="fas fa-link"></i></a><a href="#微信扫码登录" class="headerlink" title="微信扫码登录"></a>微信扫码登录</h2>
      
        <h3 id="WxPortalController层"   >
          <a href="#WxPortalController层" class="heading-link"><i class="fas fa-link"></i></a><a href="#WxPortalController层" class="headerlink" title="WxPortalController层"></a>WxPortalController层</h3>
      
        <h4 id="post"   >
          <a href="#post" class="heading-link"><i class="fas fa-link"></i></a><a href="#post" class="headerlink" title="post"></a>post</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(produces = &quot;application/xml; charset=UTF-8&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">post</span><span class="params">(<span class="meta">@RequestBody</span> String requestBody,</span></span><br><span class="line"><span class="params">                       <span class="meta">@RequestParam(&quot;signature&quot;)</span> String signature,</span></span><br><span class="line"><span class="params">                       <span class="meta">@RequestParam(&quot;timestamp&quot;)</span> String timestamp,</span></span><br><span class="line"><span class="params">                       <span class="meta">@RequestParam(&quot;nonce&quot;)</span> String nonce,</span></span><br><span class="line"><span class="params">                       <span class="meta">@RequestParam(&quot;openid&quot;)</span> String openid,</span></span><br><span class="line"><span class="params">                       <span class="meta">@RequestParam(name = &quot;encrypt_type&quot;, required = false)</span> String encType,</span></span><br><span class="line"><span class="params">                       <span class="meta">@RequestParam(name = &quot;msg_signature&quot;, required = false)</span> String msgSignature)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;\n接收微信请求：[openid=[&#123;&#125;], [signature=[&#123;&#125;], encType=[&#123;&#125;], msgSignature=[&#123;&#125;],&quot;</span></span><br><span class="line">                        + <span class="string">&quot; timestamp=[&#123;&#125;], nonce=[&#123;&#125;], requestBody=[\n&#123;&#125;\n] &quot;</span>,</span><br><span class="line">                openid, signature, encType, msgSignature, timestamp, nonce, requestBody);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!wxService.checkSignature(timestamp, nonce, signature)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;非法请求，可能属于伪造的请求！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">out</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (encType == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 明文传输的消息</span></span><br><span class="line">            <span class="type">WxMpXmlMessage</span> <span class="variable">inMessage</span> <span class="operator">=</span> WxMpXmlMessage.fromXml(requestBody);</span><br><span class="line">            <span class="type">WxMpXmlOutMessage</span> <span class="variable">outMessage</span> <span class="operator">=</span> <span class="built_in">this</span>.route(inMessage);</span><br><span class="line">            <span class="keyword">if</span> (outMessage == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            out = outMessage.toXml();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;aes&quot;</span>.equalsIgnoreCase(encType)) &#123;</span><br><span class="line">            <span class="comment">// aes加密的消息</span></span><br><span class="line">            <span class="type">WxMpXmlMessage</span> <span class="variable">inMessage</span> <span class="operator">=</span> WxMpXmlMessage.fromEncryptedXml(requestBody, wxService.getWxMpConfigStorage(),</span><br><span class="line">                    timestamp, nonce, msgSignature);</span><br><span class="line">            log.debug(<span class="string">&quot;\n消息解密后内容为：\n&#123;&#125; &quot;</span>, inMessage.toString());</span><br><span class="line">            <span class="type">WxMpXmlOutMessage</span> <span class="variable">outMessage</span> <span class="operator">=</span> <span class="built_in">this</span>.route(inMessage);</span><br><span class="line">            <span class="keyword">if</span> (outMessage == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            out = outMessage.toEncryptedXml(wxService.getWxMpConfigStorage());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        log.debug(<span class="string">&quot;\n组装回复信息：&#123;&#125;&quot;</span>, out);</span><br><span class="line">        <span class="keyword">return</span> out;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="authGet"   >
          <a href="#authGet" class="heading-link"><i class="fas fa-link"></i></a><a href="#authGet" class="headerlink" title="authGet"></a>authGet</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//这个方法用于微信服务器与自己内网的后端代码建立连接</span></span><br><span class="line"><span class="meta">@GetMapping(produces = &quot;text/plain;charset=utf-8&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">authGet</span><span class="params">(<span class="meta">@RequestParam(name = &quot;signature&quot;, required = false)</span> String signature,</span></span><br><span class="line"><span class="params">                      <span class="meta">@RequestParam(name = &quot;timestamp&quot;, required = false)</span> String timestamp,</span></span><br><span class="line"><span class="params">                      <span class="meta">@RequestParam(name = &quot;nonce&quot;, required = false)</span> String nonce,</span></span><br><span class="line"><span class="params">                      <span class="meta">@RequestParam(name = &quot;echostr&quot;, required = false)</span> String echostr)</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//传入参数1.微信加密签名 2.时间戳 3.随机数 4.随机字符串</span></span><br><span class="line">    log.info(<span class="string">&quot;\n接收到来自微信服务器的认证消息：[&#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;]&quot;</span>, signature,</span><br><span class="line">            timestamp, nonce, echostr);</span><br><span class="line">    <span class="comment">//如果为空则抛出异常</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isAnyBlank(signature, timestamp, nonce, echostr)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;请求参数非法，请核实!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//微信校验</span></span><br><span class="line">    <span class="keyword">if</span> (wxService.checkSignature(timestamp, nonce, signature)) &#123;</span><br><span class="line">        <span class="keyword">return</span> echostr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;非法请求&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="callBack"   >
          <a href="#callBack" class="heading-link"><i class="fas fa-link"></i></a><a href="#callBack" class="headerlink" title="callBack"></a>callBack</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//回调函数</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/callBack&quot;)</span></span><br><span class="line"><span class="keyword">public</span> RedirectView <span class="title function_">callBack</span><span class="params">(<span class="meta">@RequestParam</span> String code)</span> <span class="keyword">throws</span> WxErrorException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">WxOAuth2AccessToken</span> <span class="variable">accessToken</span> <span class="operator">=</span> wxService.getOAuth2Service().getAccessToken(code);</span><br><span class="line">        <span class="type">WxOAuth2UserInfo</span> <span class="variable">userInfo</span> <span class="operator">=</span> wxService.getOAuth2Service().getUserInfo(accessToken, <span class="string">&quot;zh_CN&quot;</span>);</span><br><span class="line">        wxMsgService.authorize(userInfo);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;callBack error&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//重定向</span></span><br><span class="line">    <span class="type">RedirectView</span> <span class="variable">redirectView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedirectView</span>();</span><br><span class="line">    <span class="comment">//重定向uri</span></span><br><span class="line">    redirectView.setUrl(<span class="string">&quot;https://mp.weixin.qq.com/s/m1SRsBG96kLJW5mPe4AVGA&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> redirectView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="WxMsgService"   >
          <a href="#WxMsgService" class="heading-link"><i class="fas fa-link"></i></a><a href="#WxMsgService" class="headerlink" title="WxMsgService"></a>WxMsgService</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WxMsgService</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户的openId和前端登录场景code的映射关系</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, Integer&gt; OPENID_EVENT_CODE_MAP = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">URL</span> <span class="operator">=</span> <span class="string">&quot;https://open.weixin.qq.com/connect/oauth2/authorize?appid=%s&amp;redirect_uri=%s&amp;response_type=code&amp;scope=snsapi_userinfo&amp;state=STATE#wechat_redirect&quot;</span>;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;wx.mp.callback&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String callback;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Lazy</span></span><br><span class="line">    <span class="keyword">private</span> WebSocketService webSocketService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LoginService loginService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ThreadPoolTaskExecutor threadPoolTaskExecutor;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> WxMpXmlOutMessage <span class="title function_">scan</span><span class="params">(WxMpService wxMpService, WxMpXmlMessage wxMpXmlMessage)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">fromUser</span> <span class="operator">=</span> wxMpXmlMessage.getFromUser();</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">eventKey</span> <span class="operator">=</span> Integer.parseInt(getEventKey(wxMpXmlMessage));</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userDao.getByOpenId(fromUser);</span><br><span class="line">        <span class="keyword">if</span> (Objects.nonNull(user) &amp;&amp; StringUtils.isNotEmpty(user.getAvatar())) &#123;</span><br><span class="line">            <span class="comment">//注册且已经授权的用户，直接登录成功</span></span><br><span class="line">            login(user.getId(), eventKey);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(user)) &#123;</span><br><span class="line">            <span class="comment">//未注册的先注册</span></span><br><span class="line">            userService.register(fromUser);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//保存openid和场景code的关系，后续才能通知到前端</span></span><br><span class="line">        OPENID_EVENT_CODE_MAP.put(fromUser, eventKey);</span><br><span class="line">        <span class="comment">//授权流程,给用户发送授权消息，并且异步通知前端扫码成功</span></span><br><span class="line">        threadPoolTaskExecutor.execute(() -&gt; webSocketService.scanSuccess(eventKey));</span><br><span class="line">        <span class="type">String</span> <span class="variable">skipUrl</span> <span class="operator">=</span> String.format(URL, wxMpService.getWxMpConfigStorage().getAppId(), URLEncoder.encode(callback + <span class="string">&quot;/wx/portal/public/callBack&quot;</span>));</span><br><span class="line">        WxMpXmlOutMessage.TEXT().build();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TextBuilder</span>().build(<span class="string">&quot;请点击链接授权：&lt;a href=\&quot;&quot;</span> + skipUrl + <span class="string">&quot;\&quot;&gt;登录&lt;/a&gt;&quot;</span>, wxMpXmlMessage, wxMpService);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getEventKey</span><span class="params">(WxMpXmlMessage wxMpXmlMessage)</span> &#123;</span><br><span class="line">        <span class="comment">//扫码关注的渠道事件有前缀，需要去除</span></span><br><span class="line">        <span class="keyword">return</span> wxMpXmlMessage.getEventKey().replace(<span class="string">&quot;qrscene_&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户授权</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userInfo</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">authorize</span><span class="params">(WxOAuth2UserInfo userInfo)</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userDao.getByOpenId(userInfo.getOpenid());</span><br><span class="line">        <span class="comment">//更新用户信息</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(user.getName())) &#123;</span><br><span class="line">            fillUserInfo(user.getId(), userInfo);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//触发用户登录成功操作</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">eventKey</span> <span class="operator">=</span> OPENID_EVENT_CODE_MAP.get(userInfo.getOpenid());</span><br><span class="line">        login(user.getId(), eventKey);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">fillUserInfo</span><span class="params">(Long uid, WxOAuth2UserInfo userInfo)</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">update</span> <span class="operator">=</span> UserAdapter.buildAuthorizeUser(uid, userInfo);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                userDao.updateById(update);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (DuplicateKeyException e) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;fill userInfo duplicate uid:&#123;&#125;,info:&#123;&#125;&quot;</span>, uid, userInfo);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;fill userInfo fail uid:&#123;&#125;,info:&#123;&#125;&quot;</span>, uid, userInfo);</span><br><span class="line">            &#125;</span><br><span class="line">            update.setName(<span class="string">&quot;名字重置&quot;</span> + RandomUtil.randomInt(<span class="number">100000</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">login</span><span class="params">(Long uid, Integer eventKey)</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userDao.getById(uid);</span><br><span class="line">        <span class="comment">//调用用户登录模块</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> loginService.login(uid);</span><br><span class="line">        <span class="comment">//推送前端登录成功</span></span><br><span class="line">        webSocketService.scanLoginSuccess(eventKey, user, token);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="流程-5"   >
          <a href="#流程-5" class="heading-link"><i class="fas fa-link"></i></a><a href="#流程-5" class="headerlink" title="流程"></a>流程</h3>
      
        <h4 id="前端和后端建立一个WebSocket连接"   >
          <a href="#前端和后端建立一个WebSocket连接" class="heading-link"><i class="fas fa-link"></i></a><a href="#前端和后端建立一个WebSocket连接" class="headerlink" title="前端和后端建立一个WebSocket连接"></a>前端和后端建立一个WebSocket连接</h4>
      <p>前端新建一个WebSocket连接，端口号是8090，然后后端通过netty记录并且管理连接</p>

        <h4 id="前端请求扫码登录"   >
          <a href="#前端请求扫码登录" class="heading-link"><i class="fas fa-link"></i></a><a href="#前端请求扫码登录" class="headerlink" title="前端请求扫码登录"></a>前端请求扫码登录</h4>
      <p><strong>后端</strong></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoginReq</span><span class="params">(Channel channel)</span> &#123;</span><br><span class="line">        <span class="comment">//生成随机不重复的登录码</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">code</span> <span class="operator">=</span> generateLoginCode(channel);</span><br><span class="line">        <span class="comment">//请求微信接口，获取登录码地址</span></span><br><span class="line">        <span class="type">WxMpQrCodeTicket</span> <span class="variable">wxMpQrCodeTicket</span> <span class="operator">=</span> wxMpService.getQrcodeService().qrCodeCreateTmpTicket(code, (<span class="type">int</span>) EXPIRE_TIME.getSeconds());</span><br><span class="line">        <span class="comment">//返回给前端</span></span><br><span class="line">        sendMsg(channel, WSAdapter.buildLoginResp(wxMpQrCodeTicket));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>

<p><strong>generateLoginCode</strong></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取不重复的登录的code，微信要求最大不超过int的存储极限</span></span><br><span class="line"><span class="comment"> * 防止并发，可以给方法加上synchronize，也可以使用cas乐观锁</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Integer <span class="title function_">generateLoginCode</span><span class="params">(Channel channel)</span> &#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        CODE.getAndIncrement();</span><br><span class="line">    &#125; <span class="keyword">while</span> (WAIT_LOGIN_MAP.asMap().containsKey(CODE.get())</span><br><span class="line">            || Objects.isNull(WAIT_LOGIN_MAP.get(CODE.get(), c -&gt; channel)));</span><br><span class="line">    <span class="keyword">return</span> CODE.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>也即后端会生成一个随机的登录码，这个登录码会和这个channal相连</p>
<p>然后将登录码发送到微信获取一个登录二维码链接</p>
<p>返回给前端一个二维码链接转换成二维码图片</p>
<p><strong>这样前端就获取了一个带有登录码的二维码图片</strong></p>

        <h4 id="用户扫码登录"   >
          <a href="#用户扫码登录" class="heading-link"><i class="fas fa-link"></i></a><a href="#用户扫码登录" class="headerlink" title="用户扫码登录"></a>用户扫码登录</h4>
      <p>用户扫码之后公众号会判断是关注还是扫码事件</p>
<p>无论是啥事件都会返回二维码参数，也就是登录码</p>

        <h4 id="用户注册"   >
          <a href="#用户注册" class="heading-link"><i class="fas fa-link"></i></a><a href="#用户注册" class="headerlink" title="用户注册"></a>用户注册</h4>
      <p>用户注册也就是一开始未关注，然后关注公众号之后</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> WxMpXmlOutMessage <span class="title function_">scan</span><span class="params">(WxMpService wxMpService, WxMpXmlMessage wxMpXmlMessage)</span> &#123;</span><br><span class="line">    <span class="comment">//获取用户openid</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">fromUser</span> <span class="operator">=</span> wxMpXmlMessage.getFromUser();</span><br><span class="line">    <span class="comment">//获取登录码</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">eventKey</span> <span class="operator">=</span> Integer.parseInt(getEventKey(wxMpXmlMessage));</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userDao.getByOpenId(fromUser);</span><br><span class="line">    <span class="keyword">if</span> (Objects.nonNull(user) &amp;&amp; StringUtils.isNotEmpty(user.getAvatar())) &#123;</span><br><span class="line">        <span class="comment">//注册且已经授权的用户，直接登录成功</span></span><br><span class="line">        login(user.getId(), eventKey);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (Objects.isNull(user)) &#123;</span><br><span class="line">        <span class="comment">//未注册的先注册</span></span><br><span class="line">        userService.register(fromUser);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//保存openid和场景code的关系，后续才能通知到前端</span></span><br><span class="line">    OPENID_EVENT_CODE_MAP.put(fromUser, eventKey);</span><br><span class="line">    <span class="comment">//授权流程,给用户发送授权消息，并且异步通知前端扫码成功</span></span><br><span class="line">    threadPoolTaskExecutor.execute(() -&gt; webSocketService.scanSuccess(eventKey));</span><br><span class="line">    <span class="type">String</span> <span class="variable">skipUrl</span> <span class="operator">=</span> String.format(URL, wxMpService.getWxMpConfigStorage().getAppId(), URLEncoder.encode(callback + <span class="string">&quot;/wx/portal/public/callBack&quot;</span>));</span><br><span class="line">    WxMpXmlOutMessage.TEXT().build();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TextBuilder</span>().build(<span class="string">&quot;请点击链接授权：&lt;a href=\&quot;&quot;</span> + skipUrl + <span class="string">&quot;\&quot;&gt;登录&lt;/a&gt;&quot;</span>, wxMpXmlMessage, wxMpService);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p><strong>login登录</strong></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">login</span><span class="params">(Long uid, Integer eventKey)</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userDao.getById(uid);</span><br><span class="line">    <span class="comment">//调用用户登录模块</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> loginService.login(uid);</span><br><span class="line">    <span class="comment">//推送前端登录成功</span></span><br><span class="line">    webSocketService.scanLoginSuccess(eventKey, user, token);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>



<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">login</span><span class="params">(Long uid)</span> &#123;</span><br><span class="line">       <span class="comment">//拼接一个Key</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisKey.getKey(RedisKey.USER_TOKEN_STRING, uid);</span><br><span class="line">	<span class="comment">//查询Redis 这个UserToken </span></span><br><span class="line">       <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> RedisUtils.getStr(key);</span><br><span class="line">       <span class="comment">//如果Token非空 那么就直接返回Token</span></span><br><span class="line">       <span class="keyword">if</span> (StrUtil.isNotBlank(token)) &#123;</span><br><span class="line">           <span class="keyword">return</span> token;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//运行到这里说明Token为空</span></span><br><span class="line">       </span><br><span class="line">       <span class="comment">//获取用户token</span></span><br><span class="line">       <span class="comment">//生成一个JWT令牌</span></span><br><span class="line">       token = jwtUtils.createToken(uid);</span><br><span class="line">       <span class="comment">//在Redis中设置这个token,初始化过期时间为5天</span></span><br><span class="line">       RedisUtils.set(key, token, TOKEN_EXPIRE_DAYS, TimeUnit.DAYS);<span class="comment">//token过期用redis中心化控制，初期采用5天过期，剩1天自动续期的方案。后续可以用双token实现</span></span><br><span class="line">       <span class="keyword">return</span> token;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></div></figure>

<p><strong>token续期操作</strong></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">@Async</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">renewalTokenIfNecessary</span><span class="params">(String token)</span> &#123;</span><br><span class="line"><span class="comment">//从token中获取uid</span></span><br><span class="line">      <span class="type">Long</span> <span class="variable">uid</span> <span class="operator">=</span> jwtUtils.getUidOrNull(token);</span><br><span class="line">      <span class="comment">//如果uid为空 那么直接返回</span></span><br><span class="line">      <span class="keyword">if</span> (Objects.isNull(uid)) &#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//拼接一个key</span></span><br><span class="line">      <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisKey.getKey(RedisKey.USER_TOKEN_STRING, uid);</span><br><span class="line">      <span class="comment">//获取这个key对应的过期时间</span></span><br><span class="line">      <span class="type">long</span> <span class="variable">expireDays</span> <span class="operator">=</span> RedisUtils.getExpire(key, TimeUnit.DAYS);</span><br><span class="line">      <span class="comment">//如果过期时间为-2 说明不存在key</span></span><br><span class="line">      <span class="keyword">if</span> (expireDays == -<span class="number">2</span>) &#123;<span class="comment">//不存在的key</span></span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">       <span class="comment">//如果过期时间&lt;TOKEN_RENEWAL_DAYS  也即过期时间小于2 那么就要续期</span></span><br><span class="line">      <span class="keyword">if</span> (expireDays &lt; TOKEN_RENEWAL_DAYS ) &#123;<span class="comment">//小于二天的token帮忙续期</span></span><br><span class="line">          <span class="comment">//续期token 每次续期5天</span></span><br><span class="line">          RedisUtils.expire(key, TOKEN_EXPIRE_DAYS, TimeUnit.DAYS);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p><strong>regist注册</strong></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(String openId)</span> &#123;</span><br><span class="line">        <span class="comment">//将openid放入User表中的openid</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">insert</span> <span class="operator">=</span> User.builder().openId(openId).build();</span><br><span class="line">        <span class="comment">//插入到User表中用户数据</span></span><br><span class="line">        userDao.save(insert);</span><br><span class="line">        <span class="comment">//推送一条用户注册的事件</span></span><br><span class="line">        applicationEventPublisher.publishEvent(<span class="keyword">new</span> <span class="title class_">UserRegisterEvent</span>(<span class="built_in">this</span>, insert));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>



<p>当用户注册完的时候，就会产生一个openid和登录码关联的临时关系</p>

        <h4 id="授权用户信息"   >
          <a href="#授权用户信息" class="heading-link"><i class="fas fa-link"></i></a><a href="#授权用户信息" class="headerlink" title="授权用户信息"></a>授权用户信息</h4>
      <p>公众号会推送一条用户授权链接，当用户点击链接会触发callback函数</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/callBack&quot;)</span></span><br><span class="line"><span class="keyword">public</span> RedirectView <span class="title function_">callBack</span><span class="params">(<span class="meta">@RequestParam</span> String code)</span> <span class="keyword">throws</span> WxErrorException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">WxOAuth2AccessToken</span> <span class="variable">accessToken</span> <span class="operator">=</span> wxService.getOAuth2Service().getAccessToken(code);</span><br><span class="line">        <span class="type">WxOAuth2UserInfo</span> <span class="variable">userInfo</span> <span class="operator">=</span> wxService.getOAuth2Service().getUserInfo(accessToken, <span class="string">&quot;zh_CN&quot;</span>);</span><br><span class="line">        wxMsgService.authorize(userInfo);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;callBack error&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//重定向uri</span></span><br><span class="line">    <span class="type">RedirectView</span> <span class="variable">redirectView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedirectView</span>();</span><br><span class="line">    redirectView.setUrl(<span class="string">&quot;https://mp.weixin.qq.com/s/m1SRsBG96kLJW5mPe4AVGA&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> redirectView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>我们通过回调函数获取userInfo  ，也即微信头像、昵称、openId等</p>
<p>获取用户授权信息之后再执行登录操作</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">authorize</span><span class="params">(WxOAuth2UserInfo userInfo)</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userDao.getByOpenId(userInfo.getOpenid());</span><br><span class="line">    <span class="comment">//更新用户信息</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isEmpty(user.getName())) &#123;</span><br><span class="line">        fillUserInfo(user.getId(), userInfo);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//触发用户登录成功操作</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">eventKey</span> <span class="operator">=</span> OPENID_EVENT_CODE_MAP.get(userInfo.getOpenid());</span><br><span class="line">    login(user.getId(), eventKey);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>那么因此就产生一个 uid对应一个Channal的关系</p>
<p>这个原因是可能一个微信可能pc和手机端同时登录mallchat，当两个设备都下线才能说明这个用户下线</p>

        <h4 id="后端主动消息推送"   >
          <a href="#后端主动消息推送" class="heading-link"><i class="fas fa-link"></i></a><a href="#后端主动消息推送" class="headerlink" title="后端主动消息推送"></a>后端主动消息推送</h4>
      <p>当有消息发送需要推送给全部用户</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Async</span></span><br><span class="line"><span class="meta">@TransactionalEventListener(classes = MessageSendEvent.class, fallbackExecution = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">notifyAllOnline</span><span class="params">(MessageSendEvent event)</span> &#123;</span><br><span class="line">    <span class="comment">//获取消息</span></span><br><span class="line">    <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> messageDao.getById(event.getMsgId());</span><br><span class="line">    <span class="comment">//判断这个消息接收到的uid， null说明为全部用户</span></span><br><span class="line">    <span class="type">ChatMessageResp</span> <span class="variable">msgResp</span> <span class="operator">=</span> chatService.getMsgResp(message, <span class="literal">null</span>);</span><br><span class="line">    <span class="comment">//调用sendToAllOnline发送给所有在线用户(除了自己)</span></span><br><span class="line">    webSocketService.sendToAllOnline(WSAdapter.buildMsgSend(msgResp), message.getFromUid());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>



<p>sendToAllOnline</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//entrySet的值不是快照数据,但是它支持遍历，所以无所谓了，不用快照也行。</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendToAllOnline</span><span class="params">(WSBaseResp&lt;?&gt; wsBaseResp, Long skipUid)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        ONLINE_WS_MAP.forEach((channel, ext) -&gt; &#123;</span><br><span class="line">            <span class="comment">//判断这个uid是不是需要跳过的uid，发送消息的uid就不需要推送给自己</span></span><br><span class="line">            <span class="keyword">if</span> (ObjectUtil.equal(ext.getUid(), skipUid)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//调用异步线程池发送消息</span></span><br><span class="line">            threadPoolTaskExecutor.execute(() -&gt; sendMsg(channel, wsBaseResp));</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="总览-1"   >
          <a href="#总览-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#总览-1" class="headerlink" title="总览"></a>总览</h3>
      <p><strong>消息的异步推送</strong></p>
<p>利用异步线程池来推送消息给全体用户</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">threadPoolTaskExecutor.execute(() -&gt; sendMsg(channel, wsBaseResp));</span><br></pre></td></tr></table></div></figure>

<p><strong>登录码的防重</strong></p>
<p>利用原子类生成一个code，这个code必须在Caffeine中没有并且能有channel与其关联，也即这个code不能重复</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoginReq</span><span class="params">(Channel channel)</span> &#123;</span><br><span class="line">        <span class="comment">//生成随机不重复的登录码</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">code</span> <span class="operator">=</span> generateLoginCode(channel);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br></pre></td></tr></table></div></figure>

<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Integer <span class="title function_">generateLoginCode</span><span class="params">(Channel channel)</span> &#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">//利用AtomicInteger获取一个code</span></span><br><span class="line">        CODE.getAndIncrement();</span><br><span class="line">    &#125; <span class="keyword">while</span> (</span><br><span class="line">        <span class="comment">//必须要Caffeine中没有 并且 能有Channael与Code关联</span></span><br><span class="line">        WAIT_LOGIN_MAP.asMap().containsKey(CODE.get())||</span><br><span class="line">        Objects.isNull(WAIT_LOGIN_MAP.get(CODE.get(), c -&gt; channel))</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> CODE.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">CODE</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>();</span><br></pre></td></tr></table></div></figure>

<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Cache&lt;Integer, Channel&gt; WAIT_LOGIN_MAP = Caffeine.newBuilder()</span><br><span class="line">        .expireAfterWrite(EXPIRE_TIME)</span><br><span class="line">        .maximumSize(MAX_MUM_SIZE)</span><br><span class="line">        .build();</span><br></pre></td></tr></table></div></figure>



<p><strong>登录二维码内存泄漏</strong></p>
<p>因为登录的时候会申请一个code和二维码相关联，如果一个用户申请了二维码就会将临时二维码和code做映射，只有当注册或者登录用户的时候才会将映射删除</p>
<p>但是迟迟没有扫码登录，那么这个code会一直存在内存中，并且其他用户在申请code的时候可能会造成code碰撞会不断申请</p>
<p><em>解决方案</em></p>
<p>利用Caffeine来最大容量和过期时间</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Cache&lt;Integer, Channel&gt; WAIT_LOGIN_MAP = Caffeine.newBuilder()</span><br><span class="line">        .expireAfterWrite(EXPIRE_TIME) <span class="comment">//设置过期时间为1h</span></span><br><span class="line">        .maximumSize(MAX_MUM_SIZE)<span class="comment">//设置最大容量为10000</span></span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Duration</span> <span class="variable">EXPIRE_TIME</span> <span class="operator">=</span> Duration.ofHours(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Long</span> <span class="variable">MAX_MUM_SIZE</span> <span class="operator">=</span> <span class="number">10000L</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">CODE</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>();</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>利用原子类自增来解决code冲突的问题</p>

        <h2 id="表情包模块"   >
          <a href="#表情包模块" class="heading-link"><i class="fas fa-link"></i></a><a href="#表情包模块" class="headerlink" title="表情包模块"></a>表情包模块</h2>
      
        <h3 id="表情包列表"   >
          <a href="#表情包列表" class="heading-link"><i class="fas fa-link"></i></a><a href="#表情包列表" class="headerlink" title="表情包列表"></a>表情包列表</h3>
      <div class="table-container"><table>
<thead>
<tr>
<th>URI</th>
<th>请求类型</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;capi&#x2F;user&#x2F;emoji&#x2F;list</td>
<td>GET请求</td>
</tr>
</tbody></table></div>

        <h4 id="Controller层-7"   >
          <a href="#Controller层-7" class="heading-link"><i class="fas fa-link"></i></a><a href="#Controller层-7" class="headerlink" title="Controller层"></a>Controller层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/list&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;表情包列表&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ApiResult&lt;List&lt;UserEmojiResp&gt;&gt; <span class="title function_">getEmojisPage</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> ApiResult.success(emojiService.list(RequestHolder.get().getUid()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="Service层-5"   >
          <a href="#Service层-5" class="heading-link"><i class="fas fa-link"></i></a><a href="#Service层-5" class="headerlink" title="Service层"></a>Service层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;UserEmojiResp&gt; <span class="title function_">list</span><span class="params">(Long uid)</span>;</span><br></pre></td></tr></table></div></figure>

<p>实现类中</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;UserEmojiResp&gt; <span class="title function_">list</span><span class="params">(Long uid)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> userEmojiDao.listByUid(uid).</span><br><span class="line">            stream()</span><br><span class="line">            .map(a -&gt; UserEmojiResp.builder()</span><br><span class="line">                    .id(a.getId())<span class="comment">//设置表情id</span></span><br><span class="line">                    .expressionUrl(a.getExpressionUrl())<span class="comment">//设置表情uil</span></span><br><span class="line">                    .build())</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="listByUid-1"   >
          <a href="#listByUid-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#listByUid-1" class="headerlink" title="listByUid"></a>listByUid</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据uid查询uid下的表情包</span></span><br><span class="line"><span class="keyword">public</span> List&lt;UserEmoji&gt; <span class="title function_">listByUid</span><span class="params">(Long uid)</span> &#123;</span><br><span class="line">    <span class="comment">//SELECT id,uid,expression_url,delete_status,create_time,update_time </span></span><br><span class="line">    <span class="comment">//FROM user_emoji </span></span><br><span class="line">    <span class="comment">//WHERE delete_status=0 AND (uid = ?)     delete_status为0说明是正常 为1是删除  即逻辑删除</span></span><br><span class="line">    <span class="keyword">return</span> lambdaQuery().eq(UserEmoji::getUid, uid).list();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="流程-6"   >
          <a href="#流程-6" class="heading-link"><i class="fas fa-link"></i></a><a href="#流程-6" class="headerlink" title="流程"></a>流程</h4>
      <p>查询Controller 传入Uid查询list，也即查询Uid下的表情包(自己拥有)</p>

        <h3 id="添加表情"   >
          <a href="#添加表情" class="heading-link"><i class="fas fa-link"></i></a><a href="#添加表情" class="headerlink" title="添加表情"></a>添加表情</h3>
      <div class="table-container"><table>
<thead>
<tr>
<th>URI</th>
<th>请求类型</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;capi&#x2F;user&#x2F;emoji</td>
<td>POST请求</td>
</tr>
</tbody></table></div>

        <h4 id="Controller层-8"   >
          <a href="#Controller层-8" class="heading-link"><i class="fas fa-link"></i></a><a href="#Controller层-8" class="headerlink" title="Controller层"></a>Controller层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping()</span></span><br><span class="line">   <span class="meta">@ApiOperation(&quot;新增表情包&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> ApiResult&lt;IdRespVO&gt; <span class="title function_">insertEmojis</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> UserEmojiReq req)</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> emojiService.insert(req, RequestHolder.get().getUid());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="Service层-6"   >
          <a href="#Service层-6" class="heading-link"><i class="fas fa-link"></i></a><a href="#Service层-6" class="headerlink" title="Service层"></a>Service层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ApiResult&lt;IdRespVO&gt; <span class="title function_">insert</span><span class="params">(UserEmojiReq emojis, Long uid)</span>;</span><br></pre></td></tr></table></div></figure>

<p>实现类中</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@RedissonLock(key = &quot;#uid&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ApiResult&lt;IdRespVO&gt; <span class="title function_">insert</span><span class="params">(UserEmojiReq req, Long uid)</span> &#123;</span><br><span class="line">    <span class="comment">//校验表情数量是否超过30</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> userEmojiDao.countByUid(uid);</span><br><span class="line">    AssertUtil.isFalse(count &gt; <span class="number">30</span>, <span class="string">&quot;最多只能添加30个表情哦~~&quot;</span>);</span><br><span class="line">    <span class="comment">//校验表情是否存在</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">existsCount</span> <span class="operator">=</span> userEmojiDao.lambdaQuery()</span><br><span class="line">            .eq(UserEmoji::getExpressionUrl, req.getExpressionUrl())</span><br><span class="line">            .eq(UserEmoji::getUid, uid)</span><br><span class="line">            .count();</span><br><span class="line">    AssertUtil.isFalse(existsCount &gt; <span class="number">0</span>, <span class="string">&quot;当前表情已存在哦~~&quot;</span>);</span><br><span class="line">    <span class="type">UserEmoji</span> <span class="variable">insert</span> <span class="operator">=</span> UserEmoji.builder().uid(uid).expressionUrl(req.getExpressionUrl()).build();</span><br><span class="line">    <span class="comment">//插入表情</span></span><br><span class="line">    userEmojiDao.save(insert);</span><br><span class="line">    <span class="keyword">return</span> ApiResult.success(IdRespVO.id(insert.getId()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="流程-7"   >
          <a href="#流程-7" class="heading-link"><i class="fas fa-link"></i></a><a href="#流程-7" class="headerlink" title="流程"></a>流程</h4>
      <p>添加表情先检验表情包数量是否超过30</p>
<p>超过30无法添加，如果不超过则检验表情是否重复</p>
<p>如果表情不重复并且表情包数量小于30 则插入User_emoji中新增表情包  添加表情包URL</p>

        <h3 id="删除表情"   >
          <a href="#删除表情" class="heading-link"><i class="fas fa-link"></i></a><a href="#删除表情" class="headerlink" title="删除表情"></a>删除表情</h3>
      <div class="table-container"><table>
<thead>
<tr>
<th>URI</th>
<th>请求类型</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;capi&#x2F;user&#x2F;emoji</td>
<td>DELETE请求</td>
</tr>
</tbody></table></div>

        <h4 id="Controller层-9"   >
          <a href="#Controller层-9" class="heading-link"><i class="fas fa-link"></i></a><a href="#Controller层-9" class="headerlink" title="Controller层"></a>Controller层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DeleteMapping()</span></span><br><span class="line">   <span class="meta">@ApiOperation(&quot;删除表情包&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> ApiResult&lt;Void&gt; <span class="title function_">deleteEmojis</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> IdReqVO reqVO)</span> &#123;</span><br><span class="line">       emojiService.remove(reqVO.getId(), RequestHolder.get().getUid());</span><br><span class="line">       <span class="keyword">return</span> ApiResult.success();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="Service层-7"   >
          <a href="#Service层-7" class="heading-link"><i class="fas fa-link"></i></a><a href="#Service层-7" class="headerlink" title="Service层"></a>Service层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">remove</span><span class="params">(Long id, Long uid)</span>;</span><br></pre></td></tr></table></div></figure>

<p>实现类中</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">(Long id, Long uid)</span> &#123;</span><br><span class="line">    <span class="comment">//获取要删除的表情包</span></span><br><span class="line">    <span class="type">UserEmoji</span> <span class="variable">userEmoji</span> <span class="operator">=</span> userEmojiDao.getById(id);</span><br><span class="line">    <span class="comment">//如果表情为空</span></span><br><span class="line">    AssertUtil.isNotEmpty(userEmoji, <span class="string">&quot;表情不能为空&quot;</span>);</span><br><span class="line">    <span class="comment">//如果表情不是自己的</span></span><br><span class="line">    AssertUtil.equal(userEmoji.getUid(), uid, <span class="string">&quot;小黑子，别人表情不是你能删的&quot;</span>);</span><br><span class="line">	<span class="comment">//删除表情 将逻辑删除改为1</span></span><br><span class="line">    userEmojiDao.removeById(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="流程-8"   >
          <a href="#流程-8" class="heading-link"><i class="fas fa-link"></i></a><a href="#流程-8" class="headerlink" title="流程"></a>流程</h4>
      <p>判断表情包是否为空，如果不为空判断表情包是否是自己的</p>
<p>如果不为空且是自己的表情，则将逻辑删除改成1，代表表情包已经被删除</p>

        <h2 id="上传文件模块"   >
          <a href="#上传文件模块" class="heading-link"><i class="fas fa-link"></i></a><a href="#上传文件模块" class="headerlink" title="上传文件模块"></a>上传文件模块</h2>
      
        <h3 id="Controller层-10"   >
          <a href="#Controller层-10" class="heading-link"><i class="fas fa-link"></i></a><a href="#Controller层-10" class="headerlink" title="Controller层"></a>Controller层</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/capi/oss&quot;)</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;oss相关接口&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OssController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OssService ossService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/upload/url&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;获取临时上传链接&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ApiResult&lt;OssResp&gt; <span class="title function_">getUploadUrl</span><span class="params">(<span class="meta">@Valid</span> UploadUrlReq req)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ApiResult.success(ossService.getUploadUrl(RequestHolder.get().getUid(), req));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h3 id="Service层-8"   >
          <a href="#Service层-8" class="heading-link"><i class="fas fa-link"></i></a><a href="#Service层-8" class="headerlink" title="Service层"></a>Service层</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OssResp <span class="title function_">getUploadUrl</span><span class="params">(Long uid, UploadUrlReq req)</span>;</span><br></pre></td></tr></table></div></figure>

<p>实现类中</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> OssResp <span class="title function_">getUploadUrl</span><span class="params">(Long uid, UploadUrlReq req)</span> &#123;</span><br><span class="line">    <span class="comment">//判断上传的类型 1为聊天内容 2为表情包</span></span><br><span class="line">    <span class="type">OssSceneEnum</span> <span class="variable">sceneEnum</span> <span class="operator">=</span> OssSceneEnum.of(req.getScene());</span><br><span class="line">    AssertUtil.isNotEmpty(sceneEnum, <span class="string">&quot;场景有误&quot;</span>);</span><br><span class="line">    <span class="type">OssReq</span> <span class="variable">ossReq</span> <span class="operator">=</span> OssReq.builder()</span><br><span class="line">            .fileName(req.getFileName())<span class="comment">//添加文件名</span></span><br><span class="line">            .filePath(sceneEnum.getPath())<span class="comment">//添加Path</span></span><br><span class="line">            .uid(uid)<span class="comment">//添加uid</span></span><br><span class="line">            .build();</span><br><span class="line">    <span class="keyword">return</span> minIOTemplate.getPreSignedObjectUrl(ossReq); <span class="comment">//上传到MinIo中</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="getPreSignedObjectUrl"   >
          <a href="#getPreSignedObjectUrl" class="heading-link"><i class="fas fa-link"></i></a><a href="#getPreSignedObjectUrl" class="headerlink" title="getPreSignedObjectUrl"></a>getPreSignedObjectUrl</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="keyword">public</span> OssResp <span class="title function_">getPreSignedObjectUrl</span><span class="params">(OssReq req)</span> &#123;</span><br><span class="line">    <span class="comment">//获取一个文件名，如果是自动路径则获取一个随机文件路径，反之拼接文件路径+&#x27;/&#x27;+文件名作为文件名 </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">absolutePath</span> <span class="operator">=</span> req.isAutoPath() ? generateAutoPath(req) : req.getFilePath() + StrUtil.SLASH + req.getFileName();</span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> minioClient.getPresignedObjectUrl(</span><br><span class="line">            GetPresignedObjectUrlArgs.builder()</span><br><span class="line">                    .method(Method.PUT)  <span class="comment">//设置为Put方法</span></span><br><span class="line">                    .bucket(ossProperties.getBucketName()) <span class="comment">//获取桶名</span></span><br><span class="line">                    .object(absolutePath)</span><br><span class="line">                    .expiry(<span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>) <span class="comment">//获取过期时间为一天</span></span><br><span class="line">                    .build());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//上传到MinIo中</span></span><br><span class="line">    <span class="keyword">return</span> OssResp.builder()</span><br><span class="line">            .uploadUrl(url)</span><br><span class="line">            .downloadUrl(getDownloadUrl(ossProperties.getBucketName(), absolutePath))</span><br><span class="line">            .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="聊天室模块"   >
          <a href="#聊天室模块" class="heading-link"><i class="fas fa-link"></i></a><a href="#聊天室模块" class="headerlink" title="聊天室模块"></a>聊天室模块</h2>
      <p>聊天室模块分为三块 1.会话的列表 2.群成员模块 3.消息模块</p>

        <h3 id="会话列表"   >
          <a href="#会话列表" class="heading-link"><i class="fas fa-link"></i></a><a href="#会话列表" class="headerlink" title="会话列表"></a>会话列表</h3>
      <div class="table-container"><table>
<thead>
<tr>
<th>URI</th>
<th>请求类型</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;capi&#x2F;chat&#x2F;public&#x2F;room&#x2F;page</td>
<td>GET请求</td>
</tr>
</tbody></table></div>

        <h4 id="Controller层-11"   >
          <a href="#Controller层-11" class="heading-link"><i class="fas fa-link"></i></a><a href="#Controller层-11" class="headerlink" title="Controller层"></a>Controller层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/public/room/page&quot;)</span></span><br><span class="line">   <span class="meta">@ApiOperation(&quot;会话列表&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> ApiResult&lt;CursorPageBaseResp&lt;ChatRoomResp&gt;&gt; <span class="title function_">getRoomPage</span><span class="params">(<span class="meta">@Valid</span> CursorPageBaseReq request)</span> &#123;</span><br><span class="line">       <span class="comment">//调用Service中的方法  传入参数1.游标 2.页面大小</span></span><br><span class="line">       <span class="keyword">return</span> ApiResult.success(chatService.getRoomPage(request, RequestHolder.get().getUid()));</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="Service层-9"   >
          <a href="#Service层-9" class="heading-link"><i class="fas fa-link"></i></a><a href="#Service层-9" class="headerlink" title="Service层"></a>Service层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CursorPageBaseResp&lt;ChatRoomResp&gt; <span class="title function_">getRoomPage</span><span class="params">(CursorPageBaseReq request, Long uid)</span>;</span><br></pre></td></tr></table></div></figure>

<p>实现类中</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//传入参数1.游标位置(起始为NUll),2.页面大小</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> CursorPageBaseResp&lt;ChatRoomResp&gt; <span class="title function_">getRoomPage</span><span class="params">(CursorPageBaseReq request, Long uid)</span> &#123;</span><br><span class="line">    <span class="comment">//获取游标位置分页</span></span><br><span class="line">    CursorPageBaseResp&lt;Room&gt; cursorPage = roomDao.getCursorPage(request);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//获取群聊列表 </span></span><br><span class="line">    ArrayList&lt;Room&gt; rooms = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(cursorPage.getList());</span><br><span class="line">    <span class="keyword">if</span> (request.isFirstPage()) &#123;</span><br><span class="line">        <span class="comment">//第一页插入置顶的大群聊</span></span><br><span class="line">        <span class="comment">//根据ID查询房间 long ROOM_GROUP_ID = 1L;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//Select * from room where id=?</span></span><br><span class="line">        <span class="type">Room</span> <span class="variable">group</span> <span class="operator">=</span> roomDao.getById(ROOM_GROUP_ID);</span><br><span class="line">        rooms.add(<span class="number">0</span>, group);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> CursorPageBaseResp.init(cursorPage, RoomAdapter.buildResp(rooms));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="getCursorPage"   >
          <a href="#getCursorPage" class="heading-link"><i class="fas fa-link"></i></a><a href="#getCursorPage" class="headerlink" title="getCursorPage"></a>getCursorPage</h4>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public CursorPageBaseResp&lt;Room&gt; getCursorPage(CursorPageBaseReq request) &#123;</span><br><span class="line">    return cursorUtils.getCursorPageByMysql(this, request, wrapper -&gt; &#123;</span><br><span class="line">        wrapper.ne(Room::getType, RoomTypeEnum.GROUP.getStatus());</span><br><span class="line">    &#125;, Room::getActiveTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="getCursorPageByMysql"   >
          <a href="#getCursorPageByMysql" class="heading-link"><i class="fas fa-link"></i></a><a href="#getCursorPageByMysql" class="headerlink" title="getCursorPageByMysql"></a>getCursorPageByMysql</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*传入参数1.Iservice&lt;Room&gt; mapper 操作room数据库的mapper</span></span><br><span class="line"><span class="comment">		 2.游标</span></span><br><span class="line"><span class="comment">         3.条件查询器  条件1).房间类型 2)房间状态</span></span><br><span class="line"><span class="comment">         4.房间最后活动时间</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; CursorPageBaseResp&lt;T&gt; <span class="title function_">getCursorPageByMysql</span><span class="params">(IService&lt;T&gt; mapper, CursorPageBaseReq request, Consumer&lt;LambdaQueryWrapper&lt;T&gt;&gt; initWrapper, SFunction&lt;T, ?&gt; cursorColumn)</span> &#123;</span><br><span class="line">    <span class="comment">//lambdaQueryWrapper </span></span><br><span class="line">    LambdaQueryWrapper&lt;T&gt; wrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">	<span class="comment">//初始化wrapper</span></span><br><span class="line">    initWrapper.accept(wrapper);</span><br><span class="line">    <span class="comment">//如果游标不为空 获取游标位置</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(request.getCursor())) &#123;</span><br><span class="line">        <span class="comment">//添加条件 游标要小于请求游标位置</span></span><br><span class="line">        wrapper.lt(cursorColumn, request.getCursor());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//根据最后请求位置 倒排</span></span><br><span class="line">    wrapper.orderByDesc(cursorColumn);</span><br><span class="line">    <span class="comment">//获取分页，一次十条 从游标位置开始倒排</span></span><br><span class="line">    Page&lt;T&gt; page = mapper.page(request.plusPage(), wrapper);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//获取一个游标 </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">cursor</span> <span class="operator">=</span> Optional.ofNullable(CollectionUtil.getLast(page.getRecords()))</span><br><span class="line">            .map(cursorColumn)</span><br><span class="line">            .map(String::valueOf)</span><br><span class="line">            .orElse(<span class="literal">null</span>);</span><br><span class="line">    <span class="comment">//判断是不是最后一页</span></span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">isLast</span> <span class="operator">=</span> page.getRecords().size() != request.getPageSize();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CursorPageBaseResp</span>&lt;&gt;(cursor, isLast, page.getRecords());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="init"   >
          <a href="#init" class="heading-link"><i class="fas fa-link"></i></a><a href="#init" class="headerlink" title="init"></a>init</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; CursorPageBaseResp&lt;T&gt; <span class="title function_">init</span><span class="params">(CursorPageBaseResp cursorPage, List&lt;T&gt; list)</span> &#123;</span><br><span class="line">    </span><br><span class="line">    CursorPageBaseResp&lt;T&gt; cursorPageBaseResp = <span class="keyword">new</span> <span class="title class_">CursorPageBaseResp</span>&lt;T&gt;();</span><br><span class="line">    <span class="comment">//设置是否是最后一页</span></span><br><span class="line">    cursorPageBaseResp.setIsLast(cursorPage.getIsLast());</span><br><span class="line">    <span class="comment">//设置list数据列表</span></span><br><span class="line">    cursorPageBaseResp.setList(list);</span><br><span class="line">    <span class="comment">//设置游标</span></span><br><span class="line">    cursorPageBaseResp.setCursor(cursorPage.getCursor());</span><br><span class="line">    <span class="keyword">return</span> cursorPageBaseResp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="流程-9"   >
          <a href="#流程-9" class="heading-link"><i class="fas fa-link"></i></a><a href="#流程-9" class="headerlink" title="流程"></a>流程</h4>
      <p>①获取所有的会话 (因为此时只有一个群聊所以不根据UID查询)</p>
<p>②获取一个返回游标及分页对象，默认游标是NULL，消息页数为10条</p>
<p>③init初始化会话和消息列表，返回</p>

        <h3 id="群成员模块"   >
          <a href="#群成员模块" class="heading-link"><i class="fas fa-link"></i></a><a href="#群成员模块" class="headerlink" title="群成员模块"></a>群成员模块</h3>
      
        <h4 id="群成员-在线人数统计"   >
          <a href="#群成员-在线人数统计" class="heading-link"><i class="fas fa-link"></i></a><a href="#群成员-在线人数统计" class="headerlink" title="群成员+在线人数统计"></a>群成员+在线人数统计</h4>
      <div class="table-container"><table>
<thead>
<tr>
<th>URI</th>
<th>请求类型</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;capi&#x2F;chat&#x2F;public&#x2F;member&#x2F;statistic</td>
<td>GET请求</td>
</tr>
</tbody></table></div>

        <h5 id="Controller层-12"   >
          <a href="#Controller层-12" class="heading-link"><i class="fas fa-link"></i></a><a href="#Controller层-12" class="headerlink" title="Controller层"></a>Controller层</h5>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;public/member/statistic&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;群成员人数统计&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ApiResult&lt;ChatMemberStatisticResp&gt; <span class="title function_">getMemberStatistic</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> ApiResult.success(chatService.getMemberStatistic());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="Service层-10"   >
          <a href="#Service层-10" class="heading-link"><i class="fas fa-link"></i></a><a href="#Service层-10" class="headerlink" title="Service层"></a>Service层</h5>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ChatMemberStatisticResp <span class="title function_">getMemberStatistic</span><span class="params">()</span>;</span><br></pre></td></tr></table></div></figure>

<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ChatMemberStatisticResp <span class="title function_">getMemberStatistic</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName());</span><br><span class="line">     	<span class="comment">//查询userCache.getOnlinenum获得在线总人数</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">onlineNum</span> <span class="operator">=</span> userCache.getOnlineNum();</span><br><span class="line">        <span class="comment">//离线人数</span></span><br><span class="line"><span class="comment">//        Long offlineNum = userCache.getOfflineNum();不展示总人数</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//获取一个返回对象</span></span><br><span class="line">        <span class="type">ChatMemberStatisticResp</span> <span class="variable">resp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChatMemberStatisticResp</span>();</span><br><span class="line">        <span class="comment">//设置在线人数</span></span><br><span class="line">        resp.setOnlineNum(onlineNum);</span><br><span class="line">        <span class="comment">//设置总人数</span></span><br><span class="line"><span class="comment">//        resp.setTotalNum(onlineNum + offlineNum);</span></span><br><span class="line">        <span class="keyword">return</span> resp;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="getOnlineNum"   >
          <a href="#getOnlineNum" class="heading-link"><i class="fas fa-link"></i></a><a href="#getOnlineNum" class="headerlink" title="getOnlineNum"></a>getOnlineNum</h5>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Long <span class="title function_">getOnlineNum</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//拼接一个Key: String ONLINE_UID_ZET = &quot;online&quot;;</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">onlineKey</span> <span class="operator">=</span> RedisKey.getKey(RedisKey.ONLINE_UID_ZET);</span><br><span class="line">    <span class="comment">//调用zCard方法将key传入</span></span><br><span class="line">    <span class="keyword">return</span> RedisUtils.zCard(onlineKey);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="zCard"   >
          <a href="#zCard" class="heading-link"><i class="fas fa-link"></i></a><a href="#zCard" class="headerlink" title="zCard"></a>zCard</h5>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ublic <span class="keyword">static</span> Long <span class="title function_">zCard</span><span class="params">(String key)</span> &#123;</span><br><span class="line">  	<span class="comment">//通过Zset将Online个数传回来</span></span><br><span class="line">    <span class="keyword">return</span> stringRedisTemplate.opsForZSet().zCard(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="流程-10"   >
          <a href="#流程-10" class="heading-link"><i class="fas fa-link"></i></a><a href="#流程-10" class="headerlink" title="流程"></a>流程</h5>
      <p>调用Redis 通过zset的Zset命令获取Key为MallChat:online的个数，然后返回给前端显示在线总人数</p>
<p>如果要做总人数的统计，可以通过key为MallChat:offLine的个数与MallChat:online的个数进行累加，这样就知道了总人数</p>

        <h4 id="上线下线推送"   >
          <a href="#上线下线推送" class="heading-link"><i class="fas fa-link"></i></a><a href="#上线下线推送" class="headerlink" title="上线下线推送"></a>上线下线推送</h4>
      
        <h5 id="主动更新成员列表"   >
          <a href="#主动更新成员列表" class="heading-link"><i class="fas fa-link"></i></a><a href="#主动更新成员列表" class="headerlink" title="主动更新成员列表"></a>主动更新成员列表</h5>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> CursorPageBaseResp&lt;ChatMemberResp&gt; <span class="title function_">getMemberPage</span><span class="params">(CursorPageBaseReq request)</span> &#123;</span><br><span class="line">    Pair&lt;ChatActiveStatusEnum, String&gt; pair = ChatMemberHelper.getCursorPair(request.getCursor());</span><br><span class="line">    <span class="type">ChatActiveStatusEnum</span> <span class="variable">activeStatusEnum</span> <span class="operator">=</span> pair.getKey();</span><br><span class="line">    <span class="type">String</span> <span class="variable">timeCursor</span> <span class="operator">=</span> pair.getValue();</span><br><span class="line">    List&lt;ChatMemberResp&gt; resultList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();<span class="comment">//最终列表</span></span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">isLast</span> <span class="operator">=</span> Boolean.FALSE;</span><br><span class="line">    <span class="keyword">if</span> (activeStatusEnum == ChatActiveStatusEnum.ONLINE) &#123;<span class="comment">//在线列表</span></span><br><span class="line">        CursorPageBaseResp&lt;Pair&lt;Long, Double&gt;&gt; cursorPage = userCache.getOnlineCursorPage(<span class="keyword">new</span> <span class="title class_">CursorPageBaseReq</span>(request.getPageSize(), timeCursor));</span><br><span class="line">        resultList.addAll(memberAdapter.buildMember(cursorPage.getList(), ChatActiveStatusEnum.ONLINE));<span class="comment">//添加在线列表</span></span><br><span class="line">        <span class="keyword">if</span> (cursorPage.getIsLast()) &#123;<span class="comment">//如果是最后一页,从离线列表再补点数据</span></span><br><span class="line">            <span class="type">Integer</span> <span class="variable">leftSize</span> <span class="operator">=</span> request.getPageSize() - cursorPage.getList().size();</span><br><span class="line">            cursorPage = userCache.getOfflineCursorPage(<span class="keyword">new</span> <span class="title class_">CursorPageBaseReq</span>(leftSize, <span class="literal">null</span>));</span><br><span class="line">            resultList.addAll(memberAdapter.buildMember(cursorPage.getList(), ChatActiveStatusEnum.OFFLINE));<span class="comment">//添加离线线列表</span></span><br><span class="line">            activeStatusEnum = ChatActiveStatusEnum.OFFLINE;</span><br><span class="line">        &#125;</span><br><span class="line">        timeCursor = cursorPage.getCursor();</span><br><span class="line">        isLast = cursorPage.getIsLast();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (activeStatusEnum == ChatActiveStatusEnum.OFFLINE) &#123;<span class="comment">//离线列表</span></span><br><span class="line">        CursorPageBaseResp&lt;Pair&lt;Long, Double&gt;&gt; cursorPage = userCache.getOfflineCursorPage(<span class="keyword">new</span> <span class="title class_">CursorPageBaseReq</span>(request.getPageSize(), timeCursor));</span><br><span class="line">        resultList.addAll(memberAdapter.buildMember(cursorPage.getList(), ChatActiveStatusEnum.OFFLINE));<span class="comment">//添加离线线列表</span></span><br><span class="line">        timeCursor = cursorPage.getCursor();</span><br><span class="line">        isLast = cursorPage.getIsLast();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//组装结果</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CursorPageBaseResp</span>&lt;&gt;(ChatMemberHelper.generateCursor(activeStatusEnum, timeCursor), isLast, resultList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="后台推送"   >
          <a href="#后台推送" class="heading-link"><i class="fas fa-link"></i></a><a href="#后台推送" class="headerlink" title="后台推送"></a>后台推送</h5>
      
        <h6 id="用户上线"   >
          <a href="#用户上线" class="heading-link"><i class="fas fa-link"></i></a><a href="#用户上线" class="headerlink" title="用户上线"></a>用户上线</h6>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loginSuccess</span><span class="params">(Channel channel, User user, String token)</span> &#123;</span><br><span class="line">        <span class="comment">//更新上线列表</span></span><br><span class="line">        online(channel, user.getId());</span><br><span class="line">        <span class="comment">//返回给用户登录成功</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">hasPower</span> <span class="operator">=</span> iRoleService.hasPower(user.getId(), RoleEnum.CHAT_MANAGER);</span><br><span class="line">        sendMsg(channel, WSAdapter.buildLoginSuccessResp(user, token, hasPower));</span><br><span class="line">        <span class="comment">//发送用户上线事件</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    	<span class="comment">//查询cache中发现Oniine中没有这个用户ID说明用户刚刚上线</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">online</span> <span class="operator">=</span> userCache.isOnline(user.getId());</span><br><span class="line">        <span class="keyword">if</span> (!online) &#123;</span><br><span class="line">            user.setLastOptTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">            user.refreshIp(NettyUtil.getAttr(channel, NettyUtil.IP));</span><br><span class="line">            <span class="comment">//发布用户上线事件</span></span><br><span class="line">            applicationEventPublisher.publishEvent(<span class="keyword">new</span> <span class="title class_">UserOnlineEvent</span>(<span class="built_in">this</span>, user));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h6 id="用户下线"   >
          <a href="#用户下线" class="heading-link"><i class="fas fa-link"></i></a><a href="#用户下线" class="headerlink" title="用户下线"></a>用户下线</h6>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removed</span><span class="params">(Channel channel)</span> &#123;</span><br><span class="line">    <span class="comment">//获取channel</span></span><br><span class="line">    <span class="type">WSChannelExtraDTO</span> <span class="variable">wsChannelExtraDTO</span> <span class="operator">=</span> ONLINE_WS_MAP.get(channel);</span><br><span class="line">    Optional&lt;Long&gt; uidOptional = Optional.ofNullable(wsChannelExtraDTO)</span><br><span class="line">            .map(WSChannelExtraDTO::getUid);</span><br><span class="line"> 	<span class="comment">//判断这个channel所对应的用户是否全部下线</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">offlineAll</span> <span class="operator">=</span> offline(channel, uidOptional);</span><br><span class="line">    <span class="keyword">if</span> (uidOptional.isPresent() &amp;&amp; offlineAll) &#123;<span class="comment">//已登录用户断连,并且全下线成功</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user.setId(uidOptional.get());</span><br><span class="line">        user.setLastOptTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        <span class="comment">//发布下线事件</span></span><br><span class="line">        applicationEventPublisher.publishEvent(<span class="keyword">new</span> <span class="title class_">UserOfflineEvent</span>(<span class="built_in">this</span>, user));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="流程-11"   >
          <a href="#流程-11" class="heading-link"><i class="fas fa-link"></i></a><a href="#流程-11" class="headerlink" title="流程"></a>流程</h5>
      <p>用户上线和下线主要靠主动的游标翻页更新成员列表以及后台的推送完成</p>
<p>1.成员上线 发布上线事件，判断游标类型对在线列表进行更新</p>
<p>2.成员下线 发布下线事件，更新在线列表以及离线列表</p>

        <h4 id="群成员Zset游标翻页"   >
          <a href="#群成员Zset游标翻页" class="heading-link"><i class="fas fa-link"></i></a><a href="#群成员Zset游标翻页" class="headerlink" title="群成员Zset游标翻页"></a>群成员Zset游标翻页</h4>
      
        <h5 id="群成员列表的翻页"   >
          <a href="#群成员列表的翻页" class="heading-link"><i class="fas fa-link"></i></a><a href="#群成员列表的翻页" class="headerlink" title="群成员列表的翻页"></a>群成员列表的翻页</h5>
      <div class="table-container"><table>
<thead>
<tr>
<th>URI</th>
<th>请求类型</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;capi&#x2F;chat&#x2F;public&#x2F;member&#x2F;page</td>
<td>GET请求</td>
</tr>
</tbody></table></div>

        <h6 id="Controller层-13"   >
          <a href="#Controller层-13" class="heading-link"><i class="fas fa-link"></i></a><a href="#Controller层-13" class="headerlink" title="Controller层"></a>Controller层</h6>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/public/member/page&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;群成员列表&quot;)</span></span><br><span class="line">	<span class="comment">//频控</span></span><br><span class="line">    <span class="meta">@FrequencyControl(time = 120, count = 20, target = FrequencyControl.Target.IP)</span></span><br><span class="line">    <span class="keyword">public</span> ApiResult&lt;CursorPageBaseResp&lt;ChatMemberResp&gt;&gt; <span class="title function_">getMemberPage</span><span class="params">(<span class="meta">@Valid</span> CursorPageBaseReq request)</span> &#123;</span><br><span class="line"><span class="comment">//        black(request);</span></span><br><span class="line">        </span><br><span class="line">        CursorPageBaseResp&lt;ChatMemberResp&gt; memberPage = chatService.getMemberPage(request);</span><br><span class="line">        <span class="comment">//过滤黑名单用户</span></span><br><span class="line">        filterBlackMember(memberPage);</span><br><span class="line">        <span class="keyword">return</span> ApiResult.success(memberPage);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h6 id="Service层-11"   >
          <a href="#Service层-11" class="heading-link"><i class="fas fa-link"></i></a><a href="#Service层-11" class="headerlink" title="Service层"></a>Service层</h6>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CursorPageBaseResp&lt;ChatMemberResp&gt; <span class="title function_">getMemberPage</span><span class="params">(CursorPageBaseReq request)</span>;</span><br></pre></td></tr></table></div></figure>

<p>实现类中</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> CursorPageBaseResp&lt;ChatMemberResp&gt; <span class="title function_">getMemberPage</span><span class="params">(CursorPageBaseReq request)</span> &#123;</span><br><span class="line">    <span class="comment">//根据游标位置获取一个pair页</span></span><br><span class="line">    Pair&lt;ChatActiveStatusEnum, String&gt; pair = ChatMemberHelper.getCursorPair(request.getCursor());</span><br><span class="line">    <span class="comment">//页获取在线状态 Key:Online/offLine</span></span><br><span class="line">    <span class="type">ChatActiveStatusEnum</span> <span class="variable">activeStatusEnum</span> <span class="operator">=</span> pair.getKey();</span><br><span class="line">    <span class="comment">//游标的当前位置</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">timeCursor</span> <span class="operator">=</span> pair.getValue();</span><br><span class="line">    List&lt;ChatMemberResp&gt; resultList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();<span class="comment">//最终列表</span></span><br><span class="line">    <span class="comment">//判断是否是最后一页，默认不是</span></span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">isLast</span> <span class="operator">=</span> Boolean.FALSE;</span><br><span class="line">    <span class="keyword">if</span> (activeStatusEnum == ChatActiveStatusEnum.ONLINE) &#123;<span class="comment">//在线列表</span></span><br><span class="line">        CursorPageBaseResp&lt;Pair&lt;Long, Double&gt;&gt; cursorPage = userCache.getOnlineCursorPage(<span class="keyword">new</span> <span class="title class_">CursorPageBaseReq</span>(request.getPageSize(), timeCursor));</span><br><span class="line">        resultList.addAll(memberAdapter.buildMember(cursorPage.getList(), ChatActiveStatusEnum.ONLINE));<span class="comment">//添加在线列表</span></span><br><span class="line">        <span class="keyword">if</span> (cursorPage.getIsLast()) &#123;<span class="comment">//如果是最后一页,从离线列表再补点数据</span></span><br><span class="line">            <span class="type">Integer</span> <span class="variable">leftSize</span> <span class="operator">=</span> request.getPageSize() - cursorPage.getList().size();</span><br><span class="line">            cursorPage = userCache.getOfflineCursorPage(<span class="keyword">new</span> <span class="title class_">CursorPageBaseReq</span>(leftSize, <span class="literal">null</span>));</span><br><span class="line">            resultList.addAll(memberAdapter.buildMember(cursorPage.getList(), ChatActiveStatusEnum.OFFLINE));<span class="comment">//添加离线线列表</span></span><br><span class="line">            activeStatusEnum = ChatActiveStatusEnum.OFFLINE;</span><br><span class="line">        &#125;</span><br><span class="line">        timeCursor = cursorPage.getCursor();</span><br><span class="line">        isLast = cursorPage.getIsLast();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (activeStatusEnum == ChatActiveStatusEnum.OFFLINE) &#123;<span class="comment">//离线列表</span></span><br><span class="line">        CursorPageBaseResp&lt;Pair&lt;Long, Double&gt;&gt; cursorPage = userCache.getOfflineCursorPage(<span class="keyword">new</span> <span class="title class_">CursorPageBaseReq</span>(request.getPageSize(), timeCursor));</span><br><span class="line">        resultList.addAll(memberAdapter.buildMember(cursorPage.getList(), ChatActiveStatusEnum.OFFLINE));<span class="comment">//添加离线线列表</span></span><br><span class="line">        timeCursor = cursorPage.getCursor();</span><br><span class="line">        isLast = cursorPage.getIsLast();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//组装结果</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CursorPageBaseResp</span>&lt;&gt;(ChatMemberHelper.generateCursor(activeStatusEnum, timeCursor), isLast, resultList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h6 id="getCurOrPageByRedis"   >
          <a href="#getCurOrPageByRedis" class="heading-link"><i class="fas fa-link"></i></a><a href="#getCurOrPageByRedis" class="headerlink" title="getCurOrPageByRedis"></a>getCurOrPageByRedis</h6>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; CursorPageBaseResp&lt;Pair&lt;T, Double&gt;&gt; <span class="title function_">getCursorPageByRedis</span><span class="params">(CursorPageBaseReq cursorPageBaseReq, String redisKey, Function&lt;String, T&gt; typeConvert)</span> &#123;</span><br><span class="line">    Set&lt;ZSetOperations.TypedTuple&lt;String&gt;&gt; typedTuples;</span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isBlank(cursorPageBaseReq.getCursor())) &#123;<span class="comment">//第一次</span></span><br><span class="line">        typedTuples = RedisUtils.zReverseRangeWithScores(redisKey, cursorPageBaseReq.getPageSize());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        typedTuples = RedisUtils.zReverseRangeByScoreWithScores(redisKey, Double.parseDouble(cursorPageBaseReq.getCursor()), cursorPageBaseReq.getPageSize());</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;Pair&lt;T, Double&gt;&gt; result = typedTuples</span><br><span class="line">            .stream()</span><br><span class="line">            .map(t -&gt; Pair.of(typeConvert.apply(t.getValue()), t.getScore()))</span><br><span class="line">            .sorted((o1, o2) -&gt; o2.getValue().compareTo(o1.getValue()))</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">    <span class="type">String</span> <span class="variable">cursor</span> <span class="operator">=</span> Optional.ofNullable(CollectionUtil.getLast(result))</span><br><span class="line">            .map(Pair::getValue)</span><br><span class="line">            .map(String::valueOf)</span><br><span class="line">            .orElse(<span class="literal">null</span>);</span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">isLast</span> <span class="operator">=</span> result.size() != cursorPageBaseReq.getPageSize();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CursorPageBaseResp</span>&lt;&gt;(cursor, isLast, result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h6 id="流程-12"   >
          <a href="#流程-12" class="heading-link"><i class="fas fa-link"></i></a><a href="#流程-12" class="headerlink" title="流程"></a>流程</h6>
      <p><strong>利用Zset的属性</strong>  </p>
<p><em>Redis命令  Zrange  key min max 天然具有分页属性</em></p>
<p>①获取一个游标分页，然后判断是不是在线状态，是不是在线状态最后一页</p>
<p>②如果是在线状态且不是最后一页，那从UserCache中找在线状态用户缓存添加到返回列表，更新游标位置</p>
<p>③如果是在线状态且是最后一页，那从UserCache中找在线用户缓存，然后判断用户数够不够，不够从离线用户中补一部分数据，更新游标位置</p>
<p>④如果是离线，从UserCache中找离线用户缓存</p>
<p>⑤最后过滤黑名单用户 返回给前端</p>

        <h5 id="的群成员列表"   >
          <a href="#的群成员列表" class="heading-link"><i class="fas fa-link"></i></a><a href="#的群成员列表" class="headerlink" title="@的群成员列表"></a>@的群成员列表</h5>
      <div class="table-container"><table>
<thead>
<tr>
<th>URI</th>
<th>请求类型</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;capi&#x2F;chat&#x2F;member&#x2F;list</td>
<td>GET请求</td>
</tr>
</tbody></table></div>

        <h6 id="Controller层-14"   >
          <a href="#Controller层-14" class="heading-link"><i class="fas fa-link"></i></a><a href="#Controller层-14" class="headerlink" title="Controller层"></a>Controller层</h6>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GetMapping(<span class="string">&quot;/member/list&quot;</span>)</span><br><span class="line"><span class="meta">@ApiOperation(&quot;房间内的所有群成员列表-@专用&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ApiResult&lt;List&lt;ChatMemberListResp&gt;&gt; <span class="title function_">getMemberList</span><span class="params">(<span class="meta">@Valid</span> ChatMessageMemberReq chatMessageMemberReq)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> ApiResult.success(chatService.getMemberList(chatMessageMemberReq));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h6 id="Service层-12"   >
          <a href="#Service层-12" class="heading-link"><i class="fas fa-link"></i></a><a href="#Service层-12" class="headerlink" title="Service层"></a>Service层</h6>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;ChatMemberListResp&gt; <span class="title function_">getMemberList</span><span class="params">(ChatMessageMemberReq chatMessageMemberReq)</span>;</span><br></pre></td></tr></table></div></figure>

<p>实现类中</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Cacheable(cacheNames = &quot;member&quot;, key = &quot;&#x27;memberList.&#x27;+#req.roomId&quot;)</span></span><br><span class="line"><span class="keyword">public</span> List&lt;ChatMemberListResp&gt; <span class="title function_">getMemberList</span><span class="params">(ChatMessageMemberReq req)</span> &#123;</span><br><span class="line">    <span class="comment">//判断房间号和请求房间ID是否相同</span></span><br><span class="line">    <span class="keyword">if</span> (Objects.equals(<span class="number">1L</span>, req.getRoomId())) &#123;<span class="comment">//大群聊可看见所有人</span></span><br><span class="line">        <span class="keyword">return</span> userDao.getMemberList()</span><br><span class="line">                .stream()</span><br><span class="line">                .map(a -&gt; &#123;</span><br><span class="line">                    <span class="type">ChatMemberListResp</span> <span class="variable">resp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChatMemberListResp</span>();</span><br><span class="line">                    BeanUtils.copyProperties(a, resp);</span><br><span class="line">                    resp.setUid(a.getId());</span><br><span class="line">                    <span class="keyword">return</span> resp;</span><br><span class="line">                &#125;).collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h6 id="getMemberList"   >
          <a href="#getMemberList" class="heading-link"><i class="fas fa-link"></i></a><a href="#getMemberList" class="headerlink" title="getMemberList"></a>getMemberList</h6>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查询用户状态正常，然后按照活跃时间倒数排列的1000人列表，select ID，name，和头像 以列表返回</span></span><br><span class="line"><span class="keyword">public</span> List&lt;User&gt; <span class="title function_">getMemberList</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> lambdaQuery()</span><br><span class="line">            .eq(User::getStatus, NormalOrNoEnum.NORMAL.getStatus())</span><br><span class="line">            .orderByDesc(User::getUpdateTime)<span class="comment">//最近活跃的1000个人，可以用lastOptTime字段，但是该字段没索引，updateTime可平替</span></span><br><span class="line">            .last(<span class="string">&quot;limit 1000&quot;</span>)<span class="comment">//毕竟是大群聊，人数需要做个限制</span></span><br><span class="line">            .select(User::getId, User::getName, User::getAvatar)</span><br><span class="line">            .list();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h6 id="流程-13"   >
          <a href="#流程-13" class="heading-link"><i class="fas fa-link"></i></a><a href="#流程-13" class="headerlink" title="流程"></a>流程</h6>
      <p>1.判断是不是公共群聊</p>
<p>2.如果是则查询活跃的1000人的头像，id，昵称且以活跃时间倒序排序</p>
<p><strong>@用户没有用到游标</strong></p>

        <h3 id="消息模块"   >
          <a href="#消息模块" class="heading-link"><i class="fas fa-link"></i></a><a href="#消息模块" class="headerlink" title="消息模块"></a>消息模块</h3>
      
        <h1 id="异常情况"   >
          <a href="#异常情况" class="heading-link"><i class="fas fa-link"></i></a><a href="#异常情况" class="headerlink" title="异常情况"></a>异常情况</h1>
      <p><strong>打上断点进行调试</strong></p>

        <h2 id="异常在线用户数量，用户已经下线而显示还在线上中"   >
          <a href="#异常在线用户数量，用户已经下线而显示还在线上中" class="heading-link"><i class="fas fa-link"></i></a><a href="#异常在线用户数量，用户已经下线而显示还在线上中" class="headerlink" title="异常在线用户数量，用户已经下线而显示还在线上中"></a>异常在线用户数量，用户已经下线而显示还在线上中</h2>
      
        <h3 id="用户端1"   >
          <a href="#用户端1" class="heading-link"><i class="fas fa-link"></i></a><a href="#用户端1" class="headerlink" title="用户端1"></a>用户端1</h3>
      <p>未登录用户界面</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="/MallChat%E9%A1%B9%E7%9B%AE%E5%88%86%E6%9E%90/image-20230804170246021.png"  alt="用戶端1">
      </p>
<p>浏览器Cache</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="/MallChat%E9%A1%B9%E7%9B%AE%E5%88%86%E6%9E%90/image-20230804170416313.png"  alt="未登录Cache">
      </p>

        <h3 id="用户端2"   >
          <a href="#用户端2" class="heading-link"><i class="fas fa-link"></i></a><a href="#用户端2" class="headerlink" title="用户端2"></a>用户端2</h3>
      <p>已登录用户用户端</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="/MallChat%E9%A1%B9%E7%9B%AE%E5%88%86%E6%9E%90/image-20230804170527319.png"  alt="已登录用户端">
      </p>
<p>浏览器Cache</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="/MallChat%E9%A1%B9%E7%9B%AE%E5%88%86%E6%9E%90/image-20230804170656484.png"  alt="浏览器Cache">
      </p>

        <h3 id="退出用户端2"   >
          <a href="#退出用户端2" class="heading-link"><i class="fas fa-link"></i></a><a href="#退出用户端2" class="headerlink" title="退出用户端2"></a>退出用户端2</h3>
      <p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="/MallChat%E9%A1%B9%E7%9B%AE%E5%88%86%E6%9E%90/image-20230804170829700.png"  alt="退出用户端2">
      </p>
<p>正如用户端1客户端显示一样</p>

        <h2 id="抛出InvalidDataAccessApiUsageException异常"   >
          <a href="#抛出InvalidDataAccessApiUsageException异常" class="heading-link"><i class="fas fa-link"></i></a><a href="#抛出InvalidDataAccessApiUsageException异常" class="headerlink" title="抛出InvalidDataAccessApiUsageException异常"></a>抛出InvalidDataAccessApiUsageException异常</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">JDBC Connection [HikariProxyConnection@<span class="number">2146628671</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@4cd7671d] will not be managed by Spring</span><br><span class="line">==&gt;  Preparing: UPDATE user SET last_opt_time=? WHERE id=?</span><br><span class="line">==&gt; Parameters: <span class="number">2023</span>-<span class="number">07</span>-<span class="number">30</span> <span class="number">17</span>:<span class="number">23</span>:<span class="number">43.267</span>(Timestamp), <span class="number">10003</span>(Long)</span><br><span class="line">|ERROR|<span class="number">2023</span>-<span class="number">07</span>-<span class="number">30</span> <span class="number">17</span>:<span class="number">23</span>:<span class="number">43.274</span>|mallchat-executor-<span class="number">7</span>||uid=|Unexpected exception occurred invoking async method: <span class="keyword">public</span> <span class="keyword">void</span> com.abin.mallchat.custom.common.event.listener.UserOfflineListener.saveRedisAndPush(com.abin.mallchat.common.common.event.UserOfflineEvent)|</span><br><span class="line">org.springframework.dao.InvalidDataAccessApiUsageException: Redisson is shutdown; nested exception is org.redisson.RedissonShutdownException: Redisson is shutdown</span><br><span class="line">	at org.redisson.spring.data.connection.RedissonExceptionConverter.convert(RedissonExceptionConverter.java:<span class="number">52</span>)</span><br><span class="line">	at org.redisson.spring.data.connection.RedissonExceptionConverter.convert(RedissonExceptionConverter.java:<span class="number">35</span>)</span><br><span class="line">	at org.springframework.data.redis.PassThroughExceptionTranslationStrategy.translate(PassThroughExceptionTranslationStrategy.java:<span class="number">44</span>)</span><br><span class="line">	at org.redisson.spring.data.connection.RedissonConnection.transform(RedissonConnection.java:<span class="number">200</span>)</span><br><span class="line">	at org.redisson.spring.data.connection.RedissonConnection.syncFuture(RedissonConnection.java:<span class="number">195</span>)</span><br><span class="line">	at org.redisson.spring.data.connection.RedissonConnection.sync(RedissonConnection.java:<span class="number">364</span>)</span><br><span class="line">	at org.redisson.spring.data.connection.RedissonConnection.write(RedissonConnection.java:<span class="number">730</span>)</span><br><span class="line">	at org.redisson.spring.data.connection.RedissonConnection.zRem(RedissonConnection.java:<span class="number">1021</span>)</span><br><span class="line">	at org.springframework.data.redis.connection.DefaultStringRedisConnection.zRem(DefaultStringRedisConnection.java:<span class="number">1829</span>)</span><br><span class="line">	at org.springframework.data.redis.core.DefaultZSetOperations.lambda$remove$<span class="number">27</span>(DefaultZSetOperations.java:<span class="number">444</span>)</span><br><span class="line">	at org.springframework.data.redis.core.RedisTemplate.execute(RedisTemplate.java:<span class="number">223</span>)</span><br><span class="line">	at org.springframework.data.redis.core.RedisTemplate.execute(RedisTemplate.java:<span class="number">190</span>)</span><br><span class="line">	at org.springframework.data.redis.core.AbstractOperations.execute(AbstractOperations.java:<span class="number">97</span>)</span><br><span class="line">	at org.springframework.data.redis.core.DefaultZSetOperations.remove(DefaultZSetOperations.java:<span class="number">444</span>)</span><br><span class="line">	at com.abin.mallchat.common.common.utils.RedisUtils.zRemove(RedisUtils.java:<span class="number">803</span>)</span><br><span class="line">	at com.abin.mallchat.common.common.utils.RedisUtils.zRemove(RedisUtils.java:<span class="number">799</span>)</span><br><span class="line">	at com.abin.mallchat.common.user.service.cache.UserCache.offline(UserCache.java:<span class="number">85</span>)</span><br><span class="line">	at com.abin.mallchat.common.user.service.cache.UserCache$$FastClassBySpringCGLIB$$4d4b28eb.invoke(&lt;generated&gt;)</span><br><span class="line">	at org.springframework.cglib.proxy.MethodProxy.invoke(MethodProxy.java:<span class="number">218</span>)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy.invokeMethod(CglibAopProxy.java:<span class="number">386</span>)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy.access$<span class="number">000</span>(CglibAopProxy.java:<span class="number">85</span>)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:<span class="number">704</span>)</span><br><span class="line">	at com.abin.mallchat.common.user.service.cache.UserCache$$EnhancerBySpringCGLIB$$6f823fec.offline(&lt;generated&gt;)</span><br><span class="line">	at com.abin.mallchat.custom.common.event.listener.UserOfflineListener.saveRedisAndPush(UserOfflineListener.java:<span class="number">36</span>)</span><br><span class="line">	at com.abin.mallchat.custom.common.event.listener.UserOfflineListener$$FastClassBySpringCGLIB$$c62500f3.invoke(&lt;generated&gt;)</span><br><span class="line">	at org.springframework.cglib.proxy.MethodProxy.invoke(MethodProxy.java:<span class="number">218</span>)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.invokeJoinpoint(CglibAopProxy.java:<span class="number">793</span>)</span><br><span class="line">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:<span class="number">163</span>)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:<span class="number">763</span>)</span><br><span class="line">	at org.springframework.aop.interceptor.AsyncExecutionInterceptor.lambda$invoke$<span class="number">0</span>(AsyncExecutionInterceptor.java:<span class="number">115</span>)</span><br><span class="line">	at java.util.concurrent.FutureTask.run(FutureTask.java:<span class="number">266</span>)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1149</span>)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">624</span>)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:<span class="number">748</span>)</span><br><span class="line">Caused by: org.redisson.RedissonShutdownException: Redisson is shutdown</span><br><span class="line">	at org.redisson.command.RedisExecutor.execute(RedisExecutor.java:<span class="number">118</span>)</span><br><span class="line">	at org.redisson.command.CommandAsyncService.async(CommandAsyncService.java:<span class="number">585</span>)</span><br><span class="line">	at org.redisson.command.CommandAsyncService.writeAsync(CommandAsyncService.java:<span class="number">554</span>)</span><br><span class="line">	at org.redisson.spring.data.connection.RedissonConnection.write(RedissonConnection.java:<span class="number">728</span>)</span><br><span class="line">	... <span class="number">27</span> common frames omitted</span><br><span class="line">&lt;==    Updates: <span class="number">1</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="执行的SQL语句"   >
          <a href="#执行的SQL语句" class="heading-link"><i class="fas fa-link"></i></a><a href="#执行的SQL语句" class="headerlink" title="执行的SQL语句"></a>执行的SQL语句</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">==&gt;Preparing: UPDATE user SET last_opt_time=? WHERE id=?</span><br><span class="line"><span class="comment">//更新user表 更新Last_opt_time(最后上下线时间) where id=?</span></span><br><span class="line">==&gt; Parameters: <span class="number">2023</span>-<span class="number">07</span>-<span class="number">30</span> <span class="number">17</span>:<span class="number">23</span>:<span class="number">43.267</span>(Timestamp), <span class="number">10003</span>(Long) </span><br><span class="line"><span class="comment">//传入时间戳和用户ID</span></span><br><span class="line">    </span><br><span class="line">   </span><br><span class="line"><span class="comment">//报错RedisSon is shutdown;</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">&lt;==    Updates: <span class="number">1</span></span><br><span class="line"><span class="comment">//更新成功</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="异常复现"   >
          <a href="#异常复现" class="heading-link"><i class="fas fa-link"></i></a><a href="#异常复现" class="headerlink" title="异常复现"></a>异常复现</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">==&gt;  Preparing: UPDATE user SET last_opt_time=? WHERE id=?</span><br><span class="line">==&gt; Parameters: <span class="number">2023</span>-<span class="number">07</span>-<span class="number">30</span> <span class="number">17</span>:<span class="number">45</span>:<span class="number">46.053</span>(Timestamp), <span class="number">10003</span>(Long)</span><br><span class="line">|ERROR|<span class="number">2023</span>-<span class="number">07</span>-<span class="number">30</span> <span class="number">17</span>:<span class="number">45</span>:<span class="number">46.061</span>|mallchat-executor-<span class="number">9</span>||uid=|Unexpected exception occurred invoking async method: <span class="keyword">public</span> <span class="keyword">void</span> com.abin.mallchat.custom.common.event.listener.UserOfflineListener.saveRedisAndPush(com.abin.mallchat.common.common.event.UserOfflineEvent)|</span><br><span class="line">org.springframework.dao.InvalidDataAccessApiUsageException: Redisson is shutdown; </span><br><span class="line">....</span><br><span class="line">	... <span class="number">27</span> common frames omitted</span><br><span class="line">&lt;==    Updates: <span class="number">1</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="分析原因"   >
          <a href="#分析原因" class="heading-link"><i class="fas fa-link"></i></a><a href="#分析原因" class="headerlink" title="分析原因"></a>分析原因</h3>
      <p>RedisSon is Shutdown 抛出的异常是因为后端的关闭，导致RedisSon实例关闭</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//抛出异常</span></span><br><span class="line">InvalidDataAccessApiUsageException: Redisson is shutdown; </span><br><span class="line">nested exception is org.redisson.RedissonShutdownException: Redisson is shutdown</span><br><span class="line"></span><br><span class="line"><span class="comment">//表示Redisson已经关闭</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="处理"   >
          <a href="#处理" class="heading-link"><i class="fas fa-link"></i></a><a href="#处理" class="headerlink" title="处理"></a>处理</h3>
      
        <h2 id="空指针异常"   >
          <a href="#空指针异常" class="heading-link"><i class="fas fa-link"></i></a><a href="#空指针异常" class="headerlink" title="空指针异常"></a>空指针异常</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">|ERROR|<span class="number">2023</span>-<span class="number">07</span>-<span class="number">30</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">35.653</span>|http-nio-<span class="number">8080</span>-exec-<span class="number">7</span>|7c7b1d92-b364-4de5-bfe8-7896ec4f2c07|uid=<span class="number">10003</span>|system exception！The reason is：<span class="literal">null</span>|</span><br><span class="line">java.lang.reflect.UndeclaredThrowableException: <span class="literal">null</span></span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:<span class="number">780</span>)</span><br><span class="line">	at org.springframework.aop.aspectj.MethodInvocationProceedingJoinPoint.proceed(MethodInvocationProceedingJoinPoint.java:<span class="number">89</span>)</span><br><span class="line">	at com.abin.mallchat.custom.common.intecepter.WebLogAspect.around(WebLogAspect.java:<span class="number">63</span>)</span><br><span class="line">	at sun.reflect.GeneratedMethodAccessor199.invoke(Unknown Source)</span><br><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:<span class="number">43</span>)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:<span class="number">498</span>)</span><br><span class="line">	at org.springframework.aop.aspectj.AbstractAspectJAdvice.invokeAdviceMethodWithGivenArgs(AbstractAspectJAdvice.java:<span class="number">634</span>)</span><br><span class="line">	at org.springframework.aop.aspectj.AbstractAspectJAdvice.invokeAdviceMethod(AbstractAspectJAdvice.java:<span class="number">624</span>)</span><br><span class="line">	at org.springframework.aop.aspectj.AspectJAroundAdvice.invoke(AspectJAroundAdvice.java:<span class="number">72</span>)</span><br><span class="line">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:<span class="number">186</span>)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:<span class="number">763</span>)</span><br><span class="line">	at org.springframework.aop.interceptor.ExposeInvocationInterceptor.invoke(ExposeInvocationInterceptor.java:<span class="number">97</span>)</span><br><span class="line">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:<span class="number">186</span>)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:<span class="number">763</span>)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:<span class="number">708</span>)</span><br><span class="line">	at com.abin.mallchat.custom.user.controller.OssController$$EnhancerBySpringCGLIB$$94c0c149.getUploadUrl(&lt;generated&gt;)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:<span class="number">62</span>)</span><br><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:<span class="number">43</span>)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:<span class="number">498</span>)</span><br><span class="line">	at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:<span class="number">205</span>)</span><br><span class="line">	at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:<span class="number">150</span>)</span><br><span class="line">	at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:<span class="number">117</span>)</span><br><span class="line">	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:<span class="number">895</span>)</span><br><span class="line">	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:<span class="number">808</span>)</span><br><span class="line">	at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:<span class="number">87</span>)</span><br><span class="line">	at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:<span class="number">1067</span>)</span><br><span class="line">	at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:<span class="number">963</span>)</span><br><span class="line">	at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:<span class="number">1006</span>)</span><br><span class="line">	at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:<span class="number">898</span>)</span><br><span class="line">	at javax.servlet.http.HttpServlet.service(HttpServlet.java:<span class="number">655</span>)</span><br><span class="line">	at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:<span class="number">883</span>)</span><br><span class="line">	at javax.servlet.http.HttpServlet.service(HttpServlet.java:<span class="number">764</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">227</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:<span class="number">53</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at com.abin.mallchat.custom.common.intecepter.HttpTraceIdFilter.doFilter(HttpTraceIdFilter.java:<span class="number">25</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:<span class="number">100</span>)</span><br><span class="line">	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">117</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:<span class="number">93</span>)</span><br><span class="line">	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">117</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at org.springframework.boot.actuate.metrics.web.servlet.WebMvcMetricsFilter.doFilterInternal(WebMvcMetricsFilter.java:<span class="number">96</span>)</span><br><span class="line">	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">117</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:<span class="number">201</span>)</span><br><span class="line">	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">117</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:<span class="number">197</span>)</span><br><span class="line">	at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:<span class="number">97</span>)</span><br><span class="line">	at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:<span class="number">541</span>)</span><br><span class="line">	at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:<span class="number">135</span>)</span><br><span class="line">	at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:<span class="number">92</span>)</span><br><span class="line">	at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:<span class="number">78</span>)</span><br><span class="line">	at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:<span class="number">360</span>)</span><br><span class="line">	at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:<span class="number">399</span>)</span><br><span class="line">	at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:<span class="number">65</span>)</span><br><span class="line">	at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:<span class="number">890</span>)</span><br><span class="line">	at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:<span class="number">1743</span>)</span><br><span class="line">	at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:<span class="number">49</span>)</span><br><span class="line">	at org.apache.tomcat.util.threads.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1191</span>)</span><br><span class="line">	at org.apache.tomcat.util.threads.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">659</span>)</span><br><span class="line">	at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:<span class="number">61</span>)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:<span class="number">748</span>)</span><br><span class="line">Caused by: io.minio.errors.ErrorResponseException: The specified bucket does not exist</span><br><span class="line">	at io.minio.S3Base$<span class="number">1.</span>onResponse(S3Base.java:<span class="number">690</span>)</span><br><span class="line">	at okhttp3.internal.connection.RealCall$AsyncCall.run(RealCall.kt:<span class="number">519</span>)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1149</span>)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">624</span>)</span><br><span class="line">	... <span class="number">1</span> common frames omitted</span><br></pre></td></tr></table></div></figure>


        <h2 id="未知异常"   >
          <a href="#未知异常" class="heading-link"><i class="fas fa-link"></i></a><a href="#未知异常" class="headerlink" title="未知异常"></a>未知异常</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">|ERROR|<span class="number">2023</span>-<span class="number">07</span>-<span class="number">31</span> <span class="number">10</span>:09:<span class="number">45.932</span>|http-nio-<span class="number">8080</span>-exec-<span class="number">10</span>|fa45bbb3-e84d-<span class="number">422f</span>-<span class="number">9053</span>-df13233dae8e|uid=<span class="number">10003</span>|system exception！The reason is：<span class="literal">null</span>|</span><br><span class="line">java.lang.reflect.UndeclaredThrowableException: <span class="literal">null</span></span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:<span class="number">780</span>)</span><br><span class="line">	at org.springframework.aop.aspectj.MethodInvocationProceedingJoinPoint.proceed(MethodInvocationProceedingJoinPoint.java:<span class="number">89</span>)</span><br><span class="line">	at com.abin.mallchat.custom.common.intecepter.WebLogAspect.around(WebLogAspect.java:<span class="number">63</span>)</span><br><span class="line">	at sun.reflect.GeneratedMethodAccessor226.invoke(Unknown Source)</span><br><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:<span class="number">43</span>)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:<span class="number">498</span>)</span><br><span class="line">	at org.springframework.aop.aspectj.AbstractAspectJAdvice.invokeAdviceMethodWithGivenArgs(AbstractAspectJAdvice.java:<span class="number">634</span>)</span><br><span class="line">	at org.springframework.aop.aspectj.AbstractAspectJAdvice.invokeAdviceMethod(AbstractAspectJAdvice.java:<span class="number">624</span>)</span><br><span class="line">	at org.springframework.aop.aspectj.AspectJAroundAdvice.invoke(AspectJAroundAdvice.java:<span class="number">72</span>)</span><br><span class="line">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:<span class="number">186</span>)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:<span class="number">763</span>)</span><br><span class="line">	at org.springframework.aop.interceptor.ExposeInvocationInterceptor.invoke(ExposeInvocationInterceptor.java:<span class="number">97</span>)</span><br><span class="line">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:<span class="number">186</span>)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:<span class="number">763</span>)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:<span class="number">708</span>)</span><br><span class="line">	at com.abin.mallchat.custom.user.controller.OssController$$EnhancerBySpringCGLIB$$94c0c149.getUploadUrl(&lt;generated&gt;)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:<span class="number">62</span>)</span><br><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:<span class="number">43</span>)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:<span class="number">498</span>)</span><br><span class="line">	at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:<span class="number">205</span>)</span><br><span class="line">	at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:<span class="number">150</span>)</span><br><span class="line">	at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:<span class="number">117</span>)</span><br><span class="line">	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:<span class="number">895</span>)</span><br><span class="line">	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:<span class="number">808</span>)</span><br><span class="line">	at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:<span class="number">87</span>)</span><br><span class="line">	at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:<span class="number">1067</span>)</span><br><span class="line">	at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:<span class="number">963</span>)</span><br><span class="line">	at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:<span class="number">1006</span>)</span><br><span class="line">	at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:<span class="number">898</span>)</span><br><span class="line">	at javax.servlet.http.HttpServlet.service(HttpServlet.java:<span class="number">655</span>)</span><br><span class="line">	at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:<span class="number">883</span>)</span><br><span class="line">	at javax.servlet.http.HttpServlet.service(HttpServlet.java:<span class="number">764</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">227</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:<span class="number">53</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at com.abin.mallchat.custom.common.intecepter.HttpTraceIdFilter.doFilter(HttpTraceIdFilter.java:<span class="number">25</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:<span class="number">100</span>)</span><br><span class="line">	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">117</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:<span class="number">93</span>)</span><br><span class="line">	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">117</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at org.springframework.boot.actuate.metrics.web.servlet.WebMvcMetricsFilter.doFilterInternal(WebMvcMetricsFilter.java:<span class="number">96</span>)</span><br><span class="line">	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">117</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:<span class="number">201</span>)</span><br><span class="line">	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">117</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:<span class="number">197</span>)</span><br><span class="line">	at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:<span class="number">97</span>)</span><br><span class="line">	at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:<span class="number">541</span>)</span><br><span class="line">	at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:<span class="number">135</span>)</span><br><span class="line">	at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:<span class="number">92</span>)</span><br><span class="line">	at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:<span class="number">78</span>)</span><br><span class="line">	at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:<span class="number">360</span>)</span><br><span class="line">	at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:<span class="number">399</span>)</span><br><span class="line">	at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:<span class="number">65</span>)</span><br><span class="line">	at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:<span class="number">890</span>)</span><br><span class="line">	at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:<span class="number">1743</span>)</span><br><span class="line">	at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:<span class="number">49</span>)</span><br><span class="line">	at org.apache.tomcat.util.threads.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1191</span>)</span><br><span class="line">	at org.apache.tomcat.util.threads.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">659</span>)</span><br><span class="line">	at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:<span class="number">61</span>)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:<span class="number">748</span>)</span><br><span class="line">Caused by: java.net.ConnectException: Failed to connect to /<span class="number">192.168</span><span class="number">.88</span><span class="number">.127</span>:<span class="number">9000</span></span><br><span class="line">	at okhttp3.internal.connection.RealConnection.connectSocket(RealConnection.kt:<span class="number">297</span>)</span><br><span class="line">	at okhttp3.internal.connection.RealConnection.connect(RealConnection.kt:<span class="number">207</span>)</span><br><span class="line">	at okhttp3.internal.connection.ExchangeFinder.findConnection(ExchangeFinder.kt:<span class="number">226</span>)</span><br><span class="line">	at okhttp3.internal.connection.ExchangeFinder.findHealthyConnection(ExchangeFinder.kt:<span class="number">106</span>)</span><br><span class="line">	at okhttp3.internal.connection.ExchangeFinder.find(ExchangeFinder.kt:<span class="number">74</span>)</span><br><span class="line">	at okhttp3.internal.connection.RealCall.initExchange$okhttp(RealCall.kt:<span class="number">255</span>)</span><br><span class="line">	at okhttp3.internal.connection.ConnectInterceptor.intercept(ConnectInterceptor.kt:<span class="number">32</span>)</span><br><span class="line">	at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.kt:<span class="number">109</span>)</span><br><span class="line">	at okhttp3.internal.cache.CacheInterceptor.intercept(CacheInterceptor.kt:<span class="number">95</span>)</span><br><span class="line">	at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.kt:<span class="number">109</span>)</span><br><span class="line">	at okhttp3.internal.http.BridgeInterceptor.intercept(BridgeInterceptor.kt:<span class="number">83</span>)</span><br><span class="line">	at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.kt:<span class="number">109</span>)</span><br><span class="line">	at okhttp3.internal.http.RetryAndFollowUpInterceptor.intercept(RetryAndFollowUpInterceptor.kt:<span class="number">76</span>)</span><br><span class="line">	at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.kt:<span class="number">109</span>)</span><br><span class="line">	at okhttp3.internal.connection.RealCall.getResponseWithInterceptorChain$okhttp(RealCall.kt:<span class="number">201</span>)</span><br><span class="line">	at okhttp3.internal.connection.RealCall$AsyncCall.run(RealCall.kt:<span class="number">517</span>)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1149</span>)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">624</span>)</span><br><span class="line">	... <span class="number">1</span> common frames omitted</span><br><span class="line">Caused by: java.net.ConnectException: Connection refused: connect</span><br><span class="line">	at java.net.DualStackPlainSocketImpl.waitForConnect(Native Method)</span><br><span class="line">	at java.net.DualStackPlainSocketImpl.socketConnect(DualStackPlainSocketImpl.java:<span class="number">81</span>)</span><br><span class="line">	at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:<span class="number">476</span>)</span><br><span class="line">	at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:<span class="number">218</span>)</span><br><span class="line">	at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:<span class="number">200</span>)</span><br><span class="line">	at java.net.PlainSocketImpl.connect(PlainSocketImpl.java:<span class="number">162</span>)</span><br><span class="line">	at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:<span class="number">394</span>)</span><br><span class="line">	at java.net.Socket.connect(Socket.java:<span class="number">606</span>)</span><br><span class="line">	at okhttp3.internal.platform.Platform.connectSocket(Platform.kt:<span class="number">120</span>)</span><br><span class="line">	at okhttp3.internal.connection.RealConnection.connectSocket(RealConnection.kt:<span class="number">295</span>)</span><br><span class="line">	... <span class="number">18</span> common frames omitted</span><br></pre></td></tr></table></div></figure>

</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ 本文结束，感谢您的阅读 ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">本文作者: </span><span class="copyright-author__value"><a href="https://username.github.io">KkkerAn</a></span></div><div class="copyright-link"><span class="copyright-link__name">本文链接: </span><span class="copyright-link__value"><a href="https://username.github.io/2023/07/30/MallChat%E9%A1%B9%E7%9B%AE%E5%88%86%E6%9E%90/">https://username.github.io/2023/07/30/MallChat%E9%A1%B9%E7%9B%AE%E5%88%86%E6%9E%90/</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">版权声明: </span><span class="copyright-notice__value">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> 许可协议。转载请注明出处！</span></div></div><div class="post-tags"><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="https://username.github.io/tags/java/">java</a></span><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="https://username.github.io/tags/MallChat/">MallChat</a></span></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/2023/08/01/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-JUC%E7%AF%87%5B1-JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80%5D/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">深入剖析并发编程-JUC篇[1-JUC并发编程基础]</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/2023/07/27/SpringCloud%E9%9D%A2%E8%AF%95%E9%A2%98/"><span class="paginator-prev__text">SpringCloud面试题</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">文章目录</span><span class="sidebar-nav-ov">站点概览</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%88%E8%B7%91%E9%80%9A%E9%A1%B9%E7%9B%AE"><span class="toc-number">1.</span> <span class="toc-text">
          先跑通项目</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%9D%E8%AF%95%E8%BF%90%E8%A1%8C"><span class="toc-number">1.1.</span> <span class="toc-text">
          尝试运行</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF"><span class="toc-number">1.1.1.</span> <span class="toc-text">
          后端:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF"><span class="toc-number">1.1.2.</span> <span class="toc-text">
          前端:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%9D%E8%AF%95%E8%BF%9B%E5%85%A5Swagger"><span class="toc-number">1.2.</span> <span class="toc-text">
          尝试进入Swagger</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AB%AF%E5%8F%A3%E5%8F%B7%E5%88%86%E6%9E%90"><span class="toc-number">1.3.</span> <span class="toc-text">
          端口号分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E5%85%A5%E5%89%8D%E7%AB%AF%E7%95%8C%E9%9D%A2%E5%B0%9D%E8%AF%95%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83"><span class="toc-number">1.4.</span> <span class="toc-text">
          进入前端界面尝试前后端联调</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%B3%E8%AF%B7%E6%B5%8B%E8%AF%95%E5%8F%B7%EF%BC%8C%E6%9D%A5%E8%BF%9B%E8%A1%8C%E8%8E%B7%E5%8F%96%E5%BE%AE%E4%BF%A1%E4%BF%A1%E6%81%AF"><span class="toc-number">1.5.</span> <span class="toc-text">
          申请测试号，来进行获取微信信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E6%B5%8B%E8%AF%95%E5%8F%B7%E8%8E%B7%E5%8F%96%E5%88%B0%E7%99%BB%E5%BD%95%E4%BF%A1%E6%81%AF%E4%B9%8B%E5%90%8E%E8%BF%9B%E5%85%A5%E5%89%8D%E7%AB%AF%E9%A1%B5%E9%9D%A2%E8%BF%9B%E8%A1%8C%E6%B5%8B%E8%AF%95"><span class="toc-number">1.6.</span> <span class="toc-text">
          通过测试号获取到登录信息之后进入前端页面进行测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97"><span class="toc-number">1.7.</span> <span class="toc-text">
          用户模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%BE%97%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="toc-number">1.7.1.</span> <span class="toc-text">
          获得用户信息</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Controller%E5%B1%82"><span class="toc-number">1.7.1.1.</span> <span class="toc-text">
          Controller层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#UserService%E5%B1%82"><span class="toc-number">1.7.1.2.</span> <span class="toc-text">
          UserService层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#getUserInfo"><span class="toc-number">1.7.1.3.</span> <span class="toc-text">
          getUserInfo</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#getInfoBatch"><span class="toc-number">1.7.1.4.</span> <span class="toc-text">
          getInfoBatch</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#UserBackPackDao"><span class="toc-number">1.7.1.5.</span> <span class="toc-text">
          UserBackPackDao</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B"><span class="toc-number">1.7.1.6.</span> <span class="toc-text">
          流程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E7%94%A8%E6%88%B7%E5%90%8D"><span class="toc-number">1.7.2.</span> <span class="toc-text">
          修改用户名</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Controller%E5%B1%82-1"><span class="toc-number">1.7.2.1.</span> <span class="toc-text">
          Controller层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#UserService%E5%B1%82-1"><span class="toc-number">1.7.2.2.</span> <span class="toc-text">
          UserService层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#getFirstValidItem"><span class="toc-number">1.7.2.3.</span> <span class="toc-text">
          getFirstValidItem</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#invaldItem"><span class="toc-number">1.7.2.4.</span> <span class="toc-text">
          invaldItem</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ModifyName"><span class="toc-number">1.7.2.5.</span> <span class="toc-text">
          ModifyName</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#userInfoChange"><span class="toc-number">1.7.2.6.</span> <span class="toc-text">
          userInfoChange</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B-1"><span class="toc-number">1.7.2.7.</span> <span class="toc-text">
          流程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AF%E9%80%89%E5%8B%8B%E7%AB%A0%E9%A2%84%E8%A7%88"><span class="toc-number">1.7.3.</span> <span class="toc-text">
          可选勋章预览</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Controller%E5%B1%82-2"><span class="toc-number">1.7.3.1.</span> <span class="toc-text">
          Controller层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Service%E5%B1%82"><span class="toc-number">1.7.3.2.</span> <span class="toc-text">
          Service层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#getByType"><span class="toc-number">1.7.3.3.</span> <span class="toc-text">
          getByType</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#getByItemId"><span class="toc-number">1.7.3.4.</span> <span class="toc-text">
          getByItemId</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#userDao-getById"><span class="toc-number">1.7.3.5.</span> <span class="toc-text">
          userDao.getById</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#buildBadgeResp"><span class="toc-number">1.7.3.6.</span> <span class="toc-text">
          buildBadgeResp</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B-2"><span class="toc-number">1.7.3.7.</span> <span class="toc-text">
          流程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%A9%E6%88%B4%E5%8B%8B%E7%AB%A0"><span class="toc-number">1.7.4.</span> <span class="toc-text">
          佩戴勋章</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Controller%E5%B1%82-3"><span class="toc-number">1.7.4.1.</span> <span class="toc-text">
          Controller层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Service%E5%B1%82-1"><span class="toc-number">1.7.4.2.</span> <span class="toc-text">
          Service层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#getFirstValidItem-1"><span class="toc-number">1.7.4.3.</span> <span class="toc-text">
          getFirstValidItem</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#itemConfigDao-getById"><span class="toc-number">1.7.4.4.</span> <span class="toc-text">
          itemConfigDao.getById</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#wearingBadge"><span class="toc-number">1.7.4.5.</span> <span class="toc-text">
          wearingBadge</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#userInfoChange-1"><span class="toc-number">1.7.4.6.</span> <span class="toc-text">
          userInfoChange</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B-3"><span class="toc-number">1.7.4.7.</span> <span class="toc-text">
          流程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%BB%91%E5%90%8D%E5%8D%95"><span class="toc-number">1.7.5.</span> <span class="toc-text">
          黑名单</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Controller%E5%B1%82-4"><span class="toc-number">1.7.5.1.</span> <span class="toc-text">
          Controller层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Service%E5%B1%82-2"><span class="toc-number">1.7.5.2.</span> <span class="toc-text">
          Service层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#blackIp"><span class="toc-number">1.7.5.3.</span> <span class="toc-text">
          blackIp</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#hasPower"><span class="toc-number">1.7.5.4.</span> <span class="toc-text">
          hasPower</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#getRoleSet"><span class="toc-number">1.7.5.5.</span> <span class="toc-text">
          getRoleSet</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#listByUid"><span class="toc-number">1.7.5.6.</span> <span class="toc-text">
          listByUid</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B-4"><span class="toc-number">1.7.5.7.</span> <span class="toc-text">
          流程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%BD%E7%AB%A0%E8%81%9A%E5%90%88%E4%BF%A1%E6%81%AF"><span class="toc-number">1.7.6.</span> <span class="toc-text">
          徽章聚合信息</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Controller%E5%B1%82-5"><span class="toc-number">1.7.6.1.</span> <span class="toc-text">
          Controller层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Service%E5%B1%82-3"><span class="toc-number">1.7.6.2.</span> <span class="toc-text">
          Service层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#getById"><span class="toc-number">1.7.6.3.</span> <span class="toc-text">
          getById</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#skip"><span class="toc-number">1.7.6.4.</span> <span class="toc-text">
          skip</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E8%81%9A%E5%90%88%E4%BF%A1%E6%81%AF"><span class="toc-number">1.7.7.</span> <span class="toc-text">
          用户聚合信息</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Controller%E5%B1%82-6"><span class="toc-number">1.7.7.1.</span> <span class="toc-text">
          Controller层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Service%E5%B1%82-4"><span class="toc-number">1.7.7.2.</span> <span class="toc-text">
          Service层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#skip-1"><span class="toc-number">1.7.7.3.</span> <span class="toc-text">
          skip</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E8%A7%88"><span class="toc-number">1.7.8.</span> <span class="toc-text">
          总览</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#UserController"><span class="toc-number">1.7.8.1.</span> <span class="toc-text">
          UserController</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#UserService"><span class="toc-number">1.7.8.2.</span> <span class="toc-text">
          UserService</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#UserServiceImpl"><span class="toc-number">1.7.8.3.</span> <span class="toc-text">
          UserServiceImpl</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E4%B8%AD%E7%9A%84%E5%8A%9F%E8%83%BD"><span class="toc-number">1.7.8.4.</span> <span class="toc-text">
          用户模块中的功能</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97-1"><span class="toc-number">1.7.8.4.1.</span> <span class="toc-text">
          用户模块</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%BB%91%E5%90%8D%E5%8D%95%E6%A8%A1%E5%9D%97"><span class="toc-number">1.7.8.4.2.</span> <span class="toc-text">
          黑名单模块</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BE%BD%E7%AB%A0%E5%8F%91%E6%94%BE%E6%A8%A1%E5%9D%97"><span class="toc-number">1.7.8.4.3.</span> <span class="toc-text">
          徽章发放模块</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%AE%E4%BF%A1%E6%89%AB%E7%A0%81%E7%99%BB%E5%BD%95"><span class="toc-number">1.8.</span> <span class="toc-text">
          微信扫码登录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#WxPortalController%E5%B1%82"><span class="toc-number">1.8.1.</span> <span class="toc-text">
          WxPortalController层</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#post"><span class="toc-number">1.8.1.1.</span> <span class="toc-text">
          post</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#authGet"><span class="toc-number">1.8.1.2.</span> <span class="toc-text">
          authGet</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#callBack"><span class="toc-number">1.8.1.3.</span> <span class="toc-text">
          callBack</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WxMsgService"><span class="toc-number">1.8.2.</span> <span class="toc-text">
          WxMsgService</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B-5"><span class="toc-number">1.8.3.</span> <span class="toc-text">
          流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E5%92%8C%E5%90%8E%E7%AB%AF%E5%BB%BA%E7%AB%8B%E4%B8%80%E4%B8%AAWebSocket%E8%BF%9E%E6%8E%A5"><span class="toc-number">1.8.3.1.</span> <span class="toc-text">
          前端和后端建立一个WebSocket连接</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E8%AF%B7%E6%B1%82%E6%89%AB%E7%A0%81%E7%99%BB%E5%BD%95"><span class="toc-number">1.8.3.2.</span> <span class="toc-text">
          前端请求扫码登录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E6%89%AB%E7%A0%81%E7%99%BB%E5%BD%95"><span class="toc-number">1.8.3.3.</span> <span class="toc-text">
          用户扫码登录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C"><span class="toc-number">1.8.3.4.</span> <span class="toc-text">
          用户注册</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%88%E6%9D%83%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="toc-number">1.8.3.5.</span> <span class="toc-text">
          授权用户信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF%E4%B8%BB%E5%8A%A8%E6%B6%88%E6%81%AF%E6%8E%A8%E9%80%81"><span class="toc-number">1.8.3.6.</span> <span class="toc-text">
          后端主动消息推送</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E8%A7%88-1"><span class="toc-number">1.8.4.</span> <span class="toc-text">
          总览</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A8%E6%83%85%E5%8C%85%E6%A8%A1%E5%9D%97"><span class="toc-number">1.9.</span> <span class="toc-text">
          表情包模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A8%E6%83%85%E5%8C%85%E5%88%97%E8%A1%A8"><span class="toc-number">1.9.1.</span> <span class="toc-text">
          表情包列表</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Controller%E5%B1%82-7"><span class="toc-number">1.9.1.1.</span> <span class="toc-text">
          Controller层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Service%E5%B1%82-5"><span class="toc-number">1.9.1.2.</span> <span class="toc-text">
          Service层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#listByUid-1"><span class="toc-number">1.9.1.3.</span> <span class="toc-text">
          listByUid</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B-6"><span class="toc-number">1.9.1.4.</span> <span class="toc-text">
          流程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E8%A1%A8%E6%83%85"><span class="toc-number">1.9.2.</span> <span class="toc-text">
          添加表情</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Controller%E5%B1%82-8"><span class="toc-number">1.9.2.1.</span> <span class="toc-text">
          Controller层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Service%E5%B1%82-6"><span class="toc-number">1.9.2.2.</span> <span class="toc-text">
          Service层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B-7"><span class="toc-number">1.9.2.3.</span> <span class="toc-text">
          流程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E8%A1%A8%E6%83%85"><span class="toc-number">1.9.3.</span> <span class="toc-text">
          删除表情</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Controller%E5%B1%82-9"><span class="toc-number">1.9.3.1.</span> <span class="toc-text">
          Controller层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Service%E5%B1%82-7"><span class="toc-number">1.9.3.2.</span> <span class="toc-text">
          Service层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B-8"><span class="toc-number">1.9.3.3.</span> <span class="toc-text">
          流程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6%E6%A8%A1%E5%9D%97"><span class="toc-number">1.10.</span> <span class="toc-text">
          上传文件模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Controller%E5%B1%82-10"><span class="toc-number">1.10.1.</span> <span class="toc-text">
          Controller层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Service%E5%B1%82-8"><span class="toc-number">1.10.2.</span> <span class="toc-text">
          Service层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#getPreSignedObjectUrl"><span class="toc-number">1.10.3.</span> <span class="toc-text">
          getPreSignedObjectUrl</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%81%8A%E5%A4%A9%E5%AE%A4%E6%A8%A1%E5%9D%97"><span class="toc-number">1.11.</span> <span class="toc-text">
          聊天室模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%9A%E8%AF%9D%E5%88%97%E8%A1%A8"><span class="toc-number">1.11.1.</span> <span class="toc-text">
          会话列表</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Controller%E5%B1%82-11"><span class="toc-number">1.11.1.1.</span> <span class="toc-text">
          Controller层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Service%E5%B1%82-9"><span class="toc-number">1.11.1.2.</span> <span class="toc-text">
          Service层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#getCursorPage"><span class="toc-number">1.11.1.3.</span> <span class="toc-text">
          getCursorPage</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#getCursorPageByMysql"><span class="toc-number">1.11.1.4.</span> <span class="toc-text">
          getCursorPageByMysql</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#init"><span class="toc-number">1.11.1.5.</span> <span class="toc-text">
          init</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B-9"><span class="toc-number">1.11.1.6.</span> <span class="toc-text">
          流程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BE%A4%E6%88%90%E5%91%98%E6%A8%A1%E5%9D%97"><span class="toc-number">1.11.2.</span> <span class="toc-text">
          群成员模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BE%A4%E6%88%90%E5%91%98-%E5%9C%A8%E7%BA%BF%E4%BA%BA%E6%95%B0%E7%BB%9F%E8%AE%A1"><span class="toc-number">1.11.2.1.</span> <span class="toc-text">
          群成员+在线人数统计</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Controller%E5%B1%82-12"><span class="toc-number">1.11.2.1.1.</span> <span class="toc-text">
          Controller层</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Service%E5%B1%82-10"><span class="toc-number">1.11.2.1.2.</span> <span class="toc-text">
          Service层</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#getOnlineNum"><span class="toc-number">1.11.2.1.3.</span> <span class="toc-text">
          getOnlineNum</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#zCard"><span class="toc-number">1.11.2.1.4.</span> <span class="toc-text">
          zCard</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B-10"><span class="toc-number">1.11.2.1.5.</span> <span class="toc-text">
          流程</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8A%E7%BA%BF%E4%B8%8B%E7%BA%BF%E6%8E%A8%E9%80%81"><span class="toc-number">1.11.2.2.</span> <span class="toc-text">
          上线下线推送</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%BB%E5%8A%A8%E6%9B%B4%E6%96%B0%E6%88%90%E5%91%98%E5%88%97%E8%A1%A8"><span class="toc-number">1.11.2.2.1.</span> <span class="toc-text">
          主动更新成员列表</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%8E%E5%8F%B0%E6%8E%A8%E9%80%81"><span class="toc-number">1.11.2.2.2.</span> <span class="toc-text">
          后台推送</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E4%B8%8A%E7%BA%BF"><span class="toc-number">1.11.2.2.2.1.</span> <span class="toc-text">
          用户上线</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E4%B8%8B%E7%BA%BF"><span class="toc-number">1.11.2.2.2.2.</span> <span class="toc-text">
          用户下线</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B-11"><span class="toc-number">1.11.2.2.3.</span> <span class="toc-text">
          流程</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BE%A4%E6%88%90%E5%91%98Zset%E6%B8%B8%E6%A0%87%E7%BF%BB%E9%A1%B5"><span class="toc-number">1.11.2.3.</span> <span class="toc-text">
          群成员Zset游标翻页</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BE%A4%E6%88%90%E5%91%98%E5%88%97%E8%A1%A8%E7%9A%84%E7%BF%BB%E9%A1%B5"><span class="toc-number">1.11.2.3.1.</span> <span class="toc-text">
          群成员列表的翻页</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#Controller%E5%B1%82-13"><span class="toc-number">1.11.2.3.1.1.</span> <span class="toc-text">
          Controller层</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Service%E5%B1%82-11"><span class="toc-number">1.11.2.3.1.2.</span> <span class="toc-text">
          Service层</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#getCurOrPageByRedis"><span class="toc-number">1.11.2.3.1.3.</span> <span class="toc-text">
          getCurOrPageByRedis</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B-12"><span class="toc-number">1.11.2.3.1.4.</span> <span class="toc-text">
          流程</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9A%84%E7%BE%A4%E6%88%90%E5%91%98%E5%88%97%E8%A1%A8"><span class="toc-number">1.11.2.3.2.</span> <span class="toc-text">
          @的群成员列表</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#Controller%E5%B1%82-14"><span class="toc-number">1.11.2.3.2.1.</span> <span class="toc-text">
          Controller层</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Service%E5%B1%82-12"><span class="toc-number">1.11.2.3.2.2.</span> <span class="toc-text">
          Service层</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#getMemberList"><span class="toc-number">1.11.2.3.2.3.</span> <span class="toc-text">
          getMemberList</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B-13"><span class="toc-number">1.11.2.3.2.4.</span> <span class="toc-text">
          流程</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E6%A8%A1%E5%9D%97"><span class="toc-number">1.11.3.</span> <span class="toc-text">
          消息模块</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E6%83%85%E5%86%B5"><span class="toc-number">2.</span> <span class="toc-text">
          异常情况</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E5%9C%A8%E7%BA%BF%E7%94%A8%E6%88%B7%E6%95%B0%E9%87%8F%EF%BC%8C%E7%94%A8%E6%88%B7%E5%B7%B2%E7%BB%8F%E4%B8%8B%E7%BA%BF%E8%80%8C%E6%98%BE%E7%A4%BA%E8%BF%98%E5%9C%A8%E7%BA%BF%E4%B8%8A%E4%B8%AD"><span class="toc-number">2.1.</span> <span class="toc-text">
          异常在线用户数量，用户已经下线而显示还在线上中</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E7%AB%AF1"><span class="toc-number">2.1.1.</span> <span class="toc-text">
          用户端1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E7%AB%AF2"><span class="toc-number">2.1.2.</span> <span class="toc-text">
          用户端2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%80%E5%87%BA%E7%94%A8%E6%88%B7%E7%AB%AF2"><span class="toc-number">2.1.3.</span> <span class="toc-text">
          退出用户端2</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%9B%E5%87%BAInvalidDataAccessApiUsageException%E5%BC%82%E5%B8%B8"><span class="toc-number">2.2.</span> <span class="toc-text">
          抛出InvalidDataAccessApiUsageException异常</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E7%9A%84SQL%E8%AF%AD%E5%8F%A5"><span class="toc-number">2.2.1.</span> <span class="toc-text">
          执行的SQL语句</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E5%A4%8D%E7%8E%B0"><span class="toc-number">2.2.2.</span> <span class="toc-text">
          异常复现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E5%8E%9F%E5%9B%A0"><span class="toc-number">2.2.3.</span> <span class="toc-text">
          分析原因</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%84%E7%90%86"><span class="toc-number">2.2.4.</span> <span class="toc-text">
          处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A9%BA%E6%8C%87%E9%92%88%E5%BC%82%E5%B8%B8"><span class="toc-number">2.3.</span> <span class="toc-text">
          空指针异常</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AA%E7%9F%A5%E5%BC%82%E5%B8%B8"><span class="toc-number">2.4.</span> <span class="toc-text">
          未知异常</span></a></li></ol></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/E7977EEC2FEF2A2B9146704271490ED2.png" alt="avatar"></div><p class="sidebar-ov-author__text">步子小也好，走得慢也好，是在往前走就好</p></div><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="/" target="_blank" rel="noopener" data-popover="social.389081641" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-qq"></i></span></a><a class="sidebar-ov-social-item" href="https://github.com/Kkker1" target="_blank" rel="noopener" data-popover="Github" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-github"></i></span></a><a class="sidebar-ov-social-item" href="/" target="_blank" rel="noopener" data-popover="social.KKKer1An@163.com" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="far fa-envelope"></i></span></a></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">33</div><div class="sidebar-ov-state-item__name">归档</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">11</div><div class="sidebar-ov-state-item__name">分类</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">16</div><div class="sidebar-ov-state-item__name">标签</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="知识共享许可协议" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">你已阅读了 </span><span class="sidebar-reading-info__num">0</span><span class="sidebar-reading-info__perc">%</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2023</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>KkkerAn</span></div><div><span>由 <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> 强力驱动</span><span> v6.3.0</span><span class="footer__devider">|</span><span>主题 - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.8.0</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="搜索文章（支持多关键词，请用空格分隔）"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lazyload@2.0.0-rc.2/lazyload.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.xml';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // 将 XML 转为 JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // 搜索对象（标题、内容）的权重，影响显示顺序
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // 根据空白字符分隔关键字
        var keywords = searchText.split(/[\s]+/);
        // 搜索结果
        var matchPosts = [];

        // 有多个关键字时，将原文字整个保存下来
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // 防止未输入字符时搜索
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // 没有标题的文章使用预设的 i18n 变量代替
            var title = (data.title && data.title.trim()) || '[ 文章无标题 ]';
            var titleLower = title && title.toLowerCase();
            // 删除 HTML 标签 和 所有空白字符
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // 删除重复的 /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // 标题中匹配到的关键词
            var titleHitSlice = [];
            // 内容中匹配到的关键词
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * 获取匹配的关键词的索引
              * @param {String} keyword 要匹配的关键字
              * @param {String} text 原文字
              * @param {Boolean} caseSensitive 是否区分大小写
              * @param {Number} weight 匹配对象的权重。权重大的优先显示
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // 每次匹配的开始索引
                var index = -1;     // 匹配到的索引值
                var result = [];    // 匹配结果

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // 索引位置相同的关键词，保留长度较长的
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // 按照匹配文字的索引的递增顺序排序
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * 给文本中匹配到的关键词添加标记，从而进行高亮显示
              * @param {String} text 原文本
              * @param {Array} hitSlice 匹配项的索引信息
              * @param {Number} start 开始索引
              * @param {Number} end 结束索引
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // 文章总的搜索权重
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // 标记匹配关键词后的标题
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // 标记匹配关键词后的内容
              var postContent;
              // 显示内容的长度
              var SHOW_WORD_LENGTH = 200;
              // 命中关键词前的字符显示长度
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // 截取匹配的第一个字符，前后共 200 个字符来显示
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // 未匹配到内容，直接截取前 200 个字符来显示
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // 按权重递增的顺序排序，使权重大的优先显示
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);

function safeOpenUrl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}

function extSearch(engine) {
  var engines = {
    google: 'https://www.google.com/search?q=',
    bing: 'https://cn.bing.com/search?q=',
    baidu: 'https://www.baidu.com/s?ie=UTF-8&wd=',
  };
  var host = window.location.host;
  var query = $('.search-input input').val().toLowerCase().trim();
  var uri = engines[engine] + query + ' site:' + host;

  if (query) {
    safeOpenUrl(uri);
  } else {
    Stun.utils.popAlert('warning', '请输入字符');
  }
}

var assistSearchList = window.CONFIG.assistSearch;

if (Array.isArray(assistSearchList)) {
  assistSearchList.forEach(function (name) {
    document.querySelector('.search-btns-item--' + name).addEventListener('click', function () {
      extSearch(name);
    }, false);
  });
}</script><script src="/js/utils.js?v=2.8.0"></script><script src="/js/stun-boot.js?v=2.8.0"></script><script src="/js/scroll.js?v=2.8.0"></script><script src="/js/header.js?v=2.8.0"></script><script src="/js/sidebar.js?v=2.8.0"></script><script type="application/json" src="/search.xml"></script></body></html>