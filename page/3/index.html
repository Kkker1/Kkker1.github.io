<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/bonbon-16%C3%9716.png?v=2.8.0" type="image/png" sizes="16x16"><link rel="icon" href="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/bonbon-32%C3%9732.png?v=2.8.0" type="image/png" sizes="32x32"><meta property="og:type" content="website">
<meta property="og:title" content="KkkerAn&#39;s Blog">
<meta property="og:url" content="https://username.github.io/page/3/index.html">
<meta property="og:site_name" content="KkkerAn&#39;s Blog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="KkkerAn">
<meta name="twitter:card" content="summary"><title>KkkerAn's Blog</title><link ref="canonical" href="https://username.github.io/page/3/index.html"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.8.0"><link rel="stylesheet" href="css/custom.css"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":false},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: true,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"复制","copySuccess":"复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 6.3.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">归档</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">分类</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">标签</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">搜索</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">WelCome to My Blog</div><div class="header-banner-info__subtitle">回忆像一块彩色橡皮糖,被拉长了,颜色淡了,但还是甜</div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content content-home" id="content"><section class="postlist"><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/08/01/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-JUC%E7%AF%87%5B1-JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80%5D/">深入剖析并发编程-JUC篇[1-JUC并发编程基础]</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-08-01</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">2.4k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">13分</span></span></div></header><div class="post-body"><div class="post-excerpt"><p><strong>JUC并发编程基础</strong></p>
<hr>
<ul>
<li>第一篇是JUC并发编程基础</li>
<li>第二篇是JMM、Volatile关键字、synchronize锁详解</li>
<li>第三篇是CAS机制原理、Unsafe魔法类、LockSupport工具类、ThreadLocal线程变量</li>
<li>第四篇是Atomic原子包源码详解</li>
<li>第五篇是AQS源码以及机制详解、ReentrantLock可重入锁、ReentrantReadWriteLock读写锁、JUC并发工具包</li>
<li>第六篇是并发容器</li>
<li>第七篇是进程、线程、线程池</li>
</ul>
<hr>

        <h1 id="冯诺依曼体系结构"   >
          <a href="#冯诺依曼体系结构" class="heading-link"><i class="fas fa-link"></i></a><a href="#冯诺依曼体系结构" class="headerlink" title="冯诺依曼体系结构"></a>冯诺依曼体系结构</h1>
      <p>首先，我们要了解并发过程中为什么会导致数据会出错</p>
<p>冯·诺依曼机（von Neumann machine），又称冯·诺依曼计算机，根据<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%86%AF%C2%B7%E8%AF%BA%E4%BE%9D%E6%9B%BC/388909?fromModule=lemma_inlink" >冯·诺依曼</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>提出的<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%AD%98%E5%82%A8%E7%A8%8B%E5%BA%8F/8800242?fromModule=lemma_inlink" >存储程序</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%A6%82%E5%BF%B5%E8%AE%BE%E8%AE%A1/1200478?fromModule=lemma_inlink" >概念设计</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>的<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E8%AE%A1%E7%AE%97%E6%9C%BA/140338?fromModule=lemma_inlink" >计算机</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>。主要特征是：指令与<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%95%B0%E6%8D%AE%E9%83%BD/20348401?fromModule=lemma_inlink" >数据都</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>以<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E4%BA%8C%E8%BF%9B%E5%88%B6/361457?fromModule=lemma_inlink" >二进制</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>形式储存在<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%AD%98%E5%82%A8%E5%99%A8/1583185?fromModule=lemma_inlink" >存储器</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>里；指令根据其储存的<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E9%A1%BA%E5%BA%8F%E6%89%A7%E8%A1%8C/332454?fromModule=lemma_inlink" >顺序执行</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>。 <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.termonline.cn/word/54892/1#s1" >[1]</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%86%AF%C2%B7%E8%AF%BA%E4%BC%8A%E6%9B%BC%E7%BB%93%E6%9E%84/6688306?fromModule=lemma_inlink" >冯·诺伊曼结构</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>（von Neumann architecture），也称冯·诺伊曼模型（Von Neumann model）或普林斯顿结构（Princeton architecture），是一种将程序指令存储器和数据存储器合并在一起的计算机设计<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%A6%82%E5%BF%B5%E7%BB%93%E6%9E%84/22325298?fromModule=lemma_inlink" >概念结构</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>。依据冯·诺伊曼<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E7%BB%93%E6%9E%84%E8%AE%BE%E8%AE%A1/7481502?fromModule=lemma_inlink" >结构设计</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>出的计算机称做冯.诺依曼计算机，又称存储程序计算机。</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230801161725875.png"  alt="冯诺依曼计算机结构图">
      </p>

        <h1 id="CPU模型"   >
          <a href="#CPU模型" class="heading-link"><i class="fas fa-link"></i></a><a href="#CPU模型" class="headerlink" title="CPU模型"></a>CPU模型</h1>
      <p>我们已知线程是CPU任务调度和执行的基本单位，而线程之间通信出现问题导致了数据的不一致性</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230801163419744.png"  alt="CPU内存模型">
      </p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">因为数据在高速缓存中，而线程之间的环境是隔离的</span><br><span class="line">每次只会获取自己线程的Cache，那么数据的不可见性最终导致数据的错误</span><br></pre></td></tr></table></div></figure>


        <h1 id="缓存行"   >
          <a href="#缓存行" class="heading-link"><i class="fas fa-link"></i></a><a href="#缓存行" class="headerlink" title="缓存行"></a>缓存行</h1>
      <p>首先我们要引入一个缓存行的概念，数据在缓存中是怎么存放的</p>
<p>缓存行是数据中存放的单元，在现在主流CPU Cache中缓存行都是64位的，例如一个数据是int类型那么是32位 一个缓存行就能存放两个数据</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230801165444126.png"  alt="缓存行">
      </p>
<p>因此当线程想要获取数据A的时候会将A所在的缓存行刷入自己的Cache中，而当要获取数据B的时候直接从自己的缓存中读取即可，但这就引起了另外的一个问题：伪共享问题</p>

        <h1 id="伪共享"   >
          <a href="#伪共享" class="heading-link"><i class="fas fa-link"></i></a><a href="#伪共享" class="headerlink" title="伪共享"></a>伪共享</h1>
      <p>因此有一个伪共享问题的存在，例如两个Int数据存放在缓存行C1中，而线程T1想要读取数据A，而线程T2想要读取数据B，他们都会从内存将C1刷入自己的Cache中</p>
<p>而当线程T1更新数据A，而线程T2的数据A没有更新，且会因为缓存一致性协议(MESI协议)，将其置为失效状态(I)</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230801171236659.png"  alt="image-20230801171236659">
      </p>
<p><em>而解决伪共享的解决方案有：</em></p>
<p>1.将变量对齐，使其填满一个缓存行</p>
<p>2.将不同线程操作的对象处于不同缓存行中</p>

        <h1 id="缓存一致性协议"   >
          <a href="#缓存一致性协议" class="heading-link"><i class="fas fa-link"></i></a><a href="#缓存一致性协议" class="headerlink" title="缓存一致性协议"></a>缓存一致性协议</h1>
      <p>因为缓存的不一致导致数据出错，那么就有了缓存一致性的需求、</p>
<p>来达到缓存的一致性有两个方式</p>

        <h2 id="给总线加锁"   >
          <a href="#给总线加锁" class="heading-link"><i class="fas fa-link"></i></a><a href="#给总线加锁" class="headerlink" title="给总线加锁"></a>给总线加锁</h2>
      <p>当线程要获取数据的时候发起Lock将与主内存的总线加锁，这样其他线程要获取数据的时候就会被阻塞</p>
<p>这样当线程执行完毕之后写回给内存之后会UnLock解锁，唤醒其他线程</p>
<p>弊端：这样导致了线程的串行化，会造成性能影响。和我们多线程的意愿违背</p>

        <h2 id="缓存一致性协议-MESI协议"   >
          <a href="#缓存一致性协议-MESI协议" class="heading-link"><i class="fas fa-link"></i></a><a href="#缓存一致性协议-MESI协议" class="headerlink" title="缓存一致性协议(MESI协议)"></a>缓存一致性协议(MESI协议)</h2>
      <p>缓存一致性协议有很多，而我们这里只谈MESI协议</p>
<p><strong>MESI协议</strong></p>
<p>M:	修改(Modified) ， 意思是这个数据只在本线程独有，并且这个数据与主存的数据不一致，是修改过后的数据</p>
<p>E：  独享(Exclusive)， 意思是这个数据只有本线程独有，并且和主存的数据一致</p>
<p>S：  分享(Shared)，    意思是这个数据被多个线程持有，并且和主存的数据一致</p>
<p>I：   失效(invalid)，     意思是这个数据已经被其他线程修改而导致失效了，需要重新从主存中获取数据</p>
<p>Cache Line在高速缓存Cache中的状态就变成 高两位为信号位(用来存放MESI状态)，后面为数据位</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230801172256181.png"  alt="缓存行在Cache中">
      </p>

        <h2 id="消息"   >
          <a href="#消息" class="heading-link"><i class="fas fa-link"></i></a><a href="#消息" class="headerlink" title="消息"></a>消息</h2>
      <p>MESI状态变换要通过消息来进行变换，而每次CPU在进行数据操作的时候都会有一个嗅探机制来处理信号并且在一定条件下响应信号</p>
<ul>
<li><p>Read 信号：表示要读取某个缓存行，会附带目标的物理地址</p>
</li>
<li><p>Read Response信号：反馈Read信号，内容就是Read信号的目标缓存行。Read Response信号可以由内存发出，也可以由其他CPU核心发出</p>
</li>
<li><p>Invalidate信号： 表示数据要被更新，告诉共享的CPU核数据已经失效了</p>
</li>
<li><p>Invalidate Acknowledge信号：表示知道数据已经失效，准备清空缓存数据</p>
</li>
<li><p>Read Invalidate信号：为Read+Invalidate，既要读取数据又要更新数据，让其他缓存行数据失效</p>
</li>
<li><p>Writeback信号：数据回写信号，在某一定条件下数据从Cache写回内存中</p>
</li>
</ul>

        <h2 id="图解MESI的各种变幻状态"   >
          <a href="#图解MESI的各种变幻状态" class="heading-link"><i class="fas fa-link"></i></a><a href="#图解MESI的各种变幻状态" class="headerlink" title="图解MESI的各种变幻状态"></a>图解MESI的各种变幻状态</h2>
      <p>我们假设有两个线程来获取数据</p>

        <h3 id="①线程A获取数据"   >
          <a href="#①线程A获取数据" class="heading-link"><i class="fas fa-link"></i></a><a href="#①线程A获取数据" class="headerlink" title="①线程A获取数据"></a>①线程A获取数据</h3>
      <p>发起一个Read信号，想要读取内存中的数据放入到线程中Cache里</p>
<p>此时返回一个Read Response信号，此时Read Response信号来自内存，线程A中的缓存行状态为E态(独享)</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230801171827789.png"  alt="仅线程A获取数据">
      </p>

        <h3 id="②线程B获取数据"   >
          <a href="#②线程B获取数据" class="heading-link"><i class="fas fa-link"></i></a><a href="#②线程B获取数据" class="headerlink" title="②线程B获取数据"></a>②线程B获取数据</h3>
      <p>线程B也发起Read信号，返回一个Read Response信号,可能来自线程A中，将线程A中的缓存行状态改成S态(独享)</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230801171947078.png"  alt="线程B也获取同一个数据">
      </p>

        <h3 id="③线程A更新数据"   >
          <a href="#③线程A更新数据" class="heading-link"><i class="fas fa-link"></i></a><a href="#③线程A更新数据" class="headerlink" title="③线程A更新数据"></a>③线程A更新数据</h3>
      <p>发出Invalidate信号，将线程B中的数据更新成I态，此时线程A的缓存行状态为M态</p>
<p>线程B会返回一个Invalidate Acknowledge信号，表示自己已经知道数据失效了将要清空缓存</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230801173716877.png"  alt="线程A更新数据">
      </p>

        <h3 id="④数据写回内存"   >
          <a href="#④数据写回内存" class="heading-link"><i class="fas fa-link"></i></a><a href="#④数据写回内存" class="headerlink" title="④数据写回内存"></a>④数据写回内存</h3>
      <p>发起WriteBack信号，写回数据，并将现场A缓存中数据置为E态</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230801173940439.png"  alt="数据写回内存">
      </p>

        <h1 id="CPU空闲-–-引入Store-Buffer"   >
          <a href="#CPU空闲-–-引入Store-Buffer" class="heading-link"><i class="fas fa-link"></i></a><a href="#CPU空闲-–-引入Store-Buffer" class="headerlink" title="CPU空闲 –&gt; 引入Store Buffer"></a>CPU空闲 –&gt; 引入Store Buffer</h1>
      <p>当线程A发起写操作并且发起Invalidate信号必须要等其他线程返回Invalidate Acknowledge信号 那么就会有一个等待时间，而我们要的是CPU忙，让CPU空闲不是我们想要的</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230801174606159.png"  alt="CPU空闲">
      </p>
<p>所以引入了StoreBuffer，将修改之后的操作直接存入StoreBuffer中，而StoreBuffer以某种条件刷入到Cache中再去执行操作，这样就不会导致线程空闲。</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230801175207579.png"  alt="引入StroeBuffer之后">
      </p>
<p>当线程有执行操作之后直接写入到StoreBuffer中，而StoreBuffer是一个先进先出的队列，这样能保证数据刷出的有序性</p>
<p>而线程要读取数据的时候发现StoreBuffer中有的时候可以直接从StroeBuffer中获取数据</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230801175913669.png"  alt="处理模型">
      </p>
<p><em>引出的问题</em>：StoreBuffer会引起缓存的不一致性，当数据还没刷出到Cache中的时候就导致了数据的错误</p>
<p><strong>解决方案</strong></p>
<p>添加屏障(CPU屏障)：写屏障或者全屏障，当写操作之前，将StoreBuffer的数据刷入到Cache中</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230801180536132.png"  alt="添加屏障，将StoreBuffer数据写到Cache中">
      </p>

        <h1 id="引入Invalidate-Queues"   >
          <a href="#引入Invalidate-Queues" class="heading-link"><i class="fas fa-link"></i></a><a href="#引入Invalidate-Queues" class="headerlink" title="引入Invalidate Queues"></a>引入Invalidate Queues</h1>
      <p>当StoreBuffer打满要刷新到Cache中或者因为其他原因要写到Cache中，多个Invalidate信号要等待Invalidate AcknowLedge信号而Invalidate AcknowLedge信号很慢，这段时间会空闲，所以引入了一个失效队列，当失效信号发出就发到失效队列中，这样就异步解决了这个问题</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230801181326286.png"  alt="引入Invalidate Queues">
      </p>
<p><em>引出的问题</em>：Invalidate会引起缓存的不一致性，当信号还没执行，就要读取数据了而此时数据没更新会导致数据的错误</p>
<p><strong>解决方案</strong></p>
<p>添加屏障(CPU屏障)：读屏障或者全屏障，当读操作之前，将InvalidateQueue中作用到Cache中</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230801181924213.png"  alt="添加屏障">
      </p>

        <h1 id="乱序问题"   >
          <a href="#乱序问题" class="heading-link"><i class="fas fa-link"></i></a><a href="#乱序问题" class="headerlink" title="乱序问题"></a>乱序问题</h1>
      <p>因为指令在虚拟机执行可能会进行一个重排，导致一个不可见性，所以有可能出现乱序问题</p>
<ul>
<li><p>Load Load：有问题，线程A读取数据的时候第一次读取和第二次读取可能不一样(其他线程进行改动)</p>
</li>
<li><p>Load Store：没问题，线程A读取数据然后从写入数据到StoreBuffer中</p>
</li>
<li><p>Store Load：有问题，线程A写操作写入StoreBuffer而没有刷到主存中，线程B再读数据就会读到脏数据</p>
</li>
<li><p>Store Store：：没问题，线程A写入StoreBuffer中，因为StoreBuffer是先进先出的队列，只要保证Happens-before原则，那么执行的顺序就是有序的</p>
</li>
</ul>
<p>解决方案:利用屏障，将数据刷出在Cache中</p>

        <h1 id="总结："   >
          <a href="#总结：" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结：" class="headerlink" title="总结："></a>总结：</h1>
      <p>以上是从硬件层面来讲JUC为什么并发会导致数据错误，我们真正要进入Java的世界中去探讨JUC并发编程的问题了</p>
<hr>

        <h1 id="后记"   >
          <a href="#后记" class="heading-link"><i class="fas fa-link"></i></a><a href="#后记" class="headerlink" title="后记"></a>后记</h1>
      <p>我学JUC这块我很幸运我能在大概几百个点击的时候在B站看到J3Code老哥对JUC并发编程的视频，我没有选择尚硅谷、马士兵、黑马的视频，可能是在学JUC这块看到了一些差评的原因，而黑马是因为视频有点旧了，实际上我学的还是JDK8的，到现在为止视频应该是可以学习的。但是因为有些评论说是因为PPT讲师造就PPT程序员，是吧。所以看差评这块影响心态被拿捏的死死的</p>
<hr>
<p>总之，我还是非常感谢J3Code老哥可以免费分享出他深入JUC这块的成果，下面是他的CSDN地址</p>
<div class="table-container"><table>
<thead>
<tr>
<th>作者</th>
<th>CSDN主页地址</th>
</tr>
</thead>
<tbody><tr>
<td>J3code</td>
<td><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/qq_40399646" >https://blog.csdn.net/qq_40399646</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td>
</tr>
</tbody></table></div>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/07/30/MallChat%E9%A1%B9%E7%9B%AE%E5%AD%A6%E4%B9%A0/">MallChat项目学习</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-07-30</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">21.8k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">197分</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="先跑通项目"   >
          <a href="#先跑通项目" class="heading-link"><i class="fas fa-link"></i></a><a href="#先跑通项目" class="headerlink" title="先跑通项目"></a>先跑通项目</h1>
      
        <h2 id="尝试运行"   >
          <a href="#尝试运行" class="heading-link"><i class="fas fa-link"></i></a><a href="#尝试运行" class="headerlink" title="尝试运行"></a>尝试运行</h2>
      
        <h3 id="后端"   >
          <a href="#后端" class="heading-link"><i class="fas fa-link"></i></a><a href="#后端" class="headerlink" title="后端:"></a>后端:</h3>
      <p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230730100207953.png"  alt="image-20230730100207953">
      </p>
<p>|INFO|2023-07-30 09:50:38.781|main||uid&#x3D;|Tomcat initialized with port(s): 8080 (http)|</p>
<p>找到内置的tomcat服务器端口号是8080</p>

        <h3 id="前端"   >
          <a href="#前端" class="heading-link"><i class="fas fa-link"></i></a><a href="#前端" class="headerlink" title="前端:"></a>前端:</h3>
      <p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230730103826557.png"  alt="image-20230730103826557">
      </p>

        <h2 id="尝试进入Swagger"   >
          <a href="#尝试进入Swagger" class="heading-link"><i class="fas fa-link"></i></a><a href="#尝试进入Swagger" class="headerlink" title="尝试进入Swagger"></a>尝试进入Swagger</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.github.xiaoymin&lt;/groupId&gt;</span><br><span class="line">    &lt;!--使用Swagger2--&gt;</span><br><span class="line">    &lt;artifactId&gt;knife4j-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">2.0</span><span class="number">.9</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></div></figure>

<p>因为找到了Swagger2依赖 所以项目中用了Swagger</p>
<p>尝试进入Swagger-ui页面</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230730100713827.png"  alt="image-20230730100713827">
      </p>
<p>找到Swagger配置类</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SwaggerConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean(value = &quot;defaultApi2&quot;)</span></span><br><span class="line">    Docket <span class="title function_">docket</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Docket</span>(DocumentationType.SWAGGER_2)</span><br><span class="line">                <span class="comment">//配置网站的基本信息</span></span><br><span class="line">                .apiInfo(<span class="keyword">new</span> <span class="title class_">ApiInfoBuilder</span>()</span><br><span class="line">                        <span class="comment">//网站标题</span></span><br><span class="line">                        .title(<span class="string">&quot;mallchat接口文档&quot;</span>)</span><br><span class="line">                        <span class="comment">//标题后面的版本号</span></span><br><span class="line">                        .version(<span class="string">&quot;v1.0&quot;</span>)</span><br><span class="line">                        .description(<span class="string">&quot;mallchat接口文档&quot;</span>)</span><br><span class="line">                        <span class="comment">//联系人信息</span></span><br><span class="line">                        .contact(<span class="keyword">new</span> <span class="title class_">Contact</span>(<span class="string">&quot;阿斌&quot;</span>, <span class="string">&quot;http://www.mallchat.cn&quot;</span>, <span class="string">&quot;972627721@qq.com&quot;</span>))</span><br><span class="line">                        .build())</span><br><span class="line">                .select()</span><br><span class="line">                <span class="comment">//指定接口的位置</span></span><br><span class="line">                .apis(RequestHandlerSelectors</span><br><span class="line">                        .withClassAnnotation(RestController.class)</span><br><span class="line">                )</span><br><span class="line">                .paths(PathSelectors.any())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>

<p>通过mallchat文档中得知</p>
<p>SwaggerUI经过Knife4j优化之后URL变更了</p>
<p>从localhost:8080&#x2F;doc.html进入SwaggerUI中</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230730103929645.png"  alt="image-20230730103929645">
      </p>
<p>获得了接口列表</p>

        <h2 id="端口号分析"   >
          <a href="#端口号分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#端口号分析" class="headerlink" title="端口号分析"></a>端口号分析</h2>
      <p>3306: Mysql端口</p>
<p>6379: Redis端口</p>
<p>8080:本地tomcat端口</p>
<p>8090:内网穿透端口</p>
<p>9000:minio端口</p>
<p>9001:minio控制台端口</p>
<p>9988?</p>

        <h2 id="进入前端界面尝试前后端联调"   >
          <a href="#进入前端界面尝试前后端联调" class="heading-link"><i class="fas fa-link"></i></a><a href="#进入前端界面尝试前后端联调" class="headerlink" title="进入前端界面尝试前后端联调"></a>进入前端界面尝试前后端联调</h2>
      <p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230730161607692.png"  alt="image-20230730161607692">
      </p>

        <h2 id="申请测试号，来进行获取微信信息"   >
          <a href="#申请测试号，来进行获取微信信息" class="heading-link"><i class="fas fa-link"></i></a><a href="#申请测试号，来进行获取微信信息" class="headerlink" title="申请测试号，来进行获取微信信息"></a>申请测试号，来进行获取微信信息</h2>
      <p>通过微信测试号可以获得登录的头像等微信信息</p>

        <h2 id="通过测试号获取到登录信息之后进入前端页面进行测试"   >
          <a href="#通过测试号获取到登录信息之后进入前端页面进行测试" class="heading-link"><i class="fas fa-link"></i></a><a href="#通过测试号获取到登录信息之后进入前端页面进行测试" class="headerlink" title="通过测试号获取到登录信息之后进入前端页面进行测试"></a>通过测试号获取到登录信息之后进入前端页面进行测试</h2>
      <p>清除浏览器Session然后重新刷新页面抓到初始化请求</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230730225147538.png"  alt="image-20230730225147538">
      </p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230731101441566.png"  alt="image-20230731101441566">
      </p>
<div class="table-container"><table>
<thead>
<tr>
<th>name</th>
<th>请求类型</th>
<th>URL</th>
</tr>
</thead>
<tbody><tr>
<td>page?pageSize&#x3D;20</td>
<td>GET请求</td>
<td><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://localhost:9988/capi/chat/public/member/page?pageSize=20" >http://localhost:9988/capi/chat/public/member/page?pageSize=20</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td>
</tr>
<tr>
<td>statistic</td>
<td>GET请求</td>
<td><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://localhost:9988/capi/chat/public/member/statistic" >http://localhost:9988/capi/chat/public/member/statistic</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td>
</tr>
<tr>
<td>badges</td>
<td>GET请求</td>
<td><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://localhost:9988/capi/user/badges" >http://localhost:9988/capi/user/badges</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td>
</tr>
<tr>
<td>page?pageSize&#x3D;20&amp;roomId&#x3D;1</td>
<td>GET请求</td>
<td><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://localhost:9988/capi/chat/public/msg/page?pageSize=20&roomId=1" >http://localhost:9988/capi/chat/public/msg/page?pageSize=20&amp;roomId=1</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td>
</tr>
<tr>
<td>list</td>
<td>GET请求</td>
<td><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://localhost:9988/capi/user/emoji/list" >http://localhost:9988/capi/user/emoji/list</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td>
</tr>
</tbody></table></div>
<p>然后点击登录按钮</p>
<p>通过微信扫码登录到聊天室中</p>
<p>我们来看新增的两个请求</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230731100759932.png"  alt="image-20230731100759932">
      </p>
<div class="table-container"><table>
<thead>
<tr>
<th>name</th>
<th>请求类型</th>
<th>URL</th>
</tr>
</thead>
<tbody><tr>
<td>userInfo</td>
<td>GET请求</td>
<td><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://localhost:9988/capi/user/userInfo" >http://localhost:9988/capi/user/userInfo</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td>
</tr>
<tr>
<td>list?uid&#x3D;10003</td>
<td>GET请求</td>
<td><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://localhost:9988/capi/user/emoji/list?uid=10003" >http://localhost:9988/capi/user/emoji/list?uid=10003</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td>
</tr>
</tbody></table></div>
<p>这个登录是通过VX扫码实现的，我们之后再看这个逻辑实现</p>
<p>先从用户模块开始看吧</p>

        <h2 id="用户模块"   >
          <a href="#用户模块" class="heading-link"><i class="fas fa-link"></i></a><a href="#用户模块" class="headerlink" title="用户模块"></a>用户模块</h2>
      <p>从Swaager-ui发起测试请求，响应结果是未登录</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230731102513714.png"  alt="image-20230731102513714">
      </p>
<p>可知URI被拦截器拦截</p>
<p>找到Token拦截器</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">//获取用户登录token</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> getToken(request);</span><br><span class="line">    <span class="type">Long</span> <span class="variable">validUid</span> <span class="operator">=</span> loginService.getValidUid(token);</span><br><span class="line">    <span class="keyword">if</span> (Objects.nonNull(validUid)) &#123;<span class="comment">//有登录态</span></span><br><span class="line">        request.setAttribute(ATTRIBUTE_UID, validUid);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isPublicURI</span> <span class="operator">=</span> isPublicURI(request.getRequestURI());</span><br><span class="line">        <span class="keyword">if</span> (!isPublicURI) &#123;<span class="comment">//又没有登录态，又不是公开路径，直接401</span></span><br><span class="line">            HttpErrorEnum.ACCESS_DENIED.sendHttpError(response);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    MDC.put(MDCKey.UID, String.valueOf(validUid));</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>调用了一个isPublicURI方法 来判断是不是公开路径</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isPublicURI</span><span class="params">(String requestURI)</span> &#123;</span><br><span class="line">    String[] split = requestURI.split(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> split.length &gt; <span class="number">2</span> &amp;&amp; <span class="string">&quot;public&quot;</span>.equals(split[<span class="number">3</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//将请求通过&#x27;/&#x27;分割,当数组长度大于2并且第四块为public的时候说明是公开路径</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">例如 http://localhost:9988/capi/user/userInfo</span></span><br><span class="line"><span class="comment">通过&#x27;/&#x27;切割 </span></span><br><span class="line"><span class="comment">则</span></span><br><span class="line"><span class="comment">split[0],</span></span><br><span class="line"><span class="comment">split[1],capi</span></span><br><span class="line"><span class="comment">split[2],user</span></span><br><span class="line"><span class="comment">split[3],userInfo</span></span><br><span class="line"><span class="comment">例如 http://localhost:9988/capi/chat/public/member/page</span></span><br><span class="line"><span class="comment">则</span></span><br><span class="line"><span class="comment">split[0],</span></span><br><span class="line"><span class="comment">split[1],capi</span></span><br><span class="line"><span class="comment">split[2],chat</span></span><br><span class="line"><span class="comment">split[3],public</span></span><br><span class="line"><span class="comment">split[4],member</span></span><br><span class="line"><span class="comment">split[5],page</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>决定用通过登录之后的前端来进行测试</p>

        <h3 id="获得用户信息"   >
          <a href="#获得用户信息" class="heading-link"><i class="fas fa-link"></i></a><a href="#获得用户信息" class="headerlink" title="获得用户信息"></a>获得用户信息</h3>
      <div class="table-container"><table>
<thead>
<tr>
<th>访问uri</th>
<th>请求类型</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;capi&#x2F;user&#x2F;userInfo</td>
<td>GET请求</td>
</tr>
</tbody></table></div>

        <h4 id="Controller层"   >
          <a href="#Controller层" class="heading-link"><i class="fas fa-link"></i></a><a href="#Controller层" class="headerlink" title="Controller层"></a>Controller层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/userInfo&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;用户详情&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ApiResult&lt;UserInfoResp&gt; <span class="title function_">getUserInfo</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//通过获取请求的上下文获取uid调用userService.getUserInfo方法  传入具体的Uid</span></span><br><span class="line">    <span class="keyword">return</span> ApiResult.success(userService.getUserInfo(RequestHolder.get().getUid()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>调用getUserInfo方法</p>
<p>将返回结果封装成APIResult对象(统一返回类型)</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(&quot;基础返回体&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApiResult</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;成功标识true or false&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Boolean success;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;错误码&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer errCode;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;错误消息&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String errMsg;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;返回对象&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; ApiResult&lt;T&gt; <span class="title function_">success</span><span class="params">(T data)</span> &#123;</span><br><span class="line">        ApiResult&lt;T&gt; result = <span class="keyword">new</span> <span class="title class_">ApiResult</span>&lt;T&gt;();</span><br><span class="line">        result.setData(data);</span><br><span class="line">        result.setSuccess(Boolean.TRUE);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//传入的参数data是Controller层中的</span></span><br><span class="line"><span class="comment">//userService.getUserInfo(RequestHolder.get().getUid())</span></span><br></pre></td></tr></table></div></figure>


        <h4 id="UserService层"   >
          <a href="#UserService层" class="heading-link"><i class="fas fa-link"></i></a><a href="#UserService层" class="headerlink" title="UserService层"></a>UserService层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UserInfoResp <span class="title function_">getUserInfo</span><span class="params">(Long uid)</span>;</span><br></pre></td></tr></table></div></figure>

<p>实现类中</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> UserInfoResp <span class="title function_">getUserInfo</span><span class="params">(Long uid)</span> &#123;</span><br><span class="line">       <span class="comment">//查询缓存中有没有这个Uid,本质上调用map.get() 如果有则返回User 如果没有则返回null</span></span><br><span class="line">       <span class="type">User</span> <span class="variable">userInfo</span> <span class="operator">=</span> userCache.getUserInfo(uid);</span><br><span class="line">       <span class="comment">//查询当前用户(Uid)的物品改名卡使用状态</span></span><br><span class="line">       <span class="type">Integer</span> <span class="variable">countByValidItemId</span> <span class="operator">=</span></span><br><span class="line">           userBackpackDao.getCountByValidItemId(uid, ItemEnum.MODIFY_NAME_CARD.getId());</span><br><span class="line">       <span class="keyword">return</span> UserAdapter.buildUserInfoResp(userInfo, countByValidItemId);</span><br><span class="line">       <span class="comment">//将缓存中的数据和当前用户改名卡状态发送到适配器中buildUserInfoResp中</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="getUserInfo"   >
          <a href="#getUserInfo" class="heading-link"><i class="fas fa-link"></i></a><a href="#getUserInfo" class="headerlink" title="getUserInfo"></a>getUserInfo</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> User <span class="title function_">getUserInfo</span><span class="params">(Long uid)</span> &#123;<span class="comment">//todo 后期做二级缓存</span></span><br><span class="line">		<span class="comment">//调用getUserInfoBatch获取一个Map&lt;Long,user&gt; 然后调用Map的get方法  如果有数据返回User,没有返回null</span></span><br><span class="line">       <span class="keyword">return</span> getUserInfoBatch(Collections.singleton(uid)).get(uid);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="getInfoBatch"   >
          <a href="#getInfoBatch" class="heading-link"><i class="fas fa-link"></i></a><a href="#getInfoBatch" class="headerlink" title="getInfoBatch"></a>getInfoBatch</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Map&lt;Long, User&gt; <span class="title function_">getUserInfoBatch</span><span class="params">(Set&lt;Long&gt; uids)</span> &#123;</span><br><span class="line">    	<span class="comment">//将uids转换成流 然后调用RedisKey的封装类将其拼接成mallchat:userInfo:uid_%d的格式，然后转成List列表</span></span><br><span class="line">        List&lt;String&gt; keys = uids.stream().map(a -&gt; RedisKey.getKey(RedisKey.USER_INFO_STRING, a)).collect(Collectors.toList());</span><br><span class="line">    	<span class="comment">//调用RedisUtils的mget方法，返回多个User放到List中</span></span><br><span class="line">        List&lt;User&gt; mget = RedisUtils.mget(keys, User.class);</span><br><span class="line">    	<span class="comment">//过滤非空的对象，封装成Key为Uid,Value为User的map 这里的map是缓存中的map</span></span><br><span class="line">        Map&lt;Long, User&gt; map = mget.stream().filter(Objects::nonNull).collect(Collectors.toMap(User::getId, Function.identity()));</span><br><span class="line">        <span class="comment">//还需要load更新的uid</span></span><br><span class="line">    	<span class="comment">//找到不包含在缓存中的uid放到needLoadUidList中</span></span><br><span class="line">        List&lt;Long&gt; needLoadUidList = uids.stream().filter(a -&gt; !map.containsKey(a)).collect(Collectors.toList());</span><br><span class="line">    	<span class="comment">//如果needLoadUidList非空则说明有新数据要写到缓存中</span></span><br><span class="line">        <span class="keyword">if</span> (CollUtil.isNotEmpty(needLoadUidList)) &#123;</span><br><span class="line">            <span class="comment">//调用userDao的查询方法 ，UserDao调用getBaseMapper().selectBatchIds(idList)获取数据库中的user用户列表</span></span><br><span class="line">            List&lt;User&gt; needLoadUserList = userDao.listByIds(needLoadUidList);</span><br><span class="line">            <span class="comment">//统一转换成key为mallchat:userInfo:uid_%d,value为User的格式 放到Map</span></span><br><span class="line">            Map&lt;String, User&gt; redisMap = needLoadUserList.stream().collect(Collectors.toMap(a -&gt; RedisKey.getKey(RedisKey.USER_INFO_STRING, a.getId()), Function.identity()));</span><br><span class="line">            <span class="comment">//调用RedisUtils.mset 统一写进缓存 参数一:要写进去的数据,参数二:过期时间5*60</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">//将查询UserInfo的缓存设置为300s 即5分钟</span></span><br><span class="line">            RedisUtils.mset(redisMap, <span class="number">5</span> * <span class="number">60</span>);</span><br><span class="line">            <span class="comment">//将更新完到缓存的数据放回到map中，用于进行返回用户数据</span></span><br><span class="line">            map.putAll(needLoadUserList.stream().collect(Collectors.toMap(User::getId, Function.identity())));</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">//返回map</span></span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="UserBackPackDao"   >
          <a href="#UserBackPackDao" class="heading-link"><i class="fas fa-link"></i></a><a href="#UserBackPackDao" class="headerlink" title="UserBackPackDao"></a>UserBackPackDao</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserBackpackDao</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;UserBackpackMapper, UserBackpack&gt; &#123;</span><br><span class="line">	<span class="comment">//利用了MP</span></span><br><span class="line">	<span class="keyword">public</span> Integer <span class="title function_">getCountByValidItemId</span><span class="params">(Long uid, Long itemId)</span> &#123;</span><br><span class="line">        <span class="comment">//调用lambdaQuery方法</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//这个Select语句是 SELECT COUNT( 1 ) FROM user_backpack WHERE (uid = ? AND item_id = ? AND status = ?)</span></span><br><span class="line">        <span class="comment">//注入的参数是uid: 10004， itemId: 1 ,status =0</span></span><br><span class="line">        <span class="comment">//翻译过来是查询10004号用户，物品ID为1(改名卡),未被使用(0未使用,1已使用)</span></span><br><span class="line">        <span class="comment">//返回了1  即10004用户状态正如参数所示</span></span><br><span class="line">        <span class="keyword">return</span> lambdaQuery().eq(UserBackpack::getUid, uid)</span><br><span class="line">                .eq(UserBackpack::getItemId, itemId)</span><br><span class="line">                .eq(UserBackpack::getStatus, YesOrNoEnum.NO.getStatus())</span><br><span class="line">                .count();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="流程"   >
          <a href="#流程" class="heading-link"><i class="fas fa-link"></i></a><a href="#流程" class="headerlink" title="流程"></a>流程</h4>
      <p>①查询用户信息的时候，Controller调用service的查询userInfo的方法，传入请求中的uid 然后包装成APIResult返回前端</p>
<p>②serviceImpl 查询用户数据 直接查询缓存，如果查询到缓存则直接返回用户数据</p>
<p>③如果缓存中没有数据则通过userDao查询数据库，数据库返回到的数据先写回到Redis中设置过期时间为300秒</p>
<p>④将查询结果返回，然后查询用户物品使用信息 调用userBackpackDao的方法</p>
<p>⑤统一将用户详情信息、用户物品使用信息用userAdapter封装返回</p>

        <h3 id="修改用户名"   >
          <a href="#修改用户名" class="heading-link"><i class="fas fa-link"></i></a><a href="#修改用户名" class="headerlink" title="修改用户名"></a>修改用户名</h3>
      <p>访问uil</p>
<div class="table-container"><table>
<thead>
<tr>
<th>访问uil</th>
<th>请求类型</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;capi&#x2F;user&#x2F;name</td>
<td>PUT请求</td>
</tr>
</tbody></table></div>

        <h4 id="Controller层-1"   >
          <a href="#Controller层-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#Controller层-1" class="headerlink" title="Controller层"></a>Controller层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PutMapping(&quot;/name&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;修改用户名&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ApiResult&lt;Void&gt; <span class="title function_">modifyName</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> ModifyNameReq req)</span> &#123;</span><br><span class="line">    userService.modifyName(RequestHolder.get().getUid(), req);</span><br><span class="line">    <span class="keyword">return</span> ApiResult.success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>调用userService.modfiyName方法修改用户名</p>
<p>返回成功结果</p>

        <h4 id="UserService层-1"   >
          <a href="#UserService层-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#UserService层-1" class="headerlink" title="UserService层"></a>UserService层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">modifyName</span><span class="params">(Long uid, ModifyNameReq req)</span>;</span><br></pre></td></tr></table></div></figure>

<p>实现类中</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">modifyName</span><span class="params">(Long uid, ModifyNameReq req)</span> &#123;</span><br><span class="line">    <span class="comment">//从请求中获取新的用户名</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">newName</span> <span class="operator">=</span> req.getName();</span><br><span class="line">    <span class="comment">//检查用户名是否合法,如果不合法会抛出异常</span></span><br><span class="line">    AssertUtil.isFalse(sensitiveWordBs.hasSensitiveWord(newName), <span class="string">&quot;名字中包含敏感词，请重新输入&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//检查用户列表中有没有该用户使用这个用户名 如果有则会返回一个User</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">oldUser</span> <span class="operator">=</span> userDao.getByName(newName);</span><br><span class="line">    <span class="comment">//判断用户中有这个名字则抛出异常</span></span><br><span class="line">    AssertUtil.isEmpty(oldUser, <span class="string">&quot;名字已经被抢占了，请换一个哦~~&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//判断用户有没有改名机会，如果有改名机会则会返回一个UserBackpack 如果没有则会返回null</span></span><br><span class="line">    <span class="type">UserBackpack</span> <span class="variable">firstValidItem</span> <span class="operator">=</span> userBackpackDao.getFirstValidItem(uid, ItemEnum.MODIFY_NAME_CARD.getId());</span><br><span class="line">    <span class="comment">//如果没有改名卡则抛出异常</span></span><br><span class="line">    AssertUtil.isNotEmpty(firstValidItem, <span class="string">&quot;改名次数不够了，等后续活动送改名卡哦&quot;</span>);</span><br><span class="line">   </span><br><span class="line">    <span class="comment">//走到这里用户可以改名，然后判断有没有使用改名卡</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">useSuccess</span> <span class="operator">=</span> userBackpackDao.invalidItem(firstValidItem.getId());</span><br><span class="line">    <span class="comment">//采用乐观锁判断改名卡使用是否成功</span></span><br><span class="line">    <span class="keyword">if</span> (useSuccess) &#123;</span><br><span class="line">        <span class="comment">//如果用户改名成功，则进入条件判断中</span></span><br><span class="line">        <span class="comment">//改名</span></span><br><span class="line">        userDao.modifyName(uid, req.getName());</span><br><span class="line">       </span><br><span class="line">        <span class="comment">//调用userInfoChange(uid) 删除缓存中用户信息并更新缓存数据物品使用信息</span></span><br><span class="line">        userCache.userInfoChange(uid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="getFirstValidItem"   >
          <a href="#getFirstValidItem" class="heading-link"><i class="fas fa-link"></i></a><a href="#getFirstValidItem" class="headerlink" title="getFirstValidItem"></a>getFirstValidItem</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> UserBackpack <span class="title function_">getFirstValidItem</span><span class="params">(Long uid, Long itemId)</span> &#123;</span><br><span class="line">    	<span class="comment">//调用LambdaQueryWrapper可以使用匿名类和lambda表达式进行查询条件的拼接</span></span><br><span class="line">    </span><br><span class="line">    	<span class="comment">//SELECT id,uid,item_id,status,idempotent,create_time,update_time FROM user_backpack </span></span><br><span class="line">    	<span class="comment">//WHERE (uid = ? AND item_id = ? AND status = ?) limit 1	</span></span><br><span class="line">    	<span class="comment">//参数:10004(Long), 1(Long), 0(Integer)  </span></span><br><span class="line"> </span><br><span class="line">        LambdaQueryWrapper&lt;UserBackpack&gt; wrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;UserBackpack&gt;().lambda()</span><br><span class="line">                .eq(UserBackpack::getUid, uid)   <span class="comment">//限制uid相等</span></span><br><span class="line">                .eq(UserBackpack::getItemId, itemId)  <span class="comment">//限制itemId相等</span></span><br><span class="line">                .eq(UserBackpack::getStatus, YesOrNoEnum.NO.getStatus())  <span class="comment">//限制物品使用情况，0即未使用</span></span><br><span class="line">                .last(<span class="string">&quot;limit 1&quot;</span>);  <span class="comment">//只能返回一个</span></span><br><span class="line">    </span><br><span class="line">    	<span class="comment">//返回一条查询结果</span></span><br><span class="line">        <span class="keyword">return</span> getOne(wrapper);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="invaldItem"   >
          <a href="#invaldItem" class="heading-link"><i class="fas fa-link"></i></a><a href="#invaldItem" class="headerlink" title="invaldItem"></a>invaldItem</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">invalidItem</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">		<span class="comment">//使用改名卡,修改用户物品信息表</span></span><br><span class="line">        <span class="type">UserBackpack</span> <span class="variable">update</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserBackpack</span>();</span><br><span class="line">        update.setId(id);</span><br><span class="line">        update.setStatus(YesOrNoEnum.YES.getStatus());</span><br><span class="line">    </span><br><span class="line">    	<span class="comment">//UPDATE user_backpack SET status=? WHERE id=?</span></span><br><span class="line">    	<span class="comment">//参数：1(Integer), 2(Long)</span></span><br><span class="line">    	<span class="comment">//更新用户物品使用表，如果更新成功则返回true,如果更新失败则返回false</span></span><br><span class="line">        <span class="keyword">return</span> updateById(update);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="ModifyName"   >
          <a href="#ModifyName" class="heading-link"><i class="fas fa-link"></i></a><a href="#ModifyName" class="headerlink" title="ModifyName"></a>ModifyName</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">modifyName</span><span class="params">(Long uid, String name)</span> &#123;</span><br><span class="line">    	<span class="comment">//更新用户表，用户使用了改名卡修改名字</span></span><br><span class="line">    	<span class="type">User</span> <span class="variable">update</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        update.setId(uid);</span><br><span class="line">        update.setName(name);</span><br><span class="line">    	</span><br><span class="line">    	<span class="comment">//更新用户信息</span></span><br><span class="line">    	<span class="comment">//UPDATE user SET name=? WHERE id=?</span></span><br><span class="line">    	<span class="comment">//参数：鱼鱼(String), 10004(Long)</span></span><br><span class="line">        updateById(update);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="userInfoChange"   >
          <a href="#userInfoChange" class="heading-link"><i class="fas fa-link"></i></a><a href="#userInfoChange" class="headerlink" title="userInfoChange"></a>userInfoChange</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">userInfoChange</span><span class="params">(Long uid)</span> &#123;</span><br><span class="line">    	<span class="comment">//删除用户缓存</span></span><br><span class="line">        delUserInfo(uid);</span><br><span class="line">    	<span class="comment">//更新缓存中用户物品使用时间</span></span><br><span class="line">        refreshUserModifyTime(uid);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="流程-1"   >
          <a href="#流程-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#流程-1" class="headerlink" title="流程"></a>流程</h4>
      <p>①调用Controller来处理改名请求，Controller调用service来进行改名操作</p>
<p>②判断用户名是否合法、用户名是否被占用、是否有改名次数，如果都有则进入改名阶段,如果有其一没有则抛出异常</p>
<p>③改名，先修改改名卡使用情况，如果修改成功则代表着改名成功，如果修改失败则说明有线程竞争</p>
<p>④改名成功，删除缓存中用户信息，缓存添加修改使用物品时间</p>

        <h3 id="可选勋章预览"   >
          <a href="#可选勋章预览" class="heading-link"><i class="fas fa-link"></i></a><a href="#可选勋章预览" class="headerlink" title="可选勋章预览"></a>可选勋章预览</h3>
      <div class="table-container"><table>
<thead>
<tr>
<th>访问Uri</th>
<th>请求类型</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;capi&#x2F;user&#x2F;badges</td>
<td>GET请求</td>
</tr>
</tbody></table></div>

        <h4 id="Controller层-2"   >
          <a href="#Controller层-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#Controller层-2" class="headerlink" title="Controller层"></a>Controller层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/badges&quot;)</span></span><br><span class="line">   <span class="meta">@ApiOperation(&quot;可选徽章预览&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> ApiResult&lt;List&lt;BadgeResp&gt;&gt; <span class="title function_">badges</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> ApiResult.success(userService.badges(RequestHolder.get().getUid()));</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></div></figure>

<p>调用Service层的badges方法 传入参数是请求中的uid</p>

        <h4 id="Service层"   >
          <a href="#Service层" class="heading-link"><i class="fas fa-link"></i></a><a href="#Service层" class="headerlink" title="Service层"></a>Service层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;BadgeResp&gt; <span class="title function_">badges</span><span class="params">(Long uid)</span>;</span><br></pre></td></tr></table></div></figure>

<p>实现类</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;BadgeResp&gt; <span class="title function_">badges</span><span class="params">(Long uid)</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//查询Cache中勋章列表   参数Type:2 表示勋章</span></span><br><span class="line">    List&lt;ItemConfig&gt; itemConfigs = itemCache.getByType(ItemTypeEnum.BADGE.getType());</span><br><span class="line">  </span><br><span class="line">    <span class="comment">//查询uid下的可用勋章，然后返回一个List&lt;UserBackpack&gt;</span></span><br><span class="line">    List&lt;UserBackpack&gt; backpacks = userBackpackDao.getByItemIds(uid, itemConfigs.stream().map(ItemConfig::getId).collect(Collectors.toList()));</span><br><span class="line">   </span><br><span class="line">    <span class="comment">//根据uid查询用户信息，获取当前用户佩戴的勋章</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userDao.getById(uid);</span><br><span class="line">    <span class="comment">//将总勋章列表、用户可用勋章、当前用户佩戴勋章传入适配器中的buildBadgeResp中，然后返回给前端</span></span><br><span class="line">    <span class="keyword">return</span> UserAdapter.buildBadgeResp(itemConfigs, backpacks, user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="getByType"   >
          <a href="#getByType" class="heading-link"><i class="fas fa-link"></i></a><a href="#getByType" class="headerlink" title="getByType"></a>getByType</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Cacheable(cacheNames = &quot;item&quot;, key = &quot;&#x27;itemsByType:&#x27;+#type&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;ItemConfig&gt; <span class="title function_">getByType</span><span class="params">(Integer type)</span> &#123;</span><br><span class="line">        <span class="comment">//传入参数：2 表示勋章</span></span><br><span class="line">        <span class="comment">//调用itemConfigDao的方法 返回数据 写入缓存中</span></span><br><span class="line">        <span class="keyword">return</span> itemConfigDao.getByType(type);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>

<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;ItemConfig&gt; <span class="title function_">getByType</span><span class="params">(Integer type)</span> &#123;</span><br><span class="line">    <span class="comment">//返回list,list中装着ambdaQuery查询结果</span></span><br><span class="line">    </span><br><span class="line"> 	<span class="comment">//SELECT id,type,img,`describe`,create_time,update_time FROM item_config WHERE (type = ?) </span></span><br><span class="line">    <span class="comment">//限制Type==type,然后转化成list</span></span><br><span class="line">    <span class="keyword">return</span> lambdaQuery().eq(ItemConfig::getType, type).list();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="getByItemId"   >
          <a href="#getByItemId" class="heading-link"><i class="fas fa-link"></i></a><a href="#getByItemId" class="headerlink" title="getByItemId"></a>getByItemId</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;UserBackpack&gt; <span class="title function_">getByItemIds</span><span class="params">(Long uid, List&lt;Long&gt; itemIds)</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//Preparing: SELECT id,uid,item_id,status,idempotent,create_time,update_time </span></span><br><span class="line">    <span class="comment">//FROM user_backpack WHERE (uid = ? AND item_id IN (?,?,?,?,?) AND status = ?)</span></span><br><span class="line">	<span class="comment">//==&gt; Parameters: 10004(Long), 2(Long), 3(Long), 4(Long), 5(Long), 6(Long), 0(Integer)</span></span><br><span class="line">    			<span class="comment">//返回LambdaQuery结果</span></span><br><span class="line">    			<span class="comment">//查询条件限制uid相等</span></span><br><span class="line">    	<span class="keyword">return</span> lambdaQuery().eq(UserBackpack::getUid, uid)</span><br><span class="line">        		<span class="comment">//在总勋章列表中的itemIds</span></span><br><span class="line">                .in(UserBackpack::getItemId, itemIds)</span><br><span class="line">            	<span class="comment">//是否使用勋章</span></span><br><span class="line">                .eq(UserBackpack::getStatus, YesOrNoEnum.NO.getStatus())</span><br><span class="line">                .list();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//这个方法就是判断用户是否有拥有的勋章</span></span><br></pre></td></tr></table></div></figure>


        <h4 id="userDao-getById"   >
          <a href="#userDao-getById" class="heading-link"><i class="fas fa-link"></i></a><a href="#userDao-getById" class="headerlink" title="userDao.getById"></a>userDao.getById</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">default</span> T <span class="title function_">getById</span><span class="params">(Serializable id)</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//SELECT id,name,avatar,sex,open_id,last_opt_time,ip_info,item_id,status,create_time,update_time 			//FROM user WHERE id=?</span></span><br><span class="line">    <span class="comment">//调用mp的方法，查询uid为id的用户信息，获取当前用户佩戴的勋章</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.getBaseMapper().selectById(id);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="buildBadgeResp"   >
          <a href="#buildBadgeResp" class="heading-link"><i class="fas fa-link"></i></a><a href="#buildBadgeResp" class="headerlink" title="buildBadgeResp"></a>buildBadgeResp</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;BadgeResp&gt; <span class="title function_">buildBadgeResp</span><span class="params">(List&lt;ItemConfig&gt; itemConfigs, List&lt;UserBackpack&gt; backpacks, User user)</span> &#123;</span><br><span class="line">    	<span class="comment">//判断user是否为空</span></span><br><span class="line">        <span class="keyword">if</span> (ObjectUtil.isNull(user)) &#123;</span><br><span class="line">            <span class="comment">// 这里 user 入参可能为空，防止 NPE 问题</span></span><br><span class="line">            <span class="comment">//如果为空则返回空集合</span></span><br><span class="line">            <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">        &#125;</span><br><span class="line">	</span><br><span class="line">    	<span class="comment">//将用户的可用勋章方法哦obtianItemSet中</span></span><br><span class="line">        Set&lt;Long&gt; obtainItemSet = 						backpacks.stream().map(UserBackpack::getItemId).collect(Collectors.toSet());</span><br><span class="line">    	<span class="comment">//利用总勋章列表放到流中</span></span><br><span class="line">        <span class="keyword">return</span> itemConfigs.stream().map(a -&gt; &#123;</span><br><span class="line">            <span class="comment">//new一个勋章返回类型</span></span><br><span class="line">            <span class="type">BadgeResp</span> <span class="variable">resp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadgeResp</span>();</span><br><span class="line">            <span class="comment">//将a的属性copy到resp中</span></span><br><span class="line">            BeanUtil.copyProperties(a, resp);</span><br><span class="line">            <span class="comment">//设置勋章ID，为了下一步与用户是否佩戴进行一个比较</span></span><br><span class="line">            resp.setObtain(obtainItemSet.contains(a.getId()) ? YesOrNoEnum.YES.getStatus() : YesOrNoEnum.NO.getStatus());</span><br><span class="line">            <span class="comment">//用户列表中是否有使用这个勋章，如果有则是佩戴勋章</span></span><br><span class="line">            resp.setWearing(ObjectUtil.equal(a.getId(), user.getItemId()) ? YesOrNoEnum.YES.getStatus() : YesOrNoEnum.NO.getStatus());</span><br><span class="line">            <span class="keyword">return</span> resp;</span><br><span class="line">            <span class="comment">//排序</span></span><br><span class="line">        &#125;).sorted(Comparator.comparing(BadgeResp::getWearing, Comparator.reverseOrder())</span><br><span class="line">                .thenComparing(BadgeResp::getObtain, Comparator.reverseOrder()))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="流程-2"   >
          <a href="#流程-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#流程-2" class="headerlink" title="流程"></a>流程</h4>
      <p>①Controller调用Service中的方法，封装成APIResult返回</p>
<p>②Service中先获取总的勋章列表并写入缓存中，其次再获取用户可用的勋章列表，最后获取用户信息来判断佩戴的勋章</p>
<p>③将总勋章列表、可用勋章列表、用户佩戴勋章传入适配器，适配器进行一个buildBadgeResp方法返回前端</p>

        <h3 id="佩戴勋章"   >
          <a href="#佩戴勋章" class="heading-link"><i class="fas fa-link"></i></a><a href="#佩戴勋章" class="headerlink" title="佩戴勋章"></a>佩戴勋章</h3>
      <div class="table-container"><table>
<thead>
<tr>
<th>访问URI</th>
<th>请求类型</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;capi&#x2F;user&#x2F;badge</td>
<td>PUT请求</td>
</tr>
</tbody></table></div>

        <h4 id="Controller层-3"   >
          <a href="#Controller层-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#Controller层-3" class="headerlink" title="Controller层"></a>Controller层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PutMapping(&quot;/badge&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;佩戴徽章&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ApiResult&lt;Void&gt; <span class="title function_">wearingBadge</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> WearingBadgeReq req)</span> &#123;</span><br><span class="line">    userService.wearingBadge(RequestHolder.get().getUid(), req);</span><br><span class="line">    <span class="keyword">return</span> ApiResult.success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>从请求中获取uid和整个请求都传入给userService.wearingBadge</p>

        <h4 id="Service层-1"   >
          <a href="#Service层-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#Service层-1" class="headerlink" title="Service层"></a>Service层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">wearingBadge</span><span class="params">(Long uid, WearingBadgeReq req)</span>;</span><br></pre></td></tr></table></div></figure>

<p>实现类中</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">wearingBadge</span><span class="params">(Long uid, WearingBadgeReq req)</span> &#123;</span><br><span class="line">    <span class="comment">//判断用户是否有这个勋章</span></span><br><span class="line">    <span class="type">UserBackpack</span> <span class="variable">firstValidItem</span> <span class="operator">=</span> userBackpackDao.getFirstValidItem(uid, req.getBadgeId());</span><br><span class="line">    <span class="comment">//如果没有勋章则会返回为null，为null则抛出异常</span></span><br><span class="line">    AssertUtil.isNotEmpty(firstValidItem, <span class="string">&quot;您没有这个徽章哦，快去达成条件获取吧&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//判断这个是不是勋章</span></span><br><span class="line">    <span class="type">ItemConfig</span> <span class="variable">itemConfig</span> <span class="operator">=</span> itemConfigDao.getById(firstValidItem.getItemId());</span><br><span class="line">    <span class="comment">//如果返回字段中类型不是勋章则会抛出异常</span></span><br><span class="line">    AssertUtil.equal(itemConfig.getType(), ItemTypeEnum.BADGE.getType(), <span class="string">&quot;该徽章不可佩戴&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//佩戴勋章 更新用户表</span></span><br><span class="line">    userDao.wearingBadge(uid, req.getBadgeId());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    userCache.userInfoChange(uid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>先调用getFirstValidItem方法 这里和使用改名卡那个方法是同一个，意义是确认是否拥有这个勋章如果有则会返回一条数据，如果没有则返回null</p>

        <h4 id="getFirstValidItem-1"   >
          <a href="#getFirstValidItem-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#getFirstValidItem-1" class="headerlink" title="getFirstValidItem"></a>getFirstValidItem</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> UserBackpack <span class="title function_">getFirstValidItem</span><span class="params">(Long uid, Long itemId)</span> &#123;</span><br><span class="line">    	<span class="comment">//调用LambdaQueryWrapper可以使用匿名类和lambda表达式进行查询条件的拼接</span></span><br><span class="line">    </span><br><span class="line">    	<span class="comment">//SELECT id,uid,item_id,status,idempotent,create_time,update_time FROM user_backpack </span></span><br><span class="line">    	<span class="comment">//WHERE (uid = ? AND item_id = ? AND status = ?) limit 1	</span></span><br><span class="line">    	<span class="comment">//参数:10004(Long), 2(Long), 0(Integer)  -0表示没有使用过 -1表示使用过  </span></span><br><span class="line"> </span><br><span class="line">        LambdaQueryWrapper&lt;UserBackpack&gt; wrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;UserBackpack&gt;().lambda()</span><br><span class="line">                .eq(UserBackpack::getUid, uid)   <span class="comment">//限制uid相等</span></span><br><span class="line">                .eq(UserBackpack::getItemId, itemId)  <span class="comment">//限制itemId相等</span></span><br><span class="line">                .eq(UserBackpack::getStatus, YesOrNoEnum.NO.getStatus())  <span class="comment">//限制物品使用情况，0即未使用</span></span><br><span class="line">                .last(<span class="string">&quot;limit 1&quot;</span>);  <span class="comment">//只能返回一个</span></span><br><span class="line">    </span><br><span class="line">    	<span class="comment">//返回一条查询结果</span></span><br><span class="line">        <span class="keyword">return</span> getOne(wrapper);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="itemConfigDao-getById"   >
          <a href="#itemConfigDao-getById" class="heading-link"><i class="fas fa-link"></i></a><a href="#itemConfigDao-getById" class="headerlink" title="itemConfigDao.getById"></a>itemConfigDao.getById</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//SELECT id,type,img,`describe`,create_time,update_time FROM item_config WHERE id=?</span></span><br><span class="line"><span class="comment">//Parameters: 2(Long)</span></span><br></pre></td></tr></table></div></figure>

<p>判断这个物品是不是勋章 ，查询结果会包含一个type字段，通过字段来判断是不是勋章</p>

        <h4 id="wearingBadge"   >
          <a href="#wearingBadge" class="heading-link"><i class="fas fa-link"></i></a><a href="#wearingBadge" class="headerlink" title="wearingBadge"></a>wearingBadge</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">wearingBadge</span><span class="params">(Long uid, Long badgeId)</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">update</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    <span class="comment">//设置Uid</span></span><br><span class="line">    update.setId(uid);</span><br><span class="line">    <span class="comment">//设置使用物品类型  即勋章类型</span></span><br><span class="line">    update.setItemId(badgeId);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//==&gt;  Preparing: UPDATE user SET item_id=? WHERE id=?</span></span><br><span class="line">	<span class="comment">//==&gt; Parameters: 2(Long), 10004(Long)</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//更新user表</span></span><br><span class="line">    updateById(update);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="userInfoChange-1"   >
          <a href="#userInfoChange-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#userInfoChange-1" class="headerlink" title="userInfoChange"></a>userInfoChange</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">userInfoChange</span><span class="params">(Long uid)</span> &#123;</span><br><span class="line">    	<span class="comment">//删除用户缓存</span></span><br><span class="line">        delUserInfo(uid);</span><br><span class="line">    	<span class="comment">//更新缓存中用户物品使用时间</span></span><br><span class="line">        refreshUserModifyTime(uid);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="流程-3"   >
          <a href="#流程-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#流程-3" class="headerlink" title="流程"></a>流程</h4>
      <p>①先判断用户是否有这个物品。如果没有会抛出异常</p>
<p>②判断在合格物品是不是勋章。如果不是会抛出异常</p>
<p>③更新用户表信息，将Item_id设置为这个物品</p>
<p>④更新缓存，删除本地缓存删除Redis缓存</p>

        <h3 id="黑名单"   >
          <a href="#黑名单" class="heading-link"><i class="fas fa-link"></i></a><a href="#黑名单" class="headerlink" title="黑名单"></a>黑名单</h3>
      <div class="table-container"><table>
<thead>
<tr>
<th>访问URI</th>
<th>请求类型</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;capi&#x2F;user&#x2F;black</td>
<td>PUT请求</td>
</tr>
</tbody></table></div>

        <h4 id="Controller层-4"   >
          <a href="#Controller层-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#Controller层-4" class="headerlink" title="Controller层"></a>Controller层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PutMapping(&quot;/black&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;拉黑用户&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ApiResult&lt;Void&gt; <span class="title function_">black</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> BlackReq req)</span> &#123;</span><br><span class="line">    <span class="comment">//从请求上下文中获取拉黑用户uid</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">uid</span> <span class="operator">=</span> RequestHolder.get().getUid();</span><br><span class="line">    <span class="comment">//判断拉黑目标用户是否是管理员，如果是管理员返回true</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">hasPower</span> <span class="operator">=</span> iRoleService.hasPower(uid, RoleEnum.ADMIN);</span><br><span class="line">    <span class="comment">//如果是管理员则抛出异常没有权限拉黑</span></span><br><span class="line">    AssertUtil.isTrue(hasPower, <span class="string">&quot;没有权限&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//没有异常则可以运行到这里 说明有权限 调用Service方法来拉黑用户</span></span><br><span class="line">    userService.black(req);</span><br><span class="line">    <span class="keyword">return</span> ApiResult.success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="Service层-2"   >
          <a href="#Service层-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#Service层-2" class="headerlink" title="Service层"></a>Service层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">black</span><span class="params">(BlackReq req)</span>;</span><br></pre></td></tr></table></div></figure>

<p>实现类中</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">black</span><span class="params">(BlackReq req)</span> &#123;</span><br><span class="line">    <span class="comment">//从请求上下文中获取要拉黑用户Uid</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">uid</span> <span class="operator">=</span> req.getUid();</span><br><span class="line">    <span class="comment">//创建一个黑名单用户</span></span><br><span class="line">    <span class="type">Black</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Black</span>();</span><br><span class="line">    <span class="comment">//设置拉黑用户UID、拉黑类型为UID  还有一种拉黑是拉黑IP地址</span></span><br><span class="line">    user.setTarget(uid.toString());</span><br><span class="line">    user.setType(BlackTypeEnum.UID.getType());</span><br><span class="line">    <span class="comment">//调用blackDao中的save方法 插入一条用户数据到Black表中</span></span><br><span class="line">    </span><br><span class="line">    blackDao.save(user);</span><br><span class="line">    <span class="comment">//查询用户表中的UID用户 </span></span><br><span class="line">    <span class="type">User</span> <span class="variable">byId</span> <span class="operator">=</span> userDao.getById(uid);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//拉黑IP地址 一个是创建用户IP地址 一个是最后更新用户的IP地址 两个IP都拉黑</span></span><br><span class="line">    blackIp(byId.getIpInfo().getCreateIp());</span><br><span class="line">    blackIp(byId.getIpInfo().getUpdateIp());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//发布一条事件 一个用户拉黑事件</span></span><br><span class="line">    applicationEventPublisher.publishEvent(<span class="keyword">new</span> <span class="title class_">UserBlackEvent</span>(<span class="built_in">this</span>, byId));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h4 id="blackIp"   >
          <a href="#blackIp" class="heading-link"><i class="fas fa-link"></i></a><a href="#blackIp" class="headerlink" title="blackIp"></a>blackIp</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">blackIp</span><span class="params">(String ip)</span> &#123;</span><br><span class="line">    <span class="comment">//判断IP是否为空，如果为空则直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isBlank(ip)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//创建一个拉黑用户</span></span><br><span class="line">        <span class="type">Black</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Black</span>();</span><br><span class="line">        <span class="comment">//设置IP地址</span></span><br><span class="line">        user.setTarget(ip);</span><br><span class="line">        user.setType(BlackTypeEnum.IP.getType());</span><br><span class="line">        <span class="comment">//更新黑名单表</span></span><br><span class="line">        blackDao.save(user);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;duplicate black ip:&#123;&#125;&quot;</span>, ip);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="hasPower"   >
          <a href="#hasPower" class="heading-link"><i class="fas fa-link"></i></a><a href="#hasPower" class="headerlink" title="hasPower"></a>hasPower</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasPower</span><span class="params">(Long uid, RoleEnum roleEnum)</span> &#123;<span class="comment">//超级管理员无敌的好吧，后期做成权限=》资源模式</span></span><br><span class="line">    Set&lt;Long&gt; roleSet = userCache.getRoleSet(uid);</span><br><span class="line">    <span class="keyword">return</span> isAdmin(roleSet) || roleSet.contains(roleEnum.getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="getRoleSet"   >
          <a href="#getRoleSet" class="heading-link"><i class="fas fa-link"></i></a><a href="#getRoleSet" class="headerlink" title="getRoleSet"></a>getRoleSet</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Cacheable(cacheNames = &quot;user&quot;, key = &quot;&#x27;roles&#x27;+#uid&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Set&lt;Long&gt; <span class="title function_">getRoleSet</span><span class="params">(Long uid)</span> &#123;</span><br><span class="line">    <span class="comment">//查询数据库判断是否有管理员身份</span></span><br><span class="line">    List&lt;UserRole&gt; userRoles = userRoleDao.listByUid(uid);</span><br><span class="line">    <span class="comment">//将用户身份返回一个set</span></span><br><span class="line">    <span class="keyword">return</span> userRoles.stream()</span><br><span class="line">            .map(UserRole::getRoleId)</span><br><span class="line">            .collect(Collectors.toSet());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="listByUid"   >
          <a href="#listByUid" class="heading-link"><i class="fas fa-link"></i></a><a href="#listByUid" class="headerlink" title="listByUid"></a>listByUid</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;UserRole&gt; <span class="title function_">listByUid</span><span class="params">(Long uid)</span> &#123;</span><br><span class="line">    <span class="comment">//查询user_role表 通过uid来查询身份 返回集合</span></span><br><span class="line">    <span class="keyword">return</span> lambdaQuery()</span><br><span class="line">            .eq(UserRole::getUid, Objects.requireNonNull(uid))</span><br><span class="line">            .list();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="流程-4"   >
          <a href="#流程-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#流程-4" class="headerlink" title="流程"></a>流程</h4>
      <p>①判断目标拉黑用户是否是管理员，如果是管理员则没有权限拉黑抛出异常结束方法，如果不是管理员则继续拉黑操作</p>
<p>②插入一条拉黑用户信息到拉黑数据表中 先是拉黑UID</p>
<p>③再判断创造用户时IP是否存在，如果存在则插入一条创建IP地址的拉黑用户信息</p>
<p>④再判断更新用户时IP是否存在，如果存在则插入一条更新IP地址的拉黑用户信息</p>
<p>⑤发布一条事件，用户拉黑事件</p>

        <h3 id="徽章聚合信息"   >
          <a href="#徽章聚合信息" class="heading-link"><i class="fas fa-link"></i></a><a href="#徽章聚合信息" class="headerlink" title="徽章聚合信息"></a>徽章聚合信息</h3>
      <div class="table-container"><table>
<thead>
<tr>
<th>访问URI</th>
<th>请求类型</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;capi&#x2F;user&#x2F;public&#x2F;badges&#x2F;batch</td>
<td>POST请求</td>
</tr>
</tbody></table></div>

        <h4 id="Controller层-5"   >
          <a href="#Controller层-5" class="heading-link"><i class="fas fa-link"></i></a><a href="#Controller层-5" class="headerlink" title="Controller层"></a>Controller层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/public/badges/batch&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;徽章聚合信息-返回的代表需要刷新的&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ApiResult&lt;List&lt;ItemInfoDTO&gt;&gt; <span class="title function_">getItemInfo</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> ItemInfoReq req)</span> &#123;</span><br><span class="line">    <span class="comment">//调用service层中的getItemInfo方法</span></span><br><span class="line">    <span class="keyword">return</span> ApiResult.success(userService.getItemInfo(req));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="Service层-3"   >
          <a href="#Service层-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#Service层-3" class="headerlink" title="Service层"></a>Service层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;ItemInfoDTO&gt; <span class="title function_">getItemInfo</span><span class="params">(ItemInfoReq req)</span>;</span><br></pre></td></tr></table></div></figure>

<p>实现类中</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;ItemInfoDTO&gt; <span class="title function_">getItemInfo</span><span class="params">(ItemInfoReq req)</span> &#123;<span class="comment">//简单做，更新时间可判断被修改</span></span><br><span class="line">    <span class="comment">//req.getReqList中包含itemId(物品id)，ItemModifyTime(修改时间)</span></span><br><span class="line">    <span class="keyword">return</span> req.getReqList().stream().map(a -&gt; &#123;</span><br><span class="line">        <span class="comment">//查询itemCache调用getById方法获取ItemConfig</span></span><br><span class="line">        <span class="type">ItemConfig</span> <span class="variable">itemConfig</span> <span class="operator">=</span> itemCache.getById(a.getItemId());</span><br><span class="line">        <span class="comment">//如果修改时间非空 并且最后修改时间要在物品更新时间之后 也即合法</span></span><br><span class="line">        <span class="keyword">if</span> (Objects.nonNull(a.getLastModifyTime()) &amp;&amp; a.getLastModifyTime() &gt;= itemConfig.getUpdateTime().getTime()) &#123;</span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="keyword">return</span> ItemInfoDTO.skip(a.getItemId());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//修改时间为空或者修改时间不合法</span></span><br><span class="line">        <span class="type">ItemInfoDTO</span> <span class="variable">dto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ItemInfoDTO</span>();</span><br><span class="line">        <span class="comment">//设置ItemId，Img,Describe</span></span><br><span class="line">        dto.setItemId(itemConfig.getId());</span><br><span class="line">        dto.setImg(itemConfig.getImg());</span><br><span class="line">        dto.setDescribe(itemConfig.getDescribe());</span><br><span class="line">        <span class="comment">//封装成dto</span></span><br><span class="line">        <span class="keyword">return</span> dto;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="getById"   >
          <a href="#getById" class="heading-link"><i class="fas fa-link"></i></a><a href="#getById" class="headerlink" title="getById"></a>getById</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Cacheable(cacheNames = &quot;item&quot;, key = &quot;&#x27;item:&#x27;+#itemId&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ItemConfig <span class="title function_">getById</span><span class="params">(Long itemId)</span> &#123;</span><br><span class="line">    <span class="comment">//SELECT id,type,img,`describe`,create_time,update_time FROM item_config WHERE id=?</span></span><br><span class="line">    <span class="keyword">return</span> itemConfigDao.getById(itemId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="skip"   >
          <a href="#skip" class="heading-link"><i class="fas fa-link"></i></a><a href="#skip" class="headerlink" title="skip"></a>skip</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ItemInfoDTO <span class="title function_">skip</span><span class="params">(Long itemId)</span> &#123;</span><br><span class="line">        <span class="type">ItemInfoDTO</span> <span class="variable">dto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ItemInfoDTO</span>();</span><br><span class="line">    	<span class="comment">//设置ItemID，类型为不需要刷新类型</span></span><br><span class="line">        dto.setItemId(itemId);</span><br><span class="line">        dto.setNeedRefresh(Boolean.FALSE);</span><br><span class="line">        <span class="keyword">return</span> dto;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>




        <h3 id="用户聚合信息"   >
          <a href="#用户聚合信息" class="heading-link"><i class="fas fa-link"></i></a><a href="#用户聚合信息" class="headerlink" title="用户聚合信息"></a>用户聚合信息</h3>
      <div class="table-container"><table>
<thead>
<tr>
<th>访问URI</th>
<th>请求类型</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;public&#x2F;summary&#x2F;userInfo&#x2F;batc</td>
<td>POST请求</td>
</tr>
</tbody></table></div>

        <h4 id="Controller层-6"   >
          <a href="#Controller层-6" class="heading-link"><i class="fas fa-link"></i></a><a href="#Controller层-6" class="headerlink" title="Controller层"></a>Controller层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/public/summary/userInfo/batch&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;用户聚合信息-返回的代表需要刷新的&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ApiResult&lt;List&lt;SummeryInfoDTO&gt;&gt; <span class="title function_">getSummeryUserInfo</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> SummeryInfoReq req)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> ApiResult.success(userService.getSummeryUserInfo(req));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h4 id="Service层-4"   >
          <a href="#Service层-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#Service层-4" class="headerlink" title="Service层"></a>Service层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;SummeryInfoDTO&gt; <span class="title function_">getSummeryUserInfo</span><span class="params">(SummeryInfoReq req)</span>;</span><br></pre></td></tr></table></div></figure>

<p>实现类中</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;SummeryInfoDTO&gt; <span class="title function_">getSummeryUserInfo</span><span class="params">(SummeryInfoReq req)</span> &#123;</span><br><span class="line">    <span class="comment">//获取用户uidList</span></span><br><span class="line">    List&lt;Long&gt; uidList = getNeedSyncUidList(req.getReqList());</span><br><span class="line">    <span class="comment">//加载用户信息</span></span><br><span class="line">    Map&lt;Long, SummeryInfoDTO&gt; batch = userSummaryCache.getBatch(uidList);</span><br><span class="line">    <span class="comment">//返回数据</span></span><br><span class="line">    <span class="keyword">return</span> req.getReqList()</span><br><span class="line">            .stream()</span><br><span class="line">            .map(a -&gt; batch.containsKey(a.getUid()) ? batch.get(a.getUid():SummeryInfoDTO.skip(a.getUid()))</span><br><span class="line">                 <span class="comment">//判断cache中是否有uid如果有则直接调用cache的，如果没有则封装成dto返回</span></span><br><span class="line">            .filter(Objects::nonNull)</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="skip-1"   >
          <a href="#skip-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#skip-1" class="headerlink" title="skip"></a>skip</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> SummeryInfoDTO <span class="title function_">skip</span><span class="params">(Long uid)</span> &#123;</span><br><span class="line">    <span class="type">SummeryInfoDTO</span> <span class="variable">dto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SummeryInfoDTO</span>();</span><br><span class="line">    dto.setUid(uid);</span><br><span class="line">    dto.setNeedRefresh(Boolean.FALSE);</span><br><span class="line">    <span class="keyword">return</span> dto;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="总览"   >
          <a href="#总览" class="heading-link"><i class="fas fa-link"></i></a><a href="#总览" class="headerlink" title="总览"></a>总览</h3>
      
        <h4 id="UserController"   >
          <a href="#UserController" class="heading-link"><i class="fas fa-link"></i></a><a href="#UserController" class="headerlink" title="UserController"></a>UserController</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/capi/user&quot;)</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;用户管理相关接口&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IRoleService iRoleService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/userInfo&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;用户详情&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ApiResult&lt;UserInfoResp&gt; <span class="title function_">getUserInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ApiResult.success(userService.getUserInfo(RequestHolder.get().getUid()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/public/summary/userInfo/batch&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;用户聚合信息-返回的代表需要刷新的&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ApiResult&lt;List&lt;SummeryInfoDTO&gt;&gt; <span class="title function_">getSummeryUserInfo</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> SummeryInfoReq req)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ApiResult.success(userService.getSummeryUserInfo(req));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/public/badges/batch&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;徽章聚合信息-返回的代表需要刷新的&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ApiResult&lt;List&lt;ItemInfoDTO&gt;&gt; <span class="title function_">getItemInfo</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> ItemInfoReq req)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ApiResult.success(userService.getItemInfo(req));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PutMapping(&quot;/name&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;修改用户名&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ApiResult&lt;Void&gt; <span class="title function_">modifyName</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> ModifyNameReq req)</span> &#123;</span><br><span class="line">        userService.modifyName(RequestHolder.get().getUid(), req);</span><br><span class="line">        <span class="keyword">return</span> ApiResult.success();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/badges&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;可选徽章预览&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ApiResult&lt;List&lt;BadgeResp&gt;&gt; <span class="title function_">badges</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ApiResult.success(userService.badges(RequestHolder.get().getUid()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PutMapping(&quot;/badge&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;佩戴徽章&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ApiResult&lt;Void&gt; <span class="title function_">wearingBadge</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> WearingBadgeReq req)</span> &#123;</span><br><span class="line">        userService.wearingBadge(RequestHolder.get().getUid(), req);</span><br><span class="line">        <span class="keyword">return</span> ApiResult.success();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PutMapping(&quot;/black&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;拉黑用户&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ApiResult&lt;Void&gt; <span class="title function_">black</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> BlackReq req)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">uid</span> <span class="operator">=</span> RequestHolder.get().getUid();</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">hasPower</span> <span class="operator">=</span> iRoleService.hasPower(uid, RoleEnum.ADMIN);</span><br><span class="line">        AssertUtil.isTrue(hasPower, <span class="string">&quot;没有权限&quot;</span>);</span><br><span class="line">        userService.black(req);</span><br><span class="line">        <span class="keyword">return</span> ApiResult.success();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="UserService"   >
          <a href="#UserService" class="heading-link"><i class="fas fa-link"></i></a><a href="#UserService" class="headerlink" title="UserService"></a>UserService</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取前端展示信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> uid</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    UserInfoResp <span class="title function_">getUserInfo</span><span class="params">(Long uid)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改用户名</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> uid</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> req</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">modifyName</span><span class="params">(Long uid, ModifyNameReq req)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户徽章列表</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> uid</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;BadgeResp&gt; <span class="title function_">badges</span><span class="params">(Long uid)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 佩戴徽章</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> uid</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> req</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">wearingBadge</span><span class="params">(Long uid, WearingBadgeReq req)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户注册</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> openId</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(String openId)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">black</span><span class="params">(BlackReq req)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取用户汇总信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> req</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;SummeryInfoDTO&gt; <span class="title function_">getSummeryUserInfo</span><span class="params">(SummeryInfoReq req)</span>;</span><br><span class="line"></span><br><span class="line">    List&lt;ItemInfoDTO&gt; <span class="title function_">getItemInfo</span><span class="params">(ItemInfoReq req)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h4 id="UserServiceImpl"   >
          <a href="#UserServiceImpl" class="heading-link"><i class="fas fa-link"></i></a><a href="#UserServiceImpl" class="headerlink" title="UserServiceImpl"></a>UserServiceImpl</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserCache userCache;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserBackpackDao userBackpackDao;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ItemConfigDao itemConfigDao;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ApplicationEventPublisher applicationEventPublisher;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ItemCache itemCache;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BlackDao blackDao;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserSummaryCache userSummaryCache;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SensitiveWordBs sensitiveWordBs;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserInfoResp <span class="title function_">getUserInfo</span><span class="params">(Long uid)</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">userInfo</span> <span class="operator">=</span> userCache.getUserInfo(uid);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">countByValidItemId</span> <span class="operator">=</span> userBackpackDao.getCountByValidItemId(uid, ItemEnum.MODIFY_NAME_CARD.getId());</span><br><span class="line">        <span class="keyword">return</span> UserAdapter.buildUserInfoResp(userInfo, countByValidItemId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">modifyName</span><span class="params">(Long uid, ModifyNameReq req)</span> &#123;</span><br><span class="line">        <span class="comment">//判断名字是不是重复</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">newName</span> <span class="operator">=</span> req.getName();</span><br><span class="line">        AssertUtil.isFalse(sensitiveWordBs.hasSensitiveWord(newName), <span class="string">&quot;名字中包含敏感词，请重新输入&quot;</span>); <span class="comment">// 判断名字中有没有敏感词</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">oldUser</span> <span class="operator">=</span> userDao.getByName(newName);</span><br><span class="line">        AssertUtil.isEmpty(oldUser, <span class="string">&quot;名字已经被抢占了，请换一个哦~~&quot;</span>);</span><br><span class="line">        <span class="comment">//判断改名卡够不够</span></span><br><span class="line">        <span class="type">UserBackpack</span> <span class="variable">firstValidItem</span> <span class="operator">=</span> userBackpackDao.getFirstValidItem(uid, ItemEnum.MODIFY_NAME_CARD.getId());</span><br><span class="line">        AssertUtil.isNotEmpty(firstValidItem, <span class="string">&quot;改名次数不够了，等后续活动送改名卡哦&quot;</span>);</span><br><span class="line">        <span class="comment">//使用改名卡</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">useSuccess</span> <span class="operator">=</span> userBackpackDao.invalidItem(firstValidItem.getId());</span><br><span class="line">        <span class="keyword">if</span> (useSuccess) &#123;<span class="comment">//用乐观锁，就不用分布式锁了</span></span><br><span class="line">            <span class="comment">//改名</span></span><br><span class="line">            userDao.modifyName(uid, req.getName());</span><br><span class="line">            <span class="comment">//删除缓存</span></span><br><span class="line">            userCache.userInfoChange(uid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;BadgeResp&gt; <span class="title function_">badges</span><span class="params">(Long uid)</span> &#123;</span><br><span class="line">        <span class="comment">//查询所有徽章</span></span><br><span class="line">        List&lt;ItemConfig&gt; itemConfigs = itemCache.getByType(ItemTypeEnum.BADGE.getType());</span><br><span class="line">        <span class="comment">//查询用户拥有的徽章</span></span><br><span class="line">        List&lt;UserBackpack&gt; backpacks = userBackpackDao.getByItemIds(uid, itemConfigs.stream().map(ItemConfig::getId).collect(Collectors.toList()));</span><br><span class="line">        <span class="comment">//查询用户当前佩戴的标签</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userDao.getById(uid);</span><br><span class="line">        <span class="keyword">return</span> UserAdapter.buildBadgeResp(itemConfigs, backpacks, user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">wearingBadge</span><span class="params">(Long uid, WearingBadgeReq req)</span> &#123;</span><br><span class="line">        <span class="comment">//确保有这个徽章</span></span><br><span class="line">        <span class="type">UserBackpack</span> <span class="variable">firstValidItem</span> <span class="operator">=</span> userBackpackDao.getFirstValidItem(uid, req.getBadgeId());</span><br><span class="line">        AssertUtil.isNotEmpty(firstValidItem, <span class="string">&quot;您没有这个徽章哦，快去达成条件获取吧&quot;</span>);</span><br><span class="line">        <span class="comment">//确保物品类型是徽章</span></span><br><span class="line">        <span class="type">ItemConfig</span> <span class="variable">itemConfig</span> <span class="operator">=</span> itemConfigDao.getById(firstValidItem.getItemId());</span><br><span class="line">        AssertUtil.equal(itemConfig.getType(), ItemTypeEnum.BADGE.getType(), <span class="string">&quot;该徽章不可佩戴&quot;</span>);</span><br><span class="line">        <span class="comment">//佩戴徽章</span></span><br><span class="line">        userDao.wearingBadge(uid, req.getBadgeId());</span><br><span class="line">        <span class="comment">//删除用户缓存</span></span><br><span class="line">        userCache.userInfoChange(uid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(String openId)</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">insert</span> <span class="operator">=</span> User.builder().openId(openId).build();</span><br><span class="line">        userDao.save(insert);</span><br><span class="line">        applicationEventPublisher.publishEvent(<span class="keyword">new</span> <span class="title class_">UserRegisterEvent</span>(<span class="built_in">this</span>, insert));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">black</span><span class="params">(BlackReq req)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">uid</span> <span class="operator">=</span> req.getUid();</span><br><span class="line">        <span class="type">Black</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Black</span>();</span><br><span class="line">        user.setTarget(uid.toString());</span><br><span class="line">        user.setType(BlackTypeEnum.UID.getType());</span><br><span class="line">        blackDao.save(user);</span><br><span class="line">        <span class="type">User</span> <span class="variable">byId</span> <span class="operator">=</span> userDao.getById(uid);</span><br><span class="line">        blackIp(byId.getIpInfo().getCreateIp());</span><br><span class="line">        blackIp(byId.getIpInfo().getUpdateIp());</span><br><span class="line">        applicationEventPublisher.publishEvent(<span class="keyword">new</span> <span class="title class_">UserBlackEvent</span>(<span class="built_in">this</span>, byId));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;SummeryInfoDTO&gt; <span class="title function_">getSummeryUserInfo</span><span class="params">(SummeryInfoReq req)</span> &#123;</span><br><span class="line">        <span class="comment">//需要前端同步的uid</span></span><br><span class="line">        List&lt;Long&gt; uidList = getNeedSyncUidList(req.getReqList());</span><br><span class="line">        <span class="comment">//加载用户信息</span></span><br><span class="line">        Map&lt;Long, SummeryInfoDTO&gt; batch = userSummaryCache.getBatch(uidList);</span><br><span class="line">        <span class="keyword">return</span> req.getReqList()</span><br><span class="line">                .stream()</span><br><span class="line">                .map(a -&gt; batch.containsKey(a.getUid()) ? batch.get(a.getUid()) : SummeryInfoDTO.skip(a.getUid()))</span><br><span class="line">                .filter(Objects::nonNull)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;ItemInfoDTO&gt; <span class="title function_">getItemInfo</span><span class="params">(ItemInfoReq req)</span> &#123;<span class="comment">//简单做，更新时间可判断被修改</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> req.getReqList().stream().map(a -&gt; &#123;</span><br><span class="line">            <span class="type">ItemConfig</span> <span class="variable">itemConfig</span> <span class="operator">=</span> itemCache.getById(a.getItemId());</span><br><span class="line">            <span class="keyword">if</span> (Objects.nonNull(a.getLastModifyTime()) &amp;&amp; a.getLastModifyTime() &gt;= itemConfig.getUpdateTime().getTime()) &#123;</span><br><span class="line">                <span class="keyword">return</span> ItemInfoDTO.skip(a.getItemId());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">ItemInfoDTO</span> <span class="variable">dto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ItemInfoDTO</span>();</span><br><span class="line">            dto.setItemId(itemConfig.getId());</span><br><span class="line">            dto.setImg(itemConfig.getImg());</span><br><span class="line">            dto.setDescribe(itemConfig.getDescribe());</span><br><span class="line">            <span class="keyword">return</span> dto;</span><br><span class="line">        &#125;).collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Long&gt; <span class="title function_">getNeedSyncUidList</span><span class="params">(List&lt;SummeryInfoReq.infoReq&gt; reqList)</span> &#123;</span><br><span class="line">        List&lt;Long&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        List&lt;Long&gt; userModifyTime = userCache.getUserModifyTime(reqList.stream().map(SummeryInfoReq.infoReq::getUid).collect(Collectors.toList()));</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; reqList.size(); i++) &#123;</span><br><span class="line">            SummeryInfoReq.<span class="type">infoReq</span> <span class="variable">infoReq</span> <span class="operator">=</span> reqList.get(i);</span><br><span class="line">            <span class="type">Long</span> <span class="variable">modifyTime</span> <span class="operator">=</span> userModifyTime.get(i);</span><br><span class="line">            <span class="keyword">if</span> (Objects.isNull(infoReq.getLastModifyTime()) || (Objects.nonNull(modifyTime) &amp;&amp; modifyTime &gt; infoReq.getLastModifyTime())) &#123;</span><br><span class="line">                result.add(infoReq.getUid());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">blackIp</span><span class="params">(String ip)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isBlank(ip)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Black</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Black</span>();</span><br><span class="line">            user.setTarget(ip);</span><br><span class="line">            user.setType(BlackTypeEnum.IP.getType());</span><br><span class="line">            blackDao.save(user);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;duplicate black ip:&#123;&#125;&quot;</span>, ip);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="用户模块中的功能"   >
          <a href="#用户模块中的功能" class="heading-link"><i class="fas fa-link"></i></a><a href="#用户模块中的功能" class="headerlink" title="用户模块中的功能"></a>用户模块中的功能</h4>
      
        <h5 id="用户模块-1"   >
          <a href="#用户模块-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#用户模块-1" class="headerlink" title="用户模块"></a>用户模块</h5>
      
        <h5 id="黑名单模块"   >
          <a href="#黑名单模块" class="heading-link"><i class="fas fa-link"></i></a><a href="#黑名单模块" class="headerlink" title="黑名单模块"></a>黑名单模块</h5>
      
        <h5 id="徽章发放模块"   >
          <a href="#徽章发放模块" class="heading-link"><i class="fas fa-link"></i></a><a href="#徽章发放模块" class="headerlink" title="徽章发放模块"></a>徽章发放模块</h5>
      
        <h2 id="微信扫码登录"   >
          <a href="#微信扫码登录" class="heading-link"><i class="fas fa-link"></i></a><a href="#微信扫码登录" class="headerlink" title="微信扫码登录"></a>微信扫码登录</h2>
      
        <h3 id="WxPortalController层"   >
          <a href="#WxPortalController层" class="heading-link"><i class="fas fa-link"></i></a><a href="#WxPortalController层" class="headerlink" title="WxPortalController层"></a>WxPortalController层</h3>
      
        <h4 id="post"   >
          <a href="#post" class="heading-link"><i class="fas fa-link"></i></a><a href="#post" class="headerlink" title="post"></a>post</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(produces = &quot;application/xml; charset=UTF-8&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">post</span><span class="params">(<span class="meta">@RequestBody</span> String requestBody,</span></span><br><span class="line"><span class="params">                       <span class="meta">@RequestParam(&quot;signature&quot;)</span> String signature,</span></span><br><span class="line"><span class="params">                       <span class="meta">@RequestParam(&quot;timestamp&quot;)</span> String timestamp,</span></span><br><span class="line"><span class="params">                       <span class="meta">@RequestParam(&quot;nonce&quot;)</span> String nonce,</span></span><br><span class="line"><span class="params">                       <span class="meta">@RequestParam(&quot;openid&quot;)</span> String openid,</span></span><br><span class="line"><span class="params">                       <span class="meta">@RequestParam(name = &quot;encrypt_type&quot;, required = false)</span> String encType,</span></span><br><span class="line"><span class="params">                       <span class="meta">@RequestParam(name = &quot;msg_signature&quot;, required = false)</span> String msgSignature)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;\n接收微信请求：[openid=[&#123;&#125;], [signature=[&#123;&#125;], encType=[&#123;&#125;], msgSignature=[&#123;&#125;],&quot;</span></span><br><span class="line">                        + <span class="string">&quot; timestamp=[&#123;&#125;], nonce=[&#123;&#125;], requestBody=[\n&#123;&#125;\n] &quot;</span>,</span><br><span class="line">                openid, signature, encType, msgSignature, timestamp, nonce, requestBody);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!wxService.checkSignature(timestamp, nonce, signature)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;非法请求，可能属于伪造的请求！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">out</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (encType == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 明文传输的消息</span></span><br><span class="line">            <span class="type">WxMpXmlMessage</span> <span class="variable">inMessage</span> <span class="operator">=</span> WxMpXmlMessage.fromXml(requestBody);</span><br><span class="line">            <span class="type">WxMpXmlOutMessage</span> <span class="variable">outMessage</span> <span class="operator">=</span> <span class="built_in">this</span>.route(inMessage);</span><br><span class="line">            <span class="keyword">if</span> (outMessage == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            out = outMessage.toXml();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;aes&quot;</span>.equalsIgnoreCase(encType)) &#123;</span><br><span class="line">            <span class="comment">// aes加密的消息</span></span><br><span class="line">            <span class="type">WxMpXmlMessage</span> <span class="variable">inMessage</span> <span class="operator">=</span> WxMpXmlMessage.fromEncryptedXml(requestBody, wxService.getWxMpConfigStorage(),</span><br><span class="line">                    timestamp, nonce, msgSignature);</span><br><span class="line">            log.debug(<span class="string">&quot;\n消息解密后内容为：\n&#123;&#125; &quot;</span>, inMessage.toString());</span><br><span class="line">            <span class="type">WxMpXmlOutMessage</span> <span class="variable">outMessage</span> <span class="operator">=</span> <span class="built_in">this</span>.route(inMessage);</span><br><span class="line">            <span class="keyword">if</span> (outMessage == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            out = outMessage.toEncryptedXml(wxService.getWxMpConfigStorage());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        log.debug(<span class="string">&quot;\n组装回复信息：&#123;&#125;&quot;</span>, out);</span><br><span class="line">        <span class="keyword">return</span> out;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="authGet"   >
          <a href="#authGet" class="heading-link"><i class="fas fa-link"></i></a><a href="#authGet" class="headerlink" title="authGet"></a>authGet</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//这个方法用于微信服务器与自己内网的后端代码建立连接</span></span><br><span class="line"><span class="meta">@GetMapping(produces = &quot;text/plain;charset=utf-8&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">authGet</span><span class="params">(<span class="meta">@RequestParam(name = &quot;signature&quot;, required = false)</span> String signature,</span></span><br><span class="line"><span class="params">                      <span class="meta">@RequestParam(name = &quot;timestamp&quot;, required = false)</span> String timestamp,</span></span><br><span class="line"><span class="params">                      <span class="meta">@RequestParam(name = &quot;nonce&quot;, required = false)</span> String nonce,</span></span><br><span class="line"><span class="params">                      <span class="meta">@RequestParam(name = &quot;echostr&quot;, required = false)</span> String echostr)</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//传入参数1.微信加密签名 2.时间戳 3.随机数 4.随机字符串</span></span><br><span class="line">    log.info(<span class="string">&quot;\n接收到来自微信服务器的认证消息：[&#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;]&quot;</span>, signature,</span><br><span class="line">            timestamp, nonce, echostr);</span><br><span class="line">    <span class="comment">//如果为空则抛出异常</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isAnyBlank(signature, timestamp, nonce, echostr)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;请求参数非法，请核实!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//微信校验</span></span><br><span class="line">    <span class="keyword">if</span> (wxService.checkSignature(timestamp, nonce, signature)) &#123;</span><br><span class="line">        <span class="keyword">return</span> echostr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;非法请求&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="callBack"   >
          <a href="#callBack" class="heading-link"><i class="fas fa-link"></i></a><a href="#callBack" class="headerlink" title="callBack"></a>callBack</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//回调函数</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/callBack&quot;)</span></span><br><span class="line"><span class="keyword">public</span> RedirectView <span class="title function_">callBack</span><span class="params">(<span class="meta">@RequestParam</span> String code)</span> <span class="keyword">throws</span> WxErrorException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">WxOAuth2AccessToken</span> <span class="variable">accessToken</span> <span class="operator">=</span> wxService.getOAuth2Service().getAccessToken(code);</span><br><span class="line">        <span class="type">WxOAuth2UserInfo</span> <span class="variable">userInfo</span> <span class="operator">=</span> wxService.getOAuth2Service().getUserInfo(accessToken, <span class="string">&quot;zh_CN&quot;</span>);</span><br><span class="line">        wxMsgService.authorize(userInfo);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;callBack error&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//重定向</span></span><br><span class="line">    <span class="type">RedirectView</span> <span class="variable">redirectView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedirectView</span>();</span><br><span class="line">    <span class="comment">//重定向uri</span></span><br><span class="line">    redirectView.setUrl(<span class="string">&quot;https://mp.weixin.qq.com/s/m1SRsBG96kLJW5mPe4AVGA&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> redirectView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="WxMsgService"   >
          <a href="#WxMsgService" class="heading-link"><i class="fas fa-link"></i></a><a href="#WxMsgService" class="headerlink" title="WxMsgService"></a>WxMsgService</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WxMsgService</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户的openId和前端登录场景code的映射关系</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, Integer&gt; OPENID_EVENT_CODE_MAP = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">URL</span> <span class="operator">=</span> <span class="string">&quot;https://open.weixin.qq.com/connect/oauth2/authorize?appid=%s&amp;redirect_uri=%s&amp;response_type=code&amp;scope=snsapi_userinfo&amp;state=STATE#wechat_redirect&quot;</span>;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;wx.mp.callback&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String callback;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Lazy</span></span><br><span class="line">    <span class="keyword">private</span> WebSocketService webSocketService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LoginService loginService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ThreadPoolTaskExecutor threadPoolTaskExecutor;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> WxMpXmlOutMessage <span class="title function_">scan</span><span class="params">(WxMpService wxMpService, WxMpXmlMessage wxMpXmlMessage)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">fromUser</span> <span class="operator">=</span> wxMpXmlMessage.getFromUser();</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">eventKey</span> <span class="operator">=</span> Integer.parseInt(getEventKey(wxMpXmlMessage));</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userDao.getByOpenId(fromUser);</span><br><span class="line">        <span class="keyword">if</span> (Objects.nonNull(user) &amp;&amp; StringUtils.isNotEmpty(user.getAvatar())) &#123;</span><br><span class="line">            <span class="comment">//注册且已经授权的用户，直接登录成功</span></span><br><span class="line">            login(user.getId(), eventKey);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(user)) &#123;</span><br><span class="line">            <span class="comment">//未注册的先注册</span></span><br><span class="line">            userService.register(fromUser);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//保存openid和场景code的关系，后续才能通知到前端</span></span><br><span class="line">        OPENID_EVENT_CODE_MAP.put(fromUser, eventKey);</span><br><span class="line">        <span class="comment">//授权流程,给用户发送授权消息，并且异步通知前端扫码成功</span></span><br><span class="line">        threadPoolTaskExecutor.execute(() -&gt; webSocketService.scanSuccess(eventKey));</span><br><span class="line">        <span class="type">String</span> <span class="variable">skipUrl</span> <span class="operator">=</span> String.format(URL, wxMpService.getWxMpConfigStorage().getAppId(), URLEncoder.encode(callback + <span class="string">&quot;/wx/portal/public/callBack&quot;</span>));</span><br><span class="line">        WxMpXmlOutMessage.TEXT().build();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TextBuilder</span>().build(<span class="string">&quot;请点击链接授权：&lt;a href=\&quot;&quot;</span> + skipUrl + <span class="string">&quot;\&quot;&gt;登录&lt;/a&gt;&quot;</span>, wxMpXmlMessage, wxMpService);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getEventKey</span><span class="params">(WxMpXmlMessage wxMpXmlMessage)</span> &#123;</span><br><span class="line">        <span class="comment">//扫码关注的渠道事件有前缀，需要去除</span></span><br><span class="line">        <span class="keyword">return</span> wxMpXmlMessage.getEventKey().replace(<span class="string">&quot;qrscene_&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户授权</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userInfo</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">authorize</span><span class="params">(WxOAuth2UserInfo userInfo)</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userDao.getByOpenId(userInfo.getOpenid());</span><br><span class="line">        <span class="comment">//更新用户信息</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(user.getName())) &#123;</span><br><span class="line">            fillUserInfo(user.getId(), userInfo);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//触发用户登录成功操作</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">eventKey</span> <span class="operator">=</span> OPENID_EVENT_CODE_MAP.get(userInfo.getOpenid());</span><br><span class="line">        login(user.getId(), eventKey);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">fillUserInfo</span><span class="params">(Long uid, WxOAuth2UserInfo userInfo)</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">update</span> <span class="operator">=</span> UserAdapter.buildAuthorizeUser(uid, userInfo);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                userDao.updateById(update);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (DuplicateKeyException e) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;fill userInfo duplicate uid:&#123;&#125;,info:&#123;&#125;&quot;</span>, uid, userInfo);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;fill userInfo fail uid:&#123;&#125;,info:&#123;&#125;&quot;</span>, uid, userInfo);</span><br><span class="line">            &#125;</span><br><span class="line">            update.setName(<span class="string">&quot;名字重置&quot;</span> + RandomUtil.randomInt(<span class="number">100000</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">login</span><span class="params">(Long uid, Integer eventKey)</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userDao.getById(uid);</span><br><span class="line">        <span class="comment">//调用用户登录模块</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> loginService.login(uid);</span><br><span class="line">        <span class="comment">//推送前端登录成功</span></span><br><span class="line">        webSocketService.scanLoginSuccess(eventKey, user, token);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="流程-5"   >
          <a href="#流程-5" class="heading-link"><i class="fas fa-link"></i></a><a href="#流程-5" class="headerlink" title="流程"></a>流程</h3>
      
        <h4 id="前端和后端建立一个WebSocket连接"   >
          <a href="#前端和后端建立一个WebSocket连接" class="heading-link"><i class="fas fa-link"></i></a><a href="#前端和后端建立一个WebSocket连接" class="headerlink" title="前端和后端建立一个WebSocket连接"></a>前端和后端建立一个WebSocket连接</h4>
      <p>前端新建一个WebSocket连接，端口号是8090，然后后端通过netty记录并且管理连接</p>

        <h4 id="前端请求扫码登录"   >
          <a href="#前端请求扫码登录" class="heading-link"><i class="fas fa-link"></i></a><a href="#前端请求扫码登录" class="headerlink" title="前端请求扫码登录"></a>前端请求扫码登录</h4>
      <p><strong>后端</strong></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoginReq</span><span class="params">(Channel channel)</span> &#123;</span><br><span class="line">        <span class="comment">//生成随机不重复的登录码</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">code</span> <span class="operator">=</span> generateLoginCode(channel);</span><br><span class="line">        <span class="comment">//请求微信接口，获取登录码地址</span></span><br><span class="line">        <span class="type">WxMpQrCodeTicket</span> <span class="variable">wxMpQrCodeTicket</span> <span class="operator">=</span> wxMpService.getQrcodeService().qrCodeCreateTmpTicket(code, (<span class="type">int</span>) EXPIRE_TIME.getSeconds());</span><br><span class="line">        <span class="comment">//返回给前端</span></span><br><span class="line">        sendMsg(channel, WSAdapter.buildLoginResp(wxMpQrCodeTicket));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>

<p><strong>generateLoginCode</strong></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取不重复的登录的code，微信要求最大不超过int的存储极限</span></span><br><span class="line"><span class="comment"> * 防止并发，可以给方法加上synchronize，也可以使用cas乐观锁</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Integer <span class="title function_">generateLoginCode</span><span class="params">(Channel channel)</span> &#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        CODE.getAndIncrement();</span><br><span class="line">    &#125; <span class="keyword">while</span> (WAIT_LOGIN_MAP.asMap().containsKey(CODE.get())</span><br><span class="line">            || Objects.isNull(WAIT_LOGIN_MAP.get(CODE.get(), c -&gt; channel)));</span><br><span class="line">    <span class="keyword">return</span> CODE.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>也即后端会生成一个随机的登录码，这个登录码会和这个channal相连</p>
<p>然后将登录码发送到微信获取一个登录二维码链接</p>
<p>返回给前端一个二维码链接转换成二维码图片</p>
<p><strong>这样前端就获取了一个带有登录码的二维码图片</strong></p>

        <h4 id="用户扫码登录"   >
          <a href="#用户扫码登录" class="heading-link"><i class="fas fa-link"></i></a><a href="#用户扫码登录" class="headerlink" title="用户扫码登录"></a>用户扫码登录</h4>
      <p>用户扫码之后公众号会判断是关注还是扫码事件</p>
<p>无论是啥事件都会返回二维码参数，也就是登录码</p>

        <h4 id="用户注册"   >
          <a href="#用户注册" class="heading-link"><i class="fas fa-link"></i></a><a href="#用户注册" class="headerlink" title="用户注册"></a>用户注册</h4>
      <p>用户注册也就是一开始未关注，然后关注公众号之后</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> WxMpXmlOutMessage <span class="title function_">scan</span><span class="params">(WxMpService wxMpService, WxMpXmlMessage wxMpXmlMessage)</span> &#123;</span><br><span class="line">    <span class="comment">//获取用户openid</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">fromUser</span> <span class="operator">=</span> wxMpXmlMessage.getFromUser();</span><br><span class="line">    <span class="comment">//获取登录码</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">eventKey</span> <span class="operator">=</span> Integer.parseInt(getEventKey(wxMpXmlMessage));</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userDao.getByOpenId(fromUser);</span><br><span class="line">    <span class="keyword">if</span> (Objects.nonNull(user) &amp;&amp; StringUtils.isNotEmpty(user.getAvatar())) &#123;</span><br><span class="line">        <span class="comment">//注册且已经授权的用户，直接登录成功</span></span><br><span class="line">        login(user.getId(), eventKey);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (Objects.isNull(user)) &#123;</span><br><span class="line">        <span class="comment">//未注册的先注册</span></span><br><span class="line">        userService.register(fromUser);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//保存openid和场景code的关系，后续才能通知到前端</span></span><br><span class="line">    OPENID_EVENT_CODE_MAP.put(fromUser, eventKey);</span><br><span class="line">    <span class="comment">//授权流程,给用户发送授权消息，并且异步通知前端扫码成功</span></span><br><span class="line">    threadPoolTaskExecutor.execute(() -&gt; webSocketService.scanSuccess(eventKey));</span><br><span class="line">    <span class="type">String</span> <span class="variable">skipUrl</span> <span class="operator">=</span> String.format(URL, wxMpService.getWxMpConfigStorage().getAppId(), URLEncoder.encode(callback + <span class="string">&quot;/wx/portal/public/callBack&quot;</span>));</span><br><span class="line">    WxMpXmlOutMessage.TEXT().build();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TextBuilder</span>().build(<span class="string">&quot;请点击链接授权：&lt;a href=\&quot;&quot;</span> + skipUrl + <span class="string">&quot;\&quot;&gt;登录&lt;/a&gt;&quot;</span>, wxMpXmlMessage, wxMpService);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p><strong>login登录</strong></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">login</span><span class="params">(Long uid, Integer eventKey)</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userDao.getById(uid);</span><br><span class="line">    <span class="comment">//调用用户登录模块</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> loginService.login(uid);</span><br><span class="line">    <span class="comment">//推送前端登录成功</span></span><br><span class="line">    webSocketService.scanLoginSuccess(eventKey, user, token);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>



<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">login</span><span class="params">(Long uid)</span> &#123;</span><br><span class="line">       <span class="comment">//拼接一个Key</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisKey.getKey(RedisKey.USER_TOKEN_STRING, uid);</span><br><span class="line">	<span class="comment">//查询Redis 这个UserToken </span></span><br><span class="line">       <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> RedisUtils.getStr(key);</span><br><span class="line">       <span class="comment">//如果Token非空 那么就直接返回Token</span></span><br><span class="line">       <span class="keyword">if</span> (StrUtil.isNotBlank(token)) &#123;</span><br><span class="line">           <span class="keyword">return</span> token;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//运行到这里说明Token为空</span></span><br><span class="line">       </span><br><span class="line">       <span class="comment">//获取用户token</span></span><br><span class="line">       <span class="comment">//生成一个JWT令牌</span></span><br><span class="line">       token = jwtUtils.createToken(uid);</span><br><span class="line">       <span class="comment">//在Redis中设置这个token,初始化过期时间为5天</span></span><br><span class="line">       RedisUtils.set(key, token, TOKEN_EXPIRE_DAYS, TimeUnit.DAYS);<span class="comment">//token过期用redis中心化控制，初期采用5天过期，剩1天自动续期的方案。后续可以用双token实现</span></span><br><span class="line">       <span class="keyword">return</span> token;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></div></figure>

<p><strong>token续期操作</strong></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">@Async</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">renewalTokenIfNecessary</span><span class="params">(String token)</span> &#123;</span><br><span class="line"><span class="comment">//从token中获取uid</span></span><br><span class="line">      <span class="type">Long</span> <span class="variable">uid</span> <span class="operator">=</span> jwtUtils.getUidOrNull(token);</span><br><span class="line">      <span class="comment">//如果uid为空 那么直接返回</span></span><br><span class="line">      <span class="keyword">if</span> (Objects.isNull(uid)) &#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//拼接一个key</span></span><br><span class="line">      <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisKey.getKey(RedisKey.USER_TOKEN_STRING, uid);</span><br><span class="line">      <span class="comment">//获取这个key对应的过期时间</span></span><br><span class="line">      <span class="type">long</span> <span class="variable">expireDays</span> <span class="operator">=</span> RedisUtils.getExpire(key, TimeUnit.DAYS);</span><br><span class="line">      <span class="comment">//如果过期时间为-2 说明不存在key</span></span><br><span class="line">      <span class="keyword">if</span> (expireDays == -<span class="number">2</span>) &#123;<span class="comment">//不存在的key</span></span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">       <span class="comment">//如果过期时间&lt;TOKEN_RENEWAL_DAYS  也即过期时间小于2 那么就要续期</span></span><br><span class="line">      <span class="keyword">if</span> (expireDays &lt; TOKEN_RENEWAL_DAYS ) &#123;<span class="comment">//小于二天的token帮忙续期</span></span><br><span class="line">          <span class="comment">//续期token 每次续期5天</span></span><br><span class="line">          RedisUtils.expire(key, TOKEN_EXPIRE_DAYS, TimeUnit.DAYS);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p><strong>regist注册</strong></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(String openId)</span> &#123;</span><br><span class="line">        <span class="comment">//将openid放入User表中的openid</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">insert</span> <span class="operator">=</span> User.builder().openId(openId).build();</span><br><span class="line">        <span class="comment">//插入到User表中用户数据</span></span><br><span class="line">        userDao.save(insert);</span><br><span class="line">        <span class="comment">//推送一条用户注册的事件</span></span><br><span class="line">        applicationEventPublisher.publishEvent(<span class="keyword">new</span> <span class="title class_">UserRegisterEvent</span>(<span class="built_in">this</span>, insert));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>



<p>当用户注册完的时候，就会产生一个openid和登录码关联的临时关系</p>

        <h4 id="授权用户信息"   >
          <a href="#授权用户信息" class="heading-link"><i class="fas fa-link"></i></a><a href="#授权用户信息" class="headerlink" title="授权用户信息"></a>授权用户信息</h4>
      <p>公众号会推送一条用户授权链接，当用户点击链接会触发callback函数</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/callBack&quot;)</span></span><br><span class="line"><span class="keyword">public</span> RedirectView <span class="title function_">callBack</span><span class="params">(<span class="meta">@RequestParam</span> String code)</span> <span class="keyword">throws</span> WxErrorException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">WxOAuth2AccessToken</span> <span class="variable">accessToken</span> <span class="operator">=</span> wxService.getOAuth2Service().getAccessToken(code);</span><br><span class="line">        <span class="type">WxOAuth2UserInfo</span> <span class="variable">userInfo</span> <span class="operator">=</span> wxService.getOAuth2Service().getUserInfo(accessToken, <span class="string">&quot;zh_CN&quot;</span>);</span><br><span class="line">        wxMsgService.authorize(userInfo);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;callBack error&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//重定向uri</span></span><br><span class="line">    <span class="type">RedirectView</span> <span class="variable">redirectView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedirectView</span>();</span><br><span class="line">    redirectView.setUrl(<span class="string">&quot;https://mp.weixin.qq.com/s/m1SRsBG96kLJW5mPe4AVGA&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> redirectView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>我们通过回调函数获取userInfo  ，也即微信头像、昵称、openId等</p>
<p>获取用户授权信息之后再执行登录操作</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">authorize</span><span class="params">(WxOAuth2UserInfo userInfo)</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userDao.getByOpenId(userInfo.getOpenid());</span><br><span class="line">    <span class="comment">//更新用户信息</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isEmpty(user.getName())) &#123;</span><br><span class="line">        fillUserInfo(user.getId(), userInfo);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//触发用户登录成功操作</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">eventKey</span> <span class="operator">=</span> OPENID_EVENT_CODE_MAP.get(userInfo.getOpenid());</span><br><span class="line">    login(user.getId(), eventKey);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>那么因此就产生一个 uid对应一个Channal的关系</p>
<p>这个原因是可能一个微信可能pc和手机端同时登录mallchat，当两个设备都下线才能说明这个用户下线</p>

        <h4 id="后端主动消息推送"   >
          <a href="#后端主动消息推送" class="heading-link"><i class="fas fa-link"></i></a><a href="#后端主动消息推送" class="headerlink" title="后端主动消息推送"></a>后端主动消息推送</h4>
      <p>当有消息发送需要推送给全部用户</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Async</span></span><br><span class="line"><span class="meta">@TransactionalEventListener(classes = MessageSendEvent.class, fallbackExecution = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">notifyAllOnline</span><span class="params">(MessageSendEvent event)</span> &#123;</span><br><span class="line">    <span class="comment">//获取消息</span></span><br><span class="line">    <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> messageDao.getById(event.getMsgId());</span><br><span class="line">    <span class="comment">//判断这个消息接收到的uid， null说明为全部用户</span></span><br><span class="line">    <span class="type">ChatMessageResp</span> <span class="variable">msgResp</span> <span class="operator">=</span> chatService.getMsgResp(message, <span class="literal">null</span>);</span><br><span class="line">    <span class="comment">//调用sendToAllOnline发送给所有在线用户(除了自己)</span></span><br><span class="line">    webSocketService.sendToAllOnline(WSAdapter.buildMsgSend(msgResp), message.getFromUid());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>



<p>sendToAllOnline</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//entrySet的值不是快照数据,但是它支持遍历，所以无所谓了，不用快照也行。</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendToAllOnline</span><span class="params">(WSBaseResp&lt;?&gt; wsBaseResp, Long skipUid)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        ONLINE_WS_MAP.forEach((channel, ext) -&gt; &#123;</span><br><span class="line">            <span class="comment">//判断这个uid是不是需要跳过的uid，发送消息的uid就不需要推送给自己</span></span><br><span class="line">            <span class="keyword">if</span> (ObjectUtil.equal(ext.getUid(), skipUid)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//调用异步线程池发送消息</span></span><br><span class="line">            threadPoolTaskExecutor.execute(() -&gt; sendMsg(channel, wsBaseResp));</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="总览-1"   >
          <a href="#总览-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#总览-1" class="headerlink" title="总览"></a>总览</h3>
      <p><strong>消息的异步推送</strong></p>
<p>利用异步线程池来推送消息给全体用户</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">threadPoolTaskExecutor.execute(() -&gt; sendMsg(channel, wsBaseResp));</span><br></pre></td></tr></table></div></figure>

<p><strong>登录码的防重</strong></p>
<p>利用原子类生成一个code，这个code必须在Caffeine中没有并且能有channel与其关联，也即这个code不能重复</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoginReq</span><span class="params">(Channel channel)</span> &#123;</span><br><span class="line">        <span class="comment">//生成随机不重复的登录码</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">code</span> <span class="operator">=</span> generateLoginCode(channel);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br></pre></td></tr></table></div></figure>

<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Integer <span class="title function_">generateLoginCode</span><span class="params">(Channel channel)</span> &#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">//利用AtomicInteger获取一个code</span></span><br><span class="line">        CODE.getAndIncrement();</span><br><span class="line">    &#125; <span class="keyword">while</span> (</span><br><span class="line">        <span class="comment">//必须要Caffeine中没有 并且 能有Channael与Code关联</span></span><br><span class="line">        WAIT_LOGIN_MAP.asMap().containsKey(CODE.get())||</span><br><span class="line">        Objects.isNull(WAIT_LOGIN_MAP.get(CODE.get(), c -&gt; channel))</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> CODE.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">CODE</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>();</span><br></pre></td></tr></table></div></figure>

<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Cache&lt;Integer, Channel&gt; WAIT_LOGIN_MAP = Caffeine.newBuilder()</span><br><span class="line">        .expireAfterWrite(EXPIRE_TIME)</span><br><span class="line">        .maximumSize(MAX_MUM_SIZE)</span><br><span class="line">        .build();</span><br></pre></td></tr></table></div></figure>



<p><strong>登录二维码内存泄漏</strong></p>
<p>因为登录的时候会申请一个code和二维码相关联，如果一个用户申请了二维码就会将临时二维码和code做映射，只有当注册或者登录用户的时候才会将映射删除</p>
<p>但是迟迟没有扫码登录，那么这个code会一直存在内存中，并且其他用户在申请code的时候可能会造成code碰撞会不断申请</p>
<p><em>解决方案</em></p>
<p>利用Caffeine来最大容量和过期时间</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Cache&lt;Integer, Channel&gt; WAIT_LOGIN_MAP = Caffeine.newBuilder()</span><br><span class="line">        .expireAfterWrite(EXPIRE_TIME) <span class="comment">//设置过期时间为1h</span></span><br><span class="line">        .maximumSize(MAX_MUM_SIZE)<span class="comment">//设置最大容量为10000</span></span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Duration</span> <span class="variable">EXPIRE_TIME</span> <span class="operator">=</span> Duration.ofHours(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Long</span> <span class="variable">MAX_MUM_SIZE</span> <span class="operator">=</span> <span class="number">10000L</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">CODE</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>();</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>利用原子类自增来解决code冲突的问题</p>

        <h2 id="表情包模块"   >
          <a href="#表情包模块" class="heading-link"><i class="fas fa-link"></i></a><a href="#表情包模块" class="headerlink" title="表情包模块"></a>表情包模块</h2>
      
        <h3 id="表情包列表"   >
          <a href="#表情包列表" class="heading-link"><i class="fas fa-link"></i></a><a href="#表情包列表" class="headerlink" title="表情包列表"></a>表情包列表</h3>
      <div class="table-container"><table>
<thead>
<tr>
<th>URI</th>
<th>请求类型</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;capi&#x2F;user&#x2F;emoji&#x2F;list</td>
<td>GET请求</td>
</tr>
</tbody></table></div>

        <h4 id="Controller层-7"   >
          <a href="#Controller层-7" class="heading-link"><i class="fas fa-link"></i></a><a href="#Controller层-7" class="headerlink" title="Controller层"></a>Controller层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/list&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;表情包列表&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ApiResult&lt;List&lt;UserEmojiResp&gt;&gt; <span class="title function_">getEmojisPage</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> ApiResult.success(emojiService.list(RequestHolder.get().getUid()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="Service层-5"   >
          <a href="#Service层-5" class="heading-link"><i class="fas fa-link"></i></a><a href="#Service层-5" class="headerlink" title="Service层"></a>Service层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;UserEmojiResp&gt; <span class="title function_">list</span><span class="params">(Long uid)</span>;</span><br></pre></td></tr></table></div></figure>

<p>实现类中</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;UserEmojiResp&gt; <span class="title function_">list</span><span class="params">(Long uid)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> userEmojiDao.listByUid(uid).</span><br><span class="line">            stream()</span><br><span class="line">            .map(a -&gt; UserEmojiResp.builder()</span><br><span class="line">                    .id(a.getId())<span class="comment">//设置表情id</span></span><br><span class="line">                    .expressionUrl(a.getExpressionUrl())<span class="comment">//设置表情uil</span></span><br><span class="line">                    .build())</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="listByUid-1"   >
          <a href="#listByUid-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#listByUid-1" class="headerlink" title="listByUid"></a>listByUid</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据uid查询uid下的表情包</span></span><br><span class="line"><span class="keyword">public</span> List&lt;UserEmoji&gt; <span class="title function_">listByUid</span><span class="params">(Long uid)</span> &#123;</span><br><span class="line">    <span class="comment">//SELECT id,uid,expression_url,delete_status,create_time,update_time </span></span><br><span class="line">    <span class="comment">//FROM user_emoji </span></span><br><span class="line">    <span class="comment">//WHERE delete_status=0 AND (uid = ?)     delete_status为0说明是正常 为1是删除  即逻辑删除</span></span><br><span class="line">    <span class="keyword">return</span> lambdaQuery().eq(UserEmoji::getUid, uid).list();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="流程-6"   >
          <a href="#流程-6" class="heading-link"><i class="fas fa-link"></i></a><a href="#流程-6" class="headerlink" title="流程"></a>流程</h4>
      <p>查询Controller 传入Uid查询list，也即查询Uid下的表情包(自己拥有)</p>

        <h3 id="添加表情"   >
          <a href="#添加表情" class="heading-link"><i class="fas fa-link"></i></a><a href="#添加表情" class="headerlink" title="添加表情"></a>添加表情</h3>
      <div class="table-container"><table>
<thead>
<tr>
<th>URI</th>
<th>请求类型</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;capi&#x2F;user&#x2F;emoji</td>
<td>POST请求</td>
</tr>
</tbody></table></div>

        <h4 id="Controller层-8"   >
          <a href="#Controller层-8" class="heading-link"><i class="fas fa-link"></i></a><a href="#Controller层-8" class="headerlink" title="Controller层"></a>Controller层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping()</span></span><br><span class="line">   <span class="meta">@ApiOperation(&quot;新增表情包&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> ApiResult&lt;IdRespVO&gt; <span class="title function_">insertEmojis</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> UserEmojiReq req)</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> emojiService.insert(req, RequestHolder.get().getUid());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="Service层-6"   >
          <a href="#Service层-6" class="heading-link"><i class="fas fa-link"></i></a><a href="#Service层-6" class="headerlink" title="Service层"></a>Service层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ApiResult&lt;IdRespVO&gt; <span class="title function_">insert</span><span class="params">(UserEmojiReq emojis, Long uid)</span>;</span><br></pre></td></tr></table></div></figure>

<p>实现类中</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@RedissonLock(key = &quot;#uid&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ApiResult&lt;IdRespVO&gt; <span class="title function_">insert</span><span class="params">(UserEmojiReq req, Long uid)</span> &#123;</span><br><span class="line">    <span class="comment">//校验表情数量是否超过30</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> userEmojiDao.countByUid(uid);</span><br><span class="line">    AssertUtil.isFalse(count &gt; <span class="number">30</span>, <span class="string">&quot;最多只能添加30个表情哦~~&quot;</span>);</span><br><span class="line">    <span class="comment">//校验表情是否存在</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">existsCount</span> <span class="operator">=</span> userEmojiDao.lambdaQuery()</span><br><span class="line">            .eq(UserEmoji::getExpressionUrl, req.getExpressionUrl())</span><br><span class="line">            .eq(UserEmoji::getUid, uid)</span><br><span class="line">            .count();</span><br><span class="line">    AssertUtil.isFalse(existsCount &gt; <span class="number">0</span>, <span class="string">&quot;当前表情已存在哦~~&quot;</span>);</span><br><span class="line">    <span class="type">UserEmoji</span> <span class="variable">insert</span> <span class="operator">=</span> UserEmoji.builder().uid(uid).expressionUrl(req.getExpressionUrl()).build();</span><br><span class="line">    <span class="comment">//插入表情</span></span><br><span class="line">    userEmojiDao.save(insert);</span><br><span class="line">    <span class="keyword">return</span> ApiResult.success(IdRespVO.id(insert.getId()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="流程-7"   >
          <a href="#流程-7" class="heading-link"><i class="fas fa-link"></i></a><a href="#流程-7" class="headerlink" title="流程"></a>流程</h4>
      <p>添加表情先检验表情包数量是否超过30</p>
<p>超过30无法添加，如果不超过则检验表情是否重复</p>
<p>如果表情不重复并且表情包数量小于30 则插入User_emoji中新增表情包  添加表情包URL</p>

        <h3 id="删除表情"   >
          <a href="#删除表情" class="heading-link"><i class="fas fa-link"></i></a><a href="#删除表情" class="headerlink" title="删除表情"></a>删除表情</h3>
      <div class="table-container"><table>
<thead>
<tr>
<th>URI</th>
<th>请求类型</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;capi&#x2F;user&#x2F;emoji</td>
<td>DELETE请求</td>
</tr>
</tbody></table></div>

        <h4 id="Controller层-9"   >
          <a href="#Controller层-9" class="heading-link"><i class="fas fa-link"></i></a><a href="#Controller层-9" class="headerlink" title="Controller层"></a>Controller层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DeleteMapping()</span></span><br><span class="line">   <span class="meta">@ApiOperation(&quot;删除表情包&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> ApiResult&lt;Void&gt; <span class="title function_">deleteEmojis</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> IdReqVO reqVO)</span> &#123;</span><br><span class="line">       emojiService.remove(reqVO.getId(), RequestHolder.get().getUid());</span><br><span class="line">       <span class="keyword">return</span> ApiResult.success();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="Service层-7"   >
          <a href="#Service层-7" class="heading-link"><i class="fas fa-link"></i></a><a href="#Service层-7" class="headerlink" title="Service层"></a>Service层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">remove</span><span class="params">(Long id, Long uid)</span>;</span><br></pre></td></tr></table></div></figure>

<p>实现类中</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">(Long id, Long uid)</span> &#123;</span><br><span class="line">    <span class="comment">//获取要删除的表情包</span></span><br><span class="line">    <span class="type">UserEmoji</span> <span class="variable">userEmoji</span> <span class="operator">=</span> userEmojiDao.getById(id);</span><br><span class="line">    <span class="comment">//如果表情为空</span></span><br><span class="line">    AssertUtil.isNotEmpty(userEmoji, <span class="string">&quot;表情不能为空&quot;</span>);</span><br><span class="line">    <span class="comment">//如果表情不是自己的</span></span><br><span class="line">    AssertUtil.equal(userEmoji.getUid(), uid, <span class="string">&quot;小黑子，别人表情不是你能删的&quot;</span>);</span><br><span class="line">	<span class="comment">//删除表情 将逻辑删除改为1</span></span><br><span class="line">    userEmojiDao.removeById(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="流程-8"   >
          <a href="#流程-8" class="heading-link"><i class="fas fa-link"></i></a><a href="#流程-8" class="headerlink" title="流程"></a>流程</h4>
      <p>判断表情包是否为空，如果不为空判断表情包是否是自己的</p>
<p>如果不为空且是自己的表情，则将逻辑删除改成1，代表表情包已经被删除</p>

        <h2 id="上传文件模块"   >
          <a href="#上传文件模块" class="heading-link"><i class="fas fa-link"></i></a><a href="#上传文件模块" class="headerlink" title="上传文件模块"></a>上传文件模块</h2>
      
        <h3 id="Controller层-10"   >
          <a href="#Controller层-10" class="heading-link"><i class="fas fa-link"></i></a><a href="#Controller层-10" class="headerlink" title="Controller层"></a>Controller层</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/capi/oss&quot;)</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;oss相关接口&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OssController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OssService ossService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/upload/url&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;获取临时上传链接&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ApiResult&lt;OssResp&gt; <span class="title function_">getUploadUrl</span><span class="params">(<span class="meta">@Valid</span> UploadUrlReq req)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ApiResult.success(ossService.getUploadUrl(RequestHolder.get().getUid(), req));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h3 id="Service层-8"   >
          <a href="#Service层-8" class="heading-link"><i class="fas fa-link"></i></a><a href="#Service层-8" class="headerlink" title="Service层"></a>Service层</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OssResp <span class="title function_">getUploadUrl</span><span class="params">(Long uid, UploadUrlReq req)</span>;</span><br></pre></td></tr></table></div></figure>

<p>实现类中</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> OssResp <span class="title function_">getUploadUrl</span><span class="params">(Long uid, UploadUrlReq req)</span> &#123;</span><br><span class="line">    <span class="comment">//判断上传的类型 1为聊天内容 2为表情包</span></span><br><span class="line">    <span class="type">OssSceneEnum</span> <span class="variable">sceneEnum</span> <span class="operator">=</span> OssSceneEnum.of(req.getScene());</span><br><span class="line">    AssertUtil.isNotEmpty(sceneEnum, <span class="string">&quot;场景有误&quot;</span>);</span><br><span class="line">    <span class="type">OssReq</span> <span class="variable">ossReq</span> <span class="operator">=</span> OssReq.builder()</span><br><span class="line">            .fileName(req.getFileName())<span class="comment">//添加文件名</span></span><br><span class="line">            .filePath(sceneEnum.getPath())<span class="comment">//添加Path</span></span><br><span class="line">            .uid(uid)<span class="comment">//添加uid</span></span><br><span class="line">            .build();</span><br><span class="line">    <span class="keyword">return</span> minIOTemplate.getPreSignedObjectUrl(ossReq); <span class="comment">//上传到MinIo中</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="getPreSignedObjectUrl"   >
          <a href="#getPreSignedObjectUrl" class="heading-link"><i class="fas fa-link"></i></a><a href="#getPreSignedObjectUrl" class="headerlink" title="getPreSignedObjectUrl"></a>getPreSignedObjectUrl</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="keyword">public</span> OssResp <span class="title function_">getPreSignedObjectUrl</span><span class="params">(OssReq req)</span> &#123;</span><br><span class="line">    <span class="comment">//获取一个文件名，如果是自动路径则获取一个随机文件路径，反之拼接文件路径+&#x27;/&#x27;+文件名作为文件名 </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">absolutePath</span> <span class="operator">=</span> req.isAutoPath() ? generateAutoPath(req) : req.getFilePath() + StrUtil.SLASH + req.getFileName();</span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> minioClient.getPresignedObjectUrl(</span><br><span class="line">            GetPresignedObjectUrlArgs.builder()</span><br><span class="line">                    .method(Method.PUT)  <span class="comment">//设置为Put方法</span></span><br><span class="line">                    .bucket(ossProperties.getBucketName()) <span class="comment">//获取桶名</span></span><br><span class="line">                    .object(absolutePath)</span><br><span class="line">                    .expiry(<span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>) <span class="comment">//获取过期时间为一天</span></span><br><span class="line">                    .build());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//上传到MinIo中</span></span><br><span class="line">    <span class="keyword">return</span> OssResp.builder()</span><br><span class="line">            .uploadUrl(url)</span><br><span class="line">            .downloadUrl(getDownloadUrl(ossProperties.getBucketName(), absolutePath))</span><br><span class="line">            .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="聊天室模块"   >
          <a href="#聊天室模块" class="heading-link"><i class="fas fa-link"></i></a><a href="#聊天室模块" class="headerlink" title="聊天室模块"></a>聊天室模块</h2>
      <p>聊天室模块分为三块 1.会话的列表 2.群成员模块 3.消息模块</p>

        <h3 id="会话列表"   >
          <a href="#会话列表" class="heading-link"><i class="fas fa-link"></i></a><a href="#会话列表" class="headerlink" title="会话列表"></a>会话列表</h3>
      <div class="table-container"><table>
<thead>
<tr>
<th>URI</th>
<th>请求类型</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;capi&#x2F;chat&#x2F;public&#x2F;room&#x2F;page</td>
<td>GET请求</td>
</tr>
</tbody></table></div>

        <h4 id="Controller层-11"   >
          <a href="#Controller层-11" class="heading-link"><i class="fas fa-link"></i></a><a href="#Controller层-11" class="headerlink" title="Controller层"></a>Controller层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/public/room/page&quot;)</span></span><br><span class="line">   <span class="meta">@ApiOperation(&quot;会话列表&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> ApiResult&lt;CursorPageBaseResp&lt;ChatRoomResp&gt;&gt; <span class="title function_">getRoomPage</span><span class="params">(<span class="meta">@Valid</span> CursorPageBaseReq request)</span> &#123;</span><br><span class="line">       <span class="comment">//调用Service中的方法  传入参数1.游标 2.页面大小</span></span><br><span class="line">       <span class="keyword">return</span> ApiResult.success(chatService.getRoomPage(request, RequestHolder.get().getUid()));</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="Service层-9"   >
          <a href="#Service层-9" class="heading-link"><i class="fas fa-link"></i></a><a href="#Service层-9" class="headerlink" title="Service层"></a>Service层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CursorPageBaseResp&lt;ChatRoomResp&gt; <span class="title function_">getRoomPage</span><span class="params">(CursorPageBaseReq request, Long uid)</span>;</span><br></pre></td></tr></table></div></figure>

<p>实现类中</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//传入参数1.游标位置(起始为NUll),2.页面大小</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> CursorPageBaseResp&lt;ChatRoomResp&gt; <span class="title function_">getRoomPage</span><span class="params">(CursorPageBaseReq request, Long uid)</span> &#123;</span><br><span class="line">    <span class="comment">//获取游标位置分页</span></span><br><span class="line">    CursorPageBaseResp&lt;Room&gt; cursorPage = roomDao.getCursorPage(request);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//获取群聊列表 </span></span><br><span class="line">    ArrayList&lt;Room&gt; rooms = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(cursorPage.getList());</span><br><span class="line">    <span class="keyword">if</span> (request.isFirstPage()) &#123;</span><br><span class="line">        <span class="comment">//第一页插入置顶的大群聊</span></span><br><span class="line">        <span class="comment">//根据ID查询房间 long ROOM_GROUP_ID = 1L;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//Select * from room where id=?</span></span><br><span class="line">        <span class="type">Room</span> <span class="variable">group</span> <span class="operator">=</span> roomDao.getById(ROOM_GROUP_ID);</span><br><span class="line">        rooms.add(<span class="number">0</span>, group);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> CursorPageBaseResp.init(cursorPage, RoomAdapter.buildResp(rooms));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="getCursorPage"   >
          <a href="#getCursorPage" class="heading-link"><i class="fas fa-link"></i></a><a href="#getCursorPage" class="headerlink" title="getCursorPage"></a>getCursorPage</h4>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public CursorPageBaseResp&lt;Room&gt; getCursorPage(CursorPageBaseReq request) &#123;</span><br><span class="line">    return cursorUtils.getCursorPageByMysql(this, request, wrapper -&gt; &#123;</span><br><span class="line">        wrapper.ne(Room::getType, RoomTypeEnum.GROUP.getStatus());</span><br><span class="line">    &#125;, Room::getActiveTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="getCursorPageByMysql"   >
          <a href="#getCursorPageByMysql" class="heading-link"><i class="fas fa-link"></i></a><a href="#getCursorPageByMysql" class="headerlink" title="getCursorPageByMysql"></a>getCursorPageByMysql</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*传入参数1.Iservice&lt;Room&gt; mapper 操作room数据库的mapper</span></span><br><span class="line"><span class="comment">		 2.游标</span></span><br><span class="line"><span class="comment">         3.条件查询器  条件1).房间类型 2)房间状态</span></span><br><span class="line"><span class="comment">         4.房间最后活动时间</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; CursorPageBaseResp&lt;T&gt; <span class="title function_">getCursorPageByMysql</span><span class="params">(IService&lt;T&gt; mapper, CursorPageBaseReq request, Consumer&lt;LambdaQueryWrapper&lt;T&gt;&gt; initWrapper, SFunction&lt;T, ?&gt; cursorColumn)</span> &#123;</span><br><span class="line">    <span class="comment">//lambdaQueryWrapper </span></span><br><span class="line">    LambdaQueryWrapper&lt;T&gt; wrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">	<span class="comment">//初始化wrapper</span></span><br><span class="line">    initWrapper.accept(wrapper);</span><br><span class="line">    <span class="comment">//如果游标不为空 获取游标位置</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(request.getCursor())) &#123;</span><br><span class="line">        <span class="comment">//添加条件 游标要小于请求游标位置</span></span><br><span class="line">        wrapper.lt(cursorColumn, request.getCursor());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//根据最后请求位置 倒排</span></span><br><span class="line">    wrapper.orderByDesc(cursorColumn);</span><br><span class="line">    <span class="comment">//获取分页，一次十条 从游标位置开始倒排</span></span><br><span class="line">    Page&lt;T&gt; page = mapper.page(request.plusPage(), wrapper);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//获取一个游标 </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">cursor</span> <span class="operator">=</span> Optional.ofNullable(CollectionUtil.getLast(page.getRecords()))</span><br><span class="line">            .map(cursorColumn)</span><br><span class="line">            .map(String::valueOf)</span><br><span class="line">            .orElse(<span class="literal">null</span>);</span><br><span class="line">    <span class="comment">//判断是不是最后一页</span></span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">isLast</span> <span class="operator">=</span> page.getRecords().size() != request.getPageSize();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CursorPageBaseResp</span>&lt;&gt;(cursor, isLast, page.getRecords());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="init"   >
          <a href="#init" class="heading-link"><i class="fas fa-link"></i></a><a href="#init" class="headerlink" title="init"></a>init</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; CursorPageBaseResp&lt;T&gt; <span class="title function_">init</span><span class="params">(CursorPageBaseResp cursorPage, List&lt;T&gt; list)</span> &#123;</span><br><span class="line">    </span><br><span class="line">    CursorPageBaseResp&lt;T&gt; cursorPageBaseResp = <span class="keyword">new</span> <span class="title class_">CursorPageBaseResp</span>&lt;T&gt;();</span><br><span class="line">    <span class="comment">//设置是否是最后一页</span></span><br><span class="line">    cursorPageBaseResp.setIsLast(cursorPage.getIsLast());</span><br><span class="line">    <span class="comment">//设置list数据列表</span></span><br><span class="line">    cursorPageBaseResp.setList(list);</span><br><span class="line">    <span class="comment">//设置游标</span></span><br><span class="line">    cursorPageBaseResp.setCursor(cursorPage.getCursor());</span><br><span class="line">    <span class="keyword">return</span> cursorPageBaseResp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="流程-9"   >
          <a href="#流程-9" class="heading-link"><i class="fas fa-link"></i></a><a href="#流程-9" class="headerlink" title="流程"></a>流程</h4>
      <p>①获取所有的会话 (因为此时只有一个群聊所以不根据UID查询)</p>
<p>②获取一个返回游标及分页对象，默认游标是NULL，消息页数为10条</p>
<p>③init初始化会话和消息列表，返回</p>

        <h3 id="群成员模块"   >
          <a href="#群成员模块" class="heading-link"><i class="fas fa-link"></i></a><a href="#群成员模块" class="headerlink" title="群成员模块"></a>群成员模块</h3>
      
        <h4 id="群成员-在线人数统计"   >
          <a href="#群成员-在线人数统计" class="heading-link"><i class="fas fa-link"></i></a><a href="#群成员-在线人数统计" class="headerlink" title="群成员+在线人数统计"></a>群成员+在线人数统计</h4>
      <div class="table-container"><table>
<thead>
<tr>
<th>URI</th>
<th>请求类型</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;capi&#x2F;chat&#x2F;public&#x2F;member&#x2F;statistic</td>
<td>GET请求</td>
</tr>
</tbody></table></div>

        <h5 id="Controller层-12"   >
          <a href="#Controller层-12" class="heading-link"><i class="fas fa-link"></i></a><a href="#Controller层-12" class="headerlink" title="Controller层"></a>Controller层</h5>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;public/member/statistic&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;群成员人数统计&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ApiResult&lt;ChatMemberStatisticResp&gt; <span class="title function_">getMemberStatistic</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> ApiResult.success(chatService.getMemberStatistic());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="Service层-10"   >
          <a href="#Service层-10" class="heading-link"><i class="fas fa-link"></i></a><a href="#Service层-10" class="headerlink" title="Service层"></a>Service层</h5>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ChatMemberStatisticResp <span class="title function_">getMemberStatistic</span><span class="params">()</span>;</span><br></pre></td></tr></table></div></figure>

<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ChatMemberStatisticResp <span class="title function_">getMemberStatistic</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName());</span><br><span class="line">     	<span class="comment">//查询userCache.getOnlinenum获得在线总人数</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">onlineNum</span> <span class="operator">=</span> userCache.getOnlineNum();</span><br><span class="line">        <span class="comment">//离线人数</span></span><br><span class="line"><span class="comment">//        Long offlineNum = userCache.getOfflineNum();不展示总人数</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//获取一个返回对象</span></span><br><span class="line">        <span class="type">ChatMemberStatisticResp</span> <span class="variable">resp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChatMemberStatisticResp</span>();</span><br><span class="line">        <span class="comment">//设置在线人数</span></span><br><span class="line">        resp.setOnlineNum(onlineNum);</span><br><span class="line">        <span class="comment">//设置总人数</span></span><br><span class="line"><span class="comment">//        resp.setTotalNum(onlineNum + offlineNum);</span></span><br><span class="line">        <span class="keyword">return</span> resp;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="getOnlineNum"   >
          <a href="#getOnlineNum" class="heading-link"><i class="fas fa-link"></i></a><a href="#getOnlineNum" class="headerlink" title="getOnlineNum"></a>getOnlineNum</h5>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Long <span class="title function_">getOnlineNum</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//拼接一个Key: String ONLINE_UID_ZET = &quot;online&quot;;</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">onlineKey</span> <span class="operator">=</span> RedisKey.getKey(RedisKey.ONLINE_UID_ZET);</span><br><span class="line">    <span class="comment">//调用zCard方法将key传入</span></span><br><span class="line">    <span class="keyword">return</span> RedisUtils.zCard(onlineKey);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="zCard"   >
          <a href="#zCard" class="heading-link"><i class="fas fa-link"></i></a><a href="#zCard" class="headerlink" title="zCard"></a>zCard</h5>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ublic <span class="keyword">static</span> Long <span class="title function_">zCard</span><span class="params">(String key)</span> &#123;</span><br><span class="line">  	<span class="comment">//通过Zset将Online个数传回来</span></span><br><span class="line">    <span class="keyword">return</span> stringRedisTemplate.opsForZSet().zCard(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="流程-10"   >
          <a href="#流程-10" class="heading-link"><i class="fas fa-link"></i></a><a href="#流程-10" class="headerlink" title="流程"></a>流程</h5>
      <p>调用Redis 通过zset的Zset命令获取Key为MallChat:online的个数，然后返回给前端显示在线总人数</p>
<p>如果要做总人数的统计，可以通过key为MallChat:offLine的个数与MallChat:online的个数进行累加，这样就知道了总人数</p>

        <h4 id="上线下线推送"   >
          <a href="#上线下线推送" class="heading-link"><i class="fas fa-link"></i></a><a href="#上线下线推送" class="headerlink" title="上线下线推送"></a>上线下线推送</h4>
      
        <h5 id="主动更新成员列表"   >
          <a href="#主动更新成员列表" class="heading-link"><i class="fas fa-link"></i></a><a href="#主动更新成员列表" class="headerlink" title="主动更新成员列表"></a>主动更新成员列表</h5>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> CursorPageBaseResp&lt;ChatMemberResp&gt; <span class="title function_">getMemberPage</span><span class="params">(CursorPageBaseReq request)</span> &#123;</span><br><span class="line">    Pair&lt;ChatActiveStatusEnum, String&gt; pair = ChatMemberHelper.getCursorPair(request.getCursor());</span><br><span class="line">    <span class="type">ChatActiveStatusEnum</span> <span class="variable">activeStatusEnum</span> <span class="operator">=</span> pair.getKey();</span><br><span class="line">    <span class="type">String</span> <span class="variable">timeCursor</span> <span class="operator">=</span> pair.getValue();</span><br><span class="line">    List&lt;ChatMemberResp&gt; resultList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();<span class="comment">//最终列表</span></span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">isLast</span> <span class="operator">=</span> Boolean.FALSE;</span><br><span class="line">    <span class="keyword">if</span> (activeStatusEnum == ChatActiveStatusEnum.ONLINE) &#123;<span class="comment">//在线列表</span></span><br><span class="line">        CursorPageBaseResp&lt;Pair&lt;Long, Double&gt;&gt; cursorPage = userCache.getOnlineCursorPage(<span class="keyword">new</span> <span class="title class_">CursorPageBaseReq</span>(request.getPageSize(), timeCursor));</span><br><span class="line">        resultList.addAll(memberAdapter.buildMember(cursorPage.getList(), ChatActiveStatusEnum.ONLINE));<span class="comment">//添加在线列表</span></span><br><span class="line">        <span class="keyword">if</span> (cursorPage.getIsLast()) &#123;<span class="comment">//如果是最后一页,从离线列表再补点数据</span></span><br><span class="line">            <span class="type">Integer</span> <span class="variable">leftSize</span> <span class="operator">=</span> request.getPageSize() - cursorPage.getList().size();</span><br><span class="line">            cursorPage = userCache.getOfflineCursorPage(<span class="keyword">new</span> <span class="title class_">CursorPageBaseReq</span>(leftSize, <span class="literal">null</span>));</span><br><span class="line">            resultList.addAll(memberAdapter.buildMember(cursorPage.getList(), ChatActiveStatusEnum.OFFLINE));<span class="comment">//添加离线线列表</span></span><br><span class="line">            activeStatusEnum = ChatActiveStatusEnum.OFFLINE;</span><br><span class="line">        &#125;</span><br><span class="line">        timeCursor = cursorPage.getCursor();</span><br><span class="line">        isLast = cursorPage.getIsLast();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (activeStatusEnum == ChatActiveStatusEnum.OFFLINE) &#123;<span class="comment">//离线列表</span></span><br><span class="line">        CursorPageBaseResp&lt;Pair&lt;Long, Double&gt;&gt; cursorPage = userCache.getOfflineCursorPage(<span class="keyword">new</span> <span class="title class_">CursorPageBaseReq</span>(request.getPageSize(), timeCursor));</span><br><span class="line">        resultList.addAll(memberAdapter.buildMember(cursorPage.getList(), ChatActiveStatusEnum.OFFLINE));<span class="comment">//添加离线线列表</span></span><br><span class="line">        timeCursor = cursorPage.getCursor();</span><br><span class="line">        isLast = cursorPage.getIsLast();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//组装结果</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CursorPageBaseResp</span>&lt;&gt;(ChatMemberHelper.generateCursor(activeStatusEnum, timeCursor), isLast, resultList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="后台推送"   >
          <a href="#后台推送" class="heading-link"><i class="fas fa-link"></i></a><a href="#后台推送" class="headerlink" title="后台推送"></a>后台推送</h5>
      
        <h6 id="用户上线"   >
          <a href="#用户上线" class="heading-link"><i class="fas fa-link"></i></a><a href="#用户上线" class="headerlink" title="用户上线"></a>用户上线</h6>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loginSuccess</span><span class="params">(Channel channel, User user, String token)</span> &#123;</span><br><span class="line">        <span class="comment">//更新上线列表</span></span><br><span class="line">        online(channel, user.getId());</span><br><span class="line">        <span class="comment">//返回给用户登录成功</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">hasPower</span> <span class="operator">=</span> iRoleService.hasPower(user.getId(), RoleEnum.CHAT_MANAGER);</span><br><span class="line">        sendMsg(channel, WSAdapter.buildLoginSuccessResp(user, token, hasPower));</span><br><span class="line">        <span class="comment">//发送用户上线事件</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    	<span class="comment">//查询cache中发现Oniine中没有这个用户ID说明用户刚刚上线</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">online</span> <span class="operator">=</span> userCache.isOnline(user.getId());</span><br><span class="line">        <span class="keyword">if</span> (!online) &#123;</span><br><span class="line">            user.setLastOptTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">            user.refreshIp(NettyUtil.getAttr(channel, NettyUtil.IP));</span><br><span class="line">            <span class="comment">//发布用户上线事件</span></span><br><span class="line">            applicationEventPublisher.publishEvent(<span class="keyword">new</span> <span class="title class_">UserOnlineEvent</span>(<span class="built_in">this</span>, user));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h6 id="用户下线"   >
          <a href="#用户下线" class="heading-link"><i class="fas fa-link"></i></a><a href="#用户下线" class="headerlink" title="用户下线"></a>用户下线</h6>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removed</span><span class="params">(Channel channel)</span> &#123;</span><br><span class="line">    <span class="comment">//获取channel</span></span><br><span class="line">    <span class="type">WSChannelExtraDTO</span> <span class="variable">wsChannelExtraDTO</span> <span class="operator">=</span> ONLINE_WS_MAP.get(channel);</span><br><span class="line">    Optional&lt;Long&gt; uidOptional = Optional.ofNullable(wsChannelExtraDTO)</span><br><span class="line">            .map(WSChannelExtraDTO::getUid);</span><br><span class="line"> 	<span class="comment">//判断这个channel所对应的用户是否全部下线</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">offlineAll</span> <span class="operator">=</span> offline(channel, uidOptional);</span><br><span class="line">    <span class="keyword">if</span> (uidOptional.isPresent() &amp;&amp; offlineAll) &#123;<span class="comment">//已登录用户断连,并且全下线成功</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user.setId(uidOptional.get());</span><br><span class="line">        user.setLastOptTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        <span class="comment">//发布下线事件</span></span><br><span class="line">        applicationEventPublisher.publishEvent(<span class="keyword">new</span> <span class="title class_">UserOfflineEvent</span>(<span class="built_in">this</span>, user));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="流程-11"   >
          <a href="#流程-11" class="heading-link"><i class="fas fa-link"></i></a><a href="#流程-11" class="headerlink" title="流程"></a>流程</h5>
      <p>用户上线和下线主要靠主动的游标翻页更新成员列表以及后台的推送完成</p>
<p>1.成员上线 发布上线事件，判断游标类型对在线列表进行更新</p>
<p>2.成员下线 发布下线事件，更新在线列表以及离线列表</p>

        <h4 id="群成员Zset游标翻页"   >
          <a href="#群成员Zset游标翻页" class="heading-link"><i class="fas fa-link"></i></a><a href="#群成员Zset游标翻页" class="headerlink" title="群成员Zset游标翻页"></a>群成员Zset游标翻页</h4>
      
        <h5 id="群成员列表的翻页"   >
          <a href="#群成员列表的翻页" class="heading-link"><i class="fas fa-link"></i></a><a href="#群成员列表的翻页" class="headerlink" title="群成员列表的翻页"></a>群成员列表的翻页</h5>
      <div class="table-container"><table>
<thead>
<tr>
<th>URI</th>
<th>请求类型</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;capi&#x2F;chat&#x2F;public&#x2F;member&#x2F;page</td>
<td>GET请求</td>
</tr>
</tbody></table></div>

        <h6 id="Controller层-13"   >
          <a href="#Controller层-13" class="heading-link"><i class="fas fa-link"></i></a><a href="#Controller层-13" class="headerlink" title="Controller层"></a>Controller层</h6>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/public/member/page&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;群成员列表&quot;)</span></span><br><span class="line">	<span class="comment">//频控</span></span><br><span class="line">    <span class="meta">@FrequencyControl(time = 120, count = 20, target = FrequencyControl.Target.IP)</span></span><br><span class="line">    <span class="keyword">public</span> ApiResult&lt;CursorPageBaseResp&lt;ChatMemberResp&gt;&gt; <span class="title function_">getMemberPage</span><span class="params">(<span class="meta">@Valid</span> CursorPageBaseReq request)</span> &#123;</span><br><span class="line"><span class="comment">//        black(request);</span></span><br><span class="line">        </span><br><span class="line">        CursorPageBaseResp&lt;ChatMemberResp&gt; memberPage = chatService.getMemberPage(request);</span><br><span class="line">        <span class="comment">//过滤黑名单用户</span></span><br><span class="line">        filterBlackMember(memberPage);</span><br><span class="line">        <span class="keyword">return</span> ApiResult.success(memberPage);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h6 id="Service层-11"   >
          <a href="#Service层-11" class="heading-link"><i class="fas fa-link"></i></a><a href="#Service层-11" class="headerlink" title="Service层"></a>Service层</h6>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CursorPageBaseResp&lt;ChatMemberResp&gt; <span class="title function_">getMemberPage</span><span class="params">(CursorPageBaseReq request)</span>;</span><br></pre></td></tr></table></div></figure>

<p>实现类中</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> CursorPageBaseResp&lt;ChatMemberResp&gt; <span class="title function_">getMemberPage</span><span class="params">(CursorPageBaseReq request)</span> &#123;</span><br><span class="line">    <span class="comment">//根据游标位置获取一个pair页</span></span><br><span class="line">    Pair&lt;ChatActiveStatusEnum, String&gt; pair = ChatMemberHelper.getCursorPair(request.getCursor());</span><br><span class="line">    <span class="comment">//页获取在线状态 Key:Online/offLine</span></span><br><span class="line">    <span class="type">ChatActiveStatusEnum</span> <span class="variable">activeStatusEnum</span> <span class="operator">=</span> pair.getKey();</span><br><span class="line">    <span class="comment">//游标的当前位置</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">timeCursor</span> <span class="operator">=</span> pair.getValue();</span><br><span class="line">    List&lt;ChatMemberResp&gt; resultList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();<span class="comment">//最终列表</span></span><br><span class="line">    <span class="comment">//判断是否是最后一页，默认不是</span></span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">isLast</span> <span class="operator">=</span> Boolean.FALSE;</span><br><span class="line">    <span class="keyword">if</span> (activeStatusEnum == ChatActiveStatusEnum.ONLINE) &#123;<span class="comment">//在线列表</span></span><br><span class="line">        CursorPageBaseResp&lt;Pair&lt;Long, Double&gt;&gt; cursorPage = userCache.getOnlineCursorPage(<span class="keyword">new</span> <span class="title class_">CursorPageBaseReq</span>(request.getPageSize(), timeCursor));</span><br><span class="line">        resultList.addAll(memberAdapter.buildMember(cursorPage.getList(), ChatActiveStatusEnum.ONLINE));<span class="comment">//添加在线列表</span></span><br><span class="line">        <span class="keyword">if</span> (cursorPage.getIsLast()) &#123;<span class="comment">//如果是最后一页,从离线列表再补点数据</span></span><br><span class="line">            <span class="type">Integer</span> <span class="variable">leftSize</span> <span class="operator">=</span> request.getPageSize() - cursorPage.getList().size();</span><br><span class="line">            cursorPage = userCache.getOfflineCursorPage(<span class="keyword">new</span> <span class="title class_">CursorPageBaseReq</span>(leftSize, <span class="literal">null</span>));</span><br><span class="line">            resultList.addAll(memberAdapter.buildMember(cursorPage.getList(), ChatActiveStatusEnum.OFFLINE));<span class="comment">//添加离线线列表</span></span><br><span class="line">            activeStatusEnum = ChatActiveStatusEnum.OFFLINE;</span><br><span class="line">        &#125;</span><br><span class="line">        timeCursor = cursorPage.getCursor();</span><br><span class="line">        isLast = cursorPage.getIsLast();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (activeStatusEnum == ChatActiveStatusEnum.OFFLINE) &#123;<span class="comment">//离线列表</span></span><br><span class="line">        CursorPageBaseResp&lt;Pair&lt;Long, Double&gt;&gt; cursorPage = userCache.getOfflineCursorPage(<span class="keyword">new</span> <span class="title class_">CursorPageBaseReq</span>(request.getPageSize(), timeCursor));</span><br><span class="line">        resultList.addAll(memberAdapter.buildMember(cursorPage.getList(), ChatActiveStatusEnum.OFFLINE));<span class="comment">//添加离线线列表</span></span><br><span class="line">        timeCursor = cursorPage.getCursor();</span><br><span class="line">        isLast = cursorPage.getIsLast();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//组装结果</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CursorPageBaseResp</span>&lt;&gt;(ChatMemberHelper.generateCursor(activeStatusEnum, timeCursor), isLast, resultList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h6 id="getCurOrPageByRedis"   >
          <a href="#getCurOrPageByRedis" class="heading-link"><i class="fas fa-link"></i></a><a href="#getCurOrPageByRedis" class="headerlink" title="getCurOrPageByRedis"></a>getCurOrPageByRedis</h6>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; CursorPageBaseResp&lt;Pair&lt;T, Double&gt;&gt; <span class="title function_">getCursorPageByRedis</span><span class="params">(CursorPageBaseReq cursorPageBaseReq, String redisKey, Function&lt;String, T&gt; typeConvert)</span> &#123;</span><br><span class="line">    Set&lt;ZSetOperations.TypedTuple&lt;String&gt;&gt; typedTuples;</span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isBlank(cursorPageBaseReq.getCursor())) &#123;<span class="comment">//第一次</span></span><br><span class="line">        typedTuples = RedisUtils.zReverseRangeWithScores(redisKey, cursorPageBaseReq.getPageSize());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        typedTuples = RedisUtils.zReverseRangeByScoreWithScores(redisKey, Double.parseDouble(cursorPageBaseReq.getCursor()), cursorPageBaseReq.getPageSize());</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;Pair&lt;T, Double&gt;&gt; result = typedTuples</span><br><span class="line">            .stream()</span><br><span class="line">            .map(t -&gt; Pair.of(typeConvert.apply(t.getValue()), t.getScore()))</span><br><span class="line">            .sorted((o1, o2) -&gt; o2.getValue().compareTo(o1.getValue()))</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">    <span class="type">String</span> <span class="variable">cursor</span> <span class="operator">=</span> Optional.ofNullable(CollectionUtil.getLast(result))</span><br><span class="line">            .map(Pair::getValue)</span><br><span class="line">            .map(String::valueOf)</span><br><span class="line">            .orElse(<span class="literal">null</span>);</span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">isLast</span> <span class="operator">=</span> result.size() != cursorPageBaseReq.getPageSize();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CursorPageBaseResp</span>&lt;&gt;(cursor, isLast, result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h6 id="流程-12"   >
          <a href="#流程-12" class="heading-link"><i class="fas fa-link"></i></a><a href="#流程-12" class="headerlink" title="流程"></a>流程</h6>
      <p><strong>利用Zset的属性</strong>  </p>
<p><em>Redis命令  Zrange  key min max 天然具有分页属性</em></p>
<p>①获取一个游标分页，然后判断是不是在线状态，是不是在线状态最后一页</p>
<p>②如果是在线状态且不是最后一页，那从UserCache中找在线状态用户缓存添加到返回列表，更新游标位置</p>
<p>③如果是在线状态且是最后一页，那从UserCache中找在线用户缓存，然后判断用户数够不够，不够从离线用户中补一部分数据，更新游标位置</p>
<p>④如果是离线，从UserCache中找离线用户缓存</p>
<p>⑤最后过滤黑名单用户 返回给前端</p>

        <h5 id="的群成员列表"   >
          <a href="#的群成员列表" class="heading-link"><i class="fas fa-link"></i></a><a href="#的群成员列表" class="headerlink" title="@的群成员列表"></a>@的群成员列表</h5>
      <div class="table-container"><table>
<thead>
<tr>
<th>URI</th>
<th>请求类型</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;capi&#x2F;chat&#x2F;member&#x2F;list</td>
<td>GET请求</td>
</tr>
</tbody></table></div>

        <h6 id="Controller层-14"   >
          <a href="#Controller层-14" class="heading-link"><i class="fas fa-link"></i></a><a href="#Controller层-14" class="headerlink" title="Controller层"></a>Controller层</h6>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GetMapping(<span class="string">&quot;/member/list&quot;</span>)</span><br><span class="line"><span class="meta">@ApiOperation(&quot;房间内的所有群成员列表-@专用&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ApiResult&lt;List&lt;ChatMemberListResp&gt;&gt; <span class="title function_">getMemberList</span><span class="params">(<span class="meta">@Valid</span> ChatMessageMemberReq chatMessageMemberReq)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> ApiResult.success(chatService.getMemberList(chatMessageMemberReq));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h6 id="Service层-12"   >
          <a href="#Service层-12" class="heading-link"><i class="fas fa-link"></i></a><a href="#Service层-12" class="headerlink" title="Service层"></a>Service层</h6>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;ChatMemberListResp&gt; <span class="title function_">getMemberList</span><span class="params">(ChatMessageMemberReq chatMessageMemberReq)</span>;</span><br></pre></td></tr></table></div></figure>

<p>实现类中</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Cacheable(cacheNames = &quot;member&quot;, key = &quot;&#x27;memberList.&#x27;+#req.roomId&quot;)</span></span><br><span class="line"><span class="keyword">public</span> List&lt;ChatMemberListResp&gt; <span class="title function_">getMemberList</span><span class="params">(ChatMessageMemberReq req)</span> &#123;</span><br><span class="line">    <span class="comment">//判断房间号和请求房间ID是否相同</span></span><br><span class="line">    <span class="keyword">if</span> (Objects.equals(<span class="number">1L</span>, req.getRoomId())) &#123;<span class="comment">//大群聊可看见所有人</span></span><br><span class="line">        <span class="keyword">return</span> userDao.getMemberList()</span><br><span class="line">                .stream()</span><br><span class="line">                .map(a -&gt; &#123;</span><br><span class="line">                    <span class="type">ChatMemberListResp</span> <span class="variable">resp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChatMemberListResp</span>();</span><br><span class="line">                    BeanUtils.copyProperties(a, resp);</span><br><span class="line">                    resp.setUid(a.getId());</span><br><span class="line">                    <span class="keyword">return</span> resp;</span><br><span class="line">                &#125;).collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h6 id="getMemberList"   >
          <a href="#getMemberList" class="heading-link"><i class="fas fa-link"></i></a><a href="#getMemberList" class="headerlink" title="getMemberList"></a>getMemberList</h6>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查询用户状态正常，然后按照活跃时间倒数排列的1000人列表，select ID，name，和头像 以列表返回</span></span><br><span class="line"><span class="keyword">public</span> List&lt;User&gt; <span class="title function_">getMemberList</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> lambdaQuery()</span><br><span class="line">            .eq(User::getStatus, NormalOrNoEnum.NORMAL.getStatus())</span><br><span class="line">            .orderByDesc(User::getUpdateTime)<span class="comment">//最近活跃的1000个人，可以用lastOptTime字段，但是该字段没索引，updateTime可平替</span></span><br><span class="line">            .last(<span class="string">&quot;limit 1000&quot;</span>)<span class="comment">//毕竟是大群聊，人数需要做个限制</span></span><br><span class="line">            .select(User::getId, User::getName, User::getAvatar)</span><br><span class="line">            .list();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h6 id="流程-13"   >
          <a href="#流程-13" class="heading-link"><i class="fas fa-link"></i></a><a href="#流程-13" class="headerlink" title="流程"></a>流程</h6>
      <p>1.判断是不是公共群聊</p>
<p>2.如果是则查询活跃的1000人的头像，id，昵称且以活跃时间倒序排序</p>
<p><strong>@用户没有用到游标</strong></p>

        <h3 id="消息模块"   >
          <a href="#消息模块" class="heading-link"><i class="fas fa-link"></i></a><a href="#消息模块" class="headerlink" title="消息模块"></a>消息模块</h3>
      
        <h4 id="消息列表"   >
          <a href="#消息列表" class="heading-link"><i class="fas fa-link"></i></a><a href="#消息列表" class="headerlink" title="消息列表"></a>消息列表</h4>
      <div class="table-container"><table>
<thead>
<tr>
<th>URI</th>
<th>请求类型</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;capi&#x2F;chat&#x2F;public&#x2F;msg&#x2F;page</td>
<td>GET请求</td>
</tr>
</tbody></table></div>

        <h5 id="Controller层-15"   >
          <a href="#Controller层-15" class="heading-link"><i class="fas fa-link"></i></a><a href="#Controller层-15" class="headerlink" title="Controller层"></a>Controller层</h5>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">	<span class="meta">@GetMapping(&quot;/public/msg/page&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;消息列表&quot;)</span></span><br><span class="line">    <span class="meta">@FrequencyControl(time = 120, count = 20, target = FrequencyControl.Target.IP)</span></span><br><span class="line">    <span class="keyword">public</span> ApiResult&lt;CursorPageBaseResp&lt;ChatMessageResp&gt;&gt; <span class="title function_">getMsgPage</span><span class="params">(<span class="meta">@Valid</span> ChatMessagePageReq request)</span> &#123;</span><br><span class="line"><span class="comment">//        black(request);</span></span><br><span class="line">        CursorPageBaseResp&lt;ChatMessageResp&gt; msgPage = chatService.getMsgPage(request, RequestHolder.get().getUid());</span><br><span class="line">        <span class="comment">//过滤空消息</span></span><br><span class="line">        filterBlackMsg(msgPage);</span><br><span class="line">        <span class="keyword">return</span> ApiResult.success(msgPage);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="service层"   >
          <a href="#service层" class="heading-link"><i class="fas fa-link"></i></a><a href="#service层" class="headerlink" title="service层"></a>service层</h5>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CursorPageBaseResp&lt;ChatMessageResp&gt; <span class="title function_">getMsgPage</span><span class="params">(ChatMessagePageReq request, <span class="meta">@Nullable</span> Long receiveUid)</span>;</span><br></pre></td></tr></table></div></figure>

<p>实现类中</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> CursorPageBaseResp&lt;ChatMessageResp&gt; <span class="title function_">getMsgPage</span><span class="params">(ChatMessagePageReq request, Long receiveUid)</span> &#123;</span><br><span class="line">    CursorPageBaseResp&lt;Message&gt; cursorPage = messageDao.getCursorPage(request.getRoomId(), request);</span><br><span class="line">    <span class="comment">//判断返回页是否为空</span></span><br><span class="line">    <span class="keyword">if</span> (cursorPage.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">//抛出异常</span></span><br><span class="line">        <span class="keyword">return</span> CursorPageBaseResp.empty();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//初始化</span></span><br><span class="line">    <span class="keyword">return</span> CursorPageBaseResp.init(cursorPage, getMsgRespBatch(cursorPage.getList(), receiveUid));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h5 id="getCursorPage-1"   >
          <a href="#getCursorPage-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#getCursorPage-1" class="headerlink" title="getCursorPage"></a>getCursorPage</h5>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> CursorPageBaseResp&lt;Message&gt; <span class="title function_">getCursorPage</span><span class="params">(Long roomId, CursorPageBaseReq request)</span> &#123;</span><br><span class="line">    <span class="comment">//传入参数1.RoomId 2.游标翻页请求</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//拼接查询条件 roomid==room_id,消息status(正常)==status</span></span><br><span class="line">    <span class="comment">//SELECT COUNT(1) FROM message WHERE (room_id = ? AND status = ?)</span></span><br><span class="line">    <span class="keyword">return</span> cursorUtils.getCursorPageByMysql(<span class="built_in">this</span>, request, wrapper -&gt; &#123;</span><br><span class="line">            wrapper.eq(Message::getRoomId, roomId);</span><br><span class="line">            wrapper.eq(Message::getStatus, MessageStatusEnum.NORMAL.getStatus());</span><br><span class="line">        &#125;, Message::getId);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>




        <h5 id="getCursorPageByMysql-1"   >
          <a href="#getCursorPageByMysql-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#getCursorPageByMysql-1" class="headerlink" title="getCursorPageByMysql"></a>getCursorPageByMysql</h5>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据游标位置倒序查找Mysql</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; CursorPageBaseResp&lt;T&gt; <span class="title function_">getCursorPageByMysql</span><span class="params">(IService&lt;T&gt; mapper, CursorPageBaseReq request, Consumer&lt;LambdaQueryWrapper&lt;T&gt;&gt; initWrapper, SFunction&lt;T, ?&gt; cursorColumn)</span> &#123;</span><br><span class="line">        LambdaQueryWrapper&lt;T&gt; wrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">        initWrapper.accept(wrapper);</span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotBlank(request.getCursor())) &#123;</span><br><span class="line">            wrapper.lt(cursorColumn, request.getCursor());</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    	<span class="comment">//根据id倒叙排序 </span></span><br><span class="line">        wrapper.orderByDesc(cursorColumn);</span><br><span class="line">    </span><br><span class="line">    	<span class="comment">//根据规定页10条</span></span><br><span class="line">        Page&lt;T&gt; page = mapper.page(request.plusPage(), wrapper);</span><br><span class="line">        <span class="type">String</span> <span class="variable">cursor</span> <span class="operator">=</span> Optional.ofNullable(CollectionUtil.getLast(page.getRecords()))</span><br><span class="line">                .map(cursorColumn)</span><br><span class="line">                .map(String::valueOf)</span><br><span class="line">                .orElse(<span class="literal">null</span>);</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">isLast</span> <span class="operator">=</span> page.getRecords().size() != request.getPageSize();</span><br><span class="line">    <span class="comment">//返回游标，是否为最终页，数据</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CursorPageBaseResp</span>&lt;&gt;(cursor, isLast, page.getRecords());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="流程-14"   >
          <a href="#流程-14" class="heading-link"><i class="fas fa-link"></i></a><a href="#流程-14" class="headerlink" title="流程"></a>流程</h5>
      <p>利用游标思想，每次移动10条，然后返回给前端消息</p>

        <h4 id="发送消息"   >
          <a href="#发送消息" class="heading-link"><i class="fas fa-link"></i></a><a href="#发送消息" class="headerlink" title="发送消息"></a>发送消息</h4>
      <div class="table-container"><table>
<thead>
<tr>
<th>URI</th>
<th>请求类型</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;capi&#x2F;chat&#x2F;msg</td>
<td>POST请求</td>
</tr>
</tbody></table></div>

        <h5 id="Controller层-16"   >
          <a href="#Controller层-16" class="heading-link"><i class="fas fa-link"></i></a><a href="#Controller层-16" class="headerlink" title="Controller层"></a>Controller层</h5>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/msg&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;发送消息&quot;)</span></span><br><span class="line"><span class="meta">@FrequencyControl(time = 5, count = 3, target = FrequencyControl.Target.UID)</span></span><br><span class="line"><span class="meta">@FrequencyControl(time = 30, count = 5, target = FrequencyControl.Target.UID)</span></span><br><span class="line"><span class="meta">@FrequencyControl(time = 60, count = 10, target = FrequencyControl.Target.UID)</span></span><br><span class="line"><span class="keyword">public</span> ApiResult&lt;ChatMessageResp&gt; <span class="title function_">sendMsg</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> ChatMessageReq request)</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">msgId</span> <span class="operator">=</span> chatService.sendMsg(request, RequestHolder.get().getUid());</span><br><span class="line">    <span class="comment">//返回完整消息格式，方便前端展示</span></span><br><span class="line">    <span class="keyword">return</span> ApiResult.success(chatService.getMsgResp(msgId, RequestHolder.get().getUid()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h5 id="Service层-13"   >
          <a href="#Service层-13" class="heading-link"><i class="fas fa-link"></i></a><a href="#Service层-13" class="headerlink" title="Service层"></a>Service层</h5>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Long <span class="title function_">sendMsg</span><span class="params">(ChatMessageReq request, Long uid)</span>;</span><br></pre></td></tr></table></div></figure>

<p>实现类中</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> Long <span class="title function_">sendMsg</span><span class="params">(ChatMessageReq request, Long uid)</span> &#123;</span><br><span class="line">    <span class="type">AbstractMsgHandler</span> <span class="variable">msgHandler</span> <span class="operator">=</span> MsgHandlerFactory.getStrategyNoNull(request.getMsgType());<span class="comment">//todo 这里先不扩展，后续再改</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//检查消息体和uid</span></span><br><span class="line">    msgHandler.checkMsg(request, uid);</span><br><span class="line">    <span class="comment">//同步获取消息的跳转链接标题</span></span><br><span class="line">    <span class="type">Message</span> <span class="variable">insert</span> <span class="operator">=</span> MessageAdapter.buildMsgSave(request, uid);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//保存到数据库中 </span></span><br><span class="line">    <span class="comment">//Preparing: INSERT INTO message ( room_id, from_uid, status, type ) VALUES ( ?, ?, ?, ? )</span></span><br><span class="line">    messageDao.save(insert);</span><br><span class="line">    </span><br><span class="line">    msgHandler.saveMsg(insert, request);</span><br><span class="line">    <span class="comment">//发布消息发送事件</span></span><br><span class="line">    applicationEventPublisher.publishEvent(<span class="keyword">new</span> <span class="title class_">MessageSendEvent</span>(<span class="built_in">this</span>, insert.getId()));</span><br><span class="line">    <span class="comment">//返回消息ID</span></span><br><span class="line">    <span class="keyword">return</span> insert.getId();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="流程-15"   >
          <a href="#流程-15" class="heading-link"><i class="fas fa-link"></i></a><a href="#流程-15" class="headerlink" title="流程"></a>流程</h5>
      <p>①检查消息请求和uid</p>
<p>②新增一条消息记录存放到消息库中<del>Message</del></p>
<p>③发布消息发送事件</p>

        <h4 id="标记消息"   >
          <a href="#标记消息" class="heading-link"><i class="fas fa-link"></i></a><a href="#标记消息" class="headerlink" title="标记消息"></a>标记消息</h4>
      <div class="table-container"><table>
<thead>
<tr>
<th>URI</th>
<th>请求类型</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;capi&#x2F;chat&#x2F;msg&#x2F;mark</td>
<td></td>
</tr>
</tbody></table></div>

        <h5 id="Controller层-17"   >
          <a href="#Controller层-17" class="heading-link"><i class="fas fa-link"></i></a><a href="#Controller层-17" class="headerlink" title="Controller层"></a>Controller层</h5>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PutMapping(&quot;/msg/mark&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;消息标记&quot;)</span></span><br><span class="line">    <span class="meta">@FrequencyControl(time = 10, count = 5, target = FrequencyControl.Target.UID)</span></span><br><span class="line">    <span class="keyword">public</span> ApiResult&lt;Void&gt; <span class="title function_">setMsgMark</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> ChatMessageMarkReq request)</span> &#123;</span><br><span class="line">        chatService.setMsgMark(RequestHolder.get().getUid(), request);</span><br><span class="line">        <span class="keyword">return</span> ApiResult.success();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="Service层-14"   >
          <a href="#Service层-14" class="heading-link"><i class="fas fa-link"></i></a><a href="#Service层-14" class="headerlink" title="Service层"></a>Service层</h5>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">setMsgMark</span><span class="params">(Long uid, ChatMessageMarkReq request)</span>;</span><br></pre></td></tr></table></div></figure>

<p>实现类中</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@RedissonLock(key = &quot;#uid&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMsgMark</span><span class="params">(Long uid, ChatMessageMarkReq request)</span> &#123;</span><br><span class="line">    <span class="comment">//private Integer markType; 1为点赞2为举报</span></span><br><span class="line">    <span class="type">AbstractMsgMarkStrategy</span> <span class="variable">strategy</span> <span class="operator">=</span> MsgMarkFactory.getStrategyNoNull(request.getMarkType());</span><br><span class="line">    	<span class="comment">//判断请求的动作类型标记</span></span><br><span class="line">    <span class="keyword">switch</span> (MessageMarkActTypeEnum.of(request.getActType())) &#123;</span><br><span class="line">         <span class="comment">//SELECT COUNT( 1 ) FROM message_mark WHERE (msg_id = ? AND type = ? AND status = ?)</span></span><br><span class="line">            </span><br><span class="line">        <span class="comment">//确认标记</span></span><br><span class="line">        <span class="keyword">case</span> MARK:</span><br><span class="line">            strategy.mark(uid, request.getMsgId());</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">//取消标记</span></span><br><span class="line">        <span class="keyword">case</span> UN_MARK:</span><br><span class="line">            strategy.unMark(uid, request.getMsgId());</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="mark"   >
          <a href="#mark" class="heading-link"><i class="fas fa-link"></i></a><a href="#mark" class="headerlink" title="mark"></a>mark</h5>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">mark</span><span class="params">(Long uid, Long msgId)</span> &#123;</span><br><span class="line"> 	<span class="comment">//传入uid,msgId 且因为是mark 所以是确认标记类型</span></span><br><span class="line">    doMark(uid, msgId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="doMark"   >
          <a href="#doMark" class="heading-link"><i class="fas fa-link"></i></a><a href="#doMark" class="headerlink" title="doMark"></a>doMark</h5>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doMark</span><span class="params">(Long uid, Long msgId)</span> &#123;</span><br><span class="line"> 	<span class="comment">//传入用户uid,msgId,标记类型</span></span><br><span class="line">    exec(uid, msgId, MessageMarkActTypeEnum.MARK);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="exec"   >
          <a href="#exec" class="heading-link"><i class="fas fa-link"></i></a><a href="#exec" class="headerlink" title="exec"></a>exec</h5>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">exec</span><span class="params">(Long uid, Long msgId, MessageMarkActTypeEnum actTypeEnum)</span> &#123;</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">markType</span> <span class="operator">=</span> getTypeEnum().getType();</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">actType</span> <span class="operator">=</span> actTypeEnum.getType();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//查询老的mark</span></span><br><span class="line">    <span class="comment">//SELECT COUNT( 1 ) FROM message_mark WHERE (msg_id = ? AND type = ? AND status = ?)</span></span><br><span class="line">    <span class="type">MessageMark</span> <span class="variable">oldMark</span> <span class="operator">=</span> messageMarkDao.get(uid, msgId, markType);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (Objects.isNull(oldMark) &amp;&amp; actTypeEnum == MessageMarkActTypeEnum.UN_MARK) &#123;</span><br><span class="line">        <span class="comment">//取消的类型，数据库一定有记录，没有就直接跳过操作</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//插入一条新消息,或者修改一条消息</span></span><br><span class="line">    <span class="type">MessageMark</span> <span class="variable">insertOrUpdate</span> <span class="operator">=</span> MessageMark.builder()</span><br><span class="line">            .id(Optional.ofNullable(oldMark).map(MessageMark::getId).orElse(<span class="literal">null</span>))</span><br><span class="line">            .uid(uid)</span><br><span class="line">            .msgId(msgId)</span><br><span class="line">            .type(markType)</span><br><span class="line">            .status(transformAct(actType))</span><br><span class="line">            .build();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//UPDATE message_mark SET msg_id=?, uid=?, type=?, status=? WHERE id=?</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">modify</span> <span class="operator">=</span> messageMarkDao.saveOrUpdate(insertOrUpdate);</span><br><span class="line">    <span class="keyword">if</span> (modify) &#123;</span><br><span class="line">        <span class="comment">//修改成功才发布消息标记事件</span></span><br><span class="line">        <span class="type">ChatMessageMarkDTO</span> <span class="variable">dto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChatMessageMarkDTO</span>(uid, msgId, markType, actType);</span><br><span class="line">        applicationEventPublisher.publishEvent(<span class="keyword">new</span> <span class="title class_">MessageMarkEvent</span>(<span class="built_in">this</span>, dto));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="流程-16"   >
          <a href="#流程-16" class="heading-link"><i class="fas fa-link"></i></a><a href="#流程-16" class="headerlink" title="流程"></a>流程</h5>
      <p>①获取消息标记的种类(点赞&#x2F;举报)</p>
<p>②判断执行标记消息的动作(添加、移除)</p>
<p>③执行相应的动作</p>
<ul>
<li>添加标记 则插入一条记录到消息标记库<del>Message_Mark</del>，包含消息标记的种类以及uid，状态等</li>
<li>删除标记 先判断消息标记库中是否有这条对应的添加消息的记录，如果不存在直接返回，如果存在则修改消息标记的状态</li>
</ul>
<p>④执行完修改消息库标记库之后，再发布标记消息事件</p>

        <h4 id="撤回消息"   >
          <a href="#撤回消息" class="heading-link"><i class="fas fa-link"></i></a><a href="#撤回消息" class="headerlink" title="撤回消息"></a>撤回消息</h4>
      <div class="table-container"><table>
<thead>
<tr>
<th>URI</th>
<th>请求类型</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;capi&#x2F;chat&#x2F;msg&#x2F;recall</td>
<td>PUT请求</td>
</tr>
</tbody></table></div>

        <h5 id="Controller层-18"   >
          <a href="#Controller层-18" class="heading-link"><i class="fas fa-link"></i></a><a href="#Controller层-18" class="headerlink" title="Controller层"></a>Controller层</h5>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@PutMapping(&quot;/msg/recall&quot;)</span><br><span class="line">   @ApiOperation(&quot;撤回消息&quot;)</span><br><span class="line">   @FrequencyControl(time = 20, count = 3, target = FrequencyControl.Target.UID)</span><br><span class="line">   public ApiResult&lt;Void&gt; recallMsg(@Valid @RequestBody ChatMessageBaseReq request) &#123;</span><br><span class="line">       chatService.recallMsg(RequestHolder.get().getUid(), request);</span><br><span class="line">       return ApiResult.success();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="Service层-15"   >
          <a href="#Service层-15" class="heading-link"><i class="fas fa-link"></i></a><a href="#Service层-15" class="headerlink" title="Service层"></a>Service层</h5>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">recallMsg</span><span class="params">(Long uid, ChatMessageBaseReq request)</span>;</span><br></pre></td></tr></table></div></figure>

<p><strong>实现类中</strong></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recallMsg</span><span class="params">(Long uid, ChatMessageBaseReq request)</span> &#123;</span><br><span class="line">    <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> messageDao.getById(request.getMsgId());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//校验能不能执行撤回    </span></span><br><span class="line">    <span class="comment">//SELECT id,room_id,from_uid,content,reply_msg_id,status,gap_count,type,extra,create_time,update_time FROM message WHERE id=?</span></span><br><span class="line">    checkRecall(uid, message);</span><br><span class="line">    <span class="comment">//执行消息撤回</span></span><br><span class="line">    recallMsgHandler.recall(uid, message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="checkRecall"   >
          <a href="#checkRecall" class="heading-link"><i class="fas fa-link"></i></a><a href="#checkRecall" class="headerlink" title="checkRecall"></a>checkRecall</h5>
      <p> <strong>检验消息的撤回权限</strong></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">checkRecall</span><span class="params">(Long uid, Message message)</span> &#123;</span><br><span class="line">    AssertUtil.isNotEmpty(message, <span class="string">&quot;消息有误&quot;</span>);</span><br><span class="line">    AssertUtil.notEqual(message.getType(), MessageTypeEnum.RECALL, <span class="string">&quot;消息无法撤回&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//如果不是超级管理员不能撤回</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">hasPower</span> <span class="operator">=</span> iRoleService.hasPower(uid, RoleEnum.CHAT_MANAGER);</span><br><span class="line">    <span class="keyword">if</span> (hasPower) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//运行到这里！hasPower即不是超级管理员用户</span></span><br><span class="line">    <span class="comment">//判断self 即这个消息是不是当前uid发送</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">self</span> <span class="operator">=</span> Objects.equals(uid, message.getFromUid());</span><br><span class="line"> 	<span class="comment">//为false说明不是当前用户发送 </span></span><br><span class="line">    AssertUtil.isTrue(self, <span class="string">&quot;抱歉,您没有权限&quot;</span>);</span><br><span class="line">    <span class="comment">//判断修改时间和当前时间差距是不是两分钟内</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">between</span> <span class="operator">=</span> DateUtil.between(message.getCreateTime(), <span class="keyword">new</span> <span class="title class_">Date</span>(), DateUnit.MINUTE);</span><br><span class="line">    AssertUtil.isTrue(between &lt; <span class="number">2</span>, <span class="string">&quot;覆水难收，超过2分钟的消息不能撤回哦~~&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="recall"   >
          <a href="#recall" class="heading-link"><i class="fas fa-link"></i></a><a href="#recall" class="headerlink" title="recall"></a>recall</h5>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recall</span><span class="params">(Long recallUid, Message message)</span> &#123;<span class="comment">//todo 消息覆盖问题用版本号解决</span></span><br><span class="line">    </span><br><span class="line">    	<span class="comment">//获得扩展字段</span></span><br><span class="line">    	<span class="type">MessageExtra</span> <span class="variable">extra</span> <span class="operator">=</span> message.getExtra();</span><br><span class="line">        extra.setRecall(<span class="keyword">new</span> <span class="title class_">MsgRecall</span>(recallUid, <span class="keyword">new</span> <span class="title class_">Date</span>()));</span><br><span class="line">    </span><br><span class="line">        <span class="type">Message</span> <span class="variable">update</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>();</span><br><span class="line">    	<span class="comment">//设置Id，设置更新类型为撤回类型</span></span><br><span class="line">    	update.setId(message.getId());</span><br><span class="line">        <span class="comment">//UPDATE message SET type=?, extra=? WHERE id=?  </span></span><br><span class="line">    	<span class="comment">//注入撤回消息类型、消息中的扩展字段</span></span><br><span class="line">        update.setType(MessageTypeEnum.RECALL.getType());</span><br><span class="line">        update.setExtra(extra);</span><br><span class="line">    	<span class="comment">//更新消息表</span></span><br><span class="line">        messageDao.updateById(update);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    	<span class="comment">//发布撤回消息事件</span></span><br><span class="line">        applicationEventPublisher.publishEvent(<span class="keyword">new</span> <span class="title class_">MessageRecallEvent</span>(<span class="built_in">this</span>, <span class="keyword">new</span> <span class="title class_">ChatMsgRecallDTO</span>(message.getId(), message.getRoomId(), recallUid)));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="流程-17"   >
          <a href="#流程-17" class="heading-link"><i class="fas fa-link"></i></a><a href="#流程-17" class="headerlink" title="流程"></a>流程</h5>
      <p>①检验消息能否被撤回  </p>
<p><em>判断条件</em></p>
<ul>
<li>1)如果是超级管理员则有权限撤回 </li>
<li>2)如果不是超级管理员判断是否为当前UID用户发送的消息，如果不是则不能撤回</li>
<li>3)不是超级管理员且是当前用户发送消息，判断发送时间是否超过两分钟，如果是则不能撤回</li>
</ul>
<p>②执行消息撤回</p>
<p>将消息的类型设置为Recall类型，也即撤回消息类型 </p>
<p>③发布消息撤回事件</p>

        <h2 id="监听器"   >
          <a href="#监听器" class="heading-link"><i class="fas fa-link"></i></a><a href="#监听器" class="headerlink" title="监听器"></a>监听器</h2>
      <p>我们先统计一下前面的模块究竟发布了哪些事件用于被监听呢?我们用一张表格来总结</p>
<div class="table-container"><table>
<thead>
<tr>
<th>模块</th>
<th>事件</th>
</tr>
</thead>
<tbody><tr>
<td>User</td>
<td>用户拉黑事件</td>
</tr>
<tr>
<td>User</td>
<td>用户上线事件</td>
</tr>
<tr>
<td>User</td>
<td>用户下线事件</td>
</tr>
<tr>
<td>User</td>
<td>用户注册事件</td>
</tr>
<tr>
<td>Message</td>
<td>消息发送事件</td>
</tr>
<tr>
<td>Message</td>
<td>消息标记事件</td>
</tr>
<tr>
<td>Message</td>
<td>消息撤回事件</td>
</tr>
<tr>
<td>UserItem</td>
<td>物品发放事件</td>
</tr>
</tbody></table></div>
<p>暂且也就这些，所以接下来我要从两个模块开始分析这个监听器究竟做了什么事</p>

        <h3 id="User模块"   >
          <a href="#User模块" class="heading-link"><i class="fas fa-link"></i></a><a href="#User模块" class="headerlink" title="User模块"></a>User模块</h3>
      
        <h4 id="用户拉黑事件"   >
          <a href="#用户拉黑事件" class="heading-link"><i class="fas fa-link"></i></a><a href="#用户拉黑事件" class="headerlink" title="用户拉黑事件"></a>用户拉黑事件</h4>
      
        <h5 id="刷新缓存-Tomcat和Redis"   >
          <a href="#刷新缓存-Tomcat和Redis" class="heading-link"><i class="fas fa-link"></i></a><a href="#刷新缓存-Tomcat和Redis" class="headerlink" title="刷新缓存(Tomcat和Redis)"></a>刷新缓存(Tomcat和Redis)</h5>
      <p>刷新Caffeine和Redis中的用户信息缓存</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//异步执行</span></span><br><span class="line"><span class="meta">@Async</span></span><br><span class="line"><span class="meta">@EventListener(classes = UserBlackEvent.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refreshRedis</span><span class="params">(UserBlackEvent event)</span> &#123;</span><br><span class="line">    userCache.evictBlackMap();</span><br><span class="line">    userCache.remove(event.getUser().getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h6 id="evictBlackMap"   >
          <a href="#evictBlackMap" class="heading-link"><i class="fas fa-link"></i></a><a href="#evictBlackMap" class="headerlink" title="evictBlackMap"></a>evictBlackMap</h6>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//删除Caffeine中的用户数据</span></span><br><span class="line"><span class="meta">@CacheEvict(cacheNames = &quot;user&quot;, key = &quot;&#x27;blackList&#x27;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;Integer, Set&lt;String&gt;&gt; <span class="title function_">evictBlackMap</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h6 id="remove"   >
          <a href="#remove" class="heading-link"><i class="fas fa-link"></i></a><a href="#remove" class="headerlink" title="remove"></a>remove</h6>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//删除Redis缓存中的用户数据</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">(Long uid)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">onlineKey</span> <span class="operator">=</span> RedisKey.getKey(RedisKey.ONLINE_UID_ZET);</span><br><span class="line">        <span class="type">String</span> <span class="variable">offlineKey</span> <span class="operator">=</span> RedisKey.getKey(RedisKey.OFFLINE_UID_ZET);</span><br><span class="line">        <span class="comment">//移除离线表</span></span><br><span class="line">        RedisUtils.zRemove(offlineKey, uid);</span><br><span class="line">        <span class="comment">//移除上线表</span></span><br><span class="line">        RedisUtils.zRemove(onlineKey, uid);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="删除消息"   >
          <a href="#删除消息" class="heading-link"><i class="fas fa-link"></i></a><a href="#删除消息" class="headerlink" title="删除消息"></a>删除消息</h5>
      <p>删除该uid的所有消息</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Async</span> <span class="comment">//表示异步</span></span><br><span class="line">   <span class="meta">@EventListener(classes = UserBlackEvent.class)</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteMsg</span><span class="params">(UserBlackEvent event)</span> &#123;</span><br><span class="line">       messageDao.invalidByUid(event.getUser().getId());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></div></figure>


        <h6 id="deleteMsg"   >
          <a href="#deleteMsg" class="heading-link"><i class="fas fa-link"></i></a><a href="#deleteMsg" class="headerlink" title="deleteMsg"></a>deleteMsg</h6>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将拉黑用户的消息类型置为删除状态</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invalidByUid</span><span class="params">(Long uid)</span> &#123;</span><br><span class="line">        lambdaUpdate()</span><br><span class="line">                .eq(Message::getFromUid, uid)</span><br><span class="line">                .set(Message::getStatus, MessageStatusEnum.DELETE.getStatus())</span><br><span class="line">                .update();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>




        <h5 id="推送拉黑"   >
          <a href="#推送拉黑" class="heading-link"><i class="fas fa-link"></i></a><a href="#推送拉黑" class="headerlink" title="推送拉黑"></a>推送拉黑</h5>
      <p>推送给所有在线用户，该uid的用户已经被拉黑</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Async</span></span><br><span class="line"><span class="meta">@EventListener(classes = UserBlackEvent.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendPush</span><span class="params">(UserBlackEvent event)</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">uid</span> <span class="operator">=</span> event.getUser().getId();</span><br><span class="line">    WSBaseResp&lt;WSBlack&gt; resp = <span class="keyword">new</span> <span class="title class_">WSBaseResp</span>&lt;&gt;();</span><br><span class="line">    <span class="type">WSBlack</span> <span class="variable">black</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WSBlack</span>(uid);</span><br><span class="line">    resp.setData(black);</span><br><span class="line">    resp.setType(WSRespTypeEnum.BLACK.getType());</span><br><span class="line">    webSocketService.sendToAllOnline(resp, uid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h4 id="用户上线事件"   >
          <a href="#用户上线事件" class="heading-link"><i class="fas fa-link"></i></a><a href="#用户上线事件" class="headerlink" title="用户上线事件"></a>用户上线事件</h4>
      
        <h5 id="更新缓存以及上线推送"   >
          <a href="#更新缓存以及上线推送" class="heading-link"><i class="fas fa-link"></i></a><a href="#更新缓存以及上线推送" class="headerlink" title="更新缓存以及上线推送"></a>更新缓存以及上线推送</h5>
      <p>更新Redis中的用户表，推送给所有在线用户该用户登录</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Async</span></span><br><span class="line">   <span class="meta">@EventListener(classes = UserOnlineEvent.class)</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveRedisAndPush</span><span class="params">(UserOnlineEvent event)</span> &#123;</span><br><span class="line">       <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> event.getUser();</span><br><span class="line">       userCache.online(user.getId(), user.getLastOptTime());</span><br><span class="line">       <span class="comment">//推送给所有在线用户，该用户登录成功</span></span><br><span class="line">       webSocketService.sendToAllOnline(wsAdapter.buildOnlineNotifyResp(event.getUser()));</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></div></figure>


        <h6 id="online"   >
          <a href="#online" class="heading-link"><i class="fas fa-link"></i></a><a href="#online" class="headerlink" title="online"></a>online</h6>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//用户上线</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">online</span><span class="params">(Long uid, Date optTime)</span> &#123;</span><br><span class="line">       <span class="type">String</span> <span class="variable">onlineKey</span> <span class="operator">=</span> RedisKey.getKey(RedisKey.ONLINE_UID_ZET);</span><br><span class="line">       <span class="type">String</span> <span class="variable">offlineKey</span> <span class="operator">=</span> RedisKey.getKey(RedisKey.OFFLINE_UID_ZET);</span><br><span class="line">       <span class="comment">//移除离线表</span></span><br><span class="line">       RedisUtils.zRemove(offlineKey, uid);</span><br><span class="line">       <span class="comment">//更新上线表</span></span><br><span class="line">       RedisUtils.zAdd(onlineKey, uid, optTime.getTime());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="持久化"   >
          <a href="#持久化" class="heading-link"><i class="fas fa-link"></i></a><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h5>
      <p>持久化到数据库，更新IP地址以及操作时间</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Async</span></span><br><span class="line"><span class="meta">@EventListener(classes = UserOnlineEvent.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveDB</span><span class="params">(UserOnlineEvent event)</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> event.getUser();</span><br><span class="line">    <span class="type">User</span> <span class="variable">update</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    update.setId(user.getId());</span><br><span class="line">    update.setLastOptTime(user.getLastOptTime());</span><br><span class="line">    update.setIpInfo(user.getIpInfo());</span><br><span class="line">    userDao.updateById(update);</span><br><span class="line">    <span class="comment">//更新用户ip详情</span></span><br><span class="line">    ipService.refreshIpDetailAsync(user.getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h6 id="refreshIpDetailAsync"   >
          <a href="#refreshIpDetailAsync" class="heading-link"><i class="fas fa-link"></i></a><a href="#refreshIpDetailAsync" class="headerlink" title="refreshIpDetailAsync"></a>refreshIpDetailAsync</h6>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refreshIpDetailAsync</span><span class="params">(Long uid)</span> &#123;</span><br><span class="line">       EXECUTOR.execute(() -&gt; &#123;</span><br><span class="line">           <span class="comment">//获取用户数据</span></span><br><span class="line">           <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userDao.getById(uid);</span><br><span class="line">           <span class="comment">//获取ip地址</span></span><br><span class="line">           <span class="type">IpInfo</span> <span class="variable">ipInfo</span> <span class="operator">=</span> user.getIpInfo();</span><br><span class="line">           <span class="comment">//判断ip是否为空</span></span><br><span class="line">           <span class="keyword">if</span> (Objects.isNull(ipInfo)) &#123;</span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           </span><br><span class="line">           <span class="comment">//ip不为空判断是否是黑名单用户</span></span><br><span class="line">           <span class="type">String</span> <span class="variable">ip</span> <span class="operator">=</span> ipInfo.needRefreshIp();</span><br><span class="line">           <span class="keyword">if</span> (StrUtil.isBlank(ip)) &#123;</span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">//ip不为空且不是黑名单用户 则更新缓存以及数据库中的Ip地址</span></span><br><span class="line">           <span class="type">IpDetail</span> <span class="variable">ipDetail</span> <span class="operator">=</span> TryGetIpDetailOrNullTreeTimes(ip);</span><br><span class="line">           <span class="keyword">if</span> (Objects.nonNull(ipDetail)) &#123;</span><br><span class="line">               ipInfo.refreshIpDetail(ipDetail);</span><br><span class="line">               <span class="type">User</span> <span class="variable">update</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">               update.setId(uid);</span><br><span class="line">               update.setIpInfo(ipInfo);</span><br><span class="line">               userDao.updateById(update);</span><br><span class="line">               userCache.userInfoChange(uid);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               log.error(<span class="string">&quot;get ip detail fail ip:&#123;&#125;,uid:&#123;&#125;&quot;</span>, ip, uid);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="用户下线事件"   >
          <a href="#用户下线事件" class="heading-link"><i class="fas fa-link"></i></a><a href="#用户下线事件" class="headerlink" title="用户下线事件"></a>用户下线事件</h4>
      
        <h5 id="更新缓存以及下线推送"   >
          <a href="#更新缓存以及下线推送" class="heading-link"><i class="fas fa-link"></i></a><a href="#更新缓存以及下线推送" class="headerlink" title="更新缓存以及下线推送"></a>更新缓存以及下线推送</h5>
      <p>用户下线与用户上线做的事情是一样的，所以这里不再赘述</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Async</span></span><br><span class="line">   <span class="meta">@EventListener(classes = UserOfflineEvent.class)</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveRedisAndPush</span><span class="params">(UserOfflineEvent event)</span> &#123;</span><br><span class="line">       <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> event.getUser();</span><br><span class="line">       userCache.offline(user.getId(), user.getLastOptTime());</span><br><span class="line">       <span class="comment">//推送给所有在线用户，该用户下线</span></span><br><span class="line">       webSocketService.sendToAllOnline(wsAdapter.buildOfflineNotifyResp(event.getUser()), event.getUser().getId());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="持久化-1"   >
          <a href="#持久化-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#持久化-1" class="headerlink" title="持久化"></a>持久化</h5>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Async</span></span><br><span class="line">   <span class="meta">@EventListener(classes = UserOfflineEvent.class)</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveDB</span><span class="params">(UserOfflineEvent event)</span> &#123;</span><br><span class="line">       <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> event.getUser();</span><br><span class="line">       <span class="type">User</span> <span class="variable">update</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">       update.setId(user.getId());</span><br><span class="line">       update.setLastOptTime(user.getLastOptTime());</span><br><span class="line">       userDao.updateById(update);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h4 id="用户注册事件"   >
          <a href="#用户注册事件" class="heading-link"><i class="fas fa-link"></i></a><a href="#用户注册事件" class="headerlink" title="用户注册事件"></a>用户注册事件</h4>
      
        <h5 id="初始化用户背包"   >
          <a href="#初始化用户背包" class="heading-link"><i class="fas fa-link"></i></a><a href="#初始化用户背包" class="headerlink" title="初始化用户背包"></a>初始化用户背包</h5>
      <p>用户刚注册时候送了一张改名卡 可以用于改名</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Async</span><br><span class="line">   @EventListener(classes = UserRegisterEvent.class)</span><br><span class="line">   public void sendCard(UserRegisterEvent event) &#123;</span><br><span class="line">       User user = event.getUser();</span><br><span class="line">       //送一张改名卡</span><br><span class="line">       iUserBackpackService.acquireItem(user.getId(), ItemEnum.MODIFY_NAME_CARD.getId(), 		IdempotentEnum.UID, user.getId().toString());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></div></figure>


        <h6 id="acquireItem"   >
          <a href="#acquireItem" class="heading-link"><i class="fas fa-link"></i></a><a href="#acquireItem" class="headerlink" title="acquireItem"></a>acquireItem</h6>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//发放改名卡  幂等号是为了防止多发以及消费时的不重复做保障  思路由三部分组成 1.物品ID 2.用户UID 3.订单号ID</span></span><br><span class="line">Override</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">acquireItem</span><span class="params">(Long uid, Long itemId, IdempotentEnum idempotentEnum, String businessId)</span> &#123;</span><br><span class="line">    <span class="comment">//组装幂等号 </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">idempotent</span> <span class="operator">=</span> getIdempotent(itemId, idempotentEnum, businessId);</span><br><span class="line">    userBackpackService.doAcquireItem(uid, itemId, idempotent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h6 id="doAcquireItem"   >
          <a href="#doAcquireItem" class="heading-link"><i class="fas fa-link"></i></a><a href="#doAcquireItem" class="headerlink" title="doAcquireItem"></a>doAcquireItem</h6>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//发放用户物品</span></span><br><span class="line"><span class="meta">@RedissonLock(key = &quot;#idempotent&quot;, waitTime = 5000)</span><span class="comment">//相同幂等如果同时发奖，需要排队等上一个执行完，取出之前数据返回</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doAcquireItem</span><span class="params">(Long uid, Long itemId, String idempotent)</span> &#123;</span><br><span class="line">        <span class="type">UserBackpack</span> <span class="variable">userBackpack</span> <span class="operator">=</span> userBackpackDao.getByIdp(idempotent);</span><br><span class="line">        <span class="comment">//幂等检查</span></span><br><span class="line">        <span class="keyword">if</span> (Objects.nonNull(userBackpack)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//业务检查</span></span><br><span class="line">        <span class="type">ItemConfig</span> <span class="variable">itemConfig</span> <span class="operator">=</span> itemCache.getById(itemId);</span><br><span class="line">        <span class="keyword">if</span> (ItemTypeEnum.BADGE.getType().equals(itemConfig.getType())) &#123;<span class="comment">//徽章类型做唯一性检查</span></span><br><span class="line">            <span class="type">Integer</span> <span class="variable">countByValidItemId</span> <span class="operator">=</span> userBackpackDao.getCountByValidItemId(uid, itemId);</span><br><span class="line">            <span class="keyword">if</span> (countByValidItemId &gt; <span class="number">0</span>) &#123;<span class="comment">//已经有徽章了不发</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//发物品</span></span><br><span class="line">        <span class="type">UserBackpack</span> <span class="variable">insert</span> <span class="operator">=</span> UserBackpack.builder()</span><br><span class="line">                .uid(uid)</span><br><span class="line">                .itemId(itemId)</span><br><span class="line">                .status(YesOrNoEnum.NO.getStatus())</span><br><span class="line">                .idempotent(idempotent)</span><br><span class="line">                .build();</span><br><span class="line">        userBackpackDao.save(insert);</span><br><span class="line">        <span class="comment">//用户收到物品的事件</span></span><br><span class="line">        applicationEventPublisher.publishEvent(<span class="keyword">new</span> <span class="title class_">ItemReceiveEvent</span>(<span class="built_in">this</span>, insert));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>

<p>而这里多出来一个事件是物品发放事件，所以我们直接把它代码看了</p>

        <h3 id="UserItem模块"   >
          <a href="#UserItem模块" class="heading-link"><i class="fas fa-link"></i></a><a href="#UserItem模块" class="headerlink" title="UserItem模块"></a>UserItem模块</h3>
      
        <h4 id="物品发放事件"   >
          <a href="#物品发放事件" class="heading-link"><i class="fas fa-link"></i></a><a href="#物品发放事件" class="headerlink" title="物品发放事件"></a>物品发放事件</h4>
      <p>发放之后直接默认佩戴，更新缓存以及数据库</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Async</span></span><br><span class="line"><span class="meta">@EventListener(classes = ItemReceiveEvent.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">wear</span><span class="params">(ItemReceiveEvent event)</span> &#123;</span><br><span class="line">    <span class="type">UserBackpack</span> <span class="variable">userBackpack</span> <span class="operator">=</span> event.getUserBackpack();</span><br><span class="line">    <span class="type">ItemConfig</span> <span class="variable">itemConfig</span> <span class="operator">=</span> itemCache.getById(userBackpack.getItemId());</span><br><span class="line">    <span class="keyword">if</span> (ItemTypeEnum.BADGE.getType().equals(itemConfig.getType())) &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userDao.getById(userBackpack.getUid());</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(user.getItemId())) &#123;</span><br><span class="line">            userDao.wearingBadge(userBackpack.getUid(), userBackpack.getItemId());</span><br><span class="line">            userCache.userInfoChange(userBackpack.getUid());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="Message模块"   >
          <a href="#Message模块" class="heading-link"><i class="fas fa-link"></i></a><a href="#Message模块" class="headerlink" title="Message模块"></a>Message模块</h3>
      
        <h4 id="消息发送事件"   >
          <a href="#消息发送事件" class="heading-link"><i class="fas fa-link"></i></a><a href="#消息发送事件" class="headerlink" title="消息发送事件"></a>消息发送事件</h4>
      
        <h5 id="异步发送消息推送"   >
          <a href="#异步发送消息推送" class="heading-link"><i class="fas fa-link"></i></a><a href="#异步发送消息推送" class="headerlink" title="异步发送消息推送"></a>异步发送消息推送</h5>
      <p>当消息发送之后异步推送给全部在线用户</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Async</span>  <span class="comment">//异步注解</span></span><br><span class="line">   <span class="meta">@TransactionalEventListener(classes = MessageSendEvent.class, fallbackExecution = true)</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">notifyAllOnline</span><span class="params">(MessageSendEvent event)</span> &#123;</span><br><span class="line">       <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> messageDao.getById(event.getMsgId());</span><br><span class="line">       <span class="type">ChatMessageResp</span> <span class="variable">msgResp</span> <span class="operator">=</span> chatService.getMsgResp(message, <span class="literal">null</span>);</span><br><span class="line">       webSocketService.sendToAllOnline(WSAdapter.buildMsgSend(msgResp), message.getFromUid());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="ChatGPT的接收与回复"   >
          <a href="#ChatGPT的接收与回复" class="heading-link"><i class="fas fa-link"></i></a><a href="#ChatGPT的接收与回复" class="headerlink" title="ChatGPT的接收与回复"></a>ChatGPT的接收与回复</h5>
      <p>消息发送给chatgpt，让其进行一个响应与回复</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@TransactionalEventListener(classes = MessageSendEvent.class, fallbackExecution = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handlerMsg</span><span class="params">(<span class="meta">@NotNull</span> MessageSendEvent event)</span> &#123;</span><br><span class="line">    <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> messageDao.getById(event.getMsgId());</span><br><span class="line">    openAIService.chat(message);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@TransactionalEventListener(classes = MessageSendEvent.class, fallbackExecution = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">publishChatToWechat</span><span class="params">(<span class="meta">@NotNull</span> MessageSendEvent event)</span> &#123;</span><br><span class="line">    <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> messageDao.getById(event.getMsgId());</span><br><span class="line">    <span class="keyword">if</span> (Objects.nonNull(message.getExtra().getAtUidList())) &#123;</span><br><span class="line">        weChatMsgOperationService.publishChatMsgToWeChatUser(message.getFromUid(), message.getExtra().getAtUidList(),</span><br><span class="line">                message.getContent());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h4 id="消息标记事件"   >
          <a href="#消息标记事件" class="heading-link"><i class="fas fa-link"></i></a><a href="#消息标记事件" class="headerlink" title="消息标记事件"></a>消息标记事件</h4>
      
        <h5 id="异步标记消息推送"   >
          <a href="#异步标记消息推送" class="heading-link"><i class="fas fa-link"></i></a><a href="#异步标记消息推送" class="headerlink" title="异步标记消息推送"></a>异步标记消息推送</h5>
      <p>将标记消息异步推送给所有在线用户</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Async</span></span><br><span class="line"><span class="meta">@TransactionalEventListener(classes = MessageMarkEvent.class, fallbackExecution = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">notifyAll</span><span class="params">(MessageMarkEvent event)</span> &#123;<span class="comment">//后续可做合并查询，目前异步影响不大</span></span><br><span class="line">    <span class="type">ChatMessageMarkDTO</span> <span class="variable">dto</span> <span class="operator">=</span> event.getDto();</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">markCount</span> <span class="operator">=</span> messageMarkDao.getMarkCount(dto.getMsgId(), dto.getMarkType());</span><br><span class="line">    webSocketService.sendToAllOnline(WSAdapter.buildMsgMarkSend(dto, markCount), dto.getUid());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h5 id="统计消息被点赞次数"   >
          <a href="#统计消息被点赞次数" class="heading-link"><i class="fas fa-link"></i></a><a href="#统计消息被点赞次数" class="headerlink" title="统计消息被点赞次数"></a>统计消息被点赞次数</h5>
      <p>①判断消息的类型是否是普通消息类型</p>
<p>②如果是普通消息查询数据库<del>Message_Mark</del>中Msg_id对应的赞以及举报的条数</p>
<p>③如果点赞次数等于发放点赞勋章次数<del>10次</del>，那么尝试发放勋章</p>
<p>④因为勋章的幂等性和唯一性，所以能保证一个用户只能发放一张爆赞勋章</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Async</span></span><br><span class="line">   <span class="meta">@TransactionalEventListener(classes = MessageMarkEvent.class, fallbackExecution = true)</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">changeMsgType</span><span class="params">(MessageMarkEvent event)</span> &#123;</span><br><span class="line">       <span class="type">ChatMessageMarkDTO</span> <span class="variable">dto</span> <span class="operator">=</span> event.getDto();</span><br><span class="line">       <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> messageDao.getById(dto.getMsgId());</span><br><span class="line">       <span class="keyword">if</span> (!Objects.equals(msg.getType(), MessageTypeEnum.TEXT.getType())) &#123;<span class="comment">//普通消息才需要升级</span></span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//消息被标记次数</span></span><br><span class="line">       <span class="type">Integer</span> <span class="variable">markCount</span> <span class="operator">=</span> messageMarkDao.getMarkCount(dto.getMsgId(), dto.getMarkType());</span><br><span class="line">       <span class="type">MessageMarkTypeEnum</span> <span class="variable">markTypeEnum</span> <span class="operator">=</span> MessageMarkTypeEnum.of(dto.getMarkType());</span><br><span class="line">       <span class="keyword">if</span> (markCount &lt; markTypeEnum.getRiseNum()) &#123;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (MessageMarkTypeEnum.LIKE.getType().equals(dto.getMarkType())) &#123;<span class="comment">//尝试给用户发送一张徽章</span></span><br><span class="line">           iUserBackpackService.acquireItem(msg.getFromUid(), ItemEnum.LIKE_BADGE.getId(), IdempotentEnum.MSG_ID, msg.getId().toString());</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></div></figure>




        <h4 id="消息撤回事件"   >
          <a href="#消息撤回事件" class="heading-link"><i class="fas fa-link"></i></a><a href="#消息撤回事件" class="headerlink" title="消息撤回事件"></a>消息撤回事件</h4>
      
        <h5 id="异步撤回消息推送"   >
          <a href="#异步撤回消息推送" class="heading-link"><i class="fas fa-link"></i></a><a href="#异步撤回消息推送" class="headerlink" title="异步撤回消息推送"></a>异步撤回消息推送</h5>
      <p>将撤回消息异步推送给所有在线用户</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Async</span></span><br><span class="line"><span class="meta">@TransactionalEventListener(classes = MessageRecallEvent.class, fallbackExecution = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendToAll</span><span class="params">(MessageRecallEvent event)</span> &#123;</span><br><span class="line">    webSocketService.sendToAllOnline(WSAdapter.buildMsgRecall(event.getRecallDTO()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="更新消息缓存池"   >
          <a href="#更新消息缓存池" class="heading-link"><i class="fas fa-link"></i></a><a href="#更新消息缓存池" class="headerlink" title="更新消息缓存池"></a>更新消息缓存池</h5>
      <p>更新tomcat本地缓存，消息已经置为撤回状态</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Async</span></span><br><span class="line">    <span class="meta">@TransactionalEventListener(classes = MessageRecallEvent.class, fallbackExecution = true)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">evictMsg</span><span class="params">(MessageRecallEvent event)</span> &#123;</span><br><span class="line">        <span class="type">ChatMsgRecallDTO</span> <span class="variable">recallDTO</span> <span class="operator">=</span> event.getRecallDTO();</span><br><span class="line">        msgCache.evictMsg(recallDTO.getMsgId());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>








        <h1 id="亮点"   >
          <a href="#亮点" class="heading-link"><i class="fas fa-link"></i></a><a href="#亮点" class="headerlink" title="亮点"></a>亮点</h1>
      
        <h2 id="注解分布式锁"   >
          <a href="#注解分布式锁" class="heading-link"><i class="fas fa-link"></i></a><a href="#注解分布式锁" class="headerlink" title="注解分布式锁"></a>注解分布式锁</h2>
      <p>通过注解的方式开发分布式锁</p>
<p><strong>优点</strong></p>
<ul>
<li>1.<strong>无侵入</strong>，Controller层或者Service层中没有具体加锁解锁的代码</li>
<li>2.<strong>锁的独有</strong>，加锁和释放锁只能同一个线程完成</li>
<li>3.<strong>支持多种方式获取传参Key</strong>，通过注解的指定参数名，通过反射，动态获取key</li>
</ul>
<p>主要的特点就是<strong>无侵入</strong>以及<strong>传参key可以通过反射获取</strong></p>

        <h3 id="创建注解-RedissonLock"   >
          <a href="#创建注解-RedissonLock" class="heading-link"><i class="fas fa-link"></i></a><a href="#创建注解-RedissonLock" class="headerlink" title="创建注解@RedissonLock"></a>创建注解@RedissonLock</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span><span class="comment">//运行时生效</span></span><br><span class="line"><span class="meta">@Target(ElementType.METHOD)</span><span class="comment">//作用在方法上</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> RedissonLock &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * key的前缀,默认取方法全限定名，除非我们在不同方法上对同一个资源做分布式锁，就自己指定</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> key的前缀</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">prefixKey</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * springEl 表达式</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 表达式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">key</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 等待锁的时间，默认-1，不等待直接失败,redisson默认也是-1</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 单位秒</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">waitTime</span><span class="params">()</span> <span class="keyword">default</span> -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 等待锁的时间单位，默认毫秒</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 单位</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    TimeUnit <span class="title function_">unit</span><span class="params">()</span> <span class="keyword">default</span> TimeUnit.MILLISECONDS;</span><br></pre></td></tr></table></div></figure>

<p>注解中的参数</p>
<p>prefixKey:key前缀 如果传入参数中prefix为空则是方法类名+方法名 否则则为传入的prefix </p>
<p>key:传入的key </p>
<p>waitTime:传入的等锁时间 如果不传入则默认为-1不会重试获取锁</p>
<p>unit:等待锁的时间单位 默认是毫秒</p>

        <h3 id="AOP切面"   >
          <a href="#AOP切面" class="heading-link"><i class="fas fa-link"></i></a><a href="#AOP切面" class="headerlink" title="AOP切面"></a>AOP切面</h3>
      <p>AOP的意义在于每个不影响业务的相同非业务代码抽取出来形成一个对象，这样可以减少耦合</p>
<p>这个aop主要是拼接了prefix和key 然后调用lockService中的方法去调用RedisSonclient实行锁的加锁解锁</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Order(0)</span><span class="comment">//确保比事务注解先执行，分布式锁在事务外</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedissonLockAspect</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LockService lockService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around(&quot;@annotation(com.abin.mallchat.common.common.annotation.RedissonLock)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">around</span><span class="params">(ProceedingJoinPoint joinPoint)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> ((MethodSignature) joinPoint.getSignature()).getMethod();</span><br><span class="line">        <span class="type">RedissonLock</span> <span class="variable">redissonLock</span> <span class="operator">=</span> method.getAnnotation(RedissonLock.class);</span><br><span class="line"> 		<span class="comment">//拼接前缀</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">prefix</span> <span class="operator">=</span> StrUtil.isBlank(redissonLock.prefixKey()) ? SpElUtils.getMethodKey(method) : redissonLock.prefixKey();<span class="comment">//默认方法限定名+注解排名（可能多个）</span></span><br><span class="line">        <span class="comment">//获取key</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> SpElUtils.parseSpEl(method, joinPoint.getArgs(), redissonLock.key());</span><br><span class="line">        <span class="comment">//最终Redis中锁的key为拼接前缀+传参key 调用lockService中的方法</span></span><br><span class="line">        <span class="keyword">return</span> lockService.executeWithLockThrows(prefix + <span class="string">&quot;:&quot;</span> + key, redissonLock.waitTime(), redissonLock.unit(), joinPoint::proceed);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="LockService"   >
          <a href="#LockService" class="heading-link"><i class="fas fa-link"></i></a><a href="#LockService" class="headerlink" title="LockService"></a>LockService</h3>
      <p>这个实现类中也就是使用RedissonClient进行一个加锁的操作，本质上就是Redisson的过程</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LockService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">executeWithLockThrows</span><span class="params">(String key, <span class="type">int</span> waitTime, TimeUnit unit, SupplierThrow&lt;T&gt; supplier)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(key);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">lockSuccess</span> <span class="operator">=</span> lock.tryLock(waitTime, unit);</span><br><span class="line">        <span class="keyword">if</span> (!lockSuccess) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(CommonErrorEnum.LOCK_LIMIT);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> supplier.get();<span class="comment">//执行锁内的代码逻辑</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (lock.isLocked() &amp;&amp; lock.isHeldByCurrentThread()) &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">executeWithLock</span><span class="params">(String key, <span class="type">int</span> waitTime, TimeUnit unit, Supplier&lt;T&gt; supplier)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> executeWithLockThrows(key, waitTime, unit, supplier::get);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">executeWithLock</span><span class="params">(String key, Supplier&lt;T&gt; supplier)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> executeWithLock(key, -<span class="number">1</span>, TimeUnit.MILLISECONDS, supplier);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@FunctionalInterface</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SupplierThrow</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Gets a result.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> a result</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        T <span class="title function_">get</span><span class="params">()</span> <span class="keyword">throws</span> Throwable;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        List&lt;String&gt; sensitiveList = Arrays.asList(<span class="string">&quot;abcd&quot;</span>, <span class="string">&quot;abcbba&quot;</span>, <span class="string">&quot;adabca&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> <span class="string">&quot;abcdefg&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (String s : sensitiveList) &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">hit</span> <span class="operator">=</span> text.contains(s);</span><br><span class="line">            System.out.println(hit);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="注解的使用"   >
          <a href="#注解的使用" class="heading-link"><i class="fas fa-link"></i></a><a href="#注解的使用" class="headerlink" title="注解的使用"></a>注解的使用</h3>
      <p>使用范围是在方法上，利用el表达式来传参 反射获取方法名中的idempotent</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RedissonLock(key = &quot;#idempotent&quot;, waitTime = 5000)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doAcquireItem</span><span class="params">(Long uid, Long itemId, String idempotent)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h2 id="频控注解"   >
          <a href="#频控注解" class="heading-link"><i class="fas fa-link"></i></a><a href="#频控注解" class="headerlink" title="频控注解"></a>频控注解</h2>
      <p>频控的使用地方</p>
<ul>
<li>1.发送消息规定5秒只能发两条，30秒发5条，60秒10条 为了防止一直刷屏</li>
<li>2.消息标记以及消息撤回的频控管理，防止一直瞎点</li>
<li>3.消息列表的获取</li>
<li>4.微信接口的限制，生成登录二维码的频控</li>
</ul>

        <h3 id="创建注解-FrequencyControl"   >
          <a href="#创建注解-FrequencyControl" class="heading-link"><i class="fas fa-link"></i></a><a href="#创建注解-FrequencyControl" class="headerlink" title="创建注解@FrequencyControl"></a>创建注解@FrequencyControl</h3>
      <p>这个关键注解在于@Repeatable 可重复注解使其可以多个相同注解加到同一个方法上</p>
<p>主要还是利用了Redis来实现一个频控，所以传入了Prefixkey、和el表达式 spel   两者拼接成为Redis中的key</p>
<p>time和unit是限制时间，count是统计次数，target是因为注解加到接口上可以通过上下文获取id和uid，如果是这两个的话就不用传入el表达式了</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repeatable(FrequencyControlContainer.class)</span><span class="comment">//可重复</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span><span class="comment">//运行时生效</span></span><br><span class="line"><span class="meta">@Target(ElementType.METHOD)</span><span class="comment">//作用在方法上</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> FrequencyControl &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * key的前缀,默认取方法全限定名，除非我们在不同方法上对同一个资源做频控，就自己指定</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> key的前缀</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">prefixKey</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 频控对象，默认el表达指定具体的频控对象</span></span><br><span class="line"><span class="comment">     * 对于ip 和uid模式，需要是http入口的对象，保证RequestHolder里有值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Target <span class="title function_">target</span><span class="params">()</span> <span class="keyword">default</span> Target.EL;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * springEl 表达式，target=EL必填</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 表达式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">spEl</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 频控时间范围，默认单位秒</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 时间范围</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">time</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 频控时间单位，默认秒</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 单位</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    TimeUnit <span class="title function_">unit</span><span class="params">()</span> <span class="keyword">default</span> TimeUnit.SECONDS;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 单位时间内最大访问次数</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 次数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">count</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">Target</span> &#123;</span><br><span class="line">        UID, IP, EL</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h3 id="AOP切面-1"   >
          <a href="#AOP切面-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#AOP切面-1" class="headerlink" title="AOP切面"></a>AOP切面</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FrequencyControlAspect</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around(&quot;@annotation(com.abin.mallchat.common.common.annotation.FrequencyControl)||@annotation(com.abin.mallchat.common.common.annotation.FrequencyControlContainer)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">around</span><span class="params">(ProceedingJoinPoint joinPoint)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> ((MethodSignature) joinPoint.getSignature()).getMethod();</span><br><span class="line">        FrequencyControl[] annotationsByType = method.getAnnotationsByType(FrequencyControl.class);</span><br><span class="line">        Map&lt;String, FrequencyControl&gt; keyMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; annotationsByType.length; i++) &#123;</span><br><span class="line">            <span class="type">FrequencyControl</span> <span class="variable">frequencyControl</span> <span class="operator">=</span> annotationsByType[i];</span><br><span class="line">            <span class="type">String</span> <span class="variable">prefix</span> <span class="operator">=</span> StrUtil.isBlank(frequencyControl.prefixKey()) ? SpElUtils.getMethodKey(method) + <span class="string">&quot;:index:&quot;</span> + i : frequencyControl.prefixKey();<span class="comment">//默认方法限定名+注解排名（可能多个）</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">switch</span> (frequencyControl.target()) &#123;</span><br><span class="line">                <span class="keyword">case</span> EL:</span><br><span class="line">                    key = SpElUtils.parseSpEl(method, joinPoint.getArgs(), frequencyControl.spEl());</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> IP:</span><br><span class="line">                    key = RequestHolder.get().getIp();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> UID:</span><br><span class="line">                    key = RequestHolder.get().getUid().toString();</span><br><span class="line">            &#125;</span><br><span class="line">            keyMap.put(prefix + <span class="string">&quot;:&quot;</span> + key, frequencyControl);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将注解的参数转换为编程式调用需要的参数</span></span><br><span class="line">        List&lt;FrequencyControlDTO&gt; frequencyControlDTOS = keyMap.entrySet().stream().map(entrySet -&gt; buildFrequencyControlDTO(entrySet.getKey(), entrySet.getValue())).collect(Collectors.toList());</span><br><span class="line">        <span class="comment">// 调用编程式注解</span></span><br><span class="line">        <span class="keyword">return</span> FrequencyControlUtil.executeWithFrequencyControlList(TOTAL_COUNT_WITH_IN_FIX_TIME_FREQUENCY_CONTROLLER, frequencyControlDTOS, joinPoint::proceed);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将注解参数转换为编程式调用所需要的参数</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key              频率控制Key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> frequencyControl 注解</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 编程式调用所需要的参数-FrequencyControlDTO</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> FrequencyControlDTO <span class="title function_">buildFrequencyControlDTO</span><span class="params">(String key, FrequencyControl frequencyControl)</span> &#123;</span><br><span class="line">        <span class="type">FrequencyControlDTO</span> <span class="variable">frequencyControlDTO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FrequencyControlDTO</span>();</span><br><span class="line">        frequencyControlDTO.setCount(frequencyControl.count());</span><br><span class="line">        frequencyControlDTO.setTime(frequencyControl.time());</span><br><span class="line">        frequencyControlDTO.setUnit(frequencyControl.unit());</span><br><span class="line">        frequencyControlDTO.setKey(key);</span><br><span class="line">        <span class="keyword">return</span> frequencyControlDTO;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>频控切面做了三件事</p>

        <h4 id="拼接Key"   >
          <a href="#拼接Key" class="heading-link"><i class="fas fa-link"></i></a><a href="#拼接Key" class="headerlink" title="拼接Key"></a>拼接Key</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> ((MethodSignature) joinPoint.getSignature()).getMethod();</span><br><span class="line">        FrequencyControl[] annotationsByType = method.getAnnotationsByType(FrequencyControl.class);</span><br><span class="line">        Map&lt;String, FrequencyControl&gt; keyMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; annotationsByType.length; i++) &#123;</span><br><span class="line">            <span class="type">FrequencyControl</span> <span class="variable">frequencyControl</span> <span class="operator">=</span> annotationsByType[i];</span><br><span class="line">            <span class="type">String</span> <span class="variable">prefix</span> <span class="operator">=</span> StrUtil.isBlank(frequencyControl.prefixKey()) ? SpElUtils.getMethodKey(method) + <span class="string">&quot;:index:&quot;</span> + i : frequencyControl.prefixKey();<span class="comment">//默认方法限定名+注解排名（可能多个）</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">switch</span> (frequencyControl.target()) &#123;</span><br><span class="line">                <span class="keyword">case</span> EL:</span><br><span class="line">                    key = SpElUtils.parseSpEl(method, joinPoint.getArgs(), frequencyControl.spEl());</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> IP:</span><br><span class="line">                    key = RequestHolder.get().getIp();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> UID:</span><br><span class="line">                    key = RequestHolder.get().getUid().toString();</span><br><span class="line">            &#125;</span><br><span class="line">            keyMap.put(prefix + <span class="string">&quot;:&quot;</span> + key, frequencyControl);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></div></figure>




        <h4 id="查询Redis中的key的次数，判断是否达到限制"   >
          <a href="#查询Redis中的key的次数，判断是否达到限制" class="heading-link"><i class="fas fa-link"></i></a><a href="#查询Redis中的key的次数，判断是否达到限制" class="headerlink" title="查询Redis中的key的次数，判断是否达到限制"></a>查询Redis中的key的次数，判断是否达到限制</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">reachRateLimit</span><span class="params">(Map&lt;String, FrequencyControlDTO&gt; frequencyControlMap)</span> &#123;</span><br><span class="line">    <span class="comment">//批量获取redis统计的值</span></span><br><span class="line">    List&lt;String&gt; frequencyKeys = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(frequencyControlMap.keySet());</span><br><span class="line">    List&lt;Integer&gt; countList = RedisUtils.mget(frequencyKeys, Integer.class);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; frequencyKeys.size(); i++) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> frequencyKeys.get(i);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> countList.get(i);</span><br><span class="line">        <span class="type">int</span> <span class="variable">frequencyControlCount</span> <span class="operator">=</span> frequencyControlMap.get(key).getCount();</span><br><span class="line">        <span class="keyword">if</span> (Objects.nonNull(count) &amp;&amp; count &gt;= frequencyControlCount) &#123;</span><br><span class="line">            <span class="comment">//频率超过了</span></span><br><span class="line">            log.warn(<span class="string">&quot;frequencyControl limit key:&#123;&#125;,count:&#123;&#125;&quot;</span>, key, count);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="无论是否达到限制都会统计次数并且设置过期时间"   >
          <a href="#无论是否达到限制都会统计次数并且设置过期时间" class="heading-link"><i class="fas fa-link"></i></a><a href="#无论是否达到限制都会统计次数并且设置过期时间" class="headerlink" title="无论是否达到限制都会统计次数并且设置过期时间"></a>无论是否达到限制都会统计次数并且设置过期时间</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">addFrequencyControlStatisticsCount</span><span class="params">(Map&lt;String, FrequencyControlDTO&gt; frequencyControlMap)</span> &#123;</span><br><span class="line">    frequencyControlMap.forEach((k, v) -&gt; RedisUtils.inc(k, v.getTime(), v.getUnit()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>利用lua脚本对key添加次数以及设置过期时间使其成为原子操作</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LUA_INCR_EXPIRE</span> <span class="operator">=</span></span><br><span class="line">            <span class="string">&quot;local key,ttl=KEYS[1],ARGV[1] \n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; \n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;if redis.call(&#x27;EXISTS&#x27;,key)==0 then   \n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;  redis.call(&#x27;SETEX&#x27;,key,ttl,1) \n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;  return 1 \n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;else \n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;  return tonumber(redis.call(&#x27;INCR&#x27;,key)) \n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;end &quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Long <span class="title function_">inc</span><span class="params">(String key, <span class="type">int</span> time, TimeUnit unit)</span> &#123;</span><br><span class="line">        RedisScript&lt;Long&gt; redisScript = <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(LUA_INCR_EXPIRE, Long.class);</span><br><span class="line">        <span class="keyword">return</span> stringRedisTemplate.execute(redisScript, Collections.singletonList(key), String.valueOf(unit.toSeconds(time)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>




        <h3 id="总结"   >
          <a href="#总结" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结" class="headerlink" title="总结"></a>总结</h3>
      <p>使用Redis的固定时间实现一个频控，频控注解中加了@Repeatable注解使其能在同一个方法中重复使用</p>
<p>在规定时间内达到次数就抛出异常不执行业务代码</p>

        <h2 id="统一线程池管理"   >
          <a href="#统一线程池管理" class="heading-link"><i class="fas fa-link"></i></a><a href="#统一线程池管理" class="headerlink" title="统一线程池管理"></a>统一线程池管理</h2>
      
        <h3 id="创建线程池"   >
          <a href="#创建线程池" class="heading-link"><i class="fas fa-link"></i></a><a href="#创建线程池" class="headerlink" title="创建线程池"></a>创建线程池</h3>
      <p>创建线程池做了两件事 </p>
<ul>
<li>1.实现了AsyncConfigurer接口，这使其@Async注解也能使用自建的线程池</li>
<li>2.利用ThreadPoolTaskExecutor创建线程池</li>
</ul>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolConfig</span> <span class="keyword">implements</span> <span class="title class_">AsyncConfigurer</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 项目共用线程池</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MALLCHAT_EXECUTOR</span> <span class="operator">=</span> <span class="string">&quot;mallchatExecutor&quot;</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * websocket通信线程池</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">WS_EXECUTOR</span> <span class="operator">=</span> <span class="string">&quot;websocketExecutor&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">AICHAT_EXECUTOR</span> <span class="operator">=</span> <span class="string">&quot;aichatExecutor&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Executor <span class="title function_">getAsyncExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mallchatExecutor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(MALLCHAT_EXECUTOR)</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="keyword">public</span> ThreadPoolTaskExecutor <span class="title function_">mallchatExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ThreadPoolTaskExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolTaskExecutor</span>();</span><br><span class="line">        executor.setCorePoolSize(<span class="number">10</span>);</span><br><span class="line">        executor.setMaxPoolSize(<span class="number">10</span>);</span><br><span class="line">        executor.setQueueCapacity(<span class="number">200</span>);</span><br><span class="line">        executor.setThreadNamePrefix(<span class="string">&quot;mallchat-executor-&quot;</span>);</span><br><span class="line">        executor.setRejectedExecutionHandler(<span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.CallerRunsPolicy());<span class="comment">//满了调用线程执行，认为重要任务</span></span><br><span class="line">        executor.setThreadFactory(<span class="keyword">new</span> <span class="title class_">MyThreadFactory</span>(executor));</span><br><span class="line">        executor.initialize();</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(WS_EXECUTOR)</span></span><br><span class="line">    <span class="keyword">public</span> ThreadPoolTaskExecutor <span class="title function_">websocketExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ThreadPoolTaskExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolTaskExecutor</span>();</span><br><span class="line">        executor.setCorePoolSize(<span class="number">16</span>);</span><br><span class="line">        executor.setMaxPoolSize(<span class="number">16</span>);</span><br><span class="line">        executor.setQueueCapacity(<span class="number">1000</span>);<span class="comment">//支持同时推送1000人</span></span><br><span class="line">        executor.setThreadNamePrefix(<span class="string">&quot;websocket-executor-&quot;</span>);</span><br><span class="line">        executor.setRejectedExecutionHandler(<span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.DiscardPolicy());<span class="comment">//满了直接丢弃，默认为不重要消息推送</span></span><br><span class="line">        executor.setThreadFactory(<span class="keyword">new</span> <span class="title class_">MyThreadFactory</span>(executor));</span><br><span class="line">        executor.initialize();</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(AICHAT_EXECUTOR)</span></span><br><span class="line">    <span class="keyword">public</span> ThreadPoolTaskExecutor <span class="title function_">chatAiExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ThreadPoolTaskExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolTaskExecutor</span>();</span><br><span class="line">        executor.setCorePoolSize(<span class="number">10</span>);</span><br><span class="line">        executor.setMaxPoolSize(<span class="number">10</span>);</span><br><span class="line">        executor.setQueueCapacity(<span class="number">15</span>);</span><br><span class="line">        executor.setThreadNamePrefix(<span class="string">&quot;aichat-executor-&quot;</span>);</span><br><span class="line">        executor.setRejectedExecutionHandler(<span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.DiscardPolicy());<span class="comment">//满了直接丢弃，默认为不重要消息推送</span></span><br><span class="line">        executor.setThreadFactory(<span class="keyword">new</span> <span class="title class_">MyThreadFactory</span>(executor));</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="线程池的停机销毁"   >
          <a href="#线程池的停机销毁" class="heading-link"><i class="fas fa-link"></i></a><a href="#线程池的停机销毁" class="headerlink" title="线程池的停机销毁"></a>线程池的停机销毁</h3>
      <p>自建线程池是通过Spring来进行一个管理，所以当项目停机的时候就交给了Spring进行停机</p>

        <h3 id="线程池的使用"   >
          <a href="#线程池的使用" class="heading-link"><i class="fas fa-link"></i></a><a href="#线程池的使用" class="headerlink" title="线程池的使用"></a>线程池的使用</h3>
      <ul>
<li><p>1.利用Bean名字自动注入 </p>
<p><em>因为Caonfig中将线程池交给了Spring管理，要使用时注入即可</em></p>
</li>
</ul>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Qualifier(ThreadPoolConfig.WS_EXECUTOR)</span></span><br><span class="line"><span class="keyword">private</span> ThreadPoolTaskExecutor threadPoolTaskExecutor;</span><br></pre></td></tr></table></div></figure>

<ul>
<li><p>2.利用@Async注解</p>
<p><em>在方法名前面加上@Async注解使其交给线程池处理</em></p>
</li>
</ul>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Async</span></span><br><span class="line">  <span class="meta">@EventListener(classes = UserOnlineEvent.class)</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveRedisAndPush</span><span class="params">(UserOnlineEvent event)</span> &#123;</span><br><span class="line">      <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> event.getUser();</span><br><span class="line">      userCache.online(user.getId(), user.getLastOptTime());</span><br><span class="line">      <span class="comment">//推送给所有在线用户，该用户登录成功</span></span><br><span class="line">      webSocketService.sendToAllOnline(wsAdapter.buildOnlineNotifyResp(event.getUser()));</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="异常捕获"   >
          <a href="#异常捕获" class="heading-link"><i class="fas fa-link"></i></a><a href="#异常捕获" class="headerlink" title="异常捕获"></a>异常捕获</h3>
      <p>我们正常捕获异常</p>
<p>这有一段简单模拟捕获异常的代码</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.info(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;抛出异常&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;出错了&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        t.start();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>

<p>运行结果</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">20:23:27.741 [Thread-1] INFO com.kkker1.TestThread - 1</span><br><span class="line">20:23:27.744 [Thread-1] ERROR com.kkker1.TestThread - 出错了</span><br></pre></td></tr></table></div></figure>

<p>捕获完异常，异常输出是以日志打印的方式输出</p>
<p><em>只会打印在控制台而不会输出到Error日志中，所以这是一个很危险的操作，不做处理可能会导致我们不能及时发现异常</em></p>
<p>所以我们需要将日志输出到Error日志中，要怎么操作</p>
<ul>
<li>自定义线程添加异常捕获器处理器，使其输出到Error日志中</li>
<li>线程池利用<strong>修饰器模式</strong>，保持原有Spring的工厂然后扩展异常捕获处理器</li>
</ul>
<p>例如项目中的操作</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">executor.setThreadFactory(<span class="keyword">new</span> <span class="title class_">MyThreadFactory</span>(executor));</span><br></pre></td></tr></table></div></figure>

<p>MyThreadFactory</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyThreadFactory</span>  <span class="keyword">implements</span> <span class="title class_">ThreadFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ThreadFactory factory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Thread <span class="title function_">newThread</span><span class="params">(Runnable r)</span> &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span>factory.newThread(r);</span><br><span class="line">        thread.setUncaughtExceptionHandler(<span class="keyword">new</span> <span class="title class_">GlobalUncaughtExceptionHandler</span>());</span><br><span class="line">        <span class="keyword">return</span> thread;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>GlobalUncaughtExceptionHandler</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Slf4j</span><br><span class="line">public class GlobalUncaughtExceptionHandler  implements Thread.UncaughtExceptionHandler &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void uncaughtException(Thread t, Throwable e) &#123;</span><br><span class="line">        log.error(&quot;Exception in thread &#123;&#125; &quot;, t.getName(), e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h1 id="异常情况"   >
          <a href="#异常情况" class="heading-link"><i class="fas fa-link"></i></a><a href="#异常情况" class="headerlink" title="异常情况"></a>异常情况</h1>
      <p><strong>打上断点进行调试</strong></p>

        <h2 id="异常在线用户数量，用户已经下线而显示还在线上中"   >
          <a href="#异常在线用户数量，用户已经下线而显示还在线上中" class="heading-link"><i class="fas fa-link"></i></a><a href="#异常在线用户数量，用户已经下线而显示还在线上中" class="headerlink" title="异常在线用户数量，用户已经下线而显示还在线上中"></a>异常在线用户数量，用户已经下线而显示还在线上中</h2>
      
        <h3 id="用户端1"   >
          <a href="#用户端1" class="heading-link"><i class="fas fa-link"></i></a><a href="#用户端1" class="headerlink" title="用户端1"></a>用户端1</h3>
      <p>未登录用户界面</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230804170246021.png"  alt="用戶端1">
      </p>
<p>浏览器Cache</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230804170416313.png"  alt="未登录Cache">
      </p>

        <h3 id="用户端2"   >
          <a href="#用户端2" class="heading-link"><i class="fas fa-link"></i></a><a href="#用户端2" class="headerlink" title="用户端2"></a>用户端2</h3>
      <p>已登录用户用户端</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230804170527319.png"  alt="已登录用户端">
      </p>
<p>浏览器Cache</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230804170656484.png"  alt="浏览器Cache">
      </p>

        <h3 id="退出用户端2"   >
          <a href="#退出用户端2" class="heading-link"><i class="fas fa-link"></i></a><a href="#退出用户端2" class="headerlink" title="退出用户端2"></a>退出用户端2</h3>
      <p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230804170829700.png"  alt="退出用户端2">
      </p>
<p>正如用户端1客户端显示一样</p>

        <h3 id="原因"   >
          <a href="#原因" class="heading-link"><i class="fas fa-link"></i></a><a href="#原因" class="headerlink" title="原因"></a>原因</h3>
      <p>虚拟机关闭导致Redis关闭，而用户下线的事件要更新Redis时，连接关闭导致无法下线用户10003</p>

        <h2 id="抛出InvalidDataAccessApiUsageException异常"   >
          <a href="#抛出InvalidDataAccessApiUsageException异常" class="heading-link"><i class="fas fa-link"></i></a><a href="#抛出InvalidDataAccessApiUsageException异常" class="headerlink" title="抛出InvalidDataAccessApiUsageException异常"></a>抛出InvalidDataAccessApiUsageException异常</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">JDBC Connection [HikariProxyConnection@<span class="number">2146628671</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@4cd7671d] will not be managed by Spring</span><br><span class="line">==&gt;  Preparing: UPDATE user SET last_opt_time=? WHERE id=?</span><br><span class="line">==&gt; Parameters: <span class="number">2023</span>-<span class="number">07</span>-<span class="number">30</span> <span class="number">17</span>:<span class="number">23</span>:<span class="number">43.267</span>(Timestamp), <span class="number">10003</span>(Long)</span><br><span class="line">|ERROR|<span class="number">2023</span>-<span class="number">07</span>-<span class="number">30</span> <span class="number">17</span>:<span class="number">23</span>:<span class="number">43.274</span>|mallchat-executor-<span class="number">7</span>||uid=|Unexpected exception occurred invoking async method: <span class="keyword">public</span> <span class="keyword">void</span> com.abin.mallchat.custom.common.event.listener.UserOfflineListener.saveRedisAndPush(com.abin.mallchat.common.common.event.UserOfflineEvent)|</span><br><span class="line">org.springframework.dao.InvalidDataAccessApiUsageException: Redisson is shutdown; nested exception is org.redisson.RedissonShutdownException: Redisson is shutdown</span><br><span class="line">	at org.redisson.spring.data.connection.RedissonExceptionConverter.convert(RedissonExceptionConverter.java:<span class="number">52</span>)</span><br><span class="line">	at org.redisson.spring.data.connection.RedissonExceptionConverter.convert(RedissonExceptionConverter.java:<span class="number">35</span>)</span><br><span class="line">	at org.springframework.data.redis.PassThroughExceptionTranslationStrategy.translate(PassThroughExceptionTranslationStrategy.java:<span class="number">44</span>)</span><br><span class="line">	at org.redisson.spring.data.connection.RedissonConnection.transform(RedissonConnection.java:<span class="number">200</span>)</span><br><span class="line">	at org.redisson.spring.data.connection.RedissonConnection.syncFuture(RedissonConnection.java:<span class="number">195</span>)</span><br><span class="line">	at org.redisson.spring.data.connection.RedissonConnection.sync(RedissonConnection.java:<span class="number">364</span>)</span><br><span class="line">	at org.redisson.spring.data.connection.RedissonConnection.write(RedissonConnection.java:<span class="number">730</span>)</span><br><span class="line">	at org.redisson.spring.data.connection.RedissonConnection.zRem(RedissonConnection.java:<span class="number">1021</span>)</span><br><span class="line">	at org.springframework.data.redis.connection.DefaultStringRedisConnection.zRem(DefaultStringRedisConnection.java:<span class="number">1829</span>)</span><br><span class="line">	at org.springframework.data.redis.core.DefaultZSetOperations.lambda$remove$<span class="number">27</span>(DefaultZSetOperations.java:<span class="number">444</span>)</span><br><span class="line">	at org.springframework.data.redis.core.RedisTemplate.execute(RedisTemplate.java:<span class="number">223</span>)</span><br><span class="line">	at org.springframework.data.redis.core.RedisTemplate.execute(RedisTemplate.java:<span class="number">190</span>)</span><br><span class="line">	at org.springframework.data.redis.core.AbstractOperations.execute(AbstractOperations.java:<span class="number">97</span>)</span><br><span class="line">	at org.springframework.data.redis.core.DefaultZSetOperations.remove(DefaultZSetOperations.java:<span class="number">444</span>)</span><br><span class="line">	at com.abin.mallchat.common.common.utils.RedisUtils.zRemove(RedisUtils.java:<span class="number">803</span>)</span><br><span class="line">	at com.abin.mallchat.common.common.utils.RedisUtils.zRemove(RedisUtils.java:<span class="number">799</span>)</span><br><span class="line">	at com.abin.mallchat.common.user.service.cache.UserCache.offline(UserCache.java:<span class="number">85</span>)</span><br><span class="line">	at com.abin.mallchat.common.user.service.cache.UserCache$$FastClassBySpringCGLIB$$4d4b28eb.invoke(&lt;generated&gt;)</span><br><span class="line">	at org.springframework.cglib.proxy.MethodProxy.invoke(MethodProxy.java:<span class="number">218</span>)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy.invokeMethod(CglibAopProxy.java:<span class="number">386</span>)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy.access$<span class="number">000</span>(CglibAopProxy.java:<span class="number">85</span>)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:<span class="number">704</span>)</span><br><span class="line">	at com.abin.mallchat.common.user.service.cache.UserCache$$EnhancerBySpringCGLIB$$6f823fec.offline(&lt;generated&gt;)</span><br><span class="line">	at com.abin.mallchat.custom.common.event.listener.UserOfflineListener.saveRedisAndPush(UserOfflineListener.java:<span class="number">36</span>)</span><br><span class="line">	at com.abin.mallchat.custom.common.event.listener.UserOfflineListener$$FastClassBySpringCGLIB$$c62500f3.invoke(&lt;generated&gt;)</span><br><span class="line">	at org.springframework.cglib.proxy.MethodProxy.invoke(MethodProxy.java:<span class="number">218</span>)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.invokeJoinpoint(CglibAopProxy.java:<span class="number">793</span>)</span><br><span class="line">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:<span class="number">163</span>)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:<span class="number">763</span>)</span><br><span class="line">	at org.springframework.aop.interceptor.AsyncExecutionInterceptor.lambda$invoke$<span class="number">0</span>(AsyncExecutionInterceptor.java:<span class="number">115</span>)</span><br><span class="line">	at java.util.concurrent.FutureTask.run(FutureTask.java:<span class="number">266</span>)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1149</span>)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">624</span>)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:<span class="number">748</span>)</span><br><span class="line">Caused by: org.redisson.RedissonShutdownException: Redisson is shutdown</span><br><span class="line">	at org.redisson.command.RedisExecutor.execute(RedisExecutor.java:<span class="number">118</span>)</span><br><span class="line">	at org.redisson.command.CommandAsyncService.async(CommandAsyncService.java:<span class="number">585</span>)</span><br><span class="line">	at org.redisson.command.CommandAsyncService.writeAsync(CommandAsyncService.java:<span class="number">554</span>)</span><br><span class="line">	at org.redisson.spring.data.connection.RedissonConnection.write(RedissonConnection.java:<span class="number">728</span>)</span><br><span class="line">	... <span class="number">27</span> common frames omitted</span><br><span class="line">&lt;==    Updates: <span class="number">1</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="执行的SQL语句"   >
          <a href="#执行的SQL语句" class="heading-link"><i class="fas fa-link"></i></a><a href="#执行的SQL语句" class="headerlink" title="执行的SQL语句"></a>执行的SQL语句</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">==&gt;Preparing: UPDATE user SET last_opt_time=? WHERE id=?</span><br><span class="line"><span class="comment">//更新user表 更新Last_opt_time(最后上下线时间) where id=?</span></span><br><span class="line">==&gt; Parameters: <span class="number">2023</span>-<span class="number">07</span>-<span class="number">30</span> <span class="number">17</span>:<span class="number">23</span>:<span class="number">43.267</span>(Timestamp), <span class="number">10003</span>(Long) </span><br><span class="line"><span class="comment">//传入时间戳和用户ID</span></span><br><span class="line">    </span><br><span class="line">   </span><br><span class="line"><span class="comment">//报错RedisSon is shutdown;</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">&lt;==    Updates: <span class="number">1</span></span><br><span class="line"><span class="comment">//更新成功</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="异常复现"   >
          <a href="#异常复现" class="heading-link"><i class="fas fa-link"></i></a><a href="#异常复现" class="headerlink" title="异常复现"></a>异常复现</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">==&gt;  Preparing: UPDATE user SET last_opt_time=? WHERE id=?</span><br><span class="line">==&gt; Parameters: <span class="number">2023</span>-<span class="number">07</span>-<span class="number">30</span> <span class="number">17</span>:<span class="number">45</span>:<span class="number">46.053</span>(Timestamp), <span class="number">10003</span>(Long)</span><br><span class="line">|ERROR|<span class="number">2023</span>-<span class="number">07</span>-<span class="number">30</span> <span class="number">17</span>:<span class="number">45</span>:<span class="number">46.061</span>|mallchat-executor-<span class="number">9</span>||uid=|Unexpected exception occurred invoking async method: <span class="keyword">public</span> <span class="keyword">void</span> com.abin.mallchat.custom.common.event.listener.UserOfflineListener.saveRedisAndPush(com.abin.mallchat.common.common.event.UserOfflineEvent)|</span><br><span class="line">org.springframework.dao.InvalidDataAccessApiUsageException: Redisson is shutdown; </span><br><span class="line">....</span><br><span class="line">	... <span class="number">27</span> common frames omitted</span><br><span class="line">&lt;==    Updates: <span class="number">1</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="分析原因"   >
          <a href="#分析原因" class="heading-link"><i class="fas fa-link"></i></a><a href="#分析原因" class="headerlink" title="分析原因"></a>分析原因</h3>
      <p>RedisSon is Shutdown 抛出的异常是因为后端的关闭，导致RedisSon实例关闭</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//抛出异常</span></span><br><span class="line">InvalidDataAccessApiUsageException: Redisson is shutdown; </span><br><span class="line">nested exception is org.redisson.RedissonShutdownException: Redisson is shutdown</span><br><span class="line"></span><br><span class="line"><span class="comment">//表示Redisson已经关闭</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="处理"   >
          <a href="#处理" class="heading-link"><i class="fas fa-link"></i></a><a href="#处理" class="headerlink" title="处理"></a>处理</h3>
      <p>这里是后端代码池先关闭导致的，所以不做处理也没关系</p>

        <h2 id="空指针异常"   >
          <a href="#空指针异常" class="heading-link"><i class="fas fa-link"></i></a><a href="#空指针异常" class="headerlink" title="空指针异常"></a>空指针异常</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">|ERROR|<span class="number">2023</span>-<span class="number">07</span>-<span class="number">30</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">35.653</span>|http-nio-<span class="number">8080</span>-exec-<span class="number">7</span>|7c7b1d92-b364-4de5-bfe8-7896ec4f2c07|uid=<span class="number">10003</span>|system exception！The reason is：<span class="literal">null</span>|</span><br><span class="line">java.lang.reflect.UndeclaredThrowableException: <span class="literal">null</span></span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:<span class="number">780</span>)</span><br><span class="line">	at org.springframework.aop.aspectj.MethodInvocationProceedingJoinPoint.proceed(MethodInvocationProceedingJoinPoint.java:<span class="number">89</span>)</span><br><span class="line">	at com.abin.mallchat.custom.common.intecepter.WebLogAspect.around(WebLogAspect.java:<span class="number">63</span>)</span><br><span class="line">	at sun.reflect.GeneratedMethodAccessor199.invoke(Unknown Source)</span><br><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:<span class="number">43</span>)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:<span class="number">498</span>)</span><br><span class="line">	at org.springframework.aop.aspectj.AbstractAspectJAdvice.invokeAdviceMethodWithGivenArgs(AbstractAspectJAdvice.java:<span class="number">634</span>)</span><br><span class="line">	at org.springframework.aop.aspectj.AbstractAspectJAdvice.invokeAdviceMethod(AbstractAspectJAdvice.java:<span class="number">624</span>)</span><br><span class="line">	at org.springframework.aop.aspectj.AspectJAroundAdvice.invoke(AspectJAroundAdvice.java:<span class="number">72</span>)</span><br><span class="line">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:<span class="number">186</span>)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:<span class="number">763</span>)</span><br><span class="line">	at org.springframework.aop.interceptor.ExposeInvocationInterceptor.invoke(ExposeInvocationInterceptor.java:<span class="number">97</span>)</span><br><span class="line">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:<span class="number">186</span>)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:<span class="number">763</span>)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:<span class="number">708</span>)</span><br><span class="line">	at com.abin.mallchat.custom.user.controller.OssController$$EnhancerBySpringCGLIB$$94c0c149.getUploadUrl(&lt;generated&gt;)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:<span class="number">62</span>)</span><br><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:<span class="number">43</span>)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:<span class="number">498</span>)</span><br><span class="line">	at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:<span class="number">205</span>)</span><br><span class="line">	at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:<span class="number">150</span>)</span><br><span class="line">	at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:<span class="number">117</span>)</span><br><span class="line">	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:<span class="number">895</span>)</span><br><span class="line">	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:<span class="number">808</span>)</span><br><span class="line">	at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:<span class="number">87</span>)</span><br><span class="line">	at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:<span class="number">1067</span>)</span><br><span class="line">	at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:<span class="number">963</span>)</span><br><span class="line">	at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:<span class="number">1006</span>)</span><br><span class="line">	at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:<span class="number">898</span>)</span><br><span class="line">	at javax.servlet.http.HttpServlet.service(HttpServlet.java:<span class="number">655</span>)</span><br><span class="line">	at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:<span class="number">883</span>)</span><br><span class="line">	at javax.servlet.http.HttpServlet.service(HttpServlet.java:<span class="number">764</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">227</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:<span class="number">53</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at com.abin.mallchat.custom.common.intecepter.HttpTraceIdFilter.doFilter(HttpTraceIdFilter.java:<span class="number">25</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:<span class="number">100</span>)</span><br><span class="line">	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">117</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:<span class="number">93</span>)</span><br><span class="line">	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">117</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at org.springframework.boot.actuate.metrics.web.servlet.WebMvcMetricsFilter.doFilterInternal(WebMvcMetricsFilter.java:<span class="number">96</span>)</span><br><span class="line">	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">117</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:<span class="number">201</span>)</span><br><span class="line">	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">117</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:<span class="number">197</span>)</span><br><span class="line">	at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:<span class="number">97</span>)</span><br><span class="line">	at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:<span class="number">541</span>)</span><br><span class="line">	at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:<span class="number">135</span>)</span><br><span class="line">	at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:<span class="number">92</span>)</span><br><span class="line">	at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:<span class="number">78</span>)</span><br><span class="line">	at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:<span class="number">360</span>)</span><br><span class="line">	at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:<span class="number">399</span>)</span><br><span class="line">	at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:<span class="number">65</span>)</span><br><span class="line">	at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:<span class="number">890</span>)</span><br><span class="line">	at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:<span class="number">1743</span>)</span><br><span class="line">	at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:<span class="number">49</span>)</span><br><span class="line">	at org.apache.tomcat.util.threads.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1191</span>)</span><br><span class="line">	at org.apache.tomcat.util.threads.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">659</span>)</span><br><span class="line">	at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:<span class="number">61</span>)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:<span class="number">748</span>)</span><br><span class="line">Caused by: io.minio.errors.ErrorResponseException: The specified bucket does not exist</span><br><span class="line">	at io.minio.S3Base$<span class="number">1.</span>onResponse(S3Base.java:<span class="number">690</span>)</span><br><span class="line">	at okhttp3.internal.connection.RealCall$AsyncCall.run(RealCall.kt:<span class="number">519</span>)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1149</span>)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">624</span>)</span><br><span class="line">	... <span class="number">1</span> common frames omitted</span><br></pre></td></tr></table></div></figure>


        <h3 id="原因-1"   >
          <a href="#原因-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#原因-1" class="headerlink" title="原因"></a>原因</h3>
      <p>这里是Minio的docker未启动，然后发送语音的时候是存储对象，所以启动minio端口就不会出现这个空指针报错了</p>

        <h2 id="未知异常"   >
          <a href="#未知异常" class="heading-link"><i class="fas fa-link"></i></a><a href="#未知异常" class="headerlink" title="未知异常"></a>未知异常</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">|ERROR|<span class="number">2023</span>-<span class="number">07</span>-<span class="number">31</span> <span class="number">10</span>:09:<span class="number">45.932</span>|http-nio-<span class="number">8080</span>-exec-<span class="number">10</span>|fa45bbb3-e84d-<span class="number">422f</span>-<span class="number">9053</span>-df13233dae8e|uid=<span class="number">10003</span>|system exception！The reason is：<span class="literal">null</span>|</span><br><span class="line">java.lang.reflect.UndeclaredThrowableException: <span class="literal">null</span></span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:<span class="number">780</span>)</span><br><span class="line">	at org.springframework.aop.aspectj.MethodInvocationProceedingJoinPoint.proceed(MethodInvocationProceedingJoinPoint.java:<span class="number">89</span>)</span><br><span class="line">	at com.abin.mallchat.custom.common.intecepter.WebLogAspect.around(WebLogAspect.java:<span class="number">63</span>)</span><br><span class="line">	at sun.reflect.GeneratedMethodAccessor226.invoke(Unknown Source)</span><br><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:<span class="number">43</span>)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:<span class="number">498</span>)</span><br><span class="line">	at org.springframework.aop.aspectj.AbstractAspectJAdvice.invokeAdviceMethodWithGivenArgs(AbstractAspectJAdvice.java:<span class="number">634</span>)</span><br><span class="line">	at org.springframework.aop.aspectj.AbstractAspectJAdvice.invokeAdviceMethod(AbstractAspectJAdvice.java:<span class="number">624</span>)</span><br><span class="line">	at org.springframework.aop.aspectj.AspectJAroundAdvice.invoke(AspectJAroundAdvice.java:<span class="number">72</span>)</span><br><span class="line">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:<span class="number">186</span>)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:<span class="number">763</span>)</span><br><span class="line">	at org.springframework.aop.interceptor.ExposeInvocationInterceptor.invoke(ExposeInvocationInterceptor.java:<span class="number">97</span>)</span><br><span class="line">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:<span class="number">186</span>)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:<span class="number">763</span>)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:<span class="number">708</span>)</span><br><span class="line">	at com.abin.mallchat.custom.user.controller.OssController$$EnhancerBySpringCGLIB$$94c0c149.getUploadUrl(&lt;generated&gt;)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:<span class="number">62</span>)</span><br><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:<span class="number">43</span>)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:<span class="number">498</span>)</span><br><span class="line">	at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:<span class="number">205</span>)</span><br><span class="line">	at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:<span class="number">150</span>)</span><br><span class="line">	at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:<span class="number">117</span>)</span><br><span class="line">	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:<span class="number">895</span>)</span><br><span class="line">	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:<span class="number">808</span>)</span><br><span class="line">	at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:<span class="number">87</span>)</span><br><span class="line">	at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:<span class="number">1067</span>)</span><br><span class="line">	at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:<span class="number">963</span>)</span><br><span class="line">	at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:<span class="number">1006</span>)</span><br><span class="line">	at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:<span class="number">898</span>)</span><br><span class="line">	at javax.servlet.http.HttpServlet.service(HttpServlet.java:<span class="number">655</span>)</span><br><span class="line">	at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:<span class="number">883</span>)</span><br><span class="line">	at javax.servlet.http.HttpServlet.service(HttpServlet.java:<span class="number">764</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">227</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:<span class="number">53</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at com.abin.mallchat.custom.common.intecepter.HttpTraceIdFilter.doFilter(HttpTraceIdFilter.java:<span class="number">25</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:<span class="number">100</span>)</span><br><span class="line">	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">117</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:<span class="number">93</span>)</span><br><span class="line">	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">117</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at org.springframework.boot.actuate.metrics.web.servlet.WebMvcMetricsFilter.doFilterInternal(WebMvcMetricsFilter.java:<span class="number">96</span>)</span><br><span class="line">	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">117</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:<span class="number">201</span>)</span><br><span class="line">	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">117</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:<span class="number">197</span>)</span><br><span class="line">	at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:<span class="number">97</span>)</span><br><span class="line">	at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:<span class="number">541</span>)</span><br><span class="line">	at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:<span class="number">135</span>)</span><br><span class="line">	at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:<span class="number">92</span>)</span><br><span class="line">	at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:<span class="number">78</span>)</span><br><span class="line">	at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:<span class="number">360</span>)</span><br><span class="line">	at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:<span class="number">399</span>)</span><br><span class="line">	at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:<span class="number">65</span>)</span><br><span class="line">	at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:<span class="number">890</span>)</span><br><span class="line">	at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:<span class="number">1743</span>)</span><br><span class="line">	at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:<span class="number">49</span>)</span><br><span class="line">	at org.apache.tomcat.util.threads.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1191</span>)</span><br><span class="line">	at org.apache.tomcat.util.threads.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">659</span>)</span><br><span class="line">	at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:<span class="number">61</span>)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:<span class="number">748</span>)</span><br><span class="line">Caused by: java.net.ConnectException: Failed to connect to /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">9000</span></span><br><span class="line">	at okhttp3.internal.connection.RealConnection.connectSocket(RealConnection.kt:<span class="number">297</span>)</span><br><span class="line">	at okhttp3.internal.connection.RealConnection.connect(RealConnection.kt:<span class="number">207</span>)</span><br><span class="line">	at okhttp3.internal.connection.ExchangeFinder.findConnection(ExchangeFinder.kt:<span class="number">226</span>)</span><br><span class="line">	at okhttp3.internal.connection.ExchangeFinder.findHealthyConnection(ExchangeFinder.kt:<span class="number">106</span>)</span><br><span class="line">	at okhttp3.internal.connection.ExchangeFinder.find(ExchangeFinder.kt:<span class="number">74</span>)</span><br><span class="line">	at okhttp3.internal.connection.RealCall.initExchange$okhttp(RealCall.kt:<span class="number">255</span>)</span><br><span class="line">	at okhttp3.internal.connection.ConnectInterceptor.intercept(ConnectInterceptor.kt:<span class="number">32</span>)</span><br><span class="line">	at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.kt:<span class="number">109</span>)</span><br><span class="line">	at okhttp3.internal.cache.CacheInterceptor.intercept(CacheInterceptor.kt:<span class="number">95</span>)</span><br><span class="line">	at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.kt:<span class="number">109</span>)</span><br><span class="line">	at okhttp3.internal.http.BridgeInterceptor.intercept(BridgeInterceptor.kt:<span class="number">83</span>)</span><br><span class="line">	at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.kt:<span class="number">109</span>)</span><br><span class="line">	at okhttp3.internal.http.RetryAndFollowUpInterceptor.intercept(RetryAndFollowUpInterceptor.kt:<span class="number">76</span>)</span><br><span class="line">	at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.kt:<span class="number">109</span>)</span><br><span class="line">	at okhttp3.internal.connection.RealCall.getResponseWithInterceptorChain$okhttp(RealCall.kt:<span class="number">201</span>)</span><br><span class="line">	at okhttp3.internal.connection.RealCall$AsyncCall.run(RealCall.kt:<span class="number">517</span>)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1149</span>)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">624</span>)</span><br><span class="line">	... <span class="number">1</span> common frames omitted</span><br><span class="line">Caused by: java.net.ConnectException: Connection refused: connect</span><br><span class="line">	at java.net.DualStackPlainSocketImpl.waitForConnect(Native Method)</span><br><span class="line">	at java.net.DualStackPlainSocketImpl.socketConnect(DualStackPlainSocketImpl.java:<span class="number">81</span>)</span><br><span class="line">	at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:<span class="number">476</span>)</span><br><span class="line">	at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:<span class="number">218</span>)</span><br><span class="line">	at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:<span class="number">200</span>)</span><br><span class="line">	at java.net.PlainSocketImpl.connect(PlainSocketImpl.java:<span class="number">162</span>)</span><br><span class="line">	at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:<span class="number">394</span>)</span><br><span class="line">	at java.net.Socket.connect(Socket.java:<span class="number">606</span>)</span><br><span class="line">	at okhttp3.internal.platform.Platform.connectSocket(Platform.kt:<span class="number">120</span>)</span><br><span class="line">	at okhttp3.internal.connection.RealConnection.connectSocket(RealConnection.kt:<span class="number">295</span>)</span><br><span class="line">	... <span class="number">18</span> common frames omitted</span><br></pre></td></tr></table></div></figure>


        <h3 id="原因-2"   >
          <a href="#原因-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#原因-2" class="headerlink" title="原因"></a>原因</h3>
      <p>问题出现在127.0.0.1:9000端口，那么这个是Minio的异常，原因是无法连接到Minio</p>

        <h1 id="总结-1"   >
          <a href="#总结-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结-1" class="headerlink" title="总结"></a>总结</h1>
      <p>整篇项目到目前为止的阶段还有ChatAI部分没能阅读，其余已经学习完毕</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/07/27/SpringCloud%E9%9D%A2%E8%AF%95%E9%A2%98/">SpringCloud面试题</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-07-27</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">57</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">1分</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="SpringCloud常见组件有哪些"   >
          <a href="#SpringCloud常见组件有哪些" class="heading-link"><i class="fas fa-link"></i></a><a href="#SpringCloud常见组件有哪些" class="headerlink" title="SpringCloud常见组件有哪些?"></a>SpringCloud常见组件有哪些?</h1>
      
        <h1 id="Nacos的服务注册表结构是怎么样的？"   >
          <a href="#Nacos的服务注册表结构是怎么样的？" class="heading-link"><i class="fas fa-link"></i></a><a href="#Nacos的服务注册表结构是怎么样的？" class="headerlink" title="Nacos的服务注册表结构是怎么样的？"></a>Nacos的服务注册表结构是怎么样的？</h1>
      
        <h1 id="Nacos如何支撑数十万服务注册压力？"   >
          <a href="#Nacos如何支撑数十万服务注册压力？" class="heading-link"><i class="fas fa-link"></i></a><a href="#Nacos如何支撑数十万服务注册压力？" class="headerlink" title="Nacos如何支撑数十万服务注册压力？"></a>Nacos如何支撑数十万服务注册压力？</h1>
      
        <h1 id="Nacos如何避免读写并发冲突问题？"   >
          <a href="#Nacos如何避免读写并发冲突问题？" class="heading-link"><i class="fas fa-link"></i></a><a href="#Nacos如何避免读写并发冲突问题？" class="headerlink" title="Nacos如何避免读写并发冲突问题？"></a>Nacos如何避免读写并发冲突问题？</h1>
      
        <h1 id="Nacos和Eureka的区别有哪些？"   >
          <a href="#Nacos和Eureka的区别有哪些？" class="heading-link"><i class="fas fa-link"></i></a><a href="#Nacos和Eureka的区别有哪些？" class="headerlink" title="Nacos和Eureka的区别有哪些？"></a>Nacos和Eureka的区别有哪些？</h1>
      </div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/07/27/Sentinel-SpringCloud%E7%AF%87/">Sentinel-[SpringCloud篇]</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-07-27</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">0</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">1分</span></span></div></header><div class="post-body"><div class="post-excerpt"></div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/07/27/Nacos-SpringCloud%E7%AF%87/">Nacos-[SpringCloud篇]</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-07-27</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">752</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">6分</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="准备工作"   >
          <a href="#准备工作" class="heading-link"><i class="fas fa-link"></i></a><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1>
      <p>想要解析Nacos首先得把Nacos源码下载下来，这自然是第一，再是尝试在本地启动Nacos源码</p>

        <h2 id="Proto编译"   >
          <a href="#Proto编译" class="heading-link"><i class="fas fa-link"></i></a><a href="#Proto编译" class="headerlink" title="Proto编译"></a>Proto编译</h2>
      <p>因为nacos会按照Protobuf对数据做序列化和反序列化处理，这也是nacos能在多个平台运行的原因，正因为数据按照protobuf序列化了才会不同的语言才能运行</p>
<p>我们要将proto文件编译成java文件</p>

        <h3 id="protobuf"   >
          <a href="#protobuf" class="heading-link"><i class="fas fa-link"></i></a><a href="#protobuf" class="headerlink" title="protobuf"></a>protobuf</h3>
      <p>protobuf是Google公司提出的一种轻便高效的结构化数据存储格式，常用于结构化数据的序列化，具有语言无关、平台无关、可扩展性特性，常用于通讯协议、服务端数据交换场景</p>
<p>类似Json也是一种结构化存储格式</p>

        <h3 id="安装protoc"   >
          <a href="#安装protoc" class="heading-link"><i class="fas fa-link"></i></a><a href="#安装protoc" class="headerlink" title="安装protoc"></a>安装protoc</h3>
      <p><strong>接下来我们要参考nacos的官网手册来对Nacos的服务注册、服务发现、心跳检测进行分析</strong></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://nacos.io/zh-cn/docs/open-api.html" >Nacos Open API</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h1 id="Nacos服务注册"   >
          <a href="#Nacos服务注册" class="heading-link"><i class="fas fa-link"></i></a><a href="#Nacos服务注册" class="headerlink" title="Nacos服务注册"></a>Nacos服务注册</h1>
      
        <h2 id="客户端"   >
          <a href="#客户端" class="heading-link"><i class="fas fa-link"></i></a><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h2>
      
        <h2 id="服务端"   >
          <a href="#服务端" class="heading-link"><i class="fas fa-link"></i></a><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h2>
      <p>对照Nacos Open API找到服务端服务注册</p>
<div class="table-container"><table>
<thead>
<tr>
<th>服务注册</th>
<th>请求路径</th>
</tr>
</thead>
<tbody><tr>
<td>POST请求</td>
<td>&#x2F;nacos&#x2F;v1&#x2F;ns&#x2F;instance</td>
</tr>
</tbody></table></div>
<p>通过UtilsAndCommons类找到</p>
<div class="table-container"><table>
<thead>
<tr>
<th>路径</th>
<th>常量</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;nacos</td>
<td>NACOS_SERVER_CONTEXT</td>
</tr>
<tr>
<td>&#x2F;v1</td>
<td>NACOS_SERVER_VERSION</td>
</tr>
<tr>
<td>&#x2F;v1&#x2F;ns</td>
<td>DEFAULT_NACOS_NAMING_CONTEXT &#x3D; NACOS_SERVER_VERSION+ “&#x2F;ns”</td>
</tr>
</tbody></table></div>
<p>所以&#x2F;nacos&#x2F;v1&#x2F;ns就是NACOS_SERVER_CONTEXT +   DEFAULT_NACOS_NAMING_CONTEXT </p>
<p>我们的目标就是找到这个路径对应的Controller</p>

        <h3 id="InstanceController"   >
          <a href="#InstanceController" class="heading-link"><i class="fas fa-link"></i></a><a href="#InstanceController" class="headerlink" title="InstanceController"></a>InstanceController</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(UtilsAndCommons.NACOS_NAMING_CONTEXT + UtilsAndCommons.NACOS_NAMING_INSTANCE_CONTEXT)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InstanceController</span> &#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>从InstanceController找到Post请求对应的方法</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CanDistro</span></span><br><span class="line">   <span class="meta">@PostMapping</span></span><br><span class="line">   <span class="meta">@Secured(action = ActionTypes.WRITE)</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">register</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">       </span><br><span class="line">       <span class="comment">//获取命名空间 namespaceId</span></span><br><span class="line">       <span class="keyword">final</span> <span class="type">String</span> <span class="variable">namespaceId</span> <span class="operator">=</span> WebUtils</span><br><span class="line">               .optional(request, CommonParams.NAMESPACE_ID, Constants.DEFAULT_NAMESPACE_ID);</span><br><span class="line">      	</span><br><span class="line">       <span class="comment">//获取服务名称 servicename</span></span><br><span class="line">       <span class="keyword">final</span> <span class="type">String</span> <span class="variable">serviceName</span> <span class="operator">=</span> WebUtils.required(request, CommonParams.SERVICE_NAME);</span><br><span class="line">       <span class="comment">//对seviceName做一个格式化检查</span></span><br><span class="line">       NamingUtils.checkServiceNameFormat(serviceName);</span><br><span class="line">       </span><br><span class="line">       <span class="comment">//创建一个实例对象，链式编程 创建一个实例(通过SwitchDomain.isDefaultInstanceEphemeral()判断是否是临时实例)</span></span><br><span class="line">       <span class="keyword">final</span> <span class="type">Instance</span> <span class="variable">instance</span> <span class="operator">=</span> HttpRequestInstanceBuilder.newBuilder()</span><br><span class="line">               .setDefaultInstanceEphemeral(switchDomain.isDefaultInstanceEphemeral()).setRequest(request).build();</span><br><span class="line">       <span class="comment">//上面创建一个临时实例或者是一个永久实例</span></span><br><span class="line">       </span><br><span class="line">       <span class="comment">//调用getInstanceOperator.reregisterInstance方法注册实例  传入命名空间、服务名称、实例对象</span></span><br><span class="line">       getInstanceOperator().registerInstance(namespaceId, serviceName, instance);</span><br><span class="line">       </span><br><span class="line">       <span class="comment">//发布一个事务 当前已经注册了实例</span></span><br><span class="line">       <span class="comment">//传入参数</span></span><br><span class="line">       NotifyCenter.publishEvent(<span class="keyword">new</span> <span class="title class_">RegisterInstanceTraceEvent</span>(System.currentTimeMillis(), <span class="string">&quot;&quot;</span>, <span class="literal">false</span>, namespaceId , NamingUtils.getGroupName(serviceName) , NamingUtils.getServiceName(serviceName), instance.getIp(),instance.getPort()));</span><br><span class="line">       <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="registerInstance"   >
          <a href="#registerInstance" class="heading-link"><i class="fas fa-link"></i></a><a href="#registerInstance" class="headerlink" title="registerInstance"></a>registerInstance</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerInstance</span><span class="params">(String namespaceId, String serviceName, Instance instance)</span> <span class="keyword">throws</span> NacosException &#123;</span><br><span class="line">    NamingUtils.checkInstanceIsLegal(instance);</span><br><span class="line">    </span><br><span class="line">    <span class="type">boolean</span> <span class="variable">ephemeral</span> <span class="operator">=</span> instance.isEphemeral();</span><br><span class="line">    <span class="type">String</span> <span class="variable">clientId</span> <span class="operator">=</span> IpPortBasedClient.getClientId(instance.toInetAddr(), ephemeral);</span><br><span class="line">    createIpPortClientIfAbsent(clientId);</span><br><span class="line">    <span class="type">Service</span> <span class="variable">service</span> <span class="operator">=</span> getService(namespaceId, serviceName, ephemeral);</span><br><span class="line">    clientOperationService.registerInstance(service, instance, clientId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h2 id="RegisterInstanceTraceEvent"   >
          <a href="#RegisterInstanceTraceEvent" class="heading-link"><i class="fas fa-link"></i></a><a href="#RegisterInstanceTraceEvent" class="headerlink" title="RegisterInstanceTraceEvent"></a>RegisterInstanceTraceEvent</h2>
      <div class="table-container"><table>
<thead>
<tr>
<th>形参</th>
<th>传入参数</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>eventTime</td>
<td>System.currentTimeMillis()</td>
<td>当前时间戳</td>
</tr>
<tr>
<td>clientIp</td>
<td>“”</td>
<td>注册实例的请求IP，传入空字符串</td>
</tr>
<tr>
<td>rpc</td>
<td>false</td>
<td>来源是否为gRPC，传入false</td>
</tr>
<tr>
<td>serviceNamespace</td>
<td>namespaceId</td>
<td>命名空间</td>
</tr>
<tr>
<td>serviceGroup</td>
<td>NamingUtils.getGroupName(serviceName)</td>
<td>服务分组</td>
</tr>
<tr>
<td>serviceName</td>
<td>NamingUtils.getServiceName(serviceName)</td>
<td>服务名称</td>
</tr>
<tr>
<td>instanceIp</td>
<td>instance.getIp()</td>
<td>注册实例的地址IP&#x2F;HOST</td>
</tr>
<tr>
<td>instancePort</td>
<td>instance.getPort()</td>
<td>注册实例的端口Port</td>
</tr>
</tbody></table></div>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">RegisterInstanceTraceEvent</span><span class="params">(<span class="type">long</span> eventTime, String clientIp, <span class="type">boolean</span> rpc, String serviceNamespace,</span></span><br><span class="line"><span class="params">        String serviceGroup, String serviceName, String instanceIp, <span class="type">int</span> instancePort)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(<span class="string">&quot;REGISTER_INSTANCE_TRACE_EVENT&quot;</span>, eventTime, serviceNamespace, serviceGroup, serviceName);</span><br><span class="line">    <span class="built_in">this</span>.clientIp = clientIp;</span><br><span class="line">    <span class="built_in">this</span>.rpc = rpc;</span><br><span class="line">    <span class="built_in">this</span>.instanceIp = instanceIp;</span><br><span class="line">    <span class="built_in">this</span>.instancePort = instancePort;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>






        <h3 id="publishEvent"   >
          <a href="#publishEvent" class="heading-link"><i class="fas fa-link"></i></a><a href="#publishEvent" class="headerlink" title="publishEvent"></a>publishEvent</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">publishEvent</span><span class="params">(<span class="keyword">final</span> Event event)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> publishEvent(event.getClass(), event);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        LOGGER.error(<span class="string">&quot;There was an exception to the message publishing : &quot;</span>, ex);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/07/21/JavaSE%E5%9F%BA%E7%A1%80%E3%80%90%E6%80%BB%E7%BB%93%E7%AF%87%E3%80%91/">JavaSE基础【总结篇】</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-07-21</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">658</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">3分</span></span></div></header><div class="post-body"><div class="post-excerpt"><p><strong>前言</strong></p>
<p>这个文档记录的是JavaSE的基础，本着我学习的路线再进一步深化和理解，这个过程是一个必不可少的过程。</p>
<p><em>光学别人的是别人教的好而不是我学的好，想要真正掌握必须自己重新查一遍、看一遍</em></p>
<p>复盘和深化学习路线参考于Java从入门到精通(第六版)目录，这一块要重新学习的主要是最最最基础的内容</p>
<hr>

        <h1 id="Java语言基础"   >
          <a href="#Java语言基础" class="heading-link"><i class="fas fa-link"></i></a><a href="#Java语言基础" class="headerlink" title="Java语言基础"></a>Java语言基础</h1>
      
        <h2 id="基本数据类型"   >
          <a href="#基本数据类型" class="heading-link"><i class="fas fa-link"></i></a><a href="#基本数据类型" class="headerlink" title="基本数据类型"></a>基本数据类型</h2>
      <p>一共八个基本数据类型</p>
<p>整型：byte,short,int,long</p>
<p>浮点型:float,double</p>
<p>布尔型:boolean</p>
<p>字符型:char</p>
<div class="table-container"><table>
<thead>
<tr>
<th></th>
<th>字节数</th>
<th>二进制位</th>
<th>范围</th>
</tr>
</thead>
<tbody><tr>
<td>byte</td>
<td>1字节</td>
<td>8</td>
<td>[-2^7,2^7-1]</td>
</tr>
<tr>
<td>short</td>
<td>2字节</td>
<td>16</td>
<td>[-2^15,2^15-1]</td>
</tr>
<tr>
<td>int</td>
<td>4字节</td>
<td>32</td>
<td>[-2^31,2^31-1]</td>
</tr>
<tr>
<td>long</td>
<td>8字节</td>
<td>64</td>
<td>[-2^63,2^63-1]</td>
</tr>
<tr>
<td>float(单精度)</td>
<td>4字节</td>
<td>32</td>
<td></td>
</tr>
<tr>
<td>double(双精度)</td>
<td>8字节</td>
<td>64</td>
<td></td>
</tr>
<tr>
<td>boolean</td>
<td>1字节</td>
<td>8</td>
<td></td>
</tr>
<tr>
<td>char</td>
<td>2字节</td>
<td>16</td>
<td>[0,2^16-1]</td>
</tr>
</tbody></table></div>

        <h2 id="变量和常量"   >
          <a href="#变量和常量" class="heading-link"><i class="fas fa-link"></i></a><a href="#变量和常量" class="headerlink" title="变量和常量"></a>变量和常量</h2>
      <p>变量:在程序运行过程中，可以发生变化的量</p>
<p>常量:在程序运行过程中，不会发生变化的量</p>
<p>常量一般用final关键字进行修饰，只能赋值一次</p>
<p>变量有成员变量、局部变量、静态变量、参数变量</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">成员变量：定义在类中、方法外的变量，可以被类中的方法调用，可以被权限修饰符修饰</span><br><span class="line">局部变量：定义在方法体、代码块中的变量，作用域仅限当前方法、代码块中，局部变量在使用前必须先声明，并且不能被权限修饰符修饰</span><br><span class="line">静态变量：定义在类中、方法外的变量，并且用<span class="keyword">static</span>关键字修饰，可以被权限修饰符修饰</span><br><span class="line">参数变量: 方法声明时的变量，作用域仅限于方法体中</span><br></pre></td></tr></table></div></figure>




        <h2 id="运算符"   >
          <a href="#运算符" class="heading-link"><i class="fas fa-link"></i></a><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h2>
      <p>&amp;符号和&amp;&amp;之间有什么区别？</p>
<p>&amp;是普通与，无论第一个条件如何都会进行第二个条件判断，&amp;&amp;是短路与，如果第一个条件为false就不会进入第二个条件判断</p>
<p>|符号和||之间有什么区别？</p>
<p>同理，|是普通或，无论第一个条件如何都会进行第二个条件判断，||是短路或，如果第一个条件为true就不会进入第二个条件判断</p>

        <h2 id="数据类型转换"   >
          <a href="#数据类型转换" class="heading-link"><i class="fas fa-link"></i></a><a href="#数据类型转换" class="headerlink" title="数据类型转换"></a>数据类型转换</h2>
      
        <h2 id="关键字"   >
          <a href="#关键字" class="heading-link"><i class="fas fa-link"></i></a><a href="#关键字" class="headerlink" title="关键字"></a>关键字</h2>
      
        <h2 id="权限修饰符"   >
          <a href="#权限修饰符" class="heading-link"><i class="fas fa-link"></i></a><a href="#权限修饰符" class="headerlink" title="权限修饰符"></a>权限修饰符</h2>
      <hr>

        <h1 id="数组"   >
          <a href="#数组" class="heading-link"><i class="fas fa-link"></i></a><a href="#数组" class="headerlink" title="数组"></a>数组</h1>
      
        <h2 id="一维数组"   >
          <a href="#一维数组" class="heading-link"><i class="fas fa-link"></i></a><a href="#一维数组" class="headerlink" title="一维数组"></a>一维数组</h2>
      
        <h2 id="二维数组"   >
          <a href="#二维数组" class="heading-link"><i class="fas fa-link"></i></a><a href="#二维数组" class="headerlink" title="二维数组"></a>二维数组</h2>
      
        <h2 id="数组的基本操作"   >
          <a href="#数组的基本操作" class="heading-link"><i class="fas fa-link"></i></a><a href="#数组的基本操作" class="headerlink" title="数组的基本操作"></a>数组的基本操作</h2>
      <hr>

        <h1 id="类和对象"   >
          <a href="#类和对象" class="heading-link"><i class="fas fa-link"></i></a><a href="#类和对象" class="headerlink" title="类和对象"></a>类和对象</h1>
      
        <h2 id="对象"   >
          <a href="#对象" class="heading-link"><i class="fas fa-link"></i></a><a href="#对象" class="headerlink" title="对象"></a>对象</h2>
      
        <h2 id="类"   >
          <a href="#类" class="heading-link"><i class="fas fa-link"></i></a><a href="#类" class="headerlink" title="类"></a>类</h2>
      
        <h3 id="面向对象的操作"   >
          <a href="#面向对象的操作" class="heading-link"><i class="fas fa-link"></i></a><a href="#面向对象的操作" class="headerlink" title="面向对象的操作"></a>面向对象的操作</h3>
      <hr>

        <h1 id="字符串"   >
          <a href="#字符串" class="heading-link"><i class="fas fa-link"></i></a><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h1>
      <hr>

        <h1 id="异常"   >
          <a href="#异常" class="heading-link"><i class="fas fa-link"></i></a><a href="#异常" class="headerlink" title="异常"></a>异常</h1>
      <hr>

        <h1 id="枚举"   >
          <a href="#枚举" class="heading-link"><i class="fas fa-link"></i></a><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h1>
      <hr>

        <h1 id="反射与注解"   >
          <a href="#反射与注解" class="heading-link"><i class="fas fa-link"></i></a><a href="#反射与注解" class="headerlink" title="反射与注解"></a>反射与注解</h1>
      <hr>

        <h1 id="总结"   >
          <a href="#总结" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结" class="headerlink" title="总结"></a>总结</h1>
      </div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/07/20/JavaSE%E5%9F%BA%E7%A1%80-%E9%94%81%E3%80%90%E6%BA%90%E7%A0%81%E7%AF%87%E3%80%91/">JavaSE基础-锁【源码篇】</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-07-20</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">4k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">31分</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="Lock"   >
          <a href="#Lock" class="heading-link"><i class="fas fa-link"></i></a><a href="#Lock" class="headerlink" title="Lock"></a>Lock</h1>
      <p>我们首先要看JUC标准中的Lock接口</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span>;</span><br><span class="line"><span class="comment">//获取锁</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">lockInterruptibly</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	除非当前线程被中断，否则获取锁</span></span><br><span class="line"><span class="comment">	1.如果锁可用则直接获取锁</span></span><br><span class="line"><span class="comment">	2.如果锁不可用，则当前线程会被禁用并处于休眠状态直到两钟情况产生</span></span><br><span class="line"><span class="comment">		1).锁被当前线程获取</span></span><br><span class="line"><span class="comment">		2).其他线程会中断当前线程，并且支持中断锁</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">()</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	只有锁是空闲的时候才能获取锁</span></span><br><span class="line"><span class="comment">	1.如果锁可用则获取锁，返回true</span></span><br><span class="line"><span class="comment">	2.如果锁不可用则返回false</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> time, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	当锁在规定时间内是空闲并且没有线程中断，那么获取锁</span></span><br><span class="line"><span class="comment">	形参:  </span></span><br><span class="line"><span class="comment">		1.规定锁的超时时间</span></span><br><span class="line"><span class="comment">		2.规定时间单位</span></span><br><span class="line"><span class="comment">	返回值：</span></span><br><span class="line"><span class="comment">		1.true 获取锁成功</span></span><br><span class="line"><span class="comment">		2.false 超时，获取锁失败</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span>;</span><br><span class="line"><span class="comment">//释放锁</span></span><br><span class="line"></span><br><span class="line">Condition <span class="title function_">newCondition</span><span class="params">()</span>;</span><br><span class="line"><span class="comment">//创建一个新的Condition实例</span></span><br></pre></td></tr></table></div></figure>

<p>我们接下来要看Lock的实现类</p>

        <h2 id="1-ReentrantLock"   >
          <a href="#1-ReentrantLock" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ReentrantLock" class="headerlink" title="1.ReentrantLock"></a>1.ReentrantLock</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReentrantLock</span> <span class="keyword">implements</span> <span class="title class_">Lock</span>, java.io.Serializable &#123;</span><br><span class="line">    <span class="comment">/*一个可重入互斥锁</span></span><br><span class="line"><span class="comment">      当构造函数接收一个公平性参数，当设置为ture时，则下次获得锁的是等得最久的线程</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>变量</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">7373984872572414699L</span>;</span><br><span class="line"><span class="comment">//串行化ID</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*提供所有实施机制的同步器 */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Sync sync;</span><br></pre></td></tr></table></div></figure>

<p>内部类</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Sync</span> <span class="keyword">extends</span> <span class="title class_">AbstractQueuedSynchronizer</span> &#123;</span><br><span class="line">     </span><br><span class="line"> 	<span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span>;</span><br><span class="line">    ...</span><br><span class="line">        </span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">FairSync</span> <span class="keyword">extends</span> <span class="title class_">Sync</span> &#123;</span><br><span class="line">     <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">            acquire(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">NonfairSync</span> <span class="keyword">extends</span> <span class="title class_">Sync</span> &#123;</span><br><span class="line">     <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">                setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                acquire(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></div></figure>




        <h3 id="构造方法"   >
          <a href="#构造方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#构造方法" class="headerlink" title="构造方法"></a>构造方法</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>无参构造</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ReentrantLock</span><span class="params">()</span> &#123;</span><br><span class="line">        sync = <span class="keyword">new</span> <span class="title class_">NonfairSync</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//创建一个Reentrantlock实例，相当于ReentrantLock(false),创建了一个非公平可重入锁</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*	---有关的详细代码---</span></span><br><span class="line"><span class="comment">	</span></span><br><span class="line"><span class="comment">	static final class NonfairSync extends Sync &#123;</span></span><br><span class="line"><span class="comment">        private static final long serialVersionUID = 7316153563782823691L;</span></span><br><span class="line"><span class="comment">        </span></span><br><span class="line"><span class="comment">        final void lock() &#123;</span></span><br><span class="line"><span class="comment">            if (compareAndSetState(0, 1))</span></span><br><span class="line"><span class="comment">                setExclusiveOwnerThread(Thread.currentThread());</span></span><br><span class="line"><span class="comment">            else</span></span><br><span class="line"><span class="comment">                acquire(1);</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        protected final boolean tryAcquire(int acquires) &#123;</span></span><br><span class="line"><span class="comment">            return nonfairTryAcquire(acquires);</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    //因为NonfairSync类只有继承父类下的空参构造，所以会调用new Sync();</span></span><br><span class="line"><span class="comment">    abstract static class Sync extends AbstractQueuedSynchronizer &#123;</span></span><br><span class="line"><span class="comment">        abstract void lock();</span></span><br><span class="line"><span class="comment">        final boolean nonfairTryAcquire(int acquires) &#123;...&#125;</span></span><br><span class="line"><span class="comment">        protected final boolean tryRelease(int releases) &#123;...&#125;</span></span><br><span class="line"><span class="comment">       	...</span></span><br><span class="line"><span class="comment">     &#125;</span></span><br><span class="line"><span class="comment">    //同理因为Sync类也没有空参构造，会调用父类的空参构造 即new AbstractQueuedSynchronizer();</span></span><br><span class="line"><span class="comment">    public abstract class AbstractQueuedSynchronizer extends AbstractOwnableSynchronizer</span></span><br><span class="line"><span class="comment">    implements java.io.Serializable &#123;</span></span><br><span class="line"><span class="comment">    protected AbstractQueuedSynchronizer() &#123; &#125;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    //同上，且因为abstract类是个抽象类</span></span><br><span class="line"><span class="comment">    //所以父类也是空参构造，那么这个方法最后调用的结果就是new AbstractOwnableSynchronizer()</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    //那么先暂时按官方说明的理解，调用了一个ReentrantLock(false),创建了一个非公平可重入锁</span></span><br><span class="line"><span class="comment">*/</span>    </span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>有参构造</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ReentrantLock</span><span class="params">(<span class="type">boolean</span> fair)</span> &#123;</span><br><span class="line">        sync = fair ? <span class="keyword">new</span> <span class="title class_">FairSync</span>() : <span class="keyword">new</span> <span class="title class_">NonfairSync</span>();</span><br><span class="line">    <span class="comment">//通过指定公平策略，创建一个实例ReentrantLock</span></span><br><span class="line">    <span class="comment">//当fair为true则创建FairSync反之创建NonfairSync();</span></span><br><span class="line">    <span class="comment">//默认情况下空参构造是创建一个非公平的可重入互斥锁</span></span><br><span class="line">    &#125;</span><br><span class="line">	</span><br></pre></td></tr></table></div></figure>




        <h3 id="常用方法"   >
          <a href="#常用方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#常用方法" class="headerlink" title="常用方法"></a>常用方法</h3>
      
        <h4 id="lock方法"   >
          <a href="#lock方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#lock方法" class="headerlink" title="lock方法"></a>lock方法</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">        sync.lock();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//sync.lock()</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span>;</span><br><span class="line"><span class="comment">//所以要去找sync的子类看具体的方法实现</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//默认情况下:创建一个NonfairSync</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//nonfairsync.lock()</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">                setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                acquire(<span class="number">1</span>);</span><br><span class="line">    <span class="comment">//锁状态从0更新到1则说明线程获取了互斥锁</span></span><br><span class="line">&#125;   </span><br><span class="line">    <span class="comment">/*-----详情代码----</span></span><br><span class="line"><span class="comment">    我们可以先通过判断成功与否来反推这个IF语句到底在干吗</span></span><br><span class="line"><span class="comment">    条件成立:</span></span><br><span class="line"><span class="comment">    protected final void setExclusiveOwnerThread(Thread thread) &#123;</span></span><br><span class="line"><span class="comment">        exclusiveOwnerThread = thread;</span></span><br><span class="line"><span class="comment">        //这个方法执行成功后，会获得互斥锁</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    private transient Thread exclusiveOwnerThread;</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    条件不成立:</span></span><br><span class="line"><span class="comment">    public final void acquire(int arg) &#123;</span></span><br><span class="line"><span class="comment">        if (!tryAcquire(arg) &amp;&amp;acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span></span><br><span class="line"><span class="comment">        	//	当尝试获取锁失败并且添加到等待队列中，则会线程自己中断自己</span></span><br><span class="line"><span class="comment">            selfInterrupt();</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    //尝试获取锁</span></span><br><span class="line"><span class="comment">    protected boolean tryAcquire(int arg) &#123;</span></span><br><span class="line"><span class="comment">        throw new UnsupportedOperationException();</span></span><br><span class="line"><span class="comment">        //尝试获取锁，如果获取将使同步器处于非法操作则抛出异常</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    //给当前创建结点并且给一个标识表示当前线程正在抢夺互斥锁</span></span><br><span class="line"><span class="comment">    private Node addWaiter(Node mode) &#123;</span></span><br><span class="line"><span class="comment">        Node node = new Node(Thread.currentThread(), mode);</span></span><br><span class="line"><span class="comment">        //创建当前线程的结点</span></span><br><span class="line"><span class="comment">        </span></span><br><span class="line"><span class="comment">        // Try the fast path of enq; backup to full enq on failure</span></span><br><span class="line"><span class="comment">        Node pred = tail;</span></span><br><span class="line"><span class="comment">        if (pred != null) &#123;</span></span><br><span class="line"><span class="comment">            node.prev = pred;</span></span><br><span class="line"><span class="comment">            if (compareAndSetTail(pred, node)) &#123;</span></span><br><span class="line"><span class="comment">        		//利用cas机制将当前线程结点添加到队尾，然后返回Node结束方法</span></span><br><span class="line"><span class="comment">                pred.next = node;</span></span><br><span class="line"><span class="comment">                return node;</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        </span></span><br><span class="line"><span class="comment">        //运行到这里说明加入等待队尾失败        </span></span><br><span class="line"><span class="comment">        enq(node);</span></span><br><span class="line"><span class="comment">        //调用enq(node)</span></span><br><span class="line"><span class="comment">        return node;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    //enq为等待队列，这里会不断死循环直到数据插入到等待队列队尾</span></span><br><span class="line"><span class="comment">    private Node enq(final Node node) &#123;</span></span><br><span class="line"><span class="comment">        for (;;) &#123;</span></span><br><span class="line"><span class="comment">            Node t = tail;</span></span><br><span class="line"><span class="comment">            if (t == null) &#123; // Must initialize</span></span><br><span class="line"><span class="comment">            	//如果队尾为空，说明该队列还没有创建，初始化</span></span><br><span class="line"><span class="comment">                if (compareAndSetHead(new Node()))</span></span><br><span class="line"><span class="comment">                	//创建新结点插入队首，此时队伍只有队首一个元素,将尾结点指向第一个头结点</span></span><br><span class="line"><span class="comment">                    tail = head;</span></span><br><span class="line"><span class="comment">            &#125; else &#123;</span></span><br><span class="line"><span class="comment">            	//队伍中有数据，那么将结点插入队伍</span></span><br><span class="line"><span class="comment">                node.prev = t;</span></span><br><span class="line"><span class="comment">                if (compareAndSetTail(t, node)) &#123;</span></span><br><span class="line"><span class="comment">                    t.next = node;</span></span><br><span class="line"><span class="comment">                    return t;</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">    因此我们大概可以知道如果状态从0置为1则说明获得了锁，失败了就会加入重试队伍中重试获取锁</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    判断条件:这里调用的是AbstractQueuedSynchronizer父类的方法</span></span><br><span class="line"><span class="comment">    	</span></span><br><span class="line"><span class="comment">    protected final boolean compareAndSetState(int expect, int update) &#123;</span></span><br><span class="line"><span class="comment">        return unsafe.compareAndSwapInt(this, stateOffset, expect, update);</span></span><br><span class="line"><span class="comment">        //参数1:调用的位置 参数2:偏移量 参数3:期待数  参数4:更新后的值</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    public final native boolean compareAndSwapInt(Object var1, long var2, int var4, int var5);</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    stateOffset = unsafe.objectFieldOffset (AbstractQueuedSynchronizer.class.getDeclaredField(&quot;state&quot;));0</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    public native long objectFieldOffset(Field var1);</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//创建了一个公平同步器</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//FairSync.lock</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">            acquire(<span class="number">1</span>);</span><br><span class="line">    <span class="comment">//尝试获得互斥锁</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//尝试获取互斥锁，如果成立返回true,反之线程加入等待队伍</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp;</span><br><span class="line">            acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">            selfInterrupt();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h4 id="tryLock方法"   >
          <a href="#tryLock方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#tryLock方法" class="headerlink" title="tryLock方法"></a>tryLock方法</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//尝试获取锁，以非公平的方式</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sync.nonfairTryAcquire(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment">//尝试以非公平的方式获取锁</span></span><br><span class="line"><span class="comment">//如果锁是第一次获取则状态置为1</span></span><br><span class="line"><span class="comment">//如果锁已经被当前线程获取过，那么状态会是原来的状态+1</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">nonfairTryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">            <span class="comment">//获得当前线程</span></span><br><span class="line">            </span><br><span class="line">            <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">            <span class="comment">//获得当前状态</span></span><br><span class="line">            <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">                	<span class="comment">//如果用cas机制成功将0更新成参数</span></span><br><span class="line">                    setExclusiveOwnerThread(current);</span><br><span class="line">                    <span class="comment">//将该线程设置为互斥锁的获得者</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                    <span class="comment">//返回true表示获得锁成功 锁的状态为1</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">            	<span class="comment">//如果当前线程已经是锁的获得者了</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">nextc</span> <span class="operator">=</span> c + acquires;</span><br><span class="line">                <span class="comment">//将c加入参数值然后交给下一个nextc变量</span></span><br><span class="line">                <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">                setState(nextc);</span><br><span class="line">                <span class="comment">//将nextc设置成锁的状态</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                <span class="comment">//返回true表示获得锁成功，锁的状态为当前状态+1</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    		<span class="comment">//返回false表示获得锁失败</span></span><br><span class="line">        &#125;    </span><br><span class="line">    </span><br></pre></td></tr></table></div></figure>


        <h4 id="unlock方法"   >
          <a href="#unlock方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#unlock方法" class="headerlink" title="unlock方法"></a>unlock方法</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//尝试解锁</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">        sync.release(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">release</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (tryRelease(arg)) &#123;</span><br><span class="line">            <span class="comment">//设置了状态-1 </span></span><br><span class="line">            <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">            <span class="keyword">if</span> (h != <span class="literal">null</span> &amp;&amp; h.waitStatus != <span class="number">0</span>)</span><br><span class="line">                <span class="comment">//如果队首不为空并且结点不是置于等待状态，调用unparkSuccessor()方法</span></span><br><span class="line">                unparkSuccessor(h);</span><br><span class="line">            	</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="comment">//返回true表示解锁成功</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    	<span class="comment">//返回false表示解锁失败</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//试图设置state状态来释放独占锁，如果解锁导致同步器非法，那么就抛出异常</span></span><br><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">tryRelease</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unparkSuccessor</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> node.waitStatus;</span><br><span class="line">    	<span class="comment">//获得结点的等待状态,此时传入的结点是队首元素</span></span><br><span class="line">        <span class="keyword">if</span> (ws &lt; <span class="number">0</span>)</span><br><span class="line">            compareAndSetWaitStatus(node, ws, <span class="number">0</span>);</span><br><span class="line">		<span class="comment">//如果ws小于0 那么用compareAndSetWaitStatus方法将node结点的等待状态置为0</span></span><br><span class="line">        </span><br><span class="line">        <span class="type">Node</span> <span class="variable">s</span> <span class="operator">=</span> node.next;</span><br><span class="line">    	<span class="comment">//获得下一个结点</span></span><br><span class="line">        <span class="keyword">if</span> (s == <span class="literal">null</span> || s.waitStatus &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//如果下一个结点为空或者下一个结点的等待状态大于0</span></span><br><span class="line">            s = <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">//那么将下一个结点置为空</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> tail; t != <span class="literal">null</span> &amp;&amp; t != node; t = t.prev)</span><br><span class="line">                <span class="comment">//从队尾结点开始循环，当尾结点不是当前结点并且非空的时候进入循环，每次循环结束t将指向前一个结点</span></span><br><span class="line">                <span class="keyword">if</span> (t.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                    <span class="comment">//当t的状态字小于等于0的时候</span></span><br><span class="line">                    s = t;</span><br><span class="line">            		<span class="comment">//将s置于t</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (s != <span class="literal">null</span>)</span><br><span class="line">            <span class="comment">//如果s不为空</span></span><br><span class="line">            LockSupport.unpark(s.thread);</span><br><span class="line">    		<span class="comment">//将下一个线程解除阻塞，即唤醒下一个等待线程</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Makes available the permit for the given thread, if it was not already available. If the thread was blocked on park then it will unblock. Otherwise, its next call to park is guaranteed not to block. This operation is not guaranteed to have any effect at all if the given thread has not been started.</span></span><br><span class="line"><span class="comment">形参:</span></span><br><span class="line"><span class="comment">thread – the thread to unpark, or null, in which case this operation has no effect</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unpark</span><span class="params">(Thread thread)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (thread != <span class="literal">null</span>)</span><br><span class="line">            UNSAFE.unpark(thread);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">unpark</span><span class="params">(Object var1)</span>;</span><br></pre></td></tr></table></div></figure>


        <h2 id="ReentrantReadWriteLock"   >
          <a href="#ReentrantReadWriteLock" class="heading-link"><i class="fas fa-link"></i></a><a href="#ReentrantReadWriteLock" class="headerlink" title="ReentrantReadWriteLock"></a>ReentrantReadWriteLock</h2>
      <p>变量</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">6992448646407690164L</span>;</span><br><span class="line"><span class="comment">//串行化ID</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReentrantReadWriteLock.ReadLock readerLock;</span><br><span class="line"><span class="comment">//内部类 读锁</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReentrantReadWriteLock.WriteLock writerLock;</span><br><span class="line"><span class="comment">//内部类 写锁</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> Sync sync;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Unsafe mechanics</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> sun.misc.Unsafe UNSAFE;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> TID_OFFSET;</span><br></pre></td></tr></table></div></figure>

<p>内部类</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">FairSync</span> <span class="keyword">extends</span> <span class="title class_">Sync</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">2274990926593161451L</span>;</span><br><span class="line">    <span class="comment">//串行化ID</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">writerShouldBlock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> hasQueuedPredecessors();</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">readerShouldBlock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> hasQueuedPredecessors();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    //如果当前线程前面有一个排队线程则返回true</span></span><br><span class="line"><span class="comment">    //当线程位于队首或者队列为空则返回false</span></span><br><span class="line"><span class="comment">    public final boolean hasQueuedPredecessors() &#123;</span></span><br><span class="line"><span class="comment">        // The correctness of this depends on head being initialized</span></span><br><span class="line"><span class="comment">        // before tail and on head.next being accurate if the current</span></span><br><span class="line"><span class="comment">        // thread is first in queue.</span></span><br><span class="line"><span class="comment">        Node t = tail; // Read fields in reverse initialization order</span></span><br><span class="line"><span class="comment">        Node h = head;</span></span><br><span class="line"><span class="comment">        Node s;</span></span><br><span class="line"><span class="comment">        return h != t &amp;&amp;</span></span><br><span class="line"><span class="comment">            ((s = h.next) == null || s.thread != Thread.currentThread());</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Sync</span> <span class="keyword">extends</span> <span class="title class_">AbstractQueuedSynchronizer</span> &#123;</span><br><span class="line">     <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Read vs write count extraction constants and functions.</span></span><br><span class="line"><span class="comment">         * Lock state is logically divided into two unsigned shorts:</span></span><br><span class="line"><span class="comment">         * The lower one representing the exclusive (writer) lock hold count,</span></span><br><span class="line"><span class="comment">         * and the upper the shared (reader) hold count.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">     <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SHARED_SHIFT</span>   <span class="operator">=</span> <span class="number">16</span>;</span><br><span class="line">     <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SHARED_UNIT</span>    <span class="operator">=</span> (<span class="number">1</span> &lt;&lt; SHARED_SHIFT);</span><br><span class="line">     <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_COUNT</span>      <span class="operator">=</span> (<span class="number">1</span> &lt;&lt; SHARED_SHIFT) - <span class="number">1</span>;</span><br><span class="line">     <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">EXCLUSIVE_MASK</span> <span class="operator">=</span> (<span class="number">1</span> &lt;&lt; SHARED_SHIFT) - <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">HoldCounter</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// Use id, not reference, to avoid garbage retention</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">long</span> <span class="variable">tid</span> <span class="operator">=</span> getThreadId(Thread.currentThread());</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">     <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ThreadLocalHoldCounter</span></span><br><span class="line">            <span class="keyword">extends</span> <span class="title class_">ThreadLocal</span>&lt;HoldCounter&gt; &#123;</span><br><span class="line">            <span class="keyword">public</span> HoldCounter <span class="title function_">initialValue</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HoldCounter</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="构造方法-1"   >
          <a href="#构造方法-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#构造方法-1" class="headerlink" title="构造方法"></a>构造方法</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>空参构造</span><br><span class="line">    <span class="comment">//默认创建一个非公平的ReentrantReadWriteLock</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ReentrantReadWriteLock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(<span class="literal">false</span>);</span><br><span class="line">    <span class="comment">//调用ReentrantReadWriteLock(boolean fair) 方法 传入false参数</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>有参构造</span><br><span class="line">    <span class="comment">//给定指定参数，创建相应的读锁写锁</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ReentrantReadWriteLock</span><span class="params">(<span class="type">boolean</span> fair)</span> &#123;</span><br><span class="line">        sync = fair ? <span class="keyword">new</span> <span class="title class_">FairSync</span>() : <span class="keyword">new</span> <span class="title class_">NonfairSync</span>();</span><br><span class="line">        readerLock = <span class="keyword">new</span> <span class="title class_">ReadLock</span>(<span class="built_in">this</span>);</span><br><span class="line">        writerLock = <span class="keyword">new</span> <span class="title class_">WriteLock</span>(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h3 id="方法"   >
          <a href="#方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#方法" class="headerlink" title="方法"></a>方法</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//返回写锁</span></span><br><span class="line"><span class="keyword">public</span> ReentrantReadWriteLock.WriteLock <span class="title function_">writeLock</span><span class="params">()</span> &#123; <span class="keyword">return</span> writerLock; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//返回读锁</span></span><br><span class="line"><span class="keyword">public</span> ReentrantReadWriteLock.ReadLock  <span class="title function_">readLock</span><span class="params">()</span>  &#123; <span class="keyword">return</span> readerLock; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//返回是否公平</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">isFair</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sync <span class="keyword">instanceof</span> FairSync;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//返回锁的拥有线程</span></span><br><span class="line"><span class="keyword">protected</span> Thread <span class="title function_">getOwner</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sync.getOwner();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//返回读锁数量，用于监测系统状态</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getReadLockCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sync.getReadLockCount();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//查询写锁是否空闲</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isWriteLocked</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sync.isWriteLocked();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//查询当前线程是否有写锁</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isWriteLockedByCurrentThread</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sync.isHeldExclusively();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//查询当前线程写锁的可重入数</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getWriteHoldCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sync.getWriteHoldCount();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//查询当前线程读锁的可重入数</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getReadHoldCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sync.getReadHoldCount();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">    </span><br></pre></td></tr></table></div></figure>


        <h3 id="Sync常用方法"   >
          <a href="#Sync常用方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#Sync常用方法" class="headerlink" title="Sync常用方法"></a>Sync常用方法</h3>
      
        <h4 id="sync方法"   >
          <a href="#sync方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#sync方法" class="headerlink" title="sync方法"></a>sync方法</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Sync() &#123;</span><br><span class="line">            readHolds = <span class="keyword">new</span> <span class="title class_">ThreadLocalHoldCounter</span>();</span><br><span class="line">            <span class="comment">//调用ThreadLocalHoldCounter()</span></span><br><span class="line">            </span><br><span class="line">            setState(getState()); <span class="comment">// ensures visibility of readHolds</span></span><br><span class="line">            <span class="comment">//设置状态字，确保readHolds的可见性</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ThreadLocalHoldCounter</span> <span class="keyword">extends</span> <span class="title class_">ThreadLocal</span>&lt;HoldCounter&gt; &#123;</span><br><span class="line">            <span class="keyword">public</span> HoldCounter <span class="title function_">initialValue</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HoldCounter</span>();</span><br><span class="line">                <span class="comment">//调用方法 直接返回HoldCounter</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">HoldCounter</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="comment">//设置数量为0</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Use id, not reference, to avoid garbage retention</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">long</span> <span class="variable">tid</span> <span class="operator">=</span> getThreadId(Thread.currentThread());</span><br><span class="line">            <span class="comment">//获取当前线程id，使得被标记省的被垃圾回收</span></span><br><span class="line">        &#125;        </span><br><span class="line">    </span><br></pre></td></tr></table></div></figure>


        <h4 id="tryAcquire方法"   >
          <a href="#tryAcquire方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#tryAcquire方法" class="headerlink" title="tryAcquire方法"></a>tryAcquire方法</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            如果是可重入获取或者队列策略允许，则该线程有权利加锁，那么将更新锁的状态并且设置持有者为当前线程</span></span><br><span class="line"><span class="comment">         	如果读或写计数器非0，且不是当前线程持有，则返回false</span></span><br><span class="line"><span class="comment">         	如果计数器将达到上限，则返回false</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">            <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">    		<span class="comment">//获取锁的状态</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">w</span> <span class="operator">=</span> exclusiveCount(c);</span><br><span class="line">    		<span class="comment">//获取锁的可重入数计数</span></span><br><span class="line">            <span class="keyword">if</span> (c != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// (Note: if c != 0 and w == 0 then shared count != 0)</span></span><br><span class="line">                <span class="keyword">if</span> (w == <span class="number">0</span> || current != getExclusiveOwnerThread())</span><br><span class="line">                    <span class="comment">//如果可重入数计数为空或者锁非当前线程持有，那么返回false</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">if</span> (w + exclusiveCount(acquires) &gt; MAX_COUNT)</span><br><span class="line">                    <span class="comment">//如果可重入数大于最大数量，抛出异常</span></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">                <span class="comment">// Reentrant acquire</span></span><br><span class="line">                <span class="comment">//可重入锁加锁成功</span></span><br><span class="line">                <span class="comment">//将计数器设回状态中</span></span><br><span class="line">                setState(c + acquires);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">    		<span class="comment">// 能运行到这里也没有抛出异常 那么说明锁空闲</span></span><br><span class="line">            <span class="keyword">if</span> (writerShouldBlock() ||!compareAndSetState(c, c + acquires))</span><br><span class="line">                <span class="comment">//进行判断，如果写操作被阻塞或者CAS机制发现更新操作失败(即多线程情况下别人线程已经获取了锁)</span></span><br><span class="line">                <span class="comment">//加锁失败</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    		<span class="comment">//将当前线程设置为锁的持有者，返回true</span></span><br><span class="line">            setExclusiveOwnerThread(current);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="type">int</span> <span class="title function_">exclusiveCount</span><span class="params">(<span class="type">int</span> c)</span> &#123; <span class="keyword">return</span> c &amp; EXCLUSIVE_MASK; &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="tryRelease方法"   >
          <a href="#tryRelease方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#tryRelease方法" class="headerlink" title="tryRelease方法"></a>tryRelease方法</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryRelease</span><span class="params">(<span class="type">int</span> releases)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!isHeldExclusively())</span><br><span class="line">                <span class="comment">//当锁不是当前线程持有，则抛出异常</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">    </span><br><span class="line">    		<span class="comment">//运行到这里说明锁的持有者是当前线程</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">nextc</span> <span class="operator">=</span> getState() - releases;</span><br><span class="line">    		<span class="comment">//将当前状态数减去1之后设置为更新后的状态数</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">free</span> <span class="operator">=</span> exclusiveCount(nextc) == <span class="number">0</span>;</span><br><span class="line">    		<span class="comment">//如果更新之后数据为0，那么说明锁空闲</span></span><br><span class="line">            <span class="keyword">if</span> (free) </span><br><span class="line">                <span class="comment">//锁空闲之后设置者为null</span></span><br><span class="line">                setExclusiveOwnerThread(<span class="literal">null</span>);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    		<span class="comment">//设置更新之后的状态字</span></span><br><span class="line">            setState(nextc);</span><br><span class="line">    </span><br><span class="line">    		<span class="comment">//返回可重入次数</span></span><br><span class="line">            <span class="keyword">return</span> free;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">isHeldExclusively</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">// While we must in general read state before owner,</span></span><br><span class="line">            <span class="comment">// we don&#x27;t need to do so to check if current thread is owner</span></span><br><span class="line">            <span class="keyword">return</span> getExclusiveOwnerThread() == Thread.currentThread();</span><br><span class="line">    	<span class="comment">//如果当前线程不是锁的持有者则返回false</span></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="tryWriteLock方法"   >
          <a href="#tryWriteLock方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#tryWriteLock方法" class="headerlink" title="tryWriteLock方法"></a>tryWriteLock方法</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryWriteLock</span><span class="params">()</span> &#123;</span><br><span class="line">    		<span class="comment">//获取当前线程和锁的状态字</span></span><br><span class="line">            <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">            <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">            <span class="keyword">if</span> (c != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//如果锁有持有者</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">w</span> <span class="operator">=</span> exclusiveCount(c);</span><br><span class="line">                <span class="comment">//获取锁的可重入数</span></span><br><span class="line">                <span class="keyword">if</span> (w == <span class="number">0</span> || current != getExclusiveOwnerThread())</span><br><span class="line">                    <span class="comment">//如果锁并非当前线程持有，则加写锁失败</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">if</span> (w == MAX_COUNT)</span><br><span class="line">                    <span class="comment">//如果锁的可重入数达到上限，则抛出异常</span></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">    		<span class="comment">//执行到这里还没有抛出异常说明可重入数未达到上限或者锁空闲</span></span><br><span class="line">            <span class="keyword">if</span> (!compareAndSetState(c, c + <span class="number">1</span>))</span><br><span class="line">                <span class="comment">//用CAS机制设置状态失败</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    			<span class="comment">//返回false</span></span><br><span class="line">    </span><br><span class="line">    		<span class="comment">//如果加锁成功，那么将锁持有者设置为当前线程</span></span><br><span class="line">            setExclusiveOwnerThread(current);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="tryReadLock方法"   >
          <a href="#tryReadLock方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#tryReadLock方法" class="headerlink" title="tryReadLock方法"></a>tryReadLock方法</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">对读锁使用tryLock()方法</span><br><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryReadLock</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">          	<span class="comment">//获取当前线程</span></span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">                <span class="comment">//获取锁的状态</span></span><br><span class="line">                <span class="keyword">if</span> (exclusiveCount(c) != <span class="number">0</span> &amp;&amp; getExclusiveOwnerThread() != current)</span><br><span class="line">                <span class="comment">//锁可重入数非空或者锁的持有者不是当前线程，则加锁失败</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> sharedCount(c);</span><br><span class="line">                <span class="comment">//获取分享状态字</span></span><br><span class="line">                <span class="keyword">if</span> (r == MAX_COUNT)</span><br><span class="line">                    <span class="comment">//如果分享数达到上限 抛出异常</span></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (compareAndSetState(c, c + SHARED_UNIT)) &#123;</span><br><span class="line">                    <span class="comment">//用CAS给状态c设置数据</span></span><br><span class="line">                    <span class="keyword">if</span> (r == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">//如果r为空</span></span><br><span class="line">                        firstReader = current;</span><br><span class="line">                        firstReaderHoldCount = <span class="number">1</span>;</span><br><span class="line">                        <span class="comment">//那么读锁持有数设置为1，第一头结点设置为当前线程</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (firstReader == current) &#123;</span><br><span class="line">                        <span class="comment">//r非空，那么头结点获取线程数+1</span></span><br><span class="line">                        firstReaderHoldCount++;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">//缓冲区线程数设置为头结点线程数</span></span><br><span class="line">                        <span class="type">HoldCounter</span> <span class="variable">rh</span> <span class="operator">=</span> cachedHoldCounter;</span><br><span class="line">                        <span class="keyword">if</span> (rh == <span class="literal">null</span> || rh.tid != getThreadId(current))</span><br><span class="line">                            <span class="comment">//如果rh为空或者rh的线程id不等于当前线程id</span></span><br><span class="line">                            cachedHoldCounter = rh = readHolds.get();</span><br><span class="line">                        </span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (rh.count == <span class="number">0</span>)</span><br><span class="line">                            readHolds.set(rh);</span><br><span class="line">                        rh.count++;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//加锁成功</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="tryAcquireShared方法"   >
          <a href="#tryAcquireShared方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#tryAcquireShared方法" class="headerlink" title="tryAcquireShared方法"></a>tryAcquireShared方法</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">tryAcquireShared</span><span class="params">(<span class="type">int</span> unused)</span> &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            如果写锁被另一个线程持有，则失败</span></span><br><span class="line"><span class="comment">            如果当前线程能有资格持有写锁。询问队列策略是否应该被阻塞</span></span><br><span class="line"><span class="comment">            	没有被阻塞，用CAS机制给锁更新状态和计数</span></span><br><span class="line"><span class="comment">            如果加锁失败，那么可能是线程不能持有写锁，或者CAS更新失败，或者计数器饱和	</span></span><br><span class="line"><span class="comment">            </span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">            <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">            <span class="keyword">if</span> (exclusiveCount(c) != <span class="number">0</span> &amp;&amp;</span><br><span class="line">                getExclusiveOwnerThread() != current)</span><br><span class="line">                <span class="comment">//判断写锁是否被其他线程持有</span></span><br><span class="line">                <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> sharedCount(c);</span><br><span class="line">    			<span class="comment">//将计数状态交给r</span></span><br><span class="line">            <span class="keyword">if</span> (!readerShouldBlock() &amp;&amp;</span><br><span class="line">                r &lt; MAX_COUNT &amp;&amp;</span><br><span class="line">                compareAndSetState(c, c + SHARED_UNIT)) &#123;</span><br><span class="line">                <span class="comment">//当不被阻塞,并且计数器小于最大值以及更新状态成功</span></span><br><span class="line">                <span class="keyword">if</span> (r == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">//如果计数器为0 ，那么将当前线程设置为第一个顾客，可重入计数为1</span></span><br><span class="line">                    firstReader = current;</span><br><span class="line">                    firstReaderHoldCount = <span class="number">1</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (firstReader == current) &#123;</span><br><span class="line">                    <span class="comment">//如果第一个获取锁的是当前线程，那么将计数器+1</span></span><br><span class="line">                    firstReaderHoldCount++;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="type">HoldCounter</span> <span class="variable">rh</span> <span class="operator">=</span> cachedHoldCounter;</span><br><span class="line">                    <span class="keyword">if</span> (rh == <span class="literal">null</span> || rh.tid != getThreadId(current))</span><br><span class="line">                        cachedHoldCounter = rh = readHolds.get();</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (rh.count == <span class="number">0</span>)</span><br><span class="line">                        readHolds.set(rh);</span><br><span class="line">                    rh.count++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> fullTryAcquireShared(current);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></div></figure>



</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/07/20/Sprng%E9%9D%A2%E8%AF%95%E9%A2%98/">Sprng面试题</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-07-20</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">428</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">2分</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="Spring的事务传播行为"   >
          <a href="#Spring的事务传播行为" class="heading-link"><i class="fas fa-link"></i></a><a href="#Spring的事务传播行为" class="headerlink" title="Spring的事务传播行为"></a>Spring的事务传播行为</h1>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">事务有七种传播行为</span><br><span class="line"><span class="number">1.</span>REQUIRED:支持当前事务，当前有事务则直接加入该事务，当没有事务会创建一个新事务</span><br><span class="line"><span class="number">2.</span>SUPPORTS：支持当前事务，如果当前没事务就以非事务的方式进行</span><br><span class="line"><span class="number">3.</span>MANDATORY:支持当前事务，必须要有事务否则抛出异常</span><br><span class="line"><span class="number">4.</span>REQUIRES_NEW:不管有没有事务，都会开启新事务，会把当前事务挂起，当新事务执行结束老事务才会继续运行</span><br><span class="line"><span class="number">5.</span>NOT_SUPPORTED:以非事务的方式进行，如果有事务则把事务挂起</span><br><span class="line"><span class="number">6.</span>NEVER:不允许有事务，如果有事务则抛出异常</span><br><span class="line"><span class="number">7.</span>NESTED:如果当前有事务则嵌套在当前事务，如果没有会新建一个事务</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">REQUIRED和NESTED的区别:REQUIRED是同一个事务，子进程回滚也会导致父进程回滚，NESTED是嵌套事务，子事务回滚不会导致父事务回滚，</span><br></pre></td></tr></table></div></figure>












        <h1 id="Spring事务什么时候会失效？"   >
          <a href="#Spring事务什么时候会失效？" class="heading-link"><i class="fas fa-link"></i></a><a href="#Spring事务什么时候会失效？" class="headerlink" title="Spring事务什么时候会失效？"></a>Spring事务什么时候会失效？</h1>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1.Bean对象没有被Spirng容器管理：自己new出来的bean对象而不是IOC中的Bean</span><br><span class="line">2.方法的访问权限不是Public，方法的访问权限是private也会失效</span><br><span class="line">3.数据库不支持事务，所以Spring的事务会失效</span><br><span class="line">4.异常被捕获了，导致本该回滚的数据没有回滚</span><br><span class="line">5.异常类型错误或者配置错误</span><br><span class="line">6.数据源没有配置事务管理器</span><br><span class="line">7.自身调用:本方法内调用本方法，那么就没有走aop的代理过程，所以会失效</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>




        <h1 id="Spring事务的本质？"   >
          <a href="#Spring事务的本质？" class="heading-link"><i class="fas fa-link"></i></a><a href="#Spring事务的本质？" class="headerlink" title="Spring事务的本质？"></a>Spring事务的本质？</h1>
      
        <h1 id="说说你对IOC的理解"   >
          <a href="#说说你对IOC的理解" class="heading-link"><i class="fas fa-link"></i></a><a href="#说说你对IOC的理解" class="headerlink" title="说说你对IOC的理解"></a>说说你对IOC的理解</h1>
      
        <h1 id="说说你对AOP的理解"   >
          <a href="#说说你对AOP的理解" class="heading-link"><i class="fas fa-link"></i></a><a href="#说说你对AOP的理解" class="headerlink" title="说说你对AOP的理解"></a>说说你对AOP的理解</h1>
      
        <h1 id="AutoWired和Resource的区别"   >
          <a href="#AutoWired和Resource的区别" class="heading-link"><i class="fas fa-link"></i></a><a href="#AutoWired和Resource的区别" class="headerlink" title="AutoWired和Resource的区别?"></a>AutoWired和Resource的区别?</h1>
      </div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/07/20/SpringMVC%E9%9D%A2%E8%AF%95%E9%A2%98/">SpringMVC面试题</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-07-20</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">565</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">3分</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="什么是SpringMVC"   >
          <a href="#什么是SpringMVC" class="heading-link"><i class="fas fa-link"></i></a><a href="#什么是SpringMVC" class="headerlink" title="什么是SpringMVC"></a>什么是SpringMVC</h1>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SpringMVC是Spring框架下的一个模块，用于处理web请求，基于MVC的web框架,而MVC是一种设计模式</span><br><span class="line">    M -model模型 </span><br><span class="line">   	V -View 视图</span><br><span class="line">    C -controller控制器</span><br></pre></td></tr></table></div></figure>


        <h1 id="能说说SpringMVC的工作流程吗？"   >
          <a href="#能说说SpringMVC的工作流程吗？" class="heading-link"><i class="fas fa-link"></i></a><a href="#能说说SpringMVC的工作流程吗？" class="headerlink" title="能说说SpringMVC的工作流程吗？"></a>能说说SpringMVC的工作流程吗？</h1>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>用户发送HTTP请求到前端控制器DispatcherServlet</span><br><span class="line"><span class="number">2.</span>DispatcherServlet调用handlerMapping(处理器映射器)找到映射器</span><br><span class="line"><span class="number">3.</span>handlerMapping通过url路径生成对应的处理器和拦截器，一起返回给DispatcherServlet</span><br><span class="line"><span class="number">4.</span>DispatcherServlet调用handlerAdapter(处理器适配器)</span><br><span class="line"><span class="number">5.</span>handlerApadter调用handler(处理器)[也就是我们写的Controller]</span><br><span class="line"><span class="number">6.</span>handler处理返回结果封装成ModelandView</span><br><span class="line"><span class="number">7.</span>handlerApadter将返回结果ModelandView返回给DispatcherServlet</span><br><span class="line"><span class="number">8.</span>DispatcherServlet将ModelandView发送给ViewReslover(视图解析器)</span><br><span class="line"><span class="number">9.</span>ViewReslover解析之后返回具体的View</span><br><span class="line"><span class="number">10.</span>DisPatcherServlet将View渲染</span><br><span class="line"><span class="number">11.</span>DisPatcherServlet相应用户</span><br><span class="line">    </span><br><span class="line">而面向接口编程有不同的工作流程</span><br><span class="line"><span class="number">1.</span>用户发送HTTP请求到前端控制器DispatcherServlet</span><br><span class="line"><span class="number">2.</span>DispatcherServlet调用handlerMapping(处理器映射器)找到映射器</span><br><span class="line"><span class="number">3.</span>handlerMapping通过url路径生成对应的处理器和拦截器，一起返回给DispatcherServlet</span><br><span class="line"><span class="number">4.</span>DispatcherServlet调用handlerAdapter(处理器适配器)</span><br><span class="line"><span class="number">5.</span>handlerApadter调用handler(处理器)[也就是我们写的Controller]</span><br><span class="line"><span class="number">6.</span>方法上添加ReSponseBody</span><br><span class="line"><span class="number">7.</span>通过HttpMessageConverter来返回结果转为Json格式并响应</span><br></pre></td></tr></table></div></figure>


        <h1 id="SpringMVC的主要组件有哪些"   >
          <a href="#SpringMVC的主要组件有哪些" class="heading-link"><i class="fas fa-link"></i></a><a href="#SpringMVC的主要组件有哪些" class="headerlink" title="SpringMVC的主要组件有哪些"></a>SpringMVC的主要组件有哪些</h1>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">主要有五个组件:DisPatcherServlet、handlerMapping、handlerAdapter、handler、ViewReslover</span><br><span class="line"></span><br><span class="line">1.DisPatcherServlet:前端控制器    整个流程的控制中心，调用其他组件来处理网络请求</span><br><span class="line">2.handlerMapping   :处理器映射器  负责根据网络请求不同找到对应的处理器映射</span><br><span class="line">3.hander           :处理器       对具体的请求进行处理，通常是我们写的Controller</span><br><span class="line">4.handerAdapter    :处理器适配器  通过特定的规则去执行handler</span><br><span class="line">5.ViewReslover     :视图解析器    用于解析处理结果生成View</span><br></pre></td></tr></table></div></figure>


        <h1 id="SpringMVC有哪些常用注解？"   >
          <a href="#SpringMVC有哪些常用注解？" class="heading-link"><i class="fas fa-link"></i></a><a href="#SpringMVC有哪些常用注解？" class="headerlink" title="SpringMVC有哪些常用注解？"></a>SpringMVC有哪些常用注解？</h1>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span> :用于处理请求url的注解，可用于类和方法上，用于类上则所有方法都需要有这个父地址</span><br><span class="line"><span class="meta">@RequestBody</span>    :实现接收网络请求中的JSON数据</span><br><span class="line"><span class="meta">@ResponseBody</span>   :用于返回Json格式的数据</span><br></pre></td></tr></table></div></figure>


        <h1 id="Spring、SpringMVC、SpringBoot的区别"   >
          <a href="#Spring、SpringMVC、SpringBoot的区别" class="heading-link"><i class="fas fa-link"></i></a><a href="#Spring、SpringMVC、SpringBoot的区别" class="headerlink" title="Spring、SpringMVC、SpringBoot的区别"></a>Spring、SpringMVC、SpringBoot的区别</h1>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Spring是一个开发框架，核心的IOC和AOP</span><br><span class="line">SpringMVC是Spring的一个模块，用于处理网络请求的模块</span><br><span class="line">SpringBoot是基于Spring的一个脚手架，为开发Spring生态其他框架铺平道路</span><br></pre></td></tr></table></div></figure>

</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/07/19/%E6%9F%90%E5%A4%A7%E5%8E%82%E7%9A%84%E5%AE%9E%E4%B9%A0%E7%94%9F%E7%BA%BF%E4%B8%8B%E9%9D%A2%E8%AF%95/">某大厂的实习生线下面试</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-07-19</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">1.1k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">6分</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>一开始约的是两点面试，然后我是一点半就到了，搞来搞去变得直接上去在别人办公室里，等上一个哥们面试结束，然后直接就开始了。</p>
<h2 id=""><a href="#" class="headerlink" title="&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;"></a>&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</h2><p>1.简单介绍一下自己的家庭情况和学校的实习、学习情况，主修的课程、技能等</p>
<p>2.看你简历上有一个仿今日头条的项目?是出于什么目的进行开发的呢？</p>
<p>3.项目是几个人组成的小组?每个人的成员构成和职责是什么样的？</p>
<p>4.你负责的是哪个角色？</p>
<p>5.你应该也有在网上学习java，能说一下你在互联网是通过什么渠道学习的呢？</p>
<p>6.你了解前端开发吗？</p>
<p>7.有了解过集合吗？看过底层源码吗？</p>
<p>8.ArrayList底层是怎么进行创建和扩容的呢？</p>
<p>9.集合是怎么处理哈希碰撞的？</p>
<p>10.有了解过锁吗?Lock和Sychorized那些</p>
<p>11.final修饰符有学习过吗？它有什么使用场景</p>
<p>12.final修饰方法会怎么样？final修饰类会怎么样?</p>
<p>13.Integer和int能直接进行比较吗？</p>
<p>14.Integer底层有一个缓冲数组，在这个缓冲数组边界能直接使用吗？</p>
<p>15.&#x3D;&#x3D;和equals方法的区别</p>
<p>16.有了解过Volatile关键字吗？</p>
<p>17.说说SpringMVC的执行流程</p>
<p>18.说说你对Vue和H5的理解</p>
<p>19.V-show和V-if的使用场景</p>
<p>20.有了解过垃圾回收机制吗？</p>
<p>21.jdk1.8之后默认的GC是哪个？</p>
<p>22.有了解过主流的数据库吗？</p>
<p>23.说说你对Mysql优化的理解</p>
<p>24.有了解过范式和反范式吗？</p>
<p>25.你在项目中有使用过Redis，能说说你基于什么情况考虑使用的Redis呢?</p>
<p>26.Redis常用的数据类型有哪些？</p>
<p>27.你在Redis的环境下有没有开发部署过项目</p>

        <h2 id="-1"   >
          <a href="#-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#-1" class="headerlink" title="&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;"></a>&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</h2>
      <p>技术面部分结束了，然后hr问我有没有想对公司了解的情况</p>
<p>我当时问的是1.实习的时间段，是否支持转正</p>
<p>​						2.上班工作的时间段</p>
<p>然后这个时候技术面试官追问了一条能不能接收996的情况</p>
<p>总结和复盘：</p>
<p>首先，我要感谢这个公司能给我一个这个时间段的一个技术线下面试，在目前我所在的阶段，这个机会是千载难逢的，这是不可否认的。</p>
<p>其次，我因为是第一次线下面试，经过这个技术面才能知道学习到的东西和当时在小房子里面能想起来的东西真的差距很大。</p>
<p>我进去脑子一片空白，和技术面试官大眼瞪小眼，你看着我我看着你，然后他问的东西有些其实我都知道也系统学习过看过源码，但是在当时的环境下，我脑子里面什么都不知道，所有的都是基于平常的理解再一点点一点点的复述出来。</p>
<p>第三，因为第一个问题就把我问爆了有点，我自己答得不对，甚至有可能是全错，这个面试官眉头一皱，我就知道这次其实噶了，但是万幸的是在这个时间段失败是可以接受的事，因为只有经过这次面试，我才知道在日常学习和真的面试中你能脑子里想出来的东西是不一样的，我得加强对面试情况的测试。</p>
<p>真得重新准备准备下EE的内容，因为基础有点忘记了搞得答出来很没有底气，我都不知道是对是错，等校招的时候好好发挥一下，在这个时间段就应该多投实习面试，去多尝试面试，锻炼面试经验</p>
<p>可以说很多准备的东西都没有问到，问到的都是偏向基础和底层，而这块确实是我现在目前尚未发现的问题。</p>
<p>输一场也不一定是坏事，是吧</p>
</div></div></article></section><nav class="paginator"><div class="paginator-inner"><a class="extend prev" rel="prev" href="/page/2/"><i class="fas fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/4/"><i class="fas fa-angle-right"></i></a></div></nav></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><section class="sidebar-toc hide"></section><!-- ov = overview--><section class="sidebar-ov"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/E7977EEC2FEF2A2B9146704271490ED2.png" alt="avatar"></div><p class="sidebar-ov-author__text">步子小也好，走得慢也好，是在往前走就好</p></div><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="/" target="_blank" rel="noopener" data-popover="social.389081641" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-qq"></i></span></a><a class="sidebar-ov-social-item" href="https://github.com/Kkker1" target="_blank" rel="noopener" data-popover="Github" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-github"></i></span></a><a class="sidebar-ov-social-item" href="/" target="_blank" rel="noopener" data-popover="social.KKKer1An@163.com" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="far fa-envelope"></i></span></a></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">47</div><div class="sidebar-ov-state-item__name">归档</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">12</div><div class="sidebar-ov-state-item__name">分类</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">18</div><div class="sidebar-ov-state-item__name">标签</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="知识共享许可协议" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2024</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>KkkerAn</span></div><div><span>由 <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> 强力驱动</span><span> v6.3.0</span><span class="footer__devider">|</span><span>主题 - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.8.0</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="搜索文章（支持多关键词，请用空格分隔）"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lazyload@2.0.0-rc.2/lazyload.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.xml';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // 将 XML 转为 JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // 搜索对象（标题、内容）的权重，影响显示顺序
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // 根据空白字符分隔关键字
        var keywords = searchText.split(/[\s]+/);
        // 搜索结果
        var matchPosts = [];

        // 有多个关键字时，将原文字整个保存下来
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // 防止未输入字符时搜索
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // 没有标题的文章使用预设的 i18n 变量代替
            var title = (data.title && data.title.trim()) || '[ 文章无标题 ]';
            var titleLower = title && title.toLowerCase();
            // 删除 HTML 标签 和 所有空白字符
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // 删除重复的 /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // 标题中匹配到的关键词
            var titleHitSlice = [];
            // 内容中匹配到的关键词
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * 获取匹配的关键词的索引
              * @param {String} keyword 要匹配的关键字
              * @param {String} text 原文字
              * @param {Boolean} caseSensitive 是否区分大小写
              * @param {Number} weight 匹配对象的权重。权重大的优先显示
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // 每次匹配的开始索引
                var index = -1;     // 匹配到的索引值
                var result = [];    // 匹配结果

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // 索引位置相同的关键词，保留长度较长的
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // 按照匹配文字的索引的递增顺序排序
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * 给文本中匹配到的关键词添加标记，从而进行高亮显示
              * @param {String} text 原文本
              * @param {Array} hitSlice 匹配项的索引信息
              * @param {Number} start 开始索引
              * @param {Number} end 结束索引
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // 文章总的搜索权重
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // 标记匹配关键词后的标题
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // 标记匹配关键词后的内容
              var postContent;
              // 显示内容的长度
              var SHOW_WORD_LENGTH = 200;
              // 命中关键词前的字符显示长度
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // 截取匹配的第一个字符，前后共 200 个字符来显示
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // 未匹配到内容，直接截取前 200 个字符来显示
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // 按权重递增的顺序排序，使权重大的优先显示
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);

function safeOpenUrl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}

function extSearch(engine) {
  var engines = {
    google: 'https://www.google.com/search?q=',
    bing: 'https://cn.bing.com/search?q=',
    baidu: 'https://www.baidu.com/s?ie=UTF-8&wd=',
  };
  var host = window.location.host;
  var query = $('.search-input input').val().toLowerCase().trim();
  var uri = engines[engine] + query + ' site:' + host;

  if (query) {
    safeOpenUrl(uri);
  } else {
    Stun.utils.popAlert('warning', '请输入字符');
  }
}

var assistSearchList = window.CONFIG.assistSearch;

if (Array.isArray(assistSearchList)) {
  assistSearchList.forEach(function (name) {
    document.querySelector('.search-btns-item--' + name).addEventListener('click', function () {
      extSearch(name);
    }, false);
  });
}</script><script src="/js/utils.js?v=2.8.0"></script><script src="/js/stun-boot.js?v=2.8.0"></script><script src="/js/scroll.js?v=2.8.0"></script><script src="/js/header.js?v=2.8.0"></script><script src="/js/sidebar.js?v=2.8.0"></script><script type="application/json" src="/search.xml"></script></body></html>