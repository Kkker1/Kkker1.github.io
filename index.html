<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/bonbon-16%C3%9716.png?v=2.8.0" type="image/png" sizes="16x16"><link rel="icon" href="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/bonbon-32%C3%9732.png?v=2.8.0" type="image/png" sizes="32x32"><meta property="og:type" content="website">
<meta property="og:title" content="KkkerAn&#39;s Blog">
<meta property="og:url" content="https://username.github.io/index.html">
<meta property="og:site_name" content="KkkerAn&#39;s Blog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="KkkerAn">
<meta name="twitter:card" content="summary"><title>KkkerAn's Blog</title><link ref="canonical" href="https://username.github.io/index.html"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.8.0"><link rel="stylesheet" href="css/custom.css"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":false},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: true,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"复制","copySuccess":"复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 6.3.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">归档</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">分类</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">标签</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">搜索</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">WelCome to My Blog</div><div class="header-banner-info__subtitle">回忆像一块彩色橡皮糖,被拉长了,颜色淡了,但还是甜</div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content content-home" id="content"><section class="postlist"><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/08/04/%E6%AD%BB%E4%B9%8B%E5%89%8D%E8%A6%81%E5%81%9A%E5%AE%8C%E7%9A%84%E7%AE%97%E6%B3%95%E6%89%8B%E5%86%8C-%E7%AE%97%E6%B3%95%5B%E6%95%B0%E7%BB%84%E7%AF%87%5D/">死之前要做完的算法手册-[数组篇]</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-08-04</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">13.8k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">107分</span></span></div></header><div class="post-body"><div class="post-excerpt"><p><strong>前言</strong></p>
<p>经过考虑之后决定按照代码随想录的训练路线来做一个算法的学习</p>
<p>然后下面是我做数组算法的时候踩的坑</p>
<p><strong>如果赶时间的话做法可以不用看，就主要看思路、总结、图解</strong></p>
<p><em>输是正常的，重要的是不要怕输</em></p>

        <h1 id="二分查找"   >
          <a href="#二分查找" class="heading-link"><i class="fas fa-link"></i></a><a href="#二分查找" class="headerlink" title="二分查找"></a>二分查找</h1>
      <p>给定一个 n 个元素有序的（升序）整型数组 nums 和一个目标值 target  ，写一个函数搜索 nums 中的 target，如果目标值存在返回下标，否则返回 -1</p>
<p>题目是<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/binary-search/" >LeetCode上704题</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="704-二分查找"   >
          <a href="#704-二分查找" class="heading-link"><i class="fas fa-link"></i></a><a href="#704-二分查找" class="headerlink" title="704.二分查找"></a>704.二分查找</h2>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/binary-search/" >LeetCode.704题(easy)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="第一次做"   >
          <a href="#第一次做" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一次做" class="headerlink" title="第一次做"></a>第一次做</h3>
      <p>第一次单独做于23&#x2F;08&#x2F;04，说实话二分查找想起来很简单，但是一写就踩了不少坑</p>

        <h4 id="第一次代码"   >
          <a href="#第一次代码" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一次代码" class="headerlink" title="第一次代码"></a>第一次代码</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">search</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> target)</span> &#123;</span><br><span class="line">        <span class="type">int</span> low=<span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> high=nums.length;</span><br><span class="line">        <span class="keyword">while</span>(low!=high)&#123;</span><br><span class="line">            <span class="type">int</span> mid=(low+high)/<span class="number">2</span>;</span><br><span class="line">            <span class="keyword">if</span>(target&gt;nums[mid])&#123;</span><br><span class="line">                low=mid+<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(target==nums[mid])&#123;</span><br><span class="line">                <span class="keyword">return</span> mid-<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(target&lt;nums[mid])&#123;</span><br><span class="line">                high=mid-<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="提交错误"   >
          <a href="#提交错误" class="heading-link"><i class="fas fa-link"></i></a><a href="#提交错误" class="headerlink" title="提交错误"></a>提交错误</h5>
      <p>CASE1:nums&#x3D;[-1,0,3,5,9,12],target&#x3D;9,输出-1,预计输出 4</p>
<p>CASE2:nums&#x3D;[-1,0,3,5,9,12],target&#x3D;2,输出-1,预计输出-1</p>
<p>这不是运行案例都没通过嘛?更别提提交测试了</p>

        <h5 id="原因"   >
          <a href="#原因" class="heading-link"><i class="fas fa-link"></i></a><a href="#原因" class="headerlink" title="原因"></a>原因</h5>
      <p>下标我是从0开始，而上标是从数组的长度6开始，但是数组中存数的时候是0~5,所以这是第一个不对的地方，于是我进行了修正把上标的位置改成length-1</p>

        <h4 id="第二次源代码"   >
          <a href="#第二次源代码" class="heading-link"><i class="fas fa-link"></i></a><a href="#第二次源代码" class="headerlink" title="第二次源代码"></a>第二次源代码</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">search</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> target)</span> &#123;   	</span><br><span class="line">		<span class="type">int</span> low=<span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> high=nums.length-<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span>(low!=high)&#123;</span><br><span class="line">            <span class="type">int</span> mid=(low+high)/<span class="number">2</span>;</span><br><span class="line">            <span class="keyword">if</span>(target&gt;nums[mid])&#123;</span><br><span class="line">                low=mid+<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(target==nums[mid])&#123;</span><br><span class="line">                <span class="keyword">return</span> mid;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(target&lt;nums[mid])&#123;</span><br><span class="line">                high=mid-<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="提交错误-1"   >
          <a href="#提交错误-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#提交错误-1" class="headerlink" title="提交错误"></a>提交错误</h5>
      <p>CASE:nums&#x3D;[5],target&#x3D;5,输出-1,预计输出0</p>

        <h5 id="原因-1"   >
          <a href="#原因-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#原因-1" class="headerlink" title="原因"></a>原因</h5>
      <p>下标从0开始,上标也是0压根就没有进入循环判断，所以我又做了改正，将一个元素的数组进行了单独判断</p>

        <h4 id="第三次代码"   >
          <a href="#第三次代码" class="heading-link"><i class="fas fa-link"></i></a><a href="#第三次代码" class="headerlink" title="第三次代码"></a>第三次代码</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">search</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> target)</span> &#123;   </span><br><span class="line">        <span class="comment">//如果nums只有一个元素</span></span><br><span class="line">        <span class="keyword">if</span>(nums.length==<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> target==nums[<span class="number">0</span>]? <span class="number">0</span> : -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> low=<span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> high=nums.length-<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span>(low!=high)&#123;</span><br><span class="line">            <span class="type">int</span> mid=(low+high)/<span class="number">2</span>;</span><br><span class="line">            <span class="keyword">if</span>(target&gt;nums[mid])&#123;</span><br><span class="line">                low=mid+<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(target==nums[mid])&#123;</span><br><span class="line">                <span class="keyword">return</span> mid;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(target&lt;nums[mid])&#123;</span><br><span class="line">                high=mid-<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>

<p>我当时觉得我简直就是天才，对数组长度为0的时候不会做判断，而数组只有一个元素的时候单独判断，返回执行时间还更快，但这又出了岔子</p>

        <h5 id="提交错误-2"   >
          <a href="#提交错误-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#提交错误-2" class="headerlink" title="提交错误"></a>提交错误</h5>
      <p>CASE:nums&#x3D;[2,5],target&#x3D;5,输出-1,预计输出1</p>

        <h5 id="原因-2"   >
          <a href="#原因-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#原因-2" class="headerlink" title="原因"></a>原因</h5>
      <p>不仅仅是nums[length-1]不能进行一个判断同时也是nums[0]没办法进行判断，也就是数组的边界都不能进行一个判断，问题出在了循环的时候当low&#x3D;&#x3D;high的时候就退出了循环 而边界的时候就没有判断到，所以我最后进行了改正</p>

        <h4 id="第四次代码"   >
          <a href="#第四次代码" class="heading-link"><i class="fas fa-link"></i></a><a href="#第四次代码" class="headerlink" title="第四次代码"></a>第四次代码</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">search</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> target)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//如果nums只有一个元素</span></span><br><span class="line">        <span class="keyword">if</span>(nums.length==<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> target==nums[<span class="number">0</span>]? <span class="number">0</span> : -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> low=<span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> high=nums.length-<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span>(low&lt;=high)&#123;</span><br><span class="line">            <span class="type">int</span> mid=(low+high)/<span class="number">2</span>;</span><br><span class="line">            <span class="keyword">if</span>(target&gt;nums[mid])&#123;</span><br><span class="line">                low=mid+<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(target==nums[mid])&#123;</span><br><span class="line">                <span class="keyword">return</span> mid;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(target&lt;nums[mid])&#123;</span><br><span class="line">                high=mid-<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="提交成功"   >
          <a href="#提交成功" class="heading-link"><i class="fas fa-link"></i></a><a href="#提交成功" class="headerlink" title="提交成功"></a>提交成功</h5>
      <p>但是实际上有没有对一个元素数组的判断都能通过测试，问题就出在While循环中的判断条件，当low等于high的时候也应该进行一次判断，也就是Low&gt;high的时候结束循环</p>

        <h3 id="总结"   >
          <a href="#总结" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结" class="headerlink" title="总结"></a>总结</h3>
      <p>看了视频学习之后才知道 <strong>二分法</strong>的两个重点，主要要取决于边界处理</p>
<p>主要有两个版本，1.是左闭右闭的区间</p>
<p>​							   2.是左闭右合的区间</p>
<p>为了防止搞混我主要学习的是左闭右闭的区间写法</p>

        <h4 id="while循环的条件判断"   >
          <a href="#while循环的条件判断" class="heading-link"><i class="fas fa-link"></i></a><a href="#while循环的条件判断" class="headerlink" title="while循环的条件判断"></a>while循环的条件判断</h4>
      <p>重点思想是low和high是不是一个合法的值在条件判断中，如果下标是1，上标是1，那么也应该做一个while循环判断</p>
<p>所以是while(low&lt;&#x3D;high)</p>

        <h4 id="low和high的赋值处理"   >
          <a href="#low和high的赋值处理" class="heading-link"><i class="fas fa-link"></i></a><a href="#low和high的赋值处理" class="headerlink" title="low和high的赋值处理"></a>low和high的赋值处理</h4>
      <p>上一次判断的时候nums[mid]&gt;target，所以明确的是mid这个索引值已经不等于我们的目标索引值</p>
<p>因此low&#x3D;mid+1，同理当nums[mid]&lt;target时high&#x3D;mid-1;</p>

        <h3 id="图解"   >
          <a href="#图解" class="heading-link"><i class="fas fa-link"></i></a><a href="#图解" class="headerlink" title="图解"></a>图解</h3>
      <p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230804122255989.png"  alt="二分法图解">
      </p>

        <h2 id="35-搜索插入位置"   >
          <a href="#35-搜索插入位置" class="heading-link"><i class="fas fa-link"></i></a><a href="#35-搜索插入位置" class="headerlink" title="35.搜索插入位置"></a>35.搜索插入位置</h2>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/search-insert-position/" >LeetCode.35题(easy)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="第一次做-1"   >
          <a href="#第一次做-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一次做-1" class="headerlink" title="第一次做"></a>第一次做</h3>
      <p>第一次做于23&#x2F;08&#x2F;04，因为刚学完二分查找，所以找相似的题目巩固</p>

        <h4 id="第一次代码-1"   >
          <a href="#第一次代码-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一次代码-1" class="headerlink" title="第一次代码"></a>第一次代码</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">searchInsert</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> target)</span> &#123;</span><br><span class="line">        <span class="comment">// 二分法</span></span><br><span class="line">        <span class="type">int</span> low=<span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> high=nums.length-<span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> mid=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(low&lt;=high)&#123;</span><br><span class="line">            mid=(low+high)/<span class="number">2</span>;</span><br><span class="line">            <span class="keyword">if</span>(nums[mid]&gt;target)&#123;</span><br><span class="line">                high=mid-<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(nums[mid]&lt;target)&#123;</span><br><span class="line">                low=mid+<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(nums[mid]==target)&#123;</span><br><span class="line">                <span class="keyword">return</span> mid;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mid;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="提交错误-3"   >
          <a href="#提交错误-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#提交错误-3" class="headerlink" title="提交错误"></a>提交错误</h5>
      <p>Case1：nums[1,3,5,6] ,target&#x3D;5, 输出2 ，预期输出 2</p>
<p>Case2：nums[1,3,5,6] ,target&#x3D;2, 输出0，预期输出 1</p>
<p>Case3：nums[1,3,5,6] ,target&#x3D;7, 输出3 ，预期输出 2</p>

        <h5 id="原因-3"   >
          <a href="#原因-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#原因-3" class="headerlink" title="原因"></a>原因</h5>
      <p>当元素中没有这个元素的时候，最后上标和下标会指向mid的位置，这个位置的索引值是有值的所以应该在当前索引+1就是要求到的索引值</p>

        <h4 id="第二次代码"   >
          <a href="#第二次代码" class="heading-link"><i class="fas fa-link"></i></a><a href="#第二次代码" class="headerlink" title="第二次代码"></a>第二次代码</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">searchInsert</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> target)</span> &#123;</span><br><span class="line">        <span class="comment">// 二分法</span></span><br><span class="line">        <span class="type">int</span> low=<span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> high=nums.length-<span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> mid=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(low&lt;=high)&#123;</span><br><span class="line">            mid=(low+high)/<span class="number">2</span>;</span><br><span class="line">            <span class="keyword">if</span>(nums[mid]&gt;target)&#123;</span><br><span class="line">                high=mid-<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(nums[mid]&lt;target)&#123;</span><br><span class="line">                low=mid+<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(nums[mid]==target)&#123;</span><br><span class="line">                <span class="keyword">return</span> mid;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mid+<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="提交错误-4"   >
          <a href="#提交错误-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#提交错误-4" class="headerlink" title="提交错误"></a>提交错误</h5>
      <p>Case1：nums[1,3,5,6] ,target&#x3D;0, 输出1 ，预期输出 0</p>

        <h5 id="原因-4"   >
          <a href="#原因-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#原因-4" class="headerlink" title="原因"></a>原因</h5>
      <p>第一次错的改正思路不对，没有找到元素之后要插入元素的时候，最后low和high不会指向同一个索引值，一定是low＞high</p>
<p>要判断low和high与mid的关系 如果low&gt;mid，说明要插入的值比nums[mid]的值还要大，要插入在mid后面，反之如果high&lt;mid，说明当前值比插入的值要大，要插入在mid前面</p>

        <h4 id="第三次代码-1"   >
          <a href="#第三次代码-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#第三次代码-1" class="headerlink" title="第三次代码"></a>第三次代码</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">searchInsert</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> target)</span> &#123;</span><br><span class="line">        <span class="comment">// 二分法</span></span><br><span class="line">        <span class="type">int</span> low=<span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> high=nums.length-<span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> mid=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(low&lt;=high)&#123;</span><br><span class="line">            mid=(low+high)/<span class="number">2</span>;</span><br><span class="line">            <span class="keyword">if</span>(nums[mid]&gt;target)&#123;</span><br><span class="line">                high=mid-<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(nums[mid]&lt;target)&#123;</span><br><span class="line">                low=mid+<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(nums[mid]==target)&#123;</span><br><span class="line">                <span class="keyword">return</span> mid;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(low&gt;mid)&#123;</span><br><span class="line">            <span class="keyword">return</span> mid+<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mid-<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="提交错误-5"   >
          <a href="#提交错误-5" class="heading-link"><i class="fas fa-link"></i></a><a href="#提交错误-5" class="headerlink" title="提交错误"></a>提交错误</h5>
      <p>CASE1:nums[1,3,5,6], target&#x3D;0,输出-1,预期输出0</p>

        <h5 id="原因-5"   >
          <a href="#原因-5" class="heading-link"><i class="fas fa-link"></i></a><a href="#原因-5" class="headerlink" title="原因"></a>原因</h5>
      <p>在插入在当前mid索引值时多减了一位，如果这个数比mid值更小的话应该就是当前位置，而当前位置及以后的值应该往后移动</p>

        <h4 id="第四次代码-1"   >
          <a href="#第四次代码-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#第四次代码-1" class="headerlink" title="第四次代码"></a>第四次代码</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">searchInsert</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> target)</span> &#123;</span><br><span class="line">        <span class="comment">// 二分法</span></span><br><span class="line">        <span class="type">int</span> low=<span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> high=nums.length-<span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> mid=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(low&lt;=high)&#123;</span><br><span class="line">            mid=(low+high)/<span class="number">2</span>;</span><br><span class="line">            <span class="keyword">if</span>(nums[mid]&gt;target)&#123;</span><br><span class="line">                high=mid-<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(nums[mid]&lt;target)&#123;</span><br><span class="line">                low=mid+<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(nums[mid]==target)&#123;</span><br><span class="line">                <span class="keyword">return</span> mid;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(low&gt;mid)&#123;</span><br><span class="line">            <span class="keyword">return</span> mid+<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mid;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="提交成功-1"   >
          <a href="#提交成功-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#提交成功-1" class="headerlink" title="提交成功"></a>提交成功</h5>
      
        <h3 id="总结-1"   >
          <a href="#总结-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3>
      <p>先<strong>二分查找</strong>判断是否当前数组有这个值，如果有的话直接返回mid就是索引小标值</p>
<p>如果当前数组中没有这个值，就要判断插入在当前位置的前面还是后面</p>
<p>当low&gt;mid时就说明最后跳出循环前还进行了一次nums[mid]&lt;target判断 也就是说明mid索引的元素比插入元素更小，所以要插入在mid的后面</p>
<p>反之如果没有low&gt;mid说明当前值比mid值更小那么久应该插入当前元素位置，让当前元素及以后元素往后移</p>

        <h3 id="图解-1"   >
          <a href="#图解-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#图解-1" class="headerlink" title="图解"></a>图解</h3>
      
        <h4 id="找得到元素"   >
          <a href="#找得到元素" class="heading-link"><i class="fas fa-link"></i></a><a href="#找得到元素" class="headerlink" title="找得到元素"></a>找得到元素</h4>
      <p>找得到元素就是普通的二分查找返回目标索引值，图解于704题图解所示</p>

        <h4 id="找不到元素，插入在前面"   >
          <a href="#找不到元素，插入在前面" class="heading-link"><i class="fas fa-link"></i></a><a href="#找不到元素，插入在前面" class="headerlink" title="找不到元素，插入在前面"></a>找不到元素，插入在前面</h4>
      <p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230804151101834.png"  alt="插入在前面">
      </p>

        <h4 id="找不到元素，插入在后面"   >
          <a href="#找不到元素，插入在后面" class="heading-link"><i class="fas fa-link"></i></a><a href="#找不到元素，插入在后面" class="headerlink" title="找不到元素，插入在后面"></a>找不到元素，插入在后面</h4>
      <p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230804150906559.png"  alt="插入在后面">
      </p>

        <h2 id="34-在排序数组中查找元素的第一个和最后一个位置"   >
          <a href="#34-在排序数组中查找元素的第一个和最后一个位置" class="heading-link"><i class="fas fa-link"></i></a><a href="#34-在排序数组中查找元素的第一个和最后一个位置" class="headerlink" title="34.在排序数组中查找元素的第一个和最后一个位置"></a>34.在排序数组中查找元素的第一个和最后一个位置</h2>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/find-first-and-last-position-of-element-in-sorted-array/" >LeetCode.34题(medium)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="第一次做-2"   >
          <a href="#第一次做-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一次做-2" class="headerlink" title="第一次做"></a>第一次做</h3>
      <p>于23&#x2F;08&#x2F;04</p>

        <h4 id="第一次代码-2"   >
          <a href="#第一次代码-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一次代码-2" class="headerlink" title="第一次代码"></a>第一次代码</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span>[] searchRange(<span class="type">int</span>[] nums, <span class="type">int</span> target) &#123;</span><br><span class="line">        <span class="comment">//二分法</span></span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> low=<span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> high=nums.length-<span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> mid=-<span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span>[] arr=&#123;mid,mid&#125;;</span><br><span class="line">        <span class="keyword">while</span>(low&lt;=high)&#123;</span><br><span class="line">            mid=(low+high)/<span class="number">2</span>;</span><br><span class="line">            <span class="keyword">if</span>(nums[mid]&gt;target)&#123;</span><br><span class="line">                high=mid-<span class="number">1</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(nums[mid]&lt;target)</span><br><span class="line">            &#123;</span><br><span class="line">                low=mid+<span class="number">1</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//找到元素</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//结束循环判断mid值</span></span><br><span class="line">        <span class="keyword">if</span>(mid!=-<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="comment">//则说明有元素</span></span><br><span class="line">           <span class="keyword">for</span>(<span class="type">int</span> i=mid;i&gt;=low;i--)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">if</span>(nums[i]==target)</span><br><span class="line">               &#123;</span><br><span class="line">                   low=i;</span><br><span class="line">               &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">for</span>(<span class="type">int</span> i=mid;i&lt;=high;i++)&#123;</span><br><span class="line">               <span class="keyword">if</span>(nums[i]==target)&#123;</span><br><span class="line">                   high=i;</span><br><span class="line">               &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           arr[<span class="number">0</span>]=low;</span><br><span class="line">           arr[<span class="number">1</span>]=high;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//没有找到元素</span></span><br><span class="line">        <span class="keyword">return</span> arr;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="提交错误-6"   >
          <a href="#提交错误-6" class="heading-link"><i class="fas fa-link"></i></a><a href="#提交错误-6" class="headerlink" title="提交错误"></a>提交错误</h5>
      <p>Case: nums[5,7,7,8,8,10],target&#x3D;8,输出[4，4]，预期输出[3,4]</p>

        <h5 id="原因-6"   >
          <a href="#原因-6" class="heading-link"><i class="fas fa-link"></i></a><a href="#原因-6" class="headerlink" title="原因"></a>原因</h5>
      <p>在结束循环判断的时候我将I设为Mid值，如果找到了元素那么nums[mid]&#x3D;&#x3D;target，那一定会执行将low和high的值改成mid，但是这是没有意义的，我的意图是找出mid前后两边和target相同的个数，因此我做了改正 将low判断的初始化值为mid-1即mid的前一位，high的判断index改为mid+1即mid的后一位</p>

        <h4 id="第二次代码-1"   >
          <a href="#第二次代码-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#第二次代码-1" class="headerlink" title="第二次代码"></a>第二次代码</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span>[] searchRange(<span class="type">int</span>[] nums, <span class="type">int</span> target) &#123;</span><br><span class="line">       <span class="comment">//二分法</span></span><br><span class="line"></span><br><span class="line">       <span class="type">int</span> low=<span class="number">0</span>;</span><br><span class="line">       <span class="type">int</span> high=nums.length-<span class="number">1</span>;</span><br><span class="line">       <span class="type">int</span> mid=-<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">       <span class="type">int</span>[] arr=&#123;mid,mid&#125;;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">while</span>(low&lt;=high)&#123;</span><br><span class="line">           mid=(low+high)/<span class="number">2</span>;</span><br><span class="line">           <span class="keyword">if</span>(nums[mid]&gt;target)&#123;</span><br><span class="line">               high=mid-<span class="number">1</span>;</span><br><span class="line">           &#125;<span class="keyword">else</span> <span class="keyword">if</span>(nums[mid]&lt;target)</span><br><span class="line">           &#123;</span><br><span class="line">               low=mid+<span class="number">1</span>;</span><br><span class="line">           &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">               <span class="comment">//找到元素</span></span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="type">int</span> lowCount=<span class="number">0</span>; <span class="comment">//记录mid索引前面和target相同的个数</span></span><br><span class="line">       <span class="type">int</span> highCount=<span class="number">0</span>;<span class="comment">//记录mid索引后面和target相同的个数</span></span><br><span class="line">       <span class="comment">//结束循环判断mid值</span></span><br><span class="line">       <span class="keyword">if</span>(mid!=-<span class="number">1</span>)&#123;</span><br><span class="line">           <span class="comment">//则说明有元素</span></span><br><span class="line">           <span class="keyword">for</span>(<span class="type">int</span> i=mid-<span class="number">1</span>;i&gt;=low;i--)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">if</span>(nums[i]==target)</span><br><span class="line">               &#123;</span><br><span class="line">                   lowCount++;</span><br><span class="line">               &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">for</span>(<span class="type">int</span> i=mid+<span class="number">1</span>;i&lt;=high;i++)&#123;</span><br><span class="line">               <span class="keyword">if</span>(nums[i]==target)&#123;</span><br><span class="line">                   highCount++;</span><br><span class="line">               &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           arr[<span class="number">0</span>]=mid-lowCount;</span><br><span class="line">           arr[<span class="number">1</span>]=mid+highCount;</span><br><span class="line"></span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//没有找到元素</span></span><br><span class="line">       <span class="keyword">return</span> arr;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h5 id="提交错误-7"   >
          <a href="#提交错误-7" class="heading-link"><i class="fas fa-link"></i></a><a href="#提交错误-7" class="headerlink" title="提交错误"></a>提交错误</h5>
      <p>Case: nums[5,7,7,8,8,10],target&#x3D;6,输出[0，0]，预期输出[-1,-1]</p>

        <h5 id="原因-7"   >
          <a href="#原因-7" class="heading-link"><i class="fas fa-link"></i></a><a href="#原因-7" class="headerlink" title="原因"></a>原因</h5>
      <p>本次代码引入了计数器思想，就是在mid值前面的相同数量我计一个数，mid值后面相同的数量我也计一个数，最后给arr赋值的时候就只要加减Count就能代表有多少数据了</p>
<p>而问题又出现了，不存在的数据返回了[0,0]</p>
<p>通过Debug判断我才发现我有一个很严重的误区，就是无论有没有找到元素mid值一定不会等于-1，因为进入了第一个while循环判断中，如果没有找到值应该是一个mid值也会存在，所以第二个判断的起始条件有误导致后面赋值的时候mid值的错误导致整个问题出错</p>

        <h4 id="第三次代码-2"   >
          <a href="#第三次代码-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#第三次代码-2" class="headerlink" title="第三次代码"></a>第三次代码</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span>[] searchRange(<span class="type">int</span>[] nums, <span class="type">int</span> target) &#123;</span><br><span class="line">        <span class="comment">//二分法</span></span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> low=<span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> high=nums.length-<span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> mid=-<span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> midCount=<span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span>[] arr=&#123;mid,mid&#125;;</span><br><span class="line">        <span class="keyword">while</span>(low&lt;=high)&#123;</span><br><span class="line">            mid=(low+high)/<span class="number">2</span>;</span><br><span class="line">            <span class="keyword">if</span>(nums[mid]&gt;target)&#123;</span><br><span class="line">                high=mid-<span class="number">1</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(nums[mid]&lt;target)</span><br><span class="line">            &#123;</span><br><span class="line">                low=mid+<span class="number">1</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                midCount++;</span><br><span class="line">                <span class="comment">//找到元素</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">int</span> lowCount=<span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> highCount=<span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//结束循环判断mid值</span></span><br><span class="line">        <span class="keyword">if</span>(midCount!=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="comment">//则说明有元素</span></span><br><span class="line">           <span class="keyword">for</span>(<span class="type">int</span> i=mid-<span class="number">1</span>;i&gt;=low;i--)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">if</span>(nums[i]==target)</span><br><span class="line">               &#123;</span><br><span class="line">                   lowCount++;</span><br><span class="line">               &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">for</span>(<span class="type">int</span> i=mid+<span class="number">1</span>;i&lt;=high;i++)&#123;</span><br><span class="line">               <span class="keyword">if</span>(nums[i]==target)&#123;</span><br><span class="line">                   highCount++;</span><br><span class="line">               &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           </span><br><span class="line">        arr[<span class="number">0</span>]=mid-lowCount;</span><br><span class="line">        arr[<span class="number">1</span>]=mid+highCount;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//没有找到元素</span></span><br><span class="line">        <span class="keyword">return</span> arr;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="提交成功-2"   >
          <a href="#提交成功-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#提交成功-2" class="headerlink" title="提交成功"></a>提交成功</h5>
      <p>我引入了一个MidCount计数器，如果找到元素时候MidCount++，这样判断找到元素的判断条件就能确定下来</p>

        <h3 id="总结和解题思路"   >
          <a href="#总结和解题思路" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结和解题思路" class="headerlink" title="总结和解题思路"></a>总结和解题思路</h3>
      <p>①定义MidCount&#x3D;0 用来记录是否找到元素，初始化一个数组arr[-1,-1]</p>
<p>②通过二分查找的方式，如果找到元素将MidCount++则跳出循环，同时low和high就是可以确认的目标值边界 也就是nums[low]和nums[high]之间能找到target目标值，mid索引位置也就是二分查找找到的目标值索引位置</p>
<p>③判断MidCount&#x3D;&#x3D;0  如果等于0说明二分查找没有找到元素直接返回数组arr ，如果不等于0则说明二分查找找到了元素</p>
<p>④MidCount1&#x3D;0，即找到了元素，定义两个计数器LowCount和HighCount用来记录Mid索引前后分别相同的元素个数</p>
<p>⑤从mid索引开始向前遍历，如果遍历没有找到相同元素则跳出遍历，如果找到了元素则LowCount++继续遍历</p>
<p>⑥从mid索引开始向后遍历，如果遍历没有找到相同元素则跳出遍历，如果找到了元素则HighCount++继续遍历</p>
<p>⑦mid-LowCount表示第一个target出现的索引值 赋值给arr[0]</p>
<p>⑧mid+highCount表示最后一个target出现的索引值 赋值给arr[1]</p>
<p>⑨返回arr</p>

        <h2 id="69-x的平方根"   >
          <a href="#69-x的平方根" class="heading-link"><i class="fas fa-link"></i></a><a href="#69-x的平方根" class="headerlink" title="69.x的平方根"></a>69.x的平方根</h2>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/sqrtx/" >LeetCode.69题(easy)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="第一次做-3"   >
          <a href="#第一次做-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一次做-3" class="headerlink" title="第一次做"></a>第一次做</h3>
      <p>第一次做于23&#x2F;08&#x2F;05</p>

        <h4 id="第一次代码-3"   >
          <a href="#第一次代码-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一次代码-3" class="headerlink" title="第一次代码"></a>第一次代码</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">mySqrt</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">       <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i*i&lt;=x;i++)&#123;</span><br><span class="line">           <span class="keyword">return</span> i;</span><br><span class="line">       &#125;      </span><br><span class="line">       <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="提交错误-8"   >
          <a href="#提交错误-8" class="heading-link"><i class="fas fa-link"></i></a><a href="#提交错误-8" class="headerlink" title="提交错误"></a>提交错误</h5>
      <p>CASE:输入x&#x3D;4，输出0，预期2</p>

        <h5 id="原因-8"   >
          <a href="#原因-8" class="heading-link"><i class="fas fa-link"></i></a><a href="#原因-8" class="headerlink" title="原因"></a>原因</h5>
      <p>可能思路有点搞，一进来循环就返回i了，我的想法是找到i的平方大于x的时候就直接返回i,我觉得这下就是直接的整数</p>
<p>然而我改成int i放在循环外面 循环做一个空语句然后 返回i 依然是出错了， 当输入X为8的时候，输出3，预期2</p>
<p>我就大概知道我的思路出现问题了</p>

        <h4 id="第二次代码-2"   >
          <a href="#第二次代码-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#第二次代码-2" class="headerlink" title="第二次代码"></a>第二次代码</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">mySqrt</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">        <span class="type">int</span> i=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i*i&lt;x;i++)&#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//出循环了判断一下i²和x的大小</span></span><br><span class="line">        <span class="keyword">if</span>(i*i&gt;x)&#123;</span><br><span class="line">            <span class="comment">//说明数在 i-1的²和i的²之间</span></span><br><span class="line">            <span class="keyword">return</span> i-<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> i;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="提交错误-9"   >
          <a href="#提交错误-9" class="heading-link"><i class="fas fa-link"></i></a><a href="#提交错误-9" class="headerlink" title="提交错误"></a>提交错误</h5>
      <p>最后输入的值是2147483647，超出时间限度</p>

        <h5 id="原因-9"   >
          <a href="#原因-9" class="heading-link"><i class="fas fa-link"></i></a><a href="#原因-9" class="headerlink" title="原因"></a>原因</h5>
      <p>说明时间复杂度高了，具体应该是for循环的时候判断太多次了？又或者是死循环了，重新审一下题 x最大为2的32次方-1 那么判断循环跳出的时候i*i的数值已经超过了整数上限</p>

        <h4 id="第三次代码-3"   >
          <a href="#第三次代码-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#第三次代码-3" class="headerlink" title="第三次代码"></a>第三次代码</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">mySqrt</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">       <span class="type">int</span> i=<span class="number">0</span>;</span><br><span class="line">       <span class="keyword">for</span>(i=<span class="number">0</span>;;i++)&#123;</span><br><span class="line">           <span class="keyword">if</span>((i*i&gt;Integer.MAX_VALUE?Integer.MAX_VALUE : i * i)&gt; x)&#123;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;      </span><br><span class="line">       <span class="comment">//出循环了判断一下i²和x的大小</span></span><br><span class="line">       <span class="keyword">if</span>(i*i&gt;x)&#123;</span><br><span class="line">           <span class="comment">//说明数在 i-1的²和i的²之间</span></span><br><span class="line">           <span class="keyword">return</span> i-<span class="number">1</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> i;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="提交错误-10"   >
          <a href="#提交错误-10" class="heading-link"><i class="fas fa-link"></i></a><a href="#提交错误-10" class="headerlink" title="提交错误"></a>提交错误</h5>
      <p>输入2147395600，输出289398，预期输出46340</p>

        <h5 id="原因-10"   >
          <a href="#原因-10" class="heading-link"><i class="fas fa-link"></i></a><a href="#原因-10" class="headerlink" title="原因"></a>原因</h5>
      <p>46340的平方为2147395600,46341的平方为2147488281，而2的32次方-1为2147483647 即 46340²&lt;2147483647&lt;46341²</p>
<p>也就是这个求平方根最大能输出的值就应该在46340</p>
<p>我在上面改正的代码的时候做了一个判断 当i×i的数值大于整数的上限的时候设置为整数上限 反之为i×i,应该就是这个地方出了问题</p>
<p>经过debug的时候就知道了 当相等的时候没有进行跳出循环 因为这算是找到了数据但是我依然让他进行了下一次判断 下一次判断的时候会因为超出上限造成数据错误  </p>

        <h4 id="第四次代码-2"   >
          <a href="#第四次代码-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#第四次代码-2" class="headerlink" title="第四次代码"></a>第四次代码</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">mySqrt</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">       <span class="type">int</span> i=<span class="number">0</span>;</span><br><span class="line">       <span class="keyword">for</span>(i=<span class="number">0</span>;;i++)&#123;</span><br><span class="line">           <span class="keyword">if</span>(i==<span class="number">46340</span>)&#123;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span>((i*i&gt;Integer.MAX_VALUE?Integer.MAX_VALUE : i * i)&gt;=x)&#123;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;      </span><br><span class="line">       <span class="comment">//出循环了判断一下i²和x的大小</span></span><br><span class="line">       <span class="keyword">if</span>(i*i&gt;x)&#123;</span><br><span class="line">           <span class="comment">//说明数在 i-1的²和i的²之间</span></span><br><span class="line">           <span class="keyword">return</span> i-<span class="number">1</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> i;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="提交成功-3"   >
          <a href="#提交成功-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#提交成功-3" class="headerlink" title="提交成功"></a>提交成功</h5>
      <p>我直接做了一个边界处理 就是因为最大的值就是46340，所以我直接当i为46340的时候返回，但是这样代码不太优雅，因为我是因为知道错误改正之后得出一个结论就是最大的就是46340，而这个数据不应该是这样做一个特殊处理的，这道题将会看网上的题解做出自己的总结</p>

        <h3 id="题解"   >
          <a href="#题解" class="heading-link"><i class="fas fa-link"></i></a><a href="#题解" class="headerlink" title="题解"></a>题解</h3>
      <p>这个题可以用到二分查找法，因为本质上就是求一个值一共有三种条件</p>
<ul>
<li>求的值的平方恰好等于所给值，就<strong>正好找到这个算术平方根</strong></li>
<li>求的值的平方大于所给值，就说明这个值<strong>一定不是要求到的算术平方根</strong></li>
<li>求的值的平方小于所给值，说明这个值<strong>可能是要求的算术平方根</strong></li>
</ul>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">mySqrt</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> low=<span class="number">0</span>;</span><br><span class="line">	<span class="type">int</span> <span class="variable">high</span> <span class="operator">=</span>x/<span class="number">2</span>;   </span><br><span class="line">	<span class="comment">//因为除了0和1之后的所有数的一半都是小于或者等于算术平方根 也即[0,X/2]这个区间中一定有一个算数平方根是要求到的 </span></span><br><span class="line">	</span><br><span class="line">    <span class="comment">//这里过滤掉0和1的特殊情况</span></span><br><span class="line">    <span class="keyword">if</span>(x==<span class="number">0</span> || x==<span class="number">1</span> )&#123;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span>(low&lt;=high)&#123;</span><br><span class="line">        <span class="type">int</span> mid=(high+low)/<span class="number">2</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(mid==<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(mid&gt;x/mid)&#123;</span><br><span class="line">            high=mid-<span class="number">1</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(mid== x/mid)&#123;</span><br><span class="line">            <span class="keyword">return</span> mid;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//mid &lt; x/mid;</span></span><br><span class="line">            low=mid+<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> high;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h3 id="总结-2"   >
          <a href="#总结-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结-2" class="headerlink" title="总结"></a>总结</h3>
      <p>①因为除了0和1之后的所有数的一半都是小于或者等于算术平方根 也即[0,X&#x2F;2]这个区间中一定有一个算数平方根是要求到的</p>
<p>②比较的时候采用 mid (&gt; | &#x3D;&#x3D; | &lt; )x &#x2F;mid的方式来替换掉mid × mid  (&gt; | &#x3D;&#x3D; | &lt; ) x  ，避免因为乘法导致的溢出问题</p>
<p>③因为采用了<strong>除法进行比较</strong>，所以 引入了一个判断IF(mid&#x3D;&#x3D;0) break; 来规避除数不能为0的问题</p>

        <h2 id="367-有效的完全平方数"   >
          <a href="#367-有效的完全平方数" class="heading-link"><i class="fas fa-link"></i></a><a href="#367-有效的完全平方数" class="headerlink" title="367.有效的完全平方数"></a>367.有效的完全平方数</h2>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/valid-perfect-square/" >LeetCode.367(easy)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="第一次做-4"   >
          <a href="#第一次做-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一次做-4" class="headerlink" title="第一次做"></a>第一次做</h3>
      <p>于23&#x2F;08&#x2F;05</p>

        <h4 id="第一次代码-4"   >
          <a href="#第一次代码-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一次代码-4" class="headerlink" title="第一次代码"></a>第一次代码</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isPerfectSquare</span><span class="params">(<span class="type">int</span> num)</span> &#123;</span><br><span class="line">       <span class="keyword">if</span>(num==<span class="number">1</span>)&#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="type">int</span> low=<span class="number">0</span>;</span><br><span class="line">       <span class="type">int</span> high=num/<span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">while</span>(low&lt;=high)&#123;</span><br><span class="line">           <span class="type">int</span> mid=(low+high)/<span class="number">2</span>;</span><br><span class="line">           <span class="keyword">if</span>(mid==<span class="number">0</span>)&#123;</span><br><span class="line">               <span class="comment">//也即low=0 , high =1  ==&gt; num=2 那么没有完全平方数直接返回false</span></span><br><span class="line">               <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span>(mid&gt;num/mid)&#123;</span><br><span class="line">               high=mid-<span class="number">1</span>;</span><br><span class="line">           &#125;<span class="keyword">else</span> <span class="keyword">if</span>(mid&lt; num/mid)&#123;</span><br><span class="line">               low=mid+<span class="number">1</span>;</span><br><span class="line">           &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">               <span class="comment">//mid == num/mid</span></span><br><span class="line">               <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="提交错误-11"   >
          <a href="#提交错误-11" class="heading-link"><i class="fas fa-link"></i></a><a href="#提交错误-11" class="headerlink" title="提交错误"></a>提交错误</h5>
      <p>CASE:输入5 输出true ,预期输出false;</p>

        <h5 id="原因-11"   >
          <a href="#原因-11" class="heading-link"><i class="fas fa-link"></i></a><a href="#原因-11" class="headerlink" title="原因"></a>原因</h5>
      <p>做这道题的时候因为受到69题的影响 所以判断语句中用的除法，但是好像这道题是不适用的，因为num&#x2F;mid的时候是因为上面一道题求得是整数的平方根，那么在范围中间的数据做除法会进行一个末尾抛弃，对最后的结果并不造成影响而这道题的num是实实切切要进行判断的</p>

        <h5 id="分析场景"   >
          <a href="#分析场景" class="heading-link"><i class="fas fa-link"></i></a><a href="#分析场景" class="headerlink" title="分析场景"></a>分析场景</h5>
      <p>当所求值的平方相等于目标值，那么说明找到了一个数据i，我们只要分析i-1,i,i+1这三个数的平方和x的关系即可</p>
<p>如果有一个是相等的那么说明，是有效的</p>

        <h4 id="第二次代码-3"   >
          <a href="#第二次代码-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#第二次代码-3" class="headerlink" title="第二次代码"></a>第二次代码</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isPerfectSquare</span><span class="params">(<span class="type">int</span> num)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(num==<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> low=<span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> high=num/<span class="number">2</span>;</span><br><span class="line">        <span class="type">long</span> index=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(low&lt;=high)&#123;</span><br><span class="line">            <span class="type">int</span> mid=(low+high)/<span class="number">2</span>;</span><br><span class="line">            <span class="keyword">if</span>(mid==<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="comment">//也即low=0 , high =1  ==&gt; num=2 那么没有完全平方数直接返回false</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(mid&gt;num/mid)&#123;</span><br><span class="line">                high=mid-<span class="number">1</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(mid&lt; num/mid)&#123;</span><br><span class="line">                low=mid+<span class="number">1</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//mid == num/mid</span></span><br><span class="line">                index=(<span class="type">long</span>)mid;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(index*index==num|(index+<span class="number">1</span>)*(index+<span class="number">1</span>)==num|(index-<span class="number">1</span>*index-<span class="number">1</span>)==num)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="提交成功-4"   >
          <a href="#提交成功-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#提交成功-4" class="headerlink" title="提交成功"></a>提交成功</h5>
      <p>这次我引入了一个变量index，用于记录找到mid&#x3D;&#x3D;num&#x2F;mid的时候的mid值</p>

        <h3 id="总结-3"   >
          <a href="#总结-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结-3" class="headerlink" title="总结"></a>总结</h3>
      <p>其实我是做完了这道题然后去看别人的题解，因为这道题没有说不能用内置库，所以他们做的时候有的用了Sqrt函数。</p>
<p>总之我先总结我自己这道题的思路</p>
<p>①将num&#x3D;&#x3D;1的特殊情况直接返回true，这也是沿用69题的思路，因为除了0和1之外其他的数的平方根都小于等于自己的一半</p>
<p>②利用<strong>二分查找</strong> 当mid&#x3D;&#x3D;num&#x2F;mid的时候跳出循环 并用index记录这个mid值</p>
<p>此时跳出循环可能是 1.mid的平方恰好等于num 那么直接返回true即可</p>
<p>​									2.mid的平方小于num，因为num&#x2F;mid是整除，所以可能num的平方根是小数，所以要判断mid+1和mid-1的平方和num的关系</p>
<p>③我引入了一个Long变量来记录index的平方，为了避免乘法的溢出，同时在跳出的时候将mid值进行强转</p>
<p>④最后判断一下mid-1,mid,mid+1的平方与num的关系，如果有一个相等则返回true，所以我这里用了逻辑或，只要有一个条件成立即可不用判断完</p>

        <h1 id="移除元素"   >
          <a href="#移除元素" class="heading-link"><i class="fas fa-link"></i></a><a href="#移除元素" class="headerlink" title="移除元素"></a>移除元素</h1>
      <p>给你一个数组 nums 和一个值 val，你需要 原地 移除所有数值等于 val 的元素，并返回移除后数组的新长度。</p>
<p>不要使用额外的数组空间，你必须仅使用 O(1) 额外空间并<strong>原地</strong>修改输入数组。</p>
<p>元素的顺序可以改变。你不需要考虑数组中超出新长度后面的元素。</p>
<p>示例 1: 给定 nums &#x3D; [3,2,2,3], val &#x3D; 3, 函数应该返回新的长度 2, 并且 nums 中的前两个元素均为 2。 你不需要考虑数组中超出新长度后面的元素。</p>
<p>示例 2: 给定 nums &#x3D; [0,1,2,2,3,0,4,2], val &#x3D; 2, 函数应该返回新的长度 5, 并且 nums 中的前五个元素为 0, 1, 3, 0, 4。</p>

        <h2 id="27-移除元素"   >
          <a href="#27-移除元素" class="heading-link"><i class="fas fa-link"></i></a><a href="#27-移除元素" class="headerlink" title="27.移除元素"></a>27.移除元素</h2>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/remove-element/" >Leetcode.27移除元素(easy)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="第一次做-5"   >
          <a href="#第一次做-5" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一次做-5" class="headerlink" title="第一次做"></a>第一次做</h3>
      <p>第一次做于23&#x2F;08&#x2F;05</p>

        <h4 id="第一次代码-5"   >
          <a href="#第一次代码-5" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一次代码-5" class="headerlink" title="第一次代码"></a>第一次代码</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">removeElement</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> val)</span> &#123;</span><br><span class="line">        <span class="type">int</span> count=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;nums.length-<span class="number">1</span>;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(nums[i]==val)&#123;</span><br><span class="line">                <span class="comment">//当前位置的元素和数组前面的元素做一个交换</span></span><br><span class="line">                <span class="type">int</span> temp=nums[count];</span><br><span class="line">                nums[count]=val;</span><br><span class="line">                nums[i]=count;</span><br><span class="line">                count++;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//这样循环结束前count元素都是要丢掉的元素</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;count;i++)&#123;</span><br><span class="line">            <span class="type">int</span> temp=nums[i];</span><br><span class="line">            nums[i]=nums[nums.length-<span class="number">1</span>-i];</span><br><span class="line">            nums[nums.length-i-<span class="number">1</span>]=temp;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> nums.length-count;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="提交失败"   >
          <a href="#提交失败" class="heading-link"><i class="fas fa-link"></i></a><a href="#提交失败" class="headerlink" title="提交失败"></a>提交失败</h5>
      <p>CASE：输入nums[3，2，2，3]，val&#x3D;3 输出[3,2,2]，预期输出[2,2]</p>

        <h5 id="原因-12"   >
          <a href="#原因-12" class="heading-link"><i class="fas fa-link"></i></a><a href="#原因-12" class="headerlink" title="原因"></a>原因</h5>
      <p>1.通过debug的时候发现给nums[i]赋值的时候用的是count，而不是用temp交换</p>
<p>2.在第一个for循环的时候判断条件 i&lt;nums.length-1这样没有遍历到最后一个元素   </p>
<p><strong>这两个问题纯纯的低级错误中的低级错误</strong></p>

        <h4 id="第二次代码-4"   >
          <a href="#第二次代码-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#第二次代码-4" class="headerlink" title="第二次代码"></a>第二次代码</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">removeElement</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> val)</span> &#123;</span><br><span class="line">        <span class="type">int</span> count=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;nums.length;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(nums[i]==val)&#123;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//当前位置的元素和数组前面的元素做一个交换</span></span><br><span class="line">                <span class="type">int</span> temp=nums[count];</span><br><span class="line">                nums[count]=val;</span><br><span class="line">                nums[i]=temp;</span><br><span class="line">                count++;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//这样循环结束前count元素都是要丢掉的元素</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;count;i++)&#123;</span><br><span class="line">            <span class="type">int</span> temp=nums[i];</span><br><span class="line">            nums[i]=nums[nums.length-<span class="number">1</span>-i];</span><br><span class="line">            nums[nums.length-i-<span class="number">1</span>]=temp;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> nums.length-count;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="总结及思想"   >
          <a href="#总结及思想" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结及思想" class="headerlink" title="总结及思想"></a>总结及思想</h3>
      <p>通过学习代码随想录的视频，这个题可以由一种双指针的方法来实现删除元素的操作</p>
<p><strong>首先</strong></p>
<p>我们要明白数组的性质，数组是一串地址连续的元素序列，所以要删除元素只能是后面的元素对前面元素的覆盖，本质上数组还是相同的大小</p>

        <h4 id="双指针"   >
          <a href="#双指针" class="heading-link"><i class="fas fa-link"></i></a><a href="#双指针" class="headerlink" title="双指针"></a>双指针</h4>
      <p>①定义一个Fast索引指针用来遍历老数组，定义一个Slow索引指针用来指向新数组</p>
<p>②For循环判断条件是Fast&lt;arr.length</p>
<p>③当指向一个元素的时候判断这个元素是不是我们要删除的，如果不是则将arr[slow]&#x3D;arr[fast]并将slow和fast指针++指向下一个元素 </p>
<p>也即新数组的元素确定</p>
<p>④如果是我们要删除的元素则将Fast指针指向下一个元素，而Slow指针不动表示这个位置元素需要被覆盖</p>
<p>⑤循环结束返回slow,sloiw的大小也是新数组的大小</p>

        <h4 id="双指针代码实现"   >
          <a href="#双指针代码实现" class="heading-link"><i class="fas fa-link"></i></a><a href="#双指针代码实现" class="headerlink" title="双指针代码实现"></a>双指针代码实现</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">removeElement</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> val)</span> &#123;</span><br><span class="line">        <span class="type">int</span> slow=<span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> fast=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(;fast&lt;nums.length;fast++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(nums[fast]!=val)&#123;</span><br><span class="line">                <span class="comment">//是新数组需要的元素</span></span><br><span class="line">                nums[slow]=nums[fast];</span><br><span class="line">                slow++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> slow;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h4 id="交换元素"   >
          <a href="#交换元素" class="heading-link"><i class="fas fa-link"></i></a><a href="#交换元素" class="headerlink" title="交换元素"></a>交换元素</h4>
      <p>也就是我第一次做这道题的时候的思想</p>
<p>①先定义一个指针count，指向数组索引为0的位置</p>
<p>②for循环遍历，当找到我们不要的元素，将其放到数组前面</p>
<p>③这样第一次遍历结束 前面的元素都是我们不要的元素，并且我们得到了一个不要元素的数量计数器Count</p>
<p>④第二次循环的时候，将前count个元素和数组的后count个元素进行交换</p>
<p>⑤返回arr.length-count  也就是返回数组前面的元素，不要最后count个元素</p>
<p><strong>弊端</strong></p>
<p>这样是进行了两次for循环判断，这时间复杂度相较于双指针的方法实现更大</p>

        <h4 id="交换指针代码实现"   >
          <a href="#交换指针代码实现" class="heading-link"><i class="fas fa-link"></i></a><a href="#交换指针代码实现" class="headerlink" title="交换指针代码实现"></a>交换指针代码实现</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">removeElement</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> val)</span> &#123;</span><br><span class="line">        <span class="type">int</span> count=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;nums.length;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(nums[i]==val)&#123;</span><br><span class="line">                <span class="comment">//当前位置的元素和数组前面的元素做一个交换</span></span><br><span class="line">                <span class="type">int</span> temp=nums[count];</span><br><span class="line">                nums[count]=val;</span><br><span class="line">                nums[i]=temp;</span><br><span class="line">                count++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//这样循环结束前count元素都是要丢掉的元素</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;count;i++)&#123;</span><br><span class="line">            <span class="type">int</span> temp=nums[i];</span><br><span class="line">            nums[i]=nums[nums.length-<span class="number">1</span>-i];</span><br><span class="line">            nums[nums.length-i-<span class="number">1</span>]=temp;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> nums.length-count;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="图解-2"   >
          <a href="#图解-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#图解-2" class="headerlink" title="图解"></a>图解</h3>
      
        <h4 id="双指针图解"   >
          <a href="#双指针图解" class="heading-link"><i class="fas fa-link"></i></a><a href="#双指针图解" class="headerlink" title="双指针图解"></a>双指针图解</h4>
      <p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230805093305176.png"  alt="双指针图解【1】">
      </p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230805094005008.png"  alt="双指针图解【2】">
      </p>

        <h4 id="交换元素图解"   >
          <a href="#交换元素图解" class="heading-link"><i class="fas fa-link"></i></a><a href="#交换元素图解" class="headerlink" title="交换元素图解"></a>交换元素图解</h4>
      <p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230805094505082.png"  alt="交换元素图解">
      </p>

        <h2 id="26-删除排序数组中的重复项"   >
          <a href="#26-删除排序数组中的重复项" class="heading-link"><i class="fas fa-link"></i></a><a href="#26-删除排序数组中的重复项" class="headerlink" title="26.删除排序数组中的重复项"></a>26.删除排序数组中的重复项</h2>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/remove-duplicates-from-sorted-array/" >Leetcode.26题(easy)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="第一次做-6"   >
          <a href="#第一次做-6" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一次做-6" class="headerlink" title="第一次做"></a>第一次做</h3>
      <p>第一次做于23&#x2F;08&#x2F;06</p>

        <h4 id="第一次代码-6"   >
          <a href="#第一次代码-6" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一次代码-6" class="headerlink" title="第一次代码"></a>第一次代码</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">removeDuplicates</span><span class="params">(<span class="type">int</span>[] nums)</span> &#123;</span><br><span class="line">        <span class="type">int</span> slow=<span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> fast=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(;fast&lt;nums.length;fast++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(fast==nums.length-<span class="number">1</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(nums[fast-<span class="number">1</span>]!=nums[fast])&#123;</span><br><span class="line">                    nums[slow]=nums[fast];</span><br><span class="line">                    slow++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(nums[fast]!=nums[fast+<span class="number">1</span>])&#123;</span><br><span class="line">                nums[slow]=nums[fast];</span><br><span class="line">                slow++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> slow;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="提交错误-12"   >
          <a href="#提交错误-12" class="heading-link"><i class="fas fa-link"></i></a><a href="#提交错误-12" class="headerlink" title="提交错误"></a>提交错误</h5>
      <p>CASE:数组索引越界异常 Index -1 out of bounds for length 1 发生在nums[fast-1]！&#x3D;nums[fast]中</p>

        <h5 id="原因-13"   >
          <a href="#原因-13" class="heading-link"><i class="fas fa-link"></i></a><a href="#原因-13" class="headerlink" title="原因"></a>原因</h5>
      <p>没有判断异常情况，当nums.length&#x3D;&#x3D;1的时候直接返回1就行了</p>

        <h4 id="第二次代码-5"   >
          <a href="#第二次代码-5" class="heading-link"><i class="fas fa-link"></i></a><a href="#第二次代码-5" class="headerlink" title="第二次代码"></a>第二次代码</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">removeDuplicates</span><span class="params">(<span class="type">int</span>[] nums)</span> &#123;</span><br><span class="line">        <span class="type">int</span> slow=<span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> fast=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(nums.length==<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(;fast&lt;nums.length;fast++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(fast==nums.length-<span class="number">1</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(nums[fast-<span class="number">1</span>]!=nums[fast])&#123;</span><br><span class="line">                    nums[slow]=nums[fast];</span><br><span class="line">                    slow++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(nums[fast]!=nums[fast+<span class="number">1</span>])&#123;</span><br><span class="line">                nums[slow]=nums[fast];</span><br><span class="line">                slow++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> slow;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="提交错误-13"   >
          <a href="#提交错误-13" class="heading-link"><i class="fas fa-link"></i></a><a href="#提交错误-13" class="headerlink" title="提交错误"></a>提交错误</h5>
      <p>CASE:输入[1,1] 输出[], 预期结果[1]</p>

        <h5 id="原因-14"   >
          <a href="#原因-14" class="heading-link"><i class="fas fa-link"></i></a><a href="#原因-14" class="headerlink" title="原因"></a>原因</h5>
      <p>出在fast&#x3D;&#x3D;nums.length-1的时候 我将最后一个元素和倒数第二个元素进行了对比，如果不相同的话才更新到新数组中，然而我等于是比了两次因为第一次的时候是倒数第二的元素和倒数第一的元素比较，如果相同的话倒数第二个元素不会进入到新数组中，而第二次比较导致最后一个元素也进不到新数组中</p>

        <h4 id="第三次代码-4"   >
          <a href="#第三次代码-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#第三次代码-4" class="headerlink" title="第三次代码"></a>第三次代码</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">removeDuplicates</span><span class="params">(<span class="type">int</span>[] nums)</span> &#123;</span><br><span class="line">        <span class="type">int</span> slow=<span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> fast=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(nums.length==<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(;fast&lt;nums.length;fast++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(fast==nums.length-<span class="number">1</span>)&#123;</span><br><span class="line">                    nums[slow]=nums[fast];</span><br><span class="line">                    slow++;    </span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(nums[fast]!=nums[fast+<span class="number">1</span>])&#123;</span><br><span class="line">                nums[slow]=nums[fast];</span><br><span class="line">                slow++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> slow;</span><br></pre></td></tr></table></div></figure>


        <h5 id="提交成功-5"   >
          <a href="#提交成功-5" class="heading-link"><i class="fas fa-link"></i></a><a href="#提交成功-5" class="headerlink" title="提交成功"></a>提交成功</h5>
      
        <h3 id="总结-4"   >
          <a href="#总结-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结-4" class="headerlink" title="总结"></a>总结</h3>
      <p>利用<strong>双指针</strong>的思想做出这题，然后要考虑到特殊情况，比较元素的时候要小心数组索引越界异常，踩坑就是这里</p>

        <h2 id="283-移动零"   >
          <a href="#283-移动零" class="heading-link"><i class="fas fa-link"></i></a><a href="#283-移动零" class="headerlink" title="283.移动零"></a>283.移动零</h2>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/move-zeroes/" >Leetcode.283题(easy)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="第一次做-7"   >
          <a href="#第一次做-7" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一次做-7" class="headerlink" title="第一次做"></a>第一次做</h3>
      <p>第一次于23&#x2F;08&#x2F;06</p>

        <h4 id="第一次代码-7"   >
          <a href="#第一次代码-7" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一次代码-7" class="headerlink" title="第一次代码"></a>第一次代码</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">moveZeroes</span><span class="params">(<span class="type">int</span>[] nums)</span> &#123;</span><br><span class="line">        <span class="type">int</span> slow=nums.length-<span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> fast=nums.length-<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span>(;fast&gt;=<span class="number">0</span>;fast--)&#123;</span><br><span class="line">            <span class="keyword">if</span>(nums[fast]==<span class="number">0</span>)&#123;</span><br><span class="line">                nums[slow]=<span class="number">0</span>;</span><br><span class="line">                slow--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="提交错误-14"   >
          <a href="#提交错误-14" class="heading-link"><i class="fas fa-link"></i></a><a href="#提交错误-14" class="headerlink" title="提交错误"></a>提交错误</h5>
      <p>CASE:输入[0,1,0,3,12] 输出[0,1,0,0,0] 预期输出[1,3,12,0,0]</p>

        <h5 id="原因-15"   >
          <a href="#原因-15" class="heading-link"><i class="fas fa-link"></i></a><a href="#原因-15" class="headerlink" title="原因"></a>原因</h5>
      <p>我的意思是从后面开始遍历，然后当为0的时候更新慢指针的位置，把0记录在数组后面这样就不用做移动操作</p>
<p>实际上更新慢指针的时候将数据丢失了，导致非0的位置成了0而为0的位置没有变化，所以为了数据不丢失我将更新操作做了调整</p>

        <h4 id="第二次代码-6"   >
          <a href="#第二次代码-6" class="heading-link"><i class="fas fa-link"></i></a><a href="#第二次代码-6" class="headerlink" title="第二次代码"></a>第二次代码</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">moveZeroes</span><span class="params">(<span class="type">int</span>[] nums)</span> &#123;</span><br><span class="line">        <span class="type">int</span> slow=nums.length-<span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> fast=nums.length-<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span>(;fast&gt;=<span class="number">0</span>;fast--)&#123;</span><br><span class="line">            <span class="keyword">if</span>(nums[fast]==<span class="number">0</span>)&#123;</span><br><span class="line">                nums[fast]=nums[slow];</span><br><span class="line">                nums[slow]=<span class="number">0</span>;</span><br><span class="line">                slow--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="提交失败-1"   >
          <a href="#提交失败-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#提交失败-1" class="headerlink" title="提交失败"></a>提交失败</h5>
      <p>CASE:输入[0,1,0,3,12] 输出[3,1,12,0,0] 预期输出[1,3,12,0,0]</p>

        <h5 id="原因-16"   >
          <a href="#原因-16" class="heading-link"><i class="fas fa-link"></i></a><a href="#原因-16" class="headerlink" title="原因"></a>原因</h5>
      <p>因为我选择交换位置 而且我是从后面开始遍历的所以第一个0和3交换了位置 第二个0和12交换了位置，这样保证了数据不丢失，但是这样就影响了数据的次序，这是我没有考虑到的。我开始想是不是我的思路出现问题，就这样我改改提交了第三次代码</p>

        <h4 id="第三次代码-5"   >
          <a href="#第三次代码-5" class="heading-link"><i class="fas fa-link"></i></a><a href="#第三次代码-5" class="headerlink" title="第三次代码"></a>第三次代码</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">moveZeroes</span><span class="params">(<span class="type">int</span>[] nums)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">slow</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> fast= <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(;fast&lt;nums.length;fast++)&#123;</span><br><span class="line">            <span class="comment">//从头遍历 当元素不为0的时候更新到新数组中</span></span><br><span class="line">            <span class="keyword">if</span>(nums[fast]!=<span class="number">0</span>)&#123;</span><br><span class="line">                nums[slow]=nums[fast];</span><br><span class="line">                slow++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    		<span class="comment">//当循环结束新数组和老数组数量不同说明最后的元素需要更新成0</span></span><br><span class="line">        <span class="keyword">if</span>(slow!=fast)</span><br><span class="line">        <span class="keyword">for</span>(;slow&lt;fast;slow++)&#123;</span><br><span class="line">            nums[slow]=<span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="提交成功-6"   >
          <a href="#提交成功-6" class="heading-link"><i class="fas fa-link"></i></a><a href="#提交成功-6" class="headerlink" title="提交成功"></a>提交成功</h5>
      <p>我反思了一下顺序的丢失可能是因为从后面开始遍历的原因，所以我选择从头遍历，然后最后进行一个判断如果新老数组长度不相等，则更新最后几个元素，因为最后几个元素将0的位置填补掉了</p>

        <h3 id="总结-5"   >
          <a href="#总结-5" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结-5" class="headerlink" title="总结"></a>总结</h3>
      <p><strong>双指针</strong>的时候更新元素只是覆盖，要注意数据丢失的问题以及数据次序的问题</p>

        <h2 id="844-比较含退格的字符串"   >
          <a href="#844-比较含退格的字符串" class="heading-link"><i class="fas fa-link"></i></a><a href="#844-比较含退格的字符串" class="headerlink" title="844.比较含退格的字符串"></a>844.比较含退格的字符串</h2>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/backspace-string-compare/" >Leetcode.844题(easy)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="第一次做-8"   >
          <a href="#第一次做-8" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一次做-8" class="headerlink" title="第一次做"></a>第一次做</h3>
      <p>第一次于23&#x2F;08&#x2F;06</p>

        <h4 id="第一次代码-8"   >
          <a href="#第一次代码-8" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一次代码-8" class="headerlink" title="第一次代码"></a>第一次代码</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">backspaceCompare</span><span class="params">(String s, String t)</span> &#123;</span><br><span class="line">    	<span class="comment">//1.获取字符数组</span></span><br><span class="line">        <span class="type">char</span>[] c= s.toCharArray();</span><br><span class="line">        <span class="type">char</span>[] d= t.toCharArray();</span><br><span class="line"></span><br><span class="line">    	<span class="comment">//获取c数组的快慢指针</span></span><br><span class="line">        <span class="type">int</span> cslow=<span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> cFast=<span class="number">0</span>;</span><br><span class="line">    	<span class="comment">//获取d数组的快慢指针</span></span><br><span class="line">        <span class="type">int</span> dslow=<span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> dFast=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(;cFast&lt;c.length;cFast++)&#123;</span><br><span class="line">            <span class="comment">//当c[cFast]!=&#x27;#&#x27;的时候进行更新新数组操作，当c[cFast]==&#x27;#&#x27;的时候进行一个退格覆盖</span></span><br><span class="line">            <span class="keyword">if</span>(c[cFast]!=<span class="string">&#x27;#&#x27;</span>)&#123;</span><br><span class="line">                c[cslow]=c[cFast];</span><br><span class="line">                cslow++;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//c[cFast==&#x27;#&#x27;]</span></span><br><span class="line">                <span class="comment">//判断cslow的值 防止--slow的时候索引越界异常</span></span><br><span class="line">                <span class="keyword">if</span>(cslow==<span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">                c[--cslow]=<span class="string">&#x27;#&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">//下同</span></span><br><span class="line">        <span class="keyword">for</span>(;dFast&lt;d.length;dFast++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(d[dFast]!=<span class="string">&#x27;#&#x27;</span>)&#123;</span><br><span class="line">                d[dslow]=d[dFast];</span><br><span class="line">                dslow++;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//d[dFast==&#x27;#&#x27;]</span></span><br><span class="line">                <span class="keyword">if</span>(dslow==<span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">                d[--dslow]=<span class="string">&#x27;#&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">//拼接数组成字符串</span></span><br><span class="line">        String newSstr=<span class="string">&quot;&quot;</span>;</span><br><span class="line">        String newTstr=<span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;cslow;i++)&#123;</span><br><span class="line">            newSstr=newSstr+c[i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;dslow;i++)&#123;</span><br><span class="line">            newTstr=newTstr+d[i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> newSstr.equals(newTstr);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="提交成功-7"   >
          <a href="#提交成功-7" class="heading-link"><i class="fas fa-link"></i></a><a href="#提交成功-7" class="headerlink" title="提交成功"></a>提交成功</h5>
      <p>但是好像有一点点不太优雅提交完这个答案，我总觉得有地方可以改进，并且相同代码有点太多了，而看了评论区大概就是抽取出一个方法然后返回一个String类型的值  主函数中用  return 方法1(s).eqauls(方法1(t)) 这样好像优雅一点</p>

        <h3 id="总结-6"   >
          <a href="#总结-6" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结-6" class="headerlink" title="总结"></a>总结</h3>
      <p>利用<strong>双指针</strong>的思想</p>
<p>①先获取char类型的数组，方便使用双指针</p>
<p>②当nums[fast]!&#x3D;’#’的时候进行一个更新到新数组操作 即nums[slow++]&#x3D;nums[fast];</p>
<p>③当nums[fast]&#x3D;&#x3D;’#’的时候要进行一个退格操作 即nums[–slow]&#x3D;’#’  但是这里有一个坑 <strong>当slow为0的时候要注意–slow的索引越界</strong></p>
<p>所以我进行了一个判断  当slow&#x3D;&#x3D;0的时候直接continue;</p>
<p>④将字符数组返回成字符串 ，通过字符串的equasl方法比较并返回结果，我这里做的太不优雅了可以改进一点的</p>

        <h2 id="977-有序数组的平方"   >
          <a href="#977-有序数组的平方" class="heading-link"><i class="fas fa-link"></i></a><a href="#977-有序数组的平方" class="headerlink" title="977.有序数组的平方"></a>977.有序数组的平方</h2>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/squares-of-a-sorted-array/" >Leetcode.977题(easy)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="第一次做-9"   >
          <a href="#第一次做-9" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一次做-9" class="headerlink" title="第一次做"></a>第一次做</h3>
      <p>第一次做于23&#x2F;08&#x2F;06</p>

        <h4 id="第一次代码-9"   >
          <a href="#第一次代码-9" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一次代码-9" class="headerlink" title="第一次代码"></a>第一次代码</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span>[] sortedSquares(<span class="type">int</span>[] nums) &#123;</span><br><span class="line">        <span class="comment">//先平方</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;nums.length;i++)&#123;</span><br><span class="line">            nums[i]=nums[i]*nums[i];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//再排序</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;nums.length;j++)&#123;</span><br><span class="line">        	<span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;nums.length-<span class="number">1</span>;i++)&#123;</span><br><span class="line">            	<span class="keyword">if</span>(nums[i]&gt;nums[i+<span class="number">1</span>])&#123;</span><br><span class="line">                	<span class="type">int</span> temp=nums[i+<span class="number">1</span>];</span><br><span class="line">                	nums[i+<span class="number">1</span>]=nums[i];</span><br><span class="line">                	nums[i]=temp;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> nums;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="提交成功-8"   >
          <a href="#提交成功-8" class="heading-link"><i class="fas fa-link"></i></a><a href="#提交成功-8" class="headerlink" title="提交成功"></a>提交成功</h5>
      <p>很显然这次是一个暴力解法，因为我有一点点不知道怎么用双指针来解这道题，并且还有一点很关键的是，暴力解法的暴力循环我用了最老套的双层嵌套，这是一个时间复杂度为O(n²)的方法</p>

        <h3 id="题解-1"   >
          <a href="#题解-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#题解-1" class="headerlink" title="题解"></a>题解</h3>
      
        <h4 id="思路"   >
          <a href="#思路" class="heading-link"><i class="fas fa-link"></i></a><a href="#思路" class="headerlink" title="思路"></a>思路</h4>
      <p>依然是使用<strong>双指针</strong>的思想</p>
<p><strong>数组最左边或者最右边一定会产生最大的平方数</strong>，因此我们用两个指针一个指向最左边的一个指向最右边，然后来比较两者之间的最大值</p>
<p>然后将最大的写入新数组中，循环条件是左边的指针小于等于右边指针 (也就是左边指针不超过右边指针)，新数组用一个新的指针指向，并且要从后往前写这样保证了数据大的排在后面</p>
<p><strong>破局点</strong>：1.可以用新数组来承接老数组的数值，这样不会因为原地修改造成数据丢失</p>
<p>​				2.老数组的两边一定会产生这个数组中最大的平方数</p>
<p>​				3.新数组从后往前写保证了新数组的顺序</p>

        <h4 id="代码"   >
          <a href="#代码" class="heading-link"><i class="fas fa-link"></i></a><a href="#代码" class="headerlink" title="代码"></a>代码</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span>[] sortedSquares(<span class="type">int</span>[] nums) &#123;</span><br><span class="line">       <span class="comment">// 双指针</span></span><br><span class="line">    </span><br><span class="line">    	<span class="comment">//指向最左边</span></span><br><span class="line">        <span class="type">int</span> low=<span class="number">0</span>;</span><br><span class="line">    	<span class="comment">//指向最右边 </span></span><br><span class="line">        <span class="type">int</span> high=nums.length-<span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    	<span class="comment">//新数组的索引下标，从后往前写</span></span><br><span class="line">        <span class="type">int</span> write=nums.length-<span class="number">1</span>;</span><br><span class="line">    	<span class="comment">//定义一个新数组</span></span><br><span class="line">        <span class="type">int</span>[] newArr=<span class="keyword">new</span> <span class="title class_">int</span>[nums.length];</span><br><span class="line">    </span><br><span class="line">    	<span class="comment">//当左边指针不超过右边指针时候进入循环</span></span><br><span class="line">        <span class="keyword">while</span>(low&lt;=high)&#123;</span><br><span class="line">            <span class="comment">//如果左边产生的平方数比右边的平方大 将左边的平方写入新数组中然后指针移动</span></span><br><span class="line">            <span class="keyword">if</span>(nums[low]*nums[low]&gt;nums[high]*nums[high])&#123;</span><br><span class="line">                newArr[write]=nums[low]*nums[low];</span><br><span class="line">                low++;</span><br><span class="line">                write--;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//反之将右边的平方数写入数组中然后指针移动</span></span><br><span class="line">                newArr[write]=nums[high]*nums[high];</span><br><span class="line">                high--;</span><br><span class="line">                write--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> newArr;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="图解-3"   >
          <a href="#图解-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#图解-3" class="headerlink" title="图解"></a>图解</h3>
      <p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230806111400239.png"  alt="977题双指针图解(1)">
      </p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230806111548953.png"  alt="977题双指针图解(2)">
      </p>

        <h1 id="有序数组的平方"   >
          <a href="#有序数组的平方" class="heading-link"><i class="fas fa-link"></i></a><a href="#有序数组的平方" class="headerlink" title="有序数组的平方"></a>有序数组的平方</h1>
      <p>给你一个按 非递减顺序 排序的整数数组 nums，返回 每个数字的平方 组成的新数组，要求也按 非递减顺序 排序。</p>

        <h2 id="977-有序数组的平方-1"   >
          <a href="#977-有序数组的平方-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#977-有序数组的平方-1" class="headerlink" title="977.有序数组的平方"></a>977.有序数组的平方</h2>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/squares-of-a-sorted-array/" >Leetcode.977题(easy)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>有点扯，这道题明明昨天刚做过 3&gt;3 就当无事发生再重新做一遍吧</p>

        <h3 id="代码-1"   >
          <a href="#代码-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#代码-1" class="headerlink" title="代码"></a>代码</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span>[] sortedSquares(<span class="type">int</span>[] nums) &#123;</span><br><span class="line">    	<span class="comment">//定义双指针 low指向老数组最左边 high指向老数组最右边 write指向新数组的写入位置，从后往前写所以指向最后</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">low</span> <span class="operator">=</span><span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> high=nums.length-<span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> write=nums.length-<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    	<span class="comment">//创建一个新数组</span></span><br><span class="line">        <span class="type">int</span>[] newArr= <span class="keyword">new</span> <span class="title class_">int</span>[nums.length];</span><br><span class="line"></span><br><span class="line">    	<span class="comment">//当low不超过high的时候进行循环</span></span><br><span class="line">        <span class="keyword">while</span>(low&lt;=high)&#123;</span><br><span class="line">            <span class="comment">//左边的数平方比右边的数平方大</span></span><br><span class="line">            <span class="keyword">if</span>(nums[low]*nums[low]&gt;nums[high]*nums[high])&#123;</span><br><span class="line">                <span class="comment">//写入新数组中，low++,write--</span></span><br><span class="line">                newArr[write--]=nums[low]*nums[low];</span><br><span class="line">                low++;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//反之右边的数的平方比左边的数大</span></span><br><span class="line">                <span class="comment">//写入新数组中，high--,write--</span></span><br><span class="line">                newArr[write--]=nums[high]*nums[high];</span><br><span class="line">                high--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    	<span class="comment">//返回新数组</span></span><br><span class="line">        <span class="keyword">return</span> newArr;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>




        <h3 id="图解-4"   >
          <a href="#图解-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#图解-4" class="headerlink" title="图解"></a>图解</h3>
      <p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230806111400239.png"  alt="977题双指针图解(1)">
      </p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230806111548953.png"  alt="977题双指针图解(2)">
      </p>

        <h1 id="长度最小的子数组"   >
          <a href="#长度最小的子数组" class="heading-link"><i class="fas fa-link"></i></a><a href="#长度最小的子数组" class="headerlink" title="长度最小的子数组"></a>长度最小的子数组</h1>
      <p>给定一个含有 n 个正整数的数组和一个正整数 s ，找出该数组中满足其和 ≥ s 的长度最小的 连续 子数组，并返回其长度。如果不存在符合条件的子数组，返回 0</p>

        <h2 id="209-长度最小的子数组"   >
          <a href="#209-长度最小的子数组" class="heading-link"><i class="fas fa-link"></i></a><a href="#209-长度最小的子数组" class="headerlink" title="209.长度最小的子数组"></a>209.长度最小的子数组</h2>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/minimum-size-subarray-sum/" >Leetcode.209题(medium)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><em>给定一个含有 n 个正整数的数组和一个正整数 s ，找出该数组中满足其和 ≥ s 的长度最小的 连续 子数组，并返回其长度。如果不存在符合条件的子数组，返回 0</em></p>

        <h3 id="第一次做-10"   >
          <a href="#第一次做-10" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一次做-10" class="headerlink" title="第一次做"></a>第一次做</h3>
      <p>第一次做于23&#x2F;08&#x2F;07</p>

        <h4 id="第一次代码-10"   >
          <a href="#第一次代码-10" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一次代码-10" class="headerlink" title="第一次代码"></a>第一次代码</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">minSubArrayLen</span><span class="params">(<span class="type">int</span> target, <span class="type">int</span>[] nums)</span> &#123;</span><br><span class="line">        <span class="type">int</span> slow=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> sum=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> count=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> temp=nums.length;</span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> flag=<span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span>(;slow&lt;nums.length;slow++)&#123;</span><br><span class="line">            sum=<span class="number">0</span>;</span><br><span class="line">            count=<span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i=slow;i&lt;nums.length;i++)&#123;</span><br><span class="line">                sum+=nums[i];</span><br><span class="line">                <span class="keyword">if</span>(sum&gt;=target)&#123;</span><br><span class="line">                    count++;</span><br><span class="line">                    <span class="keyword">if</span>(temp&gt;=count)&#123;</span><br><span class="line">                        temp=count;</span><br><span class="line">                        flag=<span class="literal">true</span>;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    count++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(flag)&#123;</span><br><span class="line">            <span class="keyword">return</span> temp;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="提交失败-2"   >
          <a href="#提交失败-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#提交失败-2" class="headerlink" title="提交失败"></a>提交失败</h5>
      <p>CASE:输入396893380 超出时间限制</p>

        <h5 id="原因-17"   >
          <a href="#原因-17" class="heading-link"><i class="fas fa-link"></i></a><a href="#原因-17" class="headerlink" title="原因"></a>原因</h5>
      <p>嵌套循环中每一次都需要从当前之后下一个元素开始，时间复杂度太高了，我在想是不是前N个才能sum&gt;&#x3D;target的情况下，那N-1个一定是sum&lt;target，我们只需要从第N+1个元素开始看下一次条件?</p>

        <h4 id="第二次代码-7"   >
          <a href="#第二次代码-7" class="heading-link"><i class="fas fa-link"></i></a><a href="#第二次代码-7" class="headerlink" title="第二次代码"></a>第二次代码</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">minSubArrayLen</span><span class="params">(<span class="type">int</span> target, <span class="type">int</span>[] nums)</span> &#123;</span><br><span class="line">        <span class="type">int</span> slow=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> sum=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> count=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> temp=nums.length;</span><br><span class="line">        <span class="type">boolean</span> flag=<span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span>(;slow&lt;nums.length;)&#123;</span><br><span class="line">            sum=<span class="number">0</span>;</span><br><span class="line">            count=<span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i=slow;i&lt;nums.length;i++)&#123;</span><br><span class="line">                sum+=nums[i];</span><br><span class="line">                <span class="keyword">if</span>(sum&gt;=target)&#123;</span><br><span class="line">                    count++;</span><br><span class="line">                    <span class="keyword">if</span>(temp&gt;=count)&#123;</span><br><span class="line">                        temp=count;</span><br><span class="line">                        flag=<span class="literal">true</span>;</span><br><span class="line">                        slow=i+<span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    count++;</span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(flag)&#123;</span><br><span class="line">            <span class="keyword">return</span> temp;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="提交失败-3"   >
          <a href="#提交失败-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#提交失败-3" class="headerlink" title="提交失败"></a>提交失败</h5>
      <p>CASE:输入11 [1,1,1,1,1,1,1,1] 超出时间限制</p>

        <h5 id="原因-18"   >
          <a href="#原因-18" class="heading-link"><i class="fas fa-link"></i></a><a href="#原因-18" class="headerlink" title="原因"></a>原因</h5>
      <p>第二个循环才能导致外循环的slow更改数据，如果一直找不到最小的数组则陷入了死循环中</p>

        <h4 id="第三次代码-6"   >
          <a href="#第三次代码-6" class="heading-link"><i class="fas fa-link"></i></a><a href="#第三次代码-6" class="headerlink" title="第三次代码"></a>第三次代码</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">minSubArrayLen</span><span class="params">(<span class="type">int</span> target, <span class="type">int</span>[] nums)</span> &#123;</span><br><span class="line">        <span class="type">int</span> slow=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> sum=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> count=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> temp=nums.length;</span><br><span class="line">        <span class="type">boolean</span> flag=<span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span>(;slow&lt;nums.length;slow++)&#123;</span><br><span class="line">            sum+=nums[slow];</span><br><span class="line">            count++;</span><br><span class="line">           <span class="keyword">if</span>(sum&gt;=target)&#123;</span><br><span class="line">               sum=<span class="number">0</span>;</span><br><span class="line">               <span class="keyword">if</span>(temp&gt;count)&#123;</span><br><span class="line">                   temp=count;</span><br><span class="line">                   count=<span class="number">0</span>;</span><br><span class="line">               &#125;</span><br><span class="line">               flag=<span class="literal">true</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(flag)&#123;</span><br><span class="line">            <span class="keyword">return</span> temp;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="提交失败-4"   >
          <a href="#提交失败-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#提交失败-4" class="headerlink" title="提交失败"></a>提交失败</h5>
      <p>CASE:输入 11 [1,2,3,4,5] 输出5 预期输出3</p>

        <h5 id="原因-19"   >
          <a href="#原因-19" class="heading-link"><i class="fas fa-link"></i></a><a href="#原因-19" class="headerlink" title="原因"></a>原因</h5>
      <p>很显然是因为我第一次失败的错误思路，我假设前n个才能导致sum&gt;&#x3D;target，我认为n-1个时达不到sum&gt;&#x3D;target目标，所以我直接认为下一个子数组要从下一个也即n+1开始看</p>
<p>这道题我没能成功自己做出来</p>

        <h3 id="题解-2"   >
          <a href="#题解-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#题解-2" class="headerlink" title="题解"></a>题解</h3>
      <p>这道题还是用<strong>滑动窗口</strong>的思路，如果用暴力解法会时间超出限制，所以暴力法就不行了。然后双指针主要是如何更新起始位置的指针是这道题的关键，我第一次做的时候第三次代码用了相似的思路，但是我没能成功移动起始索引</p>
<p><strong>代码</strong></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">minSubArrayLen</span><span class="params">(<span class="type">int</span> target, <span class="type">int</span>[] nums)</span> &#123;</span><br><span class="line">    	<span class="comment">//定义left和right指针 一个用于表示起始位置，一个用于表示终止位置</span></span><br><span class="line">        <span class="type">int</span> left=<span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> right=<span class="number">0</span>;</span><br><span class="line">    	<span class="comment">//定义sum用来比较数值，temp是用来记录最小长度的，temp的初始化只要比nums.length大就行</span></span><br><span class="line">        <span class="type">int</span> sum=<span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> temp=Integer.MAX_VALUE;</span><br><span class="line">        <span class="keyword">for</span>(;right&lt;nums.length;right++)&#123;</span><br><span class="line">            sum+=nums[right];</span><br><span class="line">            <span class="comment">//while循环来不断更新起始位置 ，当sum&lt;target中断循环说明启示位置更新到sum&lt;target的位置了</span></span><br><span class="line">            <span class="keyword">while</span>(sum&gt;=target)&#123;</span><br><span class="line">                <span class="comment">//获取数组最小长度  结束位置-起始位置+1是当前窗口的元素个数 </span></span><br><span class="line">                temp=Math.min(temp,right-left+<span class="number">1</span>);</span><br><span class="line">                <span class="comment">//减去启示位置的元素值 用来更新起始位置</span></span><br><span class="line">                sum-=nums[left];</span><br><span class="line">                left++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    	<span class="comment">//如果temp和初始化长度一样则说明没有最小数组，反之说明找到了最小数组，返回最小数组长度</span></span><br><span class="line">        <span class="keyword">return</span> temp==Integer.MAX_VALUE? <span class="number">0</span> :temp;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="总结-7"   >
          <a href="#总结-7" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结-7" class="headerlink" title="总结"></a>总结</h3>
      <p><strong>滑动窗口的思想</strong>重点在于怎么来更新起始位置的指针，这里用while循环来保证【起始位置，终止位置】这段数组中sum&lt;target，如果用if来进行条件判断则不能保证这个【起始位置，终止位置】这个区间中sum&lt;target</p>

        <h3 id="图解-5"   >
          <a href="#图解-5" class="heading-link"><i class="fas fa-link"></i></a><a href="#图解-5" class="headerlink" title="图解"></a>图解</h3>
      <p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="/%E6%AD%BB%E4%B9%8B%E5%89%8D%E8%A6%81%E5%81%9A%E5%AE%8C%E7%9A%84%E7%AE%97%E6%B3%95%E6%89%8B%E5%86%8C-%E7%AE%97%E6%B3%95%5B%E6%95%B0%E7%BB%84%E7%AF%87%5D/image-20230807105205073.png"  alt="滑动窗口图解(1)">
      </p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="/%E6%AD%BB%E4%B9%8B%E5%89%8D%E8%A6%81%E5%81%9A%E5%AE%8C%E7%9A%84%E7%AE%97%E6%B3%95%E6%89%8B%E5%86%8C-%E7%AE%97%E6%B3%95%5B%E6%95%B0%E7%BB%84%E7%AF%87%5D/image-20230807105326262.png"  alt="滑动窗口图解(2)">
      </p>

        <h2 id="904-水果成篮"   >
          <a href="#904-水果成篮" class="heading-link"><i class="fas fa-link"></i></a><a href="#904-水果成篮" class="headerlink" title="904.水果成篮"></a>904.水果成篮</h2>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/fruit-into-baskets/" >Leetcode.904题(medium)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>你正在探访一家农场，农场从左到右种植了一排果树。这些树用一个整数数组 fruits 表示，其中 fruits[i] 是第 i 棵树上的水果 种类 。</p>
<p>你想要尽可能多地收集水果。然而，农场的主人设定了一些严格的规矩，你必须按照要求采摘水果：</p>
<p>你只有 两个 篮子，并且每个篮子只能装 单一类型 的水果。每个篮子能够装的水果总量没有限制。<br>你可以选择任意一棵树开始采摘，你必须从 每棵 树（包括开始采摘的树）上 恰好摘一个水果 。采摘的水果应当符合篮子中的水果类型。每采摘一次，你将会向右移动到下一棵树，并继续采摘。<br>一旦你走到某棵树前，但水果不符合篮子的水果类型，那么就必须停止采摘。<br>给你一个整数数组 fruits ，返回你可以收集的水果的 最大 数目。</p>

        <h3 id="第一次做-11"   >
          <a href="#第一次做-11" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一次做-11" class="headerlink" title="第一次做"></a>第一次做</h3>
      <p>第一次做于23&#x2F;08&#x2F;07</p>

        <h4 id="第一次代码-11"   >
          <a href="#第一次代码-11" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一次代码-11" class="headerlink" title="第一次代码"></a>第一次代码</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">totalFruit</span><span class="params">(<span class="type">int</span>[] fruits)</span> &#123;</span><br><span class="line">        <span class="type">int</span> typeA=Integer.MAX_VALUE;</span><br><span class="line">        <span class="type">int</span> typeB=Integer.MAX_VALUE;</span><br><span class="line">        <span class="type">int</span> left=<span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> right=<span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> count=<span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> max=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(;right&lt;fruits.length;right++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(typeA==Integer.MAX_VALUE)&#123;</span><br><span class="line">                typeA=fruits[right];</span><br><span class="line">                count++;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(typeA!=fruits[right]&amp;&amp;typeB==Integer.MAX_VALUE)&#123;</span><br><span class="line">                typeB=fruits[right];</span><br><span class="line">                count++;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(fruits[right]==typeA||fruits[right]==typeB)&#123;</span><br><span class="line">                 count++;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(fruits[right]!=typeA&amp;&amp;fruits[right]!=typeB)&#123;</span><br><span class="line">                max= max&gt;count?max:count;</span><br><span class="line">                count=<span class="number">0</span>; </span><br><span class="line">                <span class="keyword">while</span>(fruits[left]==typeA)&#123;</span><br><span class="line">                    left++;</span><br><span class="line">                &#125;</span><br><span class="line">                typeA=typeB;</span><br><span class="line">                typeB=Integer.MAX_VALUE;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        max=max&gt;count?max:count;</span><br><span class="line">        <span class="keyword">return</span> max;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="提交失败-5"   >
          <a href="#提交失败-5" class="heading-link"><i class="fas fa-link"></i></a><a href="#提交失败-5" class="headerlink" title="提交失败"></a>提交失败</h5>
      <p>CASE:输入[0,1,2,2] 输出2 ，预期输出3</p>

        <h5 id="原因-20"   >
          <a href="#原因-20" class="heading-link"><i class="fas fa-link"></i></a><a href="#原因-20" class="headerlink" title="原因"></a>原因</h5>
      <p>因为把第三种水果判断的时候我将count置为0 但是实际上我还有一个篮子装有水果，我忽略了另一个篮子中的水果个数</p>

        <h4 id="第二次代码-8"   >
          <a href="#第二次代码-8" class="heading-link"><i class="fas fa-link"></i></a><a href="#第二次代码-8" class="headerlink" title="第二次代码"></a>第二次代码</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">totalFruit</span><span class="params">(<span class="type">int</span>[] fruits)</span> &#123;</span><br><span class="line">        <span class="type">int</span> typeA=Integer.MAX_VALUE;</span><br><span class="line">        <span class="type">int</span> typeB=Integer.MAX_VALUE;</span><br><span class="line">        <span class="type">int</span> left=<span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> right=<span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> Acount=<span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> Bcount=<span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> max=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(;right&lt;fruits.length;right++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(typeA==Integer.MAX_VALUE)&#123;</span><br><span class="line">                typeA=fruits[right];</span><br><span class="line">                Acount++;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(typeA!=fruits[right]&amp;&amp;typeB==Integer.MAX_VALUE)&#123;</span><br><span class="line">                typeB=fruits[right];</span><br><span class="line">                Bcount++;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(fruits[right]==typeA)&#123;</span><br><span class="line">                Acount++;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(fruits[right]==typeB)&#123;</span><br><span class="line">                Bcount++;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(fruits[right]!=typeA&amp;&amp;fruits[right]!=typeB)&#123;</span><br><span class="line">                max= max&gt;(Acount+Bcount)?max:(Acount+Bcount);</span><br><span class="line">                Acount=Bcount;</span><br><span class="line">                Bcount=<span class="number">0</span>;</span><br><span class="line">                <span class="keyword">while</span>(fruits[left]==typeA)&#123;</span><br><span class="line">                    left++;</span><br><span class="line">                &#125;</span><br><span class="line">                typeA=typeB;</span><br><span class="line">                typeB=fruits[right];</span><br><span class="line">                Bcount++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">         max= max&gt;(Acount+Bcount)?max:(Acount+Bcount);</span><br><span class="line">        <span class="keyword">return</span> max;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="提交错误-15"   >
          <a href="#提交错误-15" class="heading-link"><i class="fas fa-link"></i></a><a href="#提交错误-15" class="headerlink" title="提交错误"></a>提交错误</h5>
      <p>CASE:输入[1,0,1,4,1,4,1,2,3] 输出4 预期输出5</p>

        <h5 id="原因-21"   >
          <a href="#原因-21" class="heading-link"><i class="fas fa-link"></i></a><a href="#原因-21" class="headerlink" title="原因"></a>原因</h5>
      <p>逻辑错了滑动窗口下一个位置应该是下一个元素前面一个类型的起始个数</p>

        <h4 id="第三次代码-7"   >
          <a href="#第三次代码-7" class="heading-link"><i class="fas fa-link"></i></a><a href="#第三次代码-7" class="headerlink" title="第三次代码"></a>第三次代码</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">totalFruit</span><span class="params">(<span class="type">int</span>[] fruits)</span> &#123;</span><br><span class="line">       <span class="type">int</span> typeA=Integer.MAX_VALUE;</span><br><span class="line">       <span class="type">int</span> typeB=Integer.MAX_VALUE;</span><br><span class="line">       <span class="type">int</span> left=<span class="number">0</span>;</span><br><span class="line">       <span class="type">int</span> right=<span class="number">0</span>;</span><br><span class="line">       <span class="type">int</span> Acount=<span class="number">0</span>;</span><br><span class="line">       <span class="type">int</span> Bcount=<span class="number">0</span>;</span><br><span class="line">       <span class="type">int</span> max=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">for</span>(;right&lt;fruits.length;right++)&#123;</span><br><span class="line">           <span class="keyword">if</span>(typeA==Integer.MAX_VALUE)&#123;</span><br><span class="line">               typeA=fruits[right];</span><br><span class="line">               Acount++;</span><br><span class="line">               <span class="keyword">continue</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span>(typeA!=fruits[right]&amp;&amp;typeB==Integer.MAX_VALUE)&#123;</span><br><span class="line">               typeB=fruits[right];</span><br><span class="line">               Bcount++;</span><br><span class="line">               <span class="keyword">continue</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span>(fruits[right]==typeA)&#123;</span><br><span class="line">               Acount++;</span><br><span class="line">               <span class="keyword">continue</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span>(fruits[right]==typeB)&#123;</span><br><span class="line">               Bcount++;</span><br><span class="line">               <span class="keyword">continue</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span>(fruits[right]!=typeA&amp;&amp;fruits[right]!=typeB)&#123;</span><br><span class="line">               max= max&gt; (Acount+Bcount)?max:(Acount+Bcount);</span><br><span class="line">               </span><br><span class="line">               <span class="keyword">if</span>(fruits[right-<span class="number">1</span>]==typeA)&#123;</span><br><span class="line">                   <span class="comment">//清空B篮子</span></span><br><span class="line">                   <span class="keyword">while</span>(Bcount!=<span class="number">0</span>)&#123;</span><br><span class="line">                       <span class="keyword">if</span>(fruits[left++]==typeB) Bcount--;</span><br><span class="line">                       <span class="keyword">else</span> Acount--;</span><br><span class="line">                   &#125;</span><br><span class="line">                  </span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span>(fruits[right-<span class="number">1</span>]==typeB)&#123;</span><br><span class="line">                   <span class="comment">//清空A篮子</span></span><br><span class="line">                   <span class="keyword">while</span>(Acount!=<span class="number">0</span>)&#123;</span><br><span class="line">                       <span class="keyword">if</span>(fruits[left++]==typeA) Acount--;</span><br><span class="line">                       <span class="keyword">else</span> Bcount--;</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="comment">//把B篮子给A篮子</span></span><br><span class="line">                   Acount=Bcount;</span><br><span class="line">                   typeA=typeB;</span><br><span class="line">                   Bcount=<span class="number">0</span>;</span><br><span class="line">               &#125;</span><br><span class="line">                typeB=fruits[right];</span><br><span class="line">                Bcount++;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">         max= max&gt; (Acount+Bcount)?max:(Acount+Bcount);</span><br><span class="line">       <span class="keyword">return</span> max;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="提交成功-9"   >
          <a href="#提交成功-9" class="heading-link"><i class="fas fa-link"></i></a><a href="#提交成功-9" class="headerlink" title="提交成功"></a>提交成功</h5>
      <p>我把左右两个篮子的个数分开算，当碰到第三种水果的时候判断前一种水果是什么让他成为种类A，索引应该移动到连续的种类A的第一个，然后把第三种水果装成种类B的篮子中</p>

        <h4 id="第四次代码-3"   >
          <a href="#第四次代码-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#第四次代码-3" class="headerlink" title="第四次代码"></a>第四次代码</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">totalFruit</span><span class="params">(<span class="type">int</span>[] fruits)</span> &#123;</span><br><span class="line">        <span class="type">int</span> left=<span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> right=<span class="number">0</span>;</span><br><span class="line">        Map&lt;Integer,Integer&gt; map= <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">int</span> len=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(;right&lt;fruits.length;right++)&#123;</span><br><span class="line">            <span class="comment">//没有装满两种类型</span></span><br><span class="line">            <span class="keyword">if</span>(map.size()&lt;<span class="number">2</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(map.containsKey(fruits[right]))&#123;</span><br><span class="line">                    <span class="type">int</span> count=map.get(fruits[right]);</span><br><span class="line">                    map.put(fruits[right],++count);</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    map.put(fruits[right],<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                 <span class="keyword">if</span>(map.containsKey(fruits[right]))&#123;</span><br><span class="line">                     <span class="comment">//是两种之一</span></span><br><span class="line">                    <span class="type">int</span> count=map.get(fruits[right]);</span><br><span class="line">                    map.put(fruits[right],++count);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//第三种，需要清空其中一种</span></span><br><span class="line">                <span class="comment">//获取最长的长度</span></span><br><span class="line">                len=Math.max(len,right-left);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//最靠近第三种水果的第二种水果种类 nums[right-1] 我们这一步的目标是清空种类1 保留连续的第二种水果</span></span><br><span class="line">                </span><br><span class="line">                <span class="type">int</span> bCount=right-left-map.get(fruits[right-<span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">while</span>(bCount!=<span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="keyword">if</span>(fruits[left]==fruits[right-<span class="number">1</span>])&#123;</span><br><span class="line">                    <span class="type">int</span> count=map.get(fruits[right-<span class="number">1</span>]);</span><br><span class="line">                    map.put(fruits[right-<span class="number">1</span>],--count);</span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    map.put(fruits[left],--bCount);</span><br><span class="line">                    &#125;</span><br><span class="line">                    left++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//循环结束移除第一种水果</span></span><br><span class="line">                map.remove(fruits[left-<span class="number">1</span>]);</span><br><span class="line">                <span class="comment">//将第三种水果添加进篮子中</span></span><br><span class="line">                map.put(fruits[right],<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; </span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> len=Math.max(len,right-left);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="提交成功-10"   >
          <a href="#提交成功-10" class="heading-link"><i class="fas fa-link"></i></a><a href="#提交成功-10" class="headerlink" title="提交成功"></a>提交成功</h5>
      <p>利用集合写的，没想到不仅是时间和空间都比第三次代码花的多</p>

        <h3 id="总结-8"   >
          <a href="#总结-8" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结-8" class="headerlink" title="总结"></a>总结</h3>
      <p>①利用<strong>滑动窗口</strong>的思想，用类型A和类型B代表两个篮子，同时用Acount和Bcount表示水果个数</p>
<p>②当碰到第三种水果的时候先判断上一个水果是类型A还是类型B 收集max &#x3D; MAX&gt;Acount+Bcount ? MAX ：Acount+ Bcount</p>
<p>③如果是类型A就把类型B的水果清空以及类型B以前的水果A要减去 如 0 1 0 1 0 0 3 要把倒数第二个0以前的0101都清空掉</p>
<p>④如果是类型B就把类型A的水果以及类型A以前的水果B都清空，然后将B水果放到A水果篮中，B个数为0</p>
<p>⑤把类型C放到类型B中，设置B果篮中的水果个数为1</p>
<p>⑥最后返回最大的水果个数</p>

        <h2 id="76-最小覆盖子串"   >
          <a href="#76-最小覆盖子串" class="heading-link"><i class="fas fa-link"></i></a><a href="#76-最小覆盖子串" class="headerlink" title="76.最小覆盖子串"></a>76.最小覆盖子串</h2>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/minimum-window-substring/" >Leetcode.76题(hard)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="第一次做-12"   >
          <a href="#第一次做-12" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一次做-12" class="headerlink" title="第一次做"></a>第一次做</h3>
      <p>第一次做于23&#x2F;08&#x2F;08</p>

        <h4 id="第一次代码-12"   >
          <a href="#第一次代码-12" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一次代码-12" class="headerlink" title="第一次代码"></a>第一次代码</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">minWindow</span><span class="params">(String s, String t)</span> &#123;</span><br><span class="line">    <span class="type">int</span> left=<span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> right=<span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>((t==<span class="literal">null</span> &amp;&amp; <span class="string">&quot;&quot;</span>.equals(t))||(s==<span class="literal">null</span> &amp;&amp; <span class="string">&quot;&quot;</span>.equals(s)))&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">char</span>[] arr=t.toCharArray();</span><br><span class="line">    Map&lt;Character,Integer&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    Map&lt;Character,Integer&gt; tempMap=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">char</span> a:arr)&#123;</span><br><span class="line">        <span class="keyword">if</span>(map.containsKey(a))&#123;</span><br><span class="line">            <span class="comment">//如果包含</span></span><br><span class="line">            <span class="type">int</span> count=map.get(a);</span><br><span class="line">            map.put(a,++count);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            map.put(a,<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    tempMap=map;</span><br><span class="line">    <span class="type">char</span>[] sArr=s.toCharArray();</span><br><span class="line"></span><br><span class="line">    List&lt;Character&gt; list=<span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">    <span class="type">int</span> count=arr.length;</span><br><span class="line">    <span class="type">int</span> sCount=<span class="number">0</span>;</span><br><span class="line">    String result=<span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="type">int</span> max=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(;right&lt;sArr.length;right++)&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(tempMap.containsKey(sArr[right]))&#123;</span><br><span class="line">            </span><br><span class="line">            <span class="type">int</span> temp=tempMap.get(sArr[right]);</span><br><span class="line">            temp--;</span><br><span class="line">            <span class="keyword">if</span>(temp==<span class="number">0</span>)&#123;</span><br><span class="line">                tempMap.remove(sArr[right]);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                tempMap.put(sArr[right],temp);</span><br><span class="line">            &#125;</span><br><span class="line">            sCount++;</span><br><span class="line">        &#125;</span><br><span class="line">        list.add(sArr[right]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(sCount==count)&#123;</span><br><span class="line">            max= max&gt;list.toString().length()? max: list.toString().length();</span><br><span class="line">            result= list.toString().length()&gt;=max? list.toString():result;</span><br><span class="line">            <span class="keyword">if</span>(tempMap.containsKey(sArr[left]))&#123;</span><br><span class="line">            </span><br><span class="line">                <span class="type">int</span> temp=tempMap.get(sArr[left]);</span><br><span class="line">                    tempMap.put(sArr[left],++temp);</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    tempMap.put(sArr[left],<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            sCount--;</span><br><span class="line">            list.remove(left);</span><br><span class="line">            left++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h5 id="提交错误-16"   >
          <a href="#提交错误-16" class="heading-link"><i class="fas fa-link"></i></a><a href="#提交错误-16" class="headerlink" title="提交错误"></a>提交错误</h5>
      <p>CASE: s:”ADOBECODEBANC” t:”ABC”,输出”[D, O, B, E, C, O, D, E, B, A]”。预期输出”BANC”</p>

        <h5 id="原因-22"   >
          <a href="#原因-22" class="heading-link"><i class="fas fa-link"></i></a><a href="#原因-22" class="headerlink" title="原因"></a>原因</h5>
      <p>挺搞的一开始，我返回的是最长的字符串max&#x3D; max&gt;list.toString().length()? max: list.toString().length(); 其次输出的数组不是一个字符串所以我还要把这个数组变成字符串</p>

        <h4 id="第二次代码-9"   >
          <a href="#第二次代码-9" class="heading-link"><i class="fas fa-link"></i></a><a href="#第二次代码-9" class="headerlink" title="第二次代码"></a>第二次代码</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">minWindow</span><span class="params">(String s, String t)</span> &#123;</span><br><span class="line">        <span class="type">int</span> left=<span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> right=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>((t==<span class="literal">null</span> &amp;&amp; <span class="string">&quot;&quot;</span>.equals(t))||(s==<span class="literal">null</span> &amp;&amp; <span class="string">&quot;&quot;</span>.equals(s)))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">char</span>[] arr=t.toCharArray();</span><br><span class="line">        Map&lt;Character,Integer&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Character,Integer&gt; tempMap=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">char</span> a:arr)&#123;</span><br><span class="line">            <span class="keyword">if</span>(map.containsKey(a))&#123;</span><br><span class="line">                <span class="comment">//如果包含</span></span><br><span class="line">                <span class="type">int</span> count=map.get(a);</span><br><span class="line">                map.put(a,++count);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                map.put(a,<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        tempMap=map;</span><br><span class="line">        <span class="type">char</span>[] sArr=s.toCharArray();</span><br><span class="line"></span><br><span class="line">        List&lt;Character&gt; list=<span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">        <span class="type">int</span> count=arr.length;</span><br><span class="line">        <span class="type">int</span> sCount=<span class="number">0</span>;</span><br><span class="line">        String result=<span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="type">int</span> min=Integer.MAX_VALUE;</span><br><span class="line">        <span class="keyword">for</span>(;right&lt;sArr.length;right++)&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(tempMap.containsKey(sArr[right]))&#123;</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> temp=tempMap.get(sArr[right]);</span><br><span class="line">                temp--;</span><br><span class="line">                <span class="keyword">if</span>(temp==<span class="number">0</span>)&#123;</span><br><span class="line">                    tempMap.remove(sArr[right]);</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    tempMap.put(sArr[right],temp);</span><br><span class="line">                &#125;</span><br><span class="line">                sCount++;</span><br><span class="line">            &#125;</span><br><span class="line">            list.add(sArr[right]);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(sCount==count)&#123;</span><br><span class="line">                min=min&gt;list.toString().length()?list.toString().length():min;</span><br><span class="line">                result=list.toString().length()&lt;=min? Arrays.toString(list.toArray()) :result;</span><br><span class="line">                <span class="keyword">if</span>(tempMap.containsKey(sArr[left]))&#123;</span><br><span class="line"></span><br><span class="line">                    <span class="type">int</span> temp=tempMap.get(sArr[left]);</span><br><span class="line">                    tempMap.put(sArr[left],++temp);</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    tempMap.put(sArr[left],<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                sCount--;</span><br><span class="line">                list.remove(left);</span><br><span class="line">                left++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="提交失败-6"   >
          <a href="#提交失败-6" class="heading-link"><i class="fas fa-link"></i></a><a href="#提交失败-6" class="headerlink" title="提交失败"></a>提交失败</h5>
      <p>CASE: s:”ADOBECODEBANC” t:”ABC”,输出”[A,D,O,B,E,C]”。预期输出”BANC”</p>

        <h5 id="原因-23"   >
          <a href="#原因-23" class="heading-link"><i class="fas fa-link"></i></a><a href="#原因-23" class="headerlink" title="原因"></a>原因</h5>
      <p>1.我还是没有解决数组变成字符串的问题</p>
<p>2.因为下标移动的时候没有从A移动到B，那么导致了list中存在DOBE…. 每次只删除了一个元素</p>

        <h4 id="第三次代码-8"   >
          <a href="#第三次代码-8" class="heading-link"><i class="fas fa-link"></i></a><a href="#第三次代码-8" class="headerlink" title="第三次代码"></a>第三次代码</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">minWindow</span><span class="params">(String s, String t)</span> &#123;</span><br><span class="line">        <span class="type">int</span> left=<span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> right=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>((t==<span class="literal">null</span> &amp;&amp; <span class="string">&quot;&quot;</span>.equals(t))||(s==<span class="literal">null</span> &amp;&amp; <span class="string">&quot;&quot;</span>.equals(s)))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">char</span>[] arr=t.toCharArray();</span><br><span class="line">        Map&lt;Character,Integer&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Character,Integer&gt; tempMap=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">char</span> a:arr)&#123;</span><br><span class="line">            <span class="keyword">if</span>(map.containsKey(a))&#123;</span><br><span class="line">                <span class="comment">//如果包含</span></span><br><span class="line">                <span class="type">int</span> count=map.get(a);</span><br><span class="line">                map.put(a,++count);</span><br><span class="line">                tempMap.put(a,++count);</span><br><span class="line"></span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                map.put(a,<span class="number">1</span>);</span><br><span class="line">                tempMap.put(a,<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">char</span>[] sArr=s.toCharArray();</span><br><span class="line"></span><br><span class="line">        LinkedList&lt;Character&gt; list=<span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">        <span class="type">int</span> count=arr.length;</span><br><span class="line">        <span class="type">int</span> sCount=<span class="number">0</span>;</span><br><span class="line">        String result=<span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="type">int</span> min=Integer.MAX_VALUE;</span><br><span class="line">        <span class="keyword">for</span>(;right&lt;sArr.length;right++)&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(map.containsKey(sArr[right]))&#123;</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> temp=map.get(sArr[right]);</span><br><span class="line">                temp--;</span><br><span class="line">                <span class="keyword">if</span>(temp==<span class="number">0</span>)&#123;</span><br><span class="line">                    tempMap.remove(sArr[right]);</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    tempMap.put(sArr[right],temp);</span><br><span class="line">                &#125;</span><br><span class="line">                sCount++;</span><br><span class="line">            &#125;</span><br><span class="line">            list.add(sArr[right]);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(sCount&gt;=count)&#123;</span><br><span class="line">                min=min&gt;list.toArray().length?list.toArray().length:min;</span><br><span class="line">                result=list.toArray().length&lt;=min? Arrays.toString(list.toArray()) :result;</span><br><span class="line">                <span class="keyword">while</span>(tempMap.size()&lt;=<span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (map.containsKey(sArr[left])) &#123;</span><br><span class="line">                        <span class="keyword">if</span>(tempMap.containsKey(sArr[left]))&#123;</span><br><span class="line">                            <span class="type">int</span> <span class="variable">temp</span> <span class="operator">=</span> tempMap.get(sArr[left]);</span><br><span class="line">                            tempMap.put(sArr[left], ++temp);</span><br><span class="line">                        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                            tempMap.put(sArr[left], <span class="number">1</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (tempMap.size() == <span class="number">2</span>) &#123;</span><br><span class="line">                        sCount--;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    list.removeFirst();</span><br><span class="line">                    left++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h5 id="提交失败-7"   >
          <a href="#提交失败-7" class="heading-link"><i class="fas fa-link"></i></a><a href="#提交失败-7" class="headerlink" title="提交失败"></a>提交失败</h5>
      <p>CASE: s:”ADOBECODEBANC” t:”ABC”,输出”[A,D,O,B,E,C]”。预期输出”BANC”</p>

        <h5 id="原因-24"   >
          <a href="#原因-24" class="heading-link"><i class="fas fa-link"></i></a><a href="#原因-24" class="headerlink" title="原因"></a>原因</h5>
      <p>我没能找到正确的索引下标移动，我中期一度卡在删除list元素中，然后发现删除的顺序和我插入元素的顺序不太一样？我后面用了removeFirst方法来删除第一个元素</p>

        <h4 id="第四次代码-4"   >
          <a href="#第四次代码-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#第四次代码-4" class="headerlink" title="第四次代码"></a>第四次代码</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">minWindow</span><span class="params">(String s, String t)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//输入判断</span></span><br><span class="line">        <span class="keyword">if</span>(s==<span class="literal">null</span>||<span class="string">&quot;&quot;</span>.equals(s) ||t==<span class="literal">null</span> || <span class="string">&quot;&quot;</span>.equals(t))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">char</span>[] sArr= s.toCharArray();</span><br><span class="line">        <span class="type">char</span>[] tArr= t.toCharArray();</span><br><span class="line">         </span><br><span class="line">        <span class="comment">//利用一个哈希map来记录目标子串的种类以及每个种类出现的次数</span></span><br><span class="line">        HashMap&lt;Character,Integer&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">char</span> c : tArr)&#123;</span><br><span class="line">            <span class="keyword">if</span>(map.containsKey(c))&#123;</span><br><span class="line">                <span class="comment">//如果是重复的字符 则添加个数</span></span><br><span class="line">                <span class="type">int</span> count=map.get(c);</span><br><span class="line">                map.put(c,++count);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//是第一次的字符则放入 Key=c ,Value=1</span></span><br><span class="line">                map.put(c,<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//用来记录一共有多少个目标子串</span></span><br><span class="line">        <span class="type">int</span> Type=map.size();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//滑动指针的双指针 </span></span><br><span class="line">        <span class="type">int</span> left=<span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> right=<span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//用一个getCount来代表滑动窗口中已经有的种类个数</span></span><br><span class="line">        <span class="type">int</span> getCount=<span class="number">0</span>;</span><br><span class="line">        <span class="comment">//定义一个哈希map来承接出现的子串以及子串个数</span></span><br><span class="line">        HashMap&lt;Character,Integer&gt; hsmap=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">int</span> min=Integer.MAX_VALUE;</span><br><span class="line">        String result=<span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="type">int</span> hscount=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(;right&lt;sArr.length;right++)&#123;</span><br><span class="line">            <span class="comment">//判断当前字符是不是在对照表map中</span></span><br><span class="line">            <span class="keyword">if</span>(map.containsKey(sArr[right]))&#123;</span><br><span class="line">                <span class="comment">//放入htmap中</span></span><br><span class="line">                <span class="keyword">if</span>(hsmap.containsKey(sArr[right]))&#123;</span><br><span class="line">                    <span class="comment">//如果有则更新个数</span></span><br><span class="line">                    <span class="type">int</span> count=hsmap.get(sArr[right]);</span><br><span class="line">                    hsmap.put(sArr[right],++count);</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="comment">//没有则不更新htmap中个数，但是更新种类个数</span></span><br><span class="line">                    hsmap.put(sArr[right],<span class="number">1</span>);</span><br><span class="line">                    getCount++;</span><br><span class="line">                &#125;</span><br><span class="line">                hscount++;</span><br><span class="line">            &#125;</span><br><span class="line">           <span class="keyword">while</span>(getCount==Type)&#123;</span><br><span class="line">                <span class="comment">//如果getCount==Type相等则说明滑动窗口已经覆盖了最小子串,移动左指针减去冗余个数</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">//如果这个元素是在t表中有的判断是否有冗余出现</span></span><br><span class="line">                <span class="keyword">if</span>(hsmap.containsKey(sArr[left]))&#123;</span><br><span class="line">                    <span class="comment">//如果left索引位置的元素在hsmap中的个数大于map中的个数说明多于了</span></span><br><span class="line">                    <span class="type">int</span> count=hsmap.get(sArr[left]);</span><br><span class="line">                    <span class="keyword">if</span>(hsmap.get(sArr[left])&gt;map.get(sArr[left]))&#123;</span><br><span class="line">                        count--;</span><br><span class="line">                        hsmap.put(sArr[left],count);</span><br><span class="line">                        left++;</span><br><span class="line">                        hscount--;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span>(count==map.get(sArr[left])) &#123;</span><br><span class="line">                        <span class="keyword">if</span>(hscount&gt;=tArr.length)&#123;</span><br><span class="line">                            min = min &gt; (right - left + <span class="number">1</span>) ? right - left + <span class="number">1</span> : min;</span><br><span class="line">                            result = min &gt;= (right - left + <span class="number">1</span>) ? s.substring(left, right + <span class="number">1</span>) : result;</span><br><span class="line">                            <span class="keyword">if</span>(count==<span class="number">1</span>)&#123;</span><br><span class="line">                                hsmap.remove(sArr[left]);</span><br><span class="line">                                getCount--;</span><br><span class="line">                                left++;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            count--;</span><br><span class="line">                            hsmap.put(sArr[left],count);</span><br><span class="line">                            hscount--;</span><br><span class="line">                            left++;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(count&lt;map.get(sArr[left]))&#123;</span><br><span class="line">                        <span class="comment">//说明不符合规定,应该移动右指针</span></span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//反之不在要求中的数据</span></span><br><span class="line">                left++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="提交错误-17"   >
          <a href="#提交错误-17" class="heading-link"><i class="fas fa-link"></i></a><a href="#提交错误-17" class="headerlink" title="提交错误"></a>提交错误</h5>
      <p>CASE：s:”aaaaaaaaaaaabbbbbcdd” t:”abcdd” 输出abbbbbcd 预期输出abbbbbcdd</p>

        <h5 id="原因-25"   >
          <a href="#原因-25" class="heading-link"><i class="fas fa-link"></i></a><a href="#原因-25" class="headerlink" title="原因"></a>原因</h5>
      <p>这里我还是看过视频之后写的，然后写了一两个小时改改停停还是改不出来，后面再看看其他用hashmap写的才知道自己哪里做错了</p>
<p>我这里Type就是当<strong>新的进来就直接认为是找到子串了实际上是不对的，要先类型有也要数量有</strong></p>

        <h3 id="题解-3"   >
          <a href="#题解-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#题解-3" class="headerlink" title="题解"></a>题解</h3>
      <p><strong>代码</strong></p>
<p>这里还是用了<strong>双指针</strong>的<strong>滑动窗口</strong>思想</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">minWindow</span><span class="params">(String s, String t)</span> &#123;</span><br><span class="line">        <span class="comment">//最小子串起始索引</span></span><br><span class="line">        <span class="type">int</span> start=<span class="number">0</span>;</span><br><span class="line">        <span class="comment">//最小子串长度</span></span><br><span class="line">        <span class="type">int</span> min=Integer.MAX_VALUE;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//双指针</span></span><br><span class="line">        <span class="type">int</span> left=<span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> right=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//这是目标t中需要的字符串种类以及个数</span></span><br><span class="line">        Map&lt;Character,Integer&gt; needs=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//这是滑动窗口用的hsmap</span></span><br><span class="line">        Map&lt;Character,Integer&gt; windows=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//遍历t数组给needs赋值</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">char</span> ch:t.toCharArray())&#123;</span><br><span class="line">            needs.put(ch,needs.getOrDefault(ch,<span class="number">0</span>)+<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//用于记录符合个数且类型的个数</span></span><br><span class="line">        <span class="type">int</span> match=<span class="number">0</span>;</span><br><span class="line">        <span class="comment">//循环开始找子串</span></span><br><span class="line">        <span class="keyword">while</span>(right&lt;s.length())&#123;</span><br><span class="line">            <span class="comment">//先获取当前right位置的字符</span></span><br><span class="line">            <span class="type">char</span> c1=s.charAt(right);</span><br><span class="line">            <span class="comment">//判断needs中是否包含c1这个字符串,如果是说明是我们需要的</span></span><br><span class="line">            <span class="keyword">if</span>(needs.containsKey(c1))&#123;</span><br><span class="line">                <span class="comment">//needs中包含c1这个字符串</span></span><br><span class="line">                <span class="comment">//将其放入滑动窗口中 相同则累加个数</span></span><br><span class="line">                windows.put(c1,windows.getOrDefault(c1,<span class="number">0</span>)+<span class="number">1</span>);</span><br><span class="line">                <span class="comment">// 判断滑动窗口中个数是否达到要求个数</span></span><br><span class="line">                <span class="keyword">if</span>(windows.get(c1).equals(needs.get(c1)))&#123;</span><br><span class="line">                    <span class="comment">//达到了则match++;</span></span><br><span class="line">                    match++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//右指针向右移动</span></span><br><span class="line">            right++;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 内循环用于滑动左指针 ,count等于needs.size说明每个都符合条件了</span></span><br><span class="line">            <span class="keyword">while</span>(match==needs.size())&#123;</span><br><span class="line">                <span class="comment">// //记录当前的字符串长度</span></span><br><span class="line">                <span class="comment">// min= min&gt;=(right-left) ? right-left : min;</span></span><br><span class="line">                <span class="comment">// //记录最小子串的起始位置</span></span><br><span class="line">                <span class="comment">// start=(right-left)&lt;=min? left:start;</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(right-left&lt;min)&#123;</span><br><span class="line">                    min=right-left;</span><br><span class="line">                    start=left;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="comment">//滑动左指针</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">//先获取当前left对应的字符</span></span><br><span class="line">                <span class="type">char</span> c2=s.charAt(left);</span><br><span class="line">                <span class="comment">//判断这个字符串是不是needs中的</span></span><br><span class="line">                <span class="keyword">if</span>(needs.containsKey(c2))&#123;</span><br><span class="line">                    <span class="comment">//将滑动窗口中的子串向右移动</span></span><br><span class="line">                    windows.put(c2,windows.get(c2)-<span class="number">1</span>);</span><br><span class="line">                    <span class="comment">//计数器--</span></span><br><span class="line">                    <span class="keyword">if</span>(windows.get(c2)&lt;needs.get(c2))&#123;</span><br><span class="line">                        match--;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//左指针向右移动</span></span><br><span class="line">                left++;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> min==Integer.MAX_VALUE? <span class="string">&quot;&quot;</span>: s.substring(start,start+min);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="总结-9"   >
          <a href="#总结-9" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结-9" class="headerlink" title="总结"></a>总结</h3>
      <p>这个题不愧是hard难度我只能说，从第一波自己写写了快两小时但是还是频繁出错，然后看官方答案我看不懂但是大概知道了思路，然后我想用hashmap把它写出来 一写就勾八写了一个多小时还没做错了 大概测试用例还有40多道，然后我去b站看了好几个视频，有C++的有Go的还有Java的 总算是差不多把自己心中想的和看得懂的写出来了，这道题真得多练练，不练真不会做</p>

        <h3 id="踩坑点"   >
          <a href="#踩坑点" class="heading-link"><i class="fas fa-link"></i></a><a href="#踩坑点" class="headerlink" title="踩坑点"></a>踩坑点</h3>
      <p>①这个match值应该是<strong>种类要相同并且个数相同</strong>才能++，我自己做就因为种类相同就认为找到了最小子串</p>
<p>②<strong>windows.get(c1).equals(needs.get(c1))<strong>，这里不能写成windos(get(c1))&#x3D;&#x3D;windos(get(c2))。因为这里get出来的值是Integet类型，底部有-128，127的缓存数组，但是超过这个返回会new一个对象，所以</strong>&#x3D;&#x3D;比较的时候会比较地址值而不是比较数值</strong>测试用例不通过，得用equals方法才能测试通过</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/08/04/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-JUC%E7%AF%87%5B3-CAS%E3%80%81Unsafe%E3%80%81ThreadLocal%5D/">深入剖析并发编程-JUC篇[3-CAS、Unsafe、ThreadLocal]</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-08-04</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">59</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">1分</span></span></div></header><div class="post-body"><div class="post-excerpt"><p><strong>CAS机制原理、Unsafe魔法类、ThreadLocal线程变量</strong></p>
<hr>
<ul>
<li>第一篇是JUC并发编程基础</li>
<li>第二篇是JMM、Volatile关键字、synchronize锁详解</li>
<li>第三篇是CAS机制原理、Unsafe魔法类、ThreadLocal线程变量</li>
</ul>
<hr>

        <h1 id="CAS"   >
          <a href="#CAS" class="heading-link"><i class="fas fa-link"></i></a><a href="#CAS" class="headerlink" title="CAS"></a>CAS</h1>
      
        <h1 id="Unsafe"   >
          <a href="#Unsafe" class="heading-link"><i class="fas fa-link"></i></a><a href="#Unsafe" class="headerlink" title="Unsafe"></a>Unsafe</h1>
      
        <h1 id="ThreadLocal"   >
          <a href="#ThreadLocal" class="heading-link"><i class="fas fa-link"></i></a><a href="#ThreadLocal" class="headerlink" title="ThreadLocal"></a>ThreadLocal</h1>
      </div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/08/03/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-JUC%E7%AF%87%5B2-JMM%E3%80%81Volatile%E3%80%81Synchronized%5D/">深入剖析并发编程-JUC篇[2-JMM、Volatile、Synchronized]</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-08-03</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">17.2k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">171分</span></span></div></header><div class="post-body"><div class="post-excerpt"><p> <strong>JMM、Volatile关键字、Synchronized锁详解</strong></p>
<hr>
<ul>
<li>第一篇是JUC并发编程基础</li>
<li>第二篇是JMM、Volatile关键字、synchronize锁详解</li>
<li>第三篇是CAS机制原理、Unsafe魔法类、ThreadLocal线程变量</li>
</ul>
<hr>

        <h1 id="JMM模型"   >
          <a href="#JMM模型" class="heading-link"><i class="fas fa-link"></i></a><a href="#JMM模型" class="headerlink" title="JMM模型"></a>JMM模型</h1>
      <p>JMM：即Java内存模型，JMM是JVM的一部分，JMM是一种抽象的概念</p>

        <h2 id="JMM的三大特性"   >
          <a href="#JMM的三大特性" class="heading-link"><i class="fas fa-link"></i></a><a href="#JMM的三大特性" class="headerlink" title="JMM的三大特性"></a>JMM的三大特性</h2>
      
        <h3 id="①原子性"   >
          <a href="#①原子性" class="heading-link"><i class="fas fa-link"></i></a><a href="#①原子性" class="headerlink" title="①原子性"></a>①原子性</h3>
      <p>对共享变量的读取和写入是原子操作，Read和Load是一组原子操作，Store和Write是原子操作</p>

        <h3 id="②有序性"   >
          <a href="#②有序性" class="heading-link"><i class="fas fa-link"></i></a><a href="#②有序性" class="headerlink" title="②有序性"></a>②有序性</h3>
      <p>StoreBuffer的先进先出性质保证了有序性</p>

        <h3 id="③可见性"   >
          <a href="#③可见性" class="heading-link"><i class="fas fa-link"></i></a><a href="#③可见性" class="headerlink" title="③可见性"></a>③可见性</h3>
      <p>内存屏障保证了可见性</p>
<p>而JMM中用Volatile关键字可以导致数据可见、除此之外synchronized锁也能保证</p>
<p>八种交互模式</p>
<ul>
<li><p>Lock （锁定）：锁定，将主内存中的变量锁定成当前线程持有</p>
</li>
<li><p>Read（读取）：将内存中的数据刷到工作区中</p>
</li>
<li><p>Load（加载）：将工作区的变量放到工作区的副本变量中</p>
</li>
<li><p>use  （使用）：将工作区的变量放到CPU执行区域</p>
</li>
<li><p>Assian（赋值）：将修改后的数据赋值给工作区的副本变量中</p>
</li>
<li><p>Store（存储）：将工作内存的变量刷到主内存中</p>
</li>
<li><p>Write（写入）:  将Store刷出的值写到主内存中</p>
</li>
<li><p>Unlock（解锁）：解锁，将锁释放以便其他线程可以使用</p>
<p><em>JMM</em>工作流程</p>
</li>
</ul>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230801192534473.png"  alt="JMM工作流程">
      </p>
<p>要注意的是，在JMM模型中没有Invalidate Queues，所以没有Load Load问题，只有Store Load的问题，</p>
<p>接下来我们重点介绍Volatile关键字和Synchronized锁</p>

        <h1 id="volatile关键字"   >
          <a href="#volatile关键字" class="heading-link"><i class="fas fa-link"></i></a><a href="#volatile关键字" class="headerlink" title="volatile关键字"></a>volatile关键字</h1>
      <p>Volatile关键字可以导致共享变量的可见性，而我们通过JUC并发编程基础那块分析得出，当JMM的共享变量的可见性只要保证StoreBuffer的数据能刷到Cache中，就会因为MESI协议和嗅探机制更新其他线程的数据</p>
<p>综上所述，Valatile关键字就是确保StoreBuffer的数据能刷到Cache中，其作用的就是添加了屏障，这里添加的是编译器屏障</p>
<p>抛开代码谈理论无异于耍流氓，我们从一个程序开始看起！</p>

        <h2 id="使用场景"   >
          <a href="#使用场景" class="heading-link"><i class="fas fa-link"></i></a><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h2>
      
        <h3 id="场景一：没有添加volatile关键字"   >
          <a href="#场景一：没有添加volatile关键字" class="heading-link"><i class="fas fa-link"></i></a><a href="#场景一：没有添加volatile关键字" class="headerlink" title="场景一：没有添加volatile关键字"></a>场景一：没有添加volatile关键字</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span>&#123;</span><br><span class="line">	<span class="comment">//定义一个变量a，不给a赋值，初始化之后a应该是0</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> a;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//重写Run方法 当a不为0X1111的时候进入循环</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span>(a!=<span class="number">0x1111</span>)&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//创建线程然后执行run方法</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">TestThread</span>().start();</span><br><span class="line">        <span class="comment">//线程睡一秒</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//将a赋值为0X1111</span></span><br><span class="line">        a=<span class="number">0x1111</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>运行结果是该线程没有结束
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230801211011188.png"  alt="场景一结果">
      </p>

        <h3 id="场景二：添加了Volatile关键字"   >
          <a href="#场景二：添加了Volatile关键字" class="heading-link"><i class="fas fa-link"></i></a><a href="#场景二：添加了Volatile关键字" class="headerlink" title="场景二：添加了Volatile关键字"></a>场景二：添加了Volatile关键字</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestThread</span> <span class="keyword">extends</span>  <span class="title class_">Thread</span>&#123;</span><br><span class="line">	<span class="comment">//给a添加Volatile使其可见</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="type">int</span> a;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span>(a!=<span class="number">0x1111</span>)&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">TestThread</span>().start();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        a=<span class="number">0x1111</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>运行结果是线程已经结束</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230801211221395.png"  alt="场景二结果">
      </p>

        <h3 id="场景三：没加Volatile但是禁止JIT优化"   >
          <a href="#场景三：没加Volatile但是禁止JIT优化" class="heading-link"><i class="fas fa-link"></i></a><a href="#场景三：没加Volatile但是禁止JIT优化" class="headerlink" title="场景三：没加Volatile但是禁止JIT优化"></a>场景三：没加Volatile但是禁止JIT优化</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">添加VM参数：-Djava.compiler=NONE  <span class="comment">//禁止JIT优化</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span>  <span class="type">int</span> a;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span>(a!=<span class="number">0x1111</span>)&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">TestThread</span>().start();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        a=<span class="number">0x1111</span>;</span><br><span class="line">    &#125;   </span><br></pre></td></tr></table></div></figure>

<p>运行结果是线程已经结束
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230801213142690.png"  alt="场景三结果">
      </p>

        <h3 id="场景四-没加Volatile但是加了Unsafe-loadFence"   >
          <a href="#场景四-没加Volatile但是加了Unsafe-loadFence" class="heading-link"><i class="fas fa-link"></i></a><a href="#场景四-没加Volatile但是加了Unsafe-loadFence" class="headerlink" title="场景四:没加Volatile但是加了Unsafe.loadFence();"></a>场景四:没加Volatile但是加了Unsafe.loadFence();</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestThread</span> <span class="keyword">extends</span>  <span class="title class_">Thread</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span>  <span class="type">int</span> a;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span>(a!=<span class="number">0x1111</span>)&#123;</span><br><span class="line">            UnsafeUtils.getUnsafe().loadFence();</span><br><span class="line">            <span class="comment">//利用UnsafeUtils.getUnsafe()获得Unsafe实例</span></span><br><span class="line">            <span class="comment">//调用loadFence()方法 也就是添加了编译器屏障</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    //读屏障	</span></span><br><span class="line"><span class="comment">    public native void loadFence();</span></span><br><span class="line"><span class="comment">	//写屏障</span></span><br><span class="line"><span class="comment">    public native void storeFence();</span></span><br><span class="line"><span class="comment">	//全屏障</span></span><br><span class="line"><span class="comment">    public native void fullFence();</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">TestThread</span>().start();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        a=<span class="number">0x1111</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>运行结果是线程已经结束
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230801213734565.png"  alt="image-20230801213734565">
      </p>

        <h2 id="分析"   >
          <a href="#分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#分析" class="headerlink" title="分析"></a>分析</h2>
      <p>只有第一种情况下没有结束进程，我们可以通过JVM调优的指令可以获取当前执行的线程验证。</p>

        <h3 id="①获取运行中线程"   >
          <a href="#①获取运行中线程" class="heading-link"><i class="fas fa-link"></i></a><a href="#①获取运行中线程" class="headerlink" title="①获取运行中线程"></a>①获取运行中线程</h3>
      <div class="table-container"><table>
<thead>
<tr>
<th>常见指令</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>jps</td>
<td>用于获得系统中运行中的java进程</td>
</tr>
<tr>
<td>jinfo <pid></td>
<td>显示指定线程的详情信息</td>
</tr>
<tr>
<td>jstat -gc <pid> (ms)</td>
<td>获得JVM各区域详情 参数一:指定进程号 参数二:每xx毫秒刷新输出</td>
</tr>
<tr>
<td>jstack <pid></td>
<td>跟踪线程中的堆栈信息</td>
</tr>
<tr>
<td>jmap -histo <pid></td>
<td>获得指定线程中实例对象个数和所占字节数<br/>#!!</td>
</tr>
</tbody></table></div>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230801214538319.png"  alt="image-20230801214538319">
      </p>
<p>我们可以清楚看出TestThread线程Thread-0正在运行</p>

        <h3 id="②打印汇编语言"   >
          <a href="#②打印汇编语言" class="heading-link"><i class="fas fa-link"></i></a><a href="#②打印汇编语言" class="headerlink" title="②打印汇编语言"></a>②打印汇编语言</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:+UnlockDiagnosticVMOptions -XX:+PrintAssembly <span class="comment">//开启控制台输出汇编语言</span></span><br></pre></td></tr></table></div></figure>

<p>我们可以在打印出的汇编记录中，可以查找数据，看个大概就是先比较之后然后经过多次跳转之后，A指向B地址，B之后跳转会指向A地址，造成一个死循环</p>
<p>这是JIT在对热点代码的优化</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//我们的热点代码</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span>(a!=<span class="number">0x1111</span>)&#123;</span><br><span class="line"><span class="comment">//            UnsafeUtils.getUnsafe().loadFence();</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment">//经过优化之后大概变成</span></span><br><span class="line">	<span class="keyword">do</span>(a!=<span class="number">0x1111</span>)&#123;</span><br><span class="line">		<span class="comment">//只做一次判断然后进入死循环</span></span><br><span class="line">	&#125;<span class="keyword">while</span>(<span class="literal">true</span>)</span><br></pre></td></tr></table></div></figure>

<p>而加入Volatile关键字就是防止编译器对代码进行优化，且通过屏障将变量刷到Cache中</p>
<p><em>即Volatile&#x3D;&#x3D;UnsafeUtils.getUnsafe().loadFence()</em></p>
<p>我们可以从源代码这块开始看，首先获取字节码指令</p>

        <h3 id="③打印字节码指令"   >
          <a href="#③打印字节码指令" class="heading-link"><i class="fas fa-link"></i></a><a href="#③打印字节码指令" class="headerlink" title="③打印字节码指令"></a>③打印字节码指令</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">利用javaP -c 来输出字节码指令</span><br></pre></td></tr></table></div></figure>

<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230801235858520.png"  alt="image-20230801235858520">
      </p>
<p>可以知道调用的getstatic方法是主要关注的</p>
<p>我们打开HotSprot的源码查找getstatic方法</p>
<p>不过不会C++，只能看英文和上下文一点一点理解</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line">  <span class="built_in">CASE</span>(_getstatic):</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//获得一个索引值</span></span><br><span class="line">      u2 index;</span><br><span class="line">        <span class="comment">//获取一个Cache</span></span><br><span class="line">      ConstantPoolCacheEntry* cache;</span><br><span class="line">        <span class="comment">//在这里看到了PC+1，所以合理猜测这个是index是程序计数器，然后计数器+1</span></span><br><span class="line">      index = Bytes::<span class="built_in">get_native_u2</span>(pc+<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// QQQ Need to make this as inlined as possible. Probably need to</span></span><br><span class="line">      <span class="comment">// split all the bytecode cases out so c++ compiler has a chance</span></span><br><span class="line">      <span class="comment">// for constant prop to fold everything possible away.</span></span><br><span class="line">      </span><br><span class="line">        <span class="comment">//从cp中获取一个entry放到Cache中</span></span><br><span class="line">      cache = cp-&gt;<span class="built_in">entry_at</span>(index);</span><br><span class="line">        <span class="comment">//如果这个没有被解析过 那就给他解析下</span></span><br><span class="line">      <span class="keyword">if</span> (!cache-&gt;<span class="built_in">is_resolved</span>((Bytecodes::Code)opcode)) &#123;</span><br><span class="line">        <span class="built_in">CALL_VM</span>(InterpreterRuntime::<span class="built_in">resolve_get_put</span>(THREAD, (Bytecodes::Code)opcode),</span><br><span class="line">                handle_exception);</span><br><span class="line">        cache = cp-&gt;<span class="built_in">entry_at</span>(index);</span><br><span class="line">      &#125;</span><br><span class="line">        <span class="comment">//总之走到这里Cache拿了一个值</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> VM_JVMTI</span></span><br><span class="line">        <span class="comment">//判断这个是不是一个中断事件，我们这里没有产生中断，所以不进这个IF语句</span></span><br><span class="line">          <span class="keyword">if</span> (_jvmti_interp_events) &#123;</span><br><span class="line">            <span class="type">int</span> *count_addr;</span><br><span class="line">            oop obj;</span><br><span class="line">            <span class="comment">// Check to see if a field modification watch has been set</span></span><br><span class="line">            <span class="comment">// before we take the time to call into the VM.</span></span><br><span class="line">            count_addr = (<span class="type">int</span> *)JvmtiExport::<span class="built_in">get_field_access_count_addr</span>();</span><br><span class="line">            <span class="keyword">if</span> ( *count_addr &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">              <span class="keyword">if</span> ((Bytecodes::Code)opcode == Bytecodes::_getstatic) &#123;</span><br><span class="line">                obj = (oop)<span class="literal">NULL</span>;</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                obj = (oop) <span class="built_in">STACK_OBJECT</span>(<span class="number">-1</span>);</span><br><span class="line">                <span class="built_in">VERIFY_OOP</span>(obj);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="built_in">CALL_VM</span>(InterpreterRuntime::<span class="built_in">post_field_access</span>(THREAD,</span><br><span class="line">                                          obj,</span><br><span class="line">                                          cache),</span><br><span class="line">                                          handle_exception);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* VM_JVMTI */</span></span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//获得一个Object对象</span></span><br><span class="line">          oop obj;</span><br><span class="line">        <span class="comment">//如果这个是个静态对象那么就应该从静态区获取对象</span></span><br><span class="line">          <span class="keyword">if</span> ((Bytecodes::Code)opcode == Bytecodes::_getstatic) &#123;</span><br><span class="line">              <span class="comment">//获取了一个Klass ，理解成Class模板</span></span><br><span class="line">            Klass* k = cache-&gt;<span class="built_in">f1_as_klass</span>();</span><br><span class="line">              <span class="comment">//将k的指向的静态对象给obj</span></span><br><span class="line">            obj = k-&gt;<span class="built_in">java_mirror</span>();</span><br><span class="line">            <span class="built_in">MORE_STACK</span>(<span class="number">1</span>);  <span class="comment">// Assume single slot push</span></span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="comment">//反之这个是个实例对象，那么从Stack栈中的对象引用到堆里的对象取出给obj</span></span><br><span class="line">            obj = (oop) <span class="built_in">STACK_OBJECT</span>(<span class="number">-1</span>);</span><br><span class="line">              <span class="comment">//检查这个OBJ是否为空</span></span><br><span class="line">            <span class="built_in">CHECK_NULL</span>(obj);</span><br><span class="line">          &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//上面这块步骤主要是拿到一个OBJ对象</span></span><br><span class="line"></span><br><span class="line">          <span class="comment">// 现在存结果在这个栈中</span></span><br><span class="line">          <span class="comment">// Now store the result on the stack</span></span><br><span class="line">          <span class="comment">//</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//获得了一个状态</span></span><br><span class="line">          TosState tos_type = cache-&gt;<span class="built_in">flag_state</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//获得一个偏移量</span></span><br><span class="line">          <span class="type">int</span> field_offset = cache-&gt;<span class="built_in">f2_as_index</span>();</span><br><span class="line">        <span class="comment">//如果这个cache是volatile修饰的</span></span><br><span class="line">          <span class="keyword">if</span> (cache-&gt;<span class="built_in">is_volatile</span>()) &#123;</span><br><span class="line">              <span class="comment">//CPU_NOT_MULTIPLE_COPY_ATOMIC  现在是单原子的就执行Fence() 即屏障</span></span><br><span class="line">            <span class="keyword">if</span> (support_IRIW_for_not_multiple_copy_atomic_cpu) &#123;</span><br><span class="line">              OrderAccess::<span class="built_in">fence</span>();</span><br><span class="line">            &#125;</span><br><span class="line">              <span class="comment">//判断现在是个什么类型 我们现在传入的是Int类型数据 所以直接进入int_field_acquire</span></span><br><span class="line">            <span class="keyword">if</span> (tos_type == atos) &#123;</span><br><span class="line">              <span class="built_in">VERIFY_OOP</span>(obj-&gt;<span class="built_in">obj_field_acquire</span>(field_offset));</span><br><span class="line">              <span class="built_in">SET_STACK_OBJECT</span>(obj-&gt;<span class="built_in">obj_field_acquire</span>(field_offset), <span class="number">-1</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tos_type == itos) &#123;</span><br><span class="line">                <span class="comment">//我们要进入这个分支</span></span><br><span class="line">              <span class="built_in">SET_STACK_INT</span>(obj-&gt;<span class="built_in">int_field_acquire</span>(field_offset), <span class="number">-1</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tos_type == ltos) &#123;</span><br><span class="line">              <span class="built_in">SET_STACK_LONG</span>(obj-&gt;<span class="built_in">long_field_acquire</span>(field_offset), <span class="number">0</span>);</span><br><span class="line">              <span class="built_in">MORE_STACK</span>(<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tos_type == btos) &#123;</span><br><span class="line">              <span class="built_in">SET_STACK_INT</span>(obj-&gt;<span class="built_in">byte_field_acquire</span>(field_offset), <span class="number">-1</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tos_type == ctos) &#123;</span><br><span class="line">              <span class="built_in">SET_STACK_INT</span>(obj-&gt;<span class="built_in">char_field_acquire</span>(field_offset), <span class="number">-1</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tos_type == stos) &#123;</span><br><span class="line">              <span class="built_in">SET_STACK_INT</span>(obj-&gt;<span class="built_in">short_field_acquire</span>(field_offset), <span class="number">-1</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tos_type == ftos) &#123;</span><br><span class="line">              <span class="built_in">SET_STACK_FLOAT</span>(obj-&gt;<span class="built_in">float_field_acquire</span>(field_offset), <span class="number">-1</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="built_in">SET_STACK_DOUBLE</span>(obj-&gt;<span class="built_in">double_field_acquire</span>(field_offset), <span class="number">0</span>);</span><br><span class="line">              <span class="built_in">MORE_STACK</span>(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="comment">//走到这里即说明这个类型不是被volatile修饰</span></span><br><span class="line">            <span class="keyword">if</span> (tos_type == atos) &#123;</span><br><span class="line">              <span class="built_in">VERIFY_OOP</span>(obj-&gt;<span class="built_in">obj_field</span>(field_offset));</span><br><span class="line">              <span class="built_in">SET_STACK_OBJECT</span>(obj-&gt;<span class="built_in">obj_field</span>(field_offset), <span class="number">-1</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tos_type == itos) &#123;</span><br><span class="line">              <span class="built_in">SET_STACK_INT</span>(obj-&gt;<span class="built_in">int_field</span>(field_offset), <span class="number">-1</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tos_type == ltos) &#123;</span><br><span class="line">              <span class="built_in">SET_STACK_LONG</span>(obj-&gt;<span class="built_in">long_field</span>(field_offset), <span class="number">0</span>);</span><br><span class="line">              <span class="built_in">MORE_STACK</span>(<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tos_type == btos) &#123;</span><br><span class="line">              <span class="built_in">SET_STACK_INT</span>(obj-&gt;<span class="built_in">byte_field</span>(field_offset), <span class="number">-1</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tos_type == ctos) &#123;</span><br><span class="line">              <span class="built_in">SET_STACK_INT</span>(obj-&gt;<span class="built_in">char_field</span>(field_offset), <span class="number">-1</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tos_type == stos) &#123;</span><br><span class="line">              <span class="built_in">SET_STACK_INT</span>(obj-&gt;<span class="built_in">short_field</span>(field_offset), <span class="number">-1</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tos_type == ftos) &#123;</span><br><span class="line">              <span class="built_in">SET_STACK_FLOAT</span>(obj-&gt;<span class="built_in">float_field</span>(field_offset), <span class="number">-1</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="built_in">SET_STACK_DOUBLE</span>(obj-&gt;<span class="built_in">double_field</span>(field_offset), <span class="number">0</span>);</span><br><span class="line">              <span class="built_in">MORE_STACK</span>(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//更新计数器然后继续</span></span><br><span class="line">          <span class="built_in">UPDATE_PC_AND_CONTINUE</span>(<span class="number">3</span>);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//我们要走到int_field_acquire方法的实现</span></span><br><span class="line"><span class="comment">//而int_field_acquire底层调用了Load_acquire方法</span></span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>这里可能是因为我的原因导致这一块代码找不到，我选择从网上找了一下老版本的代码 不过实现思路应该是一样的</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title">compiler_barrier</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> <span class="function">__asm__ <span class="title">volatile</span> <span class="params">(<span class="string">&quot;&quot;</span> : : : <span class="string">&quot;memory&quot;</span>)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">OrderAccess::loadload</span><span class="params">()</span>   </span>&#123; <span class="built_in">compiler_barrier</span>(); &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">OrderAccess::storestore</span><span class="params">()</span> </span>&#123;<span class="built_in">compiler_barrier</span>(); &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">OrderAccess::loadstore</span><span class="params">()</span>  </span>&#123; <span class="built_in">compiler_barrier</span>(); &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">OrderAccess::storeload</span><span class="params">()</span>  </span>&#123; <span class="built_in">fence</span>();            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">OrderAccess::acquire</span><span class="params">()</span>    </span>&#123; <span class="built_in">compiler_barrier</span>(); &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">OrderAccess::release</span><span class="params">()</span>    </span>&#123; <span class="built_in">compiler_barrier</span>(); &#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">OrderAccess::fence</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(os::<span class="built_in">is_MP</span>()) &#123;</span><br><span class="line">    <span class="comment">//always use locked addl since mfence is sometimes expensive</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> AMD64</span></span><br><span class="line">   <span class="function">__asm__ <span class="title">volatile</span> <span class="params">(<span class="string">&quot;lock; addl $0,0(%%rsp)&quot;</span> : : :<span class="string">&quot;cc&quot;</span>, <span class="string">&quot;memory&quot;</span>)</span></span>;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">   <span class="function">__asm__ <span class="title">volatile</span> <span class="params">(<span class="string">&quot;lock; addl $0,0(%%esp)&quot;</span> : : :<span class="string">&quot;cc&quot;</span>, <span class="string">&quot;memory&quot;</span>)</span></span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  &#125;</span><br><span class="line"> <span class="built_in">compiler_barrier</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/w329636271/article/details/54616543/" >后面这块代码来源于CSDN博主</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>在底层是通过加屏障的方式实现这个数据的可见性</p>

        <h2 id="总结"   >
          <a href="#总结" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结" class="headerlink" title="总结"></a>总结</h2>
      <p>Volatile关键字实现数据的可见性主要是依靠了加编译器屏障，防止JIT对其优化。最终可以导致数据的</p>

        <h1 id="Synchronized锁"   >
          <a href="#Synchronized锁" class="heading-link"><i class="fas fa-link"></i></a><a href="#Synchronized锁" class="headerlink" title="Synchronized锁"></a>Synchronized锁</h1>
      <p>首先我们得先明白对象的构成，以及Synchronized锁的类型</p>

        <h2 id="Object对象以及锁的级别"   >
          <a href="#Object对象以及锁的级别" class="heading-link"><i class="fas fa-link"></i></a><a href="#Object对象以及锁的级别" class="headerlink" title="Object对象以及锁的级别"></a>Object对象以及锁的级别</h2>
      <p>Object对象在存储的时候有<strong>对象头信息</strong>、<strong>数据</strong>、对齐填充信息</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230802160057306.png"  alt="Object对象">
      </p>
<p>而对象头信息 我们可以从源码中获取得知对象头信息是怎么组成的，我们这里主要关注64位的</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  32 bits:</span></span><br><span class="line"><span class="comment">//  --------</span></span><br><span class="line"><span class="comment">//             hash:25 ------------&gt;| age:4    biased_lock:1 lock:2 (normal object)</span></span><br><span class="line"><span class="comment">//             JavaThread*:23 epoch:2 age:4    biased_lock:1 lock:2 (biased object)</span></span><br><span class="line"><span class="comment">//             size:32 ------------------------------------------&gt;| (CMS free block)</span></span><br><span class="line"><span class="comment">//             PromotedObject*:29 ----------&gt;| promo_bits:3 -----&gt;| (CMS promoted object)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  64 bits:</span></span><br><span class="line"><span class="comment">//  --------</span></span><br><span class="line"><span class="comment">//  unused:25 hash:31 --&gt;| unused:1   age:4    biased_lock:1 lock:2 (normal object)</span></span><br><span class="line"><span class="comment">//  JavaThread*:54 epoch:2 unused:1   age:4    biased_lock:1 lock:2 (biased object)</span></span><br><span class="line"><span class="comment">//  PromotedObject*:61 ---------------------&gt;| promo_bits:3 -----&gt;| (CMS promoted object)</span></span><br><span class="line"><span class="comment">//  size:64 -----------------------------------------------------&gt;| (CMS free block)</span></span><br></pre></td></tr></table></div></figure>

<p>共六十四位</p>
<ul>
<li><p>25位无使用位</p>
</li>
<li><p>31位哈希</p>
</li>
<li><p>1位是否被使用标记</p>
</li>
<li><p>4位age</p>
</li>
<li><p>1位是否为偏向锁</p>
</li>
<li><p>2位锁状态</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230802162051207.png"  alt="对象头">
      </p>
</li>
</ul>
<p>接下来就是synchronized锁的级别</p>
<p>一共有四个状态 ，而对象头中有3位来表示锁的信息 一位偏向锁标志位，两位表示锁状态</p>
<ul>
<li>无锁：在对象头信息为0 01</li>
<li>偏向锁：在对象头信息为 1 01，偏向锁是当锁没有竞争压力的时候并且多次由同一个线程获取，为了减少多次CAS的操作就引入了偏向锁，偏向锁会偏向获得它的第一个线程，类似于初恋。</li>
<li>轻量级锁：在对象头信息为 0 00，轻量级锁是获得锁的时候一开始就会获得一个轻量级锁，升级为轻量级锁的时候会撤销偏向锁，当获取轻量级锁失败之后会自旋(自适应自旋)，如果CAS失败会走轻量级锁升级的过程</li>
<li>重量级锁：在对象头信息为 1 10，重量级锁是经过锁升级之后也就是我们常说的锁，重量级锁是竞争激烈的锁，重量级锁中有一个cxq阻塞队列，当线程获取锁失败后会进阻塞队列等待</li>
</ul>
<div class="table-container"><table>
<thead>
<tr>
<th>锁级别</th>
<th>是否为偏向锁</th>
<th>锁状态</th>
</tr>
</thead>
<tbody><tr>
<td>无锁态</td>
<td>0</td>
<td>01</td>
</tr>
<tr>
<td>偏向锁</td>
<td>1</td>
<td>01</td>
</tr>
<tr>
<td>轻量级锁</td>
<td></td>
<td>00</td>
</tr>
<tr>
<td>重量级锁</td>
<td></td>
<td>10</td>
</tr>
<tr>
<td>GC标记</td>
<td></td>
<td>11</td>
</tr>
</tbody></table></div>
<p>接下来我们要从代码开始分析了</p>
<p>一个很简单的程序，主要是添加了Synchronzied锁，这样的话就能从字节码文件中获取信息</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestThread</span> <span class="keyword">extends</span>  <span class="title class_">Thread</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">TestThread</span>().start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>用JavaP -C反编译获得字节码信息</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">利用javaP -c 来输出字节码指令</span><br></pre></td></tr></table></div></figure>

<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public void run();</span><br><span class="line">    Code:</span><br><span class="line">       0: aload_0</span><br><span class="line">       1: dup</span><br><span class="line">       2: astore_1</span><br><span class="line">       3: monitorenter</span><br><span class="line">       4: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">       7: ldc           #3                  // String hello</span><br><span class="line">       9: invokevirtual #4                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><span class="line">      12: aload_1</span><br><span class="line">      13: monitorexit</span><br><span class="line">      14: goto          22</span><br><span class="line">      17: astore_2</span><br><span class="line">      18: aload_1</span><br><span class="line">      19: monitorexit</span><br><span class="line">      20: aload_2</span><br><span class="line">      21: athrow</span><br><span class="line">      22: return</span><br></pre></td></tr></table></div></figure>

<p>而重点要关注的是monitorenter和monitorexit</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">3: monitorenter</span><br><span class="line">13: monitorexit</span><br><span class="line">19: monitorexit</span><br></pre></td></tr></table></div></figure>

<p>一次Monitorenter怎么会出现两次monitorexit呢？</p>
<p>原因是第二个monitorexit在finally代码块中，防止出现异常导致没有到达第一个monitorexit</p>
<p>而接下来我们要先进去看monitorenter方法</p>

        <h2 id="monitorenter"   >
          <a href="#monitorenter" class="heading-link"><i class="fas fa-link"></i></a><a href="#monitorenter" class="headerlink" title="monitorenter"></a>monitorenter</h2>
      <figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line"> <span class="built_in">CASE</span>(_monitorenter): &#123;</span><br><span class="line">     <span class="comment">//1.从栈中获取一个对象lockee</span></span><br><span class="line">        oop lockee = <span class="built_in">STACK_OBJECT</span>(<span class="number">-1</span>);</span><br><span class="line">        <span class="comment">// derefing&#x27;s lockee ought to provoke implicit null check</span></span><br><span class="line">     </span><br><span class="line">    <span class="comment">//检查这个lockee是否为空</span></span><br><span class="line">        <span class="built_in">CHECK_NULL</span>(lockee);</span><br><span class="line">        <span class="comment">// find a free monitor or one already allocated for this object</span></span><br><span class="line">        <span class="comment">// if we find a matching object then we need a new monitor</span></span><br><span class="line">        <span class="comment">// since this is recursive enter</span></span><br><span class="line">     </span><br><span class="line">     <span class="comment">//获取BasicObjectLock指针 指向的是线程内所有的monitor</span></span><br><span class="line">     <span class="comment">//limit 指向栈顶 ， most_recent指的是栈底 entry用来存放找到的monitor对象</span></span><br><span class="line">        BasicObjectLock* limit = istate-&gt;<span class="built_in">monitor_base</span>();</span><br><span class="line">        BasicObjectLock* most_recent = (BasicObjectLock*) istate-&gt;<span class="built_in">stack_base</span>();</span><br><span class="line">        BasicObjectLock* entry = <span class="literal">NULL</span>;</span><br><span class="line">     </span><br><span class="line">     </span><br><span class="line">     <span class="comment">//当limit和most_recent不指向同一个Monitor的时候进入循环</span></span><br><span class="line">     <span class="comment">//这个循环目的是找到一个可用的monitor或者发现这个锁被一个monitor监视了</span></span><br><span class="line">        <span class="keyword">while</span> (most_recent != limit ) &#123;</span><br><span class="line">            <span class="comment">//判断monitor的obj是否为空 如果是空则把它放到entry中</span></span><br><span class="line">          <span class="keyword">if</span> (most_recent-&gt;<span class="built_in">obj</span>() == <span class="literal">NULL</span>) entry = most_recent;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> (most_recent-&gt;<span class="built_in">obj</span>() == lockee) <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">//如果monitor的obj不为空且obj为lockee时跳出循环</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">//否则没有找到一个可用的monitor，栈尾指针向栈顶移动</span></span><br><span class="line">          most_recent++;</span><br><span class="line">        &#125;</span><br><span class="line">     </span><br><span class="line">     <span class="comment">//如果循环结束 entry不为空的话则说明找到了一个可用的monitor</span></span><br><span class="line">        <span class="keyword">if</span> (entry != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">//这里是找到了一个monitor</span></span><br><span class="line">            <span class="comment">//将entry指向lockee</span></span><br><span class="line">          entry-&gt;<span class="built_in">set_obj</span>(lockee);</span><br><span class="line">            </span><br><span class="line">          <span class="type">int</span> success = <span class="literal">false</span>;</span><br><span class="line">          <span class="type">uintptr_t</span> epoch_mask_in_place = (<span class="type">uintptr_t</span>)markOopDesc::epoch_mask_in_place;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//记录lockee的头信息</span></span><br><span class="line">          markOop mark = lockee-&gt;<span class="built_in">mark</span>();</span><br><span class="line">            <span class="comment">//获得一个hash值</span></span><br><span class="line">          <span class="type">intptr_t</span> hash = (<span class="type">intptr_t</span>) markOopDesc::no_hash;</span><br><span class="line">          <span class="comment">// implies UseBiasedLocking</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">//判断头信息中是否有bias_pattern 即是否是偏向锁  如果是偏向锁那么进入下面[1]过程，反之进入[2]过程</span></span><br><span class="line">          <span class="keyword">if</span> (mark-&gt;<span class="built_in">has_bias_pattern</span>()) &#123;</span><br><span class="line">              <span class="comment">/*[1]过程：现在是一个偏向锁*/</span></span><br><span class="line">              <span class="comment">/*进入这个语句中说明已经是偏向锁状态:</span></span><br><span class="line"><span class="comment">              有四种情况：</span></span><br><span class="line"><span class="comment">              		①：偏向本线程</span></span><br><span class="line"><span class="comment">              		②：要撤销偏向锁(可能变成轻量级锁或者重量级锁)</span></span><br><span class="line"><span class="comment">              		③：不偏向本线程，要重偏向到本线程</span></span><br><span class="line"><span class="comment">              		④：是匿名偏向锁</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">              */</span></span><br><span class="line">              <span class="comment">//声明变量线程id</span></span><br><span class="line">            <span class="type">uintptr_t</span> thread_ident;</span><br><span class="line">            <span class="type">uintptr_t</span> anticipated_bias_locking_value;</span><br><span class="line">              <span class="comment">//将线程id记录下来</span></span><br><span class="line">            thread_ident = (<span class="type">uintptr_t</span>)istate-&gt;<span class="built_in">thread</span>();</span><br><span class="line">              </span><br><span class="line">              <span class="comment">//通过计算获得一个偏向锁的值</span></span><br><span class="line">            anticipated_bias_locking_value =</span><br><span class="line">              (((<span class="type">uintptr_t</span>)lockee-&gt;<span class="built_in">klass</span>()-&gt;<span class="built_in">prototype_header</span>() | thread_ident) ^ (<span class="type">uintptr_t</span>)mark) &amp;</span><br><span class="line">              ~((<span class="type">uintptr_t</span>) markOopDesc::age_mask_in_place);</span><br><span class="line">	</span><br><span class="line">    		<span class="comment">/*情况①偏向本线程*/</span> </span><br><span class="line">              </span><br><span class="line">              <span class="comment">//这个值==0的话那么就认为是已经偏向本线程  那就什么都不做 将success设置为true返回</span></span><br><span class="line">              <span class="comment">//可以理解成偏向锁的重入</span></span><br><span class="line">            <span class="keyword">if</span>  (anticipated_bias_locking_value == <span class="number">0</span>) &#123;</span><br><span class="line">              <span class="comment">// already biased towards this thread, nothing to do</span></span><br><span class="line">              <span class="keyword">if</span> (PrintBiasedLockingStatistics) &#123;</span><br><span class="line">                (* BiasedLocking::<span class="built_in">biased_lock_entry_count_addr</span>())++;</span><br><span class="line">              &#125;</span><br><span class="line">              success = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">              </span><br><span class="line">            <span class="comment">/*情况②要撤销偏向锁*/</span> </span><br><span class="line">              </span><br><span class="line">            <span class="comment">//反之，判断是否要撤销偏向，说明这个锁很可能是变成了轻量级锁或者重量级锁</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((anticipated_bias_locking_value &amp; markOopDesc::biased_lock_mask_in_place) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//尝试撤销偏向</span></span><br><span class="line">              <span class="comment">// try revoke bias</span></span><br><span class="line">                <span class="comment">//通过klass模板找到一个纯净的头信息</span></span><br><span class="line">              markOop header = lockee-&gt;<span class="built_in">klass</span>()-&gt;<span class="built_in">prototype_header</span>();</span><br><span class="line">                </span><br><span class="line">              <span class="keyword">if</span> (hash != markOopDesc::no_hash) &#123;</span><br><span class="line">                  <span class="comment">//给header设置一个hash值</span></span><br><span class="line">                header = header-&gt;<span class="built_in">copy_set_hash</span>(hash);</span><br><span class="line">              &#125;</span><br><span class="line">                <span class="comment">//cas操作，撤销偏向</span></span><br><span class="line">              <span class="keyword">if</span> (Atomic::<span class="built_in">cmpxchg_ptr</span>(header, lockee-&gt;<span class="built_in">mark_addr</span>(), mark) == mark) &#123;</span><br><span class="line">                  <span class="comment">//撤销偏向成功</span></span><br><span class="line">                <span class="keyword">if</span> (PrintBiasedLockingStatistics)</span><br><span class="line">                  (*BiasedLocking::<span class="built_in">revoked_lock_entry_count_addr</span>())++;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">              </span><br><span class="line">            <span class="comment">/*③：不偏向本线程，要重偏向到本线程*/</span></span><br><span class="line">              </span><br><span class="line">              <span class="comment">//不是偏向本线程，那判断是否要重新偏向</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((anticipated_bias_locking_value &amp; epoch_mask_in_place) !=<span class="number">0</span>) &#123;</span><br><span class="line">               <span class="comment">//尝试重新偏向</span></span><br><span class="line">              <span class="comment">// try rebias</span></span><br><span class="line">                <span class="comment">//获得一个头信息给新头</span></span><br><span class="line">              markOop new_header = (markOop) ( (<span class="type">intptr_t</span>) lockee-&gt;<span class="built_in">klass</span>()-&gt;<span class="built_in">prototype_header</span>() | thread_ident);</span><br><span class="line">              <span class="keyword">if</span> (hash != markOopDesc::no_hash) &#123;</span><br><span class="line">                  <span class="comment">//给新头设置哈希值</span></span><br><span class="line">                new_header = new_header-&gt;<span class="built_in">copy_set_hash</span>(hash);</span><br><span class="line">              &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//CAS操作 ，重新偏向</span></span><br><span class="line">              <span class="keyword">if</span> (Atomic::<span class="built_in">cmpxchg_ptr</span>((<span class="type">void</span>*)new_header, lockee-&gt;<span class="built_in">mark_addr</span>(), mark) == mark) &#123;</span><br><span class="line">                  <span class="comment">//CAS成功，已经偏向本线程</span></span><br><span class="line">                <span class="keyword">if</span> (PrintBiasedLockingStatistics)</span><br><span class="line">                  (* BiasedLocking::<span class="built_in">rebiased_lock_entry_count_addr</span>())++;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="comment">//反之没有重偏向成功，进入锁膨胀方法</span></span><br><span class="line">                <span class="built_in">CALL_VM</span>(InterpreterRuntime::<span class="built_in">monitorenter</span>(THREAD, entry), handle_exception);</span><br><span class="line">              &#125;</span><br><span class="line">                <span class="comment">//加锁成功</span></span><br><span class="line">              success = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">/*④：是匿名偏向锁*/</span></span><br><span class="line">                </span><br><span class="line">              <span class="comment">// try to bias towards thread in case object is anonymously biased</span></span><br><span class="line">              markOop header = (markOop) ((<span class="type">uintptr_t</span>) mark &amp; ((<span class="type">uintptr_t</span>)markOopDesc::biased_lock_mask_in_place |(<span class="type">uintptr_t</span>)markOopDesc::age_mask_in_place |</span><br><span class="line">epoch_mask_in_place));</span><br><span class="line">                <span class="comment">//获得一个头信息 ，然后判断是否给头信息设置hash值</span></span><br><span class="line">              <span class="keyword">if</span> (hash != markOopDesc::no_hash) &#123;</span><br><span class="line">                header = header-&gt;<span class="built_in">copy_set_hash</span>(hash);</span><br><span class="line">              &#125;</span><br><span class="line">                <span class="comment">//将头信息与线程id异或之后给new_header</span></span><br><span class="line">              markOop new_header = (markOop) ((<span class="type">uintptr_t</span>) header | thread_ident);</span><br><span class="line">              <span class="comment">// debugging hint</span></span><br><span class="line">              <span class="built_in">DEBUG_ONLY</span>(entry-&gt;<span class="built_in">lock</span>()-&gt;<span class="built_in">set_displaced_header</span>((markOop) (<span class="type">uintptr_t</span>) <span class="number">0xdeaddead</span>);)</span><br><span class="line">                  <span class="comment">//CAS操作 将匿名偏向锁偏向本线程</span></span><br><span class="line">              <span class="keyword">if</span> (Atomic::<span class="built_in">cmpxchg_ptr</span>((<span class="type">void</span>*)new_header, lockee-&gt;<span class="built_in">mark_addr</span>(), header) == header) &#123;</span><br><span class="line">                  <span class="comment">//加锁成功也就是匿名偏向锁偏向本线程</span></span><br><span class="line">                <span class="keyword">if</span> (PrintBiasedLockingStatistics)</span><br><span class="line">                  (* BiasedLocking::<span class="built_in">anonymously_biased_lock_entry_count_addr</span>())++;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="comment">//反之尝试匿名偏向锁加锁失败，说明有竞争需要进行锁膨胀</span></span><br><span class="line">                <span class="built_in">CALL_VM</span>(InterpreterRuntime::<span class="built_in">monitorenter</span>(THREAD, entry), handle_exception);</span><br><span class="line">              &#125;</span><br><span class="line">              success = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">		<span class="comment">/*下面是[2]过程，说明这个锁不是偏向锁*/</span>  </span><br><span class="line">          <span class="comment">// traditional lightweight locking</span></span><br><span class="line">            <span class="comment">//只能是轻量级锁或者是重量级锁</span></span><br><span class="line">          <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">              <span class="comment">//将lockee设置成无锁状态</span></span><br><span class="line">            markOop displaced = lockee-&gt;<span class="built_in">mark</span>()-&gt;<span class="built_in">set_unlocked</span>();</span><br><span class="line">              <span class="comment">//将entry的lock也设置成无锁 </span></span><br><span class="line">            entry-&gt;<span class="built_in">lock</span>()-&gt;<span class="built_in">set_displaced_header</span>(displaced);</span><br><span class="line">              <span class="comment">//是否使用重量级锁(即不用轻量级锁和偏向锁，默认为Flase)，如果禁用了则Call_vm为true</span></span><br><span class="line">            <span class="type">bool</span> call_vm = UseHeavyMonitors;</span><br><span class="line">            <span class="keyword">if</span> (call_vm || Atomic::<span class="built_in">cmpxchg_ptr</span>(entry, lockee-&gt;<span class="built_in">mark_addr</span>(), displaced) != displaced) &#123;</span><br><span class="line">                <span class="comment">/*场景1：禁用了轻量级锁，那么进入下面的判断 ！call_vm为false 直接走到else中 进行一个升级到重量级锁</span></span><br><span class="line"><span class="comment">               	  场景2:如果是默认则Call_vm为false ，那么会进行一个轻量级锁加锁CAS过程， 如果加锁失败会进行锁膨胀升级到重量级锁</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">              <span class="comment">// Is it simple recursive case?</span></span><br><span class="line">                <span class="comment">//判断是否这个锁是轻量级锁重入，如果是把Lock设置为null</span></span><br><span class="line">              <span class="keyword">if</span> (!call_vm &amp;&amp; THREAD-&gt;<span class="built_in">is_lock_owned</span>((address) displaced-&gt;<span class="built_in">clear_lock_bits</span>())) &#123;</span><br><span class="line">                entry-&gt;<span class="built_in">lock</span>()-&gt;<span class="built_in">set_displaced_header</span>(<span class="literal">NULL</span>);</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">CALL_VM</span>(InterpreterRuntime::<span class="built_in">monitorenter</span>(THREAD, entry), handle_exception);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="built_in">UPDATE_PC_AND_TOS_AND_CONTINUE</span>(<span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          istate-&gt;<span class="built_in">set_msg</span>(more_monitors);</span><br><span class="line">          <span class="built_in">UPDATE_PC_AND_RETURN</span>(<span class="number">0</span>); <span class="comment">// Re-execute</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></div></figure>

<p>这里是上面没有详细说到的东西</p>

        <h3 id="①basicObjectLock-记录了锁和持有锁的对象"   >
          <a href="#①basicObjectLock-记录了锁和持有锁的对象" class="heading-link"><i class="fas fa-link"></i></a><a href="#①basicObjectLock-记录了锁和持有锁的对象" class="headerlink" title="①basicObjectLock:记录了锁和持有锁的对象"></a>①basicObjectLock:记录了锁和持有锁的对象</h3>
      <figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BasicObjectLock</span> VALUE_OBJ_CLASS_SPEC &#123;</span><br><span class="line">  <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">VMStructs</span>;</span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  BasicLock _lock;                                    <span class="comment">// the lock, must be double word aligned</span></span><br><span class="line">  oop       _obj;                                     <span class="comment">// object holds the lock;</span></span><br></pre></td></tr></table></div></figure>

<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230802193545800.png"  alt="BasicObjectLock">
      </p>

        <h3 id="②Atomic-cmpxchg-ptr-exchange-value-dest-compare-value"   >
          <a href="#②Atomic-cmpxchg-ptr-exchange-value-dest-compare-value" class="heading-link"><i class="fas fa-link"></i></a><a href="#②Atomic-cmpxchg-ptr-exchange-value-dest-compare-value" class="headerlink" title="②Atomic::cmpxchg_ptr(exchange_value,  dest, compare_value)"></a>②Atomic::cmpxchg_ptr(exchange_value,  dest, compare_value)</h3>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CAS操作 参数1:想要改变的值</span><br><span class="line">	    参数2:目的地址</span><br><span class="line">	    参数3:用于比较的旧值</span><br><span class="line">返回结果如果CAS成功则返回期望值(参数3)</span><br><span class="line">		  CAS失败则返回要改变的值(参数1)</span><br></pre></td></tr></table></div></figure>


        <h3 id="③匿名偏向锁"   >
          <a href="#③匿名偏向锁" class="heading-link"><i class="fas fa-link"></i></a><a href="#③匿名偏向锁" class="headerlink" title="③匿名偏向锁"></a>③匿名偏向锁</h3>
      <p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230802211243380.png"  alt="匿名偏向锁">
      </p>

        <h3 id="④轻量级锁"   >
          <a href="#④轻量级锁" class="heading-link"><i class="fas fa-link"></i></a><a href="#④轻量级锁" class="headerlink" title="④轻量级锁"></a>④轻量级锁</h3>
      <p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230802211843053.png"  alt="轻量级锁">
      </p>

        <h3 id="⑤偏向锁加锁流程图"   >
          <a href="#⑤偏向锁加锁流程图" class="heading-link"><i class="fas fa-link"></i></a><a href="#⑤偏向锁加锁流程图" class="headerlink" title="⑤偏向锁加锁流程图"></a>⑤偏向锁加锁流程图</h3>
      <p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230802203659004.png"  alt="偏向锁加锁流程">
      </p>

        <h2 id="锁膨胀-InterpreterRuntime-monitorenter"   >
          <a href="#锁膨胀-InterpreterRuntime-monitorenter" class="heading-link"><i class="fas fa-link"></i></a><a href="#锁膨胀-InterpreterRuntime-monitorenter" class="headerlink" title="锁膨胀(InterpreterRuntime::monitorenter)"></a>锁膨胀(InterpreterRuntime::monitorenter)</h2>
      <figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//------------------------------------------------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// Synchronization</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// The interpreter&#x27;s synchronization code is factored out so that it can</span></span><br><span class="line"><span class="comment">// be shared by method invocation and synchronized blocks.</span></span><br><span class="line"><span class="comment">//%note synchronization_3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//%note monitor_1</span></span><br><span class="line"><span class="built_in">IRT_ENTRY_NO_ASYNC</span>(<span class="type">void</span>, InterpreterRuntime::<span class="built_in">monitorenter</span>(JavaThread* thread, BasicObjectLock* elem))</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> ASSERT</span></span><br><span class="line">  thread-&gt;<span class="built_in">last_frame</span>().<span class="built_in">interpreter_frame_verify_monitor</span>(elem);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  <span class="keyword">if</span> (PrintBiasedLockingStatistics) &#123;</span><br><span class="line">    Atomic::<span class="built_in">inc</span>(BiasedLocking::<span class="built_in">slow_path_entry_count_addr</span>());</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 将thread和 BasicObjectLock封装到h_obj中</span></span><br><span class="line">  <span class="function">Handle <span class="title">h_obj</span><span class="params">(thread, elem-&gt;obj())</span></span>;</span><br><span class="line">  <span class="built_in">assert</span>(Universe::<span class="built_in">heap</span>()-&gt;<span class="built_in">is_in_reserved_or_null</span>(<span class="built_in">h_obj</span>()),</span><br><span class="line">         <span class="string">&quot;must be NULL or an object&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//判断是否使用了偏向锁</span></span><br><span class="line">  <span class="keyword">if</span> (UseBiasedLocking) &#123;</span><br><span class="line">    <span class="comment">// Retry fast entry if bias is revoked to avoid unnecessary inflation</span></span><br><span class="line">      <span class="comment">//是使用了偏向锁，所以要撤销偏向锁，走到fast_entry中</span></span><br><span class="line">    ObjectSynchronizer::<span class="built_in">fast_enter</span>(h_obj, elem-&gt;<span class="built_in">lock</span>(), <span class="literal">true</span>, CHECK);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">//没有使用偏向锁，进入Slow_enter</span></span><br><span class="line">    ObjectSynchronizer::<span class="built_in">slow_enter</span>(h_obj, elem-&gt;<span class="built_in">lock</span>(), CHECK);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">assert</span>(Universe::<span class="built_in">heap</span>()-&gt;<span class="built_in">is_in_reserved_or_null</span>(elem-&gt;<span class="built_in">obj</span>()),</span><br><span class="line">         <span class="string">&quot;must be NULL or an object&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> ASSERT</span></span><br><span class="line">  thread-&gt;<span class="built_in">last_frame</span>().<span class="built_in">interpreter_frame_verify_monitor</span>(elem);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">IRT_END</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h3 id="fast-entry"   >
          <a href="#fast-entry" class="heading-link"><i class="fas fa-link"></i></a><a href="#fast-entry" class="headerlink" title="fast_entry"></a>fast_entry</h3>
      <figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	传入参数1：obj ：(封装有线程ID和BasicObjectLock)</span></span><br><span class="line"><span class="comment">	    参数2：lock ：BaiscObjectLock中的Lock</span></span><br><span class="line"><span class="comment">		参数3：attempt_rebias : True,先不用管</span></span><br><span class="line"><span class="comment">		参数4：TRAPS: check</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ObjectSynchronizer::fast_enter</span><span class="params">(Handle obj, BasicLock* lock, <span class="type">bool</span> attempt_rebias, TRAPS)</span> </span>&#123;</span><br><span class="line"> 	<span class="comment">//是否用了偏向锁</span></span><br><span class="line">    <span class="keyword">if</span> (UseBiasedLocking) &#123;</span><br><span class="line">    	<span class="comment">//用了偏向锁，是否到达线程安全点</span></span><br><span class="line">    <span class="keyword">if</span> (!SafepointSynchronize::<span class="built_in">is_at_safepoint</span>()) &#123;</span><br><span class="line">        <span class="comment">//没到达线程安全点，调用方法revoke_and_rebias撤销锁并且重偏向</span></span><br><span class="line">      BiasedLocking::Condition cond = BiasedLocking::<span class="built_in">revoke_and_rebias</span>(obj, attempt_rebias, THREAD);</span><br><span class="line">        </span><br><span class="line">      <span class="keyword">if</span> (cond == BiasedLocking::BIAS_REVOKED_AND_REBIASED) &#123;</span><br><span class="line">          <span class="comment">//如果撤销锁了并且重偏向了直接return</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//到达了线程安全点</span></span><br><span class="line">      <span class="built_in">assert</span>(!attempt_rebias, <span class="string">&quot;can not rebias toward VM thread&quot;</span>);</span><br><span class="line">        <span class="comment">//线程安全点撤销偏向锁</span></span><br><span class="line">      BiasedLocking::<span class="built_in">revoke_at_safepoint</span>(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">assert</span>(!obj-&gt;<span class="built_in">mark</span>()-&gt;<span class="built_in">has_bias_pattern</span>(), <span class="string">&quot;biases should be revoked by now&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment">//进入Slow_enter方法</span></span><br><span class="line"> <span class="built_in">slow_enter</span> (obj, lock, THREAD) ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h3 id="revoke-and-rebias"   >
          <a href="#revoke-and-rebias" class="heading-link"><i class="fas fa-link"></i></a><a href="#revoke-and-rebias" class="headerlink" title="revoke_and_rebias"></a>revoke_and_rebias</h3>
      <figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	参数1：obj ：封装有线程ID和BasicObjectLock)</span></span><br><span class="line"><span class="comment">	参数2：attempt_rebias，传入的True</span></span><br><span class="line"><span class="comment">	参数3：TRAPS: check</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">BiasedLocking::Condition <span class="title">BiasedLocking::revoke_and_rebias</span><span class="params">(Handle obj, <span class="type">bool</span> attempt_rebias, TRAPS)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">assert</span>(!SafepointSynchronize::<span class="built_in">is_at_safepoint</span>(), <span class="string">&quot;must not be called while at safepoint&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We can revoke the biases of anonymously-biased objects</span></span><br><span class="line">  <span class="comment">// efficiently enough that we should not cause these revocations to</span></span><br><span class="line">  <span class="comment">// update the heuristics because doing so may cause unwanted bulk</span></span><br><span class="line">  <span class="comment">// revocations (which are expensive) to occur.</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//获得头信息</span></span><br><span class="line">  markOop mark = obj-&gt;<span class="built_in">mark</span>();</span><br><span class="line">    <span class="comment">//因为attempt_rebias==true，所以这个判断可以不走</span></span><br><span class="line">  <span class="keyword">if</span> (mark-&gt;<span class="built_in">is_biased_anonymously</span>() &amp;&amp; !attempt_rebias) &#123;</span><br><span class="line">      <span class="comment">//判断这个锁是否是匿名偏向，如果是匿名偏向且不需要重偏向则撤销偏向锁</span></span><br><span class="line">      </span><br><span class="line">    <span class="comment">// We are probably trying to revoke the bias of this object due to</span></span><br><span class="line">    <span class="comment">// an identity hash code computation. Try to revoke the bias</span></span><br><span class="line">    <span class="comment">// without a safepoint. This is possible if we can successfully</span></span><br><span class="line">    <span class="comment">// compare-and-exchange an unbiased header into the mark word of</span></span><br><span class="line">    <span class="comment">// the object, meaning that no other thread has raced to acquire</span></span><br><span class="line">    <span class="comment">// the bias of the object.</span></span><br><span class="line">    markOop biased_value       = mark;</span><br><span class="line">    markOop unbiased_prototype = markOopDesc::<span class="built_in">prototype</span>()-&gt;<span class="built_in">set_age</span>(mark-&gt;<span class="built_in">age</span>());</span><br><span class="line">    markOop res_mark = (markOop) Atomic::<span class="built_in">cmpxchg_ptr</span>(unbiased_prototype, obj-&gt;<span class="built_in">mark_addr</span>(), mark);</span><br><span class="line">    <span class="keyword">if</span> (res_mark == biased_value) &#123;</span><br><span class="line">      <span class="keyword">return</span> BIAS_REVOKED;</span><br><span class="line">    &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//直接进入下面的判断中，判断是否是偏向锁</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mark-&gt;<span class="built_in">has_bias_pattern</span>()) &#123;</span><br><span class="line">      <span class="comment">//是偏向锁</span></span><br><span class="line">      <span class="comment">//取到Klass 为k</span></span><br><span class="line">      <span class="comment">//k取到纯净的头信息</span></span><br><span class="line">    Klass* k = obj-&gt;<span class="built_in">klass</span>();</span><br><span class="line">    markOop prototype_header = k-&gt;<span class="built_in">prototype_header</span>();</span><br><span class="line">    <span class="keyword">if</span> (!prototype_header-&gt;<span class="built_in">has_bias_pattern</span>()) &#123;</span><br><span class="line">        <span class="comment">//如果原始的头是不是偏向锁</span></span><br><span class="line">        </span><br><span class="line">      <span class="comment">// This object has a stale bias from before the bulk revocation</span></span><br><span class="line">      <span class="comment">// for this data type occurred. It&#x27;s pointless to update the</span></span><br><span class="line">      <span class="comment">// heuristics at this point so simply update the header with a</span></span><br><span class="line">      <span class="comment">// CAS. If we fail this race, the object&#x27;s bias has been revoked</span></span><br><span class="line">      <span class="comment">// by another thread so we simply return and let the caller deal</span></span><br><span class="line">      <span class="comment">// with it.</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//将锁头Lock改成无锁状态，然后返回BIAS_REVOKED状态(已经撤销偏向)</span></span><br><span class="line">      markOop biased_value       = mark;</span><br><span class="line">      markOop res_mark = (markOop) Atomic::<span class="built_in">cmpxchg_ptr</span>(prototype_header, obj-&gt;<span class="built_in">mark_addr</span>(), mark);</span><br><span class="line">      <span class="built_in">assert</span>(!(*(obj-&gt;<span class="built_in">mark_addr</span>()))-&gt;<span class="built_in">has_bias_pattern</span>(), <span class="string">&quot;even if we raced, should still be revoked&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> BIAS_REVOKED;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (prototype_header-&gt;<span class="built_in">bias_epoch</span>() != mark-&gt;<span class="built_in">bias_epoch</span>()) &#123;</span><br><span class="line">        <span class="comment">//判断这个Epoch数据，判断是否被其他线程修改过，如果修改过那么这个偏向锁无效(过期)</span></span><br><span class="line">        </span><br><span class="line">      <span class="comment">// The epoch of this biasing has expired indicating that the</span></span><br><span class="line">      <span class="comment">// object is effectively unbiased. Depending on whether we need</span></span><br><span class="line">      <span class="comment">// to rebias or revoke the bias of this object we can do it</span></span><br><span class="line">      <span class="comment">// efficiently enough with a CAS that we shouldn&#x27;t update the</span></span><br><span class="line">      <span class="comment">// heuristics. This is normally done in the assembly code but we</span></span><br><span class="line">      <span class="comment">// can reach this point due to various points in the runtime</span></span><br><span class="line">      <span class="comment">// needing to revoke biases.</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//是否需要重偏向，我们这传入的数据是true所以需要重偏向</span></span><br><span class="line">      <span class="keyword">if</span> (attempt_rebias) &#123;</span><br><span class="line">        <span class="built_in">assert</span>(THREAD-&gt;<span class="built_in">is_Java_thread</span>(), <span class="string">&quot;&quot;</span>);</span><br><span class="line">        markOop biased_value       = mark;</span><br><span class="line">        markOop rebiased_prototype = markOopDesc::<span class="built_in">encode</span>((JavaThread*) THREAD, mark-&gt;<span class="built_in">age</span>(), prototype_header-&gt;<span class="built_in">bias_epoch</span>());</span><br><span class="line">          </span><br><span class="line">          <span class="comment">//CAS操作将锁重新偏向</span></span><br><span class="line">        markOop res_mark = (markOop) Atomic::<span class="built_in">cmpxchg_ptr</span>(rebiased_prototype, obj-&gt;<span class="built_in">mark_addr</span>(), mark);</span><br><span class="line">        <span class="keyword">if</span> (res_mark == biased_value) &#123;</span><br><span class="line">            <span class="comment">//撤销后且重新偏向成功 返回BIAS_REVOKED_AND_REBIASED</span></span><br><span class="line">          <span class="keyword">return</span> BIAS_REVOKED_AND_REBIASED;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">//这不需要重新偏向</span></span><br><span class="line">        markOop biased_value       = mark;</span><br><span class="line">        markOop unbiased_prototype = markOopDesc::<span class="built_in">prototype</span>()-&gt;<span class="built_in">set_age</span>(mark-&gt;<span class="built_in">age</span>());</span><br><span class="line">          <span class="comment">//CAS将头信息设置为无锁状态</span></span><br><span class="line">        markOop res_mark = (markOop) Atomic::<span class="built_in">cmpxchg_ptr</span>(unbiased_prototype, obj-&gt;<span class="built_in">mark_addr</span>(), mark);</span><br><span class="line">        <span class="keyword">if</span> (res_mark == biased_value) &#123;</span><br><span class="line">            <span class="comment">//将锁头Lock改成无锁状态，然后返回BIAS_REVOKED状态(已经撤销偏向)</span></span><br><span class="line">          <span class="keyword">return</span> BIAS_REVOKED;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//走到这里说明不是匿名偏向、偏向锁撤销且重偏向撤销失败、偏向锁撤销失败</span></span><br><span class="line"> HeuristicsResult heuristics = <span class="built_in">update_heuristics</span>(<span class="built_in">obj</span>(), attempt_rebias);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//判断这个锁是否是偏向状态</span></span><br><span class="line">  <span class="keyword">if</span> (heuristics == HR_NOT_BIASED) &#123;</span><br><span class="line">      <span class="comment">//这个锁不是偏向状态</span></span><br><span class="line">    <span class="keyword">return</span> NOT_BIASED;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (heuristics == HR_SINGLE_REVOKE) &#123;</span><br><span class="line">      <span class="comment">//反之 这个锁是个偏向锁，判断是否单例撤销</span></span><br><span class="line">    Klass *k = obj-&gt;<span class="built_in">klass</span>();</span><br><span class="line">    markOop prototype_header = k-&gt;<span class="built_in">prototype_header</span>();</span><br><span class="line">    <span class="keyword">if</span> (mark-&gt;<span class="built_in">biased_locker</span>() == THREAD &amp;&amp;</span><br><span class="line">        prototype_header-&gt;<span class="built_in">bias_epoch</span>() == mark-&gt;<span class="built_in">bias_epoch</span>()) &#123;</span><br><span class="line">      <span class="comment">// A thread is trying to revoke the bias of an object biased</span></span><br><span class="line">      <span class="comment">// toward it, again likely due to an identity hash code</span></span><br><span class="line">      <span class="comment">// computation. We can again avoid a safepoint in this case</span></span><br><span class="line">      <span class="comment">// since we are only going to walk our own stack. There are no</span></span><br><span class="line">      <span class="comment">// races with revocations occurring in other threads because we</span></span><br><span class="line">      <span class="comment">// reach no safepoints in the revocation path.</span></span><br><span class="line">      <span class="comment">// Also check the epoch because even if threads match, another thread</span></span><br><span class="line">      <span class="comment">// can come in with a CAS to steal the bias of an object that has a</span></span><br><span class="line">      <span class="comment">// stale epoch.</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//判断是否是当前持锁线程进行锁撤销</span></span><br><span class="line">      ResourceMark rm;</span><br><span class="line">      <span class="keyword">if</span> (TraceBiasedLocking) &#123;</span><br><span class="line">        tty-&gt;<span class="built_in">print_cr</span>(<span class="string">&quot;Revoking bias by walking my own stack:&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//调用revoke_bias方法进行撤销锁 返回一个cond(撤销的状态字)</span></span><br><span class="line">      BiasedLocking::Condition cond = <span class="built_in">revoke_bias</span>(<span class="built_in">obj</span>(), <span class="literal">false</span>, <span class="literal">false</span>, (JavaThread*) THREAD);</span><br><span class="line">      ((JavaThread*) THREAD)-&gt;<span class="built_in">set_cached_monitor_info</span>(<span class="literal">NULL</span>);</span><br><span class="line">      <span class="built_in">assert</span>(cond == BIAS_REVOKED, <span class="string">&quot;why not?&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> cond;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//当前线程已经死了</span></span><br><span class="line">        <span class="comment">//交给虚拟机去进行一个锁撤销</span></span><br><span class="line">      VM_RevokeBias <span class="built_in">revoke</span>(&amp;obj, (JavaThread*) THREAD);</span><br><span class="line">      VMThread::<span class="built_in">execute</span>(&amp;revoke);</span><br><span class="line">      <span class="keyword">return</span> revoke.<span class="built_in">status_code</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//走到这里说明需要进行一个批量撤销</span></span><br><span class="line">  <span class="built_in">assert</span>((heuristics == HR_BULK_REVOKE) ||</span><br><span class="line">         (heuristics == HR_BULK_REBIAS), <span class="string">&quot;?&quot;</span>);</span><br><span class="line">  <span class="function">VM_BulkRevokeBias <span class="title">bulk_revoke</span><span class="params">(&amp;obj, (JavaThread*) THREAD,</span></span></span><br><span class="line"><span class="params"><span class="function">                                (heuristics == HR_BULK_REBIAS),</span></span></span><br><span class="line"><span class="params"><span class="function">                                attempt_rebias)</span></span>;</span><br><span class="line">  VMThread::<span class="built_in">execute</span>(&amp;bulk_revoke);</span><br><span class="line">  <span class="keyword">return</span> bulk_revoke.<span class="built_in">status_code</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h3 id="revoke-bias"   >
          <a href="#revoke-bias" class="heading-link"><i class="fas fa-link"></i></a><a href="#revoke-bias" class="headerlink" title="revoke_bias"></a>revoke_bias</h3>
      <figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	传入 参数1：obj ：(封装有线程ID和BasicObjectLock)</span></span><br><span class="line"><span class="comment">		参数2：是否允  许重偏向，False</span></span><br><span class="line"><span class="comment">		参数3：是否是批处理，False</span></span><br><span class="line"><span class="comment">		参数4：线程</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> BiasedLocking::Condition <span class="title">revoke_bias</span><span class="params">(oop obj, <span class="type">bool</span> allow_rebias, <span class="type">bool</span> is_bulk, JavaThread* requesting_thread)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//获得对象头信息</span></span><br><span class="line">  markOop mark = obj-&gt;<span class="built_in">mark</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//判断是否是偏向状态</span></span><br><span class="line">  <span class="keyword">if</span> (!mark-&gt;<span class="built_in">has_bias_pattern</span>()) &#123;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//如果允许跟踪偏向锁 我们默认是false就不走这个</span></span><br><span class="line">    <span class="keyword">if</span> (TraceBiasedLocking) &#123;</span><br><span class="line">      ResourceMark rm;</span><br><span class="line">      tty-&gt;<span class="built_in">print_cr</span>(<span class="string">&quot;  (Skipping revocation of object of type %s because it&#x27;s no longer biased)&quot;</span>,</span><br><span class="line">                    obj-&gt;<span class="built_in">klass</span>()-&gt;<span class="built_in">external_name</span>());</span><br><span class="line">    &#125;</span><br><span class="line">      <span class="comment">//到这里说明没有偏向直接返回NOT_BIASED</span></span><br><span class="line">    <span class="keyword">return</span> BiasedLocking::NOT_BIASED;</span><br><span class="line">  &#125;</span><br><span class="line">    <span class="comment">//获得锁的年龄</span></span><br><span class="line">  uint age = mark-&gt;<span class="built_in">age</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//获得一个锁的对象头</span></span><br><span class="line">  markOop   biased_prototype = markOopDesc::<span class="built_in">biased_locking_prototype</span>()-&gt;<span class="built_in">set_age</span>(age);</span><br><span class="line">    <span class="comment">//获得一个无锁的对象头</span></span><br><span class="line">  markOop unbiased_prototype = markOopDesc::<span class="built_in">prototype</span>()-&gt;<span class="built_in">set_age</span>(age);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//同上默认不允许跟踪偏向锁</span></span><br><span class="line">  <span class="keyword">if</span> (TraceBiasedLocking &amp;&amp; (Verbose || !is_bulk)) &#123;</span><br><span class="line">    ResourceMark rm;</span><br><span class="line">    tty-&gt;<span class="built_in">print_cr</span>(<span class="string">&quot;Revoking bias of object &quot;</span> INTPTR_FORMAT <span class="string">&quot; , mark &quot;</span> INTPTR_FORMAT <span class="string">&quot; , type %s , prototype header &quot;</span> INTPTR_FORMAT <span class="string">&quot; , allow rebias %d , requesting thread &quot;</span> INTPTR_FORMAT,</span><br><span class="line">                  <span class="built_in">p2i</span>((<span class="type">void</span> *)obj), (<span class="type">intptr_t</span>) mark, obj-&gt;<span class="built_in">klass</span>()-&gt;<span class="built_in">external_name</span>(), (<span class="type">intptr_t</span>) obj-&gt;<span class="built_in">klass</span>()-&gt;<span class="built_in">prototype_header</span>(), (allow_rebias ? <span class="number">1</span> : <span class="number">0</span>), (<span class="type">intptr_t</span>) requesting_thread);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取对象头的偏向线程</span></span><br><span class="line">  JavaThread* biased_thread = mark-&gt;<span class="built_in">biased_locker</span>();</span><br><span class="line">  <span class="keyword">if</span> (biased_thread == <span class="literal">NULL</span>) &#123;</span><br><span class="line">      <span class="comment">//如果偏向线程为空说明是一个匿名偏向锁</span></span><br><span class="line">      </span><br><span class="line">    <span class="comment">// Object is anonymously biased. We can get here if, for</span></span><br><span class="line">    <span class="comment">// example, we revoke the bias due to an identity hash code</span></span><br><span class="line">    <span class="comment">// being computed for an object.</span></span><br><span class="line">    <span class="keyword">if</span> (!allow_rebias) &#123;</span><br><span class="line">        <span class="comment">//如果不允许重偏向，则设置为无锁状态</span></span><br><span class="line">      obj-&gt;<span class="built_in">set_mark</span>(unbiased_prototype);</span><br><span class="line">    &#125;</span><br><span class="line">      <span class="comment">//默认不进</span></span><br><span class="line">    <span class="keyword">if</span> (TraceBiasedLocking &amp;&amp; (Verbose || !is_bulk)) &#123;</span><br><span class="line">      tty-&gt;<span class="built_in">print_cr</span>(<span class="string">&quot;  Revoked bias of anonymously-biased object&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">      <span class="comment">//返回已经撤销偏向</span></span><br><span class="line">    <span class="keyword">return</span> BiasedLocking::BIAS_REVOKED;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Handle case where the thread toward which the object was biased has exited</span></span><br><span class="line">    <span class="comment">//设置一个状态 记录持锁线程是否还活着</span></span><br><span class="line">  <span class="type">bool</span> thread_is_alive = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (requesting_thread == biased_thread) &#123;</span><br><span class="line">      <span class="comment">//如果请求线程和偏向线程相等则说明持锁线程还活着</span></span><br><span class="line">    thread_is_alive = <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">//遍历线程 然后找到持锁线程，如果持锁线程还存在 则将状态置为True</span></span><br><span class="line">    <span class="keyword">for</span> (JavaThread* cur_thread = Threads::<span class="built_in">first</span>(); cur_thread != <span class="literal">NULL</span>; cur_thread = cur_thread-&gt;<span class="built_in">next</span>()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (cur_thread == biased_thread) &#123;</span><br><span class="line">        thread_is_alive = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">    <span class="comment">//运行到这 Thread_is_alive依然是false 说明持锁线程已经死了</span></span><br><span class="line">  <span class="keyword">if</span> (!thread_is_alive) &#123;</span><br><span class="line">    <span class="keyword">if</span> (allow_rebias) &#123;</span><br><span class="line">        <span class="comment">//如果允许重偏向则设置为匿名偏向锁状态，我们传入的是False</span></span><br><span class="line">      obj-&gt;<span class="built_in">set_mark</span>(biased_prototype);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//反之设为无锁状态</span></span><br><span class="line">      obj-&gt;<span class="built_in">set_mark</span>(unbiased_prototype);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (TraceBiasedLocking &amp;&amp; (Verbose || !is_bulk)) &#123;</span><br><span class="line">      tty-&gt;<span class="built_in">print_cr</span>(<span class="string">&quot;  Revoked bias of object biased toward dead thread&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">      <span class="comment">//返回已经撤销偏向</span></span><br><span class="line">    <span class="keyword">return</span> BiasedLocking::BIAS_REVOKED;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Thread owning bias is alive.</span></span><br><span class="line">  <span class="comment">// Check to see whether it currently owns the lock and, if so,</span></span><br><span class="line">  <span class="comment">// write down the needed displaced headers to the thread&#x27;s stack.</span></span><br><span class="line">  <span class="comment">// Otherwise, restore the object&#x27;s header either to the unlocked</span></span><br><span class="line">  <span class="comment">// or unbiased state.</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//判断锁偏向线程是否还在，检查他是否拥有锁，如果有则写入线程堆栈中反之解锁或者解除偏向</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//获取一个Monitor列表</span></span><br><span class="line">  GrowableArray&lt;MonitorInfo*&gt;* cached_monitor_info = <span class="built_in">get_or_compute_monitor_info</span>(biased_thread);</span><br><span class="line">  BasicLock* highest_lock = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//遍历列表</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; cached_monitor_info-&gt;<span class="built_in">length</span>(); i++) &#123;</span><br><span class="line">    MonitorInfo* mon_info = cached_monitor_info-&gt;<span class="built_in">at</span>(i);</span><br><span class="line">    <span class="keyword">if</span> (mon_info-&gt;<span class="built_in">owner</span>() == obj) &#123;</span><br><span class="line">        <span class="comment">//这个owner指向的是不是当前的锁(重入的时候只有第一个进来的持有锁的地址)</span></span><br><span class="line">      <span class="keyword">if</span> (TraceBiasedLocking &amp;&amp; Verbose) &#123;</span><br><span class="line">        tty-&gt;<span class="built_in">print_cr</span>(<span class="string">&quot;   mon_info-&gt;owner (&quot;</span> PTR_FORMAT <span class="string">&quot;) == obj (&quot;</span> PTR_FORMAT <span class="string">&quot;)&quot;</span>,</span><br><span class="line">                      <span class="built_in">p2i</span>((<span class="type">void</span> *) mon_info-&gt;<span class="built_in">owner</span>()),</span><br><span class="line">                      <span class="built_in">p2i</span>((<span class="type">void</span> *) obj));</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// Assume recursive case and fix up highest lock later</span></span><br><span class="line">        <span class="comment">//获取一个NULL 设置为mark</span></span><br><span class="line">      markOop mark = markOopDesc::<span class="built_in">encode</span>((BasicLock*) <span class="literal">NULL</span>);</span><br><span class="line">        </span><br><span class="line">       <span class="comment">//将Highest指向这个锁对象</span></span><br><span class="line">      highest_lock = mon_info-&gt;<span class="built_in">lock</span>();</span><br><span class="line">        <span class="comment">//将obj的Mark设为Null</span></span><br><span class="line">      highest_lock-&gt;<span class="built_in">set_displaced_header</span>(mark);</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (TraceBiasedLocking &amp;&amp; Verbose) &#123;</span><br><span class="line">        tty-&gt;<span class="built_in">print_cr</span>(<span class="string">&quot;   mon_info-&gt;owner (&quot;</span> PTR_FORMAT <span class="string">&quot;) != obj (&quot;</span> PTR_FORMAT <span class="string">&quot;)&quot;</span>,</span><br><span class="line">                      <span class="built_in">p2i</span>((<span class="type">void</span> *) mon_info-&gt;<span class="built_in">owner</span>()),</span><br><span class="line">                      <span class="built_in">p2i</span>((<span class="type">void</span> *) obj));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">    </span><br><span class="line">  <span class="keyword">if</span> (highest_lock != <span class="literal">NULL</span>) &#123;</span><br><span class="line">      <span class="comment">//遍历结束之后Highest不为空说明找到了可重入锁的第一个锁头</span></span><br><span class="line">      </span><br><span class="line">    <span class="comment">// Fix up highest lock to contain displaced header and point</span></span><br><span class="line">    <span class="comment">// object at it</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">//将表头设置为无锁状态</span></span><br><span class="line">    highest_lock-&gt;<span class="built_in">set_displaced_header</span>(unbiased_prototype);</span><br><span class="line">    <span class="comment">// Reset object header to point to displaced mark.</span></span><br><span class="line">    <span class="comment">// Must release storing the lock address for platforms without TSO</span></span><br><span class="line">    <span class="comment">// ordering (e.g. ppc).</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">//将Obj的信息指向了高位锁，就是形成了一个轻量级锁</span></span><br><span class="line">    obj-&gt;<span class="built_in">release_set_mark</span>(markOopDesc::<span class="built_in">encode</span>(highest_lock));</span><br><span class="line">    <span class="built_in">assert</span>(!obj-&gt;<span class="built_in">mark</span>()-&gt;<span class="built_in">has_bias_pattern</span>(), <span class="string">&quot;illegal mark state: stack lock used bias bit&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (TraceBiasedLocking &amp;&amp; (Verbose || !is_bulk)) &#123;</span><br><span class="line">      tty-&gt;<span class="built_in">print_cr</span>(<span class="string">&quot;  Revoked bias of currently-locked object&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">//反之Highest为空则说明没有线程持有锁</span></span><br><span class="line">    <span class="keyword">if</span> (TraceBiasedLocking &amp;&amp; (Verbose || !is_bulk)) &#123;</span><br><span class="line">      tty-&gt;<span class="built_in">print_cr</span>(<span class="string">&quot;  Revoked bias of currently-unlocked object&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (allow_rebias) &#123;</span><br><span class="line">        <span class="comment">//如果可以偏向则重新偏向 我们传入的是false</span></span><br><span class="line">      obj-&gt;<span class="built_in">set_mark</span>(biased_prototype);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Store the unlocked value into the object&#x27;s header.</span></span><br><span class="line">        <span class="comment">//将锁设为无锁状态</span></span><br><span class="line">      obj-&gt;<span class="built_in">set_mark</span>(unbiased_prototype);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment">//返回已经撤销锁信号</span></span><br><span class="line">  <span class="keyword">return</span> BiasedLocking::BIAS_REVOKED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h3 id="slow-enter"   >
          <a href="#slow-enter" class="heading-link"><i class="fas fa-link"></i></a><a href="#slow-enter" class="headerlink" title="slow_enter"></a>slow_enter</h3>
      <figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ObjectSynchronizer::slow_enter</span><span class="params">(Handle obj, BasicLock* lock, TRAPS)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//获得头信息</span></span><br><span class="line">  markOop mark = obj-&gt;<span class="built_in">mark</span>();</span><br><span class="line">  <span class="built_in">assert</span>(!mark-&gt;<span class="built_in">has_bias_pattern</span>(), <span class="string">&quot;should not see bias pattern here&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (mark-&gt;<span class="built_in">is_neutral</span>()) &#123;</span><br><span class="line">      <span class="comment">//如果记录是一个无锁状态</span></span><br><span class="line">    <span class="comment">// Anticipate successful CAS -- the ST of the displaced mark must</span></span><br><span class="line">    <span class="comment">// be visible &lt;= the ST performed by the CAS.</span></span><br><span class="line">      <span class="comment">//将锁设置成头信息</span></span><br><span class="line">    lock-&gt;<span class="built_in">set_displaced_header</span>(mark);</span><br><span class="line">    <span class="keyword">if</span> (mark == (markOop) Atomic::<span class="built_in">cmpxchg_ptr</span>(lock, <span class="built_in">obj</span>()-&gt;<span class="built_in">mark_addr</span>(), mark)) &#123;</span><br><span class="line">      <span class="comment">//CAS操作，成功即是轻量级锁</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">TEVENT</span> (slow_enter: release stacklock) ;</span><br><span class="line">      <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Fall through to inflate() ...</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mark-&gt;<span class="built_in">has_locker</span>() &amp;&amp; THREAD-&gt;<span class="built_in">is_lock_owned</span>((address)mark-&gt;<span class="built_in">locker</span>())) &#123;</span><br><span class="line">      <span class="comment">//反之锁已经有拥有者了，判断当前线程是否是持锁线程</span></span><br><span class="line">    <span class="built_in">assert</span>(lock != mark-&gt;<span class="built_in">locker</span>(), <span class="string">&quot;must not re-lock the same lock&quot;</span>);</span><br><span class="line">    <span class="built_in">assert</span>(lock != (BasicLock*)obj-&gt;<span class="built_in">mark</span>(), <span class="string">&quot;don&#x27;t relock with same BasicLock&quot;</span>);</span><br><span class="line">      <span class="comment">//如果是说明是轻量级锁的重入,将下一个Lock的头设为Null</span></span><br><span class="line">    lock-&gt;<span class="built_in">set_displaced_header</span>(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">  <span class="comment">// The following optimization isn&#x27;t particularly useful.</span></span><br><span class="line">  <span class="keyword">if</span> (mark-&gt;<span class="built_in">has_monitor</span>() &amp;&amp; mark-&gt;<span class="built_in">monitor</span>()-&gt;<span class="built_in">is_entered</span>(THREAD)) &#123; </span><br><span class="line">    lock-&gt;<span class="built_in">set_displaced_header</span> (<span class="literal">NULL</span>) ;</span><br><span class="line">    <span class="keyword">return</span> ;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// The object header will never be displaced to this lock,</span></span><br><span class="line">  <span class="comment">// so it does not matter what the value is, except that it</span></span><br><span class="line">  <span class="comment">// must be non-zero to avoid looking like a re-entrant lock,</span></span><br><span class="line">  <span class="comment">// and must not look locked either.</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//以上是轻量级锁的膨胀过程，下面是重量级锁的过程</span></span><br><span class="line">  lock-&gt;<span class="built_in">set_displaced_header</span>(markOopDesc::<span class="built_in">unused_mark</span>());</span><br><span class="line">  ObjectSynchronizer::<span class="built_in">inflate</span>(THREAD, <span class="built_in">obj</span>())-&gt;<span class="built_in">enter</span>(THREAD);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>这里是上面没有详细说到的东西</p>

        <h3 id="①轻量级锁重入"   >
          <a href="#①轻量级锁重入" class="heading-link"><i class="fas fa-link"></i></a><a href="#①轻量级锁重入" class="headerlink" title="①轻量级锁重入"></a>①轻量级锁重入</h3>
      <p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230803012321008.png"  alt="轻量级锁重入">
      </p>

        <h3 id="②线程安全点"   >
          <a href="#②线程安全点" class="heading-link"><i class="fas fa-link"></i></a><a href="#②线程安全点" class="headerlink" title="②线程安全点"></a>②线程安全点</h3>
      <p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230803014810909.png"  alt="线程安全点">
      </p>

        <h3 id="③轻量级锁膨胀流程图"   >
          <a href="#③轻量级锁膨胀流程图" class="heading-link"><i class="fas fa-link"></i></a><a href="#③轻量级锁膨胀流程图" class="headerlink" title="③轻量级锁膨胀流程图"></a>③轻量级锁膨胀流程图</h3>
      <p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230803015339537.png"  alt="轻量级锁膨胀流程图">
      </p>

        <h3 id="④撤销偏向锁流程图"   >
          <a href="#④撤销偏向锁流程图" class="heading-link"><i class="fas fa-link"></i></a><a href="#④撤销偏向锁流程图" class="headerlink" title="④撤销偏向锁流程图"></a>④撤销偏向锁流程图</h3>
      <p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230803022234477.png"  alt="撤销偏向锁(1)">
      </p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230803022147767.png"  alt="撤销偏向锁(2)">
      </p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230803023201645.png"  alt="撤销偏向锁(3)">
      </p>

        <h2 id="重量级锁-ObjectSynchronizer-inflate"   >
          <a href="#重量级锁-ObjectSynchronizer-inflate" class="heading-link"><i class="fas fa-link"></i></a><a href="#重量级锁-ObjectSynchronizer-inflate" class="headerlink" title="重量级锁(ObjectSynchronizer::inflate)"></a>重量级锁(ObjectSynchronizer::inflate)</h2>
      <figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ObjectMonitor * ATTR <span class="title">ObjectSynchronizer::inflate</span> <span class="params">(Thread * Self, oop object)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    参数一：线程</span></span><br><span class="line"><span class="comment">    参数二：持锁线程和BasicObjectLock</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    </span><br><span class="line">  <span class="comment">// Inflate mutates the heap ...</span></span><br><span class="line">  <span class="comment">// Relaxing assertion for bug 6320749.</span></span><br><span class="line">  <span class="built_in">assert</span> (Universe::<span class="built_in">verify_in_progress</span>() ||</span><br><span class="line">          !SafepointSynchronize::<span class="built_in">is_at_safepoint</span>(), <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//死循环(自旋)</span></span><br><span class="line">  <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">      <span class="comment">//获得头信息</span></span><br><span class="line">      <span class="type">const</span> markOop mark = object-&gt;<span class="built_in">mark</span>() ;</span><br><span class="line">      <span class="built_in">assert</span> (!mark-&gt;<span class="built_in">has_bias_pattern</span>(), <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// The mark can be in one of the following states:</span></span><br><span class="line">      <span class="comment">// *  Inflated     - just return</span></span><br><span class="line">      <span class="comment">// *  Stack-locked - coerce it to inflated</span></span><br><span class="line">      <span class="comment">// *  INFLATING    - busy wait for conversion to complete</span></span><br><span class="line">      <span class="comment">// *  Neutral      - aggressively inflate the object.</span></span><br><span class="line">      <span class="comment">// *  BIASED       - Illegal.  We should never see this</span></span><br><span class="line">		</span><br><span class="line">      <span class="comment">//情况1：已经是一个重量级锁</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">// CASE: inflated</span></span><br><span class="line">      <span class="keyword">if</span> (mark-&gt;<span class="built_in">has_monitor</span>()) &#123;</span><br><span class="line">          <span class="comment">//has_monitor方法调用之后如果有的话返回True 说明这把锁已经是重量级锁 </span></span><br><span class="line">          ObjectMonitor * inf = mark-&gt;<span class="built_in">monitor</span>() ;</span><br><span class="line">          <span class="built_in">assert</span> (inf-&gt;<span class="built_in">header</span>()-&gt;<span class="built_in">is_neutral</span>(), <span class="string">&quot;invariant&quot;</span>);</span><br><span class="line">          <span class="built_in">assert</span> (inf-&gt;<span class="built_in">object</span>() == object, <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">          <span class="built_in">assert</span> (ObjectSynchronizer::<span class="built_in">verify_objmon_isinpool</span>(inf), <span class="string">&quot;monitor is invalid&quot;</span>);</span><br><span class="line">          <span class="comment">//将monitor返回</span></span><br><span class="line">          <span class="keyword">return</span> inf ;</span><br><span class="line">      &#125;</span><br><span class="line">	</span><br><span class="line">      <span class="comment">//情况2:这把锁处于一个轻量级锁膨胀到重量级的中间态(正在膨胀没有完成)</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">// CASE: inflation in progress - inflating over a stack-lock.</span></span><br><span class="line">      <span class="comment">// Some other thread is converting from stack-locked to inflated.</span></span><br><span class="line">      <span class="comment">// Only that thread can complete inflation -- other threads must wait.</span></span><br><span class="line">      <span class="comment">// The INFLATING value is transient.</span></span><br><span class="line">      <span class="comment">// Currently, we spin/yield/park and poll the markword, waiting for inflation to finish.</span></span><br><span class="line">      <span class="comment">// We could always eliminate polling by parking the thread on some auxiliary list.</span></span><br><span class="line">      <span class="keyword">if</span> (mark == markOopDesc::<span class="built_in">INFLATING</span>()) &#123;</span><br><span class="line">          </span><br><span class="line">          <span class="comment">//如果是中间态就让出CPU 然后continue重新判断是否处于中间状态</span></span><br><span class="line">          </span><br><span class="line">         <span class="built_in">TEVENT</span> (Inflate: spin <span class="keyword">while</span> INFLATING) ;</span><br><span class="line">         <span class="built_in">ReadStableMark</span>(object) ;</span><br><span class="line">         <span class="keyword">continue</span> ;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// CASE: stack-locked</span></span><br><span class="line">      <span class="comment">// Could be stack-locked either by this thread or by some other thread.</span></span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">      <span class="comment">// Note that we allocate the objectmonitor speculatively, _before_ attempting</span></span><br><span class="line">      <span class="comment">// to install INFLATING into the mark word.  We originally installed INFLATING,</span></span><br><span class="line">      <span class="comment">// allocated the objectmonitor, and then finally STed the address of the</span></span><br><span class="line">      <span class="comment">// objectmonitor into the mark.  This was correct, but artificially lengthened</span></span><br><span class="line">      <span class="comment">// the interval in which INFLATED appeared in the mark, thus increasing</span></span><br><span class="line">      <span class="comment">// the odds of inflation contention.</span></span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">      <span class="comment">// We now use per-thread private objectmonitor free lists.</span></span><br><span class="line">      <span class="comment">// These list are reprovisioned from the global free list outside the</span></span><br><span class="line">      <span class="comment">// critical INFLATING...ST interval.  A thread can transfer</span></span><br><span class="line">      <span class="comment">// multiple objectmonitors en-mass from the global free list to its local free list.</span></span><br><span class="line">      <span class="comment">// This reduces coherency traffic and lock contention on the global free list.</span></span><br><span class="line">      <span class="comment">// Using such local free lists, it doesn&#x27;t matter if the omAlloc() call appears</span></span><br><span class="line">      <span class="comment">// before or after the CAS(INFLATING) operation.</span></span><br><span class="line">      <span class="comment">// See the comments in omAlloc().</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">//情况3：目前这把锁是一把轻量级锁，轻量级锁要膨胀到重量级锁</span></span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (mark-&gt;<span class="built_in">has_locker</span>()) &#123;</span><br><span class="line">          <span class="comment">//omalloc申请一个monitor m</span></span><br><span class="line">          </span><br><span class="line">          ObjectMonitor * m = <span class="built_in">omAlloc</span> (Self) ;</span><br><span class="line">          <span class="comment">// Optimistically prepare the objectmonitor - anticipate successful CAS</span></span><br><span class="line">          <span class="comment">// We do this before the CAS in order to minimize the length of time</span></span><br><span class="line">          <span class="comment">// in which INFLATING appears in the mark.</span></span><br><span class="line">          </span><br><span class="line">          <span class="comment">//m的初始化</span></span><br><span class="line">          </span><br><span class="line">          m-&gt;<span class="built_in">Recycle</span>();</span><br><span class="line">          m-&gt;_Responsible  = <span class="literal">NULL</span> ;</span><br><span class="line">          m-&gt;OwnerIsThread = <span class="number">0</span> ;</span><br><span class="line">          m-&gt;_recursions   = <span class="number">0</span> ;</span><br><span class="line">          m-&gt;_SpinDuration = ObjectMonitor::Knob_SpinLimit ;   <span class="comment">// Consider: maintain by type/class</span></span><br><span class="line">		</span><br><span class="line">          <span class="comment">//CAS将这个监视器的信息设置为正在膨胀的中间态(情况2)</span></span><br><span class="line">          markOop cmp = (markOop) Atomic::<span class="built_in">cmpxchg_ptr</span> (markOopDesc::<span class="built_in">INFLATING</span>(), object-&gt;<span class="built_in">mark_addr</span>(), mark);</span><br><span class="line">          </span><br><span class="line">          <span class="comment">//判断CAS操作是否成功</span></span><br><span class="line">          <span class="keyword">if</span> (cmp != mark) &#123;</span><br><span class="line">              <span class="comment">//CAS失败 释放监控器，然后continue重试</span></span><br><span class="line">             <span class="built_in">omRelease</span> (Self, m, <span class="literal">true</span>) ;</span><br><span class="line">             <span class="keyword">continue</span> ;       <span class="comment">// Interference -- just retry</span></span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// We&#x27;ve successfully installed INFLATING (0) into the mark-word.</span></span><br><span class="line">          <span class="comment">// This is the only case where 0 will appear in a mark-work.</span></span><br><span class="line">          <span class="comment">// Only the singular thread that successfully swings the mark-word</span></span><br><span class="line">          <span class="comment">// to 0 can perform (or more precisely, complete) inflation.</span></span><br><span class="line">          <span class="comment">//</span></span><br><span class="line">          <span class="comment">// Why do we CAS a 0 into the mark-word instead of just CASing the</span></span><br><span class="line">          <span class="comment">// mark-word from the stack-locked value directly to the new inflated state?</span></span><br><span class="line">          <span class="comment">// Consider what happens when a thread unlocks a stack-locked object.</span></span><br><span class="line">          <span class="comment">// It attempts to use CAS to swing the displaced header value from the</span></span><br><span class="line">          <span class="comment">// on-stack basiclock back into the object header.  Recall also that the</span></span><br><span class="line">          <span class="comment">// header value (hashcode, etc) can reside in (a) the object header, or</span></span><br><span class="line">          <span class="comment">// (b) a displaced header associated with the stack-lock, or (c) a displaced</span></span><br><span class="line">          <span class="comment">// header in an objectMonitor.  The inflate() routine must copy the header</span></span><br><span class="line">          <span class="comment">// value from the basiclock on the owner&#x27;s stack to the objectMonitor, all</span></span><br><span class="line">          <span class="comment">// the while preserving the hashCode stability invariants.  If the owner</span></span><br><span class="line">          <span class="comment">// decides to release the lock while the value is 0, the unlock will fail</span></span><br><span class="line">          <span class="comment">// and control will eventually pass from slow_exit() to inflate.  The owner</span></span><br><span class="line">          <span class="comment">// will then spin, waiting for the 0 value to disappear.   Put another way,</span></span><br><span class="line">          <span class="comment">// the 0 causes the owner to stall if the owner happens to try to</span></span><br><span class="line">          <span class="comment">// drop the lock (restoring the header from the basiclock to the object)</span></span><br><span class="line">          <span class="comment">// while inflation is in-progress.  This protocol avoids races that might</span></span><br><span class="line">          <span class="comment">// would otherwise permit hashCode values to change or &quot;flicker&quot; for an object.</span></span><br><span class="line">          <span class="comment">// Critically, while object-&gt;mark is 0 mark-&gt;displaced_mark_helper() is stable.</span></span><br><span class="line">          <span class="comment">// 0 serves as a &quot;BUSY&quot; inflate-in-progress indicator.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">          <span class="comment">// fetch the displaced mark from the owner&#x27;s stack.</span></span><br><span class="line">          <span class="comment">// The owner can&#x27;t die or unwind past the lock while our INFLATING</span></span><br><span class="line">          <span class="comment">// object is in the mark.  Furthermore the owner can&#x27;t complete</span></span><br><span class="line">          <span class="comment">// an unlock on the object, either.</span></span><br><span class="line">          </span><br><span class="line">          </span><br><span class="line">          <span class="comment">//运行到这里锁是轻量级锁，并且已经将头信息标记成正在膨胀的状态 并且cas成功</span></span><br><span class="line">          </span><br><span class="line">          <span class="comment">//获取头信息</span></span><br><span class="line">          markOop dmw = mark-&gt;<span class="built_in">displaced_mark_helper</span>() ;</span><br><span class="line">          <span class="built_in">assert</span> (dmw-&gt;<span class="built_in">is_neutral</span>(), <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Setup monitor fields to proper values -- prepare the monitor</span></span><br><span class="line">          </span><br><span class="line">          <span class="comment">//将监控器的头信息更新</span></span><br><span class="line">          m-&gt;<span class="built_in">set_header</span>(dmw) ;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Optimization: if the mark-&gt;locker stack address is associated</span></span><br><span class="line">          <span class="comment">// with this thread we could simply set m-&gt;_owner = Self and</span></span><br><span class="line">          <span class="comment">// m-&gt;OwnerIsThread = 1. Note that a thread can inflate an object</span></span><br><span class="line">          <span class="comment">// that it has stack-locked -- as might happen in wait() -- directly</span></span><br><span class="line">          <span class="comment">// with CAS.  That is, we can avoid the xchg-NULL .... ST idiom.</span></span><br><span class="line">          </span><br><span class="line">          <span class="comment">//监视器的owner指向头信息中的locker</span></span><br><span class="line">          </span><br><span class="line">          m-&gt;<span class="built_in">set_owner</span>(mark-&gt;<span class="built_in">locker</span>());</span><br><span class="line">          </span><br><span class="line">          <span class="comment">//监视器的object设置成当前object</span></span><br><span class="line">          </span><br><span class="line">          m-&gt;<span class="built_in">set_object</span>(object);</span><br><span class="line">          <span class="comment">// TODO-<span class="doctag">FIXME:</span> assert BasicLock-&gt;dhw != 0.</span></span><br><span class="line"></span><br><span class="line">          <span class="comment">// Must preserve store ordering. The monitor state must</span></span><br><span class="line">          <span class="comment">// be stable at the time of publishing the monitor address.</span></span><br><span class="line">          <span class="built_in">guarantee</span> (object-&gt;<span class="built_in">mark</span>() == markOopDesc::<span class="built_in">INFLATING</span>(), <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">          </span><br><span class="line">          <span class="comment">//更新object中的信息</span></span><br><span class="line">          object-&gt;<span class="built_in">release_set_mark</span>(markOopDesc::<span class="built_in">encode</span>(m));</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Hopefully the performance counters are allocated on distinct cache lines</span></span><br><span class="line">          <span class="comment">// to avoid false sharing on MP systems ...</span></span><br><span class="line">          <span class="comment">//将计数器分布到不同的缓存行中???</span></span><br><span class="line">          <span class="keyword">if</span> (ObjectMonitor::_sync_Inflations != <span class="literal">NULL</span>) ObjectMonitor::_sync_Inflations-&gt;<span class="built_in">inc</span>() ;</span><br><span class="line">          <span class="built_in">TEVENT</span>(Inflate: overwrite stacklock) ;</span><br><span class="line">          <span class="keyword">if</span> (TraceMonitorInflation) &#123;</span><br><span class="line">            <span class="keyword">if</span> (object-&gt;<span class="built_in">is_instance</span>()) &#123;</span><br><span class="line">              ResourceMark rm;</span><br><span class="line">              tty-&gt;<span class="built_in">print_cr</span>(<span class="string">&quot;Inflating object &quot;</span> INTPTR_FORMAT <span class="string">&quot; , mark &quot;</span> INTPTR_FORMAT <span class="string">&quot; , type %s&quot;</span>,</span><br><span class="line">                (<span class="type">void</span> *) object, (<span class="type">intptr_t</span>) object-&gt;<span class="built_in">mark</span>(),</span><br><span class="line">                object-&gt;<span class="built_in">klass</span>()-&gt;<span class="built_in">external_name</span>());</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          </span><br><span class="line">          <span class="comment">//返回监视器</span></span><br><span class="line">          <span class="keyword">return</span> m ;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// CASE: neutral</span></span><br><span class="line">      <span class="comment">// TODO-<span class="doctag">FIXME:</span> for entry we currently inflate and then try to CAS _owner.</span></span><br><span class="line">      <span class="comment">// If we know we&#x27;re inflating for entry it&#x27;s better to inflate by swinging a</span></span><br><span class="line">      <span class="comment">// pre-locked objectMonitor pointer into the object header.   A successful</span></span><br><span class="line">      <span class="comment">// CAS inflates the object *and* confers ownership to the inflating thread.</span></span><br><span class="line">      <span class="comment">// In the current implementation we use a 2-step mechanism where we CAS()</span></span><br><span class="line">      <span class="comment">// to inflate and then CAS() again to try to swing _owner from NULL to Self.</span></span><br><span class="line">      <span class="comment">// An inflateTry() method that we could call from fast_enter() and slow_enter()</span></span><br><span class="line">      <span class="comment">// would be useful.</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">//情况4：现在状态是个无锁状态</span></span><br><span class="line">      </span><br><span class="line">      <span class="built_in">assert</span> (mark-&gt;<span class="built_in">is_neutral</span>(), <span class="string">&quot;invariant&quot;</span>);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//申请一个监视器</span></span><br><span class="line">      ObjectMonitor * m = <span class="built_in">omAlloc</span> (Self) ;</span><br><span class="line">      <span class="comment">// prepare m for installation - set monitor to initial state</span></span><br><span class="line">      m-&gt;<span class="built_in">Recycle</span>();</span><br><span class="line">      m-&gt;<span class="built_in">set_header</span>(mark);</span><br><span class="line">      m-&gt;<span class="built_in">set_owner</span>(<span class="literal">NULL</span>);</span><br><span class="line">      m-&gt;<span class="built_in">set_object</span>(object);  <span class="comment">//监视器监视当前Object</span></span><br><span class="line">      m-&gt;OwnerIsThread = <span class="number">1</span> ;  <span class="comment">//锁持有者设置为1</span></span><br><span class="line">      m-&gt;_recursions   = <span class="number">0</span> ;</span><br><span class="line">      m-&gt;_Responsible  = <span class="literal">NULL</span> ;</span><br><span class="line">      m-&gt;_SpinDuration = ObjectMonitor::Knob_SpinLimit ;       <span class="comment">// consider: keep metastats by type/class</span></span><br><span class="line">	</span><br><span class="line">      <span class="comment">//CAS操作更新监视器信息</span></span><br><span class="line">      <span class="keyword">if</span> (Atomic::<span class="built_in">cmpxchg_ptr</span> (markOopDesc::<span class="built_in">encode</span>(m), object-&gt;<span class="built_in">mark_addr</span>(), mark) != mark) &#123;</span><br><span class="line">          <span class="comment">//如果更新，说明有竞争，然后释放当前监视器，重新循环</span></span><br><span class="line">          </span><br><span class="line">          m-&gt;<span class="built_in">set_object</span> (<span class="literal">NULL</span>) ;</span><br><span class="line">          m-&gt;<span class="built_in">set_owner</span>  (<span class="literal">NULL</span>) ;</span><br><span class="line">          m-&gt;OwnerIsThread = <span class="number">0</span> ;</span><br><span class="line">          m-&gt;<span class="built_in">Recycle</span>() ;</span><br><span class="line">          <span class="built_in">omRelease</span> (Self, m, <span class="literal">true</span>) ;</span><br><span class="line">          m = <span class="literal">NULL</span> ;</span><br><span class="line">          <span class="keyword">continue</span> ;</span><br><span class="line">          <span class="comment">// interference - the markword changed - just retry.</span></span><br><span class="line">          <span class="comment">// The state-transitions are one-way, so there&#x27;s no chance of</span></span><br><span class="line">          <span class="comment">// live-lock -- &quot;Inflated&quot; is an absorbing state.</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Hopefully the performance counters are allocated on distinct</span></span><br><span class="line">      <span class="comment">// cache lines to avoid false sharing on MP systems ...</span></span><br><span class="line">      <span class="keyword">if</span> (ObjectMonitor::_sync_Inflations != <span class="literal">NULL</span>) ObjectMonitor::_sync_Inflations-&gt;<span class="built_in">inc</span>() ;</span><br><span class="line">      <span class="built_in">TEVENT</span>(Inflate: overwrite neutral) ;</span><br><span class="line">      <span class="keyword">if</span> (TraceMonitorInflation) &#123;</span><br><span class="line">        <span class="keyword">if</span> (object-&gt;<span class="built_in">is_instance</span>()) &#123;</span><br><span class="line">          ResourceMark rm;</span><br><span class="line">          tty-&gt;<span class="built_in">print_cr</span>(<span class="string">&quot;Inflating object &quot;</span> INTPTR_FORMAT <span class="string">&quot; , mark &quot;</span> INTPTR_FORMAT <span class="string">&quot; , type %s&quot;</span>,</span><br><span class="line">            (<span class="type">void</span> *) object, (<span class="type">intptr_t</span>) object-&gt;<span class="built_in">mark</span>(),</span><br><span class="line">            object-&gt;<span class="built_in">klass</span>()-&gt;<span class="built_in">external_name</span>());</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> m ;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">//膨胀过程本质上就是获取监视器，而具体的加锁要在Entry方法中</span></span><br></pre></td></tr></table></div></figure>




        <h3 id="重量级锁加锁流程图-膨胀"   >
          <a href="#重量级锁加锁流程图-膨胀" class="heading-link"><i class="fas fa-link"></i></a><a href="#重量级锁加锁流程图-膨胀" class="headerlink" title="重量级锁加锁流程图(膨胀)"></a>重量级锁加锁流程图(膨胀)</h3>
      <p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230803172249972.png"  alt="重量级锁加锁流程图(膨胀)">
      </p>
<p><em><strong>膨胀过程本质上就是获取一个监视器</strong>，返回监视器，而具体加锁在监视器中的Entry方法中</em></p>
<p><em>过程就是判断是否有可用的Monitor，如果没有创建一个公共可用的Monitor数组(1024个)，然后将指向的监视器放到当前线程下可用的监视器中，然后公共可用的Monitor减少一个，具体代码如下</em></p>

        <h3 id="申请监视器"   >
          <a href="#申请监视器" class="heading-link"><i class="fas fa-link"></i></a><a href="#申请监视器" class="headerlink" title="申请监视器"></a>申请监视器</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line">ObjectMonitor * ATTR ObjectSynchronizer::omAlloc (Thread * Self) &#123;</span><br><span class="line">    <span class="comment">// A large MAXPRIVATE value reduces both list lock contention</span></span><br><span class="line">    <span class="comment">// and list coherency traffic, but also tends to increase the</span></span><br><span class="line">    <span class="comment">// number of objectMonitors in circulation as well as the STW</span></span><br><span class="line">    <span class="comment">// scavenge costs.  As usual, we lean toward time in space-time</span></span><br><span class="line">    <span class="comment">// tradeoffs.</span></span><br><span class="line">    const <span class="type">int</span> <span class="variable">MAXPRIVATE</span> <span class="operator">=</span> <span class="number">1024</span> ;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        ObjectMonitor * m ;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1: try to allocate from the thread&#x27;s local omFreeList.</span></span><br><span class="line">        <span class="comment">// Threads will attempt to allocate first from their local list, then</span></span><br><span class="line">        <span class="comment">// from the global list, and only after those attempts fail will the thread</span></span><br><span class="line">        <span class="comment">// attempt to instantiate new monitors.   Thread-local free lists take</span></span><br><span class="line">        <span class="comment">// heat off the ListLock and improve allocation latency, as well as reducing</span></span><br><span class="line">        <span class="comment">// coherency traffic on the shared global list.</span></span><br><span class="line">        m = Self-&gt;omFreeList ;</span><br><span class="line">        <span class="keyword">if</span> (m != NULL) &#123;</span><br><span class="line">           Self-&gt;omFreeList = m-&gt;FreeNext ;</span><br><span class="line">           Self-&gt;omFreeCount -- ;</span><br><span class="line">           <span class="comment">// CONSIDER: set m-&gt;FreeNext = BAD -- diagnostic hygiene</span></span><br><span class="line">           guarantee (m-&gt;object() == NULL, <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">           <span class="keyword">if</span> (MonitorInUseLists) &#123;</span><br><span class="line">             m-&gt;FreeNext = Self-&gt;omInUseList;</span><br><span class="line">             Self-&gt;omInUseList = m;</span><br><span class="line">             Self-&gt;omInUseCount ++;</span><br><span class="line">             <span class="comment">// verifyInUse(Self);</span></span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             m-&gt;FreeNext = NULL;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> m ;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2: try to allocate from the global gFreeList</span></span><br><span class="line">        <span class="comment">// CONSIDER: use muxTry() instead of muxAcquire().</span></span><br><span class="line">        <span class="comment">// If the muxTry() fails then drop immediately into case 3.</span></span><br><span class="line">        <span class="comment">// If we&#x27;re using thread-local free lists then try</span></span><br><span class="line">        <span class="comment">// to reprovision the caller&#x27;s free list.</span></span><br><span class="line">        <span class="keyword">if</span> (gFreeList != NULL) &#123;</span><br><span class="line">            <span class="comment">// Reprovision the thread&#x27;s omFreeList.</span></span><br><span class="line">            <span class="comment">// Use bulk transfers to reduce the allocation rate and heat</span></span><br><span class="line">            <span class="comment">// on various locks.</span></span><br><span class="line">            Thread::muxAcquire (&amp;ListLock, <span class="string">&quot;omAlloc&quot;</span>) ;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> Self-&gt;omFreeProvision; --i &gt;= <span class="number">0</span> &amp;&amp; gFreeList != NULL; ) &#123;</span><br><span class="line">                MonitorFreeCount --;</span><br><span class="line">                ObjectMonitor * take = gFreeList ;</span><br><span class="line">                gFreeList = take-&gt;FreeNext ;</span><br><span class="line">                guarantee (take-&gt;object() == NULL, <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">                guarantee (!take-&gt;is_busy(), <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">                take-&gt;Recycle() ;</span><br><span class="line">                omRelease (Self, take, <span class="literal">false</span>) ;</span><br><span class="line">            &#125;</span><br><span class="line">            Thread::muxRelease (&amp;ListLock) ;</span><br><span class="line">            Self-&gt;omFreeProvision += <span class="number">1</span> + (Self-&gt;omFreeProvision/<span class="number">2</span>) ;</span><br><span class="line">            <span class="keyword">if</span> (Self-&gt;omFreeProvision &gt; MAXPRIVATE ) Self-&gt;omFreeProvision = MAXPRIVATE ;</span><br><span class="line">            TEVENT (omFirst - reprovision) ;</span><br><span class="line"></span><br><span class="line">            const <span class="type">int</span> <span class="variable">mx</span> <span class="operator">=</span> MonitorBound ;</span><br><span class="line">            <span class="keyword">if</span> (mx &gt; <span class="number">0</span> &amp;&amp; (MonitorPopulation-MonitorFreeCount) &gt; mx) &#123;</span><br><span class="line">              <span class="comment">// We can&#x27;t safely induce a STW safepoint from omAlloc() as our thread</span></span><br><span class="line">              <span class="comment">// state may not be appropriate for such activities and callers may hold</span></span><br><span class="line">              <span class="comment">// naked oops, so instead we defer the action.</span></span><br><span class="line">              InduceScavenge (Self, <span class="string">&quot;omAlloc&quot;</span>) ;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3: allocate a block of new ObjectMonitors</span></span><br><span class="line">        <span class="comment">// Both the local and global free lists are empty -- resort to malloc().</span></span><br><span class="line">        <span class="comment">// In the current implementation objectMonitors are TSM - immortal.</span></span><br><span class="line">        <span class="keyword">assert</span> (_BLOCKSIZE &gt; <span class="number">1</span>, <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">        ObjectMonitor * temp = <span class="keyword">new</span> <span class="title class_">ObjectMonitor</span>[_BLOCKSIZE];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> (almost) no way to recover if allocation failed.</span></span><br><span class="line">        <span class="comment">// We might be able to induce a STW safepoint and scavenge enough</span></span><br><span class="line">        <span class="comment">// objectMonitors to permit progress.</span></span><br><span class="line">        <span class="keyword">if</span> (temp == NULL) &#123;</span><br><span class="line">            vm_exit_out_of_memory (sizeof (ObjectMonitor[_BLOCKSIZE]), OOM_MALLOC_ERROR,</span><br><span class="line">                                   <span class="string">&quot;Allocate ObjectMonitors&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Format the block.</span></span><br><span class="line">        <span class="comment">// initialize the linked list, each monitor points to its next</span></span><br><span class="line">        <span class="comment">// forming the single linked free list, the very first monitor</span></span><br><span class="line">        <span class="comment">// will points to next block, which forms the block list.</span></span><br><span class="line">        <span class="comment">// The trick of using the 1st element in the block as gBlockList</span></span><br><span class="line">        <span class="comment">// linkage should be reconsidered.  A better implementation would</span></span><br><span class="line">        <span class="comment">// look like: class Block &#123; Block * next; int N; ObjectMonitor Body [N] ; &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; _BLOCKSIZE ; i++) &#123;</span><br><span class="line">           temp[i].FreeNext = &amp;temp[i+<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// terminate the last monitor as the end of list</span></span><br><span class="line">        temp[_BLOCKSIZE - <span class="number">1</span>].FreeNext = NULL ;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Element [0] is reserved for global list linkage</span></span><br><span class="line">        temp[<span class="number">0</span>].set_object(CHAINMARKER);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Consider carving out this thread&#x27;s current request from the</span></span><br><span class="line">        <span class="comment">// block in hand.  This avoids some lock traffic and redundant</span></span><br><span class="line">        <span class="comment">// list activity.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Acquire the ListLock to manipulate BlockList and FreeList.</span></span><br><span class="line">        <span class="comment">// An Oyama-Taura-Yonezawa scheme might be more efficient.</span></span><br><span class="line">        Thread::muxAcquire (&amp;ListLock, <span class="string">&quot;omAlloc [2]&quot;</span>) ;</span><br><span class="line">        MonitorPopulation += _BLOCKSIZE-<span class="number">1</span>;</span><br><span class="line">        MonitorFreeCount += _BLOCKSIZE-<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Add the new block to the list of extant blocks (gBlockList).</span></span><br><span class="line">        <span class="comment">// The very first objectMonitor in a block is reserved and dedicated.</span></span><br><span class="line">        <span class="comment">// It serves as blocklist &quot;next&quot; linkage.</span></span><br><span class="line">        temp[<span class="number">0</span>].FreeNext = gBlockList;</span><br><span class="line">        gBlockList = temp;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Add the new string of objectMonitors to the global free list</span></span><br><span class="line">        temp[_BLOCKSIZE - <span class="number">1</span>].FreeNext = gFreeList ;</span><br><span class="line">        gFreeList = temp + <span class="number">1</span>;</span><br><span class="line">        Thread::muxRelease (&amp;ListLock) ;</span><br><span class="line">        TEVENT (Allocate block of monitors) ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="重量级锁竞争"   >
          <a href="#重量级锁竞争" class="heading-link"><i class="fas fa-link"></i></a><a href="#重量级锁竞争" class="headerlink" title="重量级锁竞争"></a>重量级锁竞争</h3>
      
        <h4 id="ObjectMonitor-enter"   >
          <a href="#ObjectMonitor-enter" class="heading-link"><i class="fas fa-link"></i></a><a href="#ObjectMonitor-enter" class="headerlink" title="ObjectMonitor::enter"></a>ObjectMonitor::enter</h4>
      <figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> ATTR <span class="title">ObjectMonitor::enter</span><span class="params">(TRAPS)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// The following code is ordered to check the most common cases first</span></span><br><span class="line">  <span class="comment">// and to reduce RTS-&gt;RTO cache line upgrades on SPARC and IA32 processors.</span></span><br><span class="line">  Thread * <span class="type">const</span> Self = THREAD ;</span><br><span class="line">  <span class="type">void</span> * cur ;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//记录当前线程，CUR记录CAS结果 </span></span><br><span class="line">  <span class="comment">//cas成功会返回null</span></span><br><span class="line">  cur = Atomic::<span class="built_in">cmpxchg_ptr</span> (Self, &amp;_owner, <span class="literal">NULL</span>) ;</span><br><span class="line">  <span class="keyword">if</span> (cur == <span class="literal">NULL</span>) &#123;</span><br><span class="line">      <span class="comment">//CAS成功 即加锁成功</span></span><br><span class="line">      </span><br><span class="line">     <span class="comment">// Either ASSERT _recursions == 0 or explicitly set _recursions = 0.</span></span><br><span class="line">     <span class="built_in">assert</span> (_recursions == <span class="number">0</span>   , <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">     <span class="built_in">assert</span> (_owner      == Self, <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">     <span class="comment">// CONSIDER: set or assert OwnerIsThread == 1</span></span><br><span class="line">     <span class="keyword">return</span> ;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (cur == Self) &#123;</span><br><span class="line">      <span class="comment">//判断是否是当前线程，如果是就是重量级锁重入</span></span><br><span class="line">     <span class="comment">// TODO-<span class="doctag">FIXME:</span> check for integer overflow!  BUGID 6557169.</span></span><br><span class="line">     _recursions ++ ;</span><br><span class="line">      <span class="comment">//重量级锁重入次数++</span></span><br><span class="line">     <span class="keyword">return</span> ;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (Self-&gt;<span class="built_in">is_lock_owned</span> ((address)cur)) &#123;</span><br><span class="line">    	<span class="comment">//判断持锁线程是不是地址值，就是当前拥有轻量级锁的重入</span></span><br><span class="line">     <span class="built_in">assert</span> (_recursions == <span class="number">0</span>, <span class="string">&quot;internal state error&quot;</span>);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//将重量级锁重入次数设置为1</span></span><br><span class="line">    _recursions = <span class="number">1</span> ;</span><br><span class="line">    <span class="comment">// Commute owner from a thread-specific on-stack BasicLockObject address to</span></span><br><span class="line">    <span class="comment">// a full-fledged &quot;Thread *&quot;.</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">//将监视器的信息更新，锁变成重量级锁</span></span><br><span class="line">    _owner = Self ;</span><br><span class="line">    OwnerIsThread = <span class="number">1</span> ;</span><br><span class="line">    <span class="keyword">return</span> ;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We&#x27;ve encountered genuine contention.</span></span><br><span class="line">  <span class="built_in">assert</span> (Self-&gt;_Stalled == <span class="number">0</span>, <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">  Self-&gt;_Stalled = <span class="built_in">intptr_t</span>(<span class="keyword">this</span>) ;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Try one round of spinning *before* enqueueing Self</span></span><br><span class="line">  <span class="comment">// and before going through the awkward and expensive state</span></span><br><span class="line">  <span class="comment">// transitions.  The following spin is strictly optional ...</span></span><br><span class="line">  <span class="comment">// Note that if we acquire the monitor from an initial spin</span></span><br><span class="line">  <span class="comment">// we forgo posting JVMTI events and firing DTRACE probes.</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//判断环境变量是否能自旋，然后自适应自旋</span></span><br><span class="line">  <span class="keyword">if</span> (Knob_SpinEarly &amp;&amp; <span class="built_in">TrySpin</span> (Self) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">     <span class="built_in">assert</span> (_owner == Self      , <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">     <span class="built_in">assert</span> (_recursions == <span class="number">0</span>    , <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">     <span class="built_in">assert</span> (((oop)(<span class="built_in">object</span>()))-&gt;<span class="built_in">mark</span>() == markOopDesc::<span class="built_in">encode</span>(<span class="keyword">this</span>), <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">     Self-&gt;_Stalled = <span class="number">0</span> ;</span><br><span class="line">     <span class="keyword">return</span> ;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">assert</span> (_owner != Self          , <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">  <span class="built_in">assert</span> (_succ  != Self          , <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">  <span class="built_in">assert</span> (Self-&gt;<span class="built_in">is_Java_thread</span>()  , <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">  JavaThread * jt = (JavaThread *) Self ;</span><br><span class="line">  <span class="built_in">assert</span> (!SafepointSynchronize::<span class="built_in">is_at_safepoint</span>(), <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">  <span class="built_in">assert</span> (jt-&gt;<span class="built_in">thread_state</span>() != _thread_blocked   , <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">  <span class="built_in">assert</span> (<span class="keyword">this</span>-&gt;<span class="built_in">object</span>() != <span class="literal">NULL</span>  , <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">  <span class="built_in">assert</span> (_count &gt;= <span class="number">0</span>, <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Prevent deflation at STW-time.  See deflate_idle_monitors() and is_busy().</span></span><br><span class="line">  <span class="comment">// Ensure the object-monitor relationship remains stable while there&#x27;s contention.</span></span><br><span class="line">  Atomic::<span class="built_in">inc_ptr</span>(&amp;_count);</span><br><span class="line"></span><br><span class="line">  EventJavaMonitorEnter event;</span><br><span class="line"></span><br><span class="line">  &#123; <span class="comment">// Change java thread status to indicate blocked on monitor enter.</span></span><br><span class="line">    <span class="function">JavaThreadBlockedOnMonitorEnterState <span class="title">jtbmes</span><span class="params">(jt, <span class="keyword">this</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">DTRACE_MONITOR_PROBE</span>(contended__enter, <span class="keyword">this</span>, <span class="built_in">object</span>(), jt);</span><br><span class="line">    <span class="keyword">if</span> (JvmtiExport::<span class="built_in">should_post_monitor_contended_enter</span>()) &#123;</span><br><span class="line">      JvmtiExport::<span class="built_in">post_monitor_contended_enter</span>(jt, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// The current thread does not yet own the monitor and does not</span></span><br><span class="line">      <span class="comment">// yet appear on any queues that would get it made the successor.</span></span><br><span class="line">      <span class="comment">// This means that the JVMTI_EVENT_MONITOR_CONTENDED_ENTER event</span></span><br><span class="line">      <span class="comment">// handler cannot accidentally consume an unpark() meant for the</span></span><br><span class="line">      <span class="comment">// ParkEvent associated with this ObjectMonitor.</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">OSThreadContendState <span class="title">osts</span><span class="params">(Self-&gt;osthread())</span></span>;</span><br><span class="line">    <span class="function">ThreadBlockInVM <span class="title">tbivm</span><span class="params">(jt)</span></span>;</span><br><span class="line"></span><br><span class="line">    Self-&gt;<span class="built_in">set_current_pending_monitor</span>(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TODO-<span class="doctag">FIXME:</span> change the following for(;;) loop to straight-line code.</span></span><br><span class="line">      </span><br><span class="line">      </span><br><span class="line">      </span><br><span class="line">      <span class="comment">//死循环(自旋) 进入EnterI,如果出现意外导致拿锁失败则退出 </span></span><br><span class="line">      </span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">      jt-&gt;<span class="built_in">set_suspend_equivalent</span>();</span><br><span class="line">      <span class="comment">// cleared by handle_special_suspend_equivalent_condition()</span></span><br><span class="line">      <span class="comment">// or java_suspend_self()</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//进入EnterI方法</span></span><br><span class="line">      <span class="built_in">EnterI</span> (THREAD) ;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">ExitSuspendEquivalent</span>(jt)) <span class="keyword">break</span> ;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">      <span class="comment">// We have acquired the contended monitor, but while we were</span></span><br><span class="line">      <span class="comment">// waiting another thread suspended us. We don&#x27;t want to enter</span></span><br><span class="line">      <span class="comment">// the monitor while suspended because that would surprise the</span></span><br><span class="line">      <span class="comment">// thread that suspended us.</span></span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">          _recursions = <span class="number">0</span> ;</span><br><span class="line">      _succ = <span class="literal">NULL</span> ;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//出现意外导致拿锁失败了则结束</span></span><br><span class="line">      <span class="built_in">exit</span> (<span class="literal">false</span>, Self) ;</span><br><span class="line"></span><br><span class="line">      jt-&gt;<span class="built_in">java_suspend_self</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    Self-&gt;<span class="built_in">set_current_pending_monitor</span>(<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We cleared the pending monitor info since we&#x27;ve just gotten past</span></span><br><span class="line">    <span class="comment">// the enter-check-for-suspend dance and we now own the monitor free</span></span><br><span class="line">    <span class="comment">// and clear, i.e., it is no longer pending. The ThreadBlockInVM</span></span><br><span class="line">    <span class="comment">// destructor can go to a safepoint at the end of this block. If we</span></span><br><span class="line">    <span class="comment">// do a thread dump during that safepoint, then this thread will show</span></span><br><span class="line">    <span class="comment">// as having &quot;-locked&quot; the monitor, but the OS and java.lang.Thread</span></span><br><span class="line">    <span class="comment">// states will still report that the thread is blocked trying to</span></span><br><span class="line">    <span class="comment">// acquire it.</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Atomic::<span class="built_in">dec_ptr</span>(&amp;_count);</span><br><span class="line">  <span class="built_in">assert</span> (_count &gt;= <span class="number">0</span>, <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">  Self-&gt;_Stalled = <span class="number">0</span> ;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Must either set _recursions = 0 or ASSERT _recursions == 0.</span></span><br><span class="line">  <span class="built_in">assert</span> (_recursions == <span class="number">0</span>     , <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">  <span class="built_in">assert</span> (_owner == Self       , <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">  <span class="built_in">assert</span> (_succ  != Self       , <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">  <span class="built_in">assert</span> (((oop)(<span class="built_in">object</span>()))-&gt;<span class="built_in">mark</span>() == markOopDesc::<span class="built_in">encode</span>(<span class="keyword">this</span>), <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The thread -- now the owner -- is back in vm mode.</span></span><br><span class="line">  <span class="comment">// Report the glorious news via TI,DTrace and jvmstat.</span></span><br><span class="line">  <span class="comment">// The probe effect is non-trivial.  All the reportage occurs</span></span><br><span class="line">  <span class="comment">// while we hold the monitor, increasing the length of the critical</span></span><br><span class="line">  <span class="comment">// section.  Amdahl&#x27;s parallel speedup law comes vividly into play.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// Another option might be to aggregate the events (thread local or</span></span><br><span class="line">  <span class="comment">// per-monitor aggregation) and defer reporting until a more opportune</span></span><br><span class="line">  <span class="comment">// time -- such as next time some thread encounters contention but has</span></span><br><span class="line">  <span class="comment">// yet to acquire the lock.  While spinning that thread could</span></span><br><span class="line">  <span class="comment">// spinning we could increment JVMStat counters, etc.</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">DTRACE_MONITOR_PROBE</span>(contended__entered, <span class="keyword">this</span>, <span class="built_in">object</span>(), jt);</span><br><span class="line">  <span class="keyword">if</span> (JvmtiExport::<span class="built_in">should_post_monitor_contended_entered</span>()) &#123;</span><br><span class="line">    JvmtiExport::<span class="built_in">post_monitor_contended_entered</span>(jt, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The current thread already owns the monitor and is not going to</span></span><br><span class="line">    <span class="comment">// call park() for the remainder of the monitor enter protocol. So</span></span><br><span class="line">    <span class="comment">// it doesn&#x27;t matter if the JVMTI_EVENT_MONITOR_CONTENDED_ENTERED</span></span><br><span class="line">    <span class="comment">// event handler consumed an unpark() issued by the thread that</span></span><br><span class="line">    <span class="comment">// just exited the monitor.</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (event.<span class="built_in">should_commit</span>()) &#123;</span><br><span class="line">    event.<span class="built_in">set_klass</span>(((oop)<span class="keyword">this</span>-&gt;<span class="built_in">object</span>())-&gt;<span class="built_in">klass</span>());</span><br><span class="line">    event.<span class="built_in">set_previousOwner</span>((TYPE_JAVALANGTHREAD)_previous_owner_tid);</span><br><span class="line">    event.<span class="built_in">set_address</span>((TYPE_ADDRESS)(<span class="type">uintptr_t</span>)(<span class="keyword">this</span>-&gt;<span class="built_in">object_addr</span>()));</span><br><span class="line">    event.<span class="built_in">commit</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (ObjectMonitor::_sync_ContendedLockAttempts != <span class="literal">NULL</span>) &#123;</span><br><span class="line">     ObjectMonitor::_sync_ContendedLockAttempts-&gt;<span class="built_in">inc</span>() ;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h4 id="ObjectMonitor-entryI"   >
          <a href="#ObjectMonitor-entryI" class="heading-link"><i class="fas fa-link"></i></a><a href="#ObjectMonitor-entryI" class="headerlink" title="ObjectMonitor::entryI"></a>ObjectMonitor::entryI</h4>
      <figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> ATTR <span class="title">ObjectMonitor::EnterI</span> <span class="params">(TRAPS)</span> </span>&#123;</span><br><span class="line">    Thread * Self = THREAD ;</span><br><span class="line">    <span class="built_in">assert</span> (Self-&gt;<span class="built_in">is_Java_thread</span>(), <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">    <span class="built_in">assert</span> (((JavaThread *) Self)-&gt;<span class="built_in">thread_state</span>() == _thread_blocked   , <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Try the lock - TATAS</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//TryLock方法</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">TryLock</span> (Self) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">assert</span> (_succ != Self              , <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">        <span class="built_in">assert</span> (_owner == Self             , <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">        <span class="built_in">assert</span> (_Responsible != Self       , <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">DeferredInitialize</span> () ;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We try one round of spinning *before* enqueueing Self.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// If the _owner is ready but OFFPROC we could use a YieldTo()</span></span><br><span class="line">    <span class="comment">// operation to donate the remainder of this thread&#x27;s quantum</span></span><br><span class="line">    <span class="comment">// to the owner.  This has subtle but beneficial affinity</span></span><br><span class="line">    <span class="comment">// effects.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//尝试自旋拿锁</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">TrySpin</span> (Self) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">assert</span> (_owner == Self        , <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">        <span class="built_in">assert</span> (_succ != Self         , <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">        <span class="built_in">assert</span> (_Responsible != Self  , <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The Spin failed -- Enqueue and park the thread ...</span></span><br><span class="line">    <span class="built_in">assert</span> (_succ  != Self            , <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">    <span class="built_in">assert</span> (_owner != Self            , <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">    <span class="built_in">assert</span> (_Responsible != Self      , <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Enqueue &quot;Self&quot; on ObjectMonitor&#x27;s _cxq.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Node acts as a proxy for Self.</span></span><br><span class="line">    <span class="comment">// As an aside, if were to ever rewrite the synchronization code mostly</span></span><br><span class="line">    <span class="comment">// in Java, WaitNodes, ObjectMonitors, and Events would become 1st-class</span></span><br><span class="line">    <span class="comment">// Java objects.  This would avoid awkward lifecycle and liveness issues,</span></span><br><span class="line">    <span class="comment">// as well as eliminate a subset of ABA issues.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> eliminate ObjectWaiter and enqueue either Threads or Events.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//自适应自旋拿不到锁 所以要入阻塞队列中</span></span><br><span class="line">    </span><br><span class="line">    <span class="function">ObjectWaiter <span class="title">node</span><span class="params">(Self)</span> </span>;</span><br><span class="line">    Self-&gt;_ParkEvent-&gt;<span class="built_in">reset</span>() ;</span><br><span class="line">    node._prev   = (ObjectWaiter *) <span class="number">0xBAD</span> ;</span><br><span class="line">    node.TState  = ObjectWaiter::TS_CXQ ;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Push &quot;Self&quot; onto the front of the _cxq.</span></span><br><span class="line">    <span class="comment">// Once on cxq/EntryList, Self stays on-queue until it acquires the lock.</span></span><br><span class="line">    <span class="comment">// Note that spinning tends to reduce the rate at which threads</span></span><br><span class="line">    <span class="comment">// enqueue and dequeue on EntryList|cxq.</span></span><br><span class="line">    ObjectWaiter * nxt ;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//死循环</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">//获取cxq阻塞队列  node.next和nxt都指向这个阻塞队列</span></span><br><span class="line">        node._next = nxt = _cxq ;</span><br><span class="line">        <span class="comment">//CAS操作，如果成功说明这个ObjectWaiter进入了Monitor的阻塞队列中队列中</span></span><br><span class="line">        <span class="keyword">if</span> (Atomic::<span class="built_in">cmpxchg_ptr</span> (&amp;node, &amp;_cxq, nxt) == nxt) <span class="keyword">break</span> ;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Interference - the CAS failed because _cxq changed.  Just retry.</span></span><br><span class="line">        <span class="comment">// As an optional optimization we retry the lock.</span></span><br><span class="line">        <span class="comment">//尝试去获取锁，如果成功则返回1</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">TryLock</span> (Self) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">assert</span> (_succ != Self         , <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">            <span class="built_in">assert</span> (_owner == Self        , <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">            <span class="built_in">assert</span> (_Responsible != Self  , <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check for cxq|EntryList edge transition to non-null.  This indicates</span></span><br><span class="line">    <span class="comment">// the onset of contention.  While contention persists exiting threads</span></span><br><span class="line">    <span class="comment">// will use a ST:MEMBAR:LD 1-1 exit protocol.  When contention abates exit</span></span><br><span class="line">    <span class="comment">// operations revert to the faster 1-0 mode.  This enter operation may interleave</span></span><br><span class="line">    <span class="comment">// (race) a concurrent 1-0 exit operation, resulting in stranding, so we</span></span><br><span class="line">    <span class="comment">// arrange for one of the contending thread to use a timed park() operations</span></span><br><span class="line">    <span class="comment">// to detect and recover from the race.  (Stranding is form of progress failure</span></span><br><span class="line">    <span class="comment">// where the monitor is unlocked but all the contending threads remain parked).</span></span><br><span class="line">    <span class="comment">// That is, at least one of the contended threads will periodically poll _owner.</span></span><br><span class="line">    <span class="comment">// One of the contending threads will become the designated &quot;Responsible&quot; thread.</span></span><br><span class="line">    <span class="comment">// The Responsible thread uses a timed park instead of a normal indefinite park</span></span><br><span class="line">    <span class="comment">// operation -- it periodically wakes and checks for and recovers from potential</span></span><br><span class="line">    <span class="comment">// strandings admitted by 1-0 exit operations.   We need at most one Responsible</span></span><br><span class="line">    <span class="comment">// thread per-monitor at any given moment.  Only threads on cxq|EntryList may</span></span><br><span class="line">    <span class="comment">// be responsible for a monitor.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Currently, one of the contended threads takes on the added role of &quot;Responsible&quot;.</span></span><br><span class="line">    <span class="comment">// A viable alternative would be to use a dedicated &quot;stranding checker&quot; thread</span></span><br><span class="line">    <span class="comment">// that periodically iterated over all the threads (or active monitors) and unparked</span></span><br><span class="line">    <span class="comment">// successors where there was risk of stranding.  This would help eliminate the</span></span><br><span class="line">    <span class="comment">// timer scalability issues we see on some platforms as we&#x27;d only have one thread</span></span><br><span class="line">    <span class="comment">// -- the checker -- parked on a timer.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//进行边界检查</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((SyncFlags &amp; <span class="number">16</span>) == <span class="number">0</span> &amp;&amp; nxt == <span class="literal">NULL</span> &amp;&amp; _EntryList == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// Try to assume the role of responsible thread for the monitor.</span></span><br><span class="line">        <span class="comment">// CONSIDER:  ST vs CAS vs &#123; if (Responsible==null) Responsible=Self &#125;</span></span><br><span class="line">        Atomic::<span class="built_in">cmpxchg_ptr</span> (Self, &amp;_Responsible, <span class="literal">NULL</span>) ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The lock have been released while this thread was occupied queueing</span></span><br><span class="line">    <span class="comment">// itself onto _cxq.  To close the race and avoid &quot;stranding&quot; and</span></span><br><span class="line">    <span class="comment">// progress-liveness failure we must resample-retry _owner before parking.</span></span><br><span class="line">    <span class="comment">// Note the Dekker/Lamport duality: ST cxq; MEMBAR; LD Owner.</span></span><br><span class="line">    <span class="comment">// In this case the ST-MEMBAR is accomplished with CAS().</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Defer all thread state transitions until park-time.</span></span><br><span class="line">    <span class="comment">// Since state transitions are heavy and inefficient we&#x27;d like</span></span><br><span class="line">    <span class="comment">// to defer the state transitions until absolutely necessary,</span></span><br><span class="line">    <span class="comment">// and in doing so avoid some transitions ...</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">TEVENT</span> (Inflated enter - Contention) ;</span><br><span class="line">    <span class="type">int</span> nWakeups = <span class="number">0</span> ;</span><br><span class="line">    <span class="type">int</span> RecheckInterval = <span class="number">1</span> ;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//运行到这里说明已经进了阻塞队列中</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//尝试去获取锁，获取锁成功就跳出</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">TryLock</span> (Self) &gt; <span class="number">0</span>) <span class="keyword">break</span> ;</span><br><span class="line">        <span class="built_in">assert</span> (_owner != Self, <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((SyncFlags &amp; <span class="number">2</span>) &amp;&amp; _Responsible == <span class="literal">NULL</span>) &#123;</span><br><span class="line">           Atomic::<span class="built_in">cmpxchg_ptr</span> (Self, &amp;_Responsible, <span class="literal">NULL</span>) ;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//阻塞线程</span></span><br><span class="line">        <span class="comment">// park self</span></span><br><span class="line">        <span class="keyword">if</span> (_Responsible == Self || (SyncFlags &amp; <span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="built_in">TEVENT</span> (Inflated enter - park TIMED) ;</span><br><span class="line">            Self-&gt;_ParkEvent-&gt;<span class="built_in">park</span> ((jlong) RecheckInterval) ;</span><br><span class="line">            <span class="comment">// Increase the RecheckInterval, but clamp the value.</span></span><br><span class="line">            RecheckInterval *= <span class="number">8</span> ;</span><br><span class="line">            <span class="keyword">if</span> (RecheckInterval &gt; <span class="number">1000</span>) RecheckInterval = <span class="number">1000</span> ;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">TEVENT</span> (Inflated enter - park UNTIMED) ;</span><br><span class="line">            Self-&gt;_ParkEvent-&gt;<span class="built_in">park</span>() ;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取成功就跳出</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">TryLock</span>(Self) &gt; <span class="number">0</span>) <span class="keyword">break</span> ;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The lock is still contested.</span></span><br><span class="line">        <span class="comment">// Keep a tally of the # of futile wakeups.</span></span><br><span class="line">        <span class="comment">// Note that the counter is not protected by a lock or updated by atomics.</span></span><br><span class="line">        <span class="comment">// That is by design - we trade &quot;lossy&quot; counters which are exposed to</span></span><br><span class="line">        <span class="comment">// races during updates for a lower probe effect.</span></span><br><span class="line">        <span class="built_in">TEVENT</span> (Inflated enter - Futile wakeup) ;</span><br><span class="line">        <span class="keyword">if</span> (ObjectMonitor::_sync_FutileWakeups != <span class="literal">NULL</span>) &#123;</span><br><span class="line">           ObjectMonitor::_sync_FutileWakeups-&gt;<span class="built_in">inc</span>() ;</span><br><span class="line">        &#125;</span><br><span class="line">        ++ nWakeups ;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Assuming this is not a spurious wakeup we&#x27;ll normally find _succ == Self.</span></span><br><span class="line">        <span class="comment">// We can defer clearing _succ until after the spin completes</span></span><br><span class="line">        <span class="comment">// TrySpin() must tolerate being called with _succ == Self.</span></span><br><span class="line">        <span class="comment">// Try yet another round of adaptive spinning.</span></span><br><span class="line">        <span class="keyword">if</span> ((Knob_SpinAfterFutile &amp; <span class="number">1</span>) &amp;&amp; <span class="built_in">TrySpin</span> (Self) &gt; <span class="number">0</span>) <span class="keyword">break</span> ;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We can find that we were unpark()ed and redesignated _succ while</span></span><br><span class="line">        <span class="comment">// we were spinning.  That&#x27;s harmless.  If we iterate and call park(),</span></span><br><span class="line">        <span class="comment">// park() will consume the event and return immediately and we&#x27;ll</span></span><br><span class="line">        <span class="comment">// just spin again.  This pattern can repeat, leaving _succ to simply</span></span><br><span class="line">        <span class="comment">// spin on a CPU.  Enable Knob_ResetEvent to clear pending unparks().</span></span><br><span class="line">        <span class="comment">// Alternately, we can sample fired() here, and if set, forgo spinning</span></span><br><span class="line">        <span class="comment">// in the next iteration.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((Knob_ResetEvent &amp; <span class="number">1</span>) &amp;&amp; Self-&gt;_ParkEvent-&gt;<span class="built_in">fired</span>()) &#123;</span><br><span class="line">           Self-&gt;_ParkEvent-&gt;<span class="built_in">reset</span>() ;</span><br><span class="line">           OrderAccess::<span class="built_in">fence</span>() ;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (_succ == Self) _succ = <span class="literal">NULL</span> ;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Invariant: after clearing _succ a thread *must* retry _owner before parking.</span></span><br><span class="line">        OrderAccess::<span class="built_in">fence</span>() ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Egress :</span></span><br><span class="line">    <span class="comment">// Self has acquired the lock -- Unlink Self from the cxq or EntryList.</span></span><br><span class="line">    <span class="comment">// Normally we&#x27;ll find Self on the EntryList .</span></span><br><span class="line">    <span class="comment">// From the perspective of the lock owner (this thread), the</span></span><br><span class="line">    <span class="comment">// EntryList is stable and cxq is prepend-only.</span></span><br><span class="line">    <span class="comment">// The head of cxq is volatile but the interior is stable.</span></span><br><span class="line">    <span class="comment">// In addition, Self.TState is stable.</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">assert</span> (_owner == Self      , <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">    <span class="built_in">assert</span> (<span class="built_in">object</span>() != <span class="literal">NULL</span>    , <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">    <span class="comment">// I&#x27;d like to write:</span></span><br><span class="line">    <span class="comment">//   guarantee (((oop)(object()))-&gt;mark() == markOopDesc::encode(this), &quot;invariant&quot;) ;</span></span><br><span class="line">    <span class="comment">// but as we&#x27;re at a safepoint that&#x27;s not safe.</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">UnlinkAfterAcquire</span> (Self, &amp;node) ;</span><br><span class="line">    <span class="keyword">if</span> (_succ == Self) _succ = <span class="literal">NULL</span> ;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">assert</span> (_succ != Self, <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">    <span class="keyword">if</span> (_Responsible == Self) &#123;</span><br><span class="line">        _Responsible = <span class="literal">NULL</span> ;</span><br><span class="line">        OrderAccess::<span class="built_in">fence</span>(); <span class="comment">// Dekker pivot-point</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// We may leave threads on cxq|EntryList without a designated</span></span><br><span class="line">        <span class="comment">// &quot;Responsible&quot; thread.  This is benign.  When this thread subsequently</span></span><br><span class="line">        <span class="comment">// exits the monitor it can &quot;see&quot; such preexisting &quot;old&quot; threads --</span></span><br><span class="line">        <span class="comment">// threads that arrived on the cxq|EntryList before the fence, above --</span></span><br><span class="line">        <span class="comment">// by LDing cxq|EntryList.  Newly arrived threads -- that is, threads</span></span><br><span class="line">        <span class="comment">// that arrive on cxq after the ST:MEMBAR, above -- will set Responsible</span></span><br><span class="line">        <span class="comment">// non-null and elect a new &quot;Responsible&quot; timer thread.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// This thread executes:</span></span><br><span class="line">        <span class="comment">//    ST Responsible=null; MEMBAR    (in enter epilog - here)</span></span><br><span class="line">        <span class="comment">//    LD cxq|EntryList               (in subsequent exit)</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// Entering threads in the slow/contended path execute:</span></span><br><span class="line">        <span class="comment">//    ST cxq=nonnull; MEMBAR; LD Responsible (in enter prolog)</span></span><br><span class="line">        <span class="comment">//    The (ST cxq; MEMBAR) is accomplished with CAS().</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// The MEMBAR, above, prevents the LD of cxq|EntryList in the subsequent</span></span><br><span class="line">        <span class="comment">// exit operation from floating above the ST Responsible=null.</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We&#x27;ve acquired ownership with CAS().</span></span><br><span class="line">    <span class="comment">// CAS is serializing -- it has MEMBAR/FENCE-equivalent semantics.</span></span><br><span class="line">    <span class="comment">// But since the CAS() this thread may have also stored into _succ,</span></span><br><span class="line">    <span class="comment">// EntryList, cxq or Responsible.  These meta-data updates must be</span></span><br><span class="line">    <span class="comment">// visible __before this thread subsequently drops the lock.</span></span><br><span class="line">    <span class="comment">// Consider what could occur if we didn&#x27;t enforce this constraint --</span></span><br><span class="line">    <span class="comment">// STs to monitor meta-data and user-data could reorder with (become</span></span><br><span class="line">    <span class="comment">// visible after) the ST in exit that drops ownership of the lock.</span></span><br><span class="line">    <span class="comment">// Some other thread could then acquire the lock, but observe inconsistent</span></span><br><span class="line">    <span class="comment">// or old monitor meta-data and heap data.  That violates the JMM.</span></span><br><span class="line">    <span class="comment">// To that end, the 1-0 exit() operation must have at least STST|LDST</span></span><br><span class="line">    <span class="comment">// &quot;release&quot; barrier semantics.  Specifically, there must be at least a</span></span><br><span class="line">    <span class="comment">// STST|LDST barrier in exit() before the ST of null into _owner that drops</span></span><br><span class="line">    <span class="comment">// the lock.   The barrier ensures that changes to monitor meta-data and data</span></span><br><span class="line">    <span class="comment">// protected by the lock will be visible before we release the lock, and</span></span><br><span class="line">    <span class="comment">// therefore before some other thread (CPU) has a chance to acquire the lock.</span></span><br><span class="line">    <span class="comment">// See also: http://gee.cs.oswego.edu/dl/jmm/cookbook.html.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Critically, any prior STs to _succ or EntryList must be visible before</span></span><br><span class="line">    <span class="comment">// the ST of null into _owner in the *subsequent* (following) corresponding</span></span><br><span class="line">    <span class="comment">// monitorexit.  Recall too, that in 1-0 mode monitorexit does not necessarily</span></span><br><span class="line">    <span class="comment">// execute a serializing instruction.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (SyncFlags &amp; <span class="number">8</span>) &#123;</span><br><span class="line">       OrderAccess::<span class="built_in">fence</span>() ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="TryLock"   >
          <a href="#TryLock" class="heading-link"><i class="fas fa-link"></i></a><a href="#TryLock" class="headerlink" title="TryLock"></a>TryLock</h4>
      <figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">ObjectMonitor::TryLock</span> <span class="params">(Thread * Self)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//自旋</span></span><br><span class="line">   <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">   <span class="comment">//获取锁的持有者</span></span><br><span class="line">      <span class="type">void</span> * own = _owner ;</span><br><span class="line">       <span class="comment">//如果是有锁则返回0</span></span><br><span class="line">      <span class="keyword">if</span> (own != <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="number">0</span> ;</span><br><span class="line">      <span class="comment">//如果加锁成功了就返回1</span></span><br><span class="line">      <span class="keyword">if</span> (Atomic::<span class="built_in">cmpxchg_ptr</span> (Self, &amp;_owner, <span class="literal">NULL</span>) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">         </span><br><span class="line">         <span class="comment">// Either guarantee _recursions == 0 or set _recursions = 0.</span></span><br><span class="line">         <span class="built_in">assert</span> (_recursions == <span class="number">0</span>, <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">         <span class="built_in">assert</span> (_owner == Self, <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">         <span class="comment">// CONSIDER: set or assert that OwnerIsThread == 1</span></span><br><span class="line">         <span class="keyword">return</span> <span class="number">1</span> ;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// The lock had been free momentarily, but we lost the race to the lock.</span></span><br><span class="line">      <span class="comment">// Interference -- the CAS failed.</span></span><br><span class="line">      <span class="comment">// We can either return -1 or retry.</span></span><br><span class="line">      <span class="comment">// Retry doesn&#x27;t make as much sense because the lock was just acquired.</span></span><br><span class="line">       </span><br><span class="line">       <span class="comment">//锁没有主人但是竞争的时候失败了就返回-1</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="literal">true</span>) <span class="keyword">return</span> <span class="number">-1</span> ;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>






        <h4 id="自适应自旋"   >
          <a href="#自适应自旋" class="heading-link"><i class="fas fa-link"></i></a><a href="#自适应自旋" class="headerlink" title="自适应自旋"></a>自适应自旋</h4>
      <p>自适应自旋是指:如果上一次自旋获取到了那就会将自选次数添加，认为你能获取锁，如果上一次自旋之后还没有获取到，那就认为你获取不到锁，自旋次数就会减少，这个是一个很复杂的一个过程。具体代码如下</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">ObjectMonitor::TrySpin_VaryDuration</span> <span class="params">(Thread * Self)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Dumb, brutal spin.  Good for comparative measurements against adaptive spinning.</span></span><br><span class="line">    <span class="type">int</span> ctr = Knob_FixedSpin ;</span><br><span class="line">    <span class="keyword">if</span> (ctr != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (--ctr &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">TryLock</span> (Self) &gt; <span class="number">0</span>) <span class="keyword">return</span> <span class="number">1</span> ;</span><br><span class="line">            <span class="built_in">SpinPause</span> () ;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span> ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (ctr = Knob_PreSpin + <span class="number">1</span>; --ctr &gt;= <span class="number">0</span> ; ) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">TryLock</span>(Self) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Increase _SpinDuration ...</span></span><br><span class="line">        <span class="comment">// Note that we don&#x27;t clamp SpinDuration precisely at SpinLimit.</span></span><br><span class="line">        <span class="comment">// Raising _SpurDuration to the poverty line is key.</span></span><br><span class="line">        <span class="type">int</span> x = _SpinDuration ;</span><br><span class="line">        <span class="keyword">if</span> (x &lt; Knob_SpinLimit) &#123;</span><br><span class="line">           <span class="keyword">if</span> (x &lt; Knob_Poverty) x = Knob_Poverty ;</span><br><span class="line">           _SpinDuration = x + Knob_BonusB ;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span> ;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">SpinPause</span> () ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Admission control - verify preconditions for spinning</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// We always spin a little bit, just to prevent _SpinDuration == 0 from</span></span><br><span class="line">    <span class="comment">// becoming an absorbing state.  Put another way, we spin briefly to</span></span><br><span class="line">    <span class="comment">// sample, just in case the system load, parallelism, contention, or lock</span></span><br><span class="line">    <span class="comment">// modality changed.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Consider the following alternative:</span></span><br><span class="line">    <span class="comment">// Periodically set _SpinDuration = _SpinLimit and try a long/full</span></span><br><span class="line">    <span class="comment">// spin attempt.  &quot;Periodically&quot; might mean after a tally of</span></span><br><span class="line">    <span class="comment">// the # of failed spin attempts (or iterations) reaches some threshold.</span></span><br><span class="line">    <span class="comment">// This takes us into the realm of 1-out-of-N spinning, where we</span></span><br><span class="line">    <span class="comment">// hold the duration constant but vary the frequency.</span></span><br><span class="line"></span><br><span class="line">    ctr = _SpinDuration  ;</span><br><span class="line">    <span class="keyword">if</span> (ctr &lt; Knob_SpinBase) ctr = Knob_SpinBase ;</span><br><span class="line">    <span class="keyword">if</span> (ctr &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span> ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Knob_SuccRestrict &amp;&amp; _succ != <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="number">0</span> ;</span><br><span class="line">    <span class="keyword">if</span> (Knob_OState &amp;&amp; <span class="built_in">NotRunnable</span> (Self, (Thread *) _owner)) &#123;</span><br><span class="line">       <span class="built_in">TEVENT</span> (Spin abort - notrunnable [TOP]);</span><br><span class="line">       <span class="keyword">return</span> <span class="number">0</span> ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> MaxSpin = Knob_MaxSpinners ;</span><br><span class="line">    <span class="keyword">if</span> (MaxSpin &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">       <span class="keyword">if</span> (_Spinner &gt; MaxSpin) &#123;</span><br><span class="line">          <span class="built_in">TEVENT</span> (Spin abort -- too many spinners) ;</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0</span> ;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// Slighty racy, but benign ...</span></span><br><span class="line">       <span class="built_in">Adjust</span> (&amp;_Spinner, <span class="number">1</span>) ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We&#x27;re good to spin ... spin ingress.</span></span><br><span class="line">    <span class="comment">// CONSIDER: use Prefetch::write() to avoid RTS-&gt;RTO upgrades</span></span><br><span class="line">    <span class="comment">// when preparing to LD...CAS _owner, etc and the CAS is likely</span></span><br><span class="line">    <span class="comment">// to succeed.</span></span><br><span class="line">    <span class="type">int</span> hits    = <span class="number">0</span> ;</span><br><span class="line">    <span class="type">int</span> msk     = <span class="number">0</span> ;</span><br><span class="line">    <span class="type">int</span> caspty  = Knob_CASPenalty ;</span><br><span class="line">    <span class="type">int</span> oxpty   = Knob_OXPenalty ;</span><br><span class="line">    <span class="type">int</span> sss     = Knob_SpinSetSucc ;</span><br><span class="line">    <span class="keyword">if</span> (sss &amp;&amp; _succ == <span class="literal">NULL</span> ) _succ = Self ;</span><br><span class="line">    Thread * prv = <span class="literal">NULL</span> ;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// There are three ways to exit the following loop:</span></span><br><span class="line">    <span class="comment">// 1.  A successful spin where this thread has acquired the lock.</span></span><br><span class="line">    <span class="comment">// 2.  Spin failure with prejudice</span></span><br><span class="line">    <span class="comment">// 3.  Spin failure without prejudice</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (--ctr &gt;= <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Periodic polling -- Check for pending GC</span></span><br><span class="line">      <span class="comment">// Threads may spin while they&#x27;re unsafe.</span></span><br><span class="line">      <span class="comment">// We don&#x27;t want spinning threads to delay the JVM from reaching</span></span><br><span class="line">      <span class="comment">// a stop-the-world safepoint or to steal cycles from GC.</span></span><br><span class="line">      <span class="comment">// If we detect a pending safepoint we abort in order that</span></span><br><span class="line">      <span class="comment">// (a) this thread, if unsafe, doesn&#x27;t delay the safepoint, and (b)</span></span><br><span class="line">      <span class="comment">// this thread, if safe, doesn&#x27;t steal cycles from GC.</span></span><br><span class="line">      <span class="comment">// This is in keeping with the &quot;no loitering in runtime&quot; rule.</span></span><br><span class="line">      <span class="comment">// We periodically check to see if there&#x27;s a safepoint pending.</span></span><br><span class="line">      <span class="keyword">if</span> ((ctr &amp; <span class="number">0xFF</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">         <span class="keyword">if</span> (SafepointSynchronize::<span class="built_in">do_call_back</span>()) &#123;</span><br><span class="line">            <span class="built_in">TEVENT</span> (Spin: safepoint) ;</span><br><span class="line">            <span class="keyword">goto</span> Abort ;           <span class="comment">// abrupt spin egress</span></span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span> (Knob_UsePause &amp; <span class="number">1</span>) <span class="built_in">SpinPause</span> () ;</span><br><span class="line"></span><br><span class="line">         <span class="built_in">int</span> (*scb)(<span class="type">intptr_t</span>,<span class="type">int</span>) = SpinCallbackFunction ;</span><br><span class="line">         <span class="keyword">if</span> (hits &gt; <span class="number">50</span> &amp;&amp; scb != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="type">int</span> abend = (*scb)(SpinCallbackArgument, <span class="number">0</span>) ;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (Knob_UsePause &amp; <span class="number">2</span>) <span class="built_in">SpinPause</span>() ;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Exponential back-off ...  Stay off the bus to reduce coherency traffic.</span></span><br><span class="line">      <span class="comment">// This is useful on classic SMP systems, but is of less utility on</span></span><br><span class="line">      <span class="comment">// N1-style CMT platforms.</span></span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">      <span class="comment">// Trade-off: lock acquisition latency vs coherency bandwidth.</span></span><br><span class="line">      <span class="comment">// Lock hold times are typically short.  A histogram</span></span><br><span class="line">      <span class="comment">// of successful spin attempts shows that we usually acquire</span></span><br><span class="line">      <span class="comment">// the lock early in the spin.  That suggests we want to</span></span><br><span class="line">      <span class="comment">// sample _owner frequently in the early phase of the spin,</span></span><br><span class="line">      <span class="comment">// but then back-off and sample less frequently as the spin</span></span><br><span class="line">      <span class="comment">// progresses.  The back-off makes a good citizen on SMP big</span></span><br><span class="line">      <span class="comment">// SMP systems.  Oversampling _owner can consume excessive</span></span><br><span class="line">      <span class="comment">// coherency bandwidth.  Relatedly, if we _oversample _owner we</span></span><br><span class="line">      <span class="comment">// can inadvertently interfere with the the ST m-&gt;owner=null.</span></span><br><span class="line">      <span class="comment">// executed by the lock owner.</span></span><br><span class="line">      <span class="keyword">if</span> (ctr &amp; msk) <span class="keyword">continue</span> ;</span><br><span class="line">      ++hits ;</span><br><span class="line">      <span class="keyword">if</span> ((hits &amp; <span class="number">0xF</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// The 0xF, above, corresponds to the exponent.</span></span><br><span class="line">        <span class="comment">// Consider: (msk+1)|msk</span></span><br><span class="line">        msk = ((msk &lt;&lt; <span class="number">2</span>)|<span class="number">3</span>) &amp; BackOffMask ;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Probe _owner with TATAS</span></span><br><span class="line">      <span class="comment">// If this thread observes the monitor transition or flicker</span></span><br><span class="line">      <span class="comment">// from locked to unlocked to locked, then the odds that this</span></span><br><span class="line">      <span class="comment">// thread will acquire the lock in this spin attempt go down</span></span><br><span class="line">      <span class="comment">// considerably.  The same argument applies if the CAS fails</span></span><br><span class="line">      <span class="comment">// or if we observe _owner change from one non-null value to</span></span><br><span class="line">      <span class="comment">// another non-null value.   In such cases we might abort</span></span><br><span class="line">      <span class="comment">// the spin without prejudice or apply a &quot;penalty&quot; to the</span></span><br><span class="line">      <span class="comment">// spin count-down variable &quot;ctr&quot;, reducing it by 100, say.</span></span><br><span class="line"></span><br><span class="line">      Thread * ox = (Thread *) _owner ;</span><br><span class="line">      <span class="keyword">if</span> (ox == <span class="literal">NULL</span>) &#123;</span><br><span class="line">         ox = (Thread *) Atomic::<span class="built_in">cmpxchg_ptr</span> (Self, &amp;_owner, <span class="literal">NULL</span>) ;</span><br><span class="line">         <span class="keyword">if</span> (ox == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">// The CAS succeeded -- this thread acquired ownership</span></span><br><span class="line">            <span class="comment">// Take care of some bookkeeping to exit spin state.</span></span><br><span class="line">            <span class="keyword">if</span> (sss &amp;&amp; _succ == Self) &#123;</span><br><span class="line">               _succ = <span class="literal">NULL</span> ;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (MaxSpin &gt; <span class="number">0</span>) <span class="built_in">Adjust</span> (&amp;_Spinner, <span class="number">-1</span>) ;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Increase _SpinDuration :</span></span><br><span class="line">            <span class="comment">// The spin was successful (profitable) so we tend toward</span></span><br><span class="line">            <span class="comment">// longer spin attempts in the future.</span></span><br><span class="line">            <span class="comment">// CONSIDER: factor &quot;ctr&quot; into the _SpinDuration adjustment.</span></span><br><span class="line">            <span class="comment">// If we acquired the lock early in the spin cycle it</span></span><br><span class="line">            <span class="comment">// makes sense to increase _SpinDuration proportionally.</span></span><br><span class="line">            <span class="comment">// Note that we don&#x27;t clamp SpinDuration precisely at SpinLimit.</span></span><br><span class="line">            <span class="type">int</span> x = _SpinDuration ;</span><br><span class="line">            <span class="keyword">if</span> (x &lt; Knob_SpinLimit) &#123;</span><br><span class="line">                <span class="keyword">if</span> (x &lt; Knob_Poverty) x = Knob_Poverty ;</span><br><span class="line">                _SpinDuration = x + Knob_Bonus ;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span> ;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="comment">// The CAS failed ... we can take any of the following actions:</span></span><br><span class="line">         <span class="comment">// * penalize: ctr -= Knob_CASPenalty</span></span><br><span class="line">         <span class="comment">// * exit spin with prejudice -- goto Abort;</span></span><br><span class="line">         <span class="comment">// * exit spin without prejudice.</span></span><br><span class="line">         <span class="comment">// * Since CAS is high-latency, retry again immediately.</span></span><br><span class="line">         prv = ox ;</span><br><span class="line">         <span class="built_in">TEVENT</span> (Spin: cas failed) ;</span><br><span class="line">         <span class="keyword">if</span> (caspty == <span class="number">-2</span>) <span class="keyword">break</span> ;</span><br><span class="line">         <span class="keyword">if</span> (caspty == <span class="number">-1</span>) <span class="keyword">goto</span> Abort ;</span><br><span class="line">         ctr -= caspty ;</span><br><span class="line">         <span class="keyword">continue</span> ;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Did lock ownership change hands ?</span></span><br><span class="line">      <span class="keyword">if</span> (ox != prv &amp;&amp; prv != <span class="literal">NULL</span> ) &#123;</span><br><span class="line">          <span class="built_in">TEVENT</span> (spin: Owner changed)</span><br><span class="line">          <span class="keyword">if</span> (oxpty == <span class="number">-2</span>) <span class="keyword">break</span> ;</span><br><span class="line">          <span class="keyword">if</span> (oxpty == <span class="number">-1</span>) <span class="keyword">goto</span> Abort ;</span><br><span class="line">          ctr -= oxpty ;</span><br><span class="line">      &#125;</span><br><span class="line">      prv = ox ;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Abort the spin if the owner is not executing.</span></span><br><span class="line">      <span class="comment">// The owner must be executing in order to drop the lock.</span></span><br><span class="line">      <span class="comment">// Spinning while the owner is OFFPROC is idiocy.</span></span><br><span class="line">      <span class="comment">// Consider: ctr -= RunnablePenalty ;</span></span><br><span class="line">      <span class="keyword">if</span> (Knob_OState &amp;&amp; <span class="built_in">NotRunnable</span> (Self, ox)) &#123;</span><br><span class="line">         <span class="built_in">TEVENT</span> (Spin abort - notrunnable);</span><br><span class="line">         <span class="keyword">goto</span> Abort ;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (sss &amp;&amp; _succ == <span class="literal">NULL</span> ) _succ = Self ;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Spin failed with prejudice -- reduce _SpinDuration.</span></span><br><span class="line">   <span class="comment">// <span class="doctag">TODO:</span> Use an AIMD-like policy to adjust _SpinDuration.</span></span><br><span class="line">   <span class="comment">// AIMD is globally stable.</span></span><br><span class="line">   <span class="built_in">TEVENT</span> (Spin failure) ;</span><br><span class="line">   &#123;</span><br><span class="line">     <span class="type">int</span> x = _SpinDuration ;</span><br><span class="line">     <span class="keyword">if</span> (x &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Consider an AIMD scheme like: x -= (x &gt;&gt; 3) + 100</span></span><br><span class="line">        <span class="comment">// This is globally sample and tends to damp the response.</span></span><br><span class="line">        x -= Knob_Penalty ;</span><br><span class="line">        <span class="keyword">if</span> (x &lt; <span class="number">0</span>) x = <span class="number">0</span> ;</span><br><span class="line">        _SpinDuration = x ;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"> Abort:</span><br><span class="line">   <span class="keyword">if</span> (MaxSpin &gt;= <span class="number">0</span>) <span class="built_in">Adjust</span> (&amp;_Spinner, <span class="number">-1</span>) ;</span><br><span class="line">   <span class="keyword">if</span> (sss &amp;&amp; _succ == Self) &#123;</span><br><span class="line">      _succ = <span class="literal">NULL</span> ;</span><br><span class="line">      <span class="comment">// Invariant: after setting succ=null a contending thread</span></span><br><span class="line">      <span class="comment">// must recheck-retry _owner before parking.  This usually happens</span></span><br><span class="line">      <span class="comment">// in the normal usage of TrySpin(), but it&#x27;s safest</span></span><br><span class="line">      <span class="comment">// to make TrySpin() as foolproof as possible.</span></span><br><span class="line">      OrderAccess::<span class="built_in">fence</span>() ;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">TryLock</span>(Self) &gt; <span class="number">0</span>) <span class="keyword">return</span> <span class="number">1</span> ;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span> ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="阻塞队列图解"   >
          <a href="#阻塞队列图解" class="heading-link"><i class="fas fa-link"></i></a><a href="#阻塞队列图解" class="headerlink" title="阻塞队列图解"></a>阻塞队列图解</h4>
      <p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230803184039161.png"  alt="阻塞队列图解">
      </p>

        <h3 id="重量级锁竞争流程图"   >
          <a href="#重量级锁竞争流程图" class="heading-link"><i class="fas fa-link"></i></a><a href="#重量级锁竞争流程图" class="headerlink" title="重量级锁竞争流程图"></a>重量级锁竞争流程图</h3>
      <p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230803182841184.png"  alt="重量级锁竞争流程图">
      </p>

        <h2 id="锁释放"   >
          <a href="#锁释放" class="heading-link"><i class="fas fa-link"></i></a><a href="#锁释放" class="headerlink" title="锁释放"></a>锁释放</h2>
      
        <h3 id="轻量级锁释放-monitorexit"   >
          <a href="#轻量级锁释放-monitorexit" class="heading-link"><i class="fas fa-link"></i></a><a href="#轻量级锁释放-monitorexit" class="headerlink" title="轻量级锁释放(monitorexit)"></a>轻量级锁释放(monitorexit)</h3>
      <figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CASE</span>(_monitorexit): &#123;</span><br><span class="line">    	<span class="comment">//从栈中获取对象</span></span><br><span class="line">        oop lockee = <span class="built_in">STACK_OBJECT</span>(<span class="number">-1</span>);</span><br><span class="line">    	<span class="comment">//对lockee判空</span></span><br><span class="line">        <span class="built_in">CHECK_NULL</span>(lockee);</span><br><span class="line">        <span class="comment">// derefing&#x27;s lockee ought to provoke implicit null check</span></span><br><span class="line">        <span class="comment">// find our monitor slot</span></span><br><span class="line">    </span><br><span class="line">    	<span class="comment">//指向栈顶的监视器</span></span><br><span class="line">        BasicObjectLock* limit = istate-&gt;<span class="built_in">monitor_base</span>();</span><br><span class="line">    	<span class="comment">//指向栈底的监视器</span></span><br><span class="line">        BasicObjectLock* most_recent = (BasicObjectLock*) istate-&gt;<span class="built_in">stack_base</span>();</span><br><span class="line">    	<span class="comment">//循环，当栈底和栈顶不指向同一个监视器时</span></span><br><span class="line">        <span class="keyword">while</span> (most_recent != limit ) &#123;</span><br><span class="line">            <span class="comment">//如果找到监视器监视的lockee是指向当前锁</span></span><br><span class="line">          <span class="keyword">if</span> ((most_recent)-&gt;<span class="built_in">obj</span>() == lockee) &#123;</span><br><span class="line">            BasicLock* lock = most_recent-&gt;<span class="built_in">lock</span>();</span><br><span class="line">            markOop header = lock-&gt;<span class="built_in">displaced_header</span>();</span><br><span class="line">              <span class="comment">//将监视器指向的obj设为空</span></span><br><span class="line">            most_recent-&gt;<span class="built_in">set_obj</span>(<span class="literal">NULL</span>);</span><br><span class="line">            <span class="keyword">if</span> (!lockee-&gt;<span class="built_in">mark</span>()-&gt;<span class="built_in">has_bias_pattern</span>()) &#123;</span><br><span class="line">                <span class="comment">//如果这个锁不是偏向锁</span></span><br><span class="line">              <span class="type">bool</span> call_vm = UseHeavyMonitors;</span><br><span class="line">                <span class="comment">//获取环境变量是否禁用偏向锁和轻量级锁，默认是false</span></span><br><span class="line">              <span class="comment">// If it isn&#x27;t recursive we either must swap old header or call the runtime</span></span><br><span class="line">                <span class="comment">//判断头是否为空，因为头为空说明是一个重入锁，就不进这个判断，目的是找到第一个锁头</span></span><br><span class="line">              <span class="keyword">if</span> (header != <span class="literal">NULL</span> || call_vm) &#123;</span><br><span class="line">                  <span class="comment">//如果监视器的头不为空，那么CAS操作将锁的lock更新为无锁状态</span></span><br><span class="line">                <span class="keyword">if</span> (call_vm || Atomic::<span class="built_in">cmpxchg_ptr</span>(header, lockee-&gt;<span class="built_in">mark_addr</span>(), lock) != lock) &#123;</span><br><span class="line">                    <span class="comment">//如果失败则进入竞争锁的释放</span></span><br><span class="line">                  <span class="comment">// restore object for the slow case</span></span><br><span class="line">                  most_recent-&gt;<span class="built_in">set_obj</span>(lockee);</span><br><span class="line">                  <span class="built_in">CALL_VM</span>(InterpreterRuntime::<span class="built_in">monitorexit</span>(THREAD, most_recent), handle_exception);</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">              <span class="comment">//运行到这里说明锁是偏向锁，偏向锁就不做任何处理，只更新PC计数器</span></span><br><span class="line">            <span class="built_in">UPDATE_PC_AND_TOS_AND_CONTINUE</span>(<span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          most_recent++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Need to throw illegal monitor state exception</span></span><br><span class="line">        <span class="built_in">CALL_VM</span>(InterpreterRuntime::<span class="built_in">throw_illegal_monitor_state_exception</span>(THREAD), handle_exception);</span><br><span class="line">        <span class="built_in">ShouldNotReachHere</span>();</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="①InterpreterRuntime-monitorexit"   >
          <a href="#①InterpreterRuntime-monitorexit" class="heading-link"><i class="fas fa-link"></i></a><a href="#①InterpreterRuntime-monitorexit" class="headerlink" title="①InterpreterRuntime::monitorexit"></a>①InterpreterRuntime::monitorexit</h4>
      <figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">IRT_ENTRY_NO_ASYNC</span>(<span class="type">void</span>, InterpreterRuntime::<span class="built_in">monitorexit</span>(JavaThread* thread, BasicObjectLock* elem))</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> ASSERT</span></span><br><span class="line">  thread-&gt;<span class="built_in">last_frame</span>().<span class="built_in">interpreter_frame_verify_monitor</span>(elem);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="comment">//封装了线程和Object</span></span><br><span class="line">  <span class="function">Handle <span class="title">h_obj</span><span class="params">(thread, elem-&gt;obj())</span></span>;</span><br><span class="line">  <span class="built_in">assert</span>(Universe::<span class="built_in">heap</span>()-&gt;<span class="built_in">is_in_reserved_or_null</span>(<span class="built_in">h_obj</span>()),</span><br><span class="line">         <span class="string">&quot;must be NULL or an object&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (elem == <span class="literal">NULL</span> || <span class="built_in">h_obj</span>()-&gt;<span class="built_in">is_unlocked</span>()) &#123;</span><br><span class="line">    <span class="built_in">THROW</span>(vmSymbols::<span class="built_in">java_lang_IllegalMonitorStateException</span>());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//进入Slow_exit</span></span><br><span class="line">  ObjectSynchronizer::<span class="built_in">slow_exit</span>(<span class="built_in">h_obj</span>(), elem-&gt;<span class="built_in">lock</span>(), thread);</span><br><span class="line">  <span class="comment">// Free entry. This must be done here, since a pending exception might be installed on</span></span><br><span class="line">  <span class="comment">// exit. If it is not cleared, the exception handling code will try to unlock the monitor again.</span></span><br><span class="line">  elem-&gt;<span class="built_in">set_obj</span>(<span class="literal">NULL</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> ASSERT</span></span><br><span class="line">  thread-&gt;<span class="built_in">last_frame</span>().<span class="built_in">interpreter_frame_verify_monitor</span>(elem);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">IRT_END</span><br></pre></td></tr></table></div></figure>


        <h4 id="②slow-exit"   >
          <a href="#②slow-exit" class="heading-link"><i class="fas fa-link"></i></a><a href="#②slow-exit" class="headerlink" title="②slow_exit"></a>②slow_exit</h4>
      <figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ObjectSynchronizer::slow_exit</span><span class="params">(oop object, BasicLock* lock, TRAPS)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//进入fast_exit</span></span><br><span class="line">  <span class="built_in">fast_exit</span> (object, lock, THREAD) ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="③fast-exit"   >
          <a href="#③fast-exit" class="heading-link"><i class="fas fa-link"></i></a><a href="#③fast-exit" class="headerlink" title="③fast_exit"></a>③fast_exit</h4>
      <figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ObjectSynchronizer::fast_exit</span><span class="params">(oop object, BasicLock* lock, TRAPS)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">assert</span>(!object-&gt;<span class="built_in">mark</span>()-&gt;<span class="built_in">has_bias_pattern</span>(), <span class="string">&quot;should not see bias pattern here&quot;</span>);</span><br><span class="line">  <span class="comment">// if displaced header is null, the previous enter is recursive enter, no-op</span></span><br><span class="line">    <span class="comment">//获得锁头信息</span></span><br><span class="line">  markOop dhw = lock-&gt;<span class="built_in">displaced_header</span>();</span><br><span class="line">  markOop mark ;</span><br><span class="line">    <span class="comment">//如果lockee的头是null说明是一个重入</span></span><br><span class="line">  <span class="keyword">if</span> (dhw == <span class="literal">NULL</span>) &#123;</span><br><span class="line">     <span class="comment">// Recursive stack-lock.</span></span><br><span class="line">     <span class="comment">// Diagnostics -- Could be: stack-locked, inflating, inflated.</span></span><br><span class="line">     mark = object-&gt;<span class="built_in">mark</span>() ;</span><br><span class="line">     <span class="built_in">assert</span> (!mark-&gt;<span class="built_in">is_neutral</span>(), <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">     <span class="keyword">if</span> (mark-&gt;<span class="built_in">has_locker</span>() &amp;&amp; mark != markOopDesc::<span class="built_in">INFLATING</span>()) &#123;</span><br><span class="line">        <span class="built_in">assert</span>(THREAD-&gt;<span class="built_in">is_lock_owned</span>((address)mark-&gt;<span class="built_in">locker</span>()), <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span> (mark-&gt;<span class="built_in">has_monitor</span>()) &#123;</span><br><span class="line">        ObjectMonitor * m = mark-&gt;<span class="built_in">monitor</span>() ;</span><br><span class="line">        <span class="built_in">assert</span>(((oop)(m-&gt;<span class="built_in">object</span>()))-&gt;<span class="built_in">mark</span>() == mark, <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">        <span class="built_in">assert</span>(m-&gt;<span class="built_in">is_entered</span>(THREAD), <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> ;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取BasicObjectLock头信息</span></span><br><span class="line">  mark = object-&gt;<span class="built_in">mark</span>() ;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If the object is stack-locked by the current thread, try to</span></span><br><span class="line">  <span class="comment">// swing the displaced header from the box back to the mark.</span></span><br><span class="line">  <span class="keyword">if</span> (mark == (markOop) lock) &#123;</span><br><span class="line">      <span class="comment">//如果这两个地址相同，说明是一个轻量级锁</span></span><br><span class="line">     <span class="built_in">assert</span> (dhw-&gt;<span class="built_in">is_neutral</span>(), <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">      <span class="comment">//CAS操作将栈中的BasicObjectLock的头信息改成dhw</span></span><br><span class="line">     <span class="keyword">if</span> ((markOop) Atomic::<span class="built_in">cmpxchg_ptr</span> (dhw, object-&gt;<span class="built_in">mark_addr</span>(), mark) == mark) &#123;</span><br><span class="line">         <span class="comment">//如果CAS成功说明轻量级锁释放</span></span><br><span class="line">        <span class="built_in">TEVENT</span> (fast_exit: release stacklock) ;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//没有进入上面轻量级锁的释放说明在mark中的数据改变了，说明是重量级锁的释放</span></span><br><span class="line">    <span class="comment">//调用下面方法膨胀锁获取监视器对象，通过监视器的方法来释放锁</span></span><br><span class="line">  ObjectSynchronizer::<span class="built_in">inflate</span>(THREAD, object)-&gt;<span class="built_in">exit</span> (<span class="literal">true</span>, THREAD) ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h3 id="重量级锁释放-ObjectMonitor-exit"   >
          <a href="#重量级锁释放-ObjectMonitor-exit" class="heading-link"><i class="fas fa-link"></i></a><a href="#重量级锁释放-ObjectMonitor-exit" class="headerlink" title="重量级锁释放(ObjectMonitor::exit)"></a>重量级锁释放(ObjectMonitor::exit)</h3>
      <figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> ATTR <span class="title">ObjectMonitor::exit</span><span class="params">(<span class="type">bool</span> not_suspended, TRAPS)</span> </span>&#123;</span><br><span class="line">   Thread * Self = THREAD ;</span><br><span class="line">    <span class="comment">//判断当前线程是否是持锁线程，目的是将当前线程指向持锁线程</span></span><br><span class="line">   <span class="keyword">if</span> (THREAD != _owner) &#123;</span><br><span class="line">       <span class="comment">//如果当前线程不是持锁线程.那么从栈中找到持锁线程地址交给Thread</span></span><br><span class="line">     <span class="keyword">if</span> (THREAD-&gt;<span class="built_in">is_lock_owned</span>((address) _owner)) &#123;</span><br><span class="line">       <span class="comment">// Transmute _owner from a BasicLock pointer to a Thread address.</span></span><br><span class="line">       <span class="comment">// We don&#x27;t need to hold _mutex for this transition.</span></span><br><span class="line">       <span class="comment">// Non-null to Non-null is safe as long as all readers can</span></span><br><span class="line">       <span class="comment">// tolerate either flavor.</span></span><br><span class="line">       <span class="built_in">assert</span> (_recursions == <span class="number">0</span>, <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">       _owner = THREAD ;</span><br><span class="line">       _recursions = <span class="number">0</span> ;</span><br><span class="line">       OwnerIsThread = <span class="number">1</span> ;</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="comment">// <span class="doctag">NOTE:</span> we need to handle unbalanced monitor enter/exit</span></span><br><span class="line">       <span class="comment">// in native code by throwing an exception.</span></span><br><span class="line">       <span class="comment">// <span class="doctag">TODO:</span> Throw an IllegalMonitorStateException ?</span></span><br><span class="line">       <span class="built_in">TEVENT</span> (Exit - Throw IMSX) ;</span><br><span class="line">       <span class="built_in">assert</span>(<span class="literal">false</span>, <span class="string">&quot;Non-balanced monitor enter/exit!&quot;</span>);</span><br><span class="line">       <span class="keyword">if</span> (<span class="literal">false</span>) &#123;</span><br><span class="line">          <span class="built_in">THROW</span>(vmSymbols::<span class="built_in">java_lang_IllegalMonitorStateException</span>());</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span>;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//运行到这里已经找到了持锁线程</span></span><br><span class="line">	<span class="comment">//判断重入次数，如果不为0说明是重量级锁重入的释放</span></span><br><span class="line">   <span class="keyword">if</span> (_recursions != <span class="number">0</span>) &#123;</span><br><span class="line">       <span class="comment">//重入次数-1然后结束方法</span></span><br><span class="line">     _recursions--;        <span class="comment">// this is simple recursive enter</span></span><br><span class="line">     <span class="built_in">TEVENT</span> (Inflated exit - recursive) ;</span><br><span class="line">     <span class="keyword">return</span> ;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Invariant: after setting Responsible=null an thread must execute</span></span><br><span class="line">   <span class="comment">// a MEMBAR or other serializing instruction before fetching EntryList|cxq.</span></span><br><span class="line">   <span class="keyword">if</span> ((SyncFlags &amp; <span class="number">4</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">      _Responsible = <span class="literal">NULL</span> ;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> INCLUDE_TRACE</span></span><br><span class="line">   <span class="comment">// get the owner&#x27;s thread id for the MonitorEnter event</span></span><br><span class="line">   <span class="comment">// if it is enabled and the thread isn&#x27;t suspended</span></span><br><span class="line">   <span class="keyword">if</span> (not_suspended &amp;&amp; Tracing::<span class="built_in">is_event_enabled</span>(TraceJavaMonitorEnterEvent)) &#123;</span><br><span class="line">     _previous_owner_tid = SharedRuntime::<span class="built_in">get_java_tid</span>(Self);</span><br><span class="line">   &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//自旋</span></span><br><span class="line">   <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">      <span class="built_in">assert</span> (THREAD == _owner, <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (Knob_ExitPolicy == <span class="number">0</span>) &#123;</span><br><span class="line">         <span class="comment">// release semantics: prior loads and stores from within the critical section</span></span><br><span class="line">         <span class="comment">// must not float (reorder) past the following store that drops the lock.</span></span><br><span class="line">         <span class="comment">// On SPARC that requires MEMBAR #loadstore|#storestore.</span></span><br><span class="line">         <span class="comment">// But of course in TSO #loadstore|#storestore is not required.</span></span><br><span class="line">         <span class="comment">// I&#x27;d like to write one of the following:</span></span><br><span class="line">         <span class="comment">// A.  OrderAccess::release() ; _owner = NULL</span></span><br><span class="line">         <span class="comment">// B.  OrderAccess::loadstore(); OrderAccess::storestore(); _owner = NULL;</span></span><br><span class="line">         <span class="comment">// Unfortunately OrderAccess::release() and OrderAccess::loadstore() both</span></span><br><span class="line">         <span class="comment">// store into a _dummy variable.  That store is not needed, but can result</span></span><br><span class="line">         <span class="comment">// in massive wasteful coherency traffic on classic SMP systems.</span></span><br><span class="line">         <span class="comment">// Instead, I use release_store(), which is implemented as just a simple</span></span><br><span class="line">         <span class="comment">// ST on x64, x86 and SPARC.</span></span><br><span class="line">          </span><br><span class="line">          <span class="comment">//设置ObjectMonitor的Owner为NUll</span></span><br><span class="line">         OrderAccess::<span class="built_in">release_store_ptr</span> (&amp;_owner, <span class="literal">NULL</span>) ;   <span class="comment">// drop the lock</span></span><br><span class="line">         OrderAccess::<span class="built_in">storeload</span>() ;                         <span class="comment">// See if we need to wake a successor</span></span><br><span class="line">         </span><br><span class="line">          <span class="comment">//判断cxq阻塞队列和唤醒线程是否为空，如果为空就说明释放结束</span></span><br><span class="line">          <span class="keyword">if</span> ((<span class="built_in">intptr_t</span>(_EntryList)|<span class="built_in">intptr_t</span>(_cxq)) == <span class="number">0</span> || _succ != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">TEVENT</span> (Inflated exit - simple egress) ;</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="built_in">TEVENT</span> (Inflated exit - complex egress) ;</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Normally the exiting thread is responsible for ensuring succession,</span></span><br><span class="line">         <span class="comment">// but if other successors are ready or other entering threads are spinning</span></span><br><span class="line">         <span class="comment">// then this thread can simply store NULL into _owner and exit without</span></span><br><span class="line">         <span class="comment">// waking a successor.  The existence of spinners or ready successors</span></span><br><span class="line">         <span class="comment">// guarantees proper succession (liveness).  Responsibility passes to the</span></span><br><span class="line">         <span class="comment">// ready or running successors.  The exiting thread delegates the duty.</span></span><br><span class="line">         <span class="comment">// More precisely, if a successor already exists this thread is absolved</span></span><br><span class="line">         <span class="comment">// of the responsibility of waking (unparking) one.</span></span><br><span class="line">         <span class="comment">//</span></span><br><span class="line">         <span class="comment">// The _succ variable is critical to reducing futile wakeup frequency.</span></span><br><span class="line">         <span class="comment">// _succ identifies the &quot;heir presumptive&quot; thread that has been made</span></span><br><span class="line">         <span class="comment">// ready (unparked) but that has not yet run.  We need only one such</span></span><br><span class="line">         <span class="comment">// successor thread to guarantee progress.</span></span><br><span class="line">         <span class="comment">// See http://www.usenix.org/events/jvm01/full_papers/dice/dice.pdf</span></span><br><span class="line">         <span class="comment">// section 3.3 &quot;Futile Wakeup Throttling&quot; for details.</span></span><br><span class="line">         <span class="comment">//</span></span><br><span class="line">         <span class="comment">// Note that spinners in Enter() also set _succ non-null.</span></span><br><span class="line">         <span class="comment">// In the current implementation spinners opportunistically set</span></span><br><span class="line">         <span class="comment">// _succ so that exiting threads might avoid waking a successor.</span></span><br><span class="line">         <span class="comment">// Another less appealing alternative would be for the exiting thread</span></span><br><span class="line">         <span class="comment">// to drop the lock and then spin briefly to see if a spinner managed</span></span><br><span class="line">         <span class="comment">// to acquire the lock.  If so, the exiting thread could exit</span></span><br><span class="line">         <span class="comment">// immediately without waking a successor, otherwise the exiting</span></span><br><span class="line">         <span class="comment">// thread would need to dequeue and wake a successor.</span></span><br><span class="line">         <span class="comment">// (Note that we&#x27;d need to make the post-drop spin short, but no</span></span><br><span class="line">         <span class="comment">// shorter than the worst-case round-trip cache-line migration time.</span></span><br><span class="line">         <span class="comment">// The dropped lock needs to become visible to the spinner, and then</span></span><br><span class="line">         <span class="comment">// the acquisition of the lock by the spinner must become visible to</span></span><br><span class="line">         <span class="comment">// the exiting thread).</span></span><br><span class="line">         <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">         <span class="comment">// It appears that an heir-presumptive (successor) must be made ready.</span></span><br><span class="line">         <span class="comment">// Only the current lock owner can manipulate the EntryList or</span></span><br><span class="line">         <span class="comment">// drain _cxq, so we need to reacquire the lock.  If we fail</span></span><br><span class="line">         <span class="comment">// to reacquire the lock the responsibility for ensuring succession</span></span><br><span class="line">         <span class="comment">// falls to the new owner.</span></span><br><span class="line">         <span class="comment">//</span></span><br><span class="line">          </span><br><span class="line">          </span><br><span class="line">          <span class="comment">//运行到这里说明线程的阻塞队列或者唤醒队列有线程等待</span></span><br><span class="line">          </span><br><span class="line">          </span><br><span class="line">          <span class="comment">//CAS操作重新获取一把锁，将监视器指向持锁线程，说明唤醒线程操作只能由持锁线程进行</span></span><br><span class="line">         <span class="keyword">if</span> (Atomic::<span class="built_in">cmpxchg_ptr</span> (THREAD, &amp;_owner, <span class="literal">NULL</span>) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">             <span class="comment">//获取锁失败则返回</span></span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="built_in">TEVENT</span> (Exit - Reacquired) ;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          </span><br><span class="line">          <span class="comment">//判断cxq阻塞队列和唤醒线程是否为空，如果为空就说明释放结束</span></span><br><span class="line">         <span class="keyword">if</span> ((<span class="built_in">intptr_t</span>(_EntryList)|<span class="built_in">intptr_t</span>(_cxq)) == <span class="number">0</span> || _succ != <span class="literal">NULL</span>) &#123;</span><br><span class="line">             </span><br><span class="line">             <span class="comment">//设置ObjectMonitor的Owner为NUll</span></span><br><span class="line">            OrderAccess::<span class="built_in">release_store_ptr</span> (&amp;_owner, <span class="literal">NULL</span>) ;   <span class="comment">// drop the lock</span></span><br><span class="line">            OrderAccess::<span class="built_in">storeload</span>() ;</span><br><span class="line">            <span class="comment">// Ratify the previously observed values.</span></span><br><span class="line">             </span><br><span class="line">             <span class="comment">//如果cxq为空 则结束</span></span><br><span class="line">            <span class="keyword">if</span> (_cxq == <span class="literal">NULL</span> || _succ != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="built_in">TEVENT</span> (Inflated exit - simple egress) ;</span><br><span class="line">                <span class="keyword">return</span> ;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// inopportune interleaving -- the exiting thread (this thread)</span></span><br><span class="line">            <span class="comment">// in the fast-exit path raced an entering thread in the slow-enter</span></span><br><span class="line">            <span class="comment">// path.</span></span><br><span class="line">            <span class="comment">// We have two choices:</span></span><br><span class="line">            <span class="comment">// A.  Try to reacquire the lock.</span></span><br><span class="line">            <span class="comment">//     If the CAS() fails return immediately, otherwise</span></span><br><span class="line">            <span class="comment">//     we either restart/rerun the exit operation, or simply</span></span><br><span class="line">            <span class="comment">//     fall-through into the code below which wakes a successor.</span></span><br><span class="line">            <span class="comment">// B.  If the elements forming the EntryList|cxq are TSM</span></span><br><span class="line">            <span class="comment">//     we could simply unpark() the lead thread and return</span></span><br><span class="line">            <span class="comment">//     without having set _succ.</span></span><br><span class="line">             </span><br><span class="line">             </span><br><span class="line">             <span class="comment">//运行到这里说明cxq不为空，将持锁线程重新交给监视器的ONWER</span></span><br><span class="line">            <span class="keyword">if</span> (Atomic::<span class="built_in">cmpxchg_ptr</span> (THREAD, &amp;_owner, <span class="literal">NULL</span>) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="comment">//cas失败则加锁失败返回</span></span><br><span class="line">               <span class="built_in">TEVENT</span> (Inflated exit - reacquired succeeded) ;</span><br><span class="line">               <span class="keyword">return</span> ;</span><br><span class="line">            &#125;</span><br><span class="line">             </span><br><span class="line">            <span class="built_in">TEVENT</span> (Inflated exit - reacquired failed) ;</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">TEVENT</span> (Inflated exit - complex egress) ;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">       </span><br><span class="line">       <span class="comment">//接下来是唤醒等待队列线程的操作 通过Qmode来判断唤醒操作</span></span><br><span class="line">      <span class="built_in">guarantee</span> (_owner == THREAD, <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line"></span><br><span class="line">      ObjectWaiter * w = <span class="literal">NULL</span> ;</span><br><span class="line">      <span class="type">int</span> QMode = Knob_QMode ;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (QMode == <span class="number">2</span> &amp;&amp; _cxq != <span class="literal">NULL</span>) &#123;</span><br><span class="line">          <span class="comment">// QMode == 2 : cxq has precedence over EntryList.</span></span><br><span class="line">          <span class="comment">// Try to directly wake a successor from the cxq.</span></span><br><span class="line">          <span class="comment">// If successful, the successor will need to unlink itself from cxq.</span></span><br><span class="line">          w = _cxq ;</span><br><span class="line">          <span class="built_in">assert</span> (w != <span class="literal">NULL</span>, <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">          <span class="built_in">assert</span> (w-&gt;TState == ObjectWaiter::TS_CXQ, <span class="string">&quot;Invariant&quot;</span>) ;</span><br><span class="line">          <span class="built_in">ExitEpilog</span> (Self, w) ;</span><br><span class="line">          <span class="keyword">return</span> ;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (QMode == <span class="number">3</span> &amp;&amp; _cxq != <span class="literal">NULL</span>) &#123;</span><br><span class="line">          <span class="comment">// Aggressively drain cxq into EntryList at the first opportunity.</span></span><br><span class="line">          <span class="comment">// This policy ensure that recently-run threads live at the head of EntryList.</span></span><br><span class="line">          <span class="comment">// Drain _cxq into EntryList - bulk transfer.</span></span><br><span class="line">          <span class="comment">// First, detach _cxq.</span></span><br><span class="line">          <span class="comment">// The following loop is tantamount to: w = swap (&amp;cxq, NULL)</span></span><br><span class="line">          w = _cxq ;</span><br><span class="line">          <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">             <span class="built_in">assert</span> (w != <span class="literal">NULL</span>, <span class="string">&quot;Invariant&quot;</span>) ;</span><br><span class="line">             ObjectWaiter * u = (ObjectWaiter *) Atomic::<span class="built_in">cmpxchg_ptr</span> (<span class="literal">NULL</span>, &amp;_cxq, w) ;</span><br><span class="line">             <span class="keyword">if</span> (u == w) <span class="keyword">break</span> ;</span><br><span class="line">             w = u ;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="built_in">assert</span> (w != <span class="literal">NULL</span>              , <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line"></span><br><span class="line">          ObjectWaiter * q = <span class="literal">NULL</span> ;</span><br><span class="line">          ObjectWaiter * p ;</span><br><span class="line">          <span class="keyword">for</span> (p = w ; p != <span class="literal">NULL</span> ; p = p-&gt;_next) &#123;</span><br><span class="line">              <span class="built_in">guarantee</span> (p-&gt;TState == ObjectWaiter::TS_CXQ, <span class="string">&quot;Invariant&quot;</span>) ;</span><br><span class="line">              p-&gt;TState = ObjectWaiter::TS_ENTER ;</span><br><span class="line">              p-&gt;_prev = q ;</span><br><span class="line">              q = p ;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Append the RATs to the EntryList</span></span><br><span class="line">          <span class="comment">// <span class="doctag">TODO:</span> organize EntryList as a CDLL so we can locate the tail in constant-time.</span></span><br><span class="line">          ObjectWaiter * Tail ;</span><br><span class="line">          <span class="keyword">for</span> (Tail = _EntryList ; Tail != <span class="literal">NULL</span> &amp;&amp; Tail-&gt;_next != <span class="literal">NULL</span> ; Tail = Tail-&gt;_next) ;</span><br><span class="line">          <span class="keyword">if</span> (Tail == <span class="literal">NULL</span>) &#123;</span><br><span class="line">              _EntryList = w ;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              Tail-&gt;_next = w ;</span><br><span class="line">              w-&gt;_prev = Tail ;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Fall thru into code that tries to wake a successor from EntryList</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (QMode == <span class="number">4</span> &amp;&amp; _cxq != <span class="literal">NULL</span>) &#123;</span><br><span class="line">          <span class="comment">// Aggressively drain cxq into EntryList at the first opportunity.</span></span><br><span class="line">          <span class="comment">// This policy ensure that recently-run threads live at the head of EntryList.</span></span><br><span class="line"></span><br><span class="line">          <span class="comment">// Drain _cxq into EntryList - bulk transfer.</span></span><br><span class="line">          <span class="comment">// First, detach _cxq.</span></span><br><span class="line">          <span class="comment">// The following loop is tantamount to: w = swap (&amp;cxq, NULL)</span></span><br><span class="line">          w = _cxq ;</span><br><span class="line">          <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">             <span class="built_in">assert</span> (w != <span class="literal">NULL</span>, <span class="string">&quot;Invariant&quot;</span>) ;</span><br><span class="line">             ObjectWaiter * u = (ObjectWaiter *) Atomic::<span class="built_in">cmpxchg_ptr</span> (<span class="literal">NULL</span>, &amp;_cxq, w) ;</span><br><span class="line">             <span class="keyword">if</span> (u == w) <span class="keyword">break</span> ;</span><br><span class="line">             w = u ;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="built_in">assert</span> (w != <span class="literal">NULL</span>              , <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line"></span><br><span class="line">          ObjectWaiter * q = <span class="literal">NULL</span> ;</span><br><span class="line">          ObjectWaiter * p ;</span><br><span class="line">          <span class="keyword">for</span> (p = w ; p != <span class="literal">NULL</span> ; p = p-&gt;_next) &#123;</span><br><span class="line">              <span class="built_in">guarantee</span> (p-&gt;TState == ObjectWaiter::TS_CXQ, <span class="string">&quot;Invariant&quot;</span>) ;</span><br><span class="line">              p-&gt;TState = ObjectWaiter::TS_ENTER ;</span><br><span class="line">              p-&gt;_prev = q ;</span><br><span class="line">              q = p ;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Prepend the RATs to the EntryList</span></span><br><span class="line">          <span class="keyword">if</span> (_EntryList != <span class="literal">NULL</span>) &#123;</span><br><span class="line">              q-&gt;_next = _EntryList ;</span><br><span class="line">              _EntryList-&gt;_prev = q ;</span><br><span class="line">          &#125;</span><br><span class="line">          _EntryList = w ;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Fall thru into code that tries to wake a successor from EntryList</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      w = _EntryList  ;</span><br><span class="line">      <span class="keyword">if</span> (w != <span class="literal">NULL</span>) &#123;</span><br><span class="line">          <span class="comment">// I&#x27;d like to write: guarantee (w-&gt;_thread != Self).</span></span><br><span class="line">          <span class="comment">// But in practice an exiting thread may find itself on the EntryList.</span></span><br><span class="line">          <span class="comment">// Lets say thread T1 calls O.wait().  Wait() enqueues T1 on O&#x27;s waitset and</span></span><br><span class="line">          <span class="comment">// then calls exit().  Exit release the lock by setting O._owner to NULL.</span></span><br><span class="line">          <span class="comment">// Lets say T1 then stalls.  T2 acquires O and calls O.notify().  The</span></span><br><span class="line">          <span class="comment">// notify() operation moves T1 from O&#x27;s waitset to O&#x27;s EntryList. T2 then</span></span><br><span class="line">          <span class="comment">// release the lock &quot;O&quot;.  T2 resumes immediately after the ST of null into</span></span><br><span class="line">          <span class="comment">// _owner, above.  T2 notices that the EntryList is populated, so it</span></span><br><span class="line">          <span class="comment">// reacquires the lock and then finds itself on the EntryList.</span></span><br><span class="line">          <span class="comment">// Given all that, we have to tolerate the circumstance where &quot;w&quot; is</span></span><br><span class="line">          <span class="comment">// associated with Self.</span></span><br><span class="line">          <span class="built_in">assert</span> (w-&gt;TState == ObjectWaiter::TS_ENTER, <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">          <span class="built_in">ExitEpilog</span> (Self, w) ;</span><br><span class="line">          <span class="keyword">return</span> ;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// If we find that both _cxq and EntryList are null then just</span></span><br><span class="line">      <span class="comment">// re-run the exit protocol from the top.</span></span><br><span class="line">      w = _cxq ;</span><br><span class="line">      <span class="keyword">if</span> (w == <span class="literal">NULL</span>) <span class="keyword">continue</span> ;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Drain _cxq into EntryList - bulk transfer.</span></span><br><span class="line">      <span class="comment">// First, detach _cxq.</span></span><br><span class="line">      <span class="comment">// The following loop is tantamount to: w = swap (&amp;cxq, NULL)</span></span><br><span class="line">      <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">          <span class="built_in">assert</span> (w != <span class="literal">NULL</span>, <span class="string">&quot;Invariant&quot;</span>) ;</span><br><span class="line">          ObjectWaiter * u = (ObjectWaiter *) Atomic::<span class="built_in">cmpxchg_ptr</span> (<span class="literal">NULL</span>, &amp;_cxq, w) ;</span><br><span class="line">          <span class="keyword">if</span> (u == w) <span class="keyword">break</span> ;</span><br><span class="line">          w = u ;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">TEVENT</span> (Inflated exit - drain cxq into EntryList) ;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">assert</span> (w != <span class="literal">NULL</span>              , <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">      <span class="built_in">assert</span> (_EntryList  == <span class="literal">NULL</span>    , <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Convert the LIFO SLL anchored by _cxq into a DLL.</span></span><br><span class="line">      <span class="comment">// The list reorganization step operates in O(LENGTH(w)) time.</span></span><br><span class="line">      <span class="comment">// It&#x27;s critical that this step operate quickly as</span></span><br><span class="line">      <span class="comment">// &quot;Self&quot; still holds the outer-lock, restricting parallelism</span></span><br><span class="line">      <span class="comment">// and effectively lengthening the critical section.</span></span><br><span class="line">      <span class="comment">// Invariant: s chases t chases u.</span></span><br><span class="line">      <span class="comment">// TODO-<span class="doctag">FIXME:</span> consider changing EntryList from a DLL to a CDLL so</span></span><br><span class="line">      <span class="comment">// we have faster access to the tail.</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (QMode == <span class="number">1</span>) &#123;</span><br><span class="line">         <span class="comment">// QMode == 1 : drain cxq to EntryList, reversing order</span></span><br><span class="line">         <span class="comment">// We also reverse the order of the list.</span></span><br><span class="line">         ObjectWaiter * s = <span class="literal">NULL</span> ;</span><br><span class="line">         ObjectWaiter * t = w ;</span><br><span class="line">         ObjectWaiter * u = <span class="literal">NULL</span> ;</span><br><span class="line">         <span class="keyword">while</span> (t != <span class="literal">NULL</span>) &#123;</span><br><span class="line">             <span class="built_in">guarantee</span> (t-&gt;TState == ObjectWaiter::TS_CXQ, <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">             t-&gt;TState = ObjectWaiter::TS_ENTER ;</span><br><span class="line">             u = t-&gt;_next ;</span><br><span class="line">             t-&gt;_prev = u ;</span><br><span class="line">             t-&gt;_next = s ;</span><br><span class="line">             s = t;</span><br><span class="line">             t = u ;</span><br><span class="line">         &#125;</span><br><span class="line">         _EntryList  = s ;</span><br><span class="line">         <span class="built_in">assert</span> (s != <span class="literal">NULL</span>, <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="comment">// QMode == 0 or QMode == 2</span></span><br><span class="line">         _EntryList = w ;</span><br><span class="line">         ObjectWaiter * q = <span class="literal">NULL</span> ;</span><br><span class="line">         ObjectWaiter * p ;</span><br><span class="line">         <span class="keyword">for</span> (p = w ; p != <span class="literal">NULL</span> ; p = p-&gt;_next) &#123;</span><br><span class="line">             <span class="built_in">guarantee</span> (p-&gt;TState == ObjectWaiter::TS_CXQ, <span class="string">&quot;Invariant&quot;</span>) ;</span><br><span class="line">             p-&gt;TState = ObjectWaiter::TS_ENTER ;</span><br><span class="line">             p-&gt;_prev = q ;</span><br><span class="line">             q = p ;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// In 1-0 mode we need: ST EntryList; MEMBAR #storestore; ST _owner = NULL</span></span><br><span class="line">      <span class="comment">// The MEMBAR is satisfied by the release_store() operation in ExitEpilog().</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// See if we can abdicate to a spinner instead of waking a thread.</span></span><br><span class="line">      <span class="comment">// A primary goal of the implementation is to reduce the</span></span><br><span class="line">      <span class="comment">// context-switch rate.</span></span><br><span class="line">      <span class="keyword">if</span> (_succ != <span class="literal">NULL</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">      w = _EntryList  ;</span><br><span class="line">      <span class="keyword">if</span> (w != <span class="literal">NULL</span>) &#123;</span><br><span class="line">          <span class="built_in">guarantee</span> (w-&gt;TState == ObjectWaiter::TS_ENTER, <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">          <span class="built_in">ExitEpilog</span> (Self, w) ;</span><br><span class="line">          <span class="keyword">return</span> ;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="锁释放流程图"   >
          <a href="#锁释放流程图" class="heading-link"><i class="fas fa-link"></i></a><a href="#锁释放流程图" class="headerlink" title="锁释放流程图"></a>锁释放流程图</h3>
      <p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230803194242527.png"  alt="锁释放流程图">
      </p>

        <h2 id="锁的降级"   >
          <a href="#锁的降级" class="heading-link"><i class="fas fa-link"></i></a><a href="#锁的降级" class="headerlink" title="锁的降级"></a>锁的降级</h2>
      <p>我们在前面的偏向锁加锁和撤销偏向锁、轻量级锁膨胀、重量级锁膨胀、以及最后的锁的释放过程好像只是把锁头信息给改正，但是好像没有看到锁降级的过程，而锁降级确实是提供了一个方法</p>
<p><strong>即锁在虚拟机的全局安全点会检查是否有闲置的监控器</strong>，<strong>如果有会进行一个锁降级</strong></p>
<p>锁降级方法：在JVM的STW状态进行一个锁的降级</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ObjectSynchronizer::deflate_monitor</span><span class="params">(ObjectMonitor* mid, oop obj,</span></span></span><br><span class="line"><span class="params"><span class="function">                                         ObjectMonitor** FreeHeadp, ObjectMonitor** FreeTailp)</span> </span>&#123;</span><br><span class="line">  <span class="type">bool</span> deflated;</span><br><span class="line">  <span class="comment">// Normal case ... The monitor is associated with obj.</span></span><br><span class="line">  <span class="built_in">guarantee</span> (obj-&gt;<span class="built_in">mark</span>() == markOopDesc::<span class="built_in">encode</span>(mid), <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line">  <span class="built_in">guarantee</span> (mid == obj-&gt;<span class="built_in">mark</span>()-&gt;<span class="built_in">monitor</span>(), <span class="string">&quot;invariant&quot;</span>);</span><br><span class="line">  <span class="built_in">guarantee</span> (mid-&gt;<span class="built_in">header</span>()-&gt;<span class="built_in">is_neutral</span>(), <span class="string">&quot;invariant&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (mid-&gt;<span class="built_in">is_busy</span>()) &#123;</span><br><span class="line">     <span class="keyword">if</span> (ClearResponsibleAtSTW) mid-&gt;_Responsible = <span class="literal">NULL</span> ;</span><br><span class="line">     deflated = <span class="literal">false</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="comment">// Deflate the monitor if it is no longer being used</span></span><br><span class="line">     <span class="comment">// It&#x27;s idle - scavenge and return to the global free list</span></span><br><span class="line">     <span class="comment">// plain old deflation ...</span></span><br><span class="line">     <span class="built_in">TEVENT</span> (deflate_idle_monitors - scavenge1) ;</span><br><span class="line">     <span class="keyword">if</span> (TraceMonitorInflation) &#123;</span><br><span class="line">       <span class="keyword">if</span> (obj-&gt;<span class="built_in">is_instance</span>()) &#123;</span><br><span class="line">         ResourceMark rm;</span><br><span class="line">           tty-&gt;<span class="built_in">print_cr</span>(<span class="string">&quot;Deflating object &quot;</span> INTPTR_FORMAT <span class="string">&quot; , mark &quot;</span> INTPTR_FORMAT <span class="string">&quot; , type %s&quot;</span>,</span><br><span class="line">                (<span class="type">void</span> *) obj, (<span class="type">intptr_t</span>) obj-&gt;<span class="built_in">mark</span>(), obj-&gt;<span class="built_in">klass</span>()-&gt;<span class="built_in">external_name</span>());</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// Restore the header back to obj</span></span><br><span class="line">     obj-&gt;<span class="built_in">release_set_mark</span>(mid-&gt;<span class="built_in">header</span>());</span><br><span class="line">     mid-&gt;<span class="built_in">clear</span>();</span><br><span class="line"></span><br><span class="line">     <span class="built_in">assert</span> (mid-&gt;<span class="built_in">object</span>() == <span class="literal">NULL</span>, <span class="string">&quot;invariant&quot;</span>) ;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// Move the object to the working free list defined by FreeHead,FreeTail.</span></span><br><span class="line">     <span class="keyword">if</span> (*FreeHeadp == <span class="literal">NULL</span>) *FreeHeadp = mid;</span><br><span class="line">     <span class="keyword">if</span> (*FreeTailp != <span class="literal">NULL</span>) &#123;</span><br><span class="line">       ObjectMonitor * prevtail = *FreeTailp;</span><br><span class="line">       <span class="built_in">assert</span>(prevtail-&gt;FreeNext == <span class="literal">NULL</span>, <span class="string">&quot;cleaned up deflated?&quot;</span>); <span class="comment">// TODO KK</span></span><br><span class="line">       prevtail-&gt;FreeNext = mid;</span><br><span class="line">      &#125;</span><br><span class="line">     *FreeTailp = mid;</span><br><span class="line">     deflated = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> deflated;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/08/01/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-JUC%E7%AF%87%5B1-JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80%5D/">深入剖析并发编程-JUC篇[1-JUC并发编程基础]</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-08-01</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">2.3k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">12分</span></span></div></header><div class="post-body"><div class="post-excerpt"><p><strong>JUC并发编程基础</strong></p>
<hr>
<ul>
<li>第一篇是JUC并发编程基础</li>
<li>第二篇是JMM、Volatile关键字、synchronize锁详解</li>
<li>第三篇是CAS机制原理、Unsafe魔法类、ThreadLocal线程变量</li>
</ul>
<hr>

        <h1 id="冯诺依曼体系结构"   >
          <a href="#冯诺依曼体系结构" class="heading-link"><i class="fas fa-link"></i></a><a href="#冯诺依曼体系结构" class="headerlink" title="冯诺依曼体系结构"></a>冯诺依曼体系结构</h1>
      <p>首先，我们要了解并发过程中为什么会导致数据会出错</p>
<p>冯·诺依曼机（von Neumann machine），又称冯·诺依曼计算机，根据<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%86%AF%C2%B7%E8%AF%BA%E4%BE%9D%E6%9B%BC/388909?fromModule=lemma_inlink" >冯·诺依曼</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>提出的<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%AD%98%E5%82%A8%E7%A8%8B%E5%BA%8F/8800242?fromModule=lemma_inlink" >存储程序</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%A6%82%E5%BF%B5%E8%AE%BE%E8%AE%A1/1200478?fromModule=lemma_inlink" >概念设计</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>的<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E8%AE%A1%E7%AE%97%E6%9C%BA/140338?fromModule=lemma_inlink" >计算机</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>。主要特征是：指令与<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%95%B0%E6%8D%AE%E9%83%BD/20348401?fromModule=lemma_inlink" >数据都</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>以<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E4%BA%8C%E8%BF%9B%E5%88%B6/361457?fromModule=lemma_inlink" >二进制</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>形式储存在<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%AD%98%E5%82%A8%E5%99%A8/1583185?fromModule=lemma_inlink" >存储器</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>里；指令根据其储存的<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E9%A1%BA%E5%BA%8F%E6%89%A7%E8%A1%8C/332454?fromModule=lemma_inlink" >顺序执行</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>。 <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.termonline.cn/word/54892/1#s1" >[1]</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%86%AF%C2%B7%E8%AF%BA%E4%BC%8A%E6%9B%BC%E7%BB%93%E6%9E%84/6688306?fromModule=lemma_inlink" >冯·诺伊曼结构</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>（von Neumann architecture），也称冯·诺伊曼模型（Von Neumann model）或普林斯顿结构（Princeton architecture），是一种将程序指令存储器和数据存储器合并在一起的计算机设计<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%A6%82%E5%BF%B5%E7%BB%93%E6%9E%84/22325298?fromModule=lemma_inlink" >概念结构</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>。依据冯·诺伊曼<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E7%BB%93%E6%9E%84%E8%AE%BE%E8%AE%A1/7481502?fromModule=lemma_inlink" >结构设计</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>出的计算机称做冯.诺依曼计算机，又称存储程序计算机。</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230801161725875.png"  alt="冯诺依曼计算机结构图">
      </p>

        <h1 id="CPU模型"   >
          <a href="#CPU模型" class="heading-link"><i class="fas fa-link"></i></a><a href="#CPU模型" class="headerlink" title="CPU模型"></a>CPU模型</h1>
      <p>我们已知线程是CPU任务调度和执行的基本单位，而线程之间通信出现问题导致了数据的不一致性</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230801163419744.png"  alt="CPU内存模型">
      </p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">因为数据在高速缓存中，而线程之间的环境是隔离的</span><br><span class="line">每次只会获取自己线程的Cache，那么数据的不可见性最终导致数据的错误</span><br></pre></td></tr></table></div></figure>


        <h1 id="缓存行"   >
          <a href="#缓存行" class="heading-link"><i class="fas fa-link"></i></a><a href="#缓存行" class="headerlink" title="缓存行"></a>缓存行</h1>
      <p>首先我们要引入一个缓存行的概念，数据在缓存中是怎么存放的</p>
<p>缓存行是数据中存放的单元，在现在主流CPU Cache中缓存行都是64位的，例如一个数据是int类型那么是32位 一个缓存行就能存放两个数据</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230801165444126.png"  alt="缓存行">
      </p>
<p>因此当线程想要获取数据A的时候会将A所在的缓存行刷入自己的Cache中，而当要获取数据B的时候直接从自己的缓存中读取即可，但这就引起了另外的一个问题：伪共享问题</p>

        <h1 id="伪共享"   >
          <a href="#伪共享" class="heading-link"><i class="fas fa-link"></i></a><a href="#伪共享" class="headerlink" title="伪共享"></a>伪共享</h1>
      <p>因此有一个伪共享问题的存在，例如两个Int数据存放在缓存行C1中，而线程T1想要读取数据A，而线程T2想要读取数据B，他们都会从内存将C1刷入自己的Cache中</p>
<p>而当线程T1更新数据A，而线程T2的数据A没有更新，且会因为缓存一致性协议(MESI协议)，将其置为失效状态(I)</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230801171236659.png"  alt="image-20230801171236659">
      </p>
<p><em>而解决伪共享的解决方案有：</em></p>
<p>1.将变量对齐，使其填满一个缓存行</p>
<p>2.将不同线程操作的对象处于不同缓存行中</p>

        <h1 id="缓存一致性协议"   >
          <a href="#缓存一致性协议" class="heading-link"><i class="fas fa-link"></i></a><a href="#缓存一致性协议" class="headerlink" title="缓存一致性协议"></a>缓存一致性协议</h1>
      <p>因为缓存的不一致导致数据出错，那么就有了缓存一致性的需求、</p>
<p>来达到缓存的一致性有两个方式</p>

        <h2 id="给总线加锁"   >
          <a href="#给总线加锁" class="heading-link"><i class="fas fa-link"></i></a><a href="#给总线加锁" class="headerlink" title="给总线加锁"></a>给总线加锁</h2>
      <p>当线程要获取数据的时候发起Lock将与主内存的总线加锁，这样其他线程要获取数据的时候就会被阻塞</p>
<p>这样当线程执行完毕之后写回给内存之后会UnLock解锁，唤醒其他线程</p>
<p>弊端：这样导致了线程的串行化，会造成性能影响。和我们多线程的意愿违背</p>

        <h2 id="缓存一致性协议-MESI协议"   >
          <a href="#缓存一致性协议-MESI协议" class="heading-link"><i class="fas fa-link"></i></a><a href="#缓存一致性协议-MESI协议" class="headerlink" title="缓存一致性协议(MESI协议)"></a>缓存一致性协议(MESI协议)</h2>
      <p>缓存一致性协议有很多，而我们这里只谈MESI协议</p>
<p><strong>MESI协议</strong></p>
<p>M:	修改(Modified) ， 意思是这个数据只在本线程独有，并且这个数据与主存的数据不一致，是修改过后的数据</p>
<p>E：  独享(Exclusive)， 意思是这个数据只有本线程独有，并且和主存的数据一致</p>
<p>S：  分享(Shared)，    意思是这个数据被多个线程持有，并且和主存的数据一致</p>
<p>I：   失效(invalid)，     意思是这个数据已经被其他线程修改而导致失效了，需要重新从主存中获取数据</p>
<p>Cache Line在高速缓存Cache中的状态就变成 高两位为信号位(用来存放MESI状态)，后面为数据位</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230801172256181.png"  alt="缓存行在Cache中">
      </p>

        <h2 id="消息"   >
          <a href="#消息" class="heading-link"><i class="fas fa-link"></i></a><a href="#消息" class="headerlink" title="消息"></a>消息</h2>
      <p>MESI状态变换要通过消息来进行变换，而每次CPU在进行数据操作的时候都会有一个嗅探机制来处理信号并且在一定条件下响应信号</p>
<ul>
<li><p>Read 信号：表示要读取某个缓存行，会附带目标的物理地址</p>
</li>
<li><p>Read Response信号：反馈Read信号，内容就是Read信号的目标缓存行。Read Response信号可以由内存发出，也可以由其他CPU核心发出</p>
</li>
<li><p>Invalidate信号： 表示数据要被更新，告诉共享的CPU核数据已经失效了</p>
</li>
<li><p>Invalidate Acknowledge信号：表示知道数据已经失效，准备清空缓存数据</p>
</li>
<li><p>Read Invalidate信号：为Read+Invalidate，既要读取数据又要更新数据，让其他缓存行数据失效</p>
</li>
<li><p>Writeback信号：数据回写信号，在某一定条件下数据从Cache写回内存中</p>
</li>
</ul>

        <h2 id="图解MESI的各种变幻状态"   >
          <a href="#图解MESI的各种变幻状态" class="heading-link"><i class="fas fa-link"></i></a><a href="#图解MESI的各种变幻状态" class="headerlink" title="图解MESI的各种变幻状态"></a>图解MESI的各种变幻状态</h2>
      <p>我们假设有两个线程来获取数据</p>

        <h3 id="①线程A获取数据"   >
          <a href="#①线程A获取数据" class="heading-link"><i class="fas fa-link"></i></a><a href="#①线程A获取数据" class="headerlink" title="①线程A获取数据"></a>①线程A获取数据</h3>
      <p>发起一个Read信号，想要读取内存中的数据放入到线程中Cache里</p>
<p>此时返回一个Read Response信号，此时Read Response信号来自内存，线程A中的缓存行状态为E态(独享)</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230801171827789.png"  alt="仅线程A获取数据">
      </p>

        <h3 id="②线程B获取数据"   >
          <a href="#②线程B获取数据" class="heading-link"><i class="fas fa-link"></i></a><a href="#②线程B获取数据" class="headerlink" title="②线程B获取数据"></a>②线程B获取数据</h3>
      <p>线程B也发起Read信号，返回一个Read Response信号,可能来自线程A中，将线程A中的缓存行状态改成S态(独享)</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230801171947078.png"  alt="线程B也获取同一个数据">
      </p>

        <h3 id="③线程A更新数据"   >
          <a href="#③线程A更新数据" class="heading-link"><i class="fas fa-link"></i></a><a href="#③线程A更新数据" class="headerlink" title="③线程A更新数据"></a>③线程A更新数据</h3>
      <p>发出Invalidate信号，将线程B中的数据更新成I态，此时线程A的缓存行状态为M态</p>
<p>线程B会返回一个Invalidate Acknowledge信号，表示自己已经知道数据失效了将要清空缓存</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230801173716877.png"  alt="线程A更新数据">
      </p>

        <h3 id="④数据写回内存"   >
          <a href="#④数据写回内存" class="heading-link"><i class="fas fa-link"></i></a><a href="#④数据写回内存" class="headerlink" title="④数据写回内存"></a>④数据写回内存</h3>
      <p>发起WriteBack信号，写回数据，并将现场A缓存中数据置为E态</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230801173940439.png"  alt="数据写回内存">
      </p>

        <h1 id="CPU空闲-–-引入Store-Buffer"   >
          <a href="#CPU空闲-–-引入Store-Buffer" class="heading-link"><i class="fas fa-link"></i></a><a href="#CPU空闲-–-引入Store-Buffer" class="headerlink" title="CPU空闲 –&gt; 引入Store Buffer"></a>CPU空闲 –&gt; 引入Store Buffer</h1>
      <p>当线程A发起写操作并且发起Invalidate信号必须要等其他线程返回Invalidate Acknowledge信号 那么就会有一个等待时间，而我们要的是CPU忙，让CPU空闲不是我们想要的</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230801174606159.png"  alt="CPU空闲">
      </p>
<p>所以引入了StoreBuffer，将修改之后的操作直接存入StoreBuffer中，而StoreBuffer以某种条件刷入到Cache中再去执行操作，这样就不会导致线程空闲。</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230801175207579.png"  alt="引入StroeBuffer之后">
      </p>
<p>当线程有执行操作之后直接写入到StoreBuffer中，而StoreBuffer是一个先进先出的队列，这样能保证数据刷出的有序性</p>
<p>而线程要读取数据的时候发现StoreBuffer中有的时候可以直接从StroeBuffer中获取数据</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230801175913669.png"  alt="处理模型">
      </p>
<p><em>引出的问题</em>：StoreBuffer会引起缓存的不一致性，当数据还没刷出到Cache中的时候就导致了数据的错误</p>
<p><strong>解决方案</strong></p>
<p>添加屏障(CPU屏障)：写屏障或者全屏障，当写操作之前，将StoreBuffer的数据刷入到Cache中</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230801180536132.png"  alt="添加屏障，将StoreBuffer数据写到Cache中">
      </p>

        <h1 id="引入Invalidate-Queues"   >
          <a href="#引入Invalidate-Queues" class="heading-link"><i class="fas fa-link"></i></a><a href="#引入Invalidate-Queues" class="headerlink" title="引入Invalidate Queues"></a>引入Invalidate Queues</h1>
      <p>当StoreBuffer打满要刷新到Cache中或者因为其他原因要写到Cache中，多个Invalidate信号要等待Invalidate AcknowLedge信号而Invalidate AcknowLedge信号很慢，这段时间会空闲，所以引入了一个失效队列，当失效信号发出就发到失效队列中，这样就异步解决了这个问题</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230801181326286.png"  alt="引入Invalidate Queues">
      </p>
<p><em>引出的问题</em>：Invalidate会引起缓存的不一致性，当信号还没执行，就要读取数据了而此时数据没更新会导致数据的错误</p>
<p><strong>解决方案</strong></p>
<p>添加屏障(CPU屏障)：读屏障或者全屏障，当读操作之前，将InvalidateQueue中作用到Cache中</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230801181924213.png"  alt="添加屏障">
      </p>

        <h1 id="乱序问题"   >
          <a href="#乱序问题" class="heading-link"><i class="fas fa-link"></i></a><a href="#乱序问题" class="headerlink" title="乱序问题"></a>乱序问题</h1>
      <p>因为指令在虚拟机执行可能会进行一个重排，导致一个不可见性，所以有可能出现乱序问题</p>
<ul>
<li><p>Load Load：有问题，线程A读取数据的时候第一次读取和第二次读取可能不一样(其他线程进行改动)</p>
</li>
<li><p>Load Store：没问题，线程A读取数据然后从写入数据到StoreBuffer中</p>
</li>
<li><p>Store Load：有问题，线程A写操作写入StoreBuffer而没有刷到主存中，线程B再读数据就会读到脏数据</p>
</li>
<li><p>Store Store：：没问题，线程A写入StoreBuffer中，因为StoreBuffer是先进先出的队列，只要保证Happens-before原则，那么执行的顺序就是有序的</p>
</li>
</ul>
<p>解决方案:利用屏障，将数据刷出在Cache中</p>

        <h1 id="总结："   >
          <a href="#总结：" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结：" class="headerlink" title="总结："></a>总结：</h1>
      <p>以上是从硬件层面来讲JUC为什么并发会导致数据错误，我们真正要进入Java的世界中去探讨JUC并发编程的问题了</p>
<hr>

        <h1 id="后记"   >
          <a href="#后记" class="heading-link"><i class="fas fa-link"></i></a><a href="#后记" class="headerlink" title="后记"></a>后记</h1>
      <p>我学JUC这块我很幸运我能在大概几百个点击的时候在B站看到J3Code老哥对JUC并发编程的视频，我没有选择尚硅谷、马士兵、黑马的视频，可能是在学JUC这块看到了一些差评的原因，而黑马是因为视频有点旧了，实际上我学的还是JDK8的，到现在为止视频应该是可以学习的。但是因为有些评论说是因为PPT讲师造就PPT程序员，是吧。所以看差评这块影响心态被拿捏的死死的</p>
<hr>
<p>总之，我还是非常感谢J3Code老哥可以免费分享出他深入JUC这块的成果，下面是他的CSDN地址</p>
<div class="table-container"><table>
<thead>
<tr>
<th>作者</th>
<th>CSDN主页地址</th>
</tr>
</thead>
<tbody><tr>
<td>J3code</td>
<td><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/qq_40399646" >https://blog.csdn.net/qq_40399646</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td>
</tr>
</tbody></table></div>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/07/30/MallChat%E9%A1%B9%E7%9B%AE%E5%88%86%E6%9E%90/">MallChat项目分析</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-07-30</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">7.8k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">73分</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="先跑通项目"   >
          <a href="#先跑通项目" class="heading-link"><i class="fas fa-link"></i></a><a href="#先跑通项目" class="headerlink" title="先跑通项目"></a>先跑通项目</h1>
      
        <h2 id="尝试运行"   >
          <a href="#尝试运行" class="heading-link"><i class="fas fa-link"></i></a><a href="#尝试运行" class="headerlink" title="尝试运行"></a>尝试运行</h2>
      
        <h3 id="后端"   >
          <a href="#后端" class="heading-link"><i class="fas fa-link"></i></a><a href="#后端" class="headerlink" title="后端:"></a>后端:</h3>
      <p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230730100207953.png"  alt="image-20230730100207953">
      </p>
<p>|INFO|2023-07-30 09:50:38.781|main||uid&#x3D;|Tomcat initialized with port(s): 8080 (http)|</p>
<p>找到内置的tomcat服务器端口号是8080</p>

        <h3 id="前端"   >
          <a href="#前端" class="heading-link"><i class="fas fa-link"></i></a><a href="#前端" class="headerlink" title="前端:"></a>前端:</h3>
      <p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230730103826557.png"  alt="image-20230730103826557">
      </p>

        <h2 id="尝试进入Swagger"   >
          <a href="#尝试进入Swagger" class="heading-link"><i class="fas fa-link"></i></a><a href="#尝试进入Swagger" class="headerlink" title="尝试进入Swagger"></a>尝试进入Swagger</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.github.xiaoymin&lt;/groupId&gt;</span><br><span class="line">    &lt;!--使用Swagger2--&gt;</span><br><span class="line">    &lt;artifactId&gt;knife4j-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">2.0</span><span class="number">.9</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></div></figure>

<p>因为找到了Swagger2依赖 所以项目中用了Swagger</p>
<p>尝试进入Swagger-ui页面</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230730100713827.png"  alt="image-20230730100713827">
      </p>
<p>找到Swagger配置类</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SwaggerConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean(value = &quot;defaultApi2&quot;)</span></span><br><span class="line">    Docket <span class="title function_">docket</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Docket</span>(DocumentationType.SWAGGER_2)</span><br><span class="line">                <span class="comment">//配置网站的基本信息</span></span><br><span class="line">                .apiInfo(<span class="keyword">new</span> <span class="title class_">ApiInfoBuilder</span>()</span><br><span class="line">                        <span class="comment">//网站标题</span></span><br><span class="line">                        .title(<span class="string">&quot;mallchat接口文档&quot;</span>)</span><br><span class="line">                        <span class="comment">//标题后面的版本号</span></span><br><span class="line">                        .version(<span class="string">&quot;v1.0&quot;</span>)</span><br><span class="line">                        .description(<span class="string">&quot;mallchat接口文档&quot;</span>)</span><br><span class="line">                        <span class="comment">//联系人信息</span></span><br><span class="line">                        .contact(<span class="keyword">new</span> <span class="title class_">Contact</span>(<span class="string">&quot;阿斌&quot;</span>, <span class="string">&quot;http://www.mallchat.cn&quot;</span>, <span class="string">&quot;972627721@qq.com&quot;</span>))</span><br><span class="line">                        .build())</span><br><span class="line">                .select()</span><br><span class="line">                <span class="comment">//指定接口的位置</span></span><br><span class="line">                .apis(RequestHandlerSelectors</span><br><span class="line">                        .withClassAnnotation(RestController.class)</span><br><span class="line">                )</span><br><span class="line">                .paths(PathSelectors.any())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>

<p>通过mallchat文档中得知</p>
<p>SwaggerUI经过Knife4j优化之后URL变更了</p>
<p>从localhost:8080&#x2F;doc.html进入SwaggerUI中</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230730103929645.png"  alt="image-20230730103929645">
      </p>
<p>获得了接口列表</p>

        <h2 id="端口号分析"   >
          <a href="#端口号分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#端口号分析" class="headerlink" title="端口号分析"></a>端口号分析</h2>
      <p>3306: Mysql端口</p>
<p>6379: Redis端口</p>
<p>8080:本地tomcat端口</p>
<p>8090?</p>
<p>9000:minio端口</p>
<p>9988?</p>

        <h2 id="进入前端界面尝试前后端联调"   >
          <a href="#进入前端界面尝试前后端联调" class="heading-link"><i class="fas fa-link"></i></a><a href="#进入前端界面尝试前后端联调" class="headerlink" title="进入前端界面尝试前后端联调"></a>进入前端界面尝试前后端联调</h2>
      <p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230730161607692.png"  alt="image-20230730161607692">
      </p>

        <h2 id="申请测试号，来进行获取微信信息"   >
          <a href="#申请测试号，来进行获取微信信息" class="heading-link"><i class="fas fa-link"></i></a><a href="#申请测试号，来进行获取微信信息" class="headerlink" title="申请测试号，来进行获取微信信息"></a>申请测试号，来进行获取微信信息</h2>
      <p>通过微信测试号可以获得登录的头像等微信信息</p>

        <h2 id="通过测试号获取到登录信息之后进入前端页面进行测试"   >
          <a href="#通过测试号获取到登录信息之后进入前端页面进行测试" class="heading-link"><i class="fas fa-link"></i></a><a href="#通过测试号获取到登录信息之后进入前端页面进行测试" class="headerlink" title="通过测试号获取到登录信息之后进入前端页面进行测试"></a>通过测试号获取到登录信息之后进入前端页面进行测试</h2>
      <p>清除浏览器Session然后重新刷新页面抓到初始化请求</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230730225147538.png"  alt="image-20230730225147538">
      </p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="/MallChat%E9%A1%B9%E7%9B%AE%E5%88%86%E6%9E%90/image-20230731101441566.png"  alt="image-20230731101441566">
      </p>
<div class="table-container"><table>
<thead>
<tr>
<th>name</th>
<th>请求类型</th>
<th>URL</th>
</tr>
</thead>
<tbody><tr>
<td>page?pageSize&#x3D;20</td>
<td>GET请求</td>
<td><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://localhost:9988/capi/chat/public/member/page?pageSize=20" >http://localhost:9988/capi/chat/public/member/page?pageSize=20</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td>
</tr>
<tr>
<td>statistic</td>
<td>GET请求</td>
<td><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://localhost:9988/capi/chat/public/member/statistic" >http://localhost:9988/capi/chat/public/member/statistic</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td>
</tr>
<tr>
<td>badges</td>
<td>GET请求</td>
<td><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://localhost:9988/capi/user/badges" >http://localhost:9988/capi/user/badges</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td>
</tr>
<tr>
<td>page?pageSize&#x3D;20&amp;roomId&#x3D;1</td>
<td>GET请求</td>
<td><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://localhost:9988/capi/chat/public/msg/page?pageSize=20&roomId=1" >http://localhost:9988/capi/chat/public/msg/page?pageSize=20&amp;roomId=1</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td>
</tr>
<tr>
<td>list</td>
<td>GET请求</td>
<td><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://localhost:9988/capi/user/emoji/list" >http://localhost:9988/capi/user/emoji/list</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td>
</tr>
</tbody></table></div>
<p>然后点击登录按钮</p>
<p>通过微信扫码登录到聊天室中</p>
<p>我们来看新增的两个请求</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230731100759932.png"  alt="image-20230731100759932">
      </p>
<div class="table-container"><table>
<thead>
<tr>
<th>name</th>
<th>请求类型</th>
<th>URL</th>
</tr>
</thead>
<tbody><tr>
<td>userInfo</td>
<td>GET请求</td>
<td><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://localhost:9988/capi/user/userInfo" >http://localhost:9988/capi/user/userInfo</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td>
</tr>
<tr>
<td>list?uid&#x3D;10003</td>
<td>GET请求</td>
<td><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://localhost:9988/capi/user/emoji/list?uid=10003" >http://localhost:9988/capi/user/emoji/list?uid=10003</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></td>
</tr>
</tbody></table></div>
<p>这个登录是通过VX扫码实现的，我们之后再看这个逻辑实现</p>
<p>先从用户模块开始看吧</p>

        <h2 id="用户模块"   >
          <a href="#用户模块" class="heading-link"><i class="fas fa-link"></i></a><a href="#用户模块" class="headerlink" title="用户模块"></a>用户模块</h2>
      <p>从Swaager-ui发起测试请求，响应结果是未登录</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/image-20230731102513714.png"  alt="image-20230731102513714">
      </p>
<p>可知URI被拦截器拦截</p>
<p>找到Token拦截器</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">//获取用户登录token</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> getToken(request);</span><br><span class="line">    <span class="type">Long</span> <span class="variable">validUid</span> <span class="operator">=</span> loginService.getValidUid(token);</span><br><span class="line">    <span class="keyword">if</span> (Objects.nonNull(validUid)) &#123;<span class="comment">//有登录态</span></span><br><span class="line">        request.setAttribute(ATTRIBUTE_UID, validUid);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isPublicURI</span> <span class="operator">=</span> isPublicURI(request.getRequestURI());</span><br><span class="line">        <span class="keyword">if</span> (!isPublicURI) &#123;<span class="comment">//又没有登录态，又不是公开路径，直接401</span></span><br><span class="line">            HttpErrorEnum.ACCESS_DENIED.sendHttpError(response);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    MDC.put(MDCKey.UID, String.valueOf(validUid));</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>调用了一个isPublicURI方法 来判断是不是公开路径</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isPublicURI</span><span class="params">(String requestURI)</span> &#123;</span><br><span class="line">    String[] split = requestURI.split(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> split.length &gt; <span class="number">2</span> &amp;&amp; <span class="string">&quot;public&quot;</span>.equals(split[<span class="number">3</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//将请求通过&#x27;/&#x27;分割,当数组长度大于2并且第四块为public的时候说明是公开路径</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">例如 http://localhost:9988/capi/user/userInfo</span></span><br><span class="line"><span class="comment">通过&#x27;/&#x27;切割 </span></span><br><span class="line"><span class="comment">则</span></span><br><span class="line"><span class="comment">split[0],</span></span><br><span class="line"><span class="comment">split[1],capi</span></span><br><span class="line"><span class="comment">split[2],user</span></span><br><span class="line"><span class="comment">split[3],userInfo</span></span><br><span class="line"><span class="comment">例如 http://localhost:9988/capi/chat/public/member/page</span></span><br><span class="line"><span class="comment">则</span></span><br><span class="line"><span class="comment">split[0],</span></span><br><span class="line"><span class="comment">split[1],capi</span></span><br><span class="line"><span class="comment">split[2],chat</span></span><br><span class="line"><span class="comment">split[3],public</span></span><br><span class="line"><span class="comment">split[4],member</span></span><br><span class="line"><span class="comment">split[5],page</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>决定用通过登录之后的前端来进行测试</p>

        <h3 id="获得用户信息"   >
          <a href="#获得用户信息" class="heading-link"><i class="fas fa-link"></i></a><a href="#获得用户信息" class="headerlink" title="获得用户信息"></a>获得用户信息</h3>
      <div class="table-container"><table>
<thead>
<tr>
<th>访问uri</th>
<th>请求类型</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;capi&#x2F;user&#x2F;userInfo</td>
<td>GET请求</td>
</tr>
</tbody></table></div>

        <h4 id="Controller层"   >
          <a href="#Controller层" class="heading-link"><i class="fas fa-link"></i></a><a href="#Controller层" class="headerlink" title="Controller层"></a>Controller层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/userInfo&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;用户详情&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ApiResult&lt;UserInfoResp&gt; <span class="title function_">getUserInfo</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//通过获取请求的上下文获取uid调用userService.getUserInfo方法  传入具体的Uid</span></span><br><span class="line">    <span class="keyword">return</span> ApiResult.success(userService.getUserInfo(RequestHolder.get().getUid()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>调用getUserInfo方法</p>
<p>将返回结果封装成APIResult对象(统一返回类型)</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(&quot;基础返回体&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApiResult</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;成功标识true or false&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Boolean success;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;错误码&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer errCode;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;错误消息&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String errMsg;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;返回对象&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; ApiResult&lt;T&gt; <span class="title function_">success</span><span class="params">(T data)</span> &#123;</span><br><span class="line">        ApiResult&lt;T&gt; result = <span class="keyword">new</span> <span class="title class_">ApiResult</span>&lt;T&gt;();</span><br><span class="line">        result.setData(data);</span><br><span class="line">        result.setSuccess(Boolean.TRUE);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//传入的参数data是Controller层中的</span></span><br><span class="line"><span class="comment">//userService.getUserInfo(RequestHolder.get().getUid())</span></span><br></pre></td></tr></table></div></figure>


        <h4 id="UserService层"   >
          <a href="#UserService层" class="heading-link"><i class="fas fa-link"></i></a><a href="#UserService层" class="headerlink" title="UserService层"></a>UserService层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UserInfoResp <span class="title function_">getUserInfo</span><span class="params">(Long uid)</span>;</span><br></pre></td></tr></table></div></figure>

<p>实现类中</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> UserInfoResp <span class="title function_">getUserInfo</span><span class="params">(Long uid)</span> &#123;</span><br><span class="line">       <span class="comment">//查询缓存中有没有这个Uid,本质上调用map.get() 如果有则返回User 如果没有则返回null</span></span><br><span class="line">       <span class="type">User</span> <span class="variable">userInfo</span> <span class="operator">=</span> userCache.getUserInfo(uid);</span><br><span class="line">       <span class="comment">//查询当前用户(Uid)的物品改名卡使用状态</span></span><br><span class="line">       <span class="type">Integer</span> <span class="variable">countByValidItemId</span> <span class="operator">=</span></span><br><span class="line">           userBackpackDao.getCountByValidItemId(uid, ItemEnum.MODIFY_NAME_CARD.getId());</span><br><span class="line">       <span class="keyword">return</span> UserAdapter.buildUserInfoResp(userInfo, countByValidItemId);</span><br><span class="line">       <span class="comment">//将缓存中的数据和当前用户改名卡状态发送到适配器中buildUserInfoResp中</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="getUserInfo"   >
          <a href="#getUserInfo" class="heading-link"><i class="fas fa-link"></i></a><a href="#getUserInfo" class="headerlink" title="getUserInfo"></a>getUserInfo</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> User <span class="title function_">getUserInfo</span><span class="params">(Long uid)</span> &#123;<span class="comment">//todo 后期做二级缓存</span></span><br><span class="line">		<span class="comment">//调用getUserInfoBatch获取一个Map&lt;Long,user&gt; 然后调用Map的get方法  如果有数据返回User,没有返回null</span></span><br><span class="line">       <span class="keyword">return</span> getUserInfoBatch(Collections.singleton(uid)).get(uid);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="getInfoBatch"   >
          <a href="#getInfoBatch" class="heading-link"><i class="fas fa-link"></i></a><a href="#getInfoBatch" class="headerlink" title="getInfoBatch"></a>getInfoBatch</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Map&lt;Long, User&gt; <span class="title function_">getUserInfoBatch</span><span class="params">(Set&lt;Long&gt; uids)</span> &#123;</span><br><span class="line">    	<span class="comment">//将uids转换成流 然后调用RedisKey的封装类将其拼接成mallchat:userInfo:uid_%d的格式，然后转成List列表</span></span><br><span class="line">        List&lt;String&gt; keys = uids.stream().map(a -&gt; RedisKey.getKey(RedisKey.USER_INFO_STRING, a)).collect(Collectors.toList());</span><br><span class="line">    	<span class="comment">//调用RedisUtils的mget方法，返回多个User放到List中</span></span><br><span class="line">        List&lt;User&gt; mget = RedisUtils.mget(keys, User.class);</span><br><span class="line">    	<span class="comment">//过滤非空的对象，封装成Key为Uid,Value为User的map 这里的map是缓存中的map</span></span><br><span class="line">        Map&lt;Long, User&gt; map = mget.stream().filter(Objects::nonNull).collect(Collectors.toMap(User::getId, Function.identity()));</span><br><span class="line">        <span class="comment">//还需要load更新的uid</span></span><br><span class="line">    	<span class="comment">//找到不包含在缓存中的uid放到needLoadUidList中</span></span><br><span class="line">        List&lt;Long&gt; needLoadUidList = uids.stream().filter(a -&gt; !map.containsKey(a)).collect(Collectors.toList());</span><br><span class="line">    	<span class="comment">//如果needLoadUidList非空则说明有新数据要写到缓存中</span></span><br><span class="line">        <span class="keyword">if</span> (CollUtil.isNotEmpty(needLoadUidList)) &#123;</span><br><span class="line">            <span class="comment">//调用userDao的查询方法 ，UserDao调用getBaseMapper().selectBatchIds(idList)获取数据库中的user用户列表</span></span><br><span class="line">            List&lt;User&gt; needLoadUserList = userDao.listByIds(needLoadUidList);</span><br><span class="line">            <span class="comment">//统一转换成key为mallchat:userInfo:uid_%d,value为User的格式 放到Map</span></span><br><span class="line">            Map&lt;String, User&gt; redisMap = needLoadUserList.stream().collect(Collectors.toMap(a -&gt; RedisKey.getKey(RedisKey.USER_INFO_STRING, a.getId()), Function.identity()));</span><br><span class="line">            <span class="comment">//调用RedisUtils.mset 统一写进缓存 参数一:要写进去的数据,参数二:过期时间5*60</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">//将查询UserInfo的缓存设置为300s 即5分钟</span></span><br><span class="line">            RedisUtils.mset(redisMap, <span class="number">5</span> * <span class="number">60</span>);</span><br><span class="line">            <span class="comment">//将更新完到缓存的数据放回到map中，用于进行返回用户数据</span></span><br><span class="line">            map.putAll(needLoadUserList.stream().collect(Collectors.toMap(User::getId, Function.identity())));</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">//返回map</span></span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="UserBackPackDao"   >
          <a href="#UserBackPackDao" class="heading-link"><i class="fas fa-link"></i></a><a href="#UserBackPackDao" class="headerlink" title="UserBackPackDao"></a>UserBackPackDao</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserBackpackDao</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;UserBackpackMapper, UserBackpack&gt; &#123;</span><br><span class="line">	<span class="comment">//利用了MP</span></span><br><span class="line">	<span class="keyword">public</span> Integer <span class="title function_">getCountByValidItemId</span><span class="params">(Long uid, Long itemId)</span> &#123;</span><br><span class="line">        <span class="comment">//调用lambdaQuery方法</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//这个Select语句是 SELECT COUNT( 1 ) FROM user_backpack WHERE (uid = ? AND item_id = ? AND status = ?)</span></span><br><span class="line">        <span class="comment">//注入的参数是uid: 10004， itemId: 1 ,status =0</span></span><br><span class="line">        <span class="comment">//翻译过来是查询10004号用户，物品ID为1(改名卡),未被使用(0未使用,1已使用)</span></span><br><span class="line">        <span class="comment">//返回了1  即10004用户状态正如参数所示</span></span><br><span class="line">        <span class="keyword">return</span> lambdaQuery().eq(UserBackpack::getUid, uid)</span><br><span class="line">                .eq(UserBackpack::getItemId, itemId)</span><br><span class="line">                .eq(UserBackpack::getStatus, YesOrNoEnum.NO.getStatus())</span><br><span class="line">                .count();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="流程"   >
          <a href="#流程" class="heading-link"><i class="fas fa-link"></i></a><a href="#流程" class="headerlink" title="流程"></a>流程</h4>
      <p>①查询用户信息的时候，Controller调用service的查询userInfo的方法，传入请求中的uid 然后包装成APIResult返回前端</p>
<p>②serviceImpl 查询用户数据 直接查询缓存，如果查询到缓存则直接返回用户数据</p>
<p>③如果缓存中没有数据则通过userDao查询数据库，数据库返回到的数据先写回到Redis中设置过期时间为300秒</p>
<p>④将查询结果返回，然后查询用户物品使用信息 调用userBackpackDao的方法</p>
<p>⑤统一将用户详情信息、用户物品使用信息用userAdapter封装返回</p>

        <h3 id="修改用户名"   >
          <a href="#修改用户名" class="heading-link"><i class="fas fa-link"></i></a><a href="#修改用户名" class="headerlink" title="修改用户名"></a>修改用户名</h3>
      <p>访问uil</p>
<div class="table-container"><table>
<thead>
<tr>
<th>访问uil</th>
<th>请求类型</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;capi&#x2F;user&#x2F;name</td>
<td>PUT请求</td>
</tr>
</tbody></table></div>

        <h4 id="Controller层-1"   >
          <a href="#Controller层-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#Controller层-1" class="headerlink" title="Controller层"></a>Controller层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PutMapping(&quot;/name&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;修改用户名&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ApiResult&lt;Void&gt; <span class="title function_">modifyName</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> ModifyNameReq req)</span> &#123;</span><br><span class="line">    userService.modifyName(RequestHolder.get().getUid(), req);</span><br><span class="line">    <span class="keyword">return</span> ApiResult.success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>调用userService.modfiyName方法修改用户名</p>
<p>返回成功结果</p>

        <h4 id="UserService层-1"   >
          <a href="#UserService层-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#UserService层-1" class="headerlink" title="UserService层"></a>UserService层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">modifyName</span><span class="params">(Long uid, ModifyNameReq req)</span>;</span><br></pre></td></tr></table></div></figure>

<p>实现类中</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">modifyName</span><span class="params">(Long uid, ModifyNameReq req)</span> &#123;</span><br><span class="line">    <span class="comment">//从请求中获取新的用户名</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">newName</span> <span class="operator">=</span> req.getName();</span><br><span class="line">    <span class="comment">//检查用户名是否合法,如果不合法会抛出异常</span></span><br><span class="line">    AssertUtil.isFalse(sensitiveWordBs.hasSensitiveWord(newName), <span class="string">&quot;名字中包含敏感词，请重新输入&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//检查用户列表中有没有该用户使用这个用户名 如果有则会返回一个User</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">oldUser</span> <span class="operator">=</span> userDao.getByName(newName);</span><br><span class="line">    <span class="comment">//判断用户中有这个名字则抛出异常</span></span><br><span class="line">    AssertUtil.isEmpty(oldUser, <span class="string">&quot;名字已经被抢占了，请换一个哦~~&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//判断用户有没有改名机会，如果有改名机会则会返回一个UserBackpack 如果没有则会返回null</span></span><br><span class="line">    <span class="type">UserBackpack</span> <span class="variable">firstValidItem</span> <span class="operator">=</span> userBackpackDao.getFirstValidItem(uid, ItemEnum.MODIFY_NAME_CARD.getId());</span><br><span class="line">    <span class="comment">//如果没有改名卡则抛出异常</span></span><br><span class="line">    AssertUtil.isNotEmpty(firstValidItem, <span class="string">&quot;改名次数不够了，等后续活动送改名卡哦&quot;</span>);</span><br><span class="line">   </span><br><span class="line">    <span class="comment">//走到这里用户可以改名，然后判断有没有使用改名卡</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">useSuccess</span> <span class="operator">=</span> userBackpackDao.invalidItem(firstValidItem.getId());</span><br><span class="line">    <span class="comment">//采用乐观锁判断改名卡使用是否成功</span></span><br><span class="line">    <span class="keyword">if</span> (useSuccess) &#123;</span><br><span class="line">        <span class="comment">//如果用户改名成功，则进入条件判断中</span></span><br><span class="line">        <span class="comment">//改名</span></span><br><span class="line">        userDao.modifyName(uid, req.getName());</span><br><span class="line">       </span><br><span class="line">        <span class="comment">//调用userInfoChange(uid) 删除缓存中用户信息并更新缓存数据物品使用信息</span></span><br><span class="line">        userCache.userInfoChange(uid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="getFirstValidItem"   >
          <a href="#getFirstValidItem" class="heading-link"><i class="fas fa-link"></i></a><a href="#getFirstValidItem" class="headerlink" title="getFirstValidItem"></a>getFirstValidItem</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> UserBackpack <span class="title function_">getFirstValidItem</span><span class="params">(Long uid, Long itemId)</span> &#123;</span><br><span class="line">    	<span class="comment">//调用LambdaQueryWrapper可以使用匿名类和lambda表达式进行查询条件的拼接</span></span><br><span class="line">    </span><br><span class="line">    	<span class="comment">//SELECT id,uid,item_id,status,idempotent,create_time,update_time FROM user_backpack </span></span><br><span class="line">    	<span class="comment">//WHERE (uid = ? AND item_id = ? AND status = ?) limit 1	</span></span><br><span class="line">    	<span class="comment">//参数:10004(Long), 1(Long), 0(Integer)  </span></span><br><span class="line"> </span><br><span class="line">        LambdaQueryWrapper&lt;UserBackpack&gt; wrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;UserBackpack&gt;().lambda()</span><br><span class="line">                .eq(UserBackpack::getUid, uid)   <span class="comment">//限制uid相等</span></span><br><span class="line">                .eq(UserBackpack::getItemId, itemId)  <span class="comment">//限制itemId相等</span></span><br><span class="line">                .eq(UserBackpack::getStatus, YesOrNoEnum.NO.getStatus())  <span class="comment">//限制物品使用情况，0即未使用</span></span><br><span class="line">                .last(<span class="string">&quot;limit 1&quot;</span>);  <span class="comment">//只能返回一个</span></span><br><span class="line">    </span><br><span class="line">    	<span class="comment">//返回一条查询结果</span></span><br><span class="line">        <span class="keyword">return</span> getOne(wrapper);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="invaldItem"   >
          <a href="#invaldItem" class="heading-link"><i class="fas fa-link"></i></a><a href="#invaldItem" class="headerlink" title="invaldItem"></a>invaldItem</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">invalidItem</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">		<span class="comment">//使用改名卡,修改用户物品信息表</span></span><br><span class="line">        <span class="type">UserBackpack</span> <span class="variable">update</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserBackpack</span>();</span><br><span class="line">        update.setId(id);</span><br><span class="line">        update.setStatus(YesOrNoEnum.YES.getStatus());</span><br><span class="line">    </span><br><span class="line">    	<span class="comment">//UPDATE user_backpack SET status=? WHERE id=?</span></span><br><span class="line">    	<span class="comment">//参数：1(Integer), 2(Long)</span></span><br><span class="line">    	<span class="comment">//更新用户物品使用表，如果更新成功则返回true,如果更新失败则返回false</span></span><br><span class="line">        <span class="keyword">return</span> updateById(update);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="ModifyName"   >
          <a href="#ModifyName" class="heading-link"><i class="fas fa-link"></i></a><a href="#ModifyName" class="headerlink" title="ModifyName"></a>ModifyName</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">modifyName</span><span class="params">(Long uid, String name)</span> &#123;</span><br><span class="line">    	<span class="comment">//更新用户表，用户使用了改名卡修改名字</span></span><br><span class="line">    	<span class="type">User</span> <span class="variable">update</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        update.setId(uid);</span><br><span class="line">        update.setName(name);</span><br><span class="line">    	</span><br><span class="line">    	<span class="comment">//更新用户信息</span></span><br><span class="line">    	<span class="comment">//UPDATE user SET name=? WHERE id=?</span></span><br><span class="line">    	<span class="comment">//参数：鱼鱼(String), 10004(Long)</span></span><br><span class="line">        updateById(update);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="userInfoChange"   >
          <a href="#userInfoChange" class="heading-link"><i class="fas fa-link"></i></a><a href="#userInfoChange" class="headerlink" title="userInfoChange"></a>userInfoChange</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">userInfoChange</span><span class="params">(Long uid)</span> &#123;</span><br><span class="line">    	<span class="comment">//删除用户缓存</span></span><br><span class="line">        delUserInfo(uid);</span><br><span class="line">    	<span class="comment">//更新缓存中用户物品使用时间</span></span><br><span class="line">        refreshUserModifyTime(uid);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="流程-1"   >
          <a href="#流程-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#流程-1" class="headerlink" title="流程"></a>流程</h4>
      <p>①调用Controller来处理改名请求，Controller调用service来进行改名操作</p>
<p>②判断用户名是否合法、用户名是否被占用、是否有改名次数，如果都有则进入改名阶段,如果有其一没有则抛出异常</p>
<p>③改名，先修改改名卡使用情况，如果修改成功则代表着改名成功，如果修改失败则说明有线程竞争</p>
<p>④改名成功，删除缓存中用户信息，缓存添加修改使用物品时间</p>

        <h3 id="可选勋章预览"   >
          <a href="#可选勋章预览" class="heading-link"><i class="fas fa-link"></i></a><a href="#可选勋章预览" class="headerlink" title="可选勋章预览"></a>可选勋章预览</h3>
      <div class="table-container"><table>
<thead>
<tr>
<th>访问Uri</th>
<th>请求类型</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;capi&#x2F;user&#x2F;badges</td>
<td>GET请求</td>
</tr>
</tbody></table></div>

        <h4 id="Controller层-2"   >
          <a href="#Controller层-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#Controller层-2" class="headerlink" title="Controller层"></a>Controller层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/badges&quot;)</span></span><br><span class="line">   <span class="meta">@ApiOperation(&quot;可选徽章预览&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> ApiResult&lt;List&lt;BadgeResp&gt;&gt; <span class="title function_">badges</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> ApiResult.success(userService.badges(RequestHolder.get().getUid()));</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></div></figure>

<p>调用Service层的badges方法 传入参数是请求中的uid</p>

        <h4 id="Service层"   >
          <a href="#Service层" class="heading-link"><i class="fas fa-link"></i></a><a href="#Service层" class="headerlink" title="Service层"></a>Service层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;BadgeResp&gt; <span class="title function_">badges</span><span class="params">(Long uid)</span>;</span><br></pre></td></tr></table></div></figure>

<p>实现类</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;BadgeResp&gt; <span class="title function_">badges</span><span class="params">(Long uid)</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//查询Cache中勋章列表   参数Type:2 表示勋章</span></span><br><span class="line">    List&lt;ItemConfig&gt; itemConfigs = itemCache.getByType(ItemTypeEnum.BADGE.getType());</span><br><span class="line">  </span><br><span class="line">    <span class="comment">//查询uid下的可用勋章，然后返回一个List&lt;UserBackpack&gt;</span></span><br><span class="line">    List&lt;UserBackpack&gt; backpacks = userBackpackDao.getByItemIds(uid, itemConfigs.stream().map(ItemConfig::getId).collect(Collectors.toList()));</span><br><span class="line">   </span><br><span class="line">    <span class="comment">//根据uid查询用户信息，获取当前用户佩戴的勋章</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userDao.getById(uid);</span><br><span class="line">    <span class="comment">//将总勋章列表、用户可用勋章、当前用户佩戴勋章传入适配器中的buildBadgeResp中，然后返回给前端</span></span><br><span class="line">    <span class="keyword">return</span> UserAdapter.buildBadgeResp(itemConfigs, backpacks, user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="getByType"   >
          <a href="#getByType" class="heading-link"><i class="fas fa-link"></i></a><a href="#getByType" class="headerlink" title="getByType"></a>getByType</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Cacheable(cacheNames = &quot;item&quot;, key = &quot;&#x27;itemsByType:&#x27;+#type&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;ItemConfig&gt; <span class="title function_">getByType</span><span class="params">(Integer type)</span> &#123;</span><br><span class="line">        <span class="comment">//传入参数：2 表示勋章</span></span><br><span class="line">        <span class="comment">//调用itemConfigDao的方法 返回数据 写入缓存中</span></span><br><span class="line">        <span class="keyword">return</span> itemConfigDao.getByType(type);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>

<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;ItemConfig&gt; <span class="title function_">getByType</span><span class="params">(Integer type)</span> &#123;</span><br><span class="line">    <span class="comment">//返回list,list中装着ambdaQuery查询结果</span></span><br><span class="line">    </span><br><span class="line"> 	<span class="comment">//SELECT id,type,img,`describe`,create_time,update_time FROM item_config WHERE (type = ?) </span></span><br><span class="line">    <span class="comment">//限制Type==type,然后转化成list</span></span><br><span class="line">    <span class="keyword">return</span> lambdaQuery().eq(ItemConfig::getType, type).list();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="getByItemId"   >
          <a href="#getByItemId" class="heading-link"><i class="fas fa-link"></i></a><a href="#getByItemId" class="headerlink" title="getByItemId"></a>getByItemId</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;UserBackpack&gt; <span class="title function_">getByItemIds</span><span class="params">(Long uid, List&lt;Long&gt; itemIds)</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//Preparing: SELECT id,uid,item_id,status,idempotent,create_time,update_time </span></span><br><span class="line">    <span class="comment">//FROM user_backpack WHERE (uid = ? AND item_id IN (?,?,?,?,?) AND status = ?)</span></span><br><span class="line">	<span class="comment">//==&gt; Parameters: 10004(Long), 2(Long), 3(Long), 4(Long), 5(Long), 6(Long), 0(Integer)</span></span><br><span class="line">    			<span class="comment">//返回LambdaQuery结果</span></span><br><span class="line">    			<span class="comment">//查询条件限制uid相等</span></span><br><span class="line">    	<span class="keyword">return</span> lambdaQuery().eq(UserBackpack::getUid, uid)</span><br><span class="line">        		<span class="comment">//在总勋章列表中的itemIds</span></span><br><span class="line">                .in(UserBackpack::getItemId, itemIds)</span><br><span class="line">            	<span class="comment">//是否使用勋章</span></span><br><span class="line">                .eq(UserBackpack::getStatus, YesOrNoEnum.NO.getStatus())</span><br><span class="line">                .list();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//这个方法就是判断用户是否有拥有的勋章</span></span><br></pre></td></tr></table></div></figure>


        <h4 id="userDao-getById"   >
          <a href="#userDao-getById" class="heading-link"><i class="fas fa-link"></i></a><a href="#userDao-getById" class="headerlink" title="userDao.getById"></a>userDao.getById</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">default</span> T <span class="title function_">getById</span><span class="params">(Serializable id)</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//SELECT id,name,avatar,sex,open_id,last_opt_time,ip_info,item_id,status,create_time,update_time 			//FROM user WHERE id=?</span></span><br><span class="line">    <span class="comment">//调用mp的方法，查询uid为id的用户信息，获取当前用户佩戴的勋章</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.getBaseMapper().selectById(id);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="buildBadgeResp"   >
          <a href="#buildBadgeResp" class="heading-link"><i class="fas fa-link"></i></a><a href="#buildBadgeResp" class="headerlink" title="buildBadgeResp"></a>buildBadgeResp</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;BadgeResp&gt; <span class="title function_">buildBadgeResp</span><span class="params">(List&lt;ItemConfig&gt; itemConfigs, List&lt;UserBackpack&gt; backpacks, User user)</span> &#123;</span><br><span class="line">    	<span class="comment">//判断user是否为空</span></span><br><span class="line">        <span class="keyword">if</span> (ObjectUtil.isNull(user)) &#123;</span><br><span class="line">            <span class="comment">// 这里 user 入参可能为空，防止 NPE 问题</span></span><br><span class="line">            <span class="comment">//如果为空则返回空集合</span></span><br><span class="line">            <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">        &#125;</span><br><span class="line">	</span><br><span class="line">    	<span class="comment">//将用户的可用勋章方法哦obtianItemSet中</span></span><br><span class="line">        Set&lt;Long&gt; obtainItemSet = 						backpacks.stream().map(UserBackpack::getItemId).collect(Collectors.toSet());</span><br><span class="line">    	<span class="comment">//利用总勋章列表放到流中</span></span><br><span class="line">        <span class="keyword">return</span> itemConfigs.stream().map(a -&gt; &#123;</span><br><span class="line">            <span class="comment">//new一个勋章返回类型</span></span><br><span class="line">            <span class="type">BadgeResp</span> <span class="variable">resp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadgeResp</span>();</span><br><span class="line">            <span class="comment">//将a的属性copy到resp中</span></span><br><span class="line">            BeanUtil.copyProperties(a, resp);</span><br><span class="line">            <span class="comment">//设置勋章ID，为了下一步与用户是否佩戴进行一个比较</span></span><br><span class="line">            resp.setObtain(obtainItemSet.contains(a.getId()) ? YesOrNoEnum.YES.getStatus() : YesOrNoEnum.NO.getStatus());</span><br><span class="line">            <span class="comment">//用户列表中是否有使用这个勋章，如果有则是佩戴勋章</span></span><br><span class="line">            resp.setWearing(ObjectUtil.equal(a.getId(), user.getItemId()) ? YesOrNoEnum.YES.getStatus() : YesOrNoEnum.NO.getStatus());</span><br><span class="line">            <span class="keyword">return</span> resp;</span><br><span class="line">            <span class="comment">//排序</span></span><br><span class="line">        &#125;).sorted(Comparator.comparing(BadgeResp::getWearing, Comparator.reverseOrder())</span><br><span class="line">                .thenComparing(BadgeResp::getObtain, Comparator.reverseOrder()))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="流程-2"   >
          <a href="#流程-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#流程-2" class="headerlink" title="流程"></a>流程</h4>
      <p>①Controller调用Service中的方法，封装成APIResult返回</p>
<p>②Service中先获取总的勋章列表并写入缓存中，其次再获取用户可用的勋章列表，最后获取用户信息来判断佩戴的勋章</p>
<p>③将总勋章列表、可用勋章列表、用户佩戴勋章传入适配器，适配器进行一个buildBadgeResp方法返回前端</p>

        <h3 id="佩戴勋章"   >
          <a href="#佩戴勋章" class="heading-link"><i class="fas fa-link"></i></a><a href="#佩戴勋章" class="headerlink" title="佩戴勋章"></a>佩戴勋章</h3>
      <div class="table-container"><table>
<thead>
<tr>
<th>访问URI</th>
<th>请求类型</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;capi&#x2F;user&#x2F;badge</td>
<td>PUT请求</td>
</tr>
</tbody></table></div>

        <h4 id="Controller层-3"   >
          <a href="#Controller层-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#Controller层-3" class="headerlink" title="Controller层"></a>Controller层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PutMapping(&quot;/badge&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;佩戴徽章&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ApiResult&lt;Void&gt; <span class="title function_">wearingBadge</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> WearingBadgeReq req)</span> &#123;</span><br><span class="line">    userService.wearingBadge(RequestHolder.get().getUid(), req);</span><br><span class="line">    <span class="keyword">return</span> ApiResult.success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>从请求中获取uid和整个请求都传入给userService.wearingBadge</p>

        <h4 id="Service层-1"   >
          <a href="#Service层-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#Service层-1" class="headerlink" title="Service层"></a>Service层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">wearingBadge</span><span class="params">(Long uid, WearingBadgeReq req)</span>;</span><br></pre></td></tr></table></div></figure>

<p>实现类中</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">wearingBadge</span><span class="params">(Long uid, WearingBadgeReq req)</span> &#123;</span><br><span class="line">    <span class="comment">//判断用户是否有这个勋章</span></span><br><span class="line">    <span class="type">UserBackpack</span> <span class="variable">firstValidItem</span> <span class="operator">=</span> userBackpackDao.getFirstValidItem(uid, req.getBadgeId());</span><br><span class="line">    <span class="comment">//如果没有勋章则会返回为null，为null则抛出异常</span></span><br><span class="line">    AssertUtil.isNotEmpty(firstValidItem, <span class="string">&quot;您没有这个徽章哦，快去达成条件获取吧&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//判断这个是不是勋章</span></span><br><span class="line">    <span class="type">ItemConfig</span> <span class="variable">itemConfig</span> <span class="operator">=</span> itemConfigDao.getById(firstValidItem.getItemId());</span><br><span class="line">    <span class="comment">//如果返回字段中类型不是勋章则会抛出异常</span></span><br><span class="line">    AssertUtil.equal(itemConfig.getType(), ItemTypeEnum.BADGE.getType(), <span class="string">&quot;该徽章不可佩戴&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//佩戴勋章 更新用户表</span></span><br><span class="line">    userDao.wearingBadge(uid, req.getBadgeId());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    userCache.userInfoChange(uid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>先调用getFirstValidItem方法 这里和使用改名卡那个方法是同一个，意义是确认是否拥有这个勋章如果有则会返回一条数据，如果没有则返回null</p>

        <h4 id="getFirstValidItem-1"   >
          <a href="#getFirstValidItem-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#getFirstValidItem-1" class="headerlink" title="getFirstValidItem"></a>getFirstValidItem</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> UserBackpack <span class="title function_">getFirstValidItem</span><span class="params">(Long uid, Long itemId)</span> &#123;</span><br><span class="line">    	<span class="comment">//调用LambdaQueryWrapper可以使用匿名类和lambda表达式进行查询条件的拼接</span></span><br><span class="line">    </span><br><span class="line">    	<span class="comment">//SELECT id,uid,item_id,status,idempotent,create_time,update_time FROM user_backpack </span></span><br><span class="line">    	<span class="comment">//WHERE (uid = ? AND item_id = ? AND status = ?) limit 1	</span></span><br><span class="line">    	<span class="comment">//参数:10004(Long), 2(Long), 0(Integer)  -0表示没有使用过 -1表示使用过  </span></span><br><span class="line"> </span><br><span class="line">        LambdaQueryWrapper&lt;UserBackpack&gt; wrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;UserBackpack&gt;().lambda()</span><br><span class="line">                .eq(UserBackpack::getUid, uid)   <span class="comment">//限制uid相等</span></span><br><span class="line">                .eq(UserBackpack::getItemId, itemId)  <span class="comment">//限制itemId相等</span></span><br><span class="line">                .eq(UserBackpack::getStatus, YesOrNoEnum.NO.getStatus())  <span class="comment">//限制物品使用情况，0即未使用</span></span><br><span class="line">                .last(<span class="string">&quot;limit 1&quot;</span>);  <span class="comment">//只能返回一个</span></span><br><span class="line">    </span><br><span class="line">    	<span class="comment">//返回一条查询结果</span></span><br><span class="line">        <span class="keyword">return</span> getOne(wrapper);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="itemConfigDao-getById"   >
          <a href="#itemConfigDao-getById" class="heading-link"><i class="fas fa-link"></i></a><a href="#itemConfigDao-getById" class="headerlink" title="itemConfigDao.getById"></a>itemConfigDao.getById</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//SELECT id,type,img,`describe`,create_time,update_time FROM item_config WHERE id=?</span></span><br><span class="line"><span class="comment">//Parameters: 2(Long)</span></span><br></pre></td></tr></table></div></figure>

<p>判断这个物品是不是勋章 ，查询结果会包含一个type字段，通过字段来判断是不是勋章</p>

        <h4 id="wearingBadge"   >
          <a href="#wearingBadge" class="heading-link"><i class="fas fa-link"></i></a><a href="#wearingBadge" class="headerlink" title="wearingBadge"></a>wearingBadge</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">wearingBadge</span><span class="params">(Long uid, Long badgeId)</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">update</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    <span class="comment">//设置Uid</span></span><br><span class="line">    update.setId(uid);</span><br><span class="line">    <span class="comment">//设置使用物品类型  即勋章类型</span></span><br><span class="line">    update.setItemId(badgeId);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//==&gt;  Preparing: UPDATE user SET item_id=? WHERE id=?</span></span><br><span class="line">	<span class="comment">//==&gt; Parameters: 2(Long), 10004(Long)</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//更新user表</span></span><br><span class="line">    updateById(update);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="userInfoChange-1"   >
          <a href="#userInfoChange-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#userInfoChange-1" class="headerlink" title="userInfoChange"></a>userInfoChange</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">userInfoChange</span><span class="params">(Long uid)</span> &#123;</span><br><span class="line">    	<span class="comment">//删除用户缓存</span></span><br><span class="line">        delUserInfo(uid);</span><br><span class="line">    	<span class="comment">//更新缓存中用户物品使用时间</span></span><br><span class="line">        refreshUserModifyTime(uid);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="流程-3"   >
          <a href="#流程-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#流程-3" class="headerlink" title="流程"></a>流程</h4>
      <p>①先判断用户是否有这个物品。如果没有会抛出异常</p>
<p>②判断在合格物品是不是勋章。如果不是会抛出异常</p>
<p>③更新用户表信息，将Item_id设置为这个物品</p>
<p>④更新缓存，删除本地缓存删除Redis缓存</p>

        <h3 id="黑名单"   >
          <a href="#黑名单" class="heading-link"><i class="fas fa-link"></i></a><a href="#黑名单" class="headerlink" title="黑名单"></a>黑名单</h3>
      <div class="table-container"><table>
<thead>
<tr>
<th>访问URI</th>
<th>请求类型</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;capi&#x2F;user&#x2F;black</td>
<td>PUT请求</td>
</tr>
</tbody></table></div>

        <h4 id="Controller层-4"   >
          <a href="#Controller层-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#Controller层-4" class="headerlink" title="Controller层"></a>Controller层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PutMapping(&quot;/black&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;拉黑用户&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ApiResult&lt;Void&gt; <span class="title function_">black</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> BlackReq req)</span> &#123;</span><br><span class="line">    <span class="comment">//从请求上下文中获取拉黑用户uid</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">uid</span> <span class="operator">=</span> RequestHolder.get().getUid();</span><br><span class="line">    <span class="comment">//判断拉黑目标用户是否是管理员，如果是管理员返回true</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">hasPower</span> <span class="operator">=</span> iRoleService.hasPower(uid, RoleEnum.ADMIN);</span><br><span class="line">    <span class="comment">//如果是管理员则抛出异常没有权限拉黑</span></span><br><span class="line">    AssertUtil.isTrue(hasPower, <span class="string">&quot;没有权限&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//没有异常则可以运行到这里 说明有权限 调用Service方法来拉黑用户</span></span><br><span class="line">    userService.black(req);</span><br><span class="line">    <span class="keyword">return</span> ApiResult.success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="Service层-2"   >
          <a href="#Service层-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#Service层-2" class="headerlink" title="Service层"></a>Service层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">black</span><span class="params">(BlackReq req)</span>;</span><br></pre></td></tr></table></div></figure>

<p>实现类中</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">black</span><span class="params">(BlackReq req)</span> &#123;</span><br><span class="line">    <span class="comment">//从请求上下文中获取要拉黑用户Uid</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">uid</span> <span class="operator">=</span> req.getUid();</span><br><span class="line">    <span class="comment">//创建一个黑名单用户</span></span><br><span class="line">    <span class="type">Black</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Black</span>();</span><br><span class="line">    <span class="comment">//设置拉黑用户UID、拉黑类型为UID  还有一种拉黑是拉黑IP地址</span></span><br><span class="line">    user.setTarget(uid.toString());</span><br><span class="line">    user.setType(BlackTypeEnum.UID.getType());</span><br><span class="line">    <span class="comment">//调用blackDao中的save方法 插入一条用户数据到User表中</span></span><br><span class="line">    </span><br><span class="line">    blackDao.save(user);</span><br><span class="line">    <span class="comment">//查询用户表中的UID用户 </span></span><br><span class="line">    <span class="type">User</span> <span class="variable">byId</span> <span class="operator">=</span> userDao.getById(uid);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//拉黑IP地址 一个是创建用户IP地址 一个是最后更新用户的IP地址 两个IP都拉黑</span></span><br><span class="line">    blackIp(byId.getIpInfo().getCreateIp());</span><br><span class="line">    blackIp(byId.getIpInfo().getUpdateIp());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//发布一条事件 一个用户拉黑事件</span></span><br><span class="line">    applicationEventPublisher.publishEvent(<span class="keyword">new</span> <span class="title class_">UserBlackEvent</span>(<span class="built_in">this</span>, byId));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h4 id="blackIp"   >
          <a href="#blackIp" class="heading-link"><i class="fas fa-link"></i></a><a href="#blackIp" class="headerlink" title="blackIp"></a>blackIp</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">blackIp</span><span class="params">(String ip)</span> &#123;</span><br><span class="line">    <span class="comment">//判断IP是否为空，如果为空则直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isBlank(ip)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//创建一个拉黑用户</span></span><br><span class="line">        <span class="type">Black</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Black</span>();</span><br><span class="line">        <span class="comment">//设置IP地址</span></span><br><span class="line">        user.setTarget(ip);</span><br><span class="line">        user.setType(BlackTypeEnum.IP.getType());</span><br><span class="line">        <span class="comment">//更新黑名单表</span></span><br><span class="line">        blackDao.save(user);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;duplicate black ip:&#123;&#125;&quot;</span>, ip);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="hasPower"   >
          <a href="#hasPower" class="heading-link"><i class="fas fa-link"></i></a><a href="#hasPower" class="headerlink" title="hasPower"></a>hasPower</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasPower</span><span class="params">(Long uid, RoleEnum roleEnum)</span> &#123;<span class="comment">//超级管理员无敌的好吧，后期做成权限=》资源模式</span></span><br><span class="line">    Set&lt;Long&gt; roleSet = userCache.getRoleSet(uid);</span><br><span class="line">    <span class="keyword">return</span> isAdmin(roleSet) || roleSet.contains(roleEnum.getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="getRoleSet"   >
          <a href="#getRoleSet" class="heading-link"><i class="fas fa-link"></i></a><a href="#getRoleSet" class="headerlink" title="getRoleSet"></a>getRoleSet</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Cacheable(cacheNames = &quot;user&quot;, key = &quot;&#x27;roles&#x27;+#uid&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Set&lt;Long&gt; <span class="title function_">getRoleSet</span><span class="params">(Long uid)</span> &#123;</span><br><span class="line">    <span class="comment">//查询数据库判断是否有管理员身份</span></span><br><span class="line">    List&lt;UserRole&gt; userRoles = userRoleDao.listByUid(uid);</span><br><span class="line">    <span class="comment">//将用户身份返回一个set</span></span><br><span class="line">    <span class="keyword">return</span> userRoles.stream()</span><br><span class="line">            .map(UserRole::getRoleId)</span><br><span class="line">            .collect(Collectors.toSet());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="listByUid"   >
          <a href="#listByUid" class="heading-link"><i class="fas fa-link"></i></a><a href="#listByUid" class="headerlink" title="listByUid"></a>listByUid</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;UserRole&gt; <span class="title function_">listByUid</span><span class="params">(Long uid)</span> &#123;</span><br><span class="line">    <span class="comment">//查询user_role表 通过uid来查询身份 返回集合</span></span><br><span class="line">    <span class="keyword">return</span> lambdaQuery()</span><br><span class="line">            .eq(UserRole::getUid, Objects.requireNonNull(uid))</span><br><span class="line">            .list();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="流程-4"   >
          <a href="#流程-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#流程-4" class="headerlink" title="流程"></a>流程</h4>
      <p>①判断目标拉黑用户是否是管理员，如果是管理员则没有权限拉黑抛出异常结束方法，如果不是管理员则继续拉黑操作</p>
<p>②插入一条拉黑用户信息到拉黑数据表中 先是拉黑UID</p>
<p>③再判断创造用户时IP是否存在，如果存在则插入一条创建IP地址的拉黑用户信息</p>
<p>④再判断更新用户时IP是否存在，如果存在则插入一条更新IP地址的拉黑用户信息</p>
<p>⑤发布一条事件，用户拉黑事件</p>

        <h3 id="徽章聚合信息"   >
          <a href="#徽章聚合信息" class="heading-link"><i class="fas fa-link"></i></a><a href="#徽章聚合信息" class="headerlink" title="徽章聚合信息"></a>徽章聚合信息</h3>
      <div class="table-container"><table>
<thead>
<tr>
<th>访问URI</th>
<th>请求类型</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;capi&#x2F;user&#x2F;public&#x2F;badges&#x2F;batch</td>
<td>POST请求</td>
</tr>
</tbody></table></div>

        <h4 id="Controller层-5"   >
          <a href="#Controller层-5" class="heading-link"><i class="fas fa-link"></i></a><a href="#Controller层-5" class="headerlink" title="Controller层"></a>Controller层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/public/badges/batch&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;徽章聚合信息-返回的代表需要刷新的&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ApiResult&lt;List&lt;ItemInfoDTO&gt;&gt; <span class="title function_">getItemInfo</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> ItemInfoReq req)</span> &#123;</span><br><span class="line">    <span class="comment">//调用service层中的getItemInfo方法</span></span><br><span class="line">    <span class="keyword">return</span> ApiResult.success(userService.getItemInfo(req));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="Service层-3"   >
          <a href="#Service层-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#Service层-3" class="headerlink" title="Service层"></a>Service层</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;ItemInfoDTO&gt; <span class="title function_">getItemInfo</span><span class="params">(ItemInfoReq req)</span>;</span><br></pre></td></tr></table></div></figure>

<p>实现类中</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;ItemInfoDTO&gt; <span class="title function_">getItemInfo</span><span class="params">(ItemInfoReq req)</span> &#123;<span class="comment">//简单做，更新时间可判断被修改</span></span><br><span class="line">    <span class="keyword">return</span> req.getReqList().stream().map(a -&gt; &#123;</span><br><span class="line">        <span class="comment">//查询</span></span><br><span class="line">        <span class="type">ItemConfig</span> <span class="variable">itemConfig</span> <span class="operator">=</span> itemCache.getById(a.getItemId());</span><br><span class="line">        <span class="keyword">if</span> (Objects.nonNull(a.getLastModifyTime()) &amp;&amp; a.getLastModifyTime() &gt;= itemConfig.getUpdateTime().getTime()) &#123;</span><br><span class="line">            <span class="keyword">return</span> ItemInfoDTO.skip(a.getItemId());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">ItemInfoDTO</span> <span class="variable">dto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ItemInfoDTO</span>();</span><br><span class="line">        dto.setItemId(itemConfig.getId());</span><br><span class="line">        dto.setImg(itemConfig.getImg());</span><br><span class="line">        dto.setDescribe(itemConfig.getDescribe());</span><br><span class="line">        <span class="keyword">return</span> dto;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h3 id="用户聚合信息"   >
          <a href="#用户聚合信息" class="heading-link"><i class="fas fa-link"></i></a><a href="#用户聚合信息" class="headerlink" title="用户聚合信息"></a>用户聚合信息</h3>
      <div class="table-container"><table>
<thead>
<tr>
<th>访问URI</th>
<th>请求类型</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;public&#x2F;summary&#x2F;userInfo&#x2F;batc</td>
<td>POST请求</td>
</tr>
</tbody></table></div>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/public/summary/userInfo/batch&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;用户聚合信息-返回的代表需要刷新的&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ApiResult&lt;List&lt;SummeryInfoDTO&gt;&gt; <span class="title function_">getSummeryUserInfo</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> SummeryInfoReq req)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> ApiResult.success(userService.getSummeryUserInfo(req));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>














































































































































































































































































































        <h1 id="异常情况"   >
          <a href="#异常情况" class="heading-link"><i class="fas fa-link"></i></a><a href="#异常情况" class="headerlink" title="异常情况"></a>异常情况</h1>
      <p><strong>打上断点进行调试</strong></p>

        <h2 id="异常在线用户数量，用户已经下线而显示还在线上中"   >
          <a href="#异常在线用户数量，用户已经下线而显示还在线上中" class="heading-link"><i class="fas fa-link"></i></a><a href="#异常在线用户数量，用户已经下线而显示还在线上中" class="headerlink" title="异常在线用户数量，用户已经下线而显示还在线上中"></a>异常在线用户数量，用户已经下线而显示还在线上中</h2>
      
        <h3 id="用户端1"   >
          <a href="#用户端1" class="heading-link"><i class="fas fa-link"></i></a><a href="#用户端1" class="headerlink" title="用户端1"></a>用户端1</h3>
      <p>未登录用户界面</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="/MallChat%E9%A1%B9%E7%9B%AE%E5%88%86%E6%9E%90/image-20230804170246021.png"  alt="用戶端1">
      </p>
<p>浏览器Cache</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="/MallChat%E9%A1%B9%E7%9B%AE%E5%88%86%E6%9E%90/image-20230804170416313.png"  alt="未登录Cache">
      </p>

        <h3 id="用户端2"   >
          <a href="#用户端2" class="heading-link"><i class="fas fa-link"></i></a><a href="#用户端2" class="headerlink" title="用户端2"></a>用户端2</h3>
      <p>已登录用户用户端</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="/MallChat%E9%A1%B9%E7%9B%AE%E5%88%86%E6%9E%90/image-20230804170527319.png"  alt="已登录用户端">
      </p>
<p>浏览器Cache</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="/MallChat%E9%A1%B9%E7%9B%AE%E5%88%86%E6%9E%90/image-20230804170656484.png"  alt="浏览器Cache">
      </p>

        <h3 id="退出用户端2"   >
          <a href="#退出用户端2" class="heading-link"><i class="fas fa-link"></i></a><a href="#退出用户端2" class="headerlink" title="退出用户端2"></a>退出用户端2</h3>
      <p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="/MallChat%E9%A1%B9%E7%9B%AE%E5%88%86%E6%9E%90/image-20230804170829700.png"  alt="退出用户端2">
      </p>
<p>正如用户端1客户端显示一样</p>

        <h2 id="抛出InvalidDataAccessApiUsageException异常"   >
          <a href="#抛出InvalidDataAccessApiUsageException异常" class="heading-link"><i class="fas fa-link"></i></a><a href="#抛出InvalidDataAccessApiUsageException异常" class="headerlink" title="抛出InvalidDataAccessApiUsageException异常"></a>抛出InvalidDataAccessApiUsageException异常</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">JDBC Connection [HikariProxyConnection@<span class="number">2146628671</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@4cd7671d] will not be managed by Spring</span><br><span class="line">==&gt;  Preparing: UPDATE user SET last_opt_time=? WHERE id=?</span><br><span class="line">==&gt; Parameters: <span class="number">2023</span>-<span class="number">07</span>-<span class="number">30</span> <span class="number">17</span>:<span class="number">23</span>:<span class="number">43.267</span>(Timestamp), <span class="number">10003</span>(Long)</span><br><span class="line">|ERROR|<span class="number">2023</span>-<span class="number">07</span>-<span class="number">30</span> <span class="number">17</span>:<span class="number">23</span>:<span class="number">43.274</span>|mallchat-executor-<span class="number">7</span>||uid=|Unexpected exception occurred invoking async method: <span class="keyword">public</span> <span class="keyword">void</span> com.abin.mallchat.custom.common.event.listener.UserOfflineListener.saveRedisAndPush(com.abin.mallchat.common.common.event.UserOfflineEvent)|</span><br><span class="line">org.springframework.dao.InvalidDataAccessApiUsageException: Redisson is shutdown; nested exception is org.redisson.RedissonShutdownException: Redisson is shutdown</span><br><span class="line">	at org.redisson.spring.data.connection.RedissonExceptionConverter.convert(RedissonExceptionConverter.java:<span class="number">52</span>)</span><br><span class="line">	at org.redisson.spring.data.connection.RedissonExceptionConverter.convert(RedissonExceptionConverter.java:<span class="number">35</span>)</span><br><span class="line">	at org.springframework.data.redis.PassThroughExceptionTranslationStrategy.translate(PassThroughExceptionTranslationStrategy.java:<span class="number">44</span>)</span><br><span class="line">	at org.redisson.spring.data.connection.RedissonConnection.transform(RedissonConnection.java:<span class="number">200</span>)</span><br><span class="line">	at org.redisson.spring.data.connection.RedissonConnection.syncFuture(RedissonConnection.java:<span class="number">195</span>)</span><br><span class="line">	at org.redisson.spring.data.connection.RedissonConnection.sync(RedissonConnection.java:<span class="number">364</span>)</span><br><span class="line">	at org.redisson.spring.data.connection.RedissonConnection.write(RedissonConnection.java:<span class="number">730</span>)</span><br><span class="line">	at org.redisson.spring.data.connection.RedissonConnection.zRem(RedissonConnection.java:<span class="number">1021</span>)</span><br><span class="line">	at org.springframework.data.redis.connection.DefaultStringRedisConnection.zRem(DefaultStringRedisConnection.java:<span class="number">1829</span>)</span><br><span class="line">	at org.springframework.data.redis.core.DefaultZSetOperations.lambda$remove$<span class="number">27</span>(DefaultZSetOperations.java:<span class="number">444</span>)</span><br><span class="line">	at org.springframework.data.redis.core.RedisTemplate.execute(RedisTemplate.java:<span class="number">223</span>)</span><br><span class="line">	at org.springframework.data.redis.core.RedisTemplate.execute(RedisTemplate.java:<span class="number">190</span>)</span><br><span class="line">	at org.springframework.data.redis.core.AbstractOperations.execute(AbstractOperations.java:<span class="number">97</span>)</span><br><span class="line">	at org.springframework.data.redis.core.DefaultZSetOperations.remove(DefaultZSetOperations.java:<span class="number">444</span>)</span><br><span class="line">	at com.abin.mallchat.common.common.utils.RedisUtils.zRemove(RedisUtils.java:<span class="number">803</span>)</span><br><span class="line">	at com.abin.mallchat.common.common.utils.RedisUtils.zRemove(RedisUtils.java:<span class="number">799</span>)</span><br><span class="line">	at com.abin.mallchat.common.user.service.cache.UserCache.offline(UserCache.java:<span class="number">85</span>)</span><br><span class="line">	at com.abin.mallchat.common.user.service.cache.UserCache$$FastClassBySpringCGLIB$$4d4b28eb.invoke(&lt;generated&gt;)</span><br><span class="line">	at org.springframework.cglib.proxy.MethodProxy.invoke(MethodProxy.java:<span class="number">218</span>)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy.invokeMethod(CglibAopProxy.java:<span class="number">386</span>)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy.access$<span class="number">000</span>(CglibAopProxy.java:<span class="number">85</span>)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:<span class="number">704</span>)</span><br><span class="line">	at com.abin.mallchat.common.user.service.cache.UserCache$$EnhancerBySpringCGLIB$$6f823fec.offline(&lt;generated&gt;)</span><br><span class="line">	at com.abin.mallchat.custom.common.event.listener.UserOfflineListener.saveRedisAndPush(UserOfflineListener.java:<span class="number">36</span>)</span><br><span class="line">	at com.abin.mallchat.custom.common.event.listener.UserOfflineListener$$FastClassBySpringCGLIB$$c62500f3.invoke(&lt;generated&gt;)</span><br><span class="line">	at org.springframework.cglib.proxy.MethodProxy.invoke(MethodProxy.java:<span class="number">218</span>)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.invokeJoinpoint(CglibAopProxy.java:<span class="number">793</span>)</span><br><span class="line">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:<span class="number">163</span>)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:<span class="number">763</span>)</span><br><span class="line">	at org.springframework.aop.interceptor.AsyncExecutionInterceptor.lambda$invoke$<span class="number">0</span>(AsyncExecutionInterceptor.java:<span class="number">115</span>)</span><br><span class="line">	at java.util.concurrent.FutureTask.run(FutureTask.java:<span class="number">266</span>)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1149</span>)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">624</span>)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:<span class="number">748</span>)</span><br><span class="line">Caused by: org.redisson.RedissonShutdownException: Redisson is shutdown</span><br><span class="line">	at org.redisson.command.RedisExecutor.execute(RedisExecutor.java:<span class="number">118</span>)</span><br><span class="line">	at org.redisson.command.CommandAsyncService.async(CommandAsyncService.java:<span class="number">585</span>)</span><br><span class="line">	at org.redisson.command.CommandAsyncService.writeAsync(CommandAsyncService.java:<span class="number">554</span>)</span><br><span class="line">	at org.redisson.spring.data.connection.RedissonConnection.write(RedissonConnection.java:<span class="number">728</span>)</span><br><span class="line">	... <span class="number">27</span> common frames omitted</span><br><span class="line">&lt;==    Updates: <span class="number">1</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="执行的SQL语句"   >
          <a href="#执行的SQL语句" class="heading-link"><i class="fas fa-link"></i></a><a href="#执行的SQL语句" class="headerlink" title="执行的SQL语句"></a>执行的SQL语句</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">==&gt;Preparing: UPDATE user SET last_opt_time=? WHERE id=?</span><br><span class="line"><span class="comment">//更新user表 更新Last_opt_time(最后上下线时间) where id=?</span></span><br><span class="line">==&gt; Parameters: <span class="number">2023</span>-<span class="number">07</span>-<span class="number">30</span> <span class="number">17</span>:<span class="number">23</span>:<span class="number">43.267</span>(Timestamp), <span class="number">10003</span>(Long) </span><br><span class="line"><span class="comment">//传入时间戳和用户ID</span></span><br><span class="line">    </span><br><span class="line">   </span><br><span class="line"><span class="comment">//报错RedisSon is shutdown;</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">&lt;==    Updates: <span class="number">1</span></span><br><span class="line"><span class="comment">//更新成功</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="异常复现"   >
          <a href="#异常复现" class="heading-link"><i class="fas fa-link"></i></a><a href="#异常复现" class="headerlink" title="异常复现"></a>异常复现</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">==&gt;  Preparing: UPDATE user SET last_opt_time=? WHERE id=?</span><br><span class="line">==&gt; Parameters: <span class="number">2023</span>-<span class="number">07</span>-<span class="number">30</span> <span class="number">17</span>:<span class="number">45</span>:<span class="number">46.053</span>(Timestamp), <span class="number">10003</span>(Long)</span><br><span class="line">|ERROR|<span class="number">2023</span>-<span class="number">07</span>-<span class="number">30</span> <span class="number">17</span>:<span class="number">45</span>:<span class="number">46.061</span>|mallchat-executor-<span class="number">9</span>||uid=|Unexpected exception occurred invoking async method: <span class="keyword">public</span> <span class="keyword">void</span> com.abin.mallchat.custom.common.event.listener.UserOfflineListener.saveRedisAndPush(com.abin.mallchat.common.common.event.UserOfflineEvent)|</span><br><span class="line">org.springframework.dao.InvalidDataAccessApiUsageException: Redisson is shutdown; </span><br><span class="line">....</span><br><span class="line">	... <span class="number">27</span> common frames omitted</span><br><span class="line">&lt;==    Updates: <span class="number">1</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="分析原因"   >
          <a href="#分析原因" class="heading-link"><i class="fas fa-link"></i></a><a href="#分析原因" class="headerlink" title="分析原因"></a>分析原因</h3>
      <p>RedisSon is Shutdown 抛出的异常是因为后端的关闭，导致RedisSon实例关闭</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//抛出异常</span></span><br><span class="line">InvalidDataAccessApiUsageException: Redisson is shutdown; </span><br><span class="line">nested exception is org.redisson.RedissonShutdownException: Redisson is shutdown</span><br><span class="line"></span><br><span class="line"><span class="comment">//表示Redisson已经关闭</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="处理"   >
          <a href="#处理" class="heading-link"><i class="fas fa-link"></i></a><a href="#处理" class="headerlink" title="处理"></a>处理</h3>
      
        <h2 id="空指针异常"   >
          <a href="#空指针异常" class="heading-link"><i class="fas fa-link"></i></a><a href="#空指针异常" class="headerlink" title="空指针异常"></a>空指针异常</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">|ERROR|<span class="number">2023</span>-<span class="number">07</span>-<span class="number">30</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">35.653</span>|http-nio-<span class="number">8080</span>-exec-<span class="number">7</span>|7c7b1d92-b364-4de5-bfe8-7896ec4f2c07|uid=<span class="number">10003</span>|system exception！The reason is：<span class="literal">null</span>|</span><br><span class="line">java.lang.reflect.UndeclaredThrowableException: <span class="literal">null</span></span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:<span class="number">780</span>)</span><br><span class="line">	at org.springframework.aop.aspectj.MethodInvocationProceedingJoinPoint.proceed(MethodInvocationProceedingJoinPoint.java:<span class="number">89</span>)</span><br><span class="line">	at com.abin.mallchat.custom.common.intecepter.WebLogAspect.around(WebLogAspect.java:<span class="number">63</span>)</span><br><span class="line">	at sun.reflect.GeneratedMethodAccessor199.invoke(Unknown Source)</span><br><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:<span class="number">43</span>)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:<span class="number">498</span>)</span><br><span class="line">	at org.springframework.aop.aspectj.AbstractAspectJAdvice.invokeAdviceMethodWithGivenArgs(AbstractAspectJAdvice.java:<span class="number">634</span>)</span><br><span class="line">	at org.springframework.aop.aspectj.AbstractAspectJAdvice.invokeAdviceMethod(AbstractAspectJAdvice.java:<span class="number">624</span>)</span><br><span class="line">	at org.springframework.aop.aspectj.AspectJAroundAdvice.invoke(AspectJAroundAdvice.java:<span class="number">72</span>)</span><br><span class="line">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:<span class="number">186</span>)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:<span class="number">763</span>)</span><br><span class="line">	at org.springframework.aop.interceptor.ExposeInvocationInterceptor.invoke(ExposeInvocationInterceptor.java:<span class="number">97</span>)</span><br><span class="line">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:<span class="number">186</span>)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:<span class="number">763</span>)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:<span class="number">708</span>)</span><br><span class="line">	at com.abin.mallchat.custom.user.controller.OssController$$EnhancerBySpringCGLIB$$94c0c149.getUploadUrl(&lt;generated&gt;)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:<span class="number">62</span>)</span><br><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:<span class="number">43</span>)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:<span class="number">498</span>)</span><br><span class="line">	at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:<span class="number">205</span>)</span><br><span class="line">	at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:<span class="number">150</span>)</span><br><span class="line">	at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:<span class="number">117</span>)</span><br><span class="line">	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:<span class="number">895</span>)</span><br><span class="line">	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:<span class="number">808</span>)</span><br><span class="line">	at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:<span class="number">87</span>)</span><br><span class="line">	at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:<span class="number">1067</span>)</span><br><span class="line">	at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:<span class="number">963</span>)</span><br><span class="line">	at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:<span class="number">1006</span>)</span><br><span class="line">	at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:<span class="number">898</span>)</span><br><span class="line">	at javax.servlet.http.HttpServlet.service(HttpServlet.java:<span class="number">655</span>)</span><br><span class="line">	at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:<span class="number">883</span>)</span><br><span class="line">	at javax.servlet.http.HttpServlet.service(HttpServlet.java:<span class="number">764</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">227</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:<span class="number">53</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at com.abin.mallchat.custom.common.intecepter.HttpTraceIdFilter.doFilter(HttpTraceIdFilter.java:<span class="number">25</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:<span class="number">100</span>)</span><br><span class="line">	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">117</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:<span class="number">93</span>)</span><br><span class="line">	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">117</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at org.springframework.boot.actuate.metrics.web.servlet.WebMvcMetricsFilter.doFilterInternal(WebMvcMetricsFilter.java:<span class="number">96</span>)</span><br><span class="line">	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">117</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:<span class="number">201</span>)</span><br><span class="line">	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">117</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:<span class="number">197</span>)</span><br><span class="line">	at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:<span class="number">97</span>)</span><br><span class="line">	at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:<span class="number">541</span>)</span><br><span class="line">	at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:<span class="number">135</span>)</span><br><span class="line">	at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:<span class="number">92</span>)</span><br><span class="line">	at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:<span class="number">78</span>)</span><br><span class="line">	at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:<span class="number">360</span>)</span><br><span class="line">	at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:<span class="number">399</span>)</span><br><span class="line">	at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:<span class="number">65</span>)</span><br><span class="line">	at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:<span class="number">890</span>)</span><br><span class="line">	at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:<span class="number">1743</span>)</span><br><span class="line">	at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:<span class="number">49</span>)</span><br><span class="line">	at org.apache.tomcat.util.threads.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1191</span>)</span><br><span class="line">	at org.apache.tomcat.util.threads.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">659</span>)</span><br><span class="line">	at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:<span class="number">61</span>)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:<span class="number">748</span>)</span><br><span class="line">Caused by: io.minio.errors.ErrorResponseException: The specified bucket does not exist</span><br><span class="line">	at io.minio.S3Base$<span class="number">1.</span>onResponse(S3Base.java:<span class="number">690</span>)</span><br><span class="line">	at okhttp3.internal.connection.RealCall$AsyncCall.run(RealCall.kt:<span class="number">519</span>)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1149</span>)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">624</span>)</span><br><span class="line">	... <span class="number">1</span> common frames omitted</span><br></pre></td></tr></table></div></figure>


        <h2 id="未知异常"   >
          <a href="#未知异常" class="heading-link"><i class="fas fa-link"></i></a><a href="#未知异常" class="headerlink" title="未知异常"></a>未知异常</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">|ERROR|<span class="number">2023</span>-<span class="number">07</span>-<span class="number">31</span> <span class="number">10</span>:09:<span class="number">45.932</span>|http-nio-<span class="number">8080</span>-exec-<span class="number">10</span>|fa45bbb3-e84d-<span class="number">422f</span>-<span class="number">9053</span>-df13233dae8e|uid=<span class="number">10003</span>|system exception！The reason is：<span class="literal">null</span>|</span><br><span class="line">java.lang.reflect.UndeclaredThrowableException: <span class="literal">null</span></span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:<span class="number">780</span>)</span><br><span class="line">	at org.springframework.aop.aspectj.MethodInvocationProceedingJoinPoint.proceed(MethodInvocationProceedingJoinPoint.java:<span class="number">89</span>)</span><br><span class="line">	at com.abin.mallchat.custom.common.intecepter.WebLogAspect.around(WebLogAspect.java:<span class="number">63</span>)</span><br><span class="line">	at sun.reflect.GeneratedMethodAccessor226.invoke(Unknown Source)</span><br><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:<span class="number">43</span>)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:<span class="number">498</span>)</span><br><span class="line">	at org.springframework.aop.aspectj.AbstractAspectJAdvice.invokeAdviceMethodWithGivenArgs(AbstractAspectJAdvice.java:<span class="number">634</span>)</span><br><span class="line">	at org.springframework.aop.aspectj.AbstractAspectJAdvice.invokeAdviceMethod(AbstractAspectJAdvice.java:<span class="number">624</span>)</span><br><span class="line">	at org.springframework.aop.aspectj.AspectJAroundAdvice.invoke(AspectJAroundAdvice.java:<span class="number">72</span>)</span><br><span class="line">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:<span class="number">186</span>)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:<span class="number">763</span>)</span><br><span class="line">	at org.springframework.aop.interceptor.ExposeInvocationInterceptor.invoke(ExposeInvocationInterceptor.java:<span class="number">97</span>)</span><br><span class="line">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:<span class="number">186</span>)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:<span class="number">763</span>)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:<span class="number">708</span>)</span><br><span class="line">	at com.abin.mallchat.custom.user.controller.OssController$$EnhancerBySpringCGLIB$$94c0c149.getUploadUrl(&lt;generated&gt;)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:<span class="number">62</span>)</span><br><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:<span class="number">43</span>)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:<span class="number">498</span>)</span><br><span class="line">	at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:<span class="number">205</span>)</span><br><span class="line">	at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:<span class="number">150</span>)</span><br><span class="line">	at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:<span class="number">117</span>)</span><br><span class="line">	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:<span class="number">895</span>)</span><br><span class="line">	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:<span class="number">808</span>)</span><br><span class="line">	at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:<span class="number">87</span>)</span><br><span class="line">	at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:<span class="number">1067</span>)</span><br><span class="line">	at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:<span class="number">963</span>)</span><br><span class="line">	at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:<span class="number">1006</span>)</span><br><span class="line">	at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:<span class="number">898</span>)</span><br><span class="line">	at javax.servlet.http.HttpServlet.service(HttpServlet.java:<span class="number">655</span>)</span><br><span class="line">	at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:<span class="number">883</span>)</span><br><span class="line">	at javax.servlet.http.HttpServlet.service(HttpServlet.java:<span class="number">764</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">227</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:<span class="number">53</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at com.abin.mallchat.custom.common.intecepter.HttpTraceIdFilter.doFilter(HttpTraceIdFilter.java:<span class="number">25</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:<span class="number">100</span>)</span><br><span class="line">	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">117</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:<span class="number">93</span>)</span><br><span class="line">	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">117</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at org.springframework.boot.actuate.metrics.web.servlet.WebMvcMetricsFilter.doFilterInternal(WebMvcMetricsFilter.java:<span class="number">96</span>)</span><br><span class="line">	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">117</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:<span class="number">201</span>)</span><br><span class="line">	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">117</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:<span class="number">189</span>)</span><br><span class="line">	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:<span class="number">162</span>)</span><br><span class="line">	at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:<span class="number">197</span>)</span><br><span class="line">	at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:<span class="number">97</span>)</span><br><span class="line">	at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:<span class="number">541</span>)</span><br><span class="line">	at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:<span class="number">135</span>)</span><br><span class="line">	at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:<span class="number">92</span>)</span><br><span class="line">	at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:<span class="number">78</span>)</span><br><span class="line">	at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:<span class="number">360</span>)</span><br><span class="line">	at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:<span class="number">399</span>)</span><br><span class="line">	at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:<span class="number">65</span>)</span><br><span class="line">	at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:<span class="number">890</span>)</span><br><span class="line">	at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:<span class="number">1743</span>)</span><br><span class="line">	at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:<span class="number">49</span>)</span><br><span class="line">	at org.apache.tomcat.util.threads.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1191</span>)</span><br><span class="line">	at org.apache.tomcat.util.threads.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">659</span>)</span><br><span class="line">	at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:<span class="number">61</span>)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:<span class="number">748</span>)</span><br><span class="line">Caused by: java.net.ConnectException: Failed to connect to /<span class="number">192.168</span><span class="number">.88</span><span class="number">.127</span>:<span class="number">9000</span></span><br><span class="line">	at okhttp3.internal.connection.RealConnection.connectSocket(RealConnection.kt:<span class="number">297</span>)</span><br><span class="line">	at okhttp3.internal.connection.RealConnection.connect(RealConnection.kt:<span class="number">207</span>)</span><br><span class="line">	at okhttp3.internal.connection.ExchangeFinder.findConnection(ExchangeFinder.kt:<span class="number">226</span>)</span><br><span class="line">	at okhttp3.internal.connection.ExchangeFinder.findHealthyConnection(ExchangeFinder.kt:<span class="number">106</span>)</span><br><span class="line">	at okhttp3.internal.connection.ExchangeFinder.find(ExchangeFinder.kt:<span class="number">74</span>)</span><br><span class="line">	at okhttp3.internal.connection.RealCall.initExchange$okhttp(RealCall.kt:<span class="number">255</span>)</span><br><span class="line">	at okhttp3.internal.connection.ConnectInterceptor.intercept(ConnectInterceptor.kt:<span class="number">32</span>)</span><br><span class="line">	at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.kt:<span class="number">109</span>)</span><br><span class="line">	at okhttp3.internal.cache.CacheInterceptor.intercept(CacheInterceptor.kt:<span class="number">95</span>)</span><br><span class="line">	at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.kt:<span class="number">109</span>)</span><br><span class="line">	at okhttp3.internal.http.BridgeInterceptor.intercept(BridgeInterceptor.kt:<span class="number">83</span>)</span><br><span class="line">	at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.kt:<span class="number">109</span>)</span><br><span class="line">	at okhttp3.internal.http.RetryAndFollowUpInterceptor.intercept(RetryAndFollowUpInterceptor.kt:<span class="number">76</span>)</span><br><span class="line">	at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.kt:<span class="number">109</span>)</span><br><span class="line">	at okhttp3.internal.connection.RealCall.getResponseWithInterceptorChain$okhttp(RealCall.kt:<span class="number">201</span>)</span><br><span class="line">	at okhttp3.internal.connection.RealCall$AsyncCall.run(RealCall.kt:<span class="number">517</span>)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1149</span>)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">624</span>)</span><br><span class="line">	... <span class="number">1</span> common frames omitted</span><br><span class="line">Caused by: java.net.ConnectException: Connection refused: connect</span><br><span class="line">	at java.net.DualStackPlainSocketImpl.waitForConnect(Native Method)</span><br><span class="line">	at java.net.DualStackPlainSocketImpl.socketConnect(DualStackPlainSocketImpl.java:<span class="number">81</span>)</span><br><span class="line">	at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:<span class="number">476</span>)</span><br><span class="line">	at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:<span class="number">218</span>)</span><br><span class="line">	at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:<span class="number">200</span>)</span><br><span class="line">	at java.net.PlainSocketImpl.connect(PlainSocketImpl.java:<span class="number">162</span>)</span><br><span class="line">	at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:<span class="number">394</span>)</span><br><span class="line">	at java.net.Socket.connect(Socket.java:<span class="number">606</span>)</span><br><span class="line">	at okhttp3.internal.platform.Platform.connectSocket(Platform.kt:<span class="number">120</span>)</span><br><span class="line">	at okhttp3.internal.connection.RealConnection.connectSocket(RealConnection.kt:<span class="number">295</span>)</span><br><span class="line">	... <span class="number">18</span> common frames omitted</span><br></pre></td></tr></table></div></figure>

</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/07/27/SpringCloud%E9%9D%A2%E8%AF%95%E9%A2%98/">SpringCloud面试题</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-07-27</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">57</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">1分</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="SpringCloud常见组件有哪些"   >
          <a href="#SpringCloud常见组件有哪些" class="heading-link"><i class="fas fa-link"></i></a><a href="#SpringCloud常见组件有哪些" class="headerlink" title="SpringCloud常见组件有哪些?"></a>SpringCloud常见组件有哪些?</h1>
      
        <h1 id="Nacos的服务注册表结构是怎么样的？"   >
          <a href="#Nacos的服务注册表结构是怎么样的？" class="heading-link"><i class="fas fa-link"></i></a><a href="#Nacos的服务注册表结构是怎么样的？" class="headerlink" title="Nacos的服务注册表结构是怎么样的？"></a>Nacos的服务注册表结构是怎么样的？</h1>
      
        <h1 id="Nacos如何支撑数十万服务注册压力？"   >
          <a href="#Nacos如何支撑数十万服务注册压力？" class="heading-link"><i class="fas fa-link"></i></a><a href="#Nacos如何支撑数十万服务注册压力？" class="headerlink" title="Nacos如何支撑数十万服务注册压力？"></a>Nacos如何支撑数十万服务注册压力？</h1>
      
        <h1 id="Nacos如何避免读写并发冲突问题？"   >
          <a href="#Nacos如何避免读写并发冲突问题？" class="heading-link"><i class="fas fa-link"></i></a><a href="#Nacos如何避免读写并发冲突问题？" class="headerlink" title="Nacos如何避免读写并发冲突问题？"></a>Nacos如何避免读写并发冲突问题？</h1>
      
        <h1 id="Nacos和Eureka的区别有哪些？"   >
          <a href="#Nacos和Eureka的区别有哪些？" class="heading-link"><i class="fas fa-link"></i></a><a href="#Nacos和Eureka的区别有哪些？" class="headerlink" title="Nacos和Eureka的区别有哪些？"></a>Nacos和Eureka的区别有哪些？</h1>
      </div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/07/27/Sentinel-SpringCloud%E7%AF%87/">Sentinel-[SpringCloud篇]</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-07-27</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">0</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">1分</span></span></div></header><div class="post-body"><div class="post-excerpt"></div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/07/27/Nacos-SpringCloud%E7%AF%87/">Nacos-[SpringCloud篇]</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-07-27</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">752</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">6分</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="准备工作"   >
          <a href="#准备工作" class="heading-link"><i class="fas fa-link"></i></a><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1>
      <p>想要解析Nacos首先得把Nacos源码下载下来，这自然是第一，再是尝试在本地启动Nacos源码</p>

        <h2 id="Proto编译"   >
          <a href="#Proto编译" class="heading-link"><i class="fas fa-link"></i></a><a href="#Proto编译" class="headerlink" title="Proto编译"></a>Proto编译</h2>
      <p>因为nacos会按照Protobuf对数据做序列化和反序列化处理，这也是nacos能在多个平台运行的原因，正因为数据按照protobuf序列化了才会不同的语言才能运行</p>
<p>我们要将proto文件编译成java文件</p>

        <h3 id="protobuf"   >
          <a href="#protobuf" class="heading-link"><i class="fas fa-link"></i></a><a href="#protobuf" class="headerlink" title="protobuf"></a>protobuf</h3>
      <p>protobuf是Google公司提出的一种轻便高效的结构化数据存储格式，常用于结构化数据的序列化，具有语言无关、平台无关、可扩展性特性，常用于通讯协议、服务端数据交换场景</p>
<p>类似Json也是一种结构化存储格式</p>

        <h3 id="安装protoc"   >
          <a href="#安装protoc" class="heading-link"><i class="fas fa-link"></i></a><a href="#安装protoc" class="headerlink" title="安装protoc"></a>安装protoc</h3>
      <p><strong>接下来我们要参考nacos的官网手册来对Nacos的服务注册、服务发现、心跳检测进行分析</strong></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://nacos.io/zh-cn/docs/open-api.html" >Nacos Open API</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h1 id="Nacos服务注册"   >
          <a href="#Nacos服务注册" class="heading-link"><i class="fas fa-link"></i></a><a href="#Nacos服务注册" class="headerlink" title="Nacos服务注册"></a>Nacos服务注册</h1>
      
        <h2 id="客户端"   >
          <a href="#客户端" class="heading-link"><i class="fas fa-link"></i></a><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h2>
      
        <h2 id="服务端"   >
          <a href="#服务端" class="heading-link"><i class="fas fa-link"></i></a><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h2>
      <p>对照Nacos Open API找到服务端服务注册</p>
<div class="table-container"><table>
<thead>
<tr>
<th>服务注册</th>
<th>请求路径</th>
</tr>
</thead>
<tbody><tr>
<td>POST请求</td>
<td>&#x2F;nacos&#x2F;v1&#x2F;ns&#x2F;instance</td>
</tr>
</tbody></table></div>
<p>通过UtilsAndCommons类找到</p>
<div class="table-container"><table>
<thead>
<tr>
<th>路径</th>
<th>常量</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;nacos</td>
<td>NACOS_SERVER_CONTEXT</td>
</tr>
<tr>
<td>&#x2F;v1</td>
<td>NACOS_SERVER_VERSION</td>
</tr>
<tr>
<td>&#x2F;v1&#x2F;ns</td>
<td>DEFAULT_NACOS_NAMING_CONTEXT &#x3D; NACOS_SERVER_VERSION+ “&#x2F;ns”</td>
</tr>
</tbody></table></div>
<p>所以&#x2F;nacos&#x2F;v1&#x2F;ns就是NACOS_SERVER_CONTEXT +   DEFAULT_NACOS_NAMING_CONTEXT </p>
<p>我们的目标就是找到这个路径对应的Controller</p>

        <h3 id="InstanceController"   >
          <a href="#InstanceController" class="heading-link"><i class="fas fa-link"></i></a><a href="#InstanceController" class="headerlink" title="InstanceController"></a>InstanceController</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(UtilsAndCommons.NACOS_NAMING_CONTEXT + UtilsAndCommons.NACOS_NAMING_INSTANCE_CONTEXT)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InstanceController</span> &#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>从InstanceController找到Post请求对应的方法</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CanDistro</span></span><br><span class="line">   <span class="meta">@PostMapping</span></span><br><span class="line">   <span class="meta">@Secured(action = ActionTypes.WRITE)</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">register</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">       </span><br><span class="line">       <span class="comment">//获取命名空间 namespaceId</span></span><br><span class="line">       <span class="keyword">final</span> <span class="type">String</span> <span class="variable">namespaceId</span> <span class="operator">=</span> WebUtils</span><br><span class="line">               .optional(request, CommonParams.NAMESPACE_ID, Constants.DEFAULT_NAMESPACE_ID);</span><br><span class="line">      	</span><br><span class="line">       <span class="comment">//获取服务名称 servicename</span></span><br><span class="line">       <span class="keyword">final</span> <span class="type">String</span> <span class="variable">serviceName</span> <span class="operator">=</span> WebUtils.required(request, CommonParams.SERVICE_NAME);</span><br><span class="line">       <span class="comment">//对seviceName做一个格式化检查</span></span><br><span class="line">       NamingUtils.checkServiceNameFormat(serviceName);</span><br><span class="line">       </span><br><span class="line">       <span class="comment">//创建一个实例对象，链式编程 创建一个实例(通过SwitchDomain.isDefaultInstanceEphemeral()判断是否是临时实例)</span></span><br><span class="line">       <span class="keyword">final</span> <span class="type">Instance</span> <span class="variable">instance</span> <span class="operator">=</span> HttpRequestInstanceBuilder.newBuilder()</span><br><span class="line">               .setDefaultInstanceEphemeral(switchDomain.isDefaultInstanceEphemeral()).setRequest(request).build();</span><br><span class="line">       <span class="comment">//上面创建一个临时实例或者是一个永久实例</span></span><br><span class="line">       </span><br><span class="line">       <span class="comment">//调用getInstanceOperator.reregisterInstance方法注册实例  传入命名空间、服务名称、实例对象</span></span><br><span class="line">       getInstanceOperator().registerInstance(namespaceId, serviceName, instance);</span><br><span class="line">       </span><br><span class="line">       <span class="comment">//发布一个事务 当前已经注册了实例</span></span><br><span class="line">       <span class="comment">//传入参数</span></span><br><span class="line">       NotifyCenter.publishEvent(<span class="keyword">new</span> <span class="title class_">RegisterInstanceTraceEvent</span>(System.currentTimeMillis(), <span class="string">&quot;&quot;</span>, <span class="literal">false</span>, namespaceId , NamingUtils.getGroupName(serviceName) , NamingUtils.getServiceName(serviceName), instance.getIp(),instance.getPort()));</span><br><span class="line">       <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="registerInstance"   >
          <a href="#registerInstance" class="heading-link"><i class="fas fa-link"></i></a><a href="#registerInstance" class="headerlink" title="registerInstance"></a>registerInstance</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerInstance</span><span class="params">(String namespaceId, String serviceName, Instance instance)</span> <span class="keyword">throws</span> NacosException &#123;</span><br><span class="line">    NamingUtils.checkInstanceIsLegal(instance);</span><br><span class="line">    </span><br><span class="line">    <span class="type">boolean</span> <span class="variable">ephemeral</span> <span class="operator">=</span> instance.isEphemeral();</span><br><span class="line">    <span class="type">String</span> <span class="variable">clientId</span> <span class="operator">=</span> IpPortBasedClient.getClientId(instance.toInetAddr(), ephemeral);</span><br><span class="line">    createIpPortClientIfAbsent(clientId);</span><br><span class="line">    <span class="type">Service</span> <span class="variable">service</span> <span class="operator">=</span> getService(namespaceId, serviceName, ephemeral);</span><br><span class="line">    clientOperationService.registerInstance(service, instance, clientId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h2 id="RegisterInstanceTraceEvent"   >
          <a href="#RegisterInstanceTraceEvent" class="heading-link"><i class="fas fa-link"></i></a><a href="#RegisterInstanceTraceEvent" class="headerlink" title="RegisterInstanceTraceEvent"></a>RegisterInstanceTraceEvent</h2>
      <div class="table-container"><table>
<thead>
<tr>
<th>形参</th>
<th>传入参数</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>eventTime</td>
<td>System.currentTimeMillis()</td>
<td>当前时间戳</td>
</tr>
<tr>
<td>clientIp</td>
<td>“”</td>
<td>注册实例的请求IP，传入空字符串</td>
</tr>
<tr>
<td>rpc</td>
<td>false</td>
<td>来源是否为gRPC，传入false</td>
</tr>
<tr>
<td>serviceNamespace</td>
<td>namespaceId</td>
<td>命名空间</td>
</tr>
<tr>
<td>serviceGroup</td>
<td>NamingUtils.getGroupName(serviceName)</td>
<td>服务分组</td>
</tr>
<tr>
<td>serviceName</td>
<td>NamingUtils.getServiceName(serviceName)</td>
<td>服务名称</td>
</tr>
<tr>
<td>instanceIp</td>
<td>instance.getIp()</td>
<td>注册实例的地址IP&#x2F;HOST</td>
</tr>
<tr>
<td>instancePort</td>
<td>instance.getPort()</td>
<td>注册实例的端口Port</td>
</tr>
</tbody></table></div>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">RegisterInstanceTraceEvent</span><span class="params">(<span class="type">long</span> eventTime, String clientIp, <span class="type">boolean</span> rpc, String serviceNamespace,</span></span><br><span class="line"><span class="params">        String serviceGroup, String serviceName, String instanceIp, <span class="type">int</span> instancePort)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(<span class="string">&quot;REGISTER_INSTANCE_TRACE_EVENT&quot;</span>, eventTime, serviceNamespace, serviceGroup, serviceName);</span><br><span class="line">    <span class="built_in">this</span>.clientIp = clientIp;</span><br><span class="line">    <span class="built_in">this</span>.rpc = rpc;</span><br><span class="line">    <span class="built_in">this</span>.instanceIp = instanceIp;</span><br><span class="line">    <span class="built_in">this</span>.instancePort = instancePort;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>






        <h3 id="publishEvent"   >
          <a href="#publishEvent" class="heading-link"><i class="fas fa-link"></i></a><a href="#publishEvent" class="headerlink" title="publishEvent"></a>publishEvent</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">publishEvent</span><span class="params">(<span class="keyword">final</span> Event event)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> publishEvent(event.getClass(), event);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        LOGGER.error(<span class="string">&quot;There was an exception to the message publishing : &quot;</span>, ex);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/07/21/JavaSE%E5%9F%BA%E7%A1%80%E3%80%90%E6%80%BB%E7%BB%93%E7%AF%87%E3%80%91/">JavaSE基础【总结篇】</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-07-21</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">532</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">3分</span></span></div></header><div class="post-body"><div class="post-excerpt"><p><strong>前言</strong></p>
<p>这个文档记录的是JavaSE的基础，本着我学习的路线再进一步深化和理解，这个过程是一个必不可少的过程。</p>
<p><em>光学别人的是别人教的好而不是我学的好，想要真正掌握必须自己重新查一遍、看一遍</em></p>
<p>复盘和深化学习路线参考于Java从入门到精通(第六版)目录，这一块要重新学习的主要是最最最基础的内容</p>
<hr>

        <h1 id="Java语言基础"   >
          <a href="#Java语言基础" class="heading-link"><i class="fas fa-link"></i></a><a href="#Java语言基础" class="headerlink" title="Java语言基础"></a>Java语言基础</h1>
      
        <h2 id="基本数据类型"   >
          <a href="#基本数据类型" class="heading-link"><i class="fas fa-link"></i></a><a href="#基本数据类型" class="headerlink" title="基本数据类型"></a>基本数据类型</h2>
      <p>一共八个基本数据类型</p>
<p>整型：byte,short,int,long</p>
<p>浮点型:float,double</p>
<p>布尔型:boolean</p>
<p>字符型:char</p>
<div class="table-container"><table>
<thead>
<tr>
<th></th>
<th>字节数</th>
<th>二进制位</th>
<th>范围</th>
</tr>
</thead>
<tbody><tr>
<td>byte</td>
<td>1字节</td>
<td>8</td>
<td>[-2^7,2^7-1]</td>
</tr>
<tr>
<td>short</td>
<td>2字节</td>
<td>16</td>
<td>[-2^15,2^15-1]</td>
</tr>
<tr>
<td>int</td>
<td>4字节</td>
<td>32</td>
<td>[-2^31,2^31-1]</td>
</tr>
<tr>
<td>long</td>
<td>8字节</td>
<td>64</td>
<td>[-2^63,2^63-1]</td>
</tr>
<tr>
<td>float(单精度)</td>
<td>4字节</td>
<td>32</td>
<td></td>
</tr>
<tr>
<td>double(双精度)</td>
<td>8字节</td>
<td>64</td>
<td></td>
</tr>
<tr>
<td>boolean</td>
<td>1字节</td>
<td>8</td>
<td></td>
</tr>
<tr>
<td>char</td>
<td>2字节</td>
<td>16</td>
<td>[0,2^16-1]</td>
</tr>
</tbody></table></div>

        <h2 id="变量和常量"   >
          <a href="#变量和常量" class="heading-link"><i class="fas fa-link"></i></a><a href="#变量和常量" class="headerlink" title="变量和常量"></a>变量和常量</h2>
      <p>变量:在程序运行过程中，可以发生变化的量</p>
<p>常量:在程序运行过程中，不会发生变化的量</p>
<p>常量一般用final关键字进行修饰，只能赋值一次</p>
<p>变量有成员变量、局部变量、静态变量、参数变量</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">成员变量：定义在类中、方法外的变量，可以被类中的方法调用，可以被权限修饰符修饰</span><br><span class="line">局部变量：定义在方法体、代码块中的变量，作用域仅限当前方法、代码块中，局部变量在使用前必须先声明，并且不能被权限修饰符修饰</span><br><span class="line">静态变量：定义在类中、方法外的变量，并且用<span class="keyword">static</span>关键字修饰，可以被权限修饰符修饰</span><br><span class="line">参数变量: 方法声明时的变量，作用域仅限于方法体中</span><br></pre></td></tr></table></div></figure>




        <h2 id="运算符"   >
          <a href="#运算符" class="heading-link"><i class="fas fa-link"></i></a><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h2>
      
        <h2 id="数据类型转换"   >
          <a href="#数据类型转换" class="heading-link"><i class="fas fa-link"></i></a><a href="#数据类型转换" class="headerlink" title="数据类型转换"></a>数据类型转换</h2>
      
        <h2 id="关键字"   >
          <a href="#关键字" class="heading-link"><i class="fas fa-link"></i></a><a href="#关键字" class="headerlink" title="关键字"></a>关键字</h2>
      
        <h2 id="权限修饰符"   >
          <a href="#权限修饰符" class="heading-link"><i class="fas fa-link"></i></a><a href="#权限修饰符" class="headerlink" title="权限修饰符"></a>权限修饰符</h2>
      <hr>

        <h1 id="数组"   >
          <a href="#数组" class="heading-link"><i class="fas fa-link"></i></a><a href="#数组" class="headerlink" title="数组"></a>数组</h1>
      
        <h2 id="一维数组"   >
          <a href="#一维数组" class="heading-link"><i class="fas fa-link"></i></a><a href="#一维数组" class="headerlink" title="一维数组"></a>一维数组</h2>
      
        <h2 id="二维数组"   >
          <a href="#二维数组" class="heading-link"><i class="fas fa-link"></i></a><a href="#二维数组" class="headerlink" title="二维数组"></a>二维数组</h2>
      
        <h2 id="数组的基本操作"   >
          <a href="#数组的基本操作" class="heading-link"><i class="fas fa-link"></i></a><a href="#数组的基本操作" class="headerlink" title="数组的基本操作"></a>数组的基本操作</h2>
      <hr>

        <h1 id="类和对象"   >
          <a href="#类和对象" class="heading-link"><i class="fas fa-link"></i></a><a href="#类和对象" class="headerlink" title="类和对象"></a>类和对象</h1>
      
        <h2 id="对象"   >
          <a href="#对象" class="heading-link"><i class="fas fa-link"></i></a><a href="#对象" class="headerlink" title="对象"></a>对象</h2>
      
        <h2 id="类"   >
          <a href="#类" class="heading-link"><i class="fas fa-link"></i></a><a href="#类" class="headerlink" title="类"></a>类</h2>
      
        <h3 id="面向对象的操作"   >
          <a href="#面向对象的操作" class="heading-link"><i class="fas fa-link"></i></a><a href="#面向对象的操作" class="headerlink" title="面向对象的操作"></a>面向对象的操作</h3>
      <hr>

        <h1 id="字符串"   >
          <a href="#字符串" class="heading-link"><i class="fas fa-link"></i></a><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h1>
      <hr>

        <h1 id="异常"   >
          <a href="#异常" class="heading-link"><i class="fas fa-link"></i></a><a href="#异常" class="headerlink" title="异常"></a>异常</h1>
      <hr>

        <h1 id="枚举"   >
          <a href="#枚举" class="heading-link"><i class="fas fa-link"></i></a><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h1>
      <hr>

        <h1 id="反射与注解"   >
          <a href="#反射与注解" class="heading-link"><i class="fas fa-link"></i></a><a href="#反射与注解" class="headerlink" title="反射与注解"></a>反射与注解</h1>
      <hr>

        <h1 id="总结"   >
          <a href="#总结" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结" class="headerlink" title="总结"></a>总结</h1>
      </div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/07/20/JavaSE%E5%9F%BA%E7%A1%80-%E9%94%81%E3%80%90%E6%BA%90%E7%A0%81%E7%AF%87%E3%80%91/">JavaSE基础-锁【源码篇】</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-07-20</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">4k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">31分</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="Lock"   >
          <a href="#Lock" class="heading-link"><i class="fas fa-link"></i></a><a href="#Lock" class="headerlink" title="Lock"></a>Lock</h1>
      <p>我们首先要看JUC标准中的Lock接口</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span>;</span><br><span class="line"><span class="comment">//获取锁</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">lockInterruptibly</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	除非当前线程被中断，否则获取锁</span></span><br><span class="line"><span class="comment">	1.如果锁可用则直接获取锁</span></span><br><span class="line"><span class="comment">	2.如果锁不可用，则当前线程会被禁用并处于休眠状态直到两钟情况产生</span></span><br><span class="line"><span class="comment">		1).锁被当前线程获取</span></span><br><span class="line"><span class="comment">		2).其他线程会中断当前线程，并且支持中断锁</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">()</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	只有锁是空闲的时候才能获取锁</span></span><br><span class="line"><span class="comment">	1.如果锁可用则获取锁，返回true</span></span><br><span class="line"><span class="comment">	2.如果锁不可用则返回false</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> time, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	当锁在规定时间内是空闲并且没有线程中断，那么获取锁</span></span><br><span class="line"><span class="comment">	形参:  </span></span><br><span class="line"><span class="comment">		1.规定锁的超时时间</span></span><br><span class="line"><span class="comment">		2.规定时间单位</span></span><br><span class="line"><span class="comment">	返回值：</span></span><br><span class="line"><span class="comment">		1.true 获取锁成功</span></span><br><span class="line"><span class="comment">		2.false 超时，获取锁失败</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span>;</span><br><span class="line"><span class="comment">//释放锁</span></span><br><span class="line"></span><br><span class="line">Condition <span class="title function_">newCondition</span><span class="params">()</span>;</span><br><span class="line"><span class="comment">//创建一个新的Condition实例</span></span><br></pre></td></tr></table></div></figure>

<p>我们接下来要看Lock的实现类</p>

        <h2 id="1-ReentrantLock"   >
          <a href="#1-ReentrantLock" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ReentrantLock" class="headerlink" title="1.ReentrantLock"></a>1.ReentrantLock</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReentrantLock</span> <span class="keyword">implements</span> <span class="title class_">Lock</span>, java.io.Serializable &#123;</span><br><span class="line">    <span class="comment">/*一个可重入互斥锁</span></span><br><span class="line"><span class="comment">      当构造函数接收一个公平性参数，当设置为ture时，则下次获得锁的是等得最久的线程</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>变量</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">7373984872572414699L</span>;</span><br><span class="line"><span class="comment">//串行化ID</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*提供所有实施机制的同步器 */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Sync sync;</span><br></pre></td></tr></table></div></figure>

<p>内部类</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Sync</span> <span class="keyword">extends</span> <span class="title class_">AbstractQueuedSynchronizer</span> &#123;</span><br><span class="line">     </span><br><span class="line"> 	<span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span>;</span><br><span class="line">    ...</span><br><span class="line">        </span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">FairSync</span> <span class="keyword">extends</span> <span class="title class_">Sync</span> &#123;</span><br><span class="line">     <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">            acquire(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">NonfairSync</span> <span class="keyword">extends</span> <span class="title class_">Sync</span> &#123;</span><br><span class="line">     <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">                setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                acquire(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></div></figure>




        <h3 id="构造方法"   >
          <a href="#构造方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#构造方法" class="headerlink" title="构造方法"></a>构造方法</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>无参构造</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ReentrantLock</span><span class="params">()</span> &#123;</span><br><span class="line">        sync = <span class="keyword">new</span> <span class="title class_">NonfairSync</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//创建一个Reentrantlock实例，相当于ReentrantLock(false),创建了一个非公平可重入锁</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*	---有关的详细代码---</span></span><br><span class="line"><span class="comment">	</span></span><br><span class="line"><span class="comment">	static final class NonfairSync extends Sync &#123;</span></span><br><span class="line"><span class="comment">        private static final long serialVersionUID = 7316153563782823691L;</span></span><br><span class="line"><span class="comment">        </span></span><br><span class="line"><span class="comment">        final void lock() &#123;</span></span><br><span class="line"><span class="comment">            if (compareAndSetState(0, 1))</span></span><br><span class="line"><span class="comment">                setExclusiveOwnerThread(Thread.currentThread());</span></span><br><span class="line"><span class="comment">            else</span></span><br><span class="line"><span class="comment">                acquire(1);</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        protected final boolean tryAcquire(int acquires) &#123;</span></span><br><span class="line"><span class="comment">            return nonfairTryAcquire(acquires);</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    //因为NonfairSync类只有继承父类下的空参构造，所以会调用new Sync();</span></span><br><span class="line"><span class="comment">    abstract static class Sync extends AbstractQueuedSynchronizer &#123;</span></span><br><span class="line"><span class="comment">        abstract void lock();</span></span><br><span class="line"><span class="comment">        final boolean nonfairTryAcquire(int acquires) &#123;...&#125;</span></span><br><span class="line"><span class="comment">        protected final boolean tryRelease(int releases) &#123;...&#125;</span></span><br><span class="line"><span class="comment">       	...</span></span><br><span class="line"><span class="comment">     &#125;</span></span><br><span class="line"><span class="comment">    //同理因为Sync类也没有空参构造，会调用父类的空参构造 即new AbstractQueuedSynchronizer();</span></span><br><span class="line"><span class="comment">    public abstract class AbstractQueuedSynchronizer extends AbstractOwnableSynchronizer</span></span><br><span class="line"><span class="comment">    implements java.io.Serializable &#123;</span></span><br><span class="line"><span class="comment">    protected AbstractQueuedSynchronizer() &#123; &#125;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    //同上，且因为abstract类是个抽象类</span></span><br><span class="line"><span class="comment">    //所以父类也是空参构造，那么这个方法最后调用的结果就是new AbstractOwnableSynchronizer()</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    //那么先暂时按官方说明的理解，调用了一个ReentrantLock(false),创建了一个非公平可重入锁</span></span><br><span class="line"><span class="comment">*/</span>    </span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>有参构造</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ReentrantLock</span><span class="params">(<span class="type">boolean</span> fair)</span> &#123;</span><br><span class="line">        sync = fair ? <span class="keyword">new</span> <span class="title class_">FairSync</span>() : <span class="keyword">new</span> <span class="title class_">NonfairSync</span>();</span><br><span class="line">    <span class="comment">//通过指定公平策略，创建一个实例ReentrantLock</span></span><br><span class="line">    <span class="comment">//当fair为true则创建FairSync反之创建NonfairSync();</span></span><br><span class="line">    <span class="comment">//默认情况下空参构造是创建一个非公平的可重入互斥锁</span></span><br><span class="line">    &#125;</span><br><span class="line">	</span><br></pre></td></tr></table></div></figure>




        <h3 id="常用方法"   >
          <a href="#常用方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#常用方法" class="headerlink" title="常用方法"></a>常用方法</h3>
      
        <h4 id="lock方法"   >
          <a href="#lock方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#lock方法" class="headerlink" title="lock方法"></a>lock方法</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">        sync.lock();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//sync.lock()</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span>;</span><br><span class="line"><span class="comment">//所以要去找sync的子类看具体的方法实现</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//默认情况下:创建一个NonfairSync</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//nonfairsync.lock()</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">                setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                acquire(<span class="number">1</span>);</span><br><span class="line">    <span class="comment">//锁状态从0更新到1则说明线程获取了互斥锁</span></span><br><span class="line">&#125;   </span><br><span class="line">    <span class="comment">/*-----详情代码----</span></span><br><span class="line"><span class="comment">    我们可以先通过判断成功与否来反推这个IF语句到底在干吗</span></span><br><span class="line"><span class="comment">    条件成立:</span></span><br><span class="line"><span class="comment">    protected final void setExclusiveOwnerThread(Thread thread) &#123;</span></span><br><span class="line"><span class="comment">        exclusiveOwnerThread = thread;</span></span><br><span class="line"><span class="comment">        //这个方法执行成功后，会获得互斥锁</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    private transient Thread exclusiveOwnerThread;</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    条件不成立:</span></span><br><span class="line"><span class="comment">    public final void acquire(int arg) &#123;</span></span><br><span class="line"><span class="comment">        if (!tryAcquire(arg) &amp;&amp;acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span></span><br><span class="line"><span class="comment">        	//	当尝试获取锁失败并且添加到等待队列中，则会线程自己中断自己</span></span><br><span class="line"><span class="comment">            selfInterrupt();</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    //尝试获取锁</span></span><br><span class="line"><span class="comment">    protected boolean tryAcquire(int arg) &#123;</span></span><br><span class="line"><span class="comment">        throw new UnsupportedOperationException();</span></span><br><span class="line"><span class="comment">        //尝试获取锁，如果获取将使同步器处于非法操作则抛出异常</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    //给当前创建结点并且给一个标识表示当前线程正在抢夺互斥锁</span></span><br><span class="line"><span class="comment">    private Node addWaiter(Node mode) &#123;</span></span><br><span class="line"><span class="comment">        Node node = new Node(Thread.currentThread(), mode);</span></span><br><span class="line"><span class="comment">        //创建当前线程的结点</span></span><br><span class="line"><span class="comment">        </span></span><br><span class="line"><span class="comment">        // Try the fast path of enq; backup to full enq on failure</span></span><br><span class="line"><span class="comment">        Node pred = tail;</span></span><br><span class="line"><span class="comment">        if (pred != null) &#123;</span></span><br><span class="line"><span class="comment">            node.prev = pred;</span></span><br><span class="line"><span class="comment">            if (compareAndSetTail(pred, node)) &#123;</span></span><br><span class="line"><span class="comment">        		//利用cas机制将当前线程结点添加到队尾，然后返回Node结束方法</span></span><br><span class="line"><span class="comment">                pred.next = node;</span></span><br><span class="line"><span class="comment">                return node;</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        </span></span><br><span class="line"><span class="comment">        //运行到这里说明加入等待队尾失败        </span></span><br><span class="line"><span class="comment">        enq(node);</span></span><br><span class="line"><span class="comment">        //调用enq(node)</span></span><br><span class="line"><span class="comment">        return node;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    //enq为等待队列，这里会不断死循环直到数据插入到等待队列队尾</span></span><br><span class="line"><span class="comment">    private Node enq(final Node node) &#123;</span></span><br><span class="line"><span class="comment">        for (;;) &#123;</span></span><br><span class="line"><span class="comment">            Node t = tail;</span></span><br><span class="line"><span class="comment">            if (t == null) &#123; // Must initialize</span></span><br><span class="line"><span class="comment">            	//如果队尾为空，说明该队列还没有创建，初始化</span></span><br><span class="line"><span class="comment">                if (compareAndSetHead(new Node()))</span></span><br><span class="line"><span class="comment">                	//创建新结点插入队首，此时队伍只有队首一个元素,将尾结点指向第一个头结点</span></span><br><span class="line"><span class="comment">                    tail = head;</span></span><br><span class="line"><span class="comment">            &#125; else &#123;</span></span><br><span class="line"><span class="comment">            	//队伍中有数据，那么将结点插入队伍</span></span><br><span class="line"><span class="comment">                node.prev = t;</span></span><br><span class="line"><span class="comment">                if (compareAndSetTail(t, node)) &#123;</span></span><br><span class="line"><span class="comment">                    t.next = node;</span></span><br><span class="line"><span class="comment">                    return t;</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">    因此我们大概可以知道如果状态从0置为1则说明获得了锁，失败了就会加入重试队伍中重试获取锁</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    判断条件:这里调用的是AbstractQueuedSynchronizer父类的方法</span></span><br><span class="line"><span class="comment">    	</span></span><br><span class="line"><span class="comment">    protected final boolean compareAndSetState(int expect, int update) &#123;</span></span><br><span class="line"><span class="comment">        return unsafe.compareAndSwapInt(this, stateOffset, expect, update);</span></span><br><span class="line"><span class="comment">        //参数1:调用的位置 参数2:偏移量 参数3:期待数  参数4:更新后的值</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    public final native boolean compareAndSwapInt(Object var1, long var2, int var4, int var5);</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    stateOffset = unsafe.objectFieldOffset (AbstractQueuedSynchronizer.class.getDeclaredField(&quot;state&quot;));0</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    public native long objectFieldOffset(Field var1);</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//创建了一个公平同步器</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//FairSync.lock</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">            acquire(<span class="number">1</span>);</span><br><span class="line">    <span class="comment">//尝试获得互斥锁</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//尝试获取互斥锁，如果成立返回true,反之线程加入等待队伍</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp;</span><br><span class="line">            acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">            selfInterrupt();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h4 id="tryLock方法"   >
          <a href="#tryLock方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#tryLock方法" class="headerlink" title="tryLock方法"></a>tryLock方法</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//尝试获取锁，以非公平的方式</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sync.nonfairTryAcquire(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment">//尝试以非公平的方式获取锁</span></span><br><span class="line"><span class="comment">//如果锁是第一次获取则状态置为1</span></span><br><span class="line"><span class="comment">//如果锁已经被当前线程获取过，那么状态会是原来的状态+1</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">nonfairTryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">            <span class="comment">//获得当前线程</span></span><br><span class="line">            </span><br><span class="line">            <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">            <span class="comment">//获得当前状态</span></span><br><span class="line">            <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">                	<span class="comment">//如果用cas机制成功将0更新成参数</span></span><br><span class="line">                    setExclusiveOwnerThread(current);</span><br><span class="line">                    <span class="comment">//将该线程设置为互斥锁的获得者</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                    <span class="comment">//返回true表示获得锁成功 锁的状态为1</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">            	<span class="comment">//如果当前线程已经是锁的获得者了</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">nextc</span> <span class="operator">=</span> c + acquires;</span><br><span class="line">                <span class="comment">//将c加入参数值然后交给下一个nextc变量</span></span><br><span class="line">                <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">                setState(nextc);</span><br><span class="line">                <span class="comment">//将nextc设置成锁的状态</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                <span class="comment">//返回true表示获得锁成功，锁的状态为当前状态+1</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    		<span class="comment">//返回false表示获得锁失败</span></span><br><span class="line">        &#125;    </span><br><span class="line">    </span><br></pre></td></tr></table></div></figure>


        <h4 id="unlock方法"   >
          <a href="#unlock方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#unlock方法" class="headerlink" title="unlock方法"></a>unlock方法</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//尝试解锁</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">        sync.release(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">release</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (tryRelease(arg)) &#123;</span><br><span class="line">            <span class="comment">//设置了状态-1 </span></span><br><span class="line">            <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">            <span class="keyword">if</span> (h != <span class="literal">null</span> &amp;&amp; h.waitStatus != <span class="number">0</span>)</span><br><span class="line">                <span class="comment">//如果队首不为空并且结点不是置于等待状态，调用unparkSuccessor()方法</span></span><br><span class="line">                unparkSuccessor(h);</span><br><span class="line">            	</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="comment">//返回true表示解锁成功</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    	<span class="comment">//返回false表示解锁失败</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//试图设置state状态来释放独占锁，如果解锁导致同步器非法，那么就抛出异常</span></span><br><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">tryRelease</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unparkSuccessor</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> node.waitStatus;</span><br><span class="line">    	<span class="comment">//获得结点的等待状态,此时传入的结点是队首元素</span></span><br><span class="line">        <span class="keyword">if</span> (ws &lt; <span class="number">0</span>)</span><br><span class="line">            compareAndSetWaitStatus(node, ws, <span class="number">0</span>);</span><br><span class="line">		<span class="comment">//如果ws小于0 那么用compareAndSetWaitStatus方法将node结点的等待状态置为0</span></span><br><span class="line">        </span><br><span class="line">        <span class="type">Node</span> <span class="variable">s</span> <span class="operator">=</span> node.next;</span><br><span class="line">    	<span class="comment">//获得下一个结点</span></span><br><span class="line">        <span class="keyword">if</span> (s == <span class="literal">null</span> || s.waitStatus &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//如果下一个结点为空或者下一个结点的等待状态大于0</span></span><br><span class="line">            s = <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">//那么将下一个结点置为空</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> tail; t != <span class="literal">null</span> &amp;&amp; t != node; t = t.prev)</span><br><span class="line">                <span class="comment">//从队尾结点开始循环，当尾结点不是当前结点并且非空的时候进入循环，每次循环结束t将指向前一个结点</span></span><br><span class="line">                <span class="keyword">if</span> (t.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                    <span class="comment">//当t的状态字小于等于0的时候</span></span><br><span class="line">                    s = t;</span><br><span class="line">            		<span class="comment">//将s置于t</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (s != <span class="literal">null</span>)</span><br><span class="line">            <span class="comment">//如果s不为空</span></span><br><span class="line">            LockSupport.unpark(s.thread);</span><br><span class="line">    		<span class="comment">//将下一个线程解除阻塞，即唤醒下一个等待线程</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Makes available the permit for the given thread, if it was not already available. If the thread was blocked on park then it will unblock. Otherwise, its next call to park is guaranteed not to block. This operation is not guaranteed to have any effect at all if the given thread has not been started.</span></span><br><span class="line"><span class="comment">形参:</span></span><br><span class="line"><span class="comment">thread – the thread to unpark, or null, in which case this operation has no effect</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unpark</span><span class="params">(Thread thread)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (thread != <span class="literal">null</span>)</span><br><span class="line">            UNSAFE.unpark(thread);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">unpark</span><span class="params">(Object var1)</span>;</span><br></pre></td></tr></table></div></figure>


        <h2 id="ReentrantReadWriteLock"   >
          <a href="#ReentrantReadWriteLock" class="heading-link"><i class="fas fa-link"></i></a><a href="#ReentrantReadWriteLock" class="headerlink" title="ReentrantReadWriteLock"></a>ReentrantReadWriteLock</h2>
      <p>变量</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">6992448646407690164L</span>;</span><br><span class="line"><span class="comment">//串行化ID</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReentrantReadWriteLock.ReadLock readerLock;</span><br><span class="line"><span class="comment">//内部类 读锁</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReentrantReadWriteLock.WriteLock writerLock;</span><br><span class="line"><span class="comment">//内部类 写锁</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> Sync sync;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Unsafe mechanics</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> sun.misc.Unsafe UNSAFE;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> TID_OFFSET;</span><br></pre></td></tr></table></div></figure>

<p>内部类</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">FairSync</span> <span class="keyword">extends</span> <span class="title class_">Sync</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">2274990926593161451L</span>;</span><br><span class="line">    <span class="comment">//串行化ID</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">writerShouldBlock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> hasQueuedPredecessors();</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">readerShouldBlock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> hasQueuedPredecessors();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    //如果当前线程前面有一个排队线程则返回true</span></span><br><span class="line"><span class="comment">    //当线程位于队首或者队列为空则返回false</span></span><br><span class="line"><span class="comment">    public final boolean hasQueuedPredecessors() &#123;</span></span><br><span class="line"><span class="comment">        // The correctness of this depends on head being initialized</span></span><br><span class="line"><span class="comment">        // before tail and on head.next being accurate if the current</span></span><br><span class="line"><span class="comment">        // thread is first in queue.</span></span><br><span class="line"><span class="comment">        Node t = tail; // Read fields in reverse initialization order</span></span><br><span class="line"><span class="comment">        Node h = head;</span></span><br><span class="line"><span class="comment">        Node s;</span></span><br><span class="line"><span class="comment">        return h != t &amp;&amp;</span></span><br><span class="line"><span class="comment">            ((s = h.next) == null || s.thread != Thread.currentThread());</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Sync</span> <span class="keyword">extends</span> <span class="title class_">AbstractQueuedSynchronizer</span> &#123;</span><br><span class="line">     <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Read vs write count extraction constants and functions.</span></span><br><span class="line"><span class="comment">         * Lock state is logically divided into two unsigned shorts:</span></span><br><span class="line"><span class="comment">         * The lower one representing the exclusive (writer) lock hold count,</span></span><br><span class="line"><span class="comment">         * and the upper the shared (reader) hold count.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">     <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SHARED_SHIFT</span>   <span class="operator">=</span> <span class="number">16</span>;</span><br><span class="line">     <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SHARED_UNIT</span>    <span class="operator">=</span> (<span class="number">1</span> &lt;&lt; SHARED_SHIFT);</span><br><span class="line">     <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_COUNT</span>      <span class="operator">=</span> (<span class="number">1</span> &lt;&lt; SHARED_SHIFT) - <span class="number">1</span>;</span><br><span class="line">     <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">EXCLUSIVE_MASK</span> <span class="operator">=</span> (<span class="number">1</span> &lt;&lt; SHARED_SHIFT) - <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">HoldCounter</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// Use id, not reference, to avoid garbage retention</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">long</span> <span class="variable">tid</span> <span class="operator">=</span> getThreadId(Thread.currentThread());</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">     <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ThreadLocalHoldCounter</span></span><br><span class="line">            <span class="keyword">extends</span> <span class="title class_">ThreadLocal</span>&lt;HoldCounter&gt; &#123;</span><br><span class="line">            <span class="keyword">public</span> HoldCounter <span class="title function_">initialValue</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HoldCounter</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="构造方法-1"   >
          <a href="#构造方法-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#构造方法-1" class="headerlink" title="构造方法"></a>构造方法</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>空参构造</span><br><span class="line">    <span class="comment">//默认创建一个非公平的ReentrantReadWriteLock</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ReentrantReadWriteLock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(<span class="literal">false</span>);</span><br><span class="line">    <span class="comment">//调用ReentrantReadWriteLock(boolean fair) 方法 传入false参数</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>有参构造</span><br><span class="line">    <span class="comment">//给定指定参数，创建相应的读锁写锁</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ReentrantReadWriteLock</span><span class="params">(<span class="type">boolean</span> fair)</span> &#123;</span><br><span class="line">        sync = fair ? <span class="keyword">new</span> <span class="title class_">FairSync</span>() : <span class="keyword">new</span> <span class="title class_">NonfairSync</span>();</span><br><span class="line">        readerLock = <span class="keyword">new</span> <span class="title class_">ReadLock</span>(<span class="built_in">this</span>);</span><br><span class="line">        writerLock = <span class="keyword">new</span> <span class="title class_">WriteLock</span>(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h3 id="方法"   >
          <a href="#方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#方法" class="headerlink" title="方法"></a>方法</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//返回写锁</span></span><br><span class="line"><span class="keyword">public</span> ReentrantReadWriteLock.WriteLock <span class="title function_">writeLock</span><span class="params">()</span> &#123; <span class="keyword">return</span> writerLock; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//返回读锁</span></span><br><span class="line"><span class="keyword">public</span> ReentrantReadWriteLock.ReadLock  <span class="title function_">readLock</span><span class="params">()</span>  &#123; <span class="keyword">return</span> readerLock; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//返回是否公平</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">isFair</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sync <span class="keyword">instanceof</span> FairSync;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//返回锁的拥有线程</span></span><br><span class="line"><span class="keyword">protected</span> Thread <span class="title function_">getOwner</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sync.getOwner();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//返回读锁数量，用于监测系统状态</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getReadLockCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sync.getReadLockCount();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//查询写锁是否空闲</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isWriteLocked</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sync.isWriteLocked();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//查询当前线程是否有写锁</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isWriteLockedByCurrentThread</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sync.isHeldExclusively();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//查询当前线程写锁的可重入数</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getWriteHoldCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sync.getWriteHoldCount();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//查询当前线程读锁的可重入数</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getReadHoldCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sync.getReadHoldCount();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">    </span><br></pre></td></tr></table></div></figure>


        <h3 id="Sync常用方法"   >
          <a href="#Sync常用方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#Sync常用方法" class="headerlink" title="Sync常用方法"></a>Sync常用方法</h3>
      
        <h4 id="sync方法"   >
          <a href="#sync方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#sync方法" class="headerlink" title="sync方法"></a>sync方法</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Sync() &#123;</span><br><span class="line">            readHolds = <span class="keyword">new</span> <span class="title class_">ThreadLocalHoldCounter</span>();</span><br><span class="line">            <span class="comment">//调用ThreadLocalHoldCounter()</span></span><br><span class="line">            </span><br><span class="line">            setState(getState()); <span class="comment">// ensures visibility of readHolds</span></span><br><span class="line">            <span class="comment">//设置状态字，确保readHolds的可见性</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ThreadLocalHoldCounter</span> <span class="keyword">extends</span> <span class="title class_">ThreadLocal</span>&lt;HoldCounter&gt; &#123;</span><br><span class="line">            <span class="keyword">public</span> HoldCounter <span class="title function_">initialValue</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HoldCounter</span>();</span><br><span class="line">                <span class="comment">//调用方法 直接返回HoldCounter</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">HoldCounter</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="comment">//设置数量为0</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Use id, not reference, to avoid garbage retention</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">long</span> <span class="variable">tid</span> <span class="operator">=</span> getThreadId(Thread.currentThread());</span><br><span class="line">            <span class="comment">//获取当前线程id，使得被标记省的被垃圾回收</span></span><br><span class="line">        &#125;        </span><br><span class="line">    </span><br></pre></td></tr></table></div></figure>


        <h4 id="tryAcquire方法"   >
          <a href="#tryAcquire方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#tryAcquire方法" class="headerlink" title="tryAcquire方法"></a>tryAcquire方法</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            如果是可重入获取或者队列策略允许，则该线程有权利加锁，那么将更新锁的状态并且设置持有者为当前线程</span></span><br><span class="line"><span class="comment">         	如果读或写计数器非0，且不是当前线程持有，则返回false</span></span><br><span class="line"><span class="comment">         	如果计数器将达到上限，则返回false</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">            <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">    		<span class="comment">//获取锁的状态</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">w</span> <span class="operator">=</span> exclusiveCount(c);</span><br><span class="line">    		<span class="comment">//获取锁的可重入数计数</span></span><br><span class="line">            <span class="keyword">if</span> (c != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// (Note: if c != 0 and w == 0 then shared count != 0)</span></span><br><span class="line">                <span class="keyword">if</span> (w == <span class="number">0</span> || current != getExclusiveOwnerThread())</span><br><span class="line">                    <span class="comment">//如果可重入数计数为空或者锁非当前线程持有，那么返回false</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">if</span> (w + exclusiveCount(acquires) &gt; MAX_COUNT)</span><br><span class="line">                    <span class="comment">//如果可重入数大于最大数量，抛出异常</span></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">                <span class="comment">// Reentrant acquire</span></span><br><span class="line">                <span class="comment">//可重入锁加锁成功</span></span><br><span class="line">                <span class="comment">//将计数器设回状态中</span></span><br><span class="line">                setState(c + acquires);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">    		<span class="comment">// 能运行到这里也没有抛出异常 那么说明锁空闲</span></span><br><span class="line">            <span class="keyword">if</span> (writerShouldBlock() ||!compareAndSetState(c, c + acquires))</span><br><span class="line">                <span class="comment">//进行判断，如果写操作被阻塞或者CAS机制发现更新操作失败(即多线程情况下别人线程已经获取了锁)</span></span><br><span class="line">                <span class="comment">//加锁失败</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    		<span class="comment">//将当前线程设置为锁的持有者，返回true</span></span><br><span class="line">            setExclusiveOwnerThread(current);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="type">int</span> <span class="title function_">exclusiveCount</span><span class="params">(<span class="type">int</span> c)</span> &#123; <span class="keyword">return</span> c &amp; EXCLUSIVE_MASK; &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="tryRelease方法"   >
          <a href="#tryRelease方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#tryRelease方法" class="headerlink" title="tryRelease方法"></a>tryRelease方法</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryRelease</span><span class="params">(<span class="type">int</span> releases)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!isHeldExclusively())</span><br><span class="line">                <span class="comment">//当锁不是当前线程持有，则抛出异常</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">    </span><br><span class="line">    		<span class="comment">//运行到这里说明锁的持有者是当前线程</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">nextc</span> <span class="operator">=</span> getState() - releases;</span><br><span class="line">    		<span class="comment">//将当前状态数减去1之后设置为更新后的状态数</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">free</span> <span class="operator">=</span> exclusiveCount(nextc) == <span class="number">0</span>;</span><br><span class="line">    		<span class="comment">//如果更新之后数据为0，那么说明锁空闲</span></span><br><span class="line">            <span class="keyword">if</span> (free) </span><br><span class="line">                <span class="comment">//锁空闲之后设置者为null</span></span><br><span class="line">                setExclusiveOwnerThread(<span class="literal">null</span>);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    		<span class="comment">//设置更新之后的状态字</span></span><br><span class="line">            setState(nextc);</span><br><span class="line">    </span><br><span class="line">    		<span class="comment">//返回可重入次数</span></span><br><span class="line">            <span class="keyword">return</span> free;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">isHeldExclusively</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">// While we must in general read state before owner,</span></span><br><span class="line">            <span class="comment">// we don&#x27;t need to do so to check if current thread is owner</span></span><br><span class="line">            <span class="keyword">return</span> getExclusiveOwnerThread() == Thread.currentThread();</span><br><span class="line">    	<span class="comment">//如果当前线程不是锁的持有者则返回false</span></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="tryWriteLock方法"   >
          <a href="#tryWriteLock方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#tryWriteLock方法" class="headerlink" title="tryWriteLock方法"></a>tryWriteLock方法</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryWriteLock</span><span class="params">()</span> &#123;</span><br><span class="line">    		<span class="comment">//获取当前线程和锁的状态字</span></span><br><span class="line">            <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">            <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">            <span class="keyword">if</span> (c != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//如果锁有持有者</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">w</span> <span class="operator">=</span> exclusiveCount(c);</span><br><span class="line">                <span class="comment">//获取锁的可重入数</span></span><br><span class="line">                <span class="keyword">if</span> (w == <span class="number">0</span> || current != getExclusiveOwnerThread())</span><br><span class="line">                    <span class="comment">//如果锁并非当前线程持有，则加写锁失败</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">if</span> (w == MAX_COUNT)</span><br><span class="line">                    <span class="comment">//如果锁的可重入数达到上限，则抛出异常</span></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">    		<span class="comment">//执行到这里还没有抛出异常说明可重入数未达到上限或者锁空闲</span></span><br><span class="line">            <span class="keyword">if</span> (!compareAndSetState(c, c + <span class="number">1</span>))</span><br><span class="line">                <span class="comment">//用CAS机制设置状态失败</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    			<span class="comment">//返回false</span></span><br><span class="line">    </span><br><span class="line">    		<span class="comment">//如果加锁成功，那么将锁持有者设置为当前线程</span></span><br><span class="line">            setExclusiveOwnerThread(current);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="tryReadLock方法"   >
          <a href="#tryReadLock方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#tryReadLock方法" class="headerlink" title="tryReadLock方法"></a>tryReadLock方法</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">对读锁使用tryLock()方法</span><br><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryReadLock</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">          	<span class="comment">//获取当前线程</span></span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">                <span class="comment">//获取锁的状态</span></span><br><span class="line">                <span class="keyword">if</span> (exclusiveCount(c) != <span class="number">0</span> &amp;&amp; getExclusiveOwnerThread() != current)</span><br><span class="line">                <span class="comment">//锁可重入数非空或者锁的持有者不是当前线程，则加锁失败</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> sharedCount(c);</span><br><span class="line">                <span class="comment">//获取分享状态字</span></span><br><span class="line">                <span class="keyword">if</span> (r == MAX_COUNT)</span><br><span class="line">                    <span class="comment">//如果分享数达到上限 抛出异常</span></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (compareAndSetState(c, c + SHARED_UNIT)) &#123;</span><br><span class="line">                    <span class="comment">//用CAS给状态c设置数据</span></span><br><span class="line">                    <span class="keyword">if</span> (r == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">//如果r为空</span></span><br><span class="line">                        firstReader = current;</span><br><span class="line">                        firstReaderHoldCount = <span class="number">1</span>;</span><br><span class="line">                        <span class="comment">//那么读锁持有数设置为1，第一头结点设置为当前线程</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (firstReader == current) &#123;</span><br><span class="line">                        <span class="comment">//r非空，那么头结点获取线程数+1</span></span><br><span class="line">                        firstReaderHoldCount++;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">//缓冲区线程数设置为头结点线程数</span></span><br><span class="line">                        <span class="type">HoldCounter</span> <span class="variable">rh</span> <span class="operator">=</span> cachedHoldCounter;</span><br><span class="line">                        <span class="keyword">if</span> (rh == <span class="literal">null</span> || rh.tid != getThreadId(current))</span><br><span class="line">                            <span class="comment">//如果rh为空或者rh的线程id不等于当前线程id</span></span><br><span class="line">                            cachedHoldCounter = rh = readHolds.get();</span><br><span class="line">                        </span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (rh.count == <span class="number">0</span>)</span><br><span class="line">                            readHolds.set(rh);</span><br><span class="line">                        rh.count++;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//加锁成功</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></div></figure>


        <h4 id="tryAcquireShared方法"   >
          <a href="#tryAcquireShared方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#tryAcquireShared方法" class="headerlink" title="tryAcquireShared方法"></a>tryAcquireShared方法</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">tryAcquireShared</span><span class="params">(<span class="type">int</span> unused)</span> &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            如果写锁被另一个线程持有，则失败</span></span><br><span class="line"><span class="comment">            如果当前线程能有资格持有写锁。询问队列策略是否应该被阻塞</span></span><br><span class="line"><span class="comment">            	没有被阻塞，用CAS机制给锁更新状态和计数</span></span><br><span class="line"><span class="comment">            如果加锁失败，那么可能是线程不能持有写锁，或者CAS更新失败，或者计数器饱和	</span></span><br><span class="line"><span class="comment">            </span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">            <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">            <span class="keyword">if</span> (exclusiveCount(c) != <span class="number">0</span> &amp;&amp;</span><br><span class="line">                getExclusiveOwnerThread() != current)</span><br><span class="line">                <span class="comment">//判断写锁是否被其他线程持有</span></span><br><span class="line">                <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> sharedCount(c);</span><br><span class="line">    			<span class="comment">//将计数状态交给r</span></span><br><span class="line">            <span class="keyword">if</span> (!readerShouldBlock() &amp;&amp;</span><br><span class="line">                r &lt; MAX_COUNT &amp;&amp;</span><br><span class="line">                compareAndSetState(c, c + SHARED_UNIT)) &#123;</span><br><span class="line">                <span class="comment">//当不被阻塞,并且计数器小于最大值以及更新状态成功</span></span><br><span class="line">                <span class="keyword">if</span> (r == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">//如果计数器为0 ，那么将当前线程设置为第一个顾客，可重入计数为1</span></span><br><span class="line">                    firstReader = current;</span><br><span class="line">                    firstReaderHoldCount = <span class="number">1</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (firstReader == current) &#123;</span><br><span class="line">                    <span class="comment">//如果第一个获取锁的是当前线程，那么将计数器+1</span></span><br><span class="line">                    firstReaderHoldCount++;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="type">HoldCounter</span> <span class="variable">rh</span> <span class="operator">=</span> cachedHoldCounter;</span><br><span class="line">                    <span class="keyword">if</span> (rh == <span class="literal">null</span> || rh.tid != getThreadId(current))</span><br><span class="line">                        cachedHoldCounter = rh = readHolds.get();</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (rh.count == <span class="number">0</span>)</span><br><span class="line">                        readHolds.set(rh);</span><br><span class="line">                    rh.count++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> fullTryAcquireShared(current);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></div></figure>




        <h1 id="synchronized关键字"   >
          <a href="#synchronized关键字" class="heading-link"><i class="fas fa-link"></i></a><a href="#synchronized关键字" class="headerlink" title="synchronized关键字"></a>synchronized关键字</h1>
      </div></div></article></section><nav class="paginator"><div class="paginator-inner"><span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fas fa-angle-right"></i></a></div></nav></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><section class="sidebar-toc hide"></section><!-- ov = overview--><section class="sidebar-ov"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="https://images-kkblog.oss-cn-hangzhou.aliyuncs.com/E7977EEC2FEF2A2B9146704271490ED2.png" alt="avatar"></div><p class="sidebar-ov-author__text">步子小也好，走得慢也好，是在往前走就好</p></div><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="/" target="_blank" rel="noopener" data-popover="social.389081641" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-qq"></i></span></a><a class="sidebar-ov-social-item" href="https://github.com/Kkker1" target="_blank" rel="noopener" data-popover="Github" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-github"></i></span></a><a class="sidebar-ov-social-item" href="/" target="_blank" rel="noopener" data-popover="social.KKKer1An@163.com" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="far fa-envelope"></i></span></a></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">29</div><div class="sidebar-ov-state-item__name">归档</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">11</div><div class="sidebar-ov-state-item__name">分类</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">16</div><div class="sidebar-ov-state-item__name">标签</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="知识共享许可协议" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2023</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>KkkerAn</span></div><div><span>由 <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> 强力驱动</span><span> v6.3.0</span><span class="footer__devider">|</span><span>主题 - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.8.0</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="搜索文章（支持多关键词，请用空格分隔）"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lazyload@2.0.0-rc.2/lazyload.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.xml';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // 将 XML 转为 JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // 搜索对象（标题、内容）的权重，影响显示顺序
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // 根据空白字符分隔关键字
        var keywords = searchText.split(/[\s]+/);
        // 搜索结果
        var matchPosts = [];

        // 有多个关键字时，将原文字整个保存下来
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // 防止未输入字符时搜索
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // 没有标题的文章使用预设的 i18n 变量代替
            var title = (data.title && data.title.trim()) || '[ 文章无标题 ]';
            var titleLower = title && title.toLowerCase();
            // 删除 HTML 标签 和 所有空白字符
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // 删除重复的 /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // 标题中匹配到的关键词
            var titleHitSlice = [];
            // 内容中匹配到的关键词
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * 获取匹配的关键词的索引
              * @param {String} keyword 要匹配的关键字
              * @param {String} text 原文字
              * @param {Boolean} caseSensitive 是否区分大小写
              * @param {Number} weight 匹配对象的权重。权重大的优先显示
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // 每次匹配的开始索引
                var index = -1;     // 匹配到的索引值
                var result = [];    // 匹配结果

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // 索引位置相同的关键词，保留长度较长的
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // 按照匹配文字的索引的递增顺序排序
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * 给文本中匹配到的关键词添加标记，从而进行高亮显示
              * @param {String} text 原文本
              * @param {Array} hitSlice 匹配项的索引信息
              * @param {Number} start 开始索引
              * @param {Number} end 结束索引
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // 文章总的搜索权重
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // 标记匹配关键词后的标题
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // 标记匹配关键词后的内容
              var postContent;
              // 显示内容的长度
              var SHOW_WORD_LENGTH = 200;
              // 命中关键词前的字符显示长度
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // 截取匹配的第一个字符，前后共 200 个字符来显示
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // 未匹配到内容，直接截取前 200 个字符来显示
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // 按权重递增的顺序排序，使权重大的优先显示
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);

function safeOpenUrl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}

function extSearch(engine) {
  var engines = {
    google: 'https://www.google.com/search?q=',
    bing: 'https://cn.bing.com/search?q=',
    baidu: 'https://www.baidu.com/s?ie=UTF-8&wd=',
  };
  var host = window.location.host;
  var query = $('.search-input input').val().toLowerCase().trim();
  var uri = engines[engine] + query + ' site:' + host;

  if (query) {
    safeOpenUrl(uri);
  } else {
    Stun.utils.popAlert('warning', '请输入字符');
  }
}

var assistSearchList = window.CONFIG.assistSearch;

if (Array.isArray(assistSearchList)) {
  assistSearchList.forEach(function (name) {
    document.querySelector('.search-btns-item--' + name).addEventListener('click', function () {
      extSearch(name);
    }, false);
  });
}</script><script src="/js/utils.js?v=2.8.0"></script><script src="/js/stun-boot.js?v=2.8.0"></script><script src="/js/scroll.js?v=2.8.0"></script><script src="/js/header.js?v=2.8.0"></script><script src="/js/sidebar.js?v=2.8.0"></script><script type="application/json" src="/search.xml"></script></body></html>